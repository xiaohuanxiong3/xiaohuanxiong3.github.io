

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.jpeg">
  <link rel="icon" href="/img/avatar.jpeg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Handsome Young">
  <meta name="keywords" content="">
  
    <meta name="description" content="ExecutionPlaceholder    占位符,DeferredLoad判断是否能加载时用到 123public enum ExecutionPlaceholder &amp;#123;  EXECUTION_PLACEHOLDER&amp;#125;  ErrorContext    错误上下文 123456789101112131415161718192021222324252627282930313">
<meta property="og:type" content="article">
<meta property="og:title" content="16-executor">
<meta property="og:url" content="https://xiaohuanxiong3.github.io/2023/08/28/16-executor/index.html">
<meta property="og:site_name" content="小浣熊的个人博客">
<meta property="og:description" content="ExecutionPlaceholder    占位符,DeferredLoad判断是否能加载时用到 123public enum ExecutionPlaceholder &amp;#123;  EXECUTION_PLACEHOLDER&amp;#125;  ErrorContext    错误上下文 123456789101112131415161718192021222324252627282930313">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-08-28T15:23:04.000Z">
<meta property="article:modified_time" content="2023-09-04T15:47:35.462Z">
<meta property="article:author" content="Handsome Young">
<meta property="article:tag" content="Mybatis">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>16-executor - 小浣熊的个人博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xiaohuanxiong3.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>小浣熊</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/poem/">
                <i class="iconfont icon-user-fill"></i>
                古诗词
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/thinking/">
                <i class="iconfont icon-user-fill"></i>
                思考ing
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="16-executor"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-08-28 23:23" pubdate>
          2023年8月28日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          136k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          1136 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">16-executor</h1>
            
            
              <div class="markdown-body">
                
                <h4 id="ExecutionPlaceholder"><a href="#ExecutionPlaceholder" class="headerlink" title="ExecutionPlaceholder"></a>ExecutionPlaceholder</h4><p>    占位符,DeferredLoad判断是否能加载时用到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ExecutionPlaceholder</span> &#123;<br>  EXECUTION_PLACEHOLDER<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ErrorContext"><a href="#ErrorContext" class="headerlink" title="ErrorContext"></a>ErrorContext</h4><p>    错误上下文</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorContext</span> &#123; <br><br>  <span class="hljs-comment">// 获得 \n 不同的操作系统不一样</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LINE_SEPARATOR</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;line.separator&quot;</span>,<span class="hljs-string">&quot;\n&quot;</span>);<br>  <span class="hljs-comment">// 每个线程给开一个错误上下文，防止多线程问题</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ErrorContext&gt; LOCAL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;ErrorContext&gt;(); <br><br>  <span class="hljs-keyword">private</span> ErrorContext stored;<br>  <span class="hljs-keyword">private</span> String resource;<br>  <span class="hljs-keyword">private</span> String activity;<br>  <span class="hljs-keyword">private</span> String object;<br>  <span class="hljs-keyword">private</span> String message;<br>  <span class="hljs-keyword">private</span> String sql;<br>  <span class="hljs-keyword">private</span> Throwable cause; <br><br>  <span class="hljs-comment">// 单例模式</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">ErrorContext</span><span class="hljs-params">()</span> &#123;<br>  &#125; <br><br>  <span class="hljs-comment">// 工厂方法，得到一个实例</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ErrorContext <span class="hljs-title function_">instance</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 因为是多线程，所以用了ThreadLocal  线程安全</span><br>    <span class="hljs-type">ErrorContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> LOCAL.get();<br>    <span class="hljs-comment">// 懒汉 单例模式</span><br>    <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) &#123;<br>      context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorContext</span>();<br>      LOCAL.set(context);<br>    &#125;<br>    <span class="hljs-keyword">return</span> context;<br>  &#125; <br><br>  <span class="hljs-comment">// 看代码的意思是把ErrorContext存起来供后用，并把ThreadLocal里的东西清空了</span><br>  <span class="hljs-comment">// 这里的代码似乎有点问题</span><br>  <span class="hljs-comment">// 修复代码和相关信息在下面的commit中</span><br>  <span class="hljs-comment">// https://github.com/mybatis/mybatis-3/commit/1e224840c362367d42fa2617581f2446025f7ff4</span><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">store</span><span class="hljs-params">()</span> &#123;<br>    stored = <span class="hljs-built_in">this</span>;<br>    LOCAL.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorContext</span>());<br>    <span class="hljs-keyword">return</span> LOCAL.get();<br>  &#125; <br><br>  <span class="hljs-comment">// 应该是和store相对应的方法，store是存储起来，recall是召回</span><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">recall</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (stored != <span class="hljs-literal">null</span>) &#123;<br>      LOCAL.set(stored);<br>      stored = <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> LOCAL.get();<br>  &#125; <br><br>  <span class="hljs-comment">// 以下都是建造者模式</span><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">resource</span><span class="hljs-params">(String resource)</span> &#123;<br>    <span class="hljs-built_in">this</span>.resource = resource;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">activity</span><span class="hljs-params">(String activity)</span> &#123;<br>    <span class="hljs-built_in">this</span>.activity = activity;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">object</span><span class="hljs-params">(String object)</span> &#123;<br>    <span class="hljs-built_in">this</span>.object = object;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">message</span><span class="hljs-params">(String message)</span> &#123;<br>    <span class="hljs-built_in">this</span>.message = message;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">sql</span><span class="hljs-params">(String sql)</span> &#123;<br>    <span class="hljs-built_in">this</span>.sql = sql;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">cause</span><span class="hljs-params">(Throwable cause)</span> &#123;<br>    <span class="hljs-built_in">this</span>.cause = cause;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// 全部清空重置</span><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">reset</span><span class="hljs-params">()</span> &#123;<br>    resource = <span class="hljs-literal">null</span>;<br>    activity = <span class="hljs-literal">null</span>;<br>    object = <span class="hljs-literal">null</span>;<br>    message = <span class="hljs-literal">null</span>;<br>    sql = <span class="hljs-literal">null</span>;<br>    cause = <span class="hljs-literal">null</span>;<br>    LOCAL.remove();<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// 打印信息供人阅读</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>    <span class="hljs-comment">// message</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.message != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### &quot;</span>);<br>      description.append(<span class="hljs-built_in">this</span>.message);<br>    &#125;<br><br>    <span class="hljs-comment">// resource</span><br>    <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### The error may exist in &quot;</span>);<br>      description.append(resource);<br>    &#125;<br><br>    <span class="hljs-comment">// object</span><br>    <span class="hljs-keyword">if</span> (object != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### The error may involve &quot;</span>);<br>      description.append(object);<br>    &#125;<br><br>    <span class="hljs-comment">// activity</span><br>    <span class="hljs-keyword">if</span> (activity != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### The error occurred while &quot;</span>);<br>      description.append(activity);<br>    &#125;<br><br>    <span class="hljs-comment">// activity</span><br>    <span class="hljs-keyword">if</span> (sql != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### SQL: &quot;</span>);<br>      <span class="hljs-comment">// 把sql压缩到一行里</span><br>      description.append(sql.replace(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>).replace(<span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>).replace(<span class="hljs-string">&#x27;\t&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>).trim());<br>    &#125;<br><br>    <span class="hljs-comment">// cause</span><br>    <span class="hljs-keyword">if</span> (cause != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### Cause: &quot;</span>);<br>      description.append(cause.toString());<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> description.toString();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ResultExtractor"><a href="#ResultExtractor" class="headerlink" title="ResultExtractor"></a>ResultExtractor</h4><p>    结果抽取器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultExtractor</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Configuration configuration;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResultExtractor</span><span class="hljs-params">(Configuration configuration, ObjectFactory objectFactory)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>  &#125; <br><br>  <span class="hljs-comment">// 对targetType为List、Collection和Array时做转换处理</span><br>  <span class="hljs-comment">// 否则，检查并只返回一项</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">extractObjectFromList</span><span class="hljs-params">(List&lt;Object&gt; list, Class&lt;?&gt; targetType)</span> &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (targetType != <span class="hljs-literal">null</span> &amp;&amp; targetType.isAssignableFrom(list.getClass())) &#123;<br>      <span class="hljs-comment">// 1.如果targetType是list，直接返回list</span><br>      value = list;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (targetType != <span class="hljs-literal">null</span> &amp;&amp; objectFactory.isCollection(targetType)) &#123;<br>      <span class="hljs-comment">// 2.如果targetType是Collection，返回包装好的list</span><br>      value = objectFactory.create(targetType);<br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(value);<br>      metaObject.addAll(list);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (targetType != <span class="hljs-literal">null</span> &amp;&amp; targetType.isArray()) &#123;<br>      <span class="hljs-comment">// 3.如果targetType是数组，则list转数组</span><br>      Class&lt;?&gt; arrayComponentType = targetType.getComponentType();<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">array</span> <span class="hljs-operator">=</span> Array.newInstance(arrayComponentType, list.size());<br>      <span class="hljs-keyword">if</span> (arrayComponentType.isPrimitive()) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; list.size(); i++) &#123;<br>          Array.set(array, i, list.get(i));<br>        &#125;<br>        value = array;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        value = list.toArray((Object[])array);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 4.否则返回list的第0个元素</span><br>      <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span> &amp;&amp; list.size() &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Statement returned more than one row, where no more than one was expected.&quot;</span>);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span> &amp;&amp; list.size() == <span class="hljs-number">1</span>) &#123;<br>        value = list.get(<span class="hljs-number">0</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="KeyGenerator"><a href="#KeyGenerator" class="headerlink" title="KeyGenerator"></a>KeyGenerator</h4><p>    键值生成器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">KeyGenerator</span> &#123;<br><br>  <span class="hljs-comment">// 定了2个回调方法，processBefore,processAfter</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBefore</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">processAfter</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="NoKeyGenerator"><a href="#NoKeyGenerator" class="headerlink" title="NoKeyGenerator"></a>NoKeyGenerator</h4><p>    不用键值生成器,MappedStatement有一个keyGenerator属性，默认的就用NoKeyGenerator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NoKeyGenerator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">KeyGenerator</span> &#123;<br><br>  <span class="hljs-comment">// 都是空方法</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBefore</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    <span class="hljs-comment">// Do Nothing</span><br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processAfter</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    <span class="hljs-comment">// Do Nothing</span><br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Jdbc3KeyGenerator"><a href="#Jdbc3KeyGenerator" class="headerlink" title="Jdbc3KeyGenerator"></a>Jdbc3KeyGenerator</h4><p>    JDBC3键值生成器,核心是使用JDBC3的Statement.getGeneratedKeys</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Jdbc3KeyGenerator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">KeyGenerator</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBefore</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    <span class="hljs-comment">// do nothing</span><br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processAfter</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    List&lt;Object&gt; parameters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>    parameters.add(parameter);<br>    processBatch(ms, stmt, parameters);<br>  &#125; <br><br>  <span class="hljs-comment">// 批处理</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBatch</span><span class="hljs-params">(MappedStatement ms, Statement stmt, List&lt;Object&gt; parameters)</span> &#123;<br>    <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 核心是使用JDBC3的Statement.getGeneratedKeys</span><br>      rs = stmt.getGeneratedKeys();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">TypeHandlerRegistry</span> <span class="hljs-variable">typeHandlerRegistry</span> <span class="hljs-operator">=</span> configuration.getTypeHandlerRegistry();<br>      <span class="hljs-keyword">final</span> String[] keyProperties = ms.getKeyProperties();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">rsmd</span> <span class="hljs-operator">=</span> rs.getMetaData();<br>      TypeHandler&lt;?&gt;[] typeHandlers = <span class="hljs-literal">null</span>; <br>      <span class="hljs-comment">// ResultSet 返回的列大于等于定义的返回列的数量</span><br>      <span class="hljs-keyword">if</span> (keyProperties != <span class="hljs-literal">null</span> &amp;&amp; rsmd.getColumnCount() &gt;= keyProperties.length) &#123;<br>        <span class="hljs-keyword">for</span> (Object parameter : parameters) &#123;<br>          <span class="hljs-comment">// there should be one row for each statement (also one for each parameter)</span><br>          <span class="hljs-keyword">if</span> (!rs.next()) &#123;<br>            <span class="hljs-keyword">break</span>;<br>          &#125;<br>          <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaParam</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameter);<br>          <span class="hljs-keyword">if</span> (typeHandlers == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 先取得类型处理器</span><br>            typeHandlers = getTypeHandlers(typeHandlerRegistry, metaParam, keyProperties);<br>          &#125;<br>          <span class="hljs-comment">// 填充键值</span><br>          populateKeys(rs, metaParam, keyProperties, typeHandlers);<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error getting generated key or setting result to parameter object. Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (rs != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          rs.close();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-comment">// ignore</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> TypeHandler&lt;?&gt;[] getTypeHandlers(TypeHandlerRegistry typeHandlerRegistry, MetaObject metaParam, String[] keyProperties) &#123;<br>    TypeHandler&lt;?&gt;[] typeHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;[keyProperties.length];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keyProperties.length; i++) &#123;<br>      <span class="hljs-keyword">if</span> (metaParam.hasSetter(keyProperties[i])) &#123;<br>        Class&lt;?&gt; keyPropertyType = metaParam.getSetterType(keyProperties[i]);<br>        TypeHandler&lt;?&gt; th = typeHandlerRegistry.getTypeHandler(keyPropertyType);<br>        typeHandlers[i] = th;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> typeHandlers;<br>  &#125; <br><br>  <span class="hljs-comment">// 给key属性赋值</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">populateKeys</span><span class="hljs-params">(ResultSet rs, MetaObject metaParam, String[] keyProperties, TypeHandler&lt;?&gt;[] typeHandlers)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keyProperties.length; i++) &#123;<br>      TypeHandler&lt;?&gt; th = typeHandlers[i];<br>      <span class="hljs-keyword">if</span> (th != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> th.getResult(rs, i + <span class="hljs-number">1</span>);<br>        metaParam.setValue(keyProperties[i], value);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="SelectKeyGenerator"><a href="#SelectKeyGenerator" class="headerlink" title="SelectKeyGenerator"></a>SelectKeyGenerator</h4><p>    自定义查询语句KeyGenerator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SelectKeyGenerator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">KeyGenerator</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SELECT_KEY_SUFFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!selectKey&quot;</span>;<br>  <span class="hljs-comment">// 可以自定义在sql语句执行之前还是之后执行selectKey语句</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> executeBefore;<br>  <span class="hljs-keyword">private</span> MappedStatement keyStatement; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SelectKeyGenerator</span><span class="hljs-params">(MappedStatement keyStatement, <span class="hljs-type">boolean</span> executeBefore)</span> &#123;<br>    <span class="hljs-built_in">this</span>.executeBefore = executeBefore;<br>    <span class="hljs-built_in">this</span>.keyStatement = keyStatement;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBefore</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">if</span> (executeBefore) &#123;<br>      processGeneratedKeys(executor, ms, parameter);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processAfter</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!executeBefore) &#123;<br>      processGeneratedKeys(executor, ms, parameter);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processGeneratedKeys</span><span class="hljs-params">(Executor executor, MappedStatement ms, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (parameter != <span class="hljs-literal">null</span> &amp;&amp; keyStatement != <span class="hljs-literal">null</span> &amp;&amp; keyStatement.getKeyProperties() != <span class="hljs-literal">null</span>) &#123;<br>        String[] keyProperties = keyStatement.getKeyProperties();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaParam</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameter);<br>        <span class="hljs-keyword">if</span> (keyProperties != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-comment">// Do not close keyExecutor.</span><br>          <span class="hljs-comment">// The transaction will be closed by parent executor.</span><br>          <span class="hljs-type">Executor</span> <span class="hljs-variable">keyExecutor</span> <span class="hljs-operator">=</span> configuration.newExecutor(executor.getTransaction(), ExecutorType.SIMPLE);<br>          List&lt;Object&gt; values = keyExecutor.query(keyStatement, parameter, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER);<br>          <span class="hljs-keyword">if</span> (values.size() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;SelectKey returned no data.&quot;</span>);            <br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (values.size() &gt; <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;SelectKey returned more than one value.&quot;</span>);<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaResult</span> <span class="hljs-operator">=</span> configuration.newMetaObject(values.get(<span class="hljs-number">0</span>));<br>            <span class="hljs-keyword">if</span> (keyProperties.length == <span class="hljs-number">1</span>) &#123;<br>              <span class="hljs-keyword">if</span> (metaResult.hasGetter(keyProperties[<span class="hljs-number">0</span>])) &#123;<br>                setValue(metaParam, keyProperties[<span class="hljs-number">0</span>], metaResult.getValue(keyProperties[<span class="hljs-number">0</span>]));<br>              &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// no getter for the property - maybe just a single value object</span><br>                <span class="hljs-comment">// so try that</span><br>                setValue(metaParam, keyProperties[<span class="hljs-number">0</span>], values.get(<span class="hljs-number">0</span>));<br>              &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              handleMultipleProperties(keyProperties, metaParam, metaResult);<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (ExecutorException e) &#123;<br>      <span class="hljs-keyword">throw</span> e;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error selecting key or setting result to parameter object. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(MetaObject metaParam, String property, Object value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (metaParam.hasSetter(property)) &#123;<br>      metaParam.setValue(property, value);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;No setter found for the keyProperty &#x27;&quot;</span> + property + <span class="hljs-string">&quot;&#x27; in &quot;</span> + metaParam.getOriginalObject().getClass().getName() + <span class="hljs-string">&quot;.&quot;</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMultipleProperties</span><span class="hljs-params">(String[] keyProperties,</span><br><span class="hljs-params">      MetaObject metaParam, MetaObject metaResult)</span> &#123;<br>    String[] keyColumns = keyStatement.getKeyColumns();<br><br>    <span class="hljs-keyword">if</span> (keyColumns == <span class="hljs-literal">null</span> || keyColumns.length == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// no key columns specified, just use the property names </span><br>      <span class="hljs-comment">// 没有指定key property对应的columns</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keyProperties.length; i++) &#123;<br>        setValue(metaParam, keyProperties[i], metaResult.getValue(keyProperties[i]));<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (keyColumns.length != keyProperties.length) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;If SelectKey has key columns, the number must match the number of key properties.&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keyProperties.length; i++) &#123;<br>        setValue(metaParam, keyProperties[i], metaResult.getValue(keyColumns[i]));<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ProxyFactory"><a href="#ProxyFactory" class="headerlink" title="ProxyFactory"></a>ProxyFactory</h4><p>    代理工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProxyFactory</span> &#123;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span>;<br><br>  Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ResultLoader"><a href="#ResultLoader" class="headerlink" title="ResultLoader"></a>ResultLoader</h4><p>    结果延迟加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultLoader</span> &#123; <br><br>  <span class="hljs-comment">// 配置</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Configuration configuration;<br>  <span class="hljs-comment">// 执行器</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Executor executor;<br>  <span class="hljs-comment">// 映射的语句</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> MappedStatement mappedStatement;<br>  <span class="hljs-comment">// 参数</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Object parameterObject;<br>  <span class="hljs-comment">// 定义的返回类型</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; targetType;<br>  <span class="hljs-comment">// 对象工厂</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory;<br>  <span class="hljs-comment">// cache key</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> CacheKey cacheKey;<br>  <span class="hljs-comment">// 绑定的sql，包括?和绑定的参数</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> BoundSql boundSql;<br>  <span class="hljs-comment">// 结果抽取器</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ResultExtractor resultExtractor;<br>  <span class="hljs-comment">// 创建线程</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> creatorThreadId;<br>  <span class="hljs-comment">// 是否加载</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> loaded;<br>  <span class="hljs-comment">// 结果</span><br>  <span class="hljs-keyword">protected</span> Object resultObject; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResultLoader</span><span class="hljs-params">(Configuration config, Executor executor, MappedStatement mappedStatement, Object parameterObject, Class&lt;?&gt; targetType, CacheKey cacheKey, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = config;<br>    <span class="hljs-built_in">this</span>.executor = executor;<br>    <span class="hljs-built_in">this</span>.mappedStatement = mappedStatement;<br>    <span class="hljs-built_in">this</span>.parameterObject = parameterObject;<br>    <span class="hljs-built_in">this</span>.targetType = targetType;<br>    <span class="hljs-built_in">this</span>.objectFactory = configuration.getObjectFactory();<br>    <span class="hljs-built_in">this</span>.cacheKey = cacheKey;<br>    <span class="hljs-built_in">this</span>.boundSql = boundSql;<br>    <span class="hljs-built_in">this</span>.resultExtractor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultExtractor</span>(configuration, objectFactory);<br>    <span class="hljs-built_in">this</span>.creatorThreadId = Thread.currentThread().getId();<br>  &#125; <br><br>  <span class="hljs-comment">// 加载结果</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">loadResult</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 1.selectList</span><br>    List&lt;Object&gt; list = selectList();<br>    <span class="hljs-comment">// 2.ResultExtractor.extractObjectFromList</span><br>    resultObject = resultExtractor.extractObjectFromList(list, targetType);<br>    <span class="hljs-keyword">return</span> resultObject;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Executor</span> <span class="hljs-variable">localExecutor</span> <span class="hljs-operator">=</span> executor;<br>    <span class="hljs-comment">// 如果executor已经被关闭了，则创建一个新的</span><br>    <span class="hljs-keyword">if</span> (Thread.currentThread().getId() != <span class="hljs-built_in">this</span>.creatorThreadId || localExecutor.isClosed()) &#123;<br>      localExecutor = newExecutor();<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 委托给Executor.query</span><br>      <span class="hljs-keyword">return</span> localExecutor.&lt;E&gt; query(mappedStatement, parameterObject, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER, cacheKey, boundSql);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (localExecutor != executor) &#123;<br>        localExecutor.close(<span class="hljs-literal">false</span>);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> configuration.getEnvironment();<br>    <span class="hljs-keyword">if</span> (environment == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;ResultLoader could not load lazily.  Environment was not configured.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">DataSource</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> environment.getDataSource();<br>    <span class="hljs-keyword">if</span> (ds == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;ResultLoader could not load lazily.  DataSource was not configured.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">transactionFactory</span> <span class="hljs-operator">=</span> environment.getTransactionFactory();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Transaction</span> <span class="hljs-variable">tx</span> <span class="hljs-operator">=</span> transactionFactory.newTransaction(ds, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">// 如果executor已经被关闭了，则创建一个新的SimpleExecutor</span><br>    <span class="hljs-keyword">return</span> configuration.newExecutor(tx, ExecutorType.SIMPLE);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">wasNull</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> resultObject == <span class="hljs-literal">null</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ResultLoaderMap"><a href="#ResultLoaderMap" class="headerlink" title="ResultLoaderMap"></a>ResultLoaderMap</h4><p>    结果延迟加载器映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultLoaderMap</span> &#123; <br><br>  <span class="hljs-comment">// 加载对应的hashmap</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, LoadPair&gt; loaderMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, LoadPair&gt;();<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Property which was not loaded yet.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// 静态内部类，加载对</span><br>  <span class="hljs-comment">// 尚未加载的属性</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadPair</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">20130412</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Name of factory method which returns database connection.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FACTORY_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;getConfiguration&quot;</span>; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Object to check whether we went through serialization..</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">transient</span> <span class="hljs-type">Object</span> <span class="hljs-variable">serializationCheck</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Meta object which sets loaded properties.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> MetaObject metaResultObject; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Result loader which loads unread properties.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// 通过ResultLoader加载属性</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> ResultLoader resultLoader; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Wow, logger.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Log log; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Factory class through which we get database connection.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; configurationFactory; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Name of the unread property.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// 尚未加载的属性名称</span><br>    <span class="hljs-keyword">private</span> String property; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ID of SQL statement which loads the property.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String mappedStatement; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Parameter of the sql statement.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Serializable mappedParameter; <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">LoadPair</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String property, MetaObject metaResultObject, ResultLoader resultLoader)</span> &#123;<br>      <span class="hljs-built_in">this</span>.property = property;<br>      <span class="hljs-built_in">this</span>.metaResultObject = metaResultObject;<br>      <span class="hljs-built_in">this</span>.resultLoader = resultLoader;<br><br>      <span class="hljs-comment">/* Save required information only if original object can be serialized. */</span><br>      <span class="hljs-keyword">if</span> (metaResultObject != <span class="hljs-literal">null</span> &amp;&amp; metaResultObject.getOriginalObject() <span class="hljs-keyword">instanceof</span> Serializable) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mappedStatementParameter</span> <span class="hljs-operator">=</span> resultLoader.parameterObject;<br><br>        <span class="hljs-comment">/* @todo May the parameter be null? */</span><br>        <span class="hljs-keyword">if</span> (mappedStatementParameter <span class="hljs-keyword">instanceof</span> Serializable) &#123;<br>          <span class="hljs-built_in">this</span>.mappedStatement = resultLoader.mappedStatement.getId();<br>          <span class="hljs-built_in">this</span>.mappedParameter = (Serializable) mappedStatementParameter;<br><br>          <span class="hljs-built_in">this</span>.configurationFactory = resultLoader.configuration.getConfigurationFactory();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-built_in">this</span>.getLogger().debug(<span class="hljs-string">&quot;Property [&quot;</span> + <span class="hljs-built_in">this</span>.property + <span class="hljs-string">&quot;] of [&quot;</span><br>                  + metaResultObject.getOriginalObject().getClass() + <span class="hljs-string">&quot;] cannot be loaded &quot;</span><br>                  + <span class="hljs-string">&quot;after deserialization. Make sure it&#x27;s loaded before serializing &quot;</span><br>                  + <span class="hljs-string">&quot;forenamed object.&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-comment">/* These field should not be null unless the loadpair was serialized.</span><br><span class="hljs-comment">       * Yet in that case this method should not be called. */</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.metaResultObject == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;metaResultObject is null&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.resultLoader == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;resultLoader is null&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-built_in">this</span>.load(<span class="hljs-literal">null</span>);<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-comment">/* These field should not be null unless the loadpair was serialized.</span><br><span class="hljs-comment">       * Yet in that case this method should not be called. */</span><br>      <span class="hljs-comment">// 除非loadpair可序列化，否则 this.metaResultObject 和</span><br>      <span class="hljs-comment">// this.resultLoader应该非空</span><br>      <span class="hljs-comment">// 而loadpair可序列化时，这个方法不应该被调用</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.metaResultObject == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;metaResultObject is null&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.resultLoader == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;resultLoader is null&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-built_in">this</span>.load(<span class="hljs-literal">null</span>);<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object userObject)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.metaResultObject == <span class="hljs-literal">null</span> || <span class="hljs-built_in">this</span>.resultLoader == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.mappedParameter == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-comment">// 对应构造函数中的判断</span><br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Property [&quot;</span> + <span class="hljs-built_in">this</span>.property + <span class="hljs-string">&quot;] cannot be loaded because &quot;</span><br>                  + <span class="hljs-string">&quot;required parameter of mapped statement [&quot;</span><br>                  + <span class="hljs-built_in">this</span>.mappedStatement + <span class="hljs-string">&quot;] is not serializable.&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Configuration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getConfiguration();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> config.getMappedStatement(<span class="hljs-built_in">this</span>.mappedStatement);<br>        <span class="hljs-keyword">if</span> (ms == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot lazy load property [&quot;</span> + <span class="hljs-built_in">this</span>.property<br>                  + <span class="hljs-string">&quot;] of deserialized object [&quot;</span> + userObject.getClass()<br>                  + <span class="hljs-string">&quot;] because configuration does not contain statement [&quot;</span><br>                  + <span class="hljs-built_in">this</span>.mappedStatement + <span class="hljs-string">&quot;]&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.metaResultObject = config.newMetaObject(userObject);<br>        <span class="hljs-built_in">this</span>.resultLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoader</span>(config, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClosedExecutor</span>(), ms, <span class="hljs-built_in">this</span>.mappedParameter,<br>                metaResultObject.getSetterType(<span class="hljs-built_in">this</span>.property), <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>      &#125;<br><br>      <span class="hljs-comment">/* We are using a new executor because we may be (and likely are) on a new thread</span><br><span class="hljs-comment">       * and executors aren&#x27;t thread safe. (Is this sufficient?)</span><br><span class="hljs-comment">       *</span><br><span class="hljs-comment">       * A better approach would be making executors thread safe. */</span><br>      <span class="hljs-comment">// 可能是在新的线程中，而executor不是线程安全的，所以用了一个新的excutor</span><br>      <span class="hljs-comment">// 更好的方法是使得executors线程安全</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.serializationCheck == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ResultLoader</span> <span class="hljs-variable">old</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.resultLoader;<br>        <span class="hljs-built_in">this</span>.resultLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoader</span>(old.configuration, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClosedExecutor</span>(), old.mappedStatement,<br>                old.parameterObject, old.targetType, old.cacheKey, old.boundSql);<br>      &#125;<br>      <span class="hljs-comment">// 就是构造resultLoader后设置属性</span><br>      <span class="hljs-built_in">this</span>.metaResultObject.setValue(property, <span class="hljs-built_in">this</span>.resultLoader.loadResult());<br>    &#125; <br><br>    <span class="hljs-comment">// 通过反射获取配置</span><br>    <span class="hljs-keyword">private</span> Configuration <span class="hljs-title function_">getConfiguration</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.configurationFactory == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as configuration factory was not set.&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-type">Object</span> <span class="hljs-variable">configurationObject</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Method</span> <span class="hljs-variable">factoryMethod</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.configurationFactory.getDeclaredMethod(FACTORY_METHOD);<br>        <span class="hljs-keyword">if</span> (!Modifier.isStatic(factoryMethod.getModifiers())) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as factory method [&quot;</span><br>                  + <span class="hljs-built_in">this</span>.configurationFactory + <span class="hljs-string">&quot;]#[&quot;</span><br>                  + FACTORY_METHOD + <span class="hljs-string">&quot;] is not static.&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!factoryMethod.isAccessible()) &#123;<br>          configurationObject = AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedExceptionAction</span>&lt;Object&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>              <span class="hljs-keyword">try</span> &#123;<br>                factoryMethod.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-keyword">return</span> factoryMethod.invoke(<span class="hljs-literal">null</span>);<br>              &#125; <span class="hljs-keyword">finally</span> &#123;<br>                factoryMethod.setAccessible(<span class="hljs-literal">false</span>);<br>              &#125;<br>            &#125;<br>          &#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          configurationObject = factoryMethod.invoke(<span class="hljs-literal">null</span>);<br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> NoSuchMethodException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as factory class [&quot;</span><br>                + <span class="hljs-built_in">this</span>.configurationFactory + <span class="hljs-string">&quot;] is missing factory method of name [&quot;</span><br>                + FACTORY_METHOD + <span class="hljs-string">&quot;].&quot;</span>, ex);<br>      &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> PrivilegedActionException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as factory method [&quot;</span><br>                + <span class="hljs-built_in">this</span>.configurationFactory + <span class="hljs-string">&quot;]#[&quot;</span><br>                + FACTORY_METHOD + <span class="hljs-string">&quot;] threw an exception.&quot;</span>, ex.getCause());<br>      &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> Exception ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as factory method [&quot;</span><br>                + <span class="hljs-built_in">this</span>.configurationFactory + <span class="hljs-string">&quot;]#[&quot;</span><br>                + FACTORY_METHOD + <span class="hljs-string">&quot;] threw an exception.&quot;</span>, ex);<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (!(configurationObject <span class="hljs-keyword">instanceof</span> Configuration)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as factory method [&quot;</span><br>                + <span class="hljs-built_in">this</span>.configurationFactory + <span class="hljs-string">&quot;]#[&quot;</span><br>                + FACTORY_METHOD + <span class="hljs-string">&quot;] didn&#x27;t return [&quot;</span> + Configuration.class + <span class="hljs-string">&quot;] but [&quot;</span><br>                + (configurationObject == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;null&quot;</span> : configurationObject.getClass()) + <span class="hljs-string">&quot;].&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-keyword">return</span> Configuration.class.cast(configurationObject);<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> Log <span class="hljs-title function_">getLogger</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.log == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.log = LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.log;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 关闭了的Excutor，啥都不能干</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClosedExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClosedExecutor</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-built_in">super</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isClosed</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Not supported.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Not supported.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Not supported.&quot;</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 把要延迟加载的属性记到ResultLoaderMap里（一个哈希表）</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addLoader</span><span class="hljs-params">(String property, MetaObject metaResultObject, ResultLoader resultLoader)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">upperFirst</span> <span class="hljs-operator">=</span> getUppercaseFirstProperty(property);<br>    <span class="hljs-keyword">if</span> (!upperFirst.equalsIgnoreCase(property) &amp;&amp; loaderMap.containsKey(upperFirst)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Nested lazy loaded result property &#x27;&quot;</span> + property +<br>              <span class="hljs-string">&quot;&#x27; for query id &#x27;&quot;</span> + resultLoader.mappedStatement.getId() +<br>              <span class="hljs-string">&quot; already exists in the result map. The leftmost property of all lazy loaded properties must be unique within a result map.&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// key是property，这样当客户端调用getter来取真实值时，会判断这个属性是否是延迟加载属性，是才去加载</span><br>    <span class="hljs-comment">// 可参见CglibProxyFactory的代码</span><br>    <span class="hljs-comment">//    if (lazyLoader.hasLoader(property)) &#123;</span><br>    <span class="hljs-comment">//        lazyLoader.load(property);</span><br>    <span class="hljs-comment">//    &#125;</span><br>    loaderMap.put(upperFirst, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadPair</span>(property, metaResultObject, resultLoader));<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getUppercaseFirstProperty</span><span class="hljs-params">(String property)</span> &#123;<br>    String[] parts = property.split(<span class="hljs-string">&quot;\\.&quot;</span>);<br>    <span class="hljs-keyword">return</span> parts[<span class="hljs-number">0</span>].toUpperCase(Locale.ENGLISH);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Map&lt;String, LoadPair&gt; <span class="hljs-title function_">getProperties</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, LoadPair&gt;(<span class="hljs-built_in">this</span>.loaderMap);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title function_">getPropertyNames</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> loaderMap.keySet();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> loaderMap.size();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasLoader</span><span class="hljs-params">(String property)</span> &#123;<br>    <span class="hljs-keyword">return</span> loaderMap.containsKey(property.toUpperCase(Locale.ENGLISH));<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">load</span><span class="hljs-params">(String property)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 先删除key，防止第二次又去查数据库就不对了</span><br>    <span class="hljs-type">LoadPair</span> <span class="hljs-variable">pair</span> <span class="hljs-operator">=</span> loaderMap.remove(property.toUpperCase(Locale.ENGLISH));<br>    <span class="hljs-keyword">if</span> (pair != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 去数据库查</span><br>      pair.load();<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> Set&lt;String&gt; methodNameSet = loaderMap.keySet();<br>    <span class="hljs-comment">// 为啥要转成Array...</span><br>    String[] methodNames = methodNameSet.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[methodNameSet.size()]);<br>    <span class="hljs-keyword">for</span> (String methodName : methodNames) &#123;<br>      load(methodName);<br>    &#125;<br>  &#125; <br><br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="WriteReplaceInterface"><a href="#WriteReplaceInterface" class="headerlink" title="WriteReplaceInterface"></a>WriteReplaceInterface</h4><p>    这个接口在这个版本的mybatis中似乎没有用到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WriteReplaceInterface</span> &#123;<br><br>  Object <span class="hljs-title function_">writeReplace</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ObjectStreamException;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ProxyFactory-1"><a href="#ProxyFactory-1" class="headerlink" title="ProxyFactory"></a>ProxyFactory</h4><p>    延迟加载代理工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProxyFactory</span> &#123;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span>;<br><br>  Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="AbstractSerialStateHolder"><a href="#AbstractSerialStateHolder" class="headerlink" title="AbstractSerialStateHolder"></a>AbstractSerialStateHolder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractSerialStateHolder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Externalizable</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8940388717901644661L</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ObjectOutputStream&gt; stream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;ObjectOutputStream&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] userBeanBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">private</span> Object userBean;<br>  <span class="hljs-keyword">private</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties;<br>  <span class="hljs-keyword">private</span> ObjectFactory objectFactory;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt;[] constructorArgTypes;<br>  <span class="hljs-keyword">private</span> Object[] constructorArgs;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractSerialStateHolder</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractSerialStateHolder</span><span class="hljs-params">(</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Object userBean,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes,</span><br><span class="hljs-params">          List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-built_in">this</span>.userBean = userBean;<br>    <span class="hljs-built_in">this</span>.unloadedProperties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, ResultLoaderMap.LoadPair&gt;(unloadedProperties);<br>    <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>    <span class="hljs-built_in">this</span>.constructorArgTypes = constructorArgTypes.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[constructorArgTypes.size()]);<br>    <span class="hljs-built_in">this</span>.constructorArgs = constructorArgs.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[constructorArgs.size()]);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeExternal</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ObjectOutput out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">firstRound</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>    <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> stream.get();<br>    <span class="hljs-keyword">if</span> (os == <span class="hljs-literal">null</span>) &#123;<br>      os = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>      firstRound = <span class="hljs-literal">true</span>;<br>      stream.set(os);<br>    &#125;<br><br>    os.writeObject(<span class="hljs-built_in">this</span>.userBean);<br>    os.writeObject(<span class="hljs-built_in">this</span>.unloadedProperties);<br>    os.writeObject(<span class="hljs-built_in">this</span>.objectFactory);<br>    os.writeObject(<span class="hljs-built_in">this</span>.constructorArgTypes);<br>    os.writeObject(<span class="hljs-built_in">this</span>.constructorArgs);<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] bytes = baos.toByteArray();<br>    out.writeObject(bytes);<br><br>    <span class="hljs-keyword">if</span> (firstRound) &#123;<br>      stream.remove();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readExternal</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ObjectInput in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> in.readObject();<br>    <span class="hljs-keyword">if</span> (data.getClass().isArray()) &#123;<br>      <span class="hljs-built_in">this</span>.userBeanBytes = (<span class="hljs-type">byte</span>[]) data;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">this</span>.userBean = data;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Object <span class="hljs-title function_">readResolve</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ObjectStreamException &#123;<br>    <span class="hljs-comment">/* Second run */</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.userBean != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.userBeanBytes.length == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.userBean;<br>    &#125;<br><br>    <span class="hljs-comment">/* First run */</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(<span class="hljs-built_in">this</span>.userBeanBytes));<br>      <span class="hljs-built_in">this</span>.userBean = in.readObject();<br>      <span class="hljs-built_in">this</span>.unloadedProperties = (Map&lt;String, ResultLoaderMap.LoadPair&gt;) in.readObject();<br>      <span class="hljs-built_in">this</span>.objectFactory = (ObjectFactory) in.readObject();<br>      <span class="hljs-built_in">this</span>.constructorArgTypes = (Class&lt;?&gt;[]) in.readObject();<br>      <span class="hljs-built_in">this</span>.constructorArgs = (Object[]) in.readObject();<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> IOException ex) &#123;<br>      <span class="hljs-keyword">throw</span> (ObjectStreamException) <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamCorruptedException</span>().initCause(ex);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> ClassNotFoundException ex) &#123;<br>      <span class="hljs-keyword">throw</span> (ObjectStreamException) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(ex.getLocalizedMessage()).initCause(ex);<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; arrayProps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, ResultLoaderMap.LoadPair&gt;(<span class="hljs-built_in">this</span>.unloadedProperties);<br>    <span class="hljs-keyword">final</span> List&lt;Class&lt;?&gt;&gt; arrayTypes = Arrays.asList(<span class="hljs-built_in">this</span>.constructorArgTypes);<br>    <span class="hljs-keyword">final</span> List&lt;Object&gt; arrayValues = Arrays.asList(<span class="hljs-built_in">this</span>.constructorArgs);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createDeserializationProxy(userBean, arrayProps, objectFactory, arrayTypes, arrayValues);<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title function_">createDeserializationProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="AbstractEnhancedDeserializationProxy"><a href="#AbstractEnhancedDeserializationProxy" class="headerlink" title="AbstractEnhancedDeserializationProxy"></a>AbstractEnhancedDeserializationProxy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractEnhancedDeserializationProxy</span> &#123; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FINALIZE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;finalize&quot;</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WRITE_REPLACE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;writeReplace&quot;</span>;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>  <span class="hljs-keyword">private</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties;<br>  <span class="hljs-keyword">private</span> ObjectFactory objectFactory;<br>  <span class="hljs-keyword">private</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes;<br>  <span class="hljs-keyword">private</span> List&lt;Object&gt; constructorArgs;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object reloadingPropertyLock;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> reloadingProperty; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">AbstractEnhancedDeserializationProxy</span><span class="hljs-params">(Class&lt;?&gt; type, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties,</span><br><span class="hljs-params">          ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-built_in">this</span>.type = type;<br>    <span class="hljs-built_in">this</span>.unloadedProperties = unloadedProperties;<br>    <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>    <span class="hljs-built_in">this</span>.constructorArgTypes = constructorArgTypes;<br>    <span class="hljs-built_in">this</span>.constructorArgs = constructorArgs;<br>    <span class="hljs-built_in">this</span>.reloadingPropertyLock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-built_in">this</span>.reloadingProperty = <span class="hljs-literal">false</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object enhanced, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (WRITE_REPLACE_METHOD.equals(methodName)) &#123;<br>        <span class="hljs-keyword">final</span> Object original;<br>        <span class="hljs-keyword">if</span> (constructorArgTypes.isEmpty()) &#123;<br>          original = objectFactory.create(type);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          original = objectFactory.create(type, constructorArgTypes, constructorArgs);<br>        &#125;<br><br>        PropertyCopier.copyBeanProperties(type, enhanced, original);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.newSerialStateHolder(original, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.reloadingPropertyLock) &#123;<br>          <span class="hljs-keyword">if</span> (!FINALIZE_METHOD.equals(methodName) &amp;&amp; PropertyNamer.isProperty(methodName) &amp;&amp; !reloadingProperty) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> PropertyNamer.methodToProperty(methodName);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">propertyKey</span> <span class="hljs-operator">=</span> property.toUpperCase(Locale.ENGLISH);<br>            <span class="hljs-keyword">if</span> (unloadedProperties.containsKey(propertyKey)) &#123;<br>              <span class="hljs-keyword">final</span> ResultLoaderMap.<span class="hljs-type">LoadPair</span> <span class="hljs-variable">loadPair</span> <span class="hljs-operator">=</span> unloadedProperties.remove(propertyKey);<br>              <span class="hljs-keyword">if</span> (loadPair != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                  reloadingProperty = <span class="hljs-literal">true</span>;<br>                  loadPair.load(enhanced);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                  reloadingProperty = <span class="hljs-literal">false</span>;<br>                &#125;<br>              &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">/* I&#x27;m not sure if this case can really happen or is just in tests -</span><br><span class="hljs-comment">                 * we have an unread property but no loadPair to load it. */</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;An attempt has been made to read a not loaded lazy property &#x27;&quot;</span><br>                        + property + <span class="hljs-string">&quot;&#x27; of a disconnected object&quot;</span>);<br>              &#125;<br>            &#125;<br>          &#125;<br><br>          <span class="hljs-keyword">return</span> enhanced;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> AbstractSerialStateHolder <span class="hljs-title function_">newSerialStateHolder</span><span class="hljs-params">(</span><br><span class="hljs-params">          Object userBean,</span><br><span class="hljs-params">          Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties,</span><br><span class="hljs-params">          ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes,</span><br><span class="hljs-params">          List&lt;Object&gt; constructorArgs)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="CglibProxyFactory"><a href="#CglibProxyFactory" class="headerlink" title="CglibProxyFactory"></a>CglibProxyFactory</h4><p>    Cglib延迟加载代理工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibProxyFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProxyFactory</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(CglibProxyFactory.class);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FINALIZE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;finalize&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WRITE_REPLACE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;writeReplace&quot;</span>; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CglibProxyFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 先检查是否有Cglib</span><br>      Resources.classForName(<span class="hljs-string">&quot;net.sf.cglib.proxy.Enhancer&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Cannot enable lazy loading because CGLIB is not available. Add CGLIB to your classpath.&quot;</span>, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> EnhancedResultObjectProxyImpl.createProxy(target, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">createDeserializationProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> EnhancedDeserializationProxyImpl.createProxy(target, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span> &#123;<br>      <span class="hljs-comment">// Not Implemented</span><br>  &#125;<br><br>  <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">crateProxy</span><span class="hljs-params">(Class&lt;?&gt; type, Callback callback, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-comment">// 核心就是用cglib的Enhancer</span><br>    <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();<br>    enhancer.setCallback(callback);<br>    enhancer.setSuperclass(type);<br>    <span class="hljs-keyword">try</span> &#123;<br>      type.getDeclaredMethod(WRITE_REPLACE_METHOD);<br>      <span class="hljs-comment">// ObjectOutputStream will call writeReplace of objects returned by writeReplace</span><br>      log.debug(WRITE_REPLACE_METHOD + <span class="hljs-string">&quot; method was found on bean &quot;</span> + type + <span class="hljs-string">&quot;, make sure it returns this&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>      enhancer.setInterfaces(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;WriteReplaceInterface.class&#125;);<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>      <span class="hljs-comment">// nothing to do here</span><br>    &#125;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (constructorArgTypes.isEmpty()) &#123;<br>      enhanced = enhancer.create();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      Class&lt;?&gt;[] typesArray = constructorArgTypes.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[constructorArgTypes.size()]);<br>      Object[] valuesArray = constructorArgs.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[constructorArgs.size()]);<br>      enhanced = enhancer.create(typesArray, valuesArray);<br>    &#125;<br>    <span class="hljs-keyword">return</span> enhanced;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedResultObjectProxyImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>    <span class="hljs-keyword">private</span> ResultLoaderMap lazyLoader;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> aggressive;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; lazyLoadTriggerMethods;<br>    <span class="hljs-keyword">private</span> ObjectFactory objectFactory;<br>    <span class="hljs-keyword">private</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes;<br>    <span class="hljs-keyword">private</span> List&lt;Object&gt; constructorArgs; <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">EnhancedResultObjectProxyImpl</span><span class="hljs-params">(Class&lt;?&gt; type, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-built_in">this</span>.type = type;<br>      <span class="hljs-built_in">this</span>.lazyLoader = lazyLoader;<br>      <span class="hljs-built_in">this</span>.aggressive = configuration.isAggressiveLazyLoading();<br>      <span class="hljs-built_in">this</span>.lazyLoadTriggerMethods = configuration.getLazyLoadTriggerMethods();<br>      <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>      <span class="hljs-built_in">this</span>.constructorArgTypes = constructorArgTypes;<br>      <span class="hljs-built_in">this</span>.constructorArgs = constructorArgs;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; type = target.getClass();<br>      <span class="hljs-type">EnhancedResultObjectProxyImpl</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnhancedResultObjectProxyImpl</span>(type, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> crateProxy(type, callback, constructorArgTypes, constructorArgs);<br>      PropertyCopier.copyBeanProperties(type, target, enhanced);<br>      <span class="hljs-keyword">return</span> enhanced;<br>    &#125; <br><br>    <span class="hljs-comment">// cglib拦截方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object enhanced, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (lazyLoader) &#123;<br>          <span class="hljs-keyword">if</span> (WRITE_REPLACE_METHOD.equals(methodName)) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">original</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (constructorArgTypes.isEmpty()) &#123;<br>              original = objectFactory.create(type);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              original = objectFactory.create(type, constructorArgTypes, constructorArgs);<br>            &#125;<br>            PropertyCopier.copyBeanProperties(type, enhanced, original);<br>            <span class="hljs-keyword">if</span> (lazyLoader.size() &gt; <span class="hljs-number">0</span>) &#123;<br>              <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CglibSerialStateHolder</span>(original, lazyLoader.getProperties(), objectFactory, constructorArgTypes, constructorArgs);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-keyword">return</span> original;<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 这里是关键，延迟加载就是调用ResultLoaderMap.loadAll()</span><br>            <span class="hljs-keyword">if</span> (lazyLoader.size() &gt; <span class="hljs-number">0</span> &amp;&amp; !FINALIZE_METHOD.equals(methodName)) &#123;<br>              <span class="hljs-keyword">if</span> (aggressive || lazyLoadTriggerMethods.contains(methodName)) &#123;<br>                lazyLoader.loadAll();<br>              &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (PropertyNamer.isProperty(methodName)) &#123;<br>                  <span class="hljs-comment">// 或者调用ResultLoaderMap.load()</span><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> PropertyNamer.methodToProperty(methodName);<br>                <span class="hljs-keyword">if</span> (lazyLoader.hasLoader(property)) &#123;<br>                  lazyLoader.load(property);<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> methodProxy.invokeSuper(enhanced, args);<br>      &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 这个代理判断方法名称是 WRITE_REPLACE_METHOD，则返回 AbstractSerialStateHolder</span><br>  <span class="hljs-comment">// 否则进行延迟加载</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedDeserializationProxyImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractEnhancedDeserializationProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">EnhancedDeserializationProxyImpl</span><span class="hljs-params">(Class&lt;?&gt; type, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-built_in">super</span>(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; type = target.getClass();<br>      <span class="hljs-type">EnhancedDeserializationProxyImpl</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnhancedDeserializationProxyImpl</span>(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> crateProxy(type, callback, constructorArgTypes, constructorArgs);<br>      PropertyCopier.copyBeanProperties(type, target, enhanced);<br>      <span class="hljs-keyword">return</span> enhanced;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object enhanced, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.invoke(enhanced, method, args);<br>      <span class="hljs-keyword">return</span> (o <span class="hljs-keyword">instanceof</span> AbstractSerialStateHolder) ? o : methodProxy.invokeSuper(o, args);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AbstractSerialStateHolder <span class="hljs-title function_">newSerialStateHolder</span><span class="hljs-params">(Object userBean, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CglibSerialStateHolder</span>(userBean, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="CglibSerialStateHolder"><a href="#CglibSerialStateHolder" class="headerlink" title="CglibSerialStateHolder"></a>CglibSerialStateHolder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibSerialStateHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSerialStateHolder</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8940388717901644661L</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CglibSerialStateHolder</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CglibSerialStateHolder</span><span class="hljs-params">(</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Object userBean,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes,</span><br><span class="hljs-params">          List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-built_in">super</span>(userBean, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createDeserializationProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CglibProxyFactory</span>().createDeserializationProxy(target, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="JavassistProxyFactory"><a href="#JavassistProxyFactory" class="headerlink" title="JavassistProxyFactory"></a>JavassistProxyFactory</h4><p>    Javassist延迟加载代理工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavassistProxyFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">org</span>.apache.ibatis.executor.loader.ProxyFactory &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(JavassistProxyFactory.class);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FINALIZE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;finalize&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WRITE_REPLACE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;writeReplace&quot;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JavassistProxyFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//先检查是否有javassist</span><br>      Resources.classForName(<span class="hljs-string">&quot;javassist.util.proxy.ProxyFactory&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Cannot enable lazy loading because Javassist is not available. Add Javassist to your classpath.&quot;</span>, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> EnhancedResultObjectProxyImpl.createProxy(target, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">createDeserializationProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> EnhancedDeserializationProxyImpl.createProxy(target, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span> &#123;<br>      <span class="hljs-comment">// Not Implemented</span><br>  &#125;<br><br>  <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">crateProxy</span><span class="hljs-params">(Class&lt;?&gt; type, MethodHandler callback, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br><br>    <span class="hljs-comment">// 核心就是用javassist的ProxyFactory,没啥可说的，下面逻辑都是cglib的翻版</span><br>    <span class="hljs-type">ProxyFactory</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyFactory</span>();<br>    enhancer.setSuperclass(type);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      type.getDeclaredMethod(WRITE_REPLACE_METHOD);<br>      <span class="hljs-comment">// ObjectOutputStream will call writeReplace of objects returned by writeReplace</span><br>      log.debug(WRITE_REPLACE_METHOD + <span class="hljs-string">&quot; method was found on bean &quot;</span> + type + <span class="hljs-string">&quot;, make sure it returns this&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>      enhancer.setInterfaces(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;WriteReplaceInterface.class&#125;);<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>      <span class="hljs-comment">// nothing to do here</span><br>    &#125;<br><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    Class&lt;?&gt;[] typesArray = constructorArgTypes.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[constructorArgTypes.size()]);<br>    Object[] valuesArray = constructorArgs.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[constructorArgs.size()]);<br>    <span class="hljs-keyword">try</span> &#123;<br>      enhanced = enhancer.create(typesArray, valuesArray);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error creating lazy proxy.  Cause: &quot;</span> + e, e);<br>    &#125;<br>    ((Proxy) enhanced).setHandler(callback);<br>    <span class="hljs-keyword">return</span> enhanced;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedResultObjectProxyImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodHandler</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>    <span class="hljs-keyword">private</span> ResultLoaderMap lazyLoader;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> aggressive;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; lazyLoadTriggerMethods;<br>    <span class="hljs-keyword">private</span> ObjectFactory objectFactory;<br>    <span class="hljs-keyword">private</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes;<br>    <span class="hljs-keyword">private</span> List&lt;Object&gt; constructorArgs;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">EnhancedResultObjectProxyImpl</span><span class="hljs-params">(Class&lt;?&gt; type, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-built_in">this</span>.type = type;<br>      <span class="hljs-built_in">this</span>.lazyLoader = lazyLoader;<br>      <span class="hljs-built_in">this</span>.aggressive = configuration.isAggressiveLazyLoading();<br>      <span class="hljs-built_in">this</span>.lazyLoadTriggerMethods = configuration.getLazyLoadTriggerMethods();<br>      <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>      <span class="hljs-built_in">this</span>.constructorArgTypes = constructorArgTypes;<br>      <span class="hljs-built_in">this</span>.constructorArgs = constructorArgs;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; type = target.getClass();<br>      <span class="hljs-type">EnhancedResultObjectProxyImpl</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnhancedResultObjectProxyImpl</span>(type, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> crateProxy(type, callback, constructorArgTypes, constructorArgs);<br>      PropertyCopier.copyBeanProperties(type, target, enhanced);<br>      <span class="hljs-keyword">return</span> enhanced;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object enhanced, Method method, Method methodProxy, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (lazyLoader) &#123;<br>          <span class="hljs-keyword">if</span> (WRITE_REPLACE_METHOD.equals(methodName)) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">original</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (constructorArgTypes.isEmpty()) &#123;<br>              original = objectFactory.create(type);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              original = objectFactory.create(type, constructorArgTypes, constructorArgs);<br>            &#125;<br>            PropertyCopier.copyBeanProperties(type, enhanced, original);<br>            <span class="hljs-keyword">if</span> (lazyLoader.size() &gt; <span class="hljs-number">0</span>) &#123;<br>              <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavassistSerialStateHolder</span>(original, lazyLoader.getProperties(), objectFactory, constructorArgTypes, constructorArgs);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-keyword">return</span> original;<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (lazyLoader.size() &gt; <span class="hljs-number">0</span> &amp;&amp; !FINALIZE_METHOD.equals(methodName)) &#123;<br>              <span class="hljs-keyword">if</span> (aggressive || lazyLoadTriggerMethods.contains(methodName)) &#123;<br>                lazyLoader.loadAll();<br>              &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (PropertyNamer.isProperty(methodName)) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> PropertyNamer.methodToProperty(methodName);<br>                <span class="hljs-keyword">if</span> (lazyLoader.hasLoader(property)) &#123;<br>                  lazyLoader.load(property);<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> methodProxy.invoke(enhanced, args);<br>      &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedDeserializationProxyImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractEnhancedDeserializationProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodHandler</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">EnhancedDeserializationProxyImpl</span><span class="hljs-params">(Class&lt;?&gt; type, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-built_in">super</span>(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; type = target.getClass();<br>      <span class="hljs-type">EnhancedDeserializationProxyImpl</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnhancedDeserializationProxyImpl</span>(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> crateProxy(type, callback, constructorArgTypes, constructorArgs);<br>      PropertyCopier.copyBeanProperties(type, target, enhanced);<br>      <span class="hljs-keyword">return</span> enhanced;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object enhanced, Method method, Method methodProxy, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.invoke(enhanced, method, args);<br>      <span class="hljs-keyword">return</span> (o <span class="hljs-keyword">instanceof</span> AbstractSerialStateHolder) ? o : methodProxy.invoke(o, args);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AbstractSerialStateHolder <span class="hljs-title function_">newSerialStateHolder</span><span class="hljs-params">(Object userBean, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavassistSerialStateHolder</span>(userBean, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>    &#125;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="JavassistSerialStateHolder"><a href="#JavassistSerialStateHolder" class="headerlink" title="JavassistSerialStateHolder"></a>JavassistSerialStateHolder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JavassistSerialStateHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSerialStateHolder</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8940388717901644661L</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JavassistSerialStateHolder</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JavassistSerialStateHolder</span><span class="hljs-params">(</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Object userBean,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes,</span><br><span class="hljs-params">          List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-built_in">super</span>(userBean, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createDeserializationProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavassistProxyFactory</span>().createDeserializationProxy(target, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ParameterHandler"><a href="#ParameterHandler" class="headerlink" title="ParameterHandler"></a>ParameterHandler</h4><p>    参数处理器,其实现类DefaultParameterHandler已在scripting模块讲过</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ParameterHandler</span> &#123;<br><br>  <span class="hljs-comment">// 得到参数</span><br>  Object <span class="hljs-title function_">getParameterObject</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">// 设置参数</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameters</span><span class="hljs-params">(PreparedStatement ps)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="DefaultResultHandler"><a href="#DefaultResultHandler" class="headerlink" title="DefaultResultHandler"></a>DefaultResultHandler</h4><p>    默认结果处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultResultHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResultHandler</span> &#123;<br><br>  <span class="hljs-comment">// 内部实现是存了一个List</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Object&gt; list;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultResultHandler</span><span class="hljs-params">()</span> &#123;<br>    list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>  &#125;<br><br>  <span class="hljs-comment">// 但不一定是ArrayList,也可以通过ObjectFactory来产生特定的List</span><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultResultHandler</span><span class="hljs-params">(ObjectFactory objectFactory)</span> &#123;<br>    list = objectFactory.create(List.class);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResult</span><span class="hljs-params">(ResultContext context)</span> &#123;<br>    <span class="hljs-comment">// 处理很简单，就是把记录加入List</span><br>    list.add(context.getResultObject());<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">getResultList</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> list;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="DefaultResultContext"><a href="#DefaultResultContext" class="headerlink" title="DefaultResultContext"></a>DefaultResultContext</h4><p>    默认结果上下文</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultResultContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResultContext</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Object resultObject;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> resultCount;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> stopped;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultResultContext</span><span class="hljs-params">()</span> &#123;<br>    resultObject = <span class="hljs-literal">null</span>;<br>    resultCount = <span class="hljs-number">0</span>;<br>    stopped = <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getResultObject</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> resultObject;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getResultCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> resultCount;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStopped</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> stopped;<br>  &#125;<br><br>  <span class="hljs-comment">// 应该是每次调用nextResultObject这个方法，这样内部count就加1</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nextResultObject</span><span class="hljs-params">(Object resultObject)</span> &#123;<br>    resultCount++;<br>    <span class="hljs-built_in">this</span>.resultObject = resultObject;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.stopped = <span class="hljs-literal">true</span>;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="DefaultMapResultHandler"><a href="#DefaultMapResultHandler" class="headerlink" title="DefaultMapResultHandler"></a>DefaultMapResultHandler</h4><p>    默认Map结果处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultMapResultHandler</span>&lt;K, V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResultHandler</span> &#123;<br><br>  <span class="hljs-comment">// 内部实现是存了一个Map</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;K, V&gt; mappedResults;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String mapKey;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectWrapperFactory objectWrapperFactory;<br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultMapResultHandler</span><span class="hljs-params">(String mapKey, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory)</span> &#123;<br>    <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>    <span class="hljs-built_in">this</span>.objectWrapperFactory = objectWrapperFactory;<br>    <span class="hljs-built_in">this</span>.mappedResults = objectFactory.create(Map.class);<br>    <span class="hljs-built_in">this</span>.mapKey = mapKey;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResult</span><span class="hljs-params">(ResultContext context)</span> &#123;<br>    <span class="hljs-comment">// TODO is that assignment always true?</span><br>    <span class="hljs-comment">// 得到一条记录</span><br>    <span class="hljs-comment">// 这边黄色警告没法去掉了？因为返回Object型</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) context.getResultObject();<br>    <span class="hljs-comment">// MetaObject.forObject,包装一下记录</span><br>    <span class="hljs-comment">// MetaObject是用反射来包装各种类型</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">mo</span> <span class="hljs-operator">=</span> MetaObject.forObject(value, objectFactory, objectWrapperFactory);<br>    <span class="hljs-comment">// TODO is that assignment always true?</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) mo.getValue(mapKey);<br>    mappedResults.put(key, value);<br>    <span class="hljs-comment">// 这个类主要目的是把得到的List转为Map</span><br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Map&lt;K, V&gt; <span class="hljs-title function_">getMappedResults</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> mappedResults;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ResultSetHandler"><a href="#ResultSetHandler" class="headerlink" title="ResultSetHandler"></a>ResultSetHandler</h4><p>    结果集处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResultSetHandler</span> &#123;<br><br>  <span class="hljs-comment">// 处理结果集</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">handleResultSets</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// 处理OUT参数</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOutputParameters</span><span class="hljs-params">(CallableStatement cs)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ResultSetWrapper"><a href="#ResultSetWrapper" class="headerlink" title="ResultSetWrapper"></a>ResultSetWrapper</h4><p>    ResultSet包装</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultSetWrapper</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResultSet resultSet;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeHandlerRegistry typeHandlerRegistry;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; columnNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; classNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;JdbcType&gt; jdbcTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;JdbcType&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;&gt; typeHandlerMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;&gt;();<br>  <span class="hljs-keyword">private</span> Map&lt;String, List&lt;String&gt;&gt; mappedColumnNamesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, List&lt;String&gt;&gt;();<br>  <span class="hljs-keyword">private</span> Map&lt;String, List&lt;String&gt;&gt; unMappedColumnNamesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, List&lt;String&gt;&gt;(); <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResultSetWrapper</span><span class="hljs-params">(ResultSet rs, Configuration configuration)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-built_in">super</span>();<br>    <span class="hljs-built_in">this</span>.typeHandlerRegistry = configuration.getTypeHandlerRegistry();<br>    <span class="hljs-built_in">this</span>.resultSet = rs;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> rs.getMetaData();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">columnCount</span> <span class="hljs-operator">=</span> metaData.getColumnCount();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= columnCount; i++) &#123;<br>      columnNames.add(configuration.isUseColumnLabel() ? metaData.getColumnLabel(i) : metaData.getColumnName(i));<br>      jdbcTypes.add(JdbcType.forCode(metaData.getColumnType(i)));<br>      classNames.add(metaData.getColumnClassName(i));<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Gets the type handler to use when reading the result set.</span><br><span class="hljs-comment">   * Tries to get from the TypeHandlerRegistry by searching for the property type.</span><br><span class="hljs-comment">   * If not found it gets the column JDBC type and tries to get a handler for it.</span><br><span class="hljs-comment">   * </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> propertyType</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> columnName</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> TypeHandler&lt;?&gt; getTypeHandler(Class&lt;?&gt; propertyType, String columnName) &#123;<br>    TypeHandler&lt;?&gt; handler = <span class="hljs-literal">null</span>; <br>    <span class="hljs-comment">// 列名对应的属性类型和TypeHandler</span><br>    <span class="hljs-comment">// 这里考虑到了在不同的statement中列名重复，属性类型不同的问题</span><br>    Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; columnHandlers = typeHandlerMap.get(columnName);<br>    <span class="hljs-keyword">if</span> (columnHandlers == <span class="hljs-literal">null</span>) &#123;<br>      columnHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;();<br>      typeHandlerMap.put(columnName, columnHandlers);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      handler = columnHandlers.get(propertyType);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>      handler = typeHandlerRegistry.getTypeHandler(propertyType);<br>      <span class="hljs-comment">// Replicate logic of UnknownTypeHandler#resolveTypeHandler</span><br>      <span class="hljs-comment">// See issue #59 comment 10</span><br>      <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span> || handler <span class="hljs-keyword">instanceof</span> UnknownTypeHandler) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> columnNames.indexOf(columnName);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> jdbcTypes.get(index);<br>        <span class="hljs-keyword">final</span> Class&lt;?&gt; javaType = resolveClass(classNames.get(index));<br>        <span class="hljs-keyword">if</span> (javaType != <span class="hljs-literal">null</span> &amp;&amp; jdbcType != <span class="hljs-literal">null</span>) &#123;<br>          handler = typeHandlerRegistry.getTypeHandler(javaType, jdbcType);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (javaType != <span class="hljs-literal">null</span>) &#123;<br>          handler = typeHandlerRegistry.getTypeHandler(javaType);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (jdbcType != <span class="hljs-literal">null</span>) &#123;<br>          handler = typeHandlerRegistry.getTypeHandler(jdbcType);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span> || handler <span class="hljs-keyword">instanceof</span> UnknownTypeHandler) &#123;<br>        handler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectTypeHandler</span>();<br>      &#125;<br>      columnHandlers.put(propertyType, handler);<br>    &#125;<br>    <span class="hljs-keyword">return</span> handler;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; resolveClass(String className) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> Resources.classForName(className);<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getMappedColumnNames</span><span class="hljs-params">(ResultMap resultMap, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;String&gt; mappedColumnNames = mappedColumnNamesMap.get(getMapKey(resultMap, columnPrefix));<br>    <span class="hljs-keyword">if</span> (mappedColumnNames == <span class="hljs-literal">null</span>) &#123;<br>      loadMappedAndUnmappedColumnNames(resultMap, columnPrefix);<br>      mappedColumnNames = mappedColumnNamesMap.get(getMapKey(resultMap, columnPrefix));<br>    &#125;<br>    <span class="hljs-keyword">return</span> mappedColumnNames;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMapKey</span><span class="hljs-params">(ResultMap resultMap, String columnPrefix)</span> &#123;<br>    <span class="hljs-keyword">return</span> resultMap.getId() + <span class="hljs-string">&quot;:&quot;</span> + columnPrefix;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadMappedAndUnmappedColumnNames</span><span class="hljs-params">(ResultMap resultMap, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;String&gt; mappedColumnNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; unmappedColumnNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">upperColumnPrefix</span> <span class="hljs-operator">=</span> columnPrefix == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : columnPrefix.toUpperCase(Locale.ENGLISH);<br>    <span class="hljs-keyword">final</span> Set&lt;String&gt; mappedColumns = prependPrefixes(resultMap.getMappedColumns(), upperColumnPrefix);<br>    <span class="hljs-keyword">for</span> (String columnName : columnNames) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">upperColumnName</span> <span class="hljs-operator">=</span> columnName.toUpperCase(Locale.ENGLISH);<br>      <span class="hljs-keyword">if</span> (mappedColumns.contains(upperColumnName)) &#123;<br>        mappedColumnNames.add(upperColumnName);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        unmappedColumnNames.add(columnName);<br>      &#125;<br>    &#125; <br>    <span class="hljs-comment">// 这里的根据resultMap的mappedColumns属性判断映射的列名</span><br>    mappedColumnNamesMap.put(getMapKey(resultMap, columnPrefix), mappedColumnNames);<br>    unMappedColumnNamesMap.put(getMapKey(resultMap, columnPrefix), unmappedColumnNames);<br>  &#125; <br><br>  <span class="hljs-comment">// 未列名加上前缀</span><br>  <span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">prependPrefixes</span><span class="hljs-params">(Set&lt;String&gt; columnNames, String prefix)</span> &#123;<br>    <span class="hljs-keyword">if</span> (columnNames == <span class="hljs-literal">null</span> || columnNames.isEmpty() || prefix == <span class="hljs-literal">null</span> || prefix.length() == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span> columnNames;<br>    &#125;<br>    <span class="hljs-keyword">final</span> Set&lt;String&gt; prefixed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();<br>    <span class="hljs-keyword">for</span> (String columnName : columnNames) &#123;<br>      prefixed.add(prefix + columnName);<br>    &#125;<br>    <span class="hljs-keyword">return</span> prefixed;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getUnmappedColumnNames</span><span class="hljs-params">(ResultMap resultMap, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;String&gt; unMappedColumnNames = unMappedColumnNamesMap.get(getMapKey(resultMap, columnPrefix));<br>    <span class="hljs-keyword">if</span> (unMappedColumnNames == <span class="hljs-literal">null</span>) &#123;<br>      loadMappedAndUnmappedColumnNames(resultMap, columnPrefix);<br>      unMappedColumnNames = unMappedColumnNamesMap.get(getMapKey(resultMap, columnPrefix));<br>    &#125;<br>    <span class="hljs-keyword">return</span> unMappedColumnNames;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="DefaultResultSetHandler"><a href="#DefaultResultSetHandler" class="headerlink" title="DefaultResultSetHandler"></a>DefaultResultSetHandler</h4><p>    默认结果集处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultResultSetHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResultSetHandler</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">NO_VALUE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor executor;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Configuration configuration;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MappedStatement mappedStatement;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RowBounds rowBounds;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ParameterHandler parameterHandler;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResultHandler resultHandler;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BoundSql boundSql;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeHandlerRegistry typeHandlerRegistry;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory;<br><br>  <span class="hljs-comment">// nested resultmaps</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;CacheKey, Object&gt; nestedResultObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;CacheKey, Object&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;CacheKey, Object&gt; ancestorObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;CacheKey, Object&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; ancestorColumnPrefix = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br><br>  <span class="hljs-comment">// multiple resultsets</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, ResultMapping&gt; nextResultMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, ResultMapping&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;CacheKey, List&lt;PendingRelation&gt;&gt; pendingRelations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;CacheKey, List&lt;PendingRelation&gt;&gt;();<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PendingRelation</span> &#123;<br>    <span class="hljs-keyword">public</span> MetaObject metaObject;<br>    <span class="hljs-keyword">public</span> ResultMapping propertyMapping;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultResultSetHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, ParameterHandler parameterHandler, ResultHandler resultHandler, BoundSql boundSql,</span><br><span class="hljs-params">      RowBounds rowBounds)</span> &#123;<br>    <span class="hljs-built_in">this</span>.executor = executor;<br>    <span class="hljs-built_in">this</span>.configuration = mappedStatement.getConfiguration();<br>    <span class="hljs-built_in">this</span>.mappedStatement = mappedStatement;<br>    <span class="hljs-built_in">this</span>.rowBounds = rowBounds;<br>    <span class="hljs-built_in">this</span>.parameterHandler = parameterHandler;<br>    <span class="hljs-built_in">this</span>.boundSql = boundSql;<br>    <span class="hljs-built_in">this</span>.typeHandlerRegistry = configuration.getTypeHandlerRegistry();<br>    <span class="hljs-built_in">this</span>.objectFactory = configuration.getObjectFactory();<br>    <span class="hljs-built_in">this</span>.resultHandler = resultHandler;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOutputParameters</span><span class="hljs-params">(CallableStatement cs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> parameterHandler.getParameterObject();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaParam</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameterObject);<br>    <span class="hljs-keyword">final</span> List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();<br>    <span class="hljs-comment">// 循环处理每个参数</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameterMappings.size(); i++) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ParameterMapping</span> <span class="hljs-variable">parameterMapping</span> <span class="hljs-operator">=</span> parameterMappings.get(i);<br>      <span class="hljs-comment">// 只处理OUT|INOUT</span><br>      <span class="hljs-keyword">if</span> (parameterMapping.getMode() == ParameterMode.OUT || parameterMapping.getMode() == ParameterMode.INOUT) &#123;<br>        <span class="hljs-keyword">if</span> (ResultSet.class.equals(parameterMapping.getJavaType())) &#123;<br>          <span class="hljs-comment">// 如果是ResultSet型(游标)</span><br>          <span class="hljs-comment">// #&#123;result, jdbcType=CURSOR, mode=OUT, javaType=ResultSet, resultMap=userResultMap&#125;</span><br>          <span class="hljs-comment">// 先用CallableStatement.getObject取得这个游标，作为参数传进去</span><br>          handleRefCursorOutputParameter((ResultSet) cs.getObject(i + <span class="hljs-number">1</span>), parameterMapping, metaParam);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// 否则是普通型，核心就是CallableStatement.getXXX取得值</span><br>          <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = parameterMapping.getTypeHandler();<br>          metaParam.setValue(parameterMapping.getProperty(), typeHandler.getResult(cs, i + <span class="hljs-number">1</span>));<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 处理游标(OUT参数)</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRefCursorOutputParameter</span><span class="hljs-params">(ResultSet rs, ParameterMapping parameterMapping, MetaObject metaParam)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">resultMapId</span> <span class="hljs-operator">=</span> parameterMapping.getResultMapId();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(resultMapId);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">DefaultResultHandler</span> <span class="hljs-variable">resultHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResultHandler</span>(objectFactory);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultSetWrapper</span> <span class="hljs-variable">rsw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultSetWrapper</span>(rs, configuration);<br>      <span class="hljs-comment">// 里面就和一般ResultSet处理没两样了</span><br>      handleRowValues(rsw, resultMap, resultHandler, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RowBounds</span>(), <span class="hljs-literal">null</span>);<br>      metaParam.setValue(parameterMapping.getProperty(), resultHandler.getResultList());<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// issue #228 (close resultsets)</span><br>      closeResultSet(rs);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRowValues</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultMapping parentMapping)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (resultMap.hasNestedResultMaps()) &#123;<br>      ensureNoRowBounds();<br>      checkResultHandler();<br>      handleRowValuesForNestedResultMap(rsw, resultMap, resultHandler, rowBounds, parentMapping);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      handleRowValuesForSimpleResultMap(rsw, resultMap, resultHandler, rowBounds, parentMapping);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRowValuesForSimpleResultMap</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultMapping parentMapping)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">DefaultResultContext</span> <span class="hljs-variable">resultContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResultContext</span>();<br>    skipRows(rsw.getResultSet(), rowBounds);<br>    <span class="hljs-keyword">while</span> (shouldProcessMoreRows(resultContext, rowBounds) &amp;&amp; rsw.getResultSet().next()) &#123;<br>      <span class="hljs-type">ResultMap</span> <span class="hljs-variable">discriminatedResultMap</span> <span class="hljs-operator">=</span> resolveDiscriminatedResultMap(rsw.getResultSet(), resultMap, <span class="hljs-literal">null</span>);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">rowValue</span> <span class="hljs-operator">=</span> getRowValue(rsw, discriminatedResultMap);<br>      storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">skipRows</span><span class="hljs-params">(ResultSet rs, RowBounds rowBounds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (rs.getType() != ResultSet.TYPE_FORWARD_ONLY) &#123;<br>      <span class="hljs-keyword">if</span> (rowBounds.getOffset() != RowBounds.NO_ROW_OFFSET) &#123;<br>        rs.absolute(rowBounds.getOffset());<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; rowBounds.getOffset(); i++) &#123;<br>        rs.next();<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldProcessMoreRows</span><span class="hljs-params">(ResultContext context, RowBounds rowBounds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> !context.isStopped() &amp;&amp; context.getResultCount() &lt; rowBounds.getLimit();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ResultMap <span class="hljs-title function_">resolveDiscriminatedResultMap</span><span class="hljs-params">(ResultSet rs, ResultMap resultMap, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    Set&lt;String&gt; pastDiscriminators = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();<br>    <span class="hljs-type">Discriminator</span> <span class="hljs-variable">discriminator</span> <span class="hljs-operator">=</span> resultMap.getDiscriminator();<br>    <span class="hljs-comment">// 这里应该是处理嵌套的Discriminator</span><br>    <span class="hljs-keyword">while</span> (discriminator != <span class="hljs-literal">null</span>) &#123; <br>      <span class="hljs-comment">// 拿到Discriminator的值</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getDiscriminatorValue(rs, discriminator, columnPrefix);<br>      <span class="hljs-comment">// 拿到值对应的ResultMap id</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">discriminatedMapId</span> <span class="hljs-operator">=</span> discriminator.getMapIdFor(String.valueOf(value));<br>      <span class="hljs-keyword">if</span> (configuration.hasResultMap(discriminatedMapId)) &#123;<br>        resultMap = configuration.getResultMap(discriminatedMapId);<br>        <span class="hljs-type">Discriminator</span> <span class="hljs-variable">lastDiscriminator</span> <span class="hljs-operator">=</span> discriminator;<br>        discriminator = resultMap.getDiscriminator();<br>        <span class="hljs-keyword">if</span> (discriminator == lastDiscriminator || !pastDiscriminators.add(discriminatedMapId)) &#123;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultMap;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getDiscriminatorValue</span><span class="hljs-params">(ResultSet rs, Discriminator discriminator, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">resultMapping</span> <span class="hljs-operator">=</span> discriminator.getResultMapping();<br>    <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = resultMapping.getTypeHandler();<br>    <span class="hljs-keyword">return</span> typeHandler.getResult(rs, prependPrefix(resultMapping.getColumn(), columnPrefix));<br>  &#125; <br><br>  <span class="hljs-comment">// 核心，取得一行的值</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getRowValue</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 实例化ResultLoaderMap(延迟加载器)</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ResultLoaderMap</span> <span class="hljs-variable">lazyLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoaderMap</span>();<br>    <span class="hljs-comment">// 调用自己的createResultObject,内部就是new一个对象(如果是简单类型，new完也把值赋进去)</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">resultObject</span> <span class="hljs-operator">=</span> createResultObject(rsw, resultMap, lazyLoader, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">if</span> (resultObject != <span class="hljs-literal">null</span> &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;<br>      <span class="hljs-comment">// 一般不是简单类型不会有typehandler,这个if会进来</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(resultObject);<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> !resultMap.getConstructorResultMappings().isEmpty();<br>      <span class="hljs-keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="hljs-literal">false</span>)) &#123;        <br>        <span class="hljs-comment">// 自动映射</span><br>        <span class="hljs-comment">// 这里把每个列的值都赋到相应的字段里去了</span><br>        foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, <span class="hljs-literal">null</span>) || foundValues;<br>      &#125;<br>      foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, <span class="hljs-literal">null</span>) || foundValues;<br>      foundValues = lazyLoader.size() &gt; <span class="hljs-number">0</span> || foundValues;<br>      resultObject = foundValues ? resultObject : <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">return</span> resultObject;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultObject;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createResultObject</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, ResultLoaderMap lazyLoader, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Class&lt;?&gt;&gt;();<br>    <span class="hljs-keyword">final</span> List&lt;Object&gt; constructorArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">resultObject</span> <span class="hljs-operator">=</span> createResultObject(rsw, resultMap, constructorArgTypes, constructorArgs, columnPrefix);<br>    <span class="hljs-keyword">if</span> (resultObject != <span class="hljs-literal">null</span> &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;<br>      <span class="hljs-keyword">final</span> List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();<br>      <span class="hljs-keyword">for</span> (ResultMapping propertyMapping : propertyMappings) &#123;<br>        <span class="hljs-comment">// issue gcode #109 &amp;&amp; issue #149</span><br>        <span class="hljs-keyword">if</span> (propertyMapping.getNestedQueryId() != <span class="hljs-literal">null</span> &amp;&amp; propertyMapping.isLazy()) &#123;<br>          <span class="hljs-comment">// 使用代理(cglib/javaassist)</span><br>          <span class="hljs-keyword">return</span> configuration.getProxyFactory().createProxy(resultObject, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultObject;<br>  &#125; <br><br>  <span class="hljs-comment">// 创建结果对象</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createResultObject</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, String columnPrefix)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 得到result type</span><br>    <span class="hljs-keyword">final</span> Class&lt;?&gt; resultType = resultMap.getType();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaType</span> <span class="hljs-operator">=</span> MetaClass.forClass(resultType);<br>    <span class="hljs-keyword">final</span> List&lt;ResultMapping&gt; constructorMappings = resultMap.getConstructorResultMappings();<br>    <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(resultType)) &#123;<br>      <span class="hljs-comment">// 基本型</span><br>      <span class="hljs-keyword">return</span> createPrimitiveResultObject(rsw, resultMap, columnPrefix);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!constructorMappings.isEmpty()) &#123;<br>      <span class="hljs-comment">// 有参数的构造函数</span><br>      <span class="hljs-keyword">return</span> createParameterizedResultObject(rsw, resultType, constructorMappings, constructorArgTypes, constructorArgs, columnPrefix);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resultType.isInterface() || metaType.hasDefaultConstructor()) &#123;<br>      <span class="hljs-comment">// 普通bean类型</span><br>      <span class="hljs-keyword">return</span> objectFactory.create(resultType);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="hljs-literal">false</span>)) &#123;<br>      <span class="hljs-comment">// 自动映射</span><br>      <span class="hljs-keyword">return</span> createByConstructorSignature(rsw, resultType, constructorArgTypes, constructorArgs, columnPrefix);<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Do not know how to create an instance of &quot;</span> + resultType);<br>  &#125; <br><br>  <span class="hljs-comment">// 简单类型走这里</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createPrimitiveResultObject</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> Class&lt;?&gt; resultType = resultMap.getType();<br>    <span class="hljs-keyword">final</span> String columnName;<br>    <span class="hljs-comment">// 因为只有1列，所以取得这一列的名字</span><br>    <span class="hljs-keyword">if</span> (!resultMap.getResultMappings().isEmpty()) &#123;<br>      <span class="hljs-keyword">final</span> List&lt;ResultMapping&gt; resultMappingList = resultMap.getResultMappings();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">mapping</span> <span class="hljs-operator">=</span> resultMappingList.get(<span class="hljs-number">0</span>);<br>      columnName = prependPrefix(mapping.getColumn(), columnPrefix);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      columnName = rsw.getColumnNames().get(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(resultType, columnName);<br>    <span class="hljs-keyword">return</span> typeHandler.getResult(rsw.getResultSet(), columnName);<br>  &#125; <br><br>  <span class="hljs-comment">// 设置了构造函数参数</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createParameterizedResultObject</span><span class="hljs-params">(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; constructorMappings,</span><br><span class="hljs-params">      List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (ResultMapping constructorMapping : constructorMappings) &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; parameterType = constructorMapping.getJavaType();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> constructorMapping.getColumn();<br>      <span class="hljs-keyword">final</span> Object value;<br>      <span class="hljs-keyword">if</span> (constructorMapping.getNestedQueryId() != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 值由嵌套查询获得</span><br>        value = getNestedQueryConstructorValue(rsw.getResultSet(), constructorMapping, columnPrefix);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (constructorMapping.getNestedResultMapId() != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(constructorMapping.getNestedResultMapId());<br>        <span class="hljs-comment">// 递归获取一行的值</span><br>        value = getRowValue(rsw, resultMap);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 通过typeHandler获取值</span><br>        <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = constructorMapping.getTypeHandler();<br>        value = typeHandler.getResult(rsw.getResultSet(), prependPrefix(column, columnPrefix));<br>      &#125;<br>      constructorArgTypes.add(parameterType);<br>      constructorArgs.add(value);<br>      foundValues = value != <span class="hljs-literal">null</span> || foundValues;<br>    &#125;<br>    <span class="hljs-keyword">return</span> foundValues ? objectFactory.create(resultType, constructorArgTypes, constructorArgs) : <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getNestedQueryConstructorValue</span><span class="hljs-params">(ResultSet rs, ResultMapping constructorMapping, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">nestedQueryId</span> <span class="hljs-operator">=</span> constructorMapping.getNestedQueryId();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">nestedQuery</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(nestedQueryId);<br>    <span class="hljs-keyword">final</span> Class&lt;?&gt; nestedQueryParameterType = nestedQuery.getParameterMap().getType();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">nestedQueryParameterObject</span> <span class="hljs-operator">=</span> prepareParameterForNestedQuery(rs, constructorMapping, nestedQueryParameterType, columnPrefix);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (nestedQueryParameterObject != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">BoundSql</span> <span class="hljs-variable">nestedBoundSql</span> <span class="hljs-operator">=</span> nestedQuery.getBoundSql(nestedQueryParameterObject);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> executor.createCacheKey(nestedQuery, nestedQueryParameterObject, RowBounds.DEFAULT, nestedBoundSql);<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; targetType = constructorMapping.getJavaType();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultLoader</span> <span class="hljs-variable">resultLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoader</span>(configuration, executor, nestedQuery, nestedQueryParameterObject, targetType, key, nestedBoundSql);<br>      value = resultLoader.loadResult();<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">prepareParameterForNestedQuery</span><span class="hljs-params">(ResultSet rs, ResultMapping resultMapping, Class&lt;?&gt; parameterType, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (resultMapping.isCompositeResult()) &#123;<br>      <span class="hljs-keyword">return</span> prepareCompositeKeyParameter(rs, resultMapping, parameterType, columnPrefix);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> prepareSimpleKeyParameter(rs, resultMapping, parameterType, columnPrefix);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">prepareCompositeKeyParameter</span><span class="hljs-params">(ResultSet rs, ResultMapping resultMapping, Class&lt;?&gt; parameterType, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> instantiateParameterObject(parameterType);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameterObject);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (ResultMapping innerResultMapping : resultMapping.getComposites()) &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; propType = metaObject.getSetterType(innerResultMapping.getProperty());<br>      <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = typeHandlerRegistry.getTypeHandler(propType);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">propValue</span> <span class="hljs-operator">=</span> typeHandler.getResult(rs, prependPrefix(innerResultMapping.getColumn(), columnPrefix));<br>      <span class="hljs-comment">// issue #353 &amp; #560 do not execute nested query if key is null</span><br>      <span class="hljs-keyword">if</span> (propValue != <span class="hljs-literal">null</span>) &#123;<br>        metaObject.setValue(innerResultMapping.getProperty(), propValue);<br>        foundValues = <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> foundValues ? parameterObject : <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">instantiateParameterObject</span><span class="hljs-params">(Class&lt;?&gt; parameterType)</span> &#123;<br>    <span class="hljs-keyword">if</span> (parameterType == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Object, Object&gt;();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> objectFactory.create(parameterType);<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">prepareSimpleKeyParameter</span><span class="hljs-params">(ResultSet rs, ResultMapping resultMapping, Class&lt;?&gt; parameterType, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler;<br>    <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterType)) &#123;<br>      typeHandler = typeHandlerRegistry.getTypeHandler(parameterType);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      typeHandler = typeHandlerRegistry.getUnknownTypeHandler();<br>    &#125;<br>    <span class="hljs-keyword">return</span> typeHandler.getResult(rs, prependPrefix(resultMapping.getColumn(), columnPrefix));<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldApplyAutomaticMappings</span><span class="hljs-params">(ResultMap resultMap, <span class="hljs-type">boolean</span> isNested)</span> &#123;<br>    <span class="hljs-keyword">if</span> (resultMap.getAutoMapping() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> resultMap.getAutoMapping();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (isNested) &#123;<br>        <span class="hljs-keyword">return</span> AutoMappingBehavior.FULL == configuration.getAutoMappingBehavior();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> AutoMappingBehavior.NONE != configuration.getAutoMappingBehavior();<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createByConstructorSignature</span><span class="hljs-params">(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs,</span><br><span class="hljs-params">      String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">for</span> (Constructor&lt;?&gt; constructor : resultType.getDeclaredConstructors()) &#123;<br>       <span class="hljs-comment">// 返回的一行数据的类型正好对应上一种构造函数的参数类型</span><br>       <span class="hljs-keyword">if</span> (typeNames(constructor.getParameterTypes()).equals(rsw.getClassNames())) &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; constructor.getParameterTypes().length; i++) &#123;<br>          Class&lt;?&gt; parameterType = constructor.getParameterTypes()[i];<br>          <span class="hljs-type">String</span> <span class="hljs-variable">columnName</span> <span class="hljs-operator">=</span> rsw.getColumnNames().get(i);<br>          TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(parameterType, columnName);<br>          <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> typeHandler.getResult(rsw.getResultSet(), prependPrefix(columnName, columnPrefix));<br>          constructorArgTypes.add(parameterType);<br>          constructorArgs.add(value);<br>          foundValues = value != <span class="hljs-literal">null</span> || foundValues;<br>        &#125;<br>        <span class="hljs-comment">//上面是构造函数创建对象，下面是对象工厂来创建</span><br>        <span class="hljs-keyword">return</span> foundValues ? objectFactory.create(resultType, constructorArgTypes, constructorArgs) : <span class="hljs-literal">null</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;No constructor found in &quot;</span> + resultType.getName() + <span class="hljs-string">&quot; matching &quot;</span> + rsw.getClassNames());<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">typeNames</span><span class="hljs-params">(Class&lt;?&gt;[] parameterTypes)</span> &#123;<br>    List&lt;String&gt; names = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    <span class="hljs-keyword">for</span> (Class&lt;?&gt; type : parameterTypes) &#123;<br>      names.add(type.getName());<br>    &#125;<br>    <span class="hljs-keyword">return</span> names;<br>  &#125; <br><br>  <span class="hljs-comment">// 自动映射没有手动定义映射的列</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">applyAutomaticMappings</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> List&lt;String&gt; unmappedColumnNames = rsw.getUnmappedColumnNames(resultMap, columnPrefix);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (String columnName : unmappedColumnNames) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> columnName;<br>      <span class="hljs-keyword">if</span> (columnPrefix != <span class="hljs-literal">null</span> &amp;&amp; !columnPrefix.isEmpty()) &#123;<br>        <span class="hljs-comment">// When columnPrefix is specified,</span><br>        <span class="hljs-comment">// ignore columns without the prefix.</span><br>        <span class="hljs-keyword">if</span> (columnName.toUpperCase(Locale.ENGLISH).startsWith(columnPrefix)) &#123;<br>          propertyName = columnName.substring(columnPrefix.length());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">continue</span>;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> metaObject.findProperty(propertyName, configuration.isMapUnderscoreToCamelCase());<br>      <span class="hljs-keyword">if</span> (property != <span class="hljs-literal">null</span> &amp;&amp; metaObject.hasSetter(property)) &#123;<br>        <span class="hljs-keyword">final</span> Class&lt;?&gt; propertyType = metaObject.getSetterType(property);<br>        <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(propertyType)) &#123;<br>          <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(propertyType, columnName);<br>          <span class="hljs-comment">// 巧妙的用TypeHandler取得结果</span><br>          <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> typeHandler.getResult(rsw.getResultSet(), columnName);<br>          <span class="hljs-comment">// issue #377, call setter on nulls</span><br>          <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> || configuration.isCallSettersOnNulls()) &#123;<br>            <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> || !propertyType.isPrimitive()) &#123;<br>              <span class="hljs-comment">// 然后巧妙的用反射来设置到对象</span><br>              metaObject.setValue(property, value);<br>            &#125;<br>            foundValues = <span class="hljs-literal">true</span>;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> foundValues;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">applyPropertyMappings</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, ResultLoaderMap lazyLoader, String columnPrefix)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> List&lt;String&gt; mappedColumnNames = rsw.getMappedColumnNames(resultMap, columnPrefix);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">final</span> List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();<br>    <span class="hljs-keyword">for</span> (ResultMapping propertyMapping : propertyMappings) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> prependPrefix(propertyMapping.getColumn(), columnPrefix);<br>      <span class="hljs-keyword">if</span> (propertyMapping.isCompositeResult() <br>          || (column != <span class="hljs-literal">null</span> &amp;&amp; mappedColumnNames.contains(column.toUpperCase(Locale.ENGLISH))) <br>          || propertyMapping.getResultSet() != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getPropertyMappingValue(rsw.getResultSet(), metaObject, propertyMapping, lazyLoader, columnPrefix);<br>        <span class="hljs-comment">// issue #541 make property optional</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> propertyMapping.getProperty();<br>        <span class="hljs-comment">// issue #377, call setter on nulls</span><br>        <span class="hljs-keyword">if</span> (value != NO_VALUE &amp;&amp; property != <span class="hljs-literal">null</span> &amp;&amp; (value != <span class="hljs-literal">null</span> || configuration.isCallSettersOnNulls())) &#123;<br>          <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> || !metaObject.getSetterType(property).isPrimitive()) &#123;<br>            metaObject.setValue(property, value);<br>          &#125;<br>          foundValues = <span class="hljs-literal">true</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> foundValues;<br>  &#125; <br><br>  <span class="hljs-comment">// 获取属性映射的值</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getPropertyMappingValue</span><span class="hljs-params">(ResultSet rs, MetaObject metaResultObject, ResultMapping propertyMapping, ResultLoaderMap lazyLoader, String columnPrefix)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (propertyMapping.getNestedQueryId() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> getNestedQueryMappingValue(rs, metaResultObject, propertyMapping, lazyLoader, columnPrefix);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (propertyMapping.getResultSet() != <span class="hljs-literal">null</span>) &#123;<br>      addPendingChildRelation(rs, metaResultObject, propertyMapping);<br>      <span class="hljs-keyword">return</span> NO_VALUE;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (propertyMapping.getNestedResultMapId() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// the user added a column attribute to a nested result map, ignore it</span><br>      <span class="hljs-keyword">return</span> NO_VALUE;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = propertyMapping.getTypeHandler();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> prependPrefix(propertyMapping.getColumn(), columnPrefix);<br>      <span class="hljs-keyword">return</span> typeHandler.getResult(rs, column);<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-comment">// 得到嵌套查询值</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getNestedQueryMappingValue</span><span class="hljs-params">(ResultSet rs, MetaObject metaResultObject, ResultMapping propertyMapping, ResultLoaderMap lazyLoader, String columnPrefix)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">nestedQueryId</span> <span class="hljs-operator">=</span> propertyMapping.getNestedQueryId();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> propertyMapping.getProperty();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">nestedQuery</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(nestedQueryId);<br>    <span class="hljs-keyword">final</span> Class&lt;?&gt; nestedQueryParameterType = nestedQuery.getParameterMap().getType();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">nestedQueryParameterObject</span> <span class="hljs-operator">=</span> prepareParameterForNestedQuery(rs, propertyMapping, nestedQueryParameterType, columnPrefix);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> NO_VALUE;<br>    <span class="hljs-keyword">if</span> (nestedQueryParameterObject != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">BoundSql</span> <span class="hljs-variable">nestedBoundSql</span> <span class="hljs-operator">=</span> nestedQuery.getBoundSql(nestedQueryParameterObject);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> executor.createCacheKey(nestedQuery, nestedQueryParameterObject, RowBounds.DEFAULT, nestedBoundSql);<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; targetType = propertyMapping.getJavaType();<br>      <span class="hljs-keyword">if</span> (executor.isCached(nestedQuery, key)) &#123;<br>        <span class="hljs-comment">// 如果已经有一级缓存了，则延迟加载(实际上deferLoad方法中可以看到则是立即加载)</span><br>        executor.deferLoad(nestedQuery, metaResultObject, property, key, targetType);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 否则lazyLoader.addLoader 需要延迟加载则addLoader</span><br>        <span class="hljs-comment">// 或者ResultLoader.loadResult 不需要延迟加载则立即加载</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ResultLoader</span> <span class="hljs-variable">resultLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoader</span>(configuration, executor, nestedQuery, nestedQueryParameterObject, targetType, key, nestedBoundSql);<br>        <span class="hljs-keyword">if</span> (propertyMapping.isLazy()) &#123;<br>          lazyLoader.addLoader(property, metaResultObject, resultLoader);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          value = resultLoader.loadResult();<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>  &#125; <br><br>  <span class="hljs-comment">// 后面的不想看了，以后再看</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPendingChildRelation</span><span class="hljs-params">(ResultSet rs, MetaObject metaResultObject, ResultMapping parentMapping)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> createKeyForMultipleResults(rs, parentMapping, parentMapping.getColumn(), parentMapping.getColumn());<br>    <span class="hljs-type">PendingRelation</span> <span class="hljs-variable">deferLoad</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PendingRelation</span>();<br>    deferLoad.metaObject = metaResultObject;<br>    deferLoad.propertyMapping = parentMapping;<br>    List&lt;PendingRelation&gt; relations = pendingRelations.get(cacheKey);<br>    <span class="hljs-comment">// issue #255</span><br>    <span class="hljs-keyword">if</span> (relations == <span class="hljs-literal">null</span>) &#123;<br>      relations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;DefaultResultSetHandler.PendingRelation&gt;();<br>      pendingRelations.put(cacheKey, relations);<br>    &#125;<br>    relations.add(deferLoad);<br>    <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">previous</span> <span class="hljs-operator">=</span> nextResultMaps.get(parentMapping.getResultSet());<br>    <span class="hljs-keyword">if</span> (previous == <span class="hljs-literal">null</span>) &#123;<br>      nextResultMaps.put(parentMapping.getResultSet(), parentMapping);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (!previous.equals(parentMapping)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Two different properties are mapped to the same resultSet&quot;</span>);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">storeObject</span><span class="hljs-params">(ResultHandler resultHandler, DefaultResultContext resultContext, Object rowValue, ResultMapping parentMapping, ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (parentMapping != <span class="hljs-literal">null</span>) &#123;<br>      linkToParents(rs, parentMapping, rowValue);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      callResultHandler(resultHandler, resultContext, rowValue);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// MULTIPLE RESULT SETS</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">linkToParents</span><span class="hljs-params">(ResultSet rs, ResultMapping parentMapping, Object rowValue)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">parentKey</span> <span class="hljs-operator">=</span> createKeyForMultipleResults(rs, parentMapping, parentMapping.getColumn(), parentMapping.getForeignColumn());<br>    List&lt;PendingRelation&gt; parents = pendingRelations.get(parentKey);<br>    <span class="hljs-keyword">for</span> (PendingRelation parent : parents) &#123;<br>      <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">collectionProperty</span> <span class="hljs-operator">=</span> instantiateCollectionPropertyIfAppropriate(parent.propertyMapping, parent.metaObject);<br>        <span class="hljs-keyword">if</span> (rowValue != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">if</span> (collectionProperty != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">targetMetaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(collectionProperty);<br>            targetMetaObject.add(rowValue);<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            parent.metaObject.setValue(parent.propertyMapping.getProperty(), rowValue);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-keyword">private</span> CacheKey <span class="hljs-title function_">createKeyForMultipleResults</span><span class="hljs-params">(ResultSet rs, ResultMapping resultMapping, String names, String columns)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheKey</span>();<br>    cacheKey.update(resultMapping);<br>    <span class="hljs-keyword">if</span> (columns != <span class="hljs-literal">null</span> &amp;&amp; names != <span class="hljs-literal">null</span>) &#123;<br>      String[] columnsArray = columns.split(<span class="hljs-string">&quot;,&quot;</span>);<br>      String[] namesArray = names.split(<span class="hljs-string">&quot;,&quot;</span>);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> ; i &lt; columnsArray.length ; i++) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rs.getString(columnsArray[i]);<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>          cacheKey.update(namesArray[i]);<br>          cacheKey.update(value);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> cacheKey;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">instantiateCollectionPropertyIfAppropriate</span><span class="hljs-params">(ResultMapping resultMapping, MetaObject metaObject)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> resultMapping.getProperty();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">propertyValue</span> <span class="hljs-operator">=</span> metaObject.getValue(propertyName);<br>    <span class="hljs-keyword">if</span> (propertyValue == <span class="hljs-literal">null</span>) &#123;<br>      Class&lt;?&gt; type = resultMapping.getJavaType();<br>      <span class="hljs-keyword">if</span> (type == <span class="hljs-literal">null</span>) &#123;<br>        type = metaObject.getSetterType(propertyName);<br>      &#125;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (objectFactory.isCollection(type)) &#123;<br>          propertyValue = objectFactory.create(type);<br>          metaObject.setValue(propertyName, propertyValue);<br>          <span class="hljs-keyword">return</span> propertyValue;<br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error instantiating collection property for result &#x27;&quot;</span> + resultMapping.getProperty() + <span class="hljs-string">&quot;&#x27;.  Cause: &quot;</span> + e, e);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (objectFactory.isCollection(propertyValue.getClass())) &#123;<br>      <span class="hljs-keyword">return</span> propertyValue;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callResultHandler</span><span class="hljs-params">(ResultHandler resultHandler, DefaultResultContext resultContext, Object rowValue)</span> &#123;<br>    resultContext.nextResultObject(rowValue);<br>    resultHandler.handleResult(resultContext);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureNoRowBounds</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (configuration.isSafeRowBoundsEnabled() &amp;&amp; rowBounds != <span class="hljs-literal">null</span> &amp;&amp; (rowBounds.getLimit() &lt; RowBounds.NO_ROW_LIMIT || rowBounds.getOffset() &gt; RowBounds.NO_ROW_OFFSET)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Mapped Statements with nested result mappings cannot be safely constrained by RowBounds. &quot;</span><br>          + <span class="hljs-string">&quot;Use safeRowBoundsEnabled=false setting to bypass this check.&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkResultHandler</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (resultHandler != <span class="hljs-literal">null</span> &amp;&amp; configuration.isSafeResultHandlerEnabled() &amp;&amp; !mappedStatement.isResultOrdered()) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Mapped Statements with nested result mappings cannot be safely used with a custom ResultHandler. &quot;</span><br>          + <span class="hljs-string">&quot;Use safeResultHandlerEnabled=false setting to bypass this check &quot;</span> <br>          + <span class="hljs-string">&quot;or ensure your statement returns ordered data and set resultOrdered=true on it.&quot;</span>);<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// HANDLE NESTED RESULT MAPS</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRowValuesForNestedResultMap</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultMapping parentMapping)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">DefaultResultContext</span> <span class="hljs-variable">resultContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResultContext</span>();<br>    skipRows(rsw.getResultSet(), rowBounds);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">rowValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">while</span> (shouldProcessMoreRows(resultContext, rowBounds) &amp;&amp; rsw.getResultSet().next()) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">discriminatedResultMap</span> <span class="hljs-operator">=</span> resolveDiscriminatedResultMap(rsw.getResultSet(), resultMap, <span class="hljs-literal">null</span>);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">rowKey</span> <span class="hljs-operator">=</span> createRowKey(discriminatedResultMap, rsw, <span class="hljs-literal">null</span>);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">partialObject</span> <span class="hljs-operator">=</span> nestedResultObjects.get(rowKey);<br>      <span class="hljs-comment">// issue #577 &amp;&amp; #542</span><br>      <span class="hljs-keyword">if</span> (mappedStatement.isResultOrdered()) &#123;<br>        <span class="hljs-keyword">if</span> (partialObject == <span class="hljs-literal">null</span> &amp;&amp; rowValue != <span class="hljs-literal">null</span>) &#123;<br>          nestedResultObjects.clear();<br>          storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());<br>        &#125;<br>        rowValue = getRowValue(rsw, discriminatedResultMap, rowKey, rowKey, <span class="hljs-literal">null</span>, partialObject);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        rowValue = getRowValue(rsw, discriminatedResultMap, rowKey, rowKey, <span class="hljs-literal">null</span>, partialObject);<br>        <span class="hljs-keyword">if</span> (partialObject == <span class="hljs-literal">null</span>) &#123;<br>          storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (rowValue != <span class="hljs-literal">null</span> &amp;&amp; mappedStatement.isResultOrdered() &amp;&amp; shouldProcessMoreRows(resultContext, rowBounds)) &#123;<br>      storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// UNIQUE RESULT KEY</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-keyword">private</span> CacheKey <span class="hljs-title function_">createRowKey</span><span class="hljs-params">(ResultMap resultMap, ResultSetWrapper rsw, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheKey</span>();<br>    cacheKey.update(resultMap.getId());<br>    List&lt;ResultMapping&gt; resultMappings = getResultMappingsForRowKey(resultMap);<br>    <span class="hljs-keyword">if</span> (resultMappings.size() == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span> (Map.class.isAssignableFrom(resultMap.getType())) &#123;<br>        createRowKeyForMap(rsw, cacheKey);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        createRowKeyForUnmappedProperties(resultMap, rsw, cacheKey, columnPrefix);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      createRowKeyForMappedProperties(resultMap, rsw, cacheKey, resultMappings, columnPrefix);<br>    &#125;<br>    <span class="hljs-keyword">return</span> cacheKey;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; <span class="hljs-title function_">getResultMappingsForRowKey</span><span class="hljs-params">(ResultMap resultMap)</span> &#123;<br>    List&lt;ResultMapping&gt; resultMappings = resultMap.getIdResultMappings();<br>    <span class="hljs-keyword">if</span> (resultMappings.size() == <span class="hljs-number">0</span>) &#123;<br>      resultMappings = resultMap.getPropertyResultMappings();<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultMappings;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createRowKeyForMap</span><span class="hljs-params">(ResultSetWrapper rsw, CacheKey cacheKey)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;String&gt; columnNames = rsw.getColumnNames();<br>    <span class="hljs-keyword">for</span> (String columnName : columnNames) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rsw.getResultSet().getString(columnName);<br>      <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>        cacheKey.update(columnName);<br>        cacheKey.update(value);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createRowKeyForUnmappedProperties</span><span class="hljs-params">(ResultMap resultMap, ResultSetWrapper rsw, CacheKey cacheKey, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaType</span> <span class="hljs-operator">=</span> MetaClass.forClass(resultMap.getType());<br>    List&lt;String&gt; unmappedColumnNames = rsw.getUnmappedColumnNames(resultMap, columnPrefix);<br>    <span class="hljs-keyword">for</span> (String column : unmappedColumnNames) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> column;<br>      <span class="hljs-keyword">if</span> (columnPrefix != <span class="hljs-literal">null</span> &amp;&amp; !columnPrefix.isEmpty()) &#123;<br>        <span class="hljs-comment">// When columnPrefix is specified, ignore columns without the prefix.</span><br>        <span class="hljs-keyword">if</span> (column.toUpperCase(Locale.ENGLISH).startsWith(columnPrefix)) &#123;<br>          property = column.substring(columnPrefix.length());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">continue</span>;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (metaType.findProperty(property, configuration.isMapUnderscoreToCamelCase()) != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rsw.getResultSet().getString(column);<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>          cacheKey.update(column);<br>          cacheKey.update(value);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createRowKeyForMappedProperties</span><span class="hljs-params">(ResultMap resultMap, ResultSetWrapper rsw, CacheKey cacheKey, List&lt;ResultMapping&gt; resultMappings, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">for</span> (ResultMapping resultMapping : resultMappings) &#123;<br>      <span class="hljs-keyword">if</span> (resultMapping.getNestedResultMapId() != <span class="hljs-literal">null</span> &amp;&amp; resultMapping.getResultSet() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// Issue #392</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">nestedResultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(resultMapping.getNestedResultMapId());<br>        createRowKeyForMappedProperties(nestedResultMap, rsw, cacheKey, nestedResultMap.getConstructorResultMappings(),<br>            prependPrefix(resultMapping.getColumnPrefix(), columnPrefix));<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resultMapping.getNestedQueryId() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> prependPrefix(resultMapping.getColumn(), columnPrefix);<br>        <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; th = resultMapping.getTypeHandler();<br>        List&lt;String&gt; mappedColumnNames = rsw.getMappedColumnNames(resultMap, columnPrefix);<br>        <span class="hljs-comment">// Issue #114</span><br>        <span class="hljs-keyword">if</span> (column != <span class="hljs-literal">null</span> &amp;&amp; mappedColumnNames.contains(column.toUpperCase(Locale.ENGLISH))) &#123;<br>          <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> th.getResult(rsw.getResultSet(), column);<br>          <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>            cacheKey.update(column);<br>            cacheKey.update(value);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// GET VALUE FROM ROW FOR NESTED RESULT MAP</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getRowValue</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, CacheKey combinedKey, CacheKey absoluteKey, String columnPrefix, Object partialObject)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">resultMapId</span> <span class="hljs-operator">=</span> resultMap.getId();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">resultObject</span> <span class="hljs-operator">=</span> partialObject;<br>    <span class="hljs-keyword">if</span> (resultObject != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(resultObject);<br>      putAncestor(absoluteKey, resultObject, resultMapId, columnPrefix);<br>      applyNestedResultMappings(rsw, resultMap, metaObject, columnPrefix, combinedKey, <span class="hljs-literal">false</span>);<br>      ancestorObjects.remove(absoluteKey);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultLoaderMap</span> <span class="hljs-variable">lazyLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoaderMap</span>();<br>      resultObject = createResultObject(rsw, resultMap, lazyLoader, columnPrefix);<br>      <span class="hljs-keyword">if</span> (resultObject != <span class="hljs-literal">null</span> &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(resultObject);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> !resultMap.getConstructorResultMappings().isEmpty();<br>        <span class="hljs-keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="hljs-literal">true</span>)) &#123;<br>          foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, columnPrefix) || foundValues;<br>        &#125;        <br>        foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, columnPrefix) || foundValues;<br>        putAncestor(absoluteKey, resultObject, resultMapId, columnPrefix);<br>        foundValues = applyNestedResultMappings(rsw, resultMap, metaObject, columnPrefix, combinedKey, <span class="hljs-literal">true</span>) || foundValues;<br>        ancestorObjects.remove(absoluteKey);<br>        foundValues = lazyLoader.size() &gt; <span class="hljs-number">0</span> || foundValues;<br>        resultObject = foundValues ? resultObject : <span class="hljs-literal">null</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (combinedKey != CacheKey.NULL_CACHE_KEY) &#123;<br>        nestedResultObjects.put(combinedKey, resultObject);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultObject;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putAncestor</span><span class="hljs-params">(CacheKey rowKey, Object resultObject, String resultMapId, String columnPrefix)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!ancestorColumnPrefix.containsKey(resultMapId)) &#123;<br>      ancestorColumnPrefix.put(resultMapId, columnPrefix);<br>    &#125;<br>    ancestorObjects.put(rowKey, resultObject);<br>  &#125; <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// NESTED RESULT MAP (JOIN MAPPING)</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">applyNestedResultMappings</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, String parentPrefix, CacheKey parentRowKey, <span class="hljs-type">boolean</span> newObject)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (ResultMapping resultMapping : resultMap.getPropertyResultMappings()) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">nestedResultMapId</span> <span class="hljs-operator">=</span> resultMapping.getNestedResultMapId();<br>      <span class="hljs-keyword">if</span> (nestedResultMapId != <span class="hljs-literal">null</span> &amp;&amp; resultMapping.getResultSet() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">columnPrefix</span> <span class="hljs-operator">=</span> getColumnPrefix(parentPrefix, resultMapping);<br>          <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">nestedResultMap</span> <span class="hljs-operator">=</span> getNestedResultMap(rsw.getResultSet(), nestedResultMapId, columnPrefix);<br>          <span class="hljs-type">CacheKey</span> <span class="hljs-variable">rowKey</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>          <span class="hljs-type">Object</span> <span class="hljs-variable">ancestorObject</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>          <span class="hljs-keyword">if</span> (ancestorColumnPrefix.containsKey(nestedResultMapId)) &#123;<br>            rowKey = createRowKey(nestedResultMap, rsw, ancestorColumnPrefix.get(nestedResultMapId));<br>            ancestorObject = ancestorObjects.get(rowKey);<br>          &#125;<br>          <span class="hljs-keyword">if</span> (ancestorObject != <span class="hljs-literal">null</span>) &#123; <br>            <span class="hljs-keyword">if</span> (newObject) &#123;<br>              metaObject.setValue(resultMapping.getProperty(), ancestorObject);<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            rowKey = createRowKey(nestedResultMap, rsw, columnPrefix);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">combinedKey</span> <span class="hljs-operator">=</span> combineKeys(rowKey, parentRowKey);            <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">rowValue</span> <span class="hljs-operator">=</span> nestedResultObjects.get(combinedKey);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">knownValue</span> <span class="hljs-operator">=</span> (rowValue != <span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">collectionProperty</span> <span class="hljs-operator">=</span> instantiateCollectionPropertyIfAppropriate(resultMapping, metaObject);            <br>            <span class="hljs-keyword">if</span> (anyNotNullColumnHasValue(resultMapping, columnPrefix, rsw.getResultSet())) &#123;<br>              rowValue = getRowValue(rsw, nestedResultMap, combinedKey, rowKey, columnPrefix, rowValue);<br>              <span class="hljs-keyword">if</span> (rowValue != <span class="hljs-literal">null</span> &amp;&amp; !knownValue) &#123;<br>                <span class="hljs-keyword">if</span> (collectionProperty != <span class="hljs-literal">null</span>) &#123;<br>                  <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">targetMetaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(collectionProperty);<br>                  targetMetaObject.add(rowValue);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                  metaObject.setValue(resultMapping.getProperty(), rowValue);<br>                &#125;<br>                foundValues = <span class="hljs-literal">true</span>;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error getting nested result map values for &#x27;&quot;</span> + resultMapping.getProperty() + <span class="hljs-string">&quot;&#x27;.  Cause: &quot;</span> + e, e);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> foundValues;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getColumnPrefix</span><span class="hljs-params">(String parentPrefix, ResultMapping resultMapping)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">columnPrefixBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">if</span> (parentPrefix != <span class="hljs-literal">null</span>) &#123;<br>      columnPrefixBuilder.append(parentPrefix);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (resultMapping.getColumnPrefix() != <span class="hljs-literal">null</span>) &#123;<br>      columnPrefixBuilder.append(resultMapping.getColumnPrefix());<br>    &#125;<br>    <span class="hljs-keyword">return</span> columnPrefixBuilder.length() == <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : columnPrefixBuilder.toString().toUpperCase(Locale.ENGLISH);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> ResultMap <span class="hljs-title function_">getNestedResultMap</span><span class="hljs-params">(ResultSet rs, String nestedResultMapId, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">ResultMap</span> <span class="hljs-variable">nestedResultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(nestedResultMapId);<br>    <span class="hljs-keyword">return</span> resolveDiscriminatedResultMap(rs, nestedResultMap, columnPrefix);<br>  &#125;  <br><br>  <span class="hljs-keyword">private</span> CacheKey <span class="hljs-title function_">combineKeys</span><span class="hljs-params">(CacheKey rowKey, CacheKey parentRowKey)</span> &#123;<br>    <span class="hljs-keyword">if</span> (rowKey.getUpdateCount() &gt; <span class="hljs-number">1</span> &amp;&amp; parentRowKey.getUpdateCount() &gt; <span class="hljs-number">1</span>) &#123;<br>      CacheKey combinedKey;<br>      <span class="hljs-keyword">try</span> &#123;<br>        combinedKey = rowKey.clone();<br>      &#125; <span class="hljs-keyword">catch</span> (CloneNotSupportedException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error cloning cache key.  Cause: &quot;</span> + e, e);<br>      &#125;<br>      combinedKey.update(parentRowKey);<br>      <span class="hljs-keyword">return</span> combinedKey;<br>    &#125;<br>    <span class="hljs-keyword">return</span> CacheKey.NULL_CACHE_KEY;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">anyNotNullColumnHasValue</span><span class="hljs-params">(ResultMapping resultMapping, String columnPrefix, ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    Set&lt;String&gt; notNullColumns = resultMapping.getNotNullColumns();<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">anyNotNullColumnHasValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">if</span> (notNullColumns != <span class="hljs-literal">null</span> &amp;&amp; !notNullColumns.isEmpty()) &#123;<br>      anyNotNullColumnHasValue = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">for</span> (String column: notNullColumns) &#123;<br>        rs.getObject(prependPrefix(column, columnPrefix));<br>        <span class="hljs-keyword">if</span> (!rs.wasNull()) &#123;<br>          anyNotNullColumnHasValue = <span class="hljs-literal">true</span>;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> anyNotNullColumnHasValue;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeResultSet</span><span class="hljs-params">(ResultSet rs)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (rs != <span class="hljs-literal">null</span>) &#123;<br>        rs.close();<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-comment">// ignore</span><br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// HANDLE RESULT SETS</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">handleResultSets</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    ErrorContext.instance().activity(<span class="hljs-string">&quot;handling results&quot;</span>).object(mappedStatement.getId());<br><br>    <span class="hljs-keyword">final</span> List&lt;Object&gt; multipleResults = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">resultSetCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">ResultSetWrapper</span> <span class="hljs-variable">rsw</span> <span class="hljs-operator">=</span> getFirstResultSet(stmt);<br><br>    List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();<br>    <span class="hljs-comment">// 一般resultMaps里只有一个元素</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">resultMapCount</span> <span class="hljs-operator">=</span> resultMaps.size();<br>    validateResultMapsCount(rsw, resultMapCount);<br>    <span class="hljs-keyword">while</span> (rsw != <span class="hljs-literal">null</span> &amp;&amp; resultMapCount &gt; resultSetCount) &#123;<br>      <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> resultMaps.get(resultSetCount);<br>      handleResultSet(rsw, resultMap, multipleResults, <span class="hljs-literal">null</span>);<br>      rsw = getNextResultSet(stmt);<br>      cleanUpAfterHandlingResultSet();<br>      resultSetCount++;<br>    &#125;<br><br>    String[] resultSets = mappedStatement.getResulSets();<br>    <span class="hljs-keyword">if</span> (resultSets != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">while</span> (rsw != <span class="hljs-literal">null</span> &amp;&amp; resultSetCount &lt; resultSets.length) &#123;<br>        <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">parentMapping</span> <span class="hljs-operator">=</span> nextResultMaps.get(resultSets[resultSetCount]);<br>        <span class="hljs-keyword">if</span> (parentMapping != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">nestedResultMapId</span> <span class="hljs-operator">=</span> parentMapping.getNestedResultMapId();<br>          <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(nestedResultMapId);<br>          handleResultSet(rsw, resultMap, <span class="hljs-literal">null</span>, parentMapping);<br>        &#125;<br>        rsw = getNextResultSet(stmt);<br>        cleanUpAfterHandlingResultSet();<br>        resultSetCount++;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> collapseSingleResultList(multipleResults);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> ResultSetWrapper <span class="hljs-title function_">getFirstResultSet</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.getResultSet();<br>    <span class="hljs-comment">// HSQLDB2.1特殊情况处理</span><br>    <span class="hljs-keyword">while</span> (rs == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// move forward to get the first resultset in case the driver</span><br>      <span class="hljs-comment">// doesn&#x27;t return the resultset as the first result (HSQLDB 2.1)</span><br>      <span class="hljs-keyword">if</span> (stmt.getMoreResults()) &#123;<br>        rs = stmt.getResultSet();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (stmt.getUpdateCount() == -<span class="hljs-number">1</span>) &#123;<br>          <span class="hljs-comment">// no more results. Must be no resultset</span><br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> rs != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultSetWrapper</span>(rs, configuration) : <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateResultMapsCount</span><span class="hljs-params">(ResultSetWrapper rsw, <span class="hljs-type">int</span> resultMapCount)</span> &#123;<br>    <span class="hljs-keyword">if</span> (rsw != <span class="hljs-literal">null</span> &amp;&amp; resultMapCount &lt; <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;A query was run and no Result Maps were found for the Mapped Statement &#x27;&quot;</span> + mappedStatement.getId()<br>          + <span class="hljs-string">&quot;&#x27;.  It&#x27;s likely that neither a Result Type nor a Result Map was specified.&quot;</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> ResultSetWrapper <span class="hljs-title function_">getNextResultSet</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// Making this method tolerant of bad JDBC drivers</span><br>    <span class="hljs-comment">// 使得该方法能够容忍不良的JDBC驱动程序</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (stmt.getConnection().getMetaData().supportsMultipleResultSets()) &#123;<br>        <span class="hljs-comment">// Crazy Standard JDBC way of determining if there are more results</span><br>        <span class="hljs-keyword">if</span> (!((!stmt.getMoreResults()) &amp;&amp; (stmt.getUpdateCount() == -<span class="hljs-number">1</span>))) &#123;<br>          <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.getResultSet();<br>          <span class="hljs-keyword">return</span> rs != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultSetWrapper</span>(rs, configuration) : <span class="hljs-literal">null</span>;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-comment">// Intentionally ignored.</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanUpAfterHandlingResultSet</span><span class="hljs-params">()</span> &#123;<br>    nestedResultObjects.clear();<br>    ancestorColumnPrefix.clear();<br>  &#125; <br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">private</span> List&lt;Object&gt; <span class="hljs-title function_">collapseSingleResultList</span><span class="hljs-params">(List&lt;Object&gt; multipleResults)</span> &#123;<br>    <span class="hljs-keyword">return</span> multipleResults.size() == <span class="hljs-number">1</span> ? (List&lt;Object&gt;) multipleResults.get(<span class="hljs-number">0</span>) : multipleResults;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="StatementHandler"><a href="#StatementHandler" class="headerlink" title="StatementHandler"></a>StatementHandler</h4><p>    语句处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StatementHandler</span> &#123;<br><br>  <span class="hljs-comment">// 准备语句</span><br>  Statement <span class="hljs-title function_">prepare</span><span class="hljs-params">(Connection connection)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// 参数化</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// 批处理</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">batch</span><span class="hljs-params">(Statement statement)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// update</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// select--&gt;结果给ResultHandler</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// 得到绑定sql</span><br>  BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">// 得到参数处理器</span><br>  ParameterHandler <span class="hljs-title function_">getParameterHandler</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="BaseStatementHandler"><a href="#BaseStatementHandler" class="headerlink" title="BaseStatementHandler"></a>BaseStatementHandler</h4><p>      语句处理器的基类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseStatementHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StatementHandler</span> &#123;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Configuration configuration;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> TypeHandlerRegistry typeHandlerRegistry;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ResultSetHandler resultSetHandler;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ParameterHandler parameterHandler;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Executor executor;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> MappedStatement mappedStatement;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> RowBounds rowBounds;<br><br>  <span class="hljs-keyword">protected</span> BoundSql boundSql;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">BaseStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = mappedStatement.getConfiguration();<br>    <span class="hljs-built_in">this</span>.executor = executor;<br>    <span class="hljs-built_in">this</span>.mappedStatement = mappedStatement;<br>    <span class="hljs-built_in">this</span>.rowBounds = rowBounds;<br><br>    <span class="hljs-built_in">this</span>.typeHandlerRegistry = configuration.getTypeHandlerRegistry();<br>    <span class="hljs-built_in">this</span>.objectFactory = configuration.getObjectFactory();<br><br>    <span class="hljs-keyword">if</span> (boundSql == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// issue #435, get the key before calculating the statement</span><br>      generateKeys(parameterObject);<br>      boundSql = mappedStatement.getBoundSql(parameterObject);<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.boundSql = boundSql;<br><br>    <span class="hljs-comment">// 生成parameterHandler</span><br>    <span class="hljs-built_in">this</span>.parameterHandler = configuration.newParameterHandler(mappedStatement, parameterObject, boundSql);<br>    <span class="hljs-comment">// 生成resultSetHandler</span><br>    <span class="hljs-built_in">this</span>.resultSetHandler = configuration.newResultSetHandler(executor, mappedStatement, rowBounds, parameterHandler, resultHandler, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> boundSql;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> ParameterHandler <span class="hljs-title function_">getParameterHandler</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> parameterHandler;<br>  &#125;<br><br>  <span class="hljs-comment">// 准备语句</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Statement <span class="hljs-title function_">prepare</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    ErrorContext.instance().sql(boundSql.getSql());<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 实例化Statement</span><br>      statement = instantiateStatement(connection);<br>      <span class="hljs-comment">// 设置超时</span><br>      setStatementTimeout(statement);<br>      <span class="hljs-comment">// 设置读取条数</span><br>      setFetchSize(statement);<br>      <span class="hljs-keyword">return</span> statement;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      closeStatement(statement);<br>      <span class="hljs-keyword">throw</span> e;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      closeStatement(statement);<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error preparing statement.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 如何实例化Statement，交给子类做</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// 设置超时,其实就是调用Statement.setQueryTimeout</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatementTimeout</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> mappedStatement.getTimeout();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">defaultTimeout</span> <span class="hljs-operator">=</span> configuration.getDefaultStatementTimeout();<br>    <span class="hljs-keyword">if</span> (timeout != <span class="hljs-literal">null</span>) &#123;<br>      stmt.setQueryTimeout(timeout);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (defaultTimeout != <span class="hljs-literal">null</span>) &#123;<br>      stmt.setQueryTimeout(defaultTimeout);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 设置读取条数,其实就是调用Statement.setFetchSize</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFetchSize</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> mappedStatement.getFetchSize();<br>    <span class="hljs-keyword">if</span> (fetchSize != <span class="hljs-literal">null</span>) &#123;<br>      stmt.setFetchSize(fetchSize);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 关闭语句</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeStatement</span><span class="hljs-params">(Statement statement)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (statement != <span class="hljs-literal">null</span>) &#123;<br>        statement.close();<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-comment">// ignore</span><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 生成key</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateKeys</span><span class="hljs-params">(Object parameter)</span> &#123;<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();<br>    ErrorContext.instance().store();<br>    keyGenerator.processBefore(executor, mappedStatement, <span class="hljs-literal">null</span>, parameter);<br>    ErrorContext.instance().recall();<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="SimpleStatementHandler"><a href="#SimpleStatementHandler" class="headerlink" title="SimpleStatementHandler"></a>SimpleStatementHandler</h4><p>    简单语句处理器(STATEMENT)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleStatementHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseStatementHandler</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-built_in">super</span>(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> boundSql.getParameterObject();<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();<br>    <span class="hljs-type">int</span> rows;<br>    <span class="hljs-keyword">if</span> (keyGenerator <span class="hljs-keyword">instanceof</span> Jdbc3KeyGenerator) &#123;<br>      statement.execute(sql, Statement.RETURN_GENERATED_KEYS);<br>      rows = statement.getUpdateCount();<br>      keyGenerator.processAfter(executor, mappedStatement, statement, parameterObject);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyGenerator <span class="hljs-keyword">instanceof</span> SelectKeyGenerator) &#123;<br>      statement.execute(sql);<br>      rows = statement.getUpdateCount();<br>      keyGenerator.processAfter(executor, mappedStatement, statement, parameterObject);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 如果没有keyGenerator,直接调用Statement.execute和Statement.getUpdateCount</span><br>      statement.execute(sql);<br>      rows = statement.getUpdateCount();<br>    &#125;<br>    <span class="hljs-keyword">return</span> rows;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batch</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-comment">// 调用Statement.addBatch</span><br>    statement.addBatch(sql);<br>  &#125;<br><br>  <span class="hljs-comment">// select--&gt;结果给ResultHandler</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    statement.execute(sql);<br>    <span class="hljs-comment">// 先执行Statement.execute，然后交给ResultSetHandler.handleResultSets</span><br>    <span class="hljs-keyword">return</span> resultSetHandler.&lt;E&gt;handleResultSets(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 调用Connection.createStatement</span><br>    <span class="hljs-keyword">if</span> (mappedStatement.getResultSetType() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> connection.createStatement(mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> connection.createStatement();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// N/A</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="PreparedStatementHandler"><a href="#PreparedStatementHandler" class="headerlink" title="PreparedStatementHandler"></a>PreparedStatementHandler</h4><p>    预处理语句处理器(PREPARED)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreparedStatementHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseStatementHandler</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PreparedStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-built_in">super</span>(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 调用PreparedStatement.execute和PreparedStatement.getUpdateCount</span><br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> (PreparedStatement) statement;<br>    ps.execute();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> ps.getUpdateCount();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> boundSql.getParameterObject();<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();<br>    keyGenerator.processAfter(executor, mappedStatement, ps, parameterObject);<br>    <span class="hljs-keyword">return</span> rows;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batch</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> (PreparedStatement) statement;<br>    ps.addBatch();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> (PreparedStatement) statement;<br>    ps.execute();<br>    <span class="hljs-keyword">return</span> resultSetHandler.&lt;E&gt; handleResultSets(ps);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 调用Connection.prepareStatement</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-keyword">if</span> (mappedStatement.getKeyGenerator() <span class="hljs-keyword">instanceof</span> Jdbc3KeyGenerator) &#123;<br>      String[] keyColumnNames = mappedStatement.getKeyColumns();<br>      <span class="hljs-keyword">if</span> (keyColumnNames == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> connection.prepareStatement(sql, PreparedStatement.RETURN_GENERATED_KEYS);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> connection.prepareStatement(sql, keyColumnNames);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappedStatement.getResultSetType() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> connection.prepareStatement(sql, mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> connection.prepareStatement(sql);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 调用ParameterHandler.setParameters</span><br>    parameterHandler.setParameters((PreparedStatement) statement);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="CallableStatementHandler"><a href="#CallableStatementHandler" class="headerlink" title="CallableStatementHandler"></a>CallableStatementHandler</h4><p>      存储过程语句处理器(CALLABLE)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CallableStatementHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseStatementHandler</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CallableStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-built_in">super</span>(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 这个方法和PreparedStatementHandler代码基本一样,就多了最后的handleOutputParameters</span><br>    <span class="hljs-comment">// 调用Statement.execute和Statement.getUpdateCount</span><br>    <span class="hljs-type">CallableStatement</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> (CallableStatement) statement;<br>    cs.execute();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> cs.getUpdateCount();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> boundSql.getParameterObject();<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();<br>    keyGenerator.processAfter(executor, mappedStatement, cs, parameterObject);<br>    <span class="hljs-comment">// 然后交给ResultSetHandler.handleOutputParameters</span><br>    resultSetHandler.handleOutputParameters(cs);<br>    <span class="hljs-keyword">return</span> rows;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batch</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">CallableStatement</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> (CallableStatement) statement;<br>    cs.addBatch();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">CallableStatement</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> (CallableStatement) statement;<br>    cs.execute();<br>    List&lt;E&gt; resultList = resultSetHandler.&lt;E&gt;handleResultSets(cs);<br>    resultSetHandler.handleOutputParameters(cs);<br>    <span class="hljs-keyword">return</span> resultList;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 调用Connection.prepareCall</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-keyword">if</span> (mappedStatement.getResultSetType() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> connection.prepareCall(sql, mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> connection.prepareCall(sql);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 注册OUT参数</span><br>    registerOutputParameters((CallableStatement) statement);<br>    <span class="hljs-comment">// 调用ParameterHandler.setParameters</span><br>    parameterHandler.setParameters((CallableStatement) statement);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerOutputParameters</span><span class="hljs-params">(CallableStatement cs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = parameterMappings.size(); i &lt; n; i++) &#123;<br>      <span class="hljs-type">ParameterMapping</span> <span class="hljs-variable">parameterMapping</span> <span class="hljs-operator">=</span> parameterMappings.get(i);<br>      <span class="hljs-comment">//只处理OUT|INOUT</span><br>      <span class="hljs-keyword">if</span> (parameterMapping.getMode() == ParameterMode.OUT || parameterMapping.getMode() == ParameterMode.INOUT) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == parameterMapping.getJdbcType()) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;The JDBC Type must be specified for output parameter.  Parameter: &quot;</span> + parameterMapping.getProperty());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">if</span> (parameterMapping.getNumericScale() != <span class="hljs-literal">null</span> &amp;&amp; (parameterMapping.getJdbcType() == JdbcType.NUMERIC || parameterMapping.getJdbcType() == JdbcType.DECIMAL)) &#123;<br>            cs.registerOutParameter(i + <span class="hljs-number">1</span>, parameterMapping.getJdbcType().TYPE_CODE, parameterMapping.getNumericScale());<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//核心是调用CallableStatement.registerOutParameter</span><br>            <span class="hljs-keyword">if</span> (parameterMapping.getJdbcTypeName() == <span class="hljs-literal">null</span>) &#123;<br>              cs.registerOutParameter(i + <span class="hljs-number">1</span>, parameterMapping.getJdbcType().TYPE_CODE);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              cs.registerOutParameter(i + <span class="hljs-number">1</span>, parameterMapping.getJdbcType().TYPE_CODE, parameterMapping.getJdbcTypeName());<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="RoutingStatementHandler"><a href="#RoutingStatementHandler" class="headerlink" title="RoutingStatementHandler"></a>RoutingStatementHandler</h4><p>      路由选择语句处理器,有点像代理模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutingStatementHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StatementHandler</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StatementHandler delegate;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">RoutingStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br><br>    <span class="hljs-comment">// 根据语句类型，委派到不同的语句处理器(STATEMENT|PREPARED|CALLABLE)</span><br>    <span class="hljs-keyword">switch</span> (ms.getStatementType()) &#123;<br>      <span class="hljs-keyword">case</span> STATEMENT:<br>        delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> PREPARED:<br>        delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PreparedStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> CALLABLE:<br>        delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CallableStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Unknown statement type: &quot;</span> + ms.getStatementType());<br>    &#125;<br><br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Statement <span class="hljs-title function_">prepare</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> delegate.prepare(connection);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    delegate.parameterize(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batch</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    delegate.batch(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> delegate.update(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> delegate.&lt;E&gt;query(statement, resultHandler);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.getBoundSql();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> ParameterHandler <span class="hljs-title function_">getParameterHandler</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.getParameterHandler();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h4><p>    执行器抽象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Executor</span> &#123;<br><br>  <span class="hljs-comment">// 不需要ResultHandler</span><br>  <span class="hljs-type">ResultHandler</span> <span class="hljs-variable">NO_RESULT_HANDLER</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-comment">// 更新</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// 查询，带分页，带缓存，BoundSql</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey cacheKey, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// 查询，带分页</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// 刷新批处理语句</span><br>  List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// 提交和回滚，参数是是否要强制</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// 创建CacheKey</span><br>  CacheKey <span class="hljs-title function_">createCacheKey</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span>;<br><br>  <span class="hljs-comment">// 判断是否缓存了</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCached</span><span class="hljs-params">(MappedStatement ms, CacheKey key)</span>;<br><br>  <span class="hljs-comment">// 清理Session缓存</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearLocalCache</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">// 延迟加载</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">deferLoad</span><span class="hljs-params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span>;<br><br>  Transaction <span class="hljs-title function_">getTransaction</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">(<span class="hljs-type">boolean</span> forceRollback)</span>;<br><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">isClosed</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecutorWrapper</span><span class="hljs-params">(Executor executor)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="BaseExecutor"><a href="#BaseExecutor" class="headerlink" title="BaseExecutor"></a>BaseExecutor</h4><p>    执行器基类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(BaseExecutor.class);<br><br>  <span class="hljs-keyword">protected</span> Transaction transaction;<br>  <span class="hljs-keyword">protected</span> Executor wrapper;<br><br>  <span class="hljs-comment">// 延迟加载队列（线程安全）</span><br>  <span class="hljs-keyword">protected</span> ConcurrentLinkedQueue&lt;DeferredLoad&gt; deferredLoads;<br>  <span class="hljs-comment">// 本地缓存机制（Local Cache）防止循环引用（circular references）和加速重复嵌套查询(一级缓存)</span><br>  <span class="hljs-comment">// 本地缓存</span><br>  <span class="hljs-keyword">protected</span> PerpetualCache localCache;<br>  <span class="hljs-comment">// 本地输出参数缓存</span><br>  <span class="hljs-keyword">protected</span> PerpetualCache localOutputParameterCache;<br>  <span class="hljs-keyword">protected</span> Configuration configuration;<br><br>  <span class="hljs-comment">// 查询堆栈</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">queryStack</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> closed; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">BaseExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> &#123;<br>    <span class="hljs-built_in">this</span>.transaction = transaction;<br>    <span class="hljs-built_in">this</span>.deferredLoads = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedQueue</span>&lt;DeferredLoad&gt;();<br>    <span class="hljs-built_in">this</span>.localCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerpetualCache</span>(<span class="hljs-string">&quot;LocalCache&quot;</span>);<br>    <span class="hljs-built_in">this</span>.localOutputParameterCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerpetualCache</span>(<span class="hljs-string">&quot;LocalOutputParameterCache&quot;</span>);<br>    <span class="hljs-built_in">this</span>.closed = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.wrapper = <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Transaction <span class="hljs-title function_">getTransaction</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> transaction;<br>  &#125; <br><br>  <span class="hljs-comment">// 关闭执行器</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">(<span class="hljs-type">boolean</span> forceRollback)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123; <br>        <span class="hljs-comment">// 清除本地缓存，flush，回滚</span><br>        rollback(forceRollback);<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) &#123;<br>          transaction.close();<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-comment">// Ignore.  There&#x27;s nothing that can be done at this point.</span><br>      log.warn(<span class="hljs-string">&quot;Unexpected exception on closing transaction.  Cause: &quot;</span> + e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      transaction = <span class="hljs-literal">null</span>;<br>      deferredLoads = <span class="hljs-literal">null</span>;<br>      localCache = <span class="hljs-literal">null</span>;<br>      localOutputParameterCache = <span class="hljs-literal">null</span>;<br>      closed = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (!closed) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        clearLocalCache();<br>        flushStatements(<span class="hljs-literal">true</span>);<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (required) &#123;<br>          transaction.rollback();<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearLocalCache</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (!closed) &#123;<br>      localCache.clear();<br>      localOutputParameterCache.clear();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> flushStatements(<span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// 刷新语句，Batch用</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollBack)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> doFlushStatements(isRollBack);<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span><br>      <span class="hljs-keyword">throws</span> SQLException; <br><br>  <span class="hljs-comment">// SqlSession.update/insert/delete会调用此方法</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing an update&quot;</span>).object(ms.getId());<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 先清局部缓存，再更新，如何更新交由子类，模板方法模式</span><br>    clearLocalCache();<br>    <span class="hljs-keyword">return</span> doUpdate(ms, parameter);<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span><br>      <span class="hljs-keyword">throws</span> SQLException;  <br><br>  <span class="hljs-comment">// SqlSession.selectList会调用此方法</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 得到绑定sql</span><br>    <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> ms.getBoundSql(parameter);<br>    <span class="hljs-comment">// 创建缓存Key</span><br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> createCacheKey(ms, parameter, rowBounds, boundSql);<br>    <span class="hljs-comment">// 查询</span><br>    <span class="hljs-keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>  &#125; <br><br>  <span class="hljs-comment">// 创建缓存Key</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> CacheKey <span class="hljs-title function_">createCacheKey</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheKey</span>();<br>    <span class="hljs-comment">// MyBatis 对于其 Key 的生成采取规则为：[mappedStementId + offset + limit + SQL + queryParams + environment]生成一个哈希码</span><br>    cacheKey.update(ms.getId());<br>    cacheKey.update(Integer.valueOf(rowBounds.getOffset()));<br>    cacheKey.update(Integer.valueOf(rowBounds.getLimit()));<br>    cacheKey.update(boundSql.getSql());<br>    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();<br>    <span class="hljs-type">TypeHandlerRegistry</span> <span class="hljs-variable">typeHandlerRegistry</span> <span class="hljs-operator">=</span> ms.getConfiguration().getTypeHandlerRegistry();<br>    <span class="hljs-comment">// mimic DefaultParameterHandler logic</span><br>    <span class="hljs-comment">// 模仿DefaultParameterHandler的逻辑,不再重复，请参考DefaultParameterHandler</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameterMappings.size(); i++) &#123;<br>      <span class="hljs-type">ParameterMapping</span> <span class="hljs-variable">parameterMapping</span> <span class="hljs-operator">=</span> parameterMappings.get(i);<br>      <span class="hljs-comment">// 输入型参数</span><br>      <span class="hljs-keyword">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;<br>        Object value;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> parameterMapping.getProperty();<br>        <span class="hljs-keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;<br>          value = boundSql.getAdditionalParameter(propertyName);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterObject == <span class="hljs-literal">null</span>) &#123;<br>          value = <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;<br>          value = parameterObject;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameterObject);<br>          value = metaObject.getValue(propertyName);<br>        &#125;<br>        cacheKey.update(value);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (configuration.getEnvironment() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// issue #176</span><br>      cacheKey.update(configuration.getEnvironment().getId());<br>    &#125;<br>    <span class="hljs-keyword">return</span> cacheKey;<br>  &#125; <br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing a query&quot;</span>).object(ms.getId());<br>    <span class="hljs-comment">// 如果已经关闭，报错</span><br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 先清局部缓存，再查询.但仅查询堆栈为0，才清。为了处理递归调用</span><br>    <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;<br>      clearLocalCache();<br>    &#125;<br>    List&lt;E&gt; list;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 加一,这样递归调用到上面的时候就不会再清局部缓存了</span><br>      queryStack++;<br>      <span class="hljs-comment">// 先根据cachekey从localCache去查</span><br>      list = resultHandler == <span class="hljs-literal">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 若查到localCache缓存，处理localOutputParameterCache</span><br>        handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 从数据库查</span><br>        list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>      &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// 清空堆栈</span><br>      queryStack--;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// 加载延迟加载队列</span><br>      <span class="hljs-keyword">for</span> (DeferredLoad deferredLoad : deferredLoads) &#123;<br>        deferredLoad.load();<br>      &#125;<br>      <span class="hljs-comment">// issue #601</span><br>      <span class="hljs-comment">// 清空延迟加载队列</span><br>      deferredLoads.clear();<br>      <span class="hljs-keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;<br>        <span class="hljs-comment">// issue #482</span><br>    	<span class="hljs-comment">// 如果LocalCacheScope是STATEMENT，清本地缓存</span><br>        clearLocalCache();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> list;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLocallyCachedOutputParameters</span><span class="hljs-params">(MappedStatement ms, CacheKey key, Object parameter, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-comment">// 处理存储过程的OUT参数</span><br>    <span class="hljs-keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">cachedParameter</span> <span class="hljs-operator">=</span> localOutputParameterCache.getObject(key);<br>      <span class="hljs-keyword">if</span> (cachedParameter != <span class="hljs-literal">null</span> &amp;&amp; parameter != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 将cachedParameter中属性赋值给parameter中对应的属性</span><br>        <span class="hljs-comment">// 属性由 ParameterMapping 指定</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaCachedParameter</span> <span class="hljs-operator">=</span> configuration.newMetaObject(cachedParameter);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaParameter</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameter);<br>        <span class="hljs-keyword">for</span> (ParameterMapping parameterMapping : boundSql.getParameterMappings()) &#123;<br>          <span class="hljs-keyword">if</span> (parameterMapping.getMode() != ParameterMode.IN) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">parameterName</span> <span class="hljs-operator">=</span> parameterMapping.getProperty();<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">cachedValue</span> <span class="hljs-operator">=</span> metaCachedParameter.getValue(parameterName);<br>            metaParameter.setValue(parameterName, cachedValue);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 从数据库查</span><br>  <span class="hljs-keyword">private</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">queryFromDatabase</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;E&gt; list;<br>    <span class="hljs-comment">// 先向缓存中放入占位符？？？</span><br>    localCache.putObject(key, EXECUTION_PLACEHOLDER);<br>    <span class="hljs-keyword">try</span> &#123;<br>      list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// 最后删除占位符</span><br>      localCache.removeObject(key);<br>    &#125;<br>    <span class="hljs-comment">// 加入缓存</span><br>    localCache.putObject(key, list);<br>    <span class="hljs-comment">// 如果是存储过程，OUT参数也加入缓存</span><br>    <span class="hljs-keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;<br>      localOutputParameterCache.putObject(key, parameter);<br>    &#125;<br>    <span class="hljs-keyword">return</span> list;<br>  &#125; <br><br>  <span class="hljs-comment">//query--&gt;queryFromDatabase--&gt;doQuery</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span><br>      <span class="hljs-keyword">throws</span> SQLException; <br><br>  <span class="hljs-comment">// 延迟加载，DefaultResultSetHandler.getNestedQueryMappingValue调用.属于嵌套查询，比较高级.</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deferLoad</span><span class="hljs-params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span> &#123;<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">DeferredLoad</span> <span class="hljs-variable">deferredLoad</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeferredLoad</span>(resultObject, property, key, localCache, configuration, targetType);<br>    <span class="hljs-comment">// 如果能加载，则立刻加载，否则加入到延迟加载队列中</span><br>    <span class="hljs-keyword">if</span> (deferredLoad.canLoad()) &#123;<br>      deferredLoad.load();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 这里怎么又new了一个新的，性能有点问题</span><br>      deferredLoads.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DeferredLoad</span>(resultObject, property, key, localCache, configuration, targetType));<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCached</span><span class="hljs-params">(MappedStatement ms, CacheKey key)</span> &#123;<br>    <span class="hljs-keyword">return</span> localCache.getObject(key) != <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot commit, transaction is already closed&quot;</span>);<br>    &#125;<br>    clearLocalCache();<br>    flushStatements();<br>    <span class="hljs-keyword">if</span> (required) &#123;<br>      transaction.commit();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeStatement</span><span class="hljs-params">(Statement statement)</span> &#123;<br>    <span class="hljs-keyword">if</span> (statement != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        statement.close();<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-comment">// ignore</span><br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> transaction.getConnection();<br>    <span class="hljs-keyword">if</span> (statementLog.isDebugEnabled()) &#123;<br>      <span class="hljs-comment">// 如果需要打印Connection的日志，返回一个ConnectionLogger(代理模式, AOP思想)</span><br>      <span class="hljs-keyword">return</span> ConnectionLogger.newInstance(connection, statementLog, queryStack);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> connection;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecutorWrapper</span><span class="hljs-params">(Executor wrapper)</span> &#123;<br>    <span class="hljs-built_in">this</span>.wrapper = wrapper;<br>  &#125; <br><br>  <span class="hljs-comment">// 延迟加载</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeferredLoad</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MetaObject resultObject;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String property;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; targetType;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CacheKey key;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PerpetualCache localCache;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResultExtractor resultExtractor;<br><br>    <span class="hljs-comment">// issue #781</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DeferredLoad</span><span class="hljs-params">(MetaObject resultObject,</span><br><span class="hljs-params">                        String property,</span><br><span class="hljs-params">                        CacheKey key,</span><br><span class="hljs-params">                        PerpetualCache localCache,</span><br><span class="hljs-params">                        Configuration configuration,</span><br><span class="hljs-params">                        Class&lt;?&gt; targetType)</span> &#123;<br>      <span class="hljs-built_in">this</span>.resultObject = resultObject;<br>      <span class="hljs-built_in">this</span>.property = property;<br>      <span class="hljs-built_in">this</span>.key = key;<br>      <span class="hljs-built_in">this</span>.localCache = localCache;<br>      <span class="hljs-built_in">this</span>.objectFactory = configuration.getObjectFactory();<br>      <span class="hljs-built_in">this</span>.resultExtractor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultExtractor</span>(configuration, objectFactory);<br>      <span class="hljs-built_in">this</span>.targetType = targetType;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">canLoad</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// 缓存中找到，且不为占位符，代表可以加载</span><br>      <span class="hljs-keyword">return</span> localCache.getObject(key) != <span class="hljs-literal">null</span> &amp;&amp; localCache.getObject(key) != EXECUTION_PLACEHOLDER;<br>    &#125;<br><br>	<span class="hljs-comment">// 加载</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-meta">@SuppressWarnings( &quot;unchecked&quot; )</span><br>      <span class="hljs-comment">// we suppose we get back a List</span><br>      List&lt;Object&gt; list = (List&lt;Object&gt;) localCache.getObject(key);<br>      <span class="hljs-comment">// 调用ResultExtractor.extractObjectFromList</span><br>      <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> resultExtractor.extractObjectFromList(list, targetType);<br>      resultObject.setValue(property, value);<br>    &#125;<br><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="SimpleExecutor"><a href="#SimpleExecutor" class="headerlink" title="SimpleExecutor"></a>SimpleExecutor</h4><p>    简单执行器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration, transaction);<br>  &#125;<br><br>  <span class="hljs-comment">// update</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>      <span class="hljs-comment">// 新建一个StatementHandler</span><br>      <span class="hljs-comment">// 这里看到ResultHandler传入的是null</span><br>      <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(<span class="hljs-built_in">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>      <span class="hljs-comment">// 准备语句</span><br>      stmt = prepareStatement(handler, ms.getStatementLog());<br>      <span class="hljs-comment">// StatementHandler.update</span><br>      <span class="hljs-keyword">return</span> handler.update(stmt);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      closeStatement(stmt);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// select</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>      <span class="hljs-comment">// 新建一个StatementHandler</span><br>      <span class="hljs-comment">// 这里看到ResultHandler传入了</span><br>      <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);<br>      <span class="hljs-comment">// 准备语句</span><br>      stmt = prepareStatement(handler, ms.getStatementLog());<br>      <span class="hljs-comment">// StatementHandler.query</span><br>      <span class="hljs-keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      closeStatement(stmt);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>	<span class="hljs-comment">// doFlushStatements只是给batch用的，所以这里返回空</span><br>    <span class="hljs-keyword">return</span> Collections.emptyList();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> Statement <span class="hljs-title function_">prepareStatement</span><span class="hljs-params">(StatementHandler handler, Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    Statement stmt;<br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getConnection(statementLog);<br>    <span class="hljs-comment">// 调用StatementHandler.prepare</span><br>    stmt = handler.prepare(connection);<br>    <span class="hljs-comment">// 调用StatementHandler.parameterize</span><br>    handler.parameterize(stmt);<br>    <span class="hljs-keyword">return</span> stmt;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ReuseExecutor"><a href="#ReuseExecutor" class="headerlink" title="ReuseExecutor"></a>ReuseExecutor</h4><p>    可重用执行器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReuseExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> &#123; <br><br>  <span class="hljs-comment">// 可重用的执行器内部用了一个map，用来缓存SQL语句对应的Statement</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Statement&gt; statementMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Statement&gt;();<br> <br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReuseExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration, transaction);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>    <span class="hljs-comment">// 和SimpleExecutor一样，新建一个StatementHandler</span><br>    <span class="hljs-comment">// 这里看到ResultHandler传入的是null</span><br>    <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(<span class="hljs-built_in">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">// 准备语句</span><br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> prepareStatement(handler, ms.getStatementLog());<br>    <span class="hljs-keyword">return</span> handler.update(stmt);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>    <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> prepareStatement(handler, ms.getStatementLog());<br>    <span class="hljs-keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Statement <span class="hljs-title function_">prepareStatement</span><span class="hljs-params">(StatementHandler handler, Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    Statement stmt;<br>    <span class="hljs-comment">// 得到绑定的SQL语句</span><br>    <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> handler.getBoundSql();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-comment">// 如果缓存中已经有了，直接得到Statement</span><br>    <span class="hljs-keyword">if</span> (hasStatementFor(sql)) &#123;<br>      stmt = getStatement(sql);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 如果缓存没有找到，则和SimpleExecutor处理完全一样，然后加入缓存</span><br>      <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getConnection(statementLog);<br>      stmt = handler.prepare(connection);<br>      putStatement(sql, stmt);<br>    &#125;<br>    handler.parameterize(stmt);<br>    <span class="hljs-keyword">return</span> stmt;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasStatementFor</span><span class="hljs-params">(String sql)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> statementMap.keySet().contains(sql) &amp;&amp; !statementMap.get(sql).getConnection().isClosed();<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Statement <span class="hljs-title function_">getStatement</span><span class="hljs-params">(String s)</span> &#123;<br>    <span class="hljs-keyword">return</span> statementMap.get(s);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putStatement</span><span class="hljs-params">(String sql, Statement stmt)</span> &#123;<br>    statementMap.put(sql, stmt);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">for</span> (Statement stmt : statementMap.values()) &#123;<br>      closeStatement(stmt);<br>    &#125;<br>    statementMap.clear();<br>    <span class="hljs-keyword">return</span> Collections.emptyList();<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="BatchResult"><a href="#BatchResult" class="headerlink" title="BatchResult"></a>BatchResult</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchResult</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MappedStatement mappedStatement;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String sql;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Object&gt; parameterObjects;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] updateCounts;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BatchResult</span><span class="hljs-params">(MappedStatement mappedStatement, String sql)</span> &#123;<br>    <span class="hljs-built_in">super</span>();<br>    <span class="hljs-built_in">this</span>.mappedStatement = mappedStatement;<br>    <span class="hljs-built_in">this</span>.sql = sql;<br>    <span class="hljs-built_in">this</span>.parameterObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BatchResult</span><span class="hljs-params">(MappedStatement mappedStatement, String sql, Object parameterObject)</span> &#123;<br>    <span class="hljs-built_in">this</span>(mappedStatement, sql);<br>    addParameterObject(parameterObject);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title function_">getMappedStatement</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> mappedStatement;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSql</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> sql;<br>  &#125;<br><br>  <span class="hljs-meta">@Deprecated</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getParameterObject</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> parameterObjects.get(<span class="hljs-number">0</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">getParameterObjects</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> parameterObjects;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] getUpdateCounts() &#123;<br>    <span class="hljs-keyword">return</span> updateCounts;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUpdateCounts</span><span class="hljs-params">(<span class="hljs-type">int</span>[] updateCounts)</span> &#123;<br>    <span class="hljs-built_in">this</span>.updateCounts = updateCounts;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addParameterObject</span><span class="hljs-params">(Object parameterObject)</span> &#123;<br>    <span class="hljs-built_in">this</span>.parameterObjects.add(parameterObject);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="BatchExecutor"><a href="#BatchExecutor" class="headerlink" title="BatchExecutor"></a>BatchExecutor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BATCH_UPDATE_RETURN_VALUE</span> <span class="hljs-operator">=</span> Integer.MIN_VALUE + <span class="hljs-number">1002</span>;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Statement&gt; statementList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Statement&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;BatchResult&gt; batchResultList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;BatchResult&gt;();<br>  <span class="hljs-keyword">private</span> String currentSql;<br>  <span class="hljs-keyword">private</span> MappedStatement currentStatement; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BatchExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration, transaction);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameterObject)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(<span class="hljs-built_in">this</span>, ms, parameterObject, RowBounds.DEFAULT, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> handler.getBoundSql();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-keyword">final</span> Statement stmt;<br>    <span class="hljs-comment">// 只设置参数</span><br>    <span class="hljs-keyword">if</span> (sql.equals(currentSql) &amp;&amp; ms.equals(currentStatement)) &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> statementList.size() - <span class="hljs-number">1</span>;<br>      stmt = statementList.get(last);<br>      <span class="hljs-type">BatchResult</span> <span class="hljs-variable">batchResult</span> <span class="hljs-operator">=</span> batchResultList.get(last);<br>      batchResult.addParameterObject(parameterObject);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 添加要执行的语句和BatchResult</span><br>      <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getConnection(ms.getStatementLog());<br>      stmt = handler.prepare(connection);<br>      currentSql = sql;<br>      currentStatement = ms;<br>      statementList.add(stmt);<br>      batchResultList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchResult</span>(ms, sql, parameterObject));<br>    &#125;<br>    handler.parameterize(stmt);<br>    handler.batch(stmt);<br>    <span class="hljs-keyword">return</span> BATCH_UPDATE_RETURN_VALUE;<br>  &#125; <br><br>  <span class="hljs-comment">// 查询和其他执行器差不多</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123; <br>      <span class="hljs-comment">// 不同的地方在于查询前先flush</span><br>      flushStatements();<br>      <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>      <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(wrapper, ms, parameterObject, rowBounds, resultHandler, boundSql);<br>      <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getConnection(ms.getStatementLog());<br>      stmt = handler.prepare(connection);<br>      handler.parameterize(stmt);<br>      <span class="hljs-keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      closeStatement(stmt);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      List&lt;BatchResult&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;BatchResult&gt;();<br>      <span class="hljs-keyword">if</span> (isRollback) &#123;<br>        <span class="hljs-keyword">return</span> Collections.emptyList();<br>      &#125;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = statementList.size(); i &lt; n; i++) &#123;<br>        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> statementList.get(i);<br>        <span class="hljs-type">BatchResult</span> <span class="hljs-variable">batchResult</span> <span class="hljs-operator">=</span> batchResultList.get(i);<br>        <span class="hljs-keyword">try</span> &#123;<br>          batchResult.setUpdateCounts(stmt.executeBatch());<br>          <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> batchResult.getMappedStatement();<br>          List&lt;Object&gt; parameterObjects = batchResult.getParameterObjects();<br>          <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> ms.getKeyGenerator();<br>          <span class="hljs-keyword">if</span> (Jdbc3KeyGenerator.class.equals(keyGenerator.getClass())) &#123;<br>            <span class="hljs-type">Jdbc3KeyGenerator</span> <span class="hljs-variable">jdbc3KeyGenerator</span> <span class="hljs-operator">=</span> (Jdbc3KeyGenerator) keyGenerator;<br>            jdbc3KeyGenerator.processBatch(ms, stmt, parameterObjects);<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!NoKeyGenerator.class.equals(keyGenerator.getClass())) &#123; <span class="hljs-comment">//issue #141</span><br>            <span class="hljs-comment">// selectKeyGenerator</span><br>            <span class="hljs-keyword">for</span> (Object parameter : parameterObjects) &#123;<br>              keyGenerator.processAfter(<span class="hljs-built_in">this</span>, ms, stmt, parameter);<br>            &#125;<br>          &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (BatchUpdateException e) &#123;<br>          <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>          message.append(batchResult.getMappedStatement().getId())<br>              .append(<span class="hljs-string">&quot; (batch index #&quot;</span>)<br>              .append(i + <span class="hljs-number">1</span>)<br>              .append(<span class="hljs-string">&quot;)&quot;</span>)<br>              .append(<span class="hljs-string">&quot; failed.&quot;</span>);<br>          <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) &#123;<br>            message.append(<span class="hljs-string">&quot; &quot;</span>)<br>                .append(i)<br>                .append(<span class="hljs-string">&quot; prior sub executor(s) completed successfully, but will be rolled back.&quot;</span>);<br>          &#125;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchExecutorException</span>(message.toString(), e, results, batchResult);<br>        &#125;<br>        results.add(batchResult);<br>      &#125;<br>      <span class="hljs-keyword">return</span> results;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">for</span> (Statement stmt : statementList) &#123;<br>        closeStatement(stmt);<br>      &#125;<br>      currentSql = <span class="hljs-literal">null</span>;<br>      statementList.clear();<br>      batchResultList.clear();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="CachingExecutor"><a href="#CachingExecutor" class="headerlink" title="CachingExecutor"></a>CachingExecutor</h4><p>    二级缓存执行器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachingExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> &#123; <br><br>  <span class="hljs-keyword">private</span> Executor delegate;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">TransactionalCacheManager</span> <span class="hljs-variable">tcm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionalCacheManager</span>(); <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CachingExecutor</span><span class="hljs-params">(Executor delegate)</span> &#123;<br>    <span class="hljs-built_in">this</span>.delegate = delegate;<br>    delegate.setExecutorWrapper(<span class="hljs-built_in">this</span>);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Transaction <span class="hljs-title function_">getTransaction</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.getTransaction();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">(<span class="hljs-type">boolean</span> forceRollback)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//issues #499, #524 and #573</span><br>      <span class="hljs-keyword">if</span> (forceRollback) &#123; <br>        tcm.rollback();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        tcm.commit();<br>      &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      delegate.close(forceRollback);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isClosed</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.isClosed();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(MappedStatement ms, Object parameterObject)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>	<span class="hljs-comment">// 刷新完缓存再update</span><br>    flushCacheIfRequired(ms);<br>    <span class="hljs-keyword">return</span> delegate.update(ms, parameterObject);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flushCacheIfRequired</span><span class="hljs-params">(MappedStatement ms)</span> &#123;<br>    <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> ms.getCache();<br>    <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;      <br>      tcm.clear(cache);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> ms.getBoundSql(parameterObject);<br>	<span class="hljs-comment">// query时传入一个cachekey参数</span><br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> createCacheKey(ms, parameterObject, rowBounds, boundSql);<br>    <span class="hljs-keyword">return</span> query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> CacheKey <span class="hljs-title function_">createCacheKey</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.createCacheKey(ms, parameterObject, rowBounds, boundSql);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> ms.getCache();<br>    <span class="hljs-comment">// 默认情况下是没有开启缓存的(二级缓存).要开启二级缓存,你需要在你的 SQL 映射文件中添加一行: &lt;cache/&gt;</span><br>    <span class="hljs-comment">// 简单的说，就是先查CacheKey，查不到再委托给实际的执行器去查</span><br>    <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span>) &#123;<br>      flushCacheIfRequired(ms);<br>      <span class="hljs-keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="hljs-literal">null</span>) &#123;<br>        ensureNoOutParams(ms, parameterObject, boundSql);<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);<br>        <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span>) &#123;<br>          list = delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>          tcm.putObject(cache, key, list); <span class="hljs-comment">// issue #578 and #116</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureNoOutParams</span><span class="hljs-params">(MappedStatement ms, Object parameter, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;<br>      <span class="hljs-keyword">for</span> (ParameterMapping parameterMapping : boundSql.getParameterMappings()) &#123;<br>        <span class="hljs-keyword">if</span> (parameterMapping.getMode() != ParameterMode.IN) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Caching stored procedures with OUT params is not supported.  Please configure useCache=false in &quot;</span> + ms.getId() + <span class="hljs-string">&quot; statement.&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> delegate.flushStatements();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    delegate.commit(required);<br>    tcm.commit();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      delegate.rollback(required);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (required) &#123;<br>        tcm.rollback();<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCached</span><span class="hljs-params">(MappedStatement ms, CacheKey key)</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.isCached(ms, key);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deferLoad</span><span class="hljs-params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span> &#123;<br>    delegate.deferLoad(ms, resultObject, property, key, targetType);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecutorWrapper</span><span class="hljs-params">(Executor executor)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;This method should not be called&quot;</span>);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearLocalCache</span><span class="hljs-params">()</span> &#123;<br>    delegate.clearLocalCache();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="category-chain-item">Mybatis源码解析</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Mybatis/">#Mybatis</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
<!--    <div class="license-title">-->
<!--      <div>16-executor</div>-->
<!--      <div>https://xiaohuanxiong3.github.io/2023/08/28/16-executor/</div>-->
<!--    </div>-->
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Handsome Young</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年8月28日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            MIT
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/09/04/17-plugin/" title="17-plugin">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">17-plugin</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/08/27/15-binding/" title="15-binding">
                        <span class="hidden-mobile">15-binding</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div>小浣熊的博客 ｜ 记录有趣的收获</div> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
