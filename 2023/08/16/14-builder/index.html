

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/avatar.jpeg">
  <link rel="icon" href="/img/avatar.jpeg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Handsome Young">
  <meta name="keywords" content="">
  
    <meta name="description" content="BaseBuilder    构造器的基类 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939">
<meta property="og:type" content="article">
<meta property="og:title" content="14-builder">
<meta property="og:url" content="https://xiaohuanxiong3.github.io/2023/08/16/14-builder/index.html">
<meta property="og:site_name" content="小浣熊的个人博客">
<meta property="og:description" content="BaseBuilder    构造器的基类 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-08-16T13:23:08.000Z">
<meta property="article:modified_time" content="2023-08-23T15:39:10.598Z">
<meta property="article:author" content="Handsome Young">
<meta property="article:tag" content="Mybatis">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>14-builder - 小浣熊的个人博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xiaohuanxiong3.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>小浣熊</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/poem/">
                <i class="iconfont icon-user-fill"></i>
                古诗词
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/thinking/">
                <i class="iconfont icon-user-fill"></i>
                思考ing
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="14-builder"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-08-16 21:23" pubdate>
          2023年8月16日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          106k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          887 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">14-builder</h1>
            
            
              <div class="markdown-body">
                
                <h4 id="BaseBuilder"><a href="#BaseBuilder" class="headerlink" title="BaseBuilder"></a>BaseBuilder</h4><p>    构造器的基类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-comment">// 需要配置，类型别名注册，类型处理器注册3个类</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Configuration configuration; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> TypeAliasRegistry typeAliasRegistry;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> TypeHandlerRegistry typeHandlerRegistry; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseBuilder</span><span class="hljs-params">(Configuration configuration)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.typeAliasRegistry = <span class="hljs-built_in">this</span>.configuration.getTypeAliasRegistry();<br>    <span class="hljs-built_in">this</span>.typeHandlerRegistry = <span class="hljs-built_in">this</span>.configuration.getTypeHandlerRegistry();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Configuration <span class="hljs-title function_">getConfiguration</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> configuration;<br>  &#125; <br><br>  <span class="hljs-comment">// 下面的方法都支持默认值</span><br>  <span class="hljs-keyword">protected</span> Pattern <span class="hljs-title function_">parseExpression</span><span class="hljs-params">(String regex, String defaultValue)</span> &#123;<br>    <span class="hljs-keyword">return</span> Pattern.compile(regex == <span class="hljs-literal">null</span> ? defaultValue : regex);<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> Boolean <span class="hljs-title function_">booleanValueOf</span><span class="hljs-params">(String value, Boolean defaultValue)</span> &#123;<br>    <span class="hljs-keyword">return</span> value == <span class="hljs-literal">null</span> ? defaultValue : Boolean.valueOf(value);<br>  &#125;<br><br>  <span class="hljs-keyword">protected</span> Integer <span class="hljs-title function_">integerValueOf</span><span class="hljs-params">(String value, Integer defaultValue)</span> &#123;<br>    <span class="hljs-keyword">return</span> value == <span class="hljs-literal">null</span> ? defaultValue : Integer.valueOf(value);<br>  &#125; <br><br>  <span class="hljs-comment">// 把以逗号分割的一个字符串重新包装，返回一个Set</span><br>  <span class="hljs-keyword">protected</span> Set&lt;String&gt; <span class="hljs-title function_">stringSetValueOf</span><span class="hljs-params">(String value, String defaultValue)</span> &#123;<br>    value = (value == <span class="hljs-literal">null</span> ? defaultValue : value);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;(Arrays.asList(value.split(<span class="hljs-string">&quot;,&quot;</span>)));<br>  &#125; <br><br>  <span class="hljs-comment">// 解析JdbcType</span><br>  <span class="hljs-keyword">protected</span> JdbcType <span class="hljs-title function_">resolveJdbcType</span><span class="hljs-params">(String alias)</span> &#123;<br>    <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> JdbcType.valueOf(alias);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error resolving JdbcType. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 解析ResultSetType</span><br>  <span class="hljs-keyword">protected</span> ResultSetType <span class="hljs-title function_">resolveResultSetType</span><span class="hljs-params">(String alias)</span> &#123;<br>    <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> ResultSetType.valueOf(alias);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error resolving ResultSetType. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 解析ParameterMode(SP的IN/OUT/INOUT)</span><br>  <span class="hljs-keyword">protected</span> ParameterMode <span class="hljs-title function_">resolveParameterMode</span><span class="hljs-params">(String alias)</span> &#123;<br>    <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> ParameterMode.valueOf(alias);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error resolving ParameterMode. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 根据别名解析Class，然后创建实例</span><br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createInstance</span><span class="hljs-params">(String alias)</span> &#123;<br>    Class&lt;?&gt; clazz = resolveClass(alias);<br>    <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> resolveClass(alias).newInstance();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error creating instance. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 根据别名解析Class,其实是去查看 类型别名注册/事务管理器别名</span><br>  <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(String alias) &#123;<br>    <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> resolveAlias(alias);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error resolving class. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveAlias(String alias) &#123;<br>    <span class="hljs-keyword">return</span> typeAliasRegistry.resolveAlias(alias);<br>  &#125; <br><br>  <span class="hljs-comment">// 解析类型处理器</span><br>  <span class="hljs-keyword">protected</span> TypeHandler&lt;?&gt; resolveTypeHandler(Class&lt;?&gt; javaType, String typeHandlerAlias) &#123;<br>    <span class="hljs-keyword">if</span> (typeHandlerAlias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 先取得别名所属的Class</span><br>    Class&lt;?&gt; type = resolveClass(typeHandlerAlias);<br>    <span class="hljs-comment">// 如果不是TypeHandler的子类,报错</span><br>    <span class="hljs-keyword">if</span> (type != <span class="hljs-literal">null</span> &amp;&amp; !TypeHandler.class.isAssignableFrom(type)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Type &quot;</span> + type.getName() + <span class="hljs-string">&quot; is not a valid TypeHandler because it does not implement TypeHandler interface&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@SuppressWarnings( &quot;unchecked&quot; )</span> <span class="hljs-comment">// already verified it is a TypeHandler</span><br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerType = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt;) type;<br>    <span class="hljs-comment">// 再去调用另一个重载的方法</span><br>    <span class="hljs-keyword">return</span> resolveTypeHandler(javaType, typeHandlerType);<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> TypeHandler&lt;?&gt; resolveTypeHandler(Class&lt;?&gt; javaType, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerType) &#123;<br>    <span class="hljs-keyword">if</span> (typeHandlerType == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// javaType ignored for injected handlers see issue #746 for full detail</span><br>    <span class="hljs-comment">// 去typeHandlerRegistry查询对应的TypeHandler</span><br>    TypeHandler&lt;?&gt; handler = typeHandlerRegistry.getMappingTypeHandler(typeHandlerType);<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// not in registry, create a new one</span><br>      <span class="hljs-comment">// 如果没有在Registry找到，调用typeHandlerRegistry.getInstance来new一个TypeHandler返回</span><br>      handler = typeHandlerRegistry.getInstance(javaType, typeHandlerType);<br>    &#125;<br>    <span class="hljs-keyword">return</span> handler;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ParameterExpression"><a href="#ParameterExpression" class="headerlink" title="ParameterExpression"></a>ParameterExpression</h4><p>    参数表达式,继承自HashMap，可以参考ParameterExpressionTest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterExpression</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt; &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2417552199605158680L</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ParameterExpression</span><span class="hljs-params">(String expression)</span> &#123;<br>    parse(expression);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-comment">// #&#123;property,javaType=int,jdbcType=NUMERIC&#125;</span><br>    <span class="hljs-comment">// 首先去除空白,返回的p是第一个不是空白的字符位置</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> skipWS(expression, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (expression.charAt(p) == <span class="hljs-string">&#x27;(&#x27;</span>) &#123;<br>      <span class="hljs-comment">// 处理表达式</span><br>      expression(expression, p + <span class="hljs-number">1</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 处理属性</span><br>      property(expression, p);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">skipWS</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> p)</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> p; i &lt; expression.length(); i++) &#123;<br>      <span class="hljs-keyword">if</span> (expression.charAt(i) &gt; <span class="hljs-number">0x20</span>) &#123;<br>        <span class="hljs-keyword">return</span> i;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> expression.length();<br>  &#125; <br><br>  <span class="hljs-comment">// 表达式可能是3.2的新功能，可以先不管</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">expression</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> left)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> left + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">while</span> (match &gt; <span class="hljs-number">0</span>) &#123; <br>      <span class="hljs-comment">// 这里主要是为了支持类似 ((xxx)) 有多个圆括号的表达式</span><br>      <span class="hljs-keyword">if</span> (expression.charAt(right) == <span class="hljs-string">&#x27;)&#x27;</span>) &#123;<br>        match--;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (expression.charAt(right) == <span class="hljs-string">&#x27;(&#x27;</span>) &#123;<br>        match++;<br>      &#125;<br>      right++;<br>    &#125;<br>    put(<span class="hljs-string">&quot;expression&quot;</span>, expression.substring(left, right - <span class="hljs-number">1</span>));<br>    jdbcTypeOpt(expression, right);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jdbcTypeOpt</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> p)</span> &#123;<br>    <span class="hljs-comment">// #&#123;property,javaType=int,jdbcType=NUMERIC&#125;</span><br>    <span class="hljs-comment">// property:VARCHAR</span><br>    <span class="hljs-comment">// 首先去除空白,返回的p是第一个不是空白的字符位置</span><br>    p = skipWS(expression, p);<br>    <span class="hljs-keyword">if</span> (p &lt; expression.length()) &#123;<br>      <span class="hljs-comment">// 第一个property解析完有两种情况，逗号和冒号</span><br>      <span class="hljs-keyword">if</span> (expression.charAt(p) == <span class="hljs-string">&#x27;:&#x27;</span>) &#123;<br>        jdbcType(expression, p + <span class="hljs-number">1</span>);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (expression.charAt(p) == <span class="hljs-string">&#x27;,&#x27;</span>) &#123;<br>        option(expression, p + <span class="hljs-number">1</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Parsing error in &#123;&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(expression) + <span class="hljs-string">&quot;&#125; in position &quot;</span> + p);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jdbcType</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> p)</span> &#123;<br>    <span class="hljs-comment">// property:VARCHAR</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> skipWS(expression, p);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> skipUntil(expression, left, <span class="hljs-string">&quot;,&quot;</span>);<br>    <span class="hljs-keyword">if</span> (right &gt; left) &#123;<br>      put(<span class="hljs-string">&quot;jdbcType&quot;</span>, trimmedStr(expression, left, right));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Parsing error in &#123;&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(expression) + <span class="hljs-string">&quot;&#125; in position &quot;</span> + p);<br>    &#125;<br>    option(expression, right + <span class="hljs-number">1</span>);<br>  &#125; <br><br>  <span class="hljs-comment">// 从expression的p处开始找，直到找到一个包含在endChars中的字符，</span><br>  <span class="hljs-comment">// 返回endChars的起始位置</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">skipUntil</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> p, <span class="hljs-keyword">final</span> String endChars)</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> p; i &lt; expression.length(); i++) &#123;<br>      <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> expression.charAt(i);<br>      <span class="hljs-keyword">if</span> (endChars.indexOf(c) &gt; -<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> i;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> expression.length();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">trimmedStr</span><span class="hljs-params">(String str, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> &#123;<br>    <span class="hljs-keyword">while</span> (str.charAt(start) &lt;= <span class="hljs-number">0x20</span>) &#123;<br>      start++;<br>    &#125;<br>    <span class="hljs-keyword">while</span> (str.charAt(end - <span class="hljs-number">1</span>) &lt;= <span class="hljs-number">0x20</span>) &#123;<br>      end--;<br>    &#125;<br>    <span class="hljs-keyword">return</span> start &gt;= end ? <span class="hljs-string">&quot;&quot;</span> : str.substring(start, end);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">option</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> p)</span> &#123;<br>    <span class="hljs-comment">// #&#123;property,javaType=int,jdbcType=NUMERIC&#125;</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> skipWS(expression, p);<br>    <span class="hljs-keyword">if</span> (left &lt; expression.length()) &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> skipUntil(expression, left, <span class="hljs-string">&quot;=&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> trimmedStr(expression, left, right);<br>      left = right + <span class="hljs-number">1</span>;<br>      right = skipUntil(expression, left, <span class="hljs-string">&quot;,&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> trimmedStr(expression, left, right);<br>      put(name, value);<br>      <span class="hljs-comment">// 递归调用option，进行逗号后面一个属性的解析</span><br>      option(expression, right + <span class="hljs-number">1</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 处理属性和处理表达式类似</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">property</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> left)</span> &#123;<br>    <span class="hljs-comment">// #&#123;property,javaType=int,jdbcType=NUMERIC&#125;</span><br>    <span class="hljs-comment">// property:VARCHAR</span><br>    <span class="hljs-keyword">if</span> (left &lt; expression.length()) &#123;<br>      <span class="hljs-comment">// 首先，得到逗号或者冒号之前的字符串，加入到property</span><br>      <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> skipUntil(expression, left, <span class="hljs-string">&quot;,:&quot;</span>);<br>      put(<span class="hljs-string">&quot;property&quot;</span>, trimmedStr(expression, left, right));<br>      <span class="hljs-comment">// 第二，处理javaType，jdbcType</span><br>      jdbcTypeOpt(expression, right);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="StaticSqlSource"><a href="#StaticSqlSource" class="headerlink" title="StaticSqlSource"></a>StaticSqlSource</h4><p>    没啥好说的，感兴趣的自己看下吧</p>
<h4 id="MapperBuilderAssistant"><a href="#MapperBuilderAssistant" class="headerlink" title="MapperBuilderAssistant"></a>MapperBuilderAssistant</h4><p>      映射构建器助手，建造者模式,继承BaseBuilder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperBuilderAssistant</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-comment">// 每个助手都有1个namespace,resource,cache</span><br>  <span class="hljs-keyword">private</span> String currentNamespace;<br>  <span class="hljs-keyword">private</span> String resource;<br>  <span class="hljs-keyword">private</span> Cache currentCache;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> unresolvedCacheRef; <span class="hljs-comment">// issue #676 </span><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperBuilderAssistant</span><span class="hljs-params">(Configuration configuration, String resource)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration);<br>    ErrorContext.instance().resource(resource);<br>    <span class="hljs-built_in">this</span>.resource = resource;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCurrentNamespace</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> currentNamespace;<br>  &#125; <br><br>  <span class="hljs-comment">// currentNamespace 只能赋值一次</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCurrentNamespace</span><span class="hljs-params">(String currentNamespace)</span> &#123;<br>    <span class="hljs-keyword">if</span> (currentNamespace == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;The mapper element requires a namespace attribute to be specified.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.currentNamespace != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.currentNamespace.equals(currentNamespace)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Wrong namespace. Expected &#x27;&quot;</span><br>          + <span class="hljs-built_in">this</span>.currentNamespace + <span class="hljs-string">&quot;&#x27; but found &#x27;&quot;</span> + currentNamespace + <span class="hljs-string">&quot;&#x27;.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.currentNamespace = currentNamespace;<br>  &#125; <br><br>  <span class="hljs-comment">// 为id加上namespace前缀，如selectPerson--&gt;org.a.b.selectPerson</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">applyCurrentNamespace</span><span class="hljs-params">(String base, <span class="hljs-type">boolean</span> isReference)</span> &#123;<br>    <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (isReference) &#123;<br>      <span class="hljs-comment">// is it qualified with any namespace yet?</span><br>      <span class="hljs-keyword">if</span> (base.contains(<span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> base;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// is it qualified with this namespace yet?</span><br>      <span class="hljs-keyword">if</span> (base.startsWith(currentNamespace + <span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> base;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (base.contains(<span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Dots are not allowed in element names, please remove it from &quot;</span> + base);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> currentNamespace + <span class="hljs-string">&quot;.&quot;</span> + base;<br>  &#125; <br><br>  <span class="hljs-comment">// 设置缓存</span><br>  <span class="hljs-keyword">public</span> Cache <span class="hljs-title function_">useCacheRef</span><span class="hljs-params">(String namespace)</span> &#123;<br>    <span class="hljs-keyword">if</span> (namespace == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;cache-ref element requires a namespace attribute.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      unresolvedCacheRef = <span class="hljs-literal">true</span>;<br>      <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> configuration.getCache(namespace);<br>      <span class="hljs-keyword">if</span> (cache == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;No cache for namespace &#x27;&quot;</span> + namespace + <span class="hljs-string">&quot;&#x27; could be found.&quot;</span>);<br>      &#125;<br>      currentCache = cache;<br>      unresolvedCacheRef = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">return</span> cache;<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;No cache for namespace &#x27;&quot;</span> + namespace + <span class="hljs-string">&quot;&#x27; could be found.&quot;</span>, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 通过传入的参数构建并设置缓存</span><br>  <span class="hljs-keyword">public</span> Cache <span class="hljs-title function_">useNewCache</span><span class="hljs-params">(Class&lt;? extends Cache&gt; typeClass,</span><br><span class="hljs-params">      Class&lt;? extends Cache&gt; evictionClass,</span><br><span class="hljs-params">      Long flushInterval,</span><br><span class="hljs-params">      Integer size,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> readWrite,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> blocking,</span><br><span class="hljs-params">      Properties props)</span> &#123;<br>    <span class="hljs-comment">// 这里面又判断了一下是否为null就用默认值，有点和XMLMapperBuilder.cacheElement逻辑重复了</span><br>    typeClass = valueOrDefault(typeClass, PerpetualCache.class);<br>    evictionClass = valueOrDefault(evictionClass, LruCache.class);<br>    <span class="hljs-comment">// 调用CacheBuilder构建cache,id=currentNamespace</span><br>    <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheBuilder</span>(currentNamespace)<br>        .implementation(typeClass)<br>        .addDecorator(evictionClass)<br>        .clearInterval(flushInterval)<br>        .size(size)<br>        .readWrite(readWrite)<br>        .blocking(blocking)<br>        .properties(props)<br>        .build();<br>    <span class="hljs-comment">// 加入缓存</span><br>    configuration.addCache(cache);<br>    <span class="hljs-comment">// 当前的缓存</span><br>    currentCache = cache;<br>    <span class="hljs-keyword">return</span> cache;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">valueOrDefault</span><span class="hljs-params">(T value, T defaultValue)</span> &#123;<br>    <span class="hljs-keyword">return</span> value == <span class="hljs-literal">null</span> ? defaultValue : value;<br>  &#125; <br><br>  <span class="hljs-comment">// 往configuration 中添加 ParameterMap </span><br>  <span class="hljs-keyword">public</span> ParameterMap <span class="hljs-title function_">addParameterMap</span><span class="hljs-params">(String id, Class&lt;?&gt; parameterClass, List&lt;ParameterMapping&gt; parameterMappings)</span> &#123;<br>    id = applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>    ParameterMap.<span class="hljs-type">Builder</span> <span class="hljs-variable">parameterMapBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMap</span>.Builder(configuration, id, parameterClass, parameterMappings);<br>    <span class="hljs-type">ParameterMap</span> <span class="hljs-variable">parameterMap</span> <span class="hljs-operator">=</span> parameterMapBuilder.build();<br>    configuration.addParameterMap(parameterMap);<br>    <span class="hljs-keyword">return</span> parameterMap;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ParameterMapping <span class="hljs-title function_">buildParameterMapping</span><span class="hljs-params">(</span><br><span class="hljs-params">      Class&lt;?&gt; parameterType,</span><br><span class="hljs-params">      String property,</span><br><span class="hljs-params">      Class&lt;?&gt; javaType,</span><br><span class="hljs-params">      JdbcType jdbcType,</span><br><span class="hljs-params">      String resultMap,</span><br><span class="hljs-params">      ParameterMode parameterMode,</span><br><span class="hljs-params">      Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span><br><span class="hljs-params">      Integer numericScale)</span> &#123;<br>    resultMap = applyCurrentNamespace(resultMap, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">// Class parameterType = parameterMapBuilder.type();</span><br>    Class&lt;?&gt; javaTypeClass = resolveParameterJavaType(parameterType, property, javaType, jdbcType);<br>    TypeHandler&lt;?&gt; typeHandlerInstance = resolveTypeHandler(javaTypeClass, typeHandler);<br><br>    ParameterMapping.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMapping</span>.Builder(configuration, property, javaTypeClass);<br>    builder.jdbcType(jdbcType);<br>    builder.resultMapId(resultMap);<br>    builder.mode(parameterMode);<br>    builder.numericScale(numericScale);<br>    builder.typeHandler(typeHandlerInstance);<br>    <span class="hljs-keyword">return</span> builder.build();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; resolveParameterJavaType(Class&lt;?&gt; resultType, String property, Class&lt;?&gt; javaType, JdbcType jdbcType) &#123;<br>    <span class="hljs-keyword">if</span> (javaType == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (JdbcType.CURSOR.equals(jdbcType)) &#123;<br>        javaType = java.sql.ResultSet.class;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Map.class.isAssignableFrom(resultType)) &#123;<br>        javaType = Object.class;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaResultType</span> <span class="hljs-operator">=</span> MetaClass.forClass(resultType);<br>        javaType = metaResultType.getGetterType(property);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (javaType == <span class="hljs-literal">null</span>) &#123;<br>      javaType = Object.class;<br>    &#125;<br>    <span class="hljs-keyword">return</span> javaType;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> TypeHandler&lt;?&gt; resolveTypeHandler(Class&lt;?&gt; javaType, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerType) &#123;<br>    <span class="hljs-keyword">if</span> (typeHandlerType == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// javaType ignored for injected handlers see issue #746 for full detail</span><br>    <span class="hljs-comment">// 去typeHandlerRegistry查询对应的TypeHandler</span><br>    TypeHandler&lt;?&gt; handler = typeHandlerRegistry.getMappingTypeHandler(typeHandlerType);<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// not in registry, create a new one</span><br>      <span class="hljs-comment">// 如果没有在Registry找到，调用typeHandlerRegistry.getInstance来new一个TypeHandler返回</span><br>      handler = typeHandlerRegistry.getInstance(javaType, typeHandlerType);<br>    &#125;<br>    <span class="hljs-keyword">return</span> handler;<br>  &#125; <br><br>  <span class="hljs-comment">// 增加ResultMap</span><br>  <span class="hljs-keyword">public</span> ResultMap <span class="hljs-title function_">addResultMap</span><span class="hljs-params">(</span><br><span class="hljs-params">      String id,</span><br><span class="hljs-params">      Class&lt;?&gt; type,</span><br><span class="hljs-params">      String extend,</span><br><span class="hljs-params">      Discriminator discriminator,</span><br><span class="hljs-params">      List&lt;ResultMapping&gt; resultMappings,</span><br><span class="hljs-params">      Boolean autoMapping)</span> &#123;<br>    id = applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>    extend = applyCurrentNamespace(extend, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">// 建造者模式</span><br>    ResultMap.<span class="hljs-type">Builder</span> <span class="hljs-variable">resultMapBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMap</span>.Builder(configuration, id, type, resultMappings, autoMapping);<br>    <span class="hljs-keyword">if</span> (extend != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!configuration.hasResultMap(extend)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Could not find a parent resultmap with id &#x27;&quot;</span> + extend + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>      &#125;<br>      <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(extend);<br>      List&lt;ResultMapping&gt; extendedResultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;(resultMap.getResultMappings());<br>      extendedResultMappings.removeAll(resultMappings);<br>      <span class="hljs-comment">// Remove parent constructor if this resultMap declares a constructor.</span><br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">declaresConstructor</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">for</span> (ResultMapping resultMapping : resultMappings) &#123;<br>        <span class="hljs-keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;<br>          declaresConstructor = <span class="hljs-literal">true</span>;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (declaresConstructor) &#123;<br>        Iterator&lt;ResultMapping&gt; extendedResultMappingsIter = extendedResultMappings.iterator();<br>        <span class="hljs-keyword">while</span> (extendedResultMappingsIter.hasNext()) &#123;<br>          <span class="hljs-keyword">if</span> (extendedResultMappingsIter.next().getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;<br>            extendedResultMappingsIter.remove();<br>          &#125;<br>        &#125;<br>      &#125;<br>      resultMappings.addAll(extendedResultMappings);<br>    &#125;<br>    resultMapBuilder.discriminator(discriminator);<br>    <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> resultMapBuilder.build();<br>    configuration.addResultMap(resultMap);<br>    <span class="hljs-keyword">return</span> resultMap;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Discriminator <span class="hljs-title function_">buildDiscriminator</span><span class="hljs-params">(</span><br><span class="hljs-params">      Class&lt;?&gt; resultType,</span><br><span class="hljs-params">      String column,</span><br><span class="hljs-params">      Class&lt;?&gt; javaType,</span><br><span class="hljs-params">      JdbcType jdbcType,</span><br><span class="hljs-params">      Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span><br><span class="hljs-params">      Map&lt;String, String&gt; discriminatorMap)</span> &#123;<br>    <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">resultMapping</span> <span class="hljs-operator">=</span> buildResultMapping(<br>        resultType,<br>        <span class="hljs-literal">null</span>,<br>        column,<br>        javaType,<br>        jdbcType,<br>        <span class="hljs-literal">null</span>,<br>        <span class="hljs-literal">null</span>,<br>        <span class="hljs-literal">null</span>,<br>        <span class="hljs-literal">null</span>,<br>        typeHandler,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;(),<br>        <span class="hljs-literal">null</span>,<br>        <span class="hljs-literal">null</span>,<br>        <span class="hljs-literal">false</span>);<br>    Map&lt;String, String&gt; namespaceDiscriminatorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; e : discriminatorMap.entrySet()) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> e.getValue();<br>      resultMap = applyCurrentNamespace(resultMap, <span class="hljs-literal">true</span>);<br>      namespaceDiscriminatorMap.put(e.getKey(), resultMap);<br>    &#125;<br>    Discriminator.<span class="hljs-type">Builder</span> <span class="hljs-variable">discriminatorBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Discriminator</span>.Builder(configuration, resultMapping, namespaceDiscriminatorMap);<br>    <span class="hljs-keyword">return</span> discriminatorBuilder.build();<br>  &#125; <br><br>  <span class="hljs-comment">// 增加映射语句</span><br>  <span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title function_">addMappedStatement</span><span class="hljs-params">(</span><br><span class="hljs-params">      String id,</span><br><span class="hljs-params">      SqlSource sqlSource,</span><br><span class="hljs-params">      StatementType statementType,</span><br><span class="hljs-params">      SqlCommandType sqlCommandType,</span><br><span class="hljs-params">      Integer fetchSize,</span><br><span class="hljs-params">      Integer timeout,</span><br><span class="hljs-params">      String parameterMap,</span><br><span class="hljs-params">      Class&lt;?&gt; parameterType,</span><br><span class="hljs-params">      String resultMap,</span><br><span class="hljs-params">      Class&lt;?&gt; resultType,</span><br><span class="hljs-params">      ResultSetType resultSetType,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> flushCache,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> useCache,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> resultOrdered,</span><br><span class="hljs-params">      KeyGenerator keyGenerator,</span><br><span class="hljs-params">      String keyProperty,</span><br><span class="hljs-params">      String keyColumn,</span><br><span class="hljs-params">      String databaseId,</span><br><span class="hljs-params">      LanguageDriver lang,</span><br><span class="hljs-params">      String resultSets)</span> &#123;<br><br>    <span class="hljs-keyword">if</span> (unresolvedCacheRef) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Cache-ref not yet resolved&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 为id加上namespace前缀</span><br>    id = applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">// 是否是select语句</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSelect</span> <span class="hljs-operator">=</span> sqlCommandType == SqlCommandType.SELECT;<br><br>    <span class="hljs-comment">// 又是建造者模式</span><br>    MappedStatement.<span class="hljs-type">Builder</span> <span class="hljs-variable">statementBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MappedStatement</span>.Builder(configuration, id, sqlSource, sqlCommandType);<br>    statementBuilder.resource(resource);<br>    statementBuilder.fetchSize(fetchSize);<br>    statementBuilder.statementType(statementType);<br>    statementBuilder.keyGenerator(keyGenerator);<br>    statementBuilder.keyProperty(keyProperty);<br>    statementBuilder.keyColumn(keyColumn);<br>    statementBuilder.databaseId(databaseId);<br>    statementBuilder.lang(lang);<br>    statementBuilder.resultOrdered(resultOrdered);<br>    statementBuilder.resulSets(resultSets);<br>    setStatementTimeout(timeout, statementBuilder);<br><br>    <span class="hljs-comment">// 1.参数映射</span><br>    setStatementParameterMap(parameterMap, parameterType, statementBuilder);<br>    <span class="hljs-comment">// 2.结果映射</span><br>    setStatementResultMap(resultMap, resultType, resultSetType, statementBuilder);<br>    setStatementCache(isSelect, flushCache, useCache, currentCache, statementBuilder);<br><br>    <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> statementBuilder.build();<br>    <span class="hljs-comment">// 建造好调用configuration.addMappedStatement</span><br>    configuration.addMappedStatement(statement);<br>    <span class="hljs-keyword">return</span> statement;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatementTimeout</span><span class="hljs-params">(Integer timeout, MappedStatement.Builder statementBuilder)</span> &#123;<br>    <span class="hljs-keyword">if</span> (timeout == <span class="hljs-literal">null</span>) &#123;<br>      timeout = configuration.getDefaultStatementTimeout();<br>    &#125;<br>    statementBuilder.timeout(timeout);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatementParameterMap</span><span class="hljs-params">(</span><br><span class="hljs-params">      String parameterMap,</span><br><span class="hljs-params">      Class&lt;?&gt; parameterTypeClass,</span><br><span class="hljs-params">      MappedStatement.Builder statementBuilder)</span> &#123;<br>    parameterMap = applyCurrentNamespace(parameterMap, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-keyword">if</span> (parameterMap != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        statementBuilder.parameterMap(configuration.getParameterMap(parameterMap));<br>      &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Could not find parameter map &quot;</span> + parameterMap, e);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterTypeClass != <span class="hljs-literal">null</span>) &#123;<br>      List&lt;ParameterMapping&gt; parameterMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ParameterMapping&gt;();<br>      ParameterMap.<span class="hljs-type">Builder</span> <span class="hljs-variable">inlineParameterMapBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMap</span>.Builder(<br>          configuration,<br>          statementBuilder.id() + <span class="hljs-string">&quot;-Inline&quot;</span>,<br>          parameterTypeClass,<br>          parameterMappings);<br>      statementBuilder.parameterMap(inlineParameterMapBuilder.build());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 2.result map</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatementResultMap</span><span class="hljs-params">(</span><br><span class="hljs-params">      String resultMap,</span><br><span class="hljs-params">      Class&lt;?&gt; resultType,</span><br><span class="hljs-params">      ResultSetType resultSetType,</span><br><span class="hljs-params">      MappedStatement.Builder statementBuilder)</span> &#123;<br>    resultMap = applyCurrentNamespace(resultMap, <span class="hljs-literal">true</span>);<br><br>    List&lt;ResultMap&gt; resultMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMap&gt;();<br>    <span class="hljs-keyword">if</span> (resultMap != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 2.1 resultMap是高级功能</span><br>      String[] resultMapNames = resultMap.split(<span class="hljs-string">&quot;,&quot;</span>);<br>      <span class="hljs-keyword">for</span> (String resultMapName : resultMapNames) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          resultMaps.add(configuration.getResultMap(resultMapName.trim()));<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Could not find result map &quot;</span> + resultMapName, e);<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resultType != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 2.2 resultType,一般用这个足矣了</span><br>      <span class="hljs-comment">// &lt;select id=&quot;selectUsers&quot; resultType=&quot;User&quot;&gt;</span><br>      <span class="hljs-comment">// 这种情况下,MyBatis 会在幕后自动创建一个 ResultMap,基于属性名来映射列到 JavaBean 的属性上。</span><br>      <span class="hljs-comment">// 如果列名没有精确匹配,你可以在列名上使用 select 字句的别名来匹配标签。</span><br>      <span class="hljs-comment">// 创建一个inline result map, 把resultType设上就OK了，</span><br>      <span class="hljs-comment">// 然后后面被DefaultResultSetHandler.createResultObject()使用</span><br>      <span class="hljs-comment">// DefaultResultSetHandler.getRowValue()使用</span><br>      ResultMap.<span class="hljs-type">Builder</span> <span class="hljs-variable">inlineResultMapBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMap</span>.Builder(<br>          configuration,<br>          statementBuilder.id() + <span class="hljs-string">&quot;-Inline&quot;</span>,<br>          resultType,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;(),<br>          <span class="hljs-literal">null</span>);<br>      resultMaps.add(inlineResultMapBuilder.build());<br>    &#125;<br>    statementBuilder.resultMaps(resultMaps);<br><br>    statementBuilder.resultSetType(resultSetType);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatementCache</span><span class="hljs-params">(</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> isSelect,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> flushCache,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> useCache,</span><br><span class="hljs-params">      Cache cache,</span><br><span class="hljs-params">      MappedStatement.Builder statementBuilder)</span> &#123;<br>    flushCache = valueOrDefault(flushCache, !isSelect);<br>    useCache = valueOrDefault(useCache, isSelect);<br>    statementBuilder.flushCacheRequired(flushCache);<br>    statementBuilder.useCache(useCache);<br>    statementBuilder.cache(cache);<br>  &#125; <br><br>  <span class="hljs-comment">// 构建result mapping</span><br>  <span class="hljs-keyword">public</span> ResultMapping <span class="hljs-title function_">buildResultMapping</span><span class="hljs-params">(</span><br><span class="hljs-params">      Class&lt;?&gt; resultType,</span><br><span class="hljs-params">      String property,</span><br><span class="hljs-params">      String column,</span><br><span class="hljs-params">      Class&lt;?&gt; javaType,</span><br><span class="hljs-params">      JdbcType jdbcType,</span><br><span class="hljs-params">      String nestedSelect,</span><br><span class="hljs-params">      String nestedResultMap,</span><br><span class="hljs-params">      String notNullColumn,</span><br><span class="hljs-params">      String columnPrefix,</span><br><span class="hljs-params">      Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span><br><span class="hljs-params">      List&lt;ResultFlag&gt; flags,</span><br><span class="hljs-params">      String resultSet,</span><br><span class="hljs-params">      String foreignColumn, </span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> lazy)</span> &#123;<br>    Class&lt;?&gt; javaTypeClass = resolveResultJavaType(resultType, property, javaType);<br>    TypeHandler&lt;?&gt; typeHandlerInstance = resolveTypeHandler(javaTypeClass, typeHandler);<br>    <span class="hljs-comment">// 解析复合的列名,一般用不到，返回的是空</span><br>    List&lt;ResultMapping&gt; composites = parseCompositeColumnName(column);<br>    <span class="hljs-keyword">if</span> (composites.size() &gt; <span class="hljs-number">0</span>) &#123;<br>      column = <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 构建result mapping</span><br>    ResultMapping.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMapping</span>.Builder(configuration, property, column, javaTypeClass);<br>    builder.jdbcType(jdbcType);<br>    builder.nestedQueryId(applyCurrentNamespace(nestedSelect, <span class="hljs-literal">true</span>));<br>    builder.nestedResultMapId(applyCurrentNamespace(nestedResultMap, <span class="hljs-literal">true</span>));<br>    builder.resultSet(resultSet);<br>    builder.typeHandler(typeHandlerInstance);<br>    builder.flags(flags == <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;() : flags);<br>    builder.composites(composites);<br>    builder.notNullColumns(parseMultipleColumnNames(notNullColumn));<br>    builder.columnPrefix(columnPrefix);<br>    builder.foreignColumn(foreignColumn);<br>    builder.lazy(lazy);<br>    <span class="hljs-keyword">return</span> builder.build();<br>  &#125; <br><br>  <span class="hljs-comment">// 解析复合列名，即列名由多个组成，可以先忽略</span><br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; <span class="hljs-title function_">parseCompositeColumnName</span><span class="hljs-params">(String columnName)</span> &#123;<br>    List&lt;ResultMapping&gt; composites = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>    <span class="hljs-keyword">if</span> (columnName != <span class="hljs-literal">null</span> &amp;&amp; (columnName.indexOf(<span class="hljs-string">&#x27;=&#x27;</span>) &gt; -<span class="hljs-number">1</span> || columnName.indexOf(<span class="hljs-string">&#x27;,&#x27;</span>) &gt; -<span class="hljs-number">1</span>)) &#123;<br>      <span class="hljs-type">StringTokenizer</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTokenizer</span>(columnName, <span class="hljs-string">&quot;&#123;&#125;=, &quot;</span>, <span class="hljs-literal">false</span>);<br>      <span class="hljs-keyword">while</span> (parser.hasMoreTokens()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> parser.nextToken();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> parser.nextToken();<br>        ResultMapping.<span class="hljs-type">Builder</span> <span class="hljs-variable">complexBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMapping</span>.Builder(configuration, property, column, configuration.getTypeHandlerRegistry().getUnknownTypeHandler());<br>        composites.add(complexBuilder.build());<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> composites;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">parseMultipleColumnNames</span><span class="hljs-params">(String columnName)</span> &#123;<br>    Set&lt;String&gt; columns = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();<br>    <span class="hljs-keyword">if</span> (columnName != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (columnName.indexOf(<span class="hljs-string">&#x27;,&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-type">StringTokenizer</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTokenizer</span>(columnName, <span class="hljs-string">&quot;&#123;&#125;, &quot;</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">while</span> (parser.hasMoreTokens()) &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> parser.nextToken();<br>          columns.add(column);<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        columns.add(columnName);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> columns;<br>  &#125; <br><br>  <span class="hljs-comment">/** Backward compatibility signature */</span><br>  <span class="hljs-comment">// 向后兼容方法</span><br>  <span class="hljs-keyword">public</span> ResultMapping <span class="hljs-title function_">buildResultMapping</span><span class="hljs-params">(</span><br><span class="hljs-params">      Class&lt;?&gt; resultType,</span><br><span class="hljs-params">      String property,</span><br><span class="hljs-params">      String column,</span><br><span class="hljs-params">      Class&lt;?&gt; javaType,</span><br><span class="hljs-params">      JdbcType jdbcType,</span><br><span class="hljs-params">      String nestedSelect,</span><br><span class="hljs-params">      String nestedResultMap,</span><br><span class="hljs-params">      String notNullColumn,</span><br><span class="hljs-params">      String columnPrefix,</span><br><span class="hljs-params">      Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span><br><span class="hljs-params">      List&lt;ResultFlag&gt; flags)</span> &#123;<br>      <span class="hljs-keyword">return</span> buildResultMapping(<br>        resultType, property, column, javaType, jdbcType, nestedSelect, <br>        nestedResultMap, notNullColumn, columnPrefix, typeHandler, flags, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, configuration.isLazyLoadingEnabled());<br>  &#125;   <br><br>  <span class="hljs-comment">// 取得语言驱动</span><br>  <span class="hljs-keyword">public</span> LanguageDriver <span class="hljs-title function_">getLanguageDriver</span><span class="hljs-params">(Class&lt;?&gt; langClass)</span> &#123;<br>    <span class="hljs-keyword">if</span> (langClass != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 注册语言驱动</span><br>      configuration.getLanguageRegistry().register(langClass);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 如果为null，则取得默认驱动（mybatis3.2以前大家一直用的方法）</span><br>      langClass = configuration.getLanguageRegistry().getDefaultDriverClass();<br>    &#125;<br>    <span class="hljs-comment">// 再去调configuration</span><br>    <span class="hljs-keyword">return</span> configuration.getLanguageRegistry().getDriver(langClass);<br>  &#125; <br><br>  <span class="hljs-comment">/** Backward compatibility signature */</span><br>  <span class="hljs-comment">// 向后兼容方法</span><br>  <span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title function_">addMappedStatement</span><span class="hljs-params">(</span><br><span class="hljs-params">    String id,</span><br><span class="hljs-params">    SqlSource sqlSource,</span><br><span class="hljs-params">    StatementType statementType,</span><br><span class="hljs-params">    SqlCommandType sqlCommandType,</span><br><span class="hljs-params">    Integer fetchSize,</span><br><span class="hljs-params">    Integer timeout,</span><br><span class="hljs-params">    String parameterMap,</span><br><span class="hljs-params">    Class&lt;?&gt; parameterType,</span><br><span class="hljs-params">    String resultMap,</span><br><span class="hljs-params">    Class&lt;?&gt; resultType,</span><br><span class="hljs-params">    ResultSetType resultSetType,</span><br><span class="hljs-params">    <span class="hljs-type">boolean</span> flushCache,</span><br><span class="hljs-params">    <span class="hljs-type">boolean</span> useCache,</span><br><span class="hljs-params">    <span class="hljs-type">boolean</span> resultOrdered,</span><br><span class="hljs-params">    KeyGenerator keyGenerator,</span><br><span class="hljs-params">    String keyProperty,</span><br><span class="hljs-params">    String keyColumn,</span><br><span class="hljs-params">    String databaseId,</span><br><span class="hljs-params">    LanguageDriver lang)</span> &#123;<br>    <span class="hljs-keyword">return</span> addMappedStatement(<br>      id, sqlSource, statementType, sqlCommandType, fetchSize, timeout, <br>      parameterMap, parameterType, resultMap, resultType, resultSetType, <br>      flushCache, useCache, resultOrdered, keyGenerator, keyProperty, <br>      keyColumn, databaseId, lang, <span class="hljs-literal">null</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="CacheRefResolver"><a href="#CacheRefResolver" class="headerlink" title="CacheRefResolver"></a>CacheRefResolver</h4><p>    缓存引用解析器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheRefResolver</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MapperBuilderAssistant assistant;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String cacheRefNamespace;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheRefResolver</span><span class="hljs-params">(MapperBuilderAssistant assistant, String cacheRefNamespace)</span> &#123;<br>    <span class="hljs-built_in">this</span>.assistant = assistant;<br>    <span class="hljs-built_in">this</span>.cacheRefNamespace = cacheRefNamespace;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Cache <span class="hljs-title function_">resolveCacheRef</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 反调MapperBuilderAssistant解析</span><br>    <span class="hljs-keyword">return</span> assistant.useCacheRef(cacheRefNamespace);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ResultMapResolver"><a href="#ResultMapResolver" class="headerlink" title="ResultMapResolver"></a>ResultMapResolver</h4><p>      结果映射解析器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultMapResolver</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MapperBuilderAssistant assistant;<br>  <span class="hljs-keyword">private</span> String id;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>  <span class="hljs-keyword">private</span> String extend;<br>  <span class="hljs-keyword">private</span> Discriminator discriminator;<br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; resultMappings;<br>  <span class="hljs-keyword">private</span> Boolean autoMapping;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResultMapResolver</span><span class="hljs-params">(MapperBuilderAssistant assistant, String id, Class&lt;?&gt; type, String extend, Discriminator discriminator, List&lt;ResultMapping&gt; resultMappings, Boolean autoMapping)</span> &#123;<br>    <span class="hljs-built_in">this</span>.assistant = assistant;<br>    <span class="hljs-built_in">this</span>.id = id;<br>    <span class="hljs-built_in">this</span>.type = type;<br>    <span class="hljs-built_in">this</span>.extend = extend;<br>    <span class="hljs-built_in">this</span>.discriminator = discriminator;<br>    <span class="hljs-built_in">this</span>.resultMappings = resultMappings;<br>    <span class="hljs-built_in">this</span>.autoMapping = autoMapping;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> ResultMap <span class="hljs-title function_">resolve</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 解析又去调用MapperBuilderAssistant.addResultMap</span><br>    <span class="hljs-keyword">return</span> assistant.addResultMap(<span class="hljs-built_in">this</span>.id, <span class="hljs-built_in">this</span>.type, <span class="hljs-built_in">this</span>.extend, <span class="hljs-built_in">this</span>.discriminator, <span class="hljs-built_in">this</span>.resultMappings, <span class="hljs-built_in">this</span>.autoMapping);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="XMLIncludeTransformer"><a href="#XMLIncludeTransformer" class="headerlink" title="XMLIncludeTransformer"></a>XMLIncludeTransformer</h4><p>    XML include 转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLIncludeTransformer</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Configuration configuration;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MapperBuilderAssistant builderAssistant; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLIncludeTransformer</span><span class="hljs-params">(Configuration configuration, MapperBuilderAssistant builderAssistant)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.builderAssistant = builderAssistant;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyIncludes</span><span class="hljs-params">(Node source)</span> &#123;<br>    <span class="hljs-keyword">if</span> (source.getNodeName().equals(<span class="hljs-string">&quot;include&quot;</span>)) &#123;<br>      <span class="hljs-comment">// 走到这里，单独解析&lt;include refid=&quot;userColumns&quot;/&gt;</span><br>      <span class="hljs-comment">// 拿到SQL片段</span><br>      <span class="hljs-type">Node</span> <span class="hljs-variable">toInclude</span> <span class="hljs-operator">=</span> findSqlFragment(getStringAttribute(source, <span class="hljs-string">&quot;refid&quot;</span>));<br>      <span class="hljs-comment">// 递归调用--处理toInclude Node里的 include 标签</span><br>      applyIncludes(toInclude);<br>      <span class="hljs-comment">// 如果要导入的sql片段toInclude Node和source Node不属于同一个Document，</span><br>      <span class="hljs-comment">// 需要将toInclude Node导入到source Node所在的Document中</span><br>      <span class="hljs-keyword">if</span> (toInclude.getOwnerDocument() != source.getOwnerDocument()) &#123;<br>        toInclude = source.getOwnerDocument().importNode(toInclude, <span class="hljs-literal">true</span>);<br>      &#125; <br>      <span class="hljs-comment">// 将source Node替换成toInclude Node</span><br>      source.getParentNode().replaceChild(toInclude, source);<br>      <span class="hljs-comment">// 将toInclude Node的孩子节点放到toInclude Node之前</span><br>      <span class="hljs-comment">// 文本内容也是 childNode</span><br>      <span class="hljs-keyword">while</span> (toInclude.hasChildNodes()) &#123;<br>        toInclude.getParentNode().insertBefore(toInclude.getFirstChild(), toInclude);<br>      &#125; <br>      <span class="hljs-comment">// 删除toInclude Node</span><br>      toInclude.getParentNode().removeChild(toInclude);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source.getNodeType() == Node.ELEMENT_NODE) &#123;<br>      <span class="hljs-comment">// 一开始会走这段，取得所有儿子</span><br>      <span class="hljs-type">NodeList</span> <span class="hljs-variable">children</span> <span class="hljs-operator">=</span> source.getChildNodes();<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;children.getLength(); i++) &#123;<br>        <span class="hljs-comment">// 递归调用自己</span><br>        applyIncludes(children.item(i));<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Node <span class="hljs-title function_">findSqlFragment</span><span class="hljs-params">(String refid)</span> &#123;<br>    refid = PropertyParser.parse(refid, configuration.getVariables());<br>    refid = builderAssistant.applyCurrentNamespace(refid, <span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 去之前存到内存map的SQL片段中寻找</span><br>      <span class="hljs-type">XNode</span> <span class="hljs-variable">nodeToInclude</span> <span class="hljs-operator">=</span> configuration.getSqlFragments().get(refid);<br>      <span class="hljs-comment">// clone一下，以防改写？</span><br>      <span class="hljs-keyword">return</span> nodeToInclude.getNode().cloneNode(<span class="hljs-literal">true</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Could not find SQL statement to include with refid &#x27;&quot;</span> + refid + <span class="hljs-string">&quot;&#x27;&quot;</span>, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getStringAttribute</span><span class="hljs-params">(Node node, String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> node.getAttributes().getNamedItem(name).getNodeValue();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="XMLMapperEntityResolver"><a href="#XMLMapperEntityResolver" class="headerlink" title="XMLMapperEntityResolver"></a>XMLMapperEntityResolver</h4><p>    Offline entity resolver for the MyBatis DTDs  </p>
<p>    目的是未联网的情况下也能做DTD验证，实现原理就是将DTD搞到本地，然后用org.xml.sax.EntityResolver，最后调用DocumentBuilder.setEntityResolver来达到脱机验证  </p>
<p>    EntityResolver  </p>
<p>    public InputSource resolveEntity (String publicId, String systemId)  </p>
<p>    应用程序可以使用此接口将系统标识符重定向到本地 URI  </p>
<p>    但是用DTD是比较过时的做法，新的都改用xsd了  </p>
<p>    这个类的名字并不准确，因为它被两个类都用到（XMLConfigBuilder,XMLMapperBuilder）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLMapperEntityResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EntityResolver</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; doctypeMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br><br>  <span class="hljs-comment">// &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br>  <span class="hljs-comment">// &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br>  <span class="hljs-comment">// 常量定义</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IBATIS_CONFIG_PUBLIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;-//ibatis.apache.org//DTD Config 3.0//EN&quot;</span>.toUpperCase(Locale.ENGLISH);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IBATIS_CONFIG_SYSTEM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://ibatis.apache.org/dtd/ibatis-3-config.dtd&quot;</span>.toUpperCase(Locale.ENGLISH);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IBATIS_MAPPER_PUBLIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;-//ibatis.apache.org//DTD Mapper 3.0//EN&quot;</span>.toUpperCase(Locale.ENGLISH);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IBATIS_MAPPER_SYSTEM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd&quot;</span>.toUpperCase(Locale.ENGLISH);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_CONFIG_PUBLIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>.toUpperCase(Locale.ENGLISH);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_CONFIG_SYSTEM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>.toUpperCase(Locale.ENGLISH);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_MAPPER_PUBLIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>.toUpperCase(Locale.ENGLISH);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_MAPPER_SYSTEM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>.toUpperCase(Locale.ENGLISH);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_CONFIG_DTD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org/apache/ibatis/builder/xml/mybatis-3-config.dtd&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_MAPPER_DTD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org/apache/ibatis/builder/xml/mybatis-3-mapper.dtd&quot;</span>;<br><br>  <span class="hljs-keyword">static</span> &#123;<br>    <span class="hljs-comment">// 将DOCTYPE和URL都映射到本地类路径下的DTD</span><br>    doctypeMap.put(IBATIS_CONFIG_SYSTEM, MYBATIS_CONFIG_DTD);<br>    doctypeMap.put(IBATIS_CONFIG_PUBLIC, MYBATIS_CONFIG_DTD);<br><br>    doctypeMap.put(IBATIS_MAPPER_SYSTEM, MYBATIS_MAPPER_DTD);<br>    doctypeMap.put(IBATIS_MAPPER_PUBLIC, MYBATIS_MAPPER_DTD);<br><br>    doctypeMap.put(MYBATIS_CONFIG_SYSTEM, MYBATIS_CONFIG_DTD);<br>    doctypeMap.put(MYBATIS_CONFIG_PUBLIC, MYBATIS_CONFIG_DTD);<br><br>    doctypeMap.put(MYBATIS_MAPPER_SYSTEM, MYBATIS_MAPPER_DTD);<br>    doctypeMap.put(MYBATIS_MAPPER_PUBLIC, MYBATIS_MAPPER_DTD);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> InputSource <span class="hljs-title function_">resolveEntity</span><span class="hljs-params">(String publicId, String systemId)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br><br>    <span class="hljs-keyword">if</span> (publicId != <span class="hljs-literal">null</span>) &#123;<br>      publicId = publicId.toUpperCase(Locale.ENGLISH);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (systemId != <span class="hljs-literal">null</span>) &#123;<br>      systemId = systemId.toUpperCase(Locale.ENGLISH);<br>    &#125;<br><br>    <span class="hljs-type">InputSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 先找publicId，找不到再找systemId，貌似不可能找不到</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> doctypeMap.get(publicId);<br>      source = getInputSource(path, source);<br>      <span class="hljs-keyword">if</span> (source == <span class="hljs-literal">null</span>) &#123;<br>        path = doctypeMap.get(systemId);<br>        source = getInputSource(path, source);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXException</span>(e.toString());<br>    &#125;<br>    <span class="hljs-keyword">return</span> source;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> InputSource <span class="hljs-title function_">getInputSource</span><span class="hljs-params">(String path, InputSource source)</span> &#123;<br>    <span class="hljs-keyword">if</span> (path != <span class="hljs-literal">null</span>) &#123;<br>      InputStream in;<br>      <span class="hljs-keyword">try</span> &#123;<br>        in = Resources.getResourceAsStream(path);<br>        source = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(in);<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-comment">// ignore, null is ok</span><br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> source;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="XMLConfigBuilder"><a href="#XMLConfigBuilder" class="headerlink" title="XMLConfigBuilder"></a>XMLConfigBuilder</h4><p>    XML 配置构建器，建造者模式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLConfigBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-comment">// 是否已解析，XPath解析器,环境</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> parsed;<br>  <span class="hljs-keyword">private</span> XPathParser parser;<br>  <span class="hljs-keyword">private</span> String environment; <br><br>  <span class="hljs-comment">// 以下3个一组</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(Reader reader)</span> &#123;<br>    <span class="hljs-built_in">this</span>(reader, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(Reader reader, String environment)</span> &#123;<br>    <span class="hljs-built_in">this</span>(reader, environment, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// 构造函数，转换成XPathParser再去调用构造函数</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(Reader reader, String environment, Properties props)</span> &#123;<br>    <span class="hljs-comment">//构造一个需要验证，XMLMapperEntityResolver的XPathParser</span><br>    <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XPathParser</span>(reader, <span class="hljs-literal">true</span>, props, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperEntityResolver</span>()), environment, props);<br>  &#125; <br><br>  <span class="hljs-comment">// 以下3个一组</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(InputStream inputStream)</span> &#123;<br>    <span class="hljs-built_in">this</span>(inputStream, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(InputStream inputStream, String environment)</span> &#123;<br>    <span class="hljs-built_in">this</span>(inputStream, environment, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(InputStream inputStream, String environment, Properties props)</span> &#123;<br>    <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XPathParser</span>(inputStream, <span class="hljs-literal">true</span>, props, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperEntityResolver</span>()), environment, props);<br>  &#125; <br><br>  <span class="hljs-comment">// 上面6个构造函数最后都合流到这个函数，传入XPathParser</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(XPathParser parser, String environment, Properties props)</span> &#123;<br>    <span class="hljs-comment">// 首先调用父类初始化Configuration</span><br>    <span class="hljs-built_in">super</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>());<br>    <span class="hljs-comment">// 错误上下文设置成SQL Mapper Configuration(XML文件配置),以便后面出错了报错用吧</span><br>    ErrorContext.instance().resource(<span class="hljs-string">&quot;SQL Mapper Configuration&quot;</span>);<br>    <span class="hljs-comment">// 将Properties全部设置到Configuration里面去</span><br>    <span class="hljs-built_in">this</span>.configuration.setVariables(props);<br>    <span class="hljs-built_in">this</span>.parsed = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">this</span>.environment = environment;<br>    <span class="hljs-built_in">this</span>.parser = parser;<br>  &#125; <br><br>  <span class="hljs-comment">// 解析配置</span><br>  <span class="hljs-keyword">public</span> Configuration <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 如果已经解析过了，报错</span><br>    <span class="hljs-keyword">if</span> (parsed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);<br>    &#125;<br>    parsed = <span class="hljs-literal">true</span>;<br><span class="hljs-comment">//  &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; </span><br><span class="hljs-comment">//  &lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; </span><br><span class="hljs-comment">//  &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt; </span><br><span class="hljs-comment">//  &lt;configuration&gt; </span><br><span class="hljs-comment">//  &lt;environments default=&quot;development&quot;&gt; </span><br><span class="hljs-comment">//  &lt;environment id=&quot;development&quot;&gt; </span><br><span class="hljs-comment">//  &lt;transactionManager type=&quot;JDBC&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;dataSource type=&quot;POOLED&quot;&gt; </span><br><span class="hljs-comment">//  &lt;property name=&quot;driver&quot; value=&quot;$&#123;driver&#125;&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;property name=&quot;username&quot; value=&quot;$&#123;username&#125;&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;property name=&quot;password&quot; value=&quot;$&#123;password&#125;&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;/dataSource&gt; </span><br><span class="hljs-comment">//  &lt;/environment&gt; </span><br><span class="hljs-comment">//  &lt;/environments&gt;</span><br><span class="hljs-comment">//  &lt;mappers&gt; </span><br><span class="hljs-comment">//  &lt;mapper resource=&quot;org/mybatis/example/BlogMapper.xml&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;/mappers&gt; </span><br><span class="hljs-comment">//  &lt;/configuration&gt;</span><br><br>    <span class="hljs-comment">// 根节点是configuration</span><br>    parseConfiguration(parser.evalNode(<span class="hljs-string">&quot;/configuration&quot;</span>));<br>    <span class="hljs-keyword">return</span> configuration;<br>  &#125; <br><br>  <span class="hljs-comment">// 解析配置</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseConfiguration</span><span class="hljs-params">(XNode root)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 分步骤解析</span><br>      <span class="hljs-comment">// issue #117 read properties first</span><br>      <span class="hljs-comment">// 1.properties</span><br>      propertiesElement(root.evalNode(<span class="hljs-string">&quot;properties&quot;</span>));<br>      <span class="hljs-comment">// 2.类型别名</span><br>      typeAliasesElement(root.evalNode(<span class="hljs-string">&quot;typeAliases&quot;</span>));<br>      <span class="hljs-comment">// 3.插件</span><br>      pluginElement(root.evalNode(<span class="hljs-string">&quot;plugins&quot;</span>));<br>      <span class="hljs-comment">// 4.对象工厂</span><br>      objectFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectFactory&quot;</span>));<br>      <span class="hljs-comment">// 5.对象包装工厂</span><br>      objectWrapperFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectWrapperFactory&quot;</span>));<br>      <span class="hljs-comment">// 6.设置</span><br>      settingsElement(root.evalNode(<span class="hljs-string">&quot;settings&quot;</span>));<br>      <span class="hljs-comment">// read it after objectFactory and objectWrapperFactory issue #631</span><br>      <span class="hljs-comment">// 7.环境</span><br>      environmentsElement(root.evalNode(<span class="hljs-string">&quot;environments&quot;</span>));<br>      <span class="hljs-comment">// 8.databaseIdProvider</span><br>      databaseIdProviderElement(root.evalNode(<span class="hljs-string">&quot;databaseIdProvider&quot;</span>));<br>      <span class="hljs-comment">// 9.类型处理器</span><br>      typeHandlerElement(root.evalNode(<span class="hljs-string">&quot;typeHandlers&quot;</span>));<br>      <span class="hljs-comment">// 10.映射器</span><br>      mapperElement(root.evalNode(<span class="hljs-string">&quot;mappers&quot;</span>));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//1.properties</span><br>  <span class="hljs-comment">//&lt;properties resource=&quot;org/mybatis/example/config.properties&quot;&gt;</span><br>  <span class="hljs-comment">//    &lt;property name=&quot;username&quot; value=&quot;dev_user&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;property name=&quot;password&quot; value=&quot;F2Fa3!33TYyg&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/properties&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">propertiesElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 如果在这些地方,属性多于一个的话,MyBatis 按照如下的顺序加载它们:</span><br><br>      <span class="hljs-comment">// 1.在 properties 元素体内指定的属性首先被读取。</span><br>      <span class="hljs-comment">// 2.从类路径下资源或 properties 元素的 url 属性中加载的属性第二被读取,它会覆盖已经存在的完全一样的属性。</span><br>      <span class="hljs-comment">// 3.作为方法参数传递的属性最后被读取, 它也会覆盖任一已经存在的完全一样的属性,这些属性可能是从 properties 元素体内和资源/url 属性中加载的。</span><br>      <span class="hljs-comment">// 传入方式是调用构造函数时传入，public XMLConfigBuilder(Reader reader, String environment, Properties props)</span><br><br>      <span class="hljs-comment">// 1.XNode.getChildrenAsProperties函数方便得到孩子所有Properties</span><br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">defaults</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// 2.然后查找resource或者url,加入前面的Properties</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resource&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;url&quot;</span>);<br>      <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span> &amp;&amp; url != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span>) &#123;<br>        defaults.putAll(Resources.getResourceAsProperties(resource));<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (url != <span class="hljs-literal">null</span>) &#123;<br>        defaults.putAll(Resources.getUrlAsProperties(url));<br>      &#125;<br>      <span class="hljs-comment">// 3.Variables也全部加入Properties</span><br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">vars</span> <span class="hljs-operator">=</span> configuration.getVariables();<br>      <span class="hljs-keyword">if</span> (vars != <span class="hljs-literal">null</span>) &#123;<br>        defaults.putAll(vars);<br>      &#125;<br>      parser.setVariables(defaults);<br>      configuration.setVariables(defaults);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//2.类型别名</span><br>  <span class="hljs-comment">//&lt;typeAliases&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Author&quot; type=&quot;domain.blog.Author&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Blog&quot; type=&quot;domain.blog.Blog&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Comment&quot; type=&quot;domain.blog.Comment&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Post&quot; type=&quot;domain.blog.Post&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Section&quot; type=&quot;domain.blog.Section&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Tag&quot; type=&quot;domain.blog.Tag&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/typeAliases&gt;</span><br>  <span class="hljs-comment">//or    </span><br>  <span class="hljs-comment">//&lt;typeAliases&gt;</span><br>  <span class="hljs-comment">//  &lt;package name=&quot;domain.blog&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/typeAliases&gt;  </span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">typeAliasesElement</span><span class="hljs-params">(XNode parent)</span> &#123;<br>    <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (XNode child : parent.getChildren()) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;package&quot;</span>.equals(child.getName())) &#123;<br>          <span class="hljs-comment">// 如果是package</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">typeAliasPackage</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>          <span class="hljs-comment">//（一）调用TypeAliasRegistry.registerAliases，去包下找所有类,然后注册别名(有@Alias注解则用，没有则取类的simpleName)</span><br>          configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// 如果是typeAlias</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">alias</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;alias&quot;</span>);<br>          <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>          <span class="hljs-keyword">try</span> &#123;<br>            Class&lt;?&gt; clazz = Resources.classForName(type);<br>            <span class="hljs-comment">// 根据Class名字来注册类型别名</span><br>            <span class="hljs-comment">//（二）调用TypeAliasRegistry.registerAlias</span><br>            <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>              <span class="hljs-comment">// alias可以省略</span><br>              typeAliasRegistry.registerAlias(clazz);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              typeAliasRegistry.registerAlias(alias, clazz);<br>            &#125;<br>          &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error registering typeAlias for &#x27;&quot;</span> + alias + <span class="hljs-string">&quot;&#x27;. Cause: &quot;</span> + e, e);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//3.插件</span><br>  <span class="hljs-comment">//MyBatis 允许你在某一点拦截已映射语句执行的调用。默认情况下,MyBatis 允许使用插件来拦截方法调用</span><br>  <span class="hljs-comment">//&lt;plugins&gt;</span><br>  <span class="hljs-comment">//  &lt;plugin interceptor=&quot;org.mybatis.example.ExamplePlugin&quot;&gt;</span><br>  <span class="hljs-comment">//    &lt;property name=&quot;someProperty&quot; value=&quot;100&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;/plugin&gt;</span><br>  <span class="hljs-comment">//&lt;/plugins&gt;  </span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pluginElement</span><span class="hljs-params">(XNode parent)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (XNode child : parent.getChildren()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;interceptor&quot;</span>);<br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> child.getChildrenAsProperties();<br>        <span class="hljs-type">Interceptor</span> <span class="hljs-variable">interceptorInstance</span> <span class="hljs-operator">=</span> (Interceptor) resolveClass(interceptor).newInstance();<br>        interceptorInstance.setProperties(properties);<br>        <span class="hljs-comment">// 调用InterceptorChain.addInterceptor</span><br>        configuration.addInterceptor(interceptorInstance);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//4.对象工厂,可以自定义对象创建的方式,比如用对象池？</span><br>  <span class="hljs-comment">//&lt;objectFactory type=&quot;org.mybatis.example.ExampleObjectFactory&quot;&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;someProperty&quot; value=&quot;100&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/objectFactory&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">objectFactoryElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-type">ObjectFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> (ObjectFactory) resolveClass(type).newInstance();<br>      factory.setProperties(properties);<br>      configuration.setObjectFactory(factory);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 5.对象包装工厂</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">objectWrapperFactoryElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      <span class="hljs-type">ObjectWrapperFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> (ObjectWrapperFactory) resolveClass(type).newInstance();<br>      configuration.setObjectWrapperFactory(factory);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//6.设置</span><br>  <span class="hljs-comment">//这些是极其重要的调整, 它们会修改 MyBatis 在运行时的行为方式</span><br>  <span class="hljs-comment">//&lt;settings&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;lazyLoadingEnabled&quot; value=&quot;true&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;multipleResultSetsEnabled&quot; value=&quot;true&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;useColumnLabel&quot; value=&quot;true&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;useGeneratedKeys&quot; value=&quot;false&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;enhancementEnabled&quot; value=&quot;false&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;defaultExecutorType&quot; value=&quot;SIMPLE&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;defaultStatementTimeout&quot; value=&quot;25000&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;safeRowBoundsEnabled&quot; value=&quot;false&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;mapUnderscoreToCamelCase&quot; value=&quot;false&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;localCacheScope&quot; value=&quot;SESSION&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;jdbcTypeForNull&quot; value=&quot;OTHER&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;lazyLoadTriggerMethods&quot; value=&quot;equals,clone,hashCode,toString&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/settings&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">settingsElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// Check that all settings are known to the configuration class</span><br>      <span class="hljs-comment">// 检查下是否在Configuration类里都有相应的setter方法（没有拼写错误）</span><br>      <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaConfig</span> <span class="hljs-operator">=</span> MetaClass.forClass(Configuration.class);<br>      <span class="hljs-keyword">for</span> (Object key : props.keySet()) &#123;<br>        <span class="hljs-keyword">if</span> (!metaConfig.hasSetter(String.valueOf(key))) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;The setting &quot;</span> + key + <span class="hljs-string">&quot; is not known.  Make sure you spelled it correctly (case sensitive).&quot;</span>);<br>        &#125;<br>      &#125;<br><br>      <span class="hljs-comment">// 下面非常简单，一个个设置属性</span><br>      <span class="hljs-comment">// 如何自动映射列到字段/ 属性</span><br>      configuration.setAutoMappingBehavior(AutoMappingBehavior.valueOf(props.getProperty(<span class="hljs-string">&quot;autoMappingBehavior&quot;</span>, <span class="hljs-string">&quot;PARTIAL&quot;</span>)));<br>      <span class="hljs-comment">// 缓存</span><br>      configuration.setCacheEnabled(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;cacheEnabled&quot;</span>), <span class="hljs-literal">true</span>));<br>      <span class="hljs-comment">// proxyFactory (CGLIB | JAVASSIST)</span><br>      <span class="hljs-comment">// 延迟加载的核心技术就是用代理模式，CGLIB/JAVASSIST两者选一</span><br>      configuration.setProxyFactory((ProxyFactory) createInstance(props.getProperty(<span class="hljs-string">&quot;proxyFactory&quot;</span>)));<br>      <span class="hljs-comment">// 延迟加载</span><br>      configuration.setLazyLoadingEnabled(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;lazyLoadingEnabled&quot;</span>), <span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// 延迟加载时，每种属性是否还要按需加载</span><br>      configuration.setAggressiveLazyLoading(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;aggressiveLazyLoading&quot;</span>), <span class="hljs-literal">true</span>));<br>      <span class="hljs-comment">// 允不允许多种结果集从一个单独 的语句中返回</span><br>      configuration.setMultipleResultSetsEnabled(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;multipleResultSetsEnabled&quot;</span>), <span class="hljs-literal">true</span>));<br>      <span class="hljs-comment">// 使用列标签代替列名</span><br>      configuration.setUseColumnLabel(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;useColumnLabel&quot;</span>), <span class="hljs-literal">true</span>));<br>      <span class="hljs-comment">// 允许 JDBC 支持生成的键</span><br>      configuration.setUseGeneratedKeys(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;useGeneratedKeys&quot;</span>), <span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// 配置默认的执行器</span><br>      configuration.setDefaultExecutorType(ExecutorType.valueOf(props.getProperty(<span class="hljs-string">&quot;defaultExecutorType&quot;</span>, <span class="hljs-string">&quot;SIMPLE&quot;</span>)));<br>      <span class="hljs-comment">// 超时时间</span><br>      configuration.setDefaultStatementTimeout(integerValueOf(props.getProperty(<span class="hljs-string">&quot;defaultStatementTimeout&quot;</span>), <span class="hljs-literal">null</span>));<br>      <span class="hljs-comment">// 是否将DB字段自动映射到驼峰式Java属性（A_COLUMN--&gt;aColumn）</span><br>      configuration.setMapUnderscoreToCamelCase(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;mapUnderscoreToCamelCase&quot;</span>), <span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// 嵌套语句上使用RowBounds</span><br>      configuration.setSafeRowBoundsEnabled(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;safeRowBoundsEnabled&quot;</span>), <span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// 默认用session级别的缓存</span><br>      configuration.setLocalCacheScope(LocalCacheScope.valueOf(props.getProperty(<span class="hljs-string">&quot;localCacheScope&quot;</span>, <span class="hljs-string">&quot;SESSION&quot;</span>)));<br>      <span class="hljs-comment">// 为null值设置jdbctype</span><br>      configuration.setJdbcTypeForNull(JdbcType.valueOf(props.getProperty(<span class="hljs-string">&quot;jdbcTypeForNull&quot;</span>, <span class="hljs-string">&quot;OTHER&quot;</span>)));<br>      <span class="hljs-comment">// Object的哪些方法将触发延迟加载</span><br>      configuration.setLazyLoadTriggerMethods(stringSetValueOf(props.getProperty(<span class="hljs-string">&quot;lazyLoadTriggerMethods&quot;</span>), <span class="hljs-string">&quot;equals,clone,hashCode,toString&quot;</span>));<br>      <span class="hljs-comment">// 使用安全的ResultHandler</span><br>      configuration.setSafeResultHandlerEnabled(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;safeResultHandlerEnabled&quot;</span>), <span class="hljs-literal">true</span>));<br>      <span class="hljs-comment">// 动态SQL生成语言所使用的脚本语言</span><br>      configuration.setDefaultScriptingLanguage(resolveClass(props.getProperty(<span class="hljs-string">&quot;defaultScriptingLanguage&quot;</span>)));<br>      <span class="hljs-comment">// 当结果集中含有Null值时是否执行映射对象的setter或者Map对象的put方法。此设置对于原始类型如int,boolean等无效。 </span><br>      configuration.setCallSettersOnNulls(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;callSettersOnNulls&quot;</span>), <span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// logger名字的前缀</span><br>      configuration.setLogPrefix(props.getProperty(<span class="hljs-string">&quot;logPrefix&quot;</span>));<br>      <span class="hljs-comment">// 显式定义用什么log框架，不定义则用默认的自动发现jar包机制</span><br>      configuration.setLogImpl(resolveClass(props.getProperty(<span class="hljs-string">&quot;logImpl&quot;</span>)));<br>      <span class="hljs-comment">// 配置工厂</span><br>      configuration.setConfigurationFactory(resolveClass(props.getProperty(<span class="hljs-string">&quot;configurationFactory&quot;</span>)));<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//7.环境</span><br>  <span class="hljs-comment">//    &lt;environments default=&quot;development&quot;&gt;</span><br>  <span class="hljs-comment">//      &lt;environment id=&quot;development&quot;&gt;</span><br>  <span class="hljs-comment">//        &lt;transactionManager type=&quot;JDBC&quot;&gt;</span><br>  <span class="hljs-comment">//          &lt;property name=&quot;...&quot; value=&quot;...&quot;/&gt;</span><br>  <span class="hljs-comment">//        &lt;/transactionManager&gt;</span><br>  <span class="hljs-comment">//        &lt;dataSource type=&quot;POOLED&quot;&gt;</span><br>  <span class="hljs-comment">//          &lt;property name=&quot;driver&quot; value=&quot;$&#123;driver&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//          &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//          &lt;property name=&quot;username&quot; value=&quot;$&#123;username&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//          &lt;property name=&quot;password&quot; value=&quot;$&#123;password&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//        &lt;/dataSource&gt;</span><br>  <span class="hljs-comment">//      &lt;/environment&gt;</span><br>  <span class="hljs-comment">//    &lt;/environments&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">environmentsElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (environment == <span class="hljs-literal">null</span>) &#123;<br>        environment = context.getStringAttribute(<span class="hljs-string">&quot;default&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">for</span> (XNode child : context.getChildren()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>        <span class="hljs-comment">// 循环比较id是否就是指定的environment</span><br>        <span class="hljs-keyword">if</span> (isSpecifiedEnvironment(id)) &#123;<br>          <span class="hljs-comment">// 7.1事务管理器</span><br>          <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">txFactory</span> <span class="hljs-operator">=</span> transactionManagerElement(child.evalNode(<span class="hljs-string">&quot;transactionManager&quot;</span>));<br>          <span class="hljs-comment">// 7.2数据源</span><br>          <span class="hljs-type">DataSourceFactory</span> <span class="hljs-variable">dsFactory</span> <span class="hljs-operator">=</span> dataSourceElement(child.evalNode(<span class="hljs-string">&quot;dataSource&quot;</span>));<br>          <span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> dsFactory.getDataSource();<br>          Environment.<span class="hljs-type">Builder</span> <span class="hljs-variable">environmentBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Environment</span>.Builder(id)<br>              .transactionFactory(txFactory)<br>              .dataSource(dataSource);<br>          configuration.setEnvironment(environmentBuilder.build());<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 比较id和environment是否相等</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSpecifiedEnvironment</span><span class="hljs-params">(String id)</span> &#123;<br>    <span class="hljs-keyword">if</span> (environment == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;No environment specified.&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Environment requires an id attribute.&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (environment.equals(id)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125; <br><br>  <span class="hljs-comment">//7.1事务管理器</span><br>  <span class="hljs-comment">//&lt;transactionManager type=&quot;JDBC&quot;&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;...&quot; value=&quot;...&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/transactionManager&gt;</span><br>  <span class="hljs-keyword">private</span> TransactionFactory <span class="hljs-title function_">transactionManagerElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// 根据type=&quot;JDBC&quot;解析返回适当的TransactionFactory</span><br>      <span class="hljs-comment">// JDBC 是在 Configuration类中注册的</span><br>      <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> (TransactionFactory) resolveClass(type).newInstance();<br>      factory.setProperties(props);<br>      <span class="hljs-keyword">return</span> factory;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Environment declaration requires a TransactionFactory.&quot;</span>);<br>  &#125; <br><br>  <span class="hljs-comment">//7.2数据源</span><br>  <span class="hljs-comment">//&lt;dataSource type=&quot;POOLED&quot;&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;driver&quot; value=&quot;$&#123;driver&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;username&quot; value=&quot;$&#123;username&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;password&quot; value=&quot;$&#123;password&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/dataSource&gt;</span><br>  <span class="hljs-keyword">private</span> DataSourceFactory <span class="hljs-title function_">dataSourceElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// 根据type=&quot;POOLED&quot;解析返回适当的DataSourceFactory</span><br>      <span class="hljs-type">DataSourceFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> (DataSourceFactory) resolveClass(type).newInstance();<br>      factory.setProperties(props);<br>      <span class="hljs-keyword">return</span> factory;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Environment declaration requires a DataSourceFactory.&quot;</span>);<br>  &#125; <br><br>  <span class="hljs-comment">//8.databaseIdProvider</span><br>  <span class="hljs-comment">//可以根据不同数据库执行不同的SQL，sql要加databaseId属性</span><br>  <span class="hljs-comment">//这个功能感觉不是很实用，真要多数据库支持，那SQL工作量将会成倍增长，用mybatis以后一般就绑死在一个数据库上了。但也是一个不得已的方法吧</span><br>  <span class="hljs-comment">//可以参考org.apache.ibatis.submitted.multidb包里的测试用例</span><br>  <span class="hljs-comment">//    &lt;databaseIdProvider type=&quot;VENDOR&quot;&gt;</span><br>  <span class="hljs-comment">//      &lt;property name=&quot;SQL Server&quot; value=&quot;sqlserver&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;property name=&quot;DB2&quot; value=&quot;db2&quot;/&gt;        </span><br>  <span class="hljs-comment">//      &lt;property name=&quot;Oracle&quot; value=&quot;oracle&quot; /&gt;</span><br>  <span class="hljs-comment">//    &lt;/databaseIdProvider&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">databaseIdProviderElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">DatabaseIdProvider</span> <span class="hljs-variable">databaseIdProvider</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      <span class="hljs-comment">// awful patch to keep backward compatibility</span><br>      <span class="hljs-comment">// 与老版本兼容</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;VENDOR&quot;</span>.equals(type)) &#123;<br>          type = <span class="hljs-string">&quot;DB_VENDOR&quot;</span>;<br>      &#125;<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// &quot;DB_VENDOR&quot;--&gt;VendorDatabaseIdProvider</span><br>      databaseIdProvider = (DatabaseIdProvider) resolveClass(type).newInstance();<br>      databaseIdProvider.setProperties(properties);<br>    &#125;<br>    <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> configuration.getEnvironment();<br>    <span class="hljs-keyword">if</span> (environment != <span class="hljs-literal">null</span> &amp;&amp; databaseIdProvider != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 得到当前的databaseId，可以调用DatabaseMetaData.getDatabaseProductName()得到诸如&quot;Oracle (DataDirect)&quot;的字符串，</span><br>      <span class="hljs-comment">// 然后和预定义的property比较,得出目前究竟用的是什么数据库</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">databaseId</span> <span class="hljs-operator">=</span> databaseIdProvider.getDatabaseId(environment.getDataSource());<br>      configuration.setDatabaseId(databaseId);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//9.类型处理器</span><br>  <span class="hljs-comment">//    &lt;typeHandlers&gt;</span><br>  <span class="hljs-comment">//      &lt;typeHandler handler=&quot;org.mybatis.example.ExampleTypeHandler&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/typeHandlers&gt;</span><br>  <span class="hljs-comment">//or</span><br>  <span class="hljs-comment">//    &lt;typeHandlers&gt;</span><br>  <span class="hljs-comment">//      &lt;package name=&quot;org.mybatis.example&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/typeHandlers&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">typeHandlerElement</span><span class="hljs-params">(XNode parent)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (XNode child : parent.getChildren()) &#123;<br>        <span class="hljs-comment">// 如果是package</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;package&quot;</span>.equals(child.getName())) &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">typeHandlerPackage</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>          <span class="hljs-comment">//（一）调用TypeHandlerRegistry.register，去包下找所有类</span><br>          typeHandlerRegistry.register(typeHandlerPackage);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// 如果是typeHandler</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">javaTypeName</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>);<br>          <span class="hljs-type">String</span> <span class="hljs-variable">jdbcTypeName</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;jdbcType&quot;</span>);<br>          <span class="hljs-type">String</span> <span class="hljs-variable">handlerTypeName</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;handler&quot;</span>);<br>          Class&lt;?&gt; javaTypeClass = resolveClass(javaTypeName);<br>          <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> resolveJdbcType(jdbcTypeName);<br>          Class&lt;?&gt; typeHandlerClass = resolveClass(handlerTypeName);<br>          <span class="hljs-comment">//（二）调用TypeHandlerRegistry.register(以下是3种不同的参数形式)</span><br>          <span class="hljs-keyword">if</span> (javaTypeClass != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (jdbcType == <span class="hljs-literal">null</span>) &#123;<br>              typeHandlerRegistry.register(javaTypeClass, typeHandlerClass);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              typeHandlerRegistry.register(javaTypeClass, jdbcType, typeHandlerClass);<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            typeHandlerRegistry.register(typeHandlerClass);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//10.映射器</span><br>  <span class="hljs-comment">//    10.1使用类路径</span><br>  <span class="hljs-comment">//    &lt;mappers&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper resource=&quot;org/mybatis/builder/AuthorMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper resource=&quot;org/mybatis/builder/BlogMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper resource=&quot;org/mybatis/builder/PostMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/mappers&gt;</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">//    10.2使用绝对url路径</span><br>  <span class="hljs-comment">//    &lt;mappers&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper url=&quot;file:///var/mappers/AuthorMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper url=&quot;file:///var/mappers/BlogMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper url=&quot;file:///var/mappers/PostMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/mappers&gt;</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">//    10.3使用java类名</span><br>  <span class="hljs-comment">//    &lt;mappers&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper class=&quot;org.mybatis.builder.AuthorMapper&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper class=&quot;org.mybatis.builder.BlogMapper&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper class=&quot;org.mybatis.builder.PostMapper&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/mappers&gt;</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">//    10.4自动扫描包下所有映射器</span><br>  <span class="hljs-comment">//    &lt;mappers&gt;</span><br>  <span class="hljs-comment">//      &lt;package name=&quot;org.mybatis.builder&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/mappers&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mapperElement</span><span class="hljs-params">(XNode parent)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (XNode child : parent.getChildren()) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;package&quot;</span>.equals(child.getName())) &#123;<br>          <span class="hljs-comment">//10.4自动扫描包下所有映射器</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">mapperPackage</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>          configuration.addMappers(mapperPackage);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;resource&quot;</span>);<br>          <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;url&quot;</span>);<br>          <span class="hljs-type">String</span> <span class="hljs-variable">mapperClass</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;class&quot;</span>);<br>          <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span> &amp;&amp; url == <span class="hljs-literal">null</span> &amp;&amp; mapperClass == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 10.1使用类路径</span><br>            ErrorContext.instance().resource(resource);<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(resource);<br>            <span class="hljs-comment">// 映射器比较复杂，调用XMLMapperBuilder</span><br>            <span class="hljs-comment">// 注意在for循环里每个mapper都重新new一个XMLMapperBuilder，来解析</span><br>            <span class="hljs-type">XMLMapperBuilder</span> <span class="hljs-variable">mapperParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperBuilder</span>(inputStream, configuration, resource, configuration.getSqlFragments());<br>            mapperParser.parse();<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource == <span class="hljs-literal">null</span> &amp;&amp; url != <span class="hljs-literal">null</span> &amp;&amp; mapperClass == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 10.2使用绝对url路径</span><br>            ErrorContext.instance().resource(url);<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getUrlAsStream(url);<br>            <span class="hljs-comment">// 映射器比较复杂，调用XMLMapperBuilder</span><br>            <span class="hljs-type">XMLMapperBuilder</span> <span class="hljs-variable">mapperParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperBuilder</span>(inputStream, configuration, url, configuration.getSqlFragments());<br>            mapperParser.parse();<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource == <span class="hljs-literal">null</span> &amp;&amp; url == <span class="hljs-literal">null</span> &amp;&amp; mapperClass != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 10.3使用java类名</span><br>            Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);<br>            <span class="hljs-comment">// 直接把这个映射加入配置</span><br>            configuration.addMapper(mapperInterface);<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="XMLStatementBuilder"><a href="#XMLStatementBuilder" class="headerlink" title="XMLStatementBuilder"></a>XMLStatementBuilder</h4><p>    XML语句构建器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLStatementBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-keyword">private</span> MapperBuilderAssistant builderAssistant;<br>  <span class="hljs-keyword">private</span> XNode context;<br>  <span class="hljs-keyword">private</span> String requiredDatabaseId; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLStatementBuilder</span><span class="hljs-params">(Configuration configuration, MapperBuilderAssistant builderAssistant, XNode context)</span> &#123;<br>    <span class="hljs-built_in">this</span>(configuration, builderAssistant, context, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLStatementBuilder</span><span class="hljs-params">(Configuration configuration, MapperBuilderAssistant builderAssistant, XNode context, String databaseId)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration);<br>    <span class="hljs-built_in">this</span>.builderAssistant = builderAssistant;<br>    <span class="hljs-built_in">this</span>.context = context;<br>    <span class="hljs-built_in">this</span>.requiredDatabaseId = databaseId;<br>  &#125; <br><br>  <span class="hljs-comment">//解析语句(select|insert|update|delete)</span><br>  <span class="hljs-comment">//&lt;select</span><br>  <span class="hljs-comment">//  id=&quot;selectPerson&quot;</span><br>  <span class="hljs-comment">//  parameterType=&quot;int&quot;</span><br>  <span class="hljs-comment">//  parameterMap=&quot;deprecated&quot;</span><br>  <span class="hljs-comment">//  resultType=&quot;hashmap&quot;</span><br>  <span class="hljs-comment">//  resultMap=&quot;personResultMap&quot;</span><br>  <span class="hljs-comment">//  flushCache=&quot;false&quot;</span><br>  <span class="hljs-comment">//  useCache=&quot;true&quot;</span><br>  <span class="hljs-comment">//  timeout=&quot;10000&quot;</span><br>  <span class="hljs-comment">//  fetchSize=&quot;256&quot;</span><br>  <span class="hljs-comment">//  statementType=&quot;PREPARED&quot;</span><br>  <span class="hljs-comment">//  resultSetType=&quot;FORWARD_ONLY&quot;&gt;</span><br>  <span class="hljs-comment">//  SELECT * FROM PERSON WHERE ID = #&#123;id&#125;</span><br>  <span class="hljs-comment">//&lt;/select&gt;</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseStatementNode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">databaseId</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>);<br><br>    <span class="hljs-comment">// 如果databaseId不匹配，退出</span><br>    <span class="hljs-keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="hljs-built_in">this</span>.requiredDatabaseId)) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 暗示驱动程序每次批量返回的结果行数</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> context.getIntAttribute(<span class="hljs-string">&quot;fetchSize&quot;</span>);<br>    <span class="hljs-comment">// 超时时间</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> context.getIntAttribute(<span class="hljs-string">&quot;timeout&quot;</span>);<br>    <span class="hljs-comment">// 引用外部 parameterMap,已废弃</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">parameterMap</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;parameterMap&quot;</span>);<br>    <span class="hljs-comment">// 参数类型</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">parameterType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;parameterType&quot;</span>);<br>    Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);<br>    <span class="hljs-comment">// 引用外部的 resultMap(高级功能)</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>);<br>    <span class="hljs-comment">// 结果类型</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultType&quot;</span>);<br>    <span class="hljs-comment">// 脚本语言,mybatis3.2的新功能</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lang</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;lang&quot;</span>);<br>    <span class="hljs-comment">// 得到语言驱动</span><br>    <span class="hljs-type">LanguageDriver</span> <span class="hljs-variable">langDriver</span> <span class="hljs-operator">=</span> getLanguageDriver(lang);<br><br>    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);<br>    <span class="hljs-comment">// 结果集类型，FORWARD_ONLY|SCROLL_SENSITIVE|SCROLL_INSENSITIVE 中的一种</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultSetType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultSetType&quot;</span>);<br>    <span class="hljs-comment">// 语句类型, STATEMENT|PREPARED|CALLABLE 的一种</span><br>    <span class="hljs-type">StatementType</span> <span class="hljs-variable">statementType</span> <span class="hljs-operator">=</span> StatementType.valueOf(context.getStringAttribute(<span class="hljs-string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));<br>    <span class="hljs-type">ResultSetType</span> <span class="hljs-variable">resultSetTypeEnum</span> <span class="hljs-operator">=</span> resolveResultSetType(resultSetType);<br><br>    <span class="hljs-comment">// 获取命令类型(select|insert|update|delete)</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">nodeName</span> <span class="hljs-operator">=</span> context.getNode().getNodeName();<br>    <span class="hljs-type">SqlCommandType</span> <span class="hljs-variable">sqlCommandType</span> <span class="hljs-operator">=</span> SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSelect</span> <span class="hljs-operator">=</span> sqlCommandType == SqlCommandType.SELECT;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">flushCache</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;flushCache&quot;</span>, !isSelect);<br>    <span class="hljs-comment">// 是否要缓存select结果,默认缓存</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">useCache</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;useCache&quot;</span>, isSelect);<br>    <span class="hljs-comment">// 仅针对嵌套结果 select 语句适用：如果为 true，就是假设包含了嵌套结果集或是分组了，这样的话当返回一个主结果行的时候，就不会发生有对前面结果集的引用的情况。</span><br>    <span class="hljs-comment">// 这就使得在获取嵌套的结果集的时候不至于导致内存不够用。默认值：false。</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">resultOrdered</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;resultOrdered&quot;</span>, <span class="hljs-literal">false</span>);<br><br>    <span class="hljs-comment">// Include Fragments before parsing</span><br>    <span class="hljs-comment">// 解析之前先解析&lt;include&gt;SQL片段</span><br>    <span class="hljs-type">XMLIncludeTransformer</span> <span class="hljs-variable">includeParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLIncludeTransformer</span>(configuration, builderAssistant);<br>    includeParser.applyIncludes(context.getNode());<br><br>    <span class="hljs-comment">// Parse selectKey after includes and remove them.</span><br>    <span class="hljs-comment">// 解析之前先解析&lt;selectKey&gt;</span><br>    processSelectKeyNodes(id, parameterTypeClass, langDriver);<br><br>    <span class="hljs-comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span><br>    <span class="hljs-comment">// 解析成SqlSource，一般是DynamicSqlSource</span><br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> langDriver.createSqlSource(configuration, context, parameterTypeClass);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultSets</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultSets&quot;</span>);<br>    <span class="hljs-comment">// (仅对 insert 有用) 标记一个属性, MyBatis 会通过 getGeneratedKeys 或者通过 insert 语句的 selectKey 子元素设置它的值</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyProperty</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;keyProperty&quot;</span>);<br>    <span class="hljs-comment">// (仅对 insert 有用) 标记一个属性, MyBatis 会通过 getGeneratedKeys 或者通过 insert 语句的 selectKey 子元素设置它的值</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyColumn</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;keyColumn&quot;</span>);<br>    KeyGenerator keyGenerator;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyStatementId</span> <span class="hljs-operator">=</span> id + SelectKeyGenerator.SELECT_KEY_SUFFIX;<br>    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;<br>      keyGenerator = configuration.getKeyGenerator(keyStatementId);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      keyGenerator = context.getBooleanAttribute(<span class="hljs-string">&quot;useGeneratedKeys&quot;</span>,<br>          configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))<br>          ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jdbc3KeyGenerator</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 又去调助手类</span><br>    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,<br>        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,<br>        resultSetTypeEnum, flushCache, useCache, resultOrdered, <br>        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">databaseIdMatchesCurrent</span><span class="hljs-params">(String id, String databaseId, String requiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">if</span> (requiredDatabaseId != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!requiredDatabaseId.equals(databaseId)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (databaseId != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>      <span class="hljs-comment">// skip this statement if there is a previous one with a not null databaseId</span><br>      id = builderAssistant.applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.configuration.hasStatement(id, <span class="hljs-literal">false</span>)) &#123;<br>        <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">previous</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.configuration.getMappedStatement(id, <span class="hljs-literal">false</span>); <span class="hljs-comment">// issue #2</span><br>        <span class="hljs-keyword">if</span> (previous.getDatabaseId() != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// 取得语言驱动</span><br>  <span class="hljs-keyword">private</span> LanguageDriver <span class="hljs-title function_">getLanguageDriver</span><span class="hljs-params">(String lang)</span> &#123;<br>    Class&lt;?&gt; langClass = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (lang != <span class="hljs-literal">null</span>) &#123;<br>      langClass = resolveClass(lang);<br>    &#125;<br>    <span class="hljs-comment">// 调用builderAssistant</span><br>    <span class="hljs-keyword">return</span> builderAssistant.getLanguageDriver(langClass);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSelectKeyNodes</span><span class="hljs-params">(String id, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver)</span> &#123;<br>    List&lt;XNode&gt; selectKeyNodes = context.evalNodes(<span class="hljs-string">&quot;selectKey&quot;</span>);<br>    <span class="hljs-keyword">if</span> (configuration.getDatabaseId() != <span class="hljs-literal">null</span>) &#123;<br>      parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());<br>    &#125;<br>    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, <span class="hljs-literal">null</span>);<br>    removeSelectKeyNodes(selectKeyNodes);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseSelectKeyNodes</span><span class="hljs-params">(String parentId, List&lt;XNode&gt; list, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver, String skRequiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">for</span> (XNode nodeToHandle : list) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> parentId + SelectKeyGenerator.SELECT_KEY_SUFFIX;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">databaseId</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>);<br>      <span class="hljs-keyword">if</span> (databaseIdMatchesCurrent(id, databaseId, skRequiredDatabaseId)) &#123;<br>        parseSelectKeyNode(id, nodeToHandle, parameterTypeClass, langDriver, databaseId);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseSelectKeyNode</span><span class="hljs-params">(String id, XNode nodeToHandle, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver, String databaseId)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultType</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;resultType&quot;</span>);<br>    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);<br>    <span class="hljs-type">StatementType</span> <span class="hljs-variable">statementType</span> <span class="hljs-operator">=</span> StatementType.valueOf(nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyProperty</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;keyProperty&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyColumn</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;keyColumn&quot;</span>);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">executeBefore</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;BEFORE&quot;</span>.equals(nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;order&quot;</span>, <span class="hljs-string">&quot;AFTER&quot;</span>));<br><br>    <span class="hljs-comment">// defaults</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">useCache</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">resultOrdered</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">flushCache</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">parameterMap</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">ResultSetType</span> <span class="hljs-variable">resultSetTypeEnum</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> langDriver.createSqlSource(configuration, nodeToHandle, parameterTypeClass);<br>    <span class="hljs-type">SqlCommandType</span> <span class="hljs-variable">sqlCommandType</span> <span class="hljs-operator">=</span> SqlCommandType.SELECT;<br><br>    <span class="hljs-comment">// 这里生成的MappedStatement用于设置 KeyGenerator</span><br>    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,<br>        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,<br>        resultSetTypeEnum, flushCache, useCache, resultOrdered,<br>        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, <span class="hljs-literal">null</span>);<br><br>    id = builderAssistant.applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br><br>    <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">keyStatement</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(id, <span class="hljs-literal">false</span>);<br>    configuration.addKeyGenerator(id, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SelectKeyGenerator</span>(keyStatement, executeBefore));<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeSelectKeyNodes</span><span class="hljs-params">(List&lt;XNode&gt; selectKeyNodes)</span> &#123;<br>    <span class="hljs-keyword">for</span> (XNode nodeToHandle : selectKeyNodes) &#123;<br>      nodeToHandle.getParent().getNode().removeChild(nodeToHandle.getNode());<br>    &#125;<br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="XMLMapperBuilder"><a href="#XMLMapperBuilder" class="headerlink" title="XMLMapperBuilder"></a>XMLMapperBuilder</h4><p>    XML映射构建器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLMapperBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-keyword">private</span> XPathParser parser;<br>  <span class="hljs-comment">// 映射器构建助手</span><br>  <span class="hljs-keyword">private</span> MapperBuilderAssistant builderAssistant;<br>  <span class="hljs-comment">// 用来存放sql片段的哈希表</span><br>  <span class="hljs-keyword">private</span> Map&lt;String, XNode&gt; sqlFragments;<br>  <span class="hljs-keyword">private</span> String resource; <br><br>  <span class="hljs-meta">@Deprecated</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLMapperBuilder</span><span class="hljs-params">(Reader reader, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments, String namespace)</span> &#123;<br>    <span class="hljs-built_in">this</span>(reader, configuration, resource, sqlFragments);<br>    <span class="hljs-built_in">this</span>.builderAssistant.setCurrentNamespace(namespace);<br>  &#125;<br><br>  <span class="hljs-meta">@Deprecated</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLMapperBuilder</span><span class="hljs-params">(Reader reader, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments)</span> &#123;<br>    <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XPathParser</span>(reader, <span class="hljs-literal">true</span>, configuration.getVariables(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperEntityResolver</span>()),<br>        configuration, resource, sqlFragments);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLMapperBuilder</span><span class="hljs-params">(InputStream inputStream, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments, String namespace)</span> &#123;<br>    <span class="hljs-built_in">this</span>(inputStream, configuration, resource, sqlFragments);<br>    <span class="hljs-built_in">this</span>.builderAssistant.setCurrentNamespace(namespace);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLMapperBuilder</span><span class="hljs-params">(InputStream inputStream, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments)</span> &#123;<br>    <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XPathParser</span>(inputStream, <span class="hljs-literal">true</span>, configuration.getVariables(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperEntityResolver</span>()),<br>        configuration, resource, sqlFragments);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">XMLMapperBuilder</span><span class="hljs-params">(XPathParser parser, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration);<br>    <span class="hljs-built_in">this</span>.builderAssistant = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperBuilderAssistant</span>(configuration, resource);<br>    <span class="hljs-built_in">this</span>.parser = parser;<br>    <span class="hljs-built_in">this</span>.sqlFragments = sqlFragments;<br>    <span class="hljs-built_in">this</span>.resource = resource;<br>  &#125; <br><br>  <span class="hljs-comment">// 解析</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 如果没有加载过再加载，防止重复加载</span><br>    <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;<br>      <span class="hljs-comment">// 配置mapper</span><br>      configurationElement(parser.evalNode(<span class="hljs-string">&quot;/mapper&quot;</span>));<br>      <span class="hljs-comment">// 标记一下，已经加载过了</span><br>      configuration.addLoadedResource(resource);<br>      <span class="hljs-comment">// 绑定映射器到namespace</span><br>      bindMapperForNamespace();<br>    &#125;<br><br>    <span class="hljs-comment">// 还有没解析完的东东这里接着解析？  </span><br>    parsePendingResultMaps();<br>    parsePendingChacheRefs();<br>    parsePendingStatements();<br>  &#125; <br><br>  <span class="hljs-comment">// 配置mapper元素</span><br>  <span class="hljs-comment">//    &lt;mapper namespace=&quot;org.mybatis.example.BlogMapper&quot;&gt;</span><br>  <span class="hljs-comment">//      &lt;select id=&quot;selectBlog&quot; parameterType=&quot;int&quot; resultType=&quot;Blog&quot;&gt;</span><br>  <span class="hljs-comment">//        select * from Blog where id = #&#123;id&#125;</span><br>  <span class="hljs-comment">//      &lt;/select&gt;</span><br>  <span class="hljs-comment">//    &lt;/mapper&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configurationElement</span><span class="hljs-params">(XNode context)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 1.配置namespace</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>);<br>      <span class="hljs-keyword">if</span> (namespace.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);<br>      &#125;<br>      builderAssistant.setCurrentNamespace(namespace);<br>      <span class="hljs-comment">// 2.配置cache-ref</span><br>      cacheRefElement(context.evalNode(<span class="hljs-string">&quot;cache-ref&quot;</span>));<br>      <span class="hljs-comment">// 3.配置cache</span><br>      cacheElement(context.evalNode(<span class="hljs-string">&quot;cache&quot;</span>));<br>      <span class="hljs-comment">// 4.配置parameterMap(已经废弃,老式风格的参数映射)</span><br>      parameterMapElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/parameterMap&quot;</span>));<br>      <span class="hljs-comment">// 5.配置resultMap(高级功能)</span><br>      resultMapElements(context.evalNodes(<span class="hljs-string">&quot;/mapper/resultMap&quot;</span>));<br>      <span class="hljs-comment">// 6.配置sql(定义可重用的 SQL 代码段)</span><br>      sqlElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/sql&quot;</span>));<br>      <span class="hljs-comment">// 7.配置select|insert|update|delete TODO</span><br>      buildStatementFromContext(context.evalNodes(<span class="hljs-string">&quot;select|insert|update|delete&quot;</span>));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error parsing Mapper XML. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//2.配置cache-ref,在这样的 情况下你可以使用 cache-ref 元素来引用另外一个缓存。 </span><br>  <span class="hljs-comment">//&lt;cache-ref namespace=&quot;com.someone.application.data.SomeMapper&quot;/&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacheRefElement</span><span class="hljs-params">(XNode context)</span> &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 增加cache-ref</span><br>      configuration.addCacheRef(builderAssistant.getCurrentNamespace(), context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>));<br>      <span class="hljs-type">CacheRefResolver</span> <span class="hljs-variable">cacheRefResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheRefResolver</span>(builderAssistant, context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>));<br>      <span class="hljs-keyword">try</span> &#123;<br>        cacheRefResolver.resolveCacheRef();<br>      &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>        configuration.addIncompleteCacheRef(cacheRefResolver);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//3.配置cache</span><br>  <span class="hljs-comment">//  &lt;cache</span><br>  <span class="hljs-comment">//  eviction=&quot;FIFO&quot;</span><br>  <span class="hljs-comment">//  flushInterval=&quot;60000&quot;</span><br>  <span class="hljs-comment">//  size=&quot;512&quot;</span><br>  <span class="hljs-comment">//  readOnly=&quot;true&quot;/&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacheElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;PERPETUAL&quot;</span>);<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; typeClass = typeAliasRegistry.resolveAlias(type);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">eviction</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;eviction&quot;</span>, <span class="hljs-string">&quot;LRU&quot;</span>);<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; evictionClass = typeAliasRegistry.resolveAlias(eviction);<br>      <span class="hljs-type">Long</span> <span class="hljs-variable">flushInterval</span> <span class="hljs-operator">=</span> context.getLongAttribute(<span class="hljs-string">&quot;flushInterval&quot;</span>);<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> context.getIntAttribute(<span class="hljs-string">&quot;size&quot;</span>);<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">readWrite</span> <span class="hljs-operator">=</span> !context.getBooleanAttribute(<span class="hljs-string">&quot;readOnly&quot;</span>, <span class="hljs-literal">false</span>);<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">blocking</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;blocking&quot;</span>, <span class="hljs-literal">false</span>);<br>      <span class="hljs-comment">// 读入额外的配置信息，易于第三方的缓存扩展,例:</span><br><span class="hljs-comment">//    &lt;cache type=&quot;com.domain.something.MyCustomCache&quot;&gt;</span><br><span class="hljs-comment">//      &lt;property name=&quot;cacheFile&quot; value=&quot;/tmp/my-custom-cache.tmp&quot;/&gt;</span><br><span class="hljs-comment">//    &lt;/cache&gt;</span><br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// 调用builderAssistant.useNewCache</span><br>      builderAssistant.useNewCache(typeClass, evictionClass, flushInterval, size, readWrite, blocking, props);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//4.配置parameterMap</span><br>  <span class="hljs-comment">//已经被废弃了!老式风格的参数映射。可以忽略</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterMapElement</span><span class="hljs-params">(List&lt;XNode&gt; list)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">for</span> (XNode parameterMapNode : list) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> parameterMapNode.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> parameterMapNode.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      Class&lt;?&gt; parameterClass = resolveClass(type);<br>      List&lt;XNode&gt; parameterNodes = parameterMapNode.evalNodes(<span class="hljs-string">&quot;parameter&quot;</span>);<br>      List&lt;ParameterMapping&gt; parameterMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ParameterMapping&gt;();<br>      <span class="hljs-keyword">for</span> (XNode parameterNode : parameterNodes) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;property&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">javaType</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;jdbcType&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mode</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;mode&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">typeHandler</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;typeHandler&quot;</span>);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">numericScale</span> <span class="hljs-operator">=</span> parameterNode.getIntAttribute(<span class="hljs-string">&quot;numericScale&quot;</span>);<br>        <span class="hljs-type">ParameterMode</span> <span class="hljs-variable">modeEnum</span> <span class="hljs-operator">=</span> resolveParameterMode(mode);<br>        Class&lt;?&gt; javaTypeClass = resolveClass(javaType);<br>        <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcTypeEnum</span> <span class="hljs-operator">=</span> resolveJdbcType(jdbcType);<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt;) resolveClass(typeHandler);<br>        <span class="hljs-type">ParameterMapping</span> <span class="hljs-variable">parameterMapping</span> <span class="hljs-operator">=</span> builderAssistant.buildParameterMapping(parameterClass, property, javaTypeClass, jdbcTypeEnum, resultMap, modeEnum, typeHandlerClass, numericScale);<br>        parameterMappings.add(parameterMapping);<br>      &#125;<br>      builderAssistant.addParameterMap(id, parameterClass, parameterMappings);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//5.配置resultMap,高级功能</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resultMapElements</span><span class="hljs-params">(List&lt;XNode&gt; list)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 基本上就是循环把resultMap加入到Configuration里去,保持2份，一份缩略，一分全名</span><br>    <span class="hljs-keyword">for</span> (XNode resultMapNode : list) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 循环调resultMapElement</span><br>        resultMapElement(resultMapNode);<br>      &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>        <span class="hljs-comment">// ignore, it will be retried</span><br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//5.1 配置resultMap</span><br>  <span class="hljs-keyword">private</span> ResultMap <span class="hljs-title function_">resultMapElement</span><span class="hljs-params">(XNode resultMapNode)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> resultMapElement(resultMapNode, Collections.&lt;ResultMapping&gt; emptyList());<br>  &#125; <br><br>  <span class="hljs-comment">//5.1 配置resultMap</span><br>  <span class="hljs-keyword">private</span> ResultMap <span class="hljs-title function_">resultMapElement</span><span class="hljs-params">(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//错误上下文</span><br>    <span class="hljs-comment">//取得标示符   (&quot;resultMap[userResultMap]&quot;)</span><br>    <span class="hljs-comment">//    &lt;resultMap id=&quot;userResultMap&quot; type=&quot;User&quot;&gt;</span><br>    <span class="hljs-comment">//      &lt;id property=&quot;id&quot; column=&quot;user_id&quot; /&gt;</span><br>    <span class="hljs-comment">//      &lt;result property=&quot;username&quot; column=&quot;username&quot;/&gt;</span><br>    <span class="hljs-comment">//      &lt;result property=&quot;password&quot; column=&quot;password&quot;/&gt;</span><br>    <span class="hljs-comment">//    &lt;/resultMap&gt;</span><br>    ErrorContext.instance().activity(<span class="hljs-string">&quot;processing &quot;</span> + resultMapNode.getValueBasedIdentifier());<br>    <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> resultMapNode.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>,<br>        resultMapNode.getValueBasedIdentifier());<br>    <span class="hljs-comment">//一般拿type就可以了，后面3个应该是是兼容老的代码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> resultMapNode.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>,<br>        resultMapNode.getStringAttribute(<span class="hljs-string">&quot;ofType&quot;</span>,<br>            resultMapNode.getStringAttribute(<span class="hljs-string">&quot;resultType&quot;</span>,<br>                resultMapNode.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>))));<br>    <span class="hljs-comment">//高级功能，还支持继承?</span><br>    <span class="hljs-comment">//  &lt;resultMap id=&quot;carResult&quot; type=&quot;Car&quot; extends=&quot;vehicleResult&quot;&gt;</span><br>    <span class="hljs-comment">//    &lt;result property=&quot;doorCount&quot; column=&quot;door_count&quot; /&gt;</span><br>    <span class="hljs-comment">//  &lt;/resultMap&gt;</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">extend</span> <span class="hljs-operator">=</span> resultMapNode.getStringAttribute(<span class="hljs-string">&quot;extends&quot;</span>);<br>    <span class="hljs-comment">//autoMapping</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">autoMapping</span> <span class="hljs-operator">=</span> resultMapNode.getBooleanAttribute(<span class="hljs-string">&quot;autoMapping&quot;</span>);<br>    Class&lt;?&gt; typeClass = resolveClass(type);<br>    <span class="hljs-type">Discriminator</span> <span class="hljs-variable">discriminator</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    List&lt;ResultMapping&gt; resultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>    resultMappings.addAll(additionalResultMappings);<br>    List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();<br>    <span class="hljs-keyword">for</span> (XNode resultChild : resultChildren) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;constructor&quot;</span>.equals(resultChild.getName())) &#123;<br>        <span class="hljs-comment">// 解析result map的constructor</span><br>        processConstructorElement(resultChild, typeClass, resultMappings);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;discriminator&quot;</span>.equals(resultChild.getName())) &#123;<br>        <span class="hljs-comment">// 解析result map的discriminator</span><br>        discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        List&lt;ResultFlag&gt; flags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;id&quot;</span>.equals(resultChild.getName())) &#123;<br>          flags.add(ResultFlag.ID);<br>        &#125;<br>        <span class="hljs-comment">// 调5.1.1 buildResultMappingFromContext,得到ResultMapping</span><br>        resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//最后再调ResultMapResolver得到ResultMap</span><br>    <span class="hljs-type">ResultMapResolver</span> <span class="hljs-variable">resultMapResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMapResolver</span>(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> resultMapResolver.resolve();<br>    &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException  e) &#123;<br>      configuration.addIncompleteResultMap(resultMapResolver);<br>      <span class="hljs-keyword">throw</span> e;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//解析result map的constructor</span><br>  <span class="hljs-comment">//&lt;constructor&gt;</span><br>  <span class="hljs-comment">//  &lt;idArg column=&quot;blog_id&quot; javaType=&quot;int&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/constructor&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processConstructorElement</span><span class="hljs-params">(XNode resultChild, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    List&lt;XNode&gt; argChildren = resultChild.getChildren();<br>    <span class="hljs-keyword">for</span> (XNode argChild : argChildren) &#123;<br>      List&lt;ResultFlag&gt; flags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;();<br>      <span class="hljs-comment">// 结果标志加上ID和CONSTRUCTOR</span><br>      flags.add(ResultFlag.CONSTRUCTOR);<br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;idArg&quot;</span>.equals(argChild.getName())) &#123;<br>        flags.add(ResultFlag.ID);<br>      &#125;<br>      resultMappings.add(buildResultMappingFromContext(argChild, resultType, flags));<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 5.1.1 构建resultMap</span><br>  <span class="hljs-keyword">private</span> ResultMapping <span class="hljs-title function_">buildResultMappingFromContext</span><span class="hljs-params">(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// &lt;id property=&quot;id&quot; column=&quot;author_id&quot;/&gt;</span><br>    <span class="hljs-comment">// &lt;result property=&quot;username&quot; column=&quot;author_username&quot;/&gt;</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;property&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;column&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">javaType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;jdbcType&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">nestedSelect</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;select&quot;</span>);<br>    <span class="hljs-comment">// 处理嵌套的result map</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">nestedResultMap</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>,<br>        processNestedResultMappings(context, Collections.&lt;ResultMapping&gt; emptyList()));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">notNullColumn</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;notNullColumn&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">columnPrefix</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;columnPrefix&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">typeHandler</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;typeHandler&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resulSet</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultSet&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">foreignColumn</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;foreignColumn&quot;</span>);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">lazy</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lazy&quot;</span>.equals(context.getStringAttribute(<span class="hljs-string">&quot;fetchType&quot;</span>, configuration.isLazyLoadingEnabled() ? <span class="hljs-string">&quot;lazy&quot;</span> : <span class="hljs-string">&quot;eager&quot;</span>));<br>    Class&lt;?&gt; javaTypeClass = resolveClass(javaType);<br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt;) resolveClass(typeHandler);<br>    <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcTypeEnum</span> <span class="hljs-operator">=</span> resolveJdbcType(jdbcType);<br>    <span class="hljs-comment">// 又去调builderAssistant.buildResultMapping</span><br>    <span class="hljs-keyword">return</span> builderAssistant.buildResultMapping(resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect, nestedResultMap, notNullColumn, columnPrefix, typeHandlerClass, flags, resulSet, foreignColumn, lazy);<br>  &#125; <br><br>  <span class="hljs-comment">//5.1.1.1 处理嵌套的result map</span><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">processNestedResultMappings</span><span class="hljs-params">(XNode context, List&lt;ResultMapping&gt; resultMappings)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// 处理association|collection|case</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;association&quot;</span>.equals(context.getName())<br>        || <span class="hljs-string">&quot;collection&quot;</span>.equals(context.getName())<br>        || <span class="hljs-string">&quot;case&quot;</span>.equals(context.getName())) &#123;<br><br>      <span class="hljs-comment">//   &lt;resultMap id=&quot;blogResult&quot; type=&quot;Blog&quot;&gt;</span><br>      <span class="hljs-comment">//      &lt;association property=&quot;author&quot; column=&quot;author_id&quot; javaType=&quot;Author&quot; select=&quot;selectAuthor&quot;/&gt;</span><br>      <span class="hljs-comment">//   &lt;/resultMap&gt;</span><br>      <span class="hljs-comment">//如果不是嵌套查询</span><br>      <span class="hljs-keyword">if</span> (context.getStringAttribute(<span class="hljs-string">&quot;select&quot;</span>) == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//则递归调用5.1 resultMapElement</span><br>        <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> resultMapElement(context, resultMappings);<br>        <span class="hljs-keyword">return</span> resultMap.getId();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-comment">//解析result map的discriminator</span><br>  <span class="hljs-comment">//&lt;discriminator javaType=&quot;int&quot; column=&quot;draft&quot;&gt;</span><br>  <span class="hljs-comment">//  &lt;case value=&quot;1&quot; resultType=&quot;DraftPost&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/discriminator&gt;</span><br>  <span class="hljs-keyword">private</span> Discriminator <span class="hljs-title function_">processDiscriminatorElement</span><span class="hljs-params">(XNode context, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;column&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">javaType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;jdbcType&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">typeHandler</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;typeHandler&quot;</span>);<br>    Class&lt;?&gt; javaTypeClass = resolveClass(javaType);<br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt;) resolveClass(typeHandler);<br>    <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcTypeEnum</span> <span class="hljs-operator">=</span> resolveJdbcType(jdbcType);<br>    Map&lt;String, String&gt; discriminatorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br>    <span class="hljs-keyword">for</span> (XNode caseChild : context.getChildren()) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> caseChild.getStringAttribute(<span class="hljs-string">&quot;value&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> caseChild.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>, processNestedResultMappings(caseChild, resultMappings));<br>      discriminatorMap.put(value, resultMap);<br>    &#125;<br>    <span class="hljs-keyword">return</span> builderAssistant.buildDiscriminator(resultType, column, javaTypeClass, jdbcTypeEnum, typeHandlerClass, discriminatorMap);<br>  &#125; <br><br>  <span class="hljs-comment">//6 配置sql(定义可重用的 SQL 代码段)</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sqlElement</span><span class="hljs-params">(List&lt;XNode&gt; list)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (configuration.getDatabaseId() != <span class="hljs-literal">null</span>) &#123;<br>      sqlElement(list, configuration.getDatabaseId());<br>    &#125;<br>    sqlElement(list, <span class="hljs-literal">null</span>);<br>  &#125; <br><br>  <span class="hljs-comment">//6.1 配置sql</span><br>  <span class="hljs-comment">//&lt;sql id=&quot;userColumns&quot;&gt; id,username,password &lt;/sql&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sqlElement</span><span class="hljs-params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">for</span> (XNode context : list) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">databaseId</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>      id = builderAssistant.applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>      <span class="hljs-comment">//比较简单，就是将sql片段放入hashmap,不过此时还没有解析sql片段</span><br>      <span class="hljs-keyword">if</span> (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123;<br>        sqlFragments.put(id, context);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">databaseIdMatchesCurrent</span><span class="hljs-params">(String id, String databaseId, String requiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">if</span> (requiredDatabaseId != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!requiredDatabaseId.equals(databaseId)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (databaseId != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>      <span class="hljs-comment">// skip this fragment if there is a previous one with a not null databaseId</span><br>      <span class="hljs-comment">// 如果有重名的id了</span><br>      <span class="hljs-comment">// &lt;sql id=&quot;userColumns&quot;&gt; id,username,password &lt;/sql&gt;</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sqlFragments.containsKey(id)) &#123;<br>        <span class="hljs-type">XNode</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.sqlFragments.get(id);<br>        <span class="hljs-comment">// 如果之前那个重名的sql id有databaseId，则false，否则难道true？这样新的sql覆盖老的sql？？？</span><br>        <span class="hljs-keyword">if</span> (context.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// 7.配置select|insert|update|delete</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list)</span> &#123;<br>    <span class="hljs-comment">// 调用7.1构建语句</span><br>    <span class="hljs-keyword">if</span> (configuration.getDatabaseId() != <span class="hljs-literal">null</span>) &#123;<br>      buildStatementFromContext(list, configuration.getDatabaseId());<br>    &#125;<br>    buildStatementFromContext(list, <span class="hljs-literal">null</span>);<br>  &#125; <br><br>  <span class="hljs-comment">// 7.1构建语句</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">for</span> (XNode context : list) &#123;<br>      <span class="hljs-comment">// 构建所有语句,一个mapper下可以有很多select</span><br>      <span class="hljs-comment">// 语句比较复杂，核心都在这里面，所以调用XMLStatementBuilder</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">XMLStatementBuilder</span> <span class="hljs-variable">statementParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLStatementBuilder</span>(configuration, builderAssistant, context, requiredDatabaseId);<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 核心XMLStatementBuilder.parseStatementNode</span><br>        statementParser.parseStatementNode();<br>      &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>        <span class="hljs-comment">// 如果出现SQL语句不完整，把它记下来，塞到configuration去</span><br>        configuration.addIncompleteStatement(statementParser);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 7.1构建语句</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">for</span> (XNode context : list) &#123;<br>      <span class="hljs-comment">// 构建所有语句,一个mapper下可以有很多select</span><br>      <span class="hljs-comment">// 语句比较复杂，核心都在这里面，所以调用XMLStatementBuilder</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">XMLStatementBuilder</span> <span class="hljs-variable">statementParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLStatementBuilder</span>(configuration, builderAssistant, context, requiredDatabaseId);<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 核心XMLStatementBuilder.parseStatementNode</span><br>        statementParser.parseStatementNode();<br>      &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>        <span class="hljs-comment">// 如果出现SQL语句不完整，把它记下来，塞到configuration去</span><br>        configuration.addIncompleteStatement(statementParser);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bindMapperForNamespace</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> builderAssistant.getCurrentNamespace();<br>    <span class="hljs-keyword">if</span> (namespace != <span class="hljs-literal">null</span>) &#123;<br>      Class&lt;?&gt; boundType = <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        boundType = Resources.classForName(namespace);<br>      &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>        <span class="hljs-comment">//ignore, bound type is not required</span><br>      &#125;<br>      <span class="hljs-keyword">if</span> (boundType != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!configuration.hasMapper(boundType)) &#123;<br>          <span class="hljs-comment">// Spring may not know the real resource name so we set a flag</span><br>          <span class="hljs-comment">// to prevent loading again this resource from the mapper interface</span><br>          <span class="hljs-comment">// look at MapperAnnotationBuilder#loadXmlResource</span><br>          configuration.addLoadedResource(<span class="hljs-string">&quot;namespace:&quot;</span> + namespace);<br>          configuration.addMapper(boundType);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parsePendingResultMaps</span><span class="hljs-params">()</span> &#123;<br>    Collection&lt;ResultMapResolver&gt; incompleteResultMaps = configuration.getIncompleteResultMaps();<br>    <span class="hljs-keyword">synchronized</span> (incompleteResultMaps) &#123;<br>      Iterator&lt;ResultMapResolver&gt; iter = incompleteResultMaps.iterator();<br>      <span class="hljs-keyword">while</span> (iter.hasNext()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          iter.next().resolve();<br>          iter.remove();<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>          <span class="hljs-comment">// ResultMap is still missing a resource...</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parsePendingChacheRefs</span><span class="hljs-params">()</span> &#123;<br>    Collection&lt;CacheRefResolver&gt; incompleteCacheRefs = configuration.getIncompleteCacheRefs();<br>    <span class="hljs-keyword">synchronized</span> (incompleteCacheRefs) &#123;<br>      Iterator&lt;CacheRefResolver&gt; iter = incompleteCacheRefs.iterator();<br>      <span class="hljs-keyword">while</span> (iter.hasNext()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          iter.next().resolveCacheRef();<br>          iter.remove();<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>          <span class="hljs-comment">// Cache ref is still missing a resource...</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parsePendingStatements</span><span class="hljs-params">()</span> &#123;<br>    Collection&lt;XMLStatementBuilder&gt; incompleteStatements = configuration.getIncompleteStatements();<br>    <span class="hljs-keyword">synchronized</span> (incompleteStatements) &#123;<br>      Iterator&lt;XMLStatementBuilder&gt; iter = incompleteStatements.iterator();<br>      <span class="hljs-keyword">while</span> (iter.hasNext()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          iter.next().parseStatementNode();<br>          iter.remove();<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>          <span class="hljs-comment">// Statement is still missing a resource...</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ProviderSqlSource"><a href="#ProviderSqlSource" class="headerlink" title="ProviderSqlSource"></a>ProviderSqlSource</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderSqlSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSource</span> &#123; <br><br>  <span class="hljs-keyword">private</span> SqlSourceBuilder sqlSourceParser;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; providerType;<br>  <span class="hljs-keyword">private</span> Method providerMethod;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> providerTakesParameterObject; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ProviderSqlSource</span><span class="hljs-params">(Configuration config, Object provider)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">providerMethodName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-built_in">this</span>.sqlSourceParser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSourceBuilder</span>(config); <br>      <span class="hljs-comment">// sql源码提供类</span><br>      <span class="hljs-built_in">this</span>.providerType = (Class&lt;?&gt;) provider.getClass().getMethod(<span class="hljs-string">&quot;type&quot;</span>).invoke(provider);<br>      <span class="hljs-comment">// sql源码提供类具体提供sql源码的函数名</span><br>      providerMethodName = (String) provider.getClass().getMethod(<span class="hljs-string">&quot;method&quot;</span>).invoke(provider);<br><br>      <span class="hljs-keyword">for</span> (Method m : <span class="hljs-built_in">this</span>.providerType.getMethods()) &#123;<br>        <span class="hljs-keyword">if</span> (providerMethodName.equals(m.getName())) &#123;<br>          <span class="hljs-keyword">if</span> (m.getParameterTypes().length &lt; <span class="hljs-number">2</span><br>              &amp;&amp; m.getReturnType() == String.class) &#123;<br>            <span class="hljs-built_in">this</span>.providerMethod = m;<br>            <span class="hljs-built_in">this</span>.providerTakesParameterObject = m.getParameterTypes().length == <span class="hljs-number">1</span>;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error creating SqlSource for SqlProvider.  Cause: &quot;</span> + e, e);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.providerMethod == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error creating SqlSource for SqlProvider. Method &#x27;&quot;</span><br>          + providerMethodName + <span class="hljs-string">&quot;&#x27; not found in SqlProvider &#x27;&quot;</span> + <span class="hljs-built_in">this</span>.providerType.getName() + <span class="hljs-string">&quot;&#x27;.&quot;</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">(Object parameterObject)</span> &#123;<br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> createSqlSource(parameterObject);<br>    <span class="hljs-keyword">return</span> sqlSource.getBoundSql(parameterObject);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> SqlSource <span class="hljs-title function_">createSqlSource</span><span class="hljs-params">(Object parameterObject)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      String sql;<br>      <span class="hljs-keyword">if</span> (providerTakesParameterObject) &#123;<br>        sql = (String) providerMethod.invoke(providerType.newInstance(), parameterObject);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        sql = (String) providerMethod.invoke(providerType.newInstance());<br>      &#125;<br>      Class&lt;?&gt; parameterType = parameterObject == <span class="hljs-literal">null</span> ? Object.class : parameterObject.getClass();<br>      <span class="hljs-keyword">return</span> sqlSourceParser.parse(sql, parameterType, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;());<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error invoking SqlProvider method (&quot;</span><br>          + providerType.getName() + <span class="hljs-string">&quot;.&quot;</span> + providerMethod.getName()<br>          + <span class="hljs-string">&quot;).  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="MapperAnnotationBuilder"><a href="#MapperAnnotationBuilder" class="headerlink" title="MapperAnnotationBuilder"></a>MapperAnnotationBuilder</h4><p>    注解方式构建mapper，一般不用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperAnnotationBuilder</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt; sqlAnnotationTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt; sqlProviderAnnotationTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt;(); <br><br>  <span class="hljs-keyword">private</span> Configuration configuration;<br>  <span class="hljs-keyword">private</span> MapperBuilderAssistant assistant;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; type; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperAnnotationBuilder</span><span class="hljs-params">(Configuration configuration, Class&lt;?&gt; type)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> type.getName().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>) + <span class="hljs-string">&quot;.java (best guess)&quot;</span>;<br>    <span class="hljs-built_in">this</span>.assistant = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperBuilderAssistant</span>(configuration, resource);<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.type = type;<br><br>    sqlAnnotationTypes.add(Select.class);<br>    sqlAnnotationTypes.add(Insert.class);<br>    sqlAnnotationTypes.add(Update.class);<br>    sqlAnnotationTypes.add(Delete.class);<br><br>    sqlProviderAnnotationTypes.add(SelectProvider.class);<br>    sqlProviderAnnotationTypes.add(InsertProvider.class);<br>    sqlProviderAnnotationTypes.add(UpdateProvider.class);<br>    sqlProviderAnnotationTypes.add(DeleteProvider.class);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> type.toString();<br>    <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123; <br>      <span class="hljs-comment">// 加载对应的xml文件</span><br>      loadXmlResource();<br>      configuration.addLoadedResource(resource);<br>      assistant.setCurrentNamespace(type.getName());<br>      parseCache();<br>      parseCacheRef();<br>      Method[] methods = type.getMethods();<br>      <span class="hljs-keyword">for</span> (Method method : methods) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// issue #237</span><br>          <span class="hljs-keyword">if</span> (!method.isBridge()) &#123;<br>            parseStatement(method);<br>          &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>          configuration.addIncompleteMethod(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodResolver</span>(<span class="hljs-built_in">this</span>, method));<br>        &#125;<br>      &#125;<br>    &#125;<br>    parsePendingMethods();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadXmlResource</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Spring may not know the real resource name so we check a flag</span><br>    <span class="hljs-comment">// to prevent loading again a resource twice</span><br>    <span class="hljs-comment">// this flag is set at XMLMapperBuilder#bindMapperForNamespace</span><br>    <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(<span class="hljs-string">&quot;namespace:&quot;</span> + type.getName())) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">xmlResource</span> <span class="hljs-operator">=</span> type.getName().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>) + <span class="hljs-string">&quot;.xml&quot;</span>;<br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        inputStream = Resources.getResourceAsStream(type.getClassLoader(), xmlResource);<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-comment">// ignore, resource is not required</span><br>      &#125;<br>      <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">XMLMapperBuilder</span> <span class="hljs-variable">xmlParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperBuilder</span>(inputStream, assistant.getConfiguration(), xmlResource, configuration.getSqlFragments(), type.getName());<br>        xmlParser.parse();<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// CacheNamespace 定义的操作会覆盖xml文件中的相同操作</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseCache</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">CacheNamespace</span> <span class="hljs-variable">cacheDomain</span> <span class="hljs-operator">=</span> type.getAnnotation(CacheNamespace.class);<br>    <span class="hljs-keyword">if</span> (cacheDomain != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> cacheDomain.size() == <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : cacheDomain.size();<br>      <span class="hljs-type">Long</span> <span class="hljs-variable">flushInterval</span> <span class="hljs-operator">=</span> cacheDomain.flushInterval() == <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : cacheDomain.flushInterval();<br>      assistant.useNewCache(cacheDomain.implementation(), cacheDomain.eviction(), flushInterval, size, cacheDomain.readWrite(), cacheDomain.blocking(), <span class="hljs-literal">null</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseCacheRef</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">CacheNamespaceRef</span> <span class="hljs-variable">cacheDomainRef</span> <span class="hljs-operator">=</span> type.getAnnotation(CacheNamespaceRef.class);<br>    <span class="hljs-keyword">if</span> (cacheDomainRef != <span class="hljs-literal">null</span>) &#123;<br>      assistant.useCacheRef(cacheDomainRef.value().getName());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseStatement</span><span class="hljs-params">(Method method)</span> &#123;<br>    Class&lt;?&gt; parameterTypeClass = getParameterType(method);<br>    <span class="hljs-type">LanguageDriver</span> <span class="hljs-variable">languageDriver</span> <span class="hljs-operator">=</span> getLanguageDriver(method);<br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> getSqlSourceFromAnnotations(method, parameterTypeClass, languageDriver);<br>    <span class="hljs-keyword">if</span> (sqlSource != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Options</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> method.getAnnotation(Options.class);<br>      <span class="hljs-comment">// mappedStatementId 由 类名.方法名 组成</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">mappedStatementId</span> <span class="hljs-operator">=</span> type.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName();<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-type">StatementType</span> <span class="hljs-variable">statementType</span> <span class="hljs-operator">=</span> StatementType.PREPARED;<br>      <span class="hljs-type">ResultSetType</span> <span class="hljs-variable">resultSetType</span> <span class="hljs-operator">=</span> ResultSetType.FORWARD_ONLY;<br>      <span class="hljs-comment">// 获取 sql 类型</span><br>      <span class="hljs-type">SqlCommandType</span> <span class="hljs-variable">sqlCommandType</span> <span class="hljs-operator">=</span> getSqlCommandType(method);<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">isSelect</span> <span class="hljs-operator">=</span> sqlCommandType == SqlCommandType.SELECT;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">flushCache</span> <span class="hljs-operator">=</span> !isSelect;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">useCache</span> <span class="hljs-operator">=</span> isSelect;<br><br>      KeyGenerator keyGenerator;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">keyProperty</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;id&quot;</span>;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">keyColumn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>; <br>      <span class="hljs-comment">// INSERT 或者 UPDATE 方法需要考虑是否指定了keyGenerator</span><br>      <span class="hljs-keyword">if</span> (SqlCommandType.INSERT.equals(sqlCommandType) || SqlCommandType.UPDATE.equals(sqlCommandType)) &#123;<br>        <span class="hljs-comment">// first check for SelectKey annotation - that overrides everything else</span><br>        <span class="hljs-type">SelectKey</span> <span class="hljs-variable">selectKey</span> <span class="hljs-operator">=</span> method.getAnnotation(SelectKey.class);<br>        <span class="hljs-keyword">if</span> (selectKey != <span class="hljs-literal">null</span>) &#123;<br>          keyGenerator = handleSelectKeyAnnotation(selectKey, mappedStatementId, getParameterType(method), languageDriver);<br>          keyProperty = selectKey.keyProperty();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options == <span class="hljs-literal">null</span>) &#123;<br>          keyGenerator = configuration.isUseGeneratedKeys() ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jdbc3KeyGenerator</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          keyGenerator = options.useGeneratedKeys() ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jdbc3KeyGenerator</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>          keyProperty = options.keyProperty();<br>          keyColumn = options.keyColumn();<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        keyGenerator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>      &#125;<br><br>      <span class="hljs-comment">// 一些额外选项</span><br>      <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) &#123;<br>        flushCache = options.flushCache();<br>        useCache = options.useCache();<br>        fetchSize = options.fetchSize() &gt; -<span class="hljs-number">1</span> || options.fetchSize() == Integer.MIN_VALUE ? options.fetchSize() : <span class="hljs-literal">null</span>; <span class="hljs-comment">//issue #348</span><br>        timeout = options.timeout() &gt; -<span class="hljs-number">1</span> ? options.timeout() : <span class="hljs-literal">null</span>;<br>        statementType = options.statementType();<br>        resultSetType = options.resultSetType();<br>      &#125;<br><br>      <span class="hljs-type">String</span> <span class="hljs-variable">resultMapId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMapAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(ResultMap.class);<br>      <span class="hljs-keyword">if</span> (resultMapAnnotation != <span class="hljs-literal">null</span>) &#123;<br>        String[] resultMaps = resultMapAnnotation.value();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">for</span> (String resultMap : resultMaps) &#123;<br>          <span class="hljs-keyword">if</span> (sb.length() &gt; <span class="hljs-number">0</span>) &#123;<br>            sb.append(<span class="hljs-string">&quot;,&quot;</span>);<br>          &#125;<br>          sb.append(resultMap);<br>        &#125;<br>        resultMapId = sb.toString();<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isSelect) &#123;<br>        resultMapId = parseResultMap(method);<br>      &#125;<br><br>      assistant.addMappedStatement(<br>          mappedStatementId,<br>          sqlSource,<br>          statementType,<br>          sqlCommandType,<br>          fetchSize,<br>          timeout,<br>          <span class="hljs-comment">// ParameterMapID</span><br>          <span class="hljs-literal">null</span>,<br>          parameterTypeClass,<br>          resultMapId,<br>          getReturnType(method),<br>          resultSetType,<br>          flushCache,<br>          useCache,<br>          <span class="hljs-comment">// TODO issue #577</span><br>          <span class="hljs-literal">false</span>,<br>          keyGenerator,<br>          keyProperty,<br>          keyColumn,<br>          <span class="hljs-comment">// DatabaseID</span><br>          <span class="hljs-literal">null</span>,<br>          languageDriver,<br>          <span class="hljs-comment">// ResultSets</span><br>          <span class="hljs-literal">null</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; getParameterType(Method method) &#123;<br>    Class&lt;?&gt; parameterType = <span class="hljs-literal">null</span>;<br>    Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameterTypes.length; i++) &#123;<br>      <span class="hljs-keyword">if</span> (!RowBounds.class.isAssignableFrom(parameterTypes[i]) &amp;&amp; !ResultHandler.class.isAssignableFrom(parameterTypes[i])) &#123;<br>        <span class="hljs-keyword">if</span> (parameterType == <span class="hljs-literal">null</span>) &#123;<br>          parameterType = parameterTypes[i];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// issue #135</span><br>          <span class="hljs-comment">// 存在多个参数的话，设置为 ParamMap</span><br>          parameterType = ParamMap.class;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> parameterType;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> LanguageDriver <span class="hljs-title function_">getLanguageDriver</span><span class="hljs-params">(Method method)</span> &#123;<br>    <span class="hljs-type">Lang</span> <span class="hljs-variable">lang</span> <span class="hljs-operator">=</span> method.getAnnotation(Lang.class);<br>    Class&lt;?&gt; langClass = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (lang != <span class="hljs-literal">null</span>) &#123;<br>      langClass = lang.value();<br>    &#125;<br>    <span class="hljs-keyword">return</span> assistant.getLanguageDriver(langClass);<br>  &#125; <br><br>  <span class="hljs-comment">// 将注解的内容转换为 SqlSource</span><br>  <span class="hljs-keyword">private</span> SqlSource <span class="hljs-title function_">getSqlSourceFromAnnotations</span><span class="hljs-params">(Method method, Class&lt;?&gt; parameterType, LanguageDriver languageDriver)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; sqlAnnotationType = getSqlAnnotationType(method);<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; sqlProviderAnnotationType = getSqlProviderAnnotationType(method);<br>      <span class="hljs-comment">// Select | Insert | Update | Delete 和</span><br>      <span class="hljs-comment">// SelectProvider | InsertProvider | UpdateProvider | DeleteProvider不能共存</span><br>      <span class="hljs-keyword">if</span> (sqlAnnotationType != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (sqlProviderAnnotationType != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;You cannot supply both a static SQL and SqlProvider to method named &quot;</span> + method.getName());<br>        &#125;<br>        <span class="hljs-type">Annotation</span> <span class="hljs-variable">sqlAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(sqlAnnotationType);<br>        <span class="hljs-keyword">final</span> String[] strings = (String[]) sqlAnnotation.getClass().getMethod(<span class="hljs-string">&quot;value&quot;</span>).invoke(sqlAnnotation);<br>        <span class="hljs-keyword">return</span> buildSqlSourceFromStrings(strings, parameterType, languageDriver);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sqlProviderAnnotationType != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Annotation</span> <span class="hljs-variable">sqlProviderAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(sqlProviderAnnotationType);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderSqlSource</span>(assistant.getConfiguration(), sqlProviderAnnotation);<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Could not find value method on SQL annotation.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; getSqlAnnotationType(Method method) &#123;<br>    <span class="hljs-keyword">return</span> chooseAnnotationType(method, sqlAnnotationTypes);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; getSqlProviderAnnotationType(Method method) &#123;<br>    <span class="hljs-keyword">return</span> chooseAnnotationType(method, sqlProviderAnnotationTypes);                    <br>  &#125;<br>  <span class="hljs-comment">// 就是一个一个注解找</span><br>  <span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; chooseAnnotationType(Method method, Set&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt; types) &#123;<br>    <span class="hljs-keyword">for</span> (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type : types) &#123;<br>      <span class="hljs-type">Annotation</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> method.getAnnotation(type);<br>      <span class="hljs-keyword">if</span> (annotation != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> type;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;  <br><br>  <span class="hljs-keyword">private</span> SqlSource <span class="hljs-title function_">buildSqlSourceFromStrings</span><span class="hljs-params">(String[] strings, Class&lt;?&gt; parameterTypeClass, LanguageDriver languageDriver)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">for</span> (String fragment : strings) &#123;<br>      sql.append(fragment);<br>      sql.append(<span class="hljs-string">&quot; &quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> languageDriver.createSqlSource(configuration, sql.toString(), parameterTypeClass);<br>  &#125; <br><br>  <span class="hljs-comment">// 往configuration 添加了 id-&gt;SelectKeyGenerator 的映射</span><br>  <span class="hljs-keyword">private</span> KeyGenerator <span class="hljs-title function_">handleSelectKeyAnnotation</span><span class="hljs-params">(SelectKey selectKeyAnnotation, String baseStatementId, Class&lt;?&gt; parameterTypeClass, LanguageDriver languageDriver)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> baseStatementId + SelectKeyGenerator.SELECT_KEY_SUFFIX;<br>    Class&lt;?&gt; resultTypeClass = selectKeyAnnotation.resultType();<br>    <span class="hljs-type">StatementType</span> <span class="hljs-variable">statementType</span> <span class="hljs-operator">=</span> selectKeyAnnotation.statementType();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyProperty</span> <span class="hljs-operator">=</span> selectKeyAnnotation.keyProperty();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyColumn</span> <span class="hljs-operator">=</span> selectKeyAnnotation.keyColumn();<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">executeBefore</span> <span class="hljs-operator">=</span> selectKeyAnnotation.before();<br><br>    <span class="hljs-comment">// defaults</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">useCache</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">flushCache</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">parameterMap</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">ResultSetType</span> <span class="hljs-variable">resultSetTypeEnum</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> buildSqlSourceFromStrings(selectKeyAnnotation.statement(), parameterTypeClass, languageDriver);<br>    <span class="hljs-type">SqlCommandType</span> <span class="hljs-variable">sqlCommandType</span> <span class="hljs-operator">=</span> SqlCommandType.SELECT;<br><br>    assistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType, fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass, resultSetTypeEnum,<br>        flushCache, useCache, <span class="hljs-literal">false</span>,<br>        keyGenerator, keyProperty, keyColumn, <span class="hljs-literal">null</span>, languageDriver, <span class="hljs-literal">null</span>);<br><br>    id = assistant.applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br><br>    <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">keyStatement</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(id, <span class="hljs-literal">false</span>);<br>    <span class="hljs-type">SelectKeyGenerator</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SelectKeyGenerator</span>(keyStatement, executeBefore);<br>    configuration.addKeyGenerator(id, answer);<br>    <span class="hljs-keyword">return</span> answer;<br>  &#125; <br><br>  <span class="hljs-comment">// 方法没有@ResultMap注解时根据其他注解获取ResultMap信息</span><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">parseResultMap</span><span class="hljs-params">(Method method)</span> &#123;<br>    Class&lt;?&gt; returnType = getReturnType(method);<br>    <span class="hljs-type">ConstructorArgs</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> method.getAnnotation(ConstructorArgs.class);<br>    <span class="hljs-type">Results</span> <span class="hljs-variable">results</span> <span class="hljs-operator">=</span> method.getAnnotation(Results.class);<br>    <span class="hljs-type">TypeDiscriminator</span> <span class="hljs-variable">typeDiscriminator</span> <span class="hljs-operator">=</span> method.getAnnotation(TypeDiscriminator.class);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultMapId</span> <span class="hljs-operator">=</span> generateResultMapName(method);<br>    applyResultMap(resultMapId, returnType, argsIf(args), resultsIf(results), typeDiscriminator);<br>    <span class="hljs-keyword">return</span> resultMapId;<br>  &#125; <br><br>  <span class="hljs-comment">// 获取方法对应的sql语句的返回值类型</span><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; getReturnType(Method method) &#123;<br>    Class&lt;?&gt; returnType = method.getReturnType();<br>    <span class="hljs-comment">// issue #508</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">void</span>.class.equals(returnType)) &#123;<br>      <span class="hljs-type">ResultType</span> <span class="hljs-variable">rt</span> <span class="hljs-operator">=</span> method.getAnnotation(ResultType.class);<br>      <span class="hljs-keyword">if</span> (rt != <span class="hljs-literal">null</span>) &#123;<br>        returnType = rt.value();<br>      &#125; <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Collection.class.isAssignableFrom(returnType)) &#123;<br>      <span class="hljs-type">Type</span> <span class="hljs-variable">returnTypeParameter</span> <span class="hljs-operator">=</span> method.getGenericReturnType();<br>      <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>        Type[] actualTypeArguments = ((ParameterizedType) returnTypeParameter).getActualTypeArguments();<br>        <span class="hljs-keyword">if</span> (actualTypeArguments != <span class="hljs-literal">null</span> &amp;&amp; actualTypeArguments.length == <span class="hljs-number">1</span>) &#123;<br>          returnTypeParameter = actualTypeArguments[<span class="hljs-number">0</span>];<br>          <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> Class) &#123;<br>            returnType = (Class&lt;?&gt;) returnTypeParameter;<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>            <span class="hljs-comment">// (issue #443) actual type can be a also a parameterized type</span><br>            returnType = (Class&lt;?&gt;) ((ParameterizedType) returnTypeParameter).getRawType();<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> GenericArrayType) &#123;<br>            Class&lt;?&gt; componentType = (Class&lt;?&gt;) ((GenericArrayType) returnTypeParameter).getGenericComponentType();<br>            <span class="hljs-comment">// (issue #525) support List&lt;byte[]&gt;</span><br>            returnType = Array.newInstance(componentType, <span class="hljs-number">0</span>).getClass();<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.isAnnotationPresent(MapKey.class) &amp;&amp; Map.class.isAssignableFrom(returnType)) &#123;<br>      <span class="hljs-comment">// (issue 504) Do not look into Maps if there is not MapKey annotation</span><br>      <span class="hljs-type">Type</span> <span class="hljs-variable">returnTypeParameter</span> <span class="hljs-operator">=</span> method.getGenericReturnType();<br>      <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>        Type[] actualTypeArguments = ((ParameterizedType) returnTypeParameter).getActualTypeArguments();<br>        <span class="hljs-keyword">if</span> (actualTypeArguments != <span class="hljs-literal">null</span> &amp;&amp; actualTypeArguments.length == <span class="hljs-number">2</span>) &#123;<br>          returnTypeParameter = actualTypeArguments[<span class="hljs-number">1</span>];<br>          <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> Class) &#123;<br>            returnType = (Class&lt;?&gt;) returnTypeParameter;<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>            <span class="hljs-comment">// (issue 443) actual type can be a also a parameterized type</span><br>            returnType = (Class&lt;?&gt;) ((ParameterizedType) returnTypeParameter).getRawType();<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> returnType;<br>  &#125; <br><br>  <span class="hljs-comment">// resultMapName形如</span><br>  <span class="hljs-comment">// 类名.方法名-void(-参数1类型-参数2类型-...)</span><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateResultMapName</span><span class="hljs-params">(Method method)</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">suffix</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">for</span> (Class&lt;?&gt; c : method.getParameterTypes()) &#123;<br>      suffix.append(<span class="hljs-string">&quot;-&quot;</span>);<br>      suffix.append(c.getSimpleName());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (suffix.length() &lt; <span class="hljs-number">1</span>) &#123;<br>      suffix.append(<span class="hljs-string">&quot;-void&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> type.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName() + suffix;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Arg[] argsIf(ConstructorArgs args) &#123;<br>    <span class="hljs-keyword">return</span> args == <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Arg</span>[<span class="hljs-number">0</span>] : args.value();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Result[] resultsIf(Results results) &#123;<br>    <span class="hljs-keyword">return</span> results == <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>[<span class="hljs-number">0</span>] : results.value();<br>  &#125; <br><br>  <span class="hljs-comment">// @Arg 用于描述构造方法参数的映射关系，</span><br>  <span class="hljs-comment">// 而 @Result 用于描述 JavaBean 属性与数据库列之间的映射关系</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyResultMap</span><span class="hljs-params">(String resultMapId, Class&lt;?&gt; returnType, Arg[] args, Result[] results, TypeDiscriminator discriminator)</span> &#123;<br>    List&lt;ResultMapping&gt; resultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>    applyConstructorArgs(args, returnType, resultMappings);<br>    applyResults(results, returnType, resultMappings);<br>    <span class="hljs-type">Discriminator</span> <span class="hljs-variable">disc</span> <span class="hljs-operator">=</span> applyDiscriminator(resultMapId, returnType, discriminator);<br>    <span class="hljs-comment">// TODO add AutoMappingBehaviour</span><br>    assistant.addResultMap(resultMapId, returnType, <span class="hljs-literal">null</span>, disc, resultMappings, <span class="hljs-literal">null</span>);<br>    createDiscriminatorResultMaps(resultMapId, returnType, discriminator);<br>  &#125; <br><br>  <span class="hljs-comment">// 通过 @Arg 注解的内容构造 ResultMapping</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyConstructorArgs</span><span class="hljs-params">(Arg[] args, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> &#123;<br>    <span class="hljs-keyword">for</span> (Arg arg : args) &#123;<br>      List&lt;ResultFlag&gt; flags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;();<br>      flags.add(ResultFlag.CONSTRUCTOR);<br>      <span class="hljs-keyword">if</span> (arg.id()) &#123;<br>        flags.add(ResultFlag.ID);<br>      &#125;<br>      <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">resultMapping</span> <span class="hljs-operator">=</span> assistant.buildResultMapping(<br>          resultType,<br>          <span class="hljs-literal">null</span>,<br>          nullOrEmpty(arg.column()),<br>          arg.javaType() == <span class="hljs-keyword">void</span>.class ? <span class="hljs-literal">null</span> : arg.javaType(),<br>          arg.jdbcType() == JdbcType.UNDEFINED ? <span class="hljs-literal">null</span> : arg.jdbcType(),<br>          nullOrEmpty(arg.select()),<br>          nullOrEmpty(arg.resultMap()),<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          arg.typeHandler() == UnknownTypeHandler.class ? <span class="hljs-literal">null</span> : arg.typeHandler(),<br>          flags,<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">false</span>);<br>      resultMappings.add(resultMapping);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 与 applyConstructorArgs 类似</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyResults</span><span class="hljs-params">(Result[] results, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> &#123;<br>    <span class="hljs-keyword">for</span> (Result result : results) &#123;<br>      List&lt;ResultFlag&gt; flags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;();<br>      <span class="hljs-keyword">if</span> (result.id()) &#123;<br>        flags.add(ResultFlag.ID);<br>      &#125;<br>      <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">resultMapping</span> <span class="hljs-operator">=</span> assistant.buildResultMapping(<br>          resultType,<br>          nullOrEmpty(result.property()),<br>          nullOrEmpty(result.column()),<br>          result.javaType() == <span class="hljs-keyword">void</span>.class ? <span class="hljs-literal">null</span> : result.javaType(),<br>          result.jdbcType() == JdbcType.UNDEFINED ? <span class="hljs-literal">null</span> : result.jdbcType(),<br>          hasNestedSelect(result) ? nestedSelectId(result) : <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          result.typeHandler() == UnknownTypeHandler.class ? <span class="hljs-literal">null</span> : result.typeHandler(),<br>          flags,<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          isLazy(result));<br>      resultMappings.add(resultMapping);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNestedSelect</span><span class="hljs-params">(Result result)</span> &#123;<br>    <span class="hljs-keyword">if</span> (result.one().select().length() &gt; <span class="hljs-number">0</span> &amp;&amp; result.many().select().length() &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Cannot use both @One and @Many annotations in the same @Result&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> result.one().select().length() &gt; <span class="hljs-number">0</span> || result.many().select().length() &gt; <span class="hljs-number">0</span>;  <br>  &#125;  <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">nestedSelectId</span><span class="hljs-params">(Result result)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">nestedSelect</span> <span class="hljs-operator">=</span> result.one().select();<br>    <span class="hljs-keyword">if</span> (nestedSelect.length() &lt; <span class="hljs-number">1</span>) &#123;<br>      nestedSelect = result.many().select();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!nestedSelect.contains(<span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>      nestedSelect = type.getName() + <span class="hljs-string">&quot;.&quot;</span> + nestedSelect;<br>    &#125;<br>    <span class="hljs-keyword">return</span> nestedSelect;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLazy</span><span class="hljs-params">(Result result)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLazy</span> <span class="hljs-operator">=</span> configuration.isLazyLoadingEnabled();<br>    <span class="hljs-keyword">if</span> (result.one().select().length() &gt; <span class="hljs-number">0</span> &amp;&amp; FetchType.DEFAULT != result.one().fetchType()) &#123;<br>      isLazy = (result.one().fetchType() == FetchType.LAZY);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result.many().select().length() &gt; <span class="hljs-number">0</span> &amp;&amp; FetchType.DEFAULT != result.many().fetchType()) &#123;<br>      isLazy = (result.many().fetchType() == FetchType.LAZY);<br>    &#125;<br>    <span class="hljs-keyword">return</span> isLazy;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> Discriminator <span class="hljs-title function_">applyDiscriminator</span><span class="hljs-params">(String resultMapId, Class&lt;?&gt; resultType, TypeDiscriminator discriminator)</span> &#123;<br>    <span class="hljs-keyword">if</span> (discriminator != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> discriminator.column();<br>      Class&lt;?&gt; javaType = discriminator.javaType() == <span class="hljs-keyword">void</span>.class ? String.class : discriminator.javaType();<br>      <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> discriminator.jdbcType() == JdbcType.UNDEFINED ? <span class="hljs-literal">null</span> : discriminator.jdbcType();<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandler = discriminator.typeHandler() == UnknownTypeHandler.class ? <span class="hljs-literal">null</span> : discriminator.typeHandler();<br>      Case[] cases = discriminator.cases();<br>      Map&lt;String, String&gt; discriminatorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br>      <span class="hljs-keyword">for</span> (Case c : cases) &#123; <br>        <span class="hljs-comment">// case为value时对应的 resultMapId</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> c.value();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">caseResultMapId</span> <span class="hljs-operator">=</span> resultMapId + <span class="hljs-string">&quot;-&quot;</span> + value;<br>        discriminatorMap.put(value, caseResultMapId);<br>      &#125;<br>      <span class="hljs-keyword">return</span> assistant.buildDiscriminator(resultType, column, javaType, jdbcType, typeHandler, discriminatorMap);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// 根据@Case 注解 添加ResultMap</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createDiscriminatorResultMaps</span><span class="hljs-params">(String resultMapId, Class&lt;?&gt; resultType, TypeDiscriminator discriminator)</span> &#123;<br>    <span class="hljs-keyword">if</span> (discriminator != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (Case c : discriminator.cases()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">caseResultMapId</span> <span class="hljs-operator">=</span> resultMapId + <span class="hljs-string">&quot;-&quot;</span> + c.value();<br>        List&lt;ResultMapping&gt; resultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>        <span class="hljs-comment">// issue #136</span><br>        applyConstructorArgs(c.constructArgs(), resultType, resultMappings);<br>        applyResults(c.results(), resultType, resultMappings);<br>        <span class="hljs-comment">// TODO add AutoMappingBehaviour</span><br>        assistant.addResultMap(caseResultMapId, c.type(), resultMapId, <span class="hljs-literal">null</span>, resultMappings, <span class="hljs-literal">null</span>);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parsePendingMethods</span><span class="hljs-params">()</span> &#123;<br>    Collection&lt;MethodResolver&gt; incompleteMethods = configuration.getIncompleteMethods();<br>    <span class="hljs-keyword">synchronized</span> (incompleteMethods) &#123;<br>      Iterator&lt;MethodResolver&gt; iter = incompleteMethods.iterator();<br>      <span class="hljs-keyword">while</span> (iter.hasNext()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          iter.next().resolve();<br>          iter.remove();<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>          <span class="hljs-comment">// This method is still missing a resource</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="MethodResolver"><a href="#MethodResolver" class="headerlink" title="MethodResolver"></a>MethodResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodResolver</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MapperAnnotationBuilder annotationBuilder;<br>  <span class="hljs-keyword">private</span> Method method;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MethodResolver</span><span class="hljs-params">(MapperAnnotationBuilder annotationBuilder, Method method)</span> &#123;<br>    <span class="hljs-built_in">this</span>.annotationBuilder = annotationBuilder;<br>    <span class="hljs-built_in">this</span>.method = method;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolve</span><span class="hljs-params">()</span> &#123;<br>    annotationBuilder.parseStatement(method);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h4><p>    annotations模块略过，感兴趣的同学可以自行查阅相关注解的用法</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Mybatis%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" class="category-chain-item">Mybatis源码解析</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Mybatis/">#Mybatis</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
<!--    <div class="license-title">-->
<!--      <div>14-builder</div>-->
<!--      <div>https://xiaohuanxiong3.github.io/2023/08/16/14-builder/</div>-->
<!--    </div>-->
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Handsome Young</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年8月16日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            MIT
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/08/27/15-binding/" title="15-binding">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">15-binding</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/08/05/13-scripting/" title="13-scripting">
                        <span class="hidden-mobile">13-scripting</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div>小浣熊的博客 ｜ 记录有趣的收获</div> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
