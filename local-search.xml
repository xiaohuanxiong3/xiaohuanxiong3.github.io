<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>AIç¼–ç åŠ©æ‰‹é˜¶æ®µæ€§æˆæœ-3</title>
    <link href="/2024/10/19/personal-projects/ai-code-assistant/AI%E7%BC%96%E7%A0%81%E5%8A%A9%E6%89%8B%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C-3/"/>
    <url>/2024/10/19/personal-projects/ai-code-assistant/AI%E7%BC%96%E7%A0%81%E5%8A%A9%E6%89%8B%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C-3/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â æ¼”ç¤ºè§†é¢‘è§ï¼š</p><ol><li><p><a href="https://www.bilibili.com/video/BV1hdC2YPE61/?spm_id_from=333.1365.list.card_archive.click&vd_source=e34a63b22e0fdff3024db1f903163a2c">AIç¼–ç åŠ©æ‰‹é˜¶æ®µæ€§æˆæœ-3.1_å“”å“©å“”å“©_bilibili</a></p></li><li><p><a href="https://www.bilibili.com/video/BV13dC2YPEGZ/?spm_id_from=333.1365.list.card_archive.click&vd_source=e34a63b22e0fdff3024db1f903163a2c">AIç¼–ç åŠ©æ‰‹é˜¶æ®µæ€§æˆæœ-3.2_å“”å“©å“”å“©_bilibili</a></p></li></ol><h3 id="å·²å®ç°åŠŸèƒ½"><a href="#å·²å®ç°åŠŸèƒ½" class="headerlink" title="å·²å®ç°åŠŸèƒ½"></a>å·²å®ç°åŠŸèƒ½</h3><ul><li><p>å¸¦ä¸Šä¸‹æ–‡çš„èŠå¤©ã€ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„èŠå¤©ã€æ¸…ç©ºä¸Šä¸‹æ–‡å¹¶æ–°å»ºèŠå¤©</p></li><li><p>é€šè¿‡Â <code>/</code>Â å”¤èµ· å†…ç½®å‘½ä»¤æ¡†</p><p>ç›®å‰å·²å®ç°å‘½ä»¤å¦‚ä¸‹ï¼š</p><ol><li><p><code>/tab</code>ï¼šå°†å½“å‰æ–‡ä»¶æ·»åŠ åˆ°èŠå¤©ä¸Šä¸‹æ–‡ä¸­</p></li><li><p><code>/clear</code>ï¼šæ¸…ç©ºèŠå¤©ä¸Šä¸‹æ–‡å’Œç°æœ‰æ‰€æœ‰èŠå¤©è®°å½•</p></li></ol></li></ul><ul><li><p>AI å›å¤ä¸­ä»£ç åŒºåŸŸåŠŸèƒ½æ€§æŒ‰é’®</p><p>ç›®å‰å·²å®ç°çš„åŠŸèƒ½æ€§æŒ‰é’®å¦‚ä¸‹ï¼š</p><ol><li><p>å¤åˆ¶ï¼šå¤åˆ¶ä»£ç åŒºåŸŸçš„å†…å®¹åˆ°å‰ªåˆ‡æ¿</p></li><li><p>åº”ç”¨ï¼šå°†ä»£ç åŒºåŸŸçš„å†…å®¹åˆå¹¶åˆ°å½“å‰æ–‡ä»¶ä¸­ï¼ˆåç»­åªèƒ½æœŸå¾…å¤§æ¨¡å‹çš„æ¨ç†é€Ÿåº¦æ›´å¿«æˆ–è€…å¤§æ¨¡å‹èƒ½æ ¹æ®æˆ‘çš„æç¤ºè¯å‡†ç¡®åœ°è¿›è¡Œä»£ç åˆå¹¶ğŸ˜ï¼‰</p><blockquote><p>PSï¼šç°æœ‰çš„ä»£ç åˆå¹¶åŠŸèƒ½è¿˜å¾ˆä¸ç¨³å®šï¼Œä½†æ˜¯ç»è¿‡æˆ‘ä¸æ–­åœ°ä¼˜åŒ–æç¤ºè¯ï¼Œç›®å‰åªèƒ½è¯´å‹‰å¼ºèƒ½ç”¨</p></blockquote></li></ol></li></ul><h3 id="å¾…å®ç°åŠŸèƒ½"><a href="#å¾…å®ç°åŠŸèƒ½" class="headerlink" title="å¾…å®ç°åŠŸèƒ½"></a>å¾…å®ç°åŠŸèƒ½</h3><ul><li><p>ä»£ç è¡¥å…¨</p></li><li><p>å†…è”å¯¹è¯æ¡†ï¼ˆè¿™ä¸ªæˆ‘æ‰“ç®—æŠ„<code>Continue</code>çš„ï¼‰</p></li><li><p>â€¦â€¦</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>ä¸ªäººé¡¹ç›®</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Jetbrains IDE</tag>
      
      <tag>Plugin</tag>
      
      <tag>Personal Projects</tag>
      
      <tag>AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AIç¼–ç åŠ©æ‰‹é˜¶æ®µæ€§æˆæœ-2</title>
    <link href="/2024/10/08/personal-projects/ai-code-assistant/AI%E7%BC%96%E7%A0%81%E5%8A%A9%E6%89%8B%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C-2/"/>
    <url>/2024/10/08/personal-projects/ai-code-assistant/AI%E7%BC%96%E7%A0%81%E5%8A%A9%E6%89%8B%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C-2/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â æ¼”ç¤ºè§†é¢‘è§ <a href="https://www.bilibili.com/video/BV1mE2JYsEjm/?spm_id_from=333.1365.list.card_archive.click">IDEA AIç¼–ç åŠ©æ‰‹é˜¶æ®µæ€§æˆæœ-2_å“”å“©å“”å“©_bilibili</a></p><h3 id="å·²å®ç°åŠŸèƒ½"><a href="#å·²å®ç°åŠŸèƒ½" class="headerlink" title="å·²å®ç°åŠŸèƒ½"></a>å·²å®ç°åŠŸèƒ½</h3><ul><li><p>å¸¦ä¸Šä¸‹æ–‡çš„èŠå¤©ã€ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„èŠå¤©ã€æ¸…ç©ºä¸Šä¸‹æ–‡å¹¶æ–°å»ºèŠå¤©</p></li><li><p>é€šè¿‡ <code>/</code> å”¤èµ· å†…ç½®å‘½ä»¤æ¡†å¹¶å®ç° <code>/tab</code>ã€<code>/clear</code>å‘½ä»¤</p></li><li><p>AI å›å¤ä¸­ä»£ç åŒºåŸŸåŠŸèƒ½æ€§æŒ‰é’®ï¼ˆå¤åˆ¶ç­‰ï¼‰å®ç°</p></li></ul><h3 id="å¾…å®ç°åŠŸèƒ½"><a href="#å¾…å®ç°åŠŸèƒ½" class="headerlink" title="å¾…å®ç°åŠŸèƒ½"></a>å¾…å®ç°åŠŸèƒ½</h3><p>Â Â Â Â åç»­çš„å·¥ä½œä¸»è¦æ˜¯ä»£ç ä¼˜åŒ–ã€æ›´å¤šä¸Šä¸‹æ–‡çš„æ·»åŠ ä»¥åŠå¾ˆé‡è¦çš„å°†å›å¤ä¸­çš„ä»£ç åº”ç”¨åˆ°ç°æœ‰ä»£ç åŠŸèƒ½è°ƒç ”</p><p>Â Â Â Â è¿˜æœ‰æ›´é•¿è¿œçš„å·¥ä½œå¦‚ä»£ç ç´¢å¼•ï¼ˆæš‚æ—¶ä¸æ¸…æ¥šä¸ºä»€ä¹ˆè¦åšä»¥åŠæ€ä¹ˆåšï¼‰ã€ä¸IDEA å¹³å°çš„æ›´åŠ æ·±åº¦åœ°é›†æˆ</p><h3 id="ç¢ç¢å¿µ"><a href="#ç¢ç¢å¿µ" class="headerlink" title="ç¢ç¢å¿µ"></a>ç¢ç¢å¿µ</h3><p>Â Â Â Â æœ¬é¡¹ç›®å‰ç«¯é¡µé¢ç”± cursorï¼ˆç¬¬ä¸€ç‰ˆï¼‰ å’Œ github copilotï¼ˆç¬¬äºŒç‰ˆï¼‰å¤§åŠ›èµåŠ©ï¼ğŸ¤—</p><blockquote><p>å¯¹äºå¤§å‹Java é¡¹ç›®ï¼ˆSpringï¼‰ï¼Œå¦‚æœæ–‡ä»¶å‘½åè§„èŒƒçš„è¯ï¼Œæ„Ÿè§‰å¯ä»¥è€ƒè™‘ ä½¿ç”¨ &#x2F;Controllerã€&#x2F;POç­‰å†…ç½®å‘½ä»¤ç”¨äºå¿«é€Ÿé€‰æ‹©ç›¸å…³ä¸Šä¸‹æ–‡ã€‚</p><p>æ›´å‡†ç¡®ã€æ›´æ–¹ä¾¿çš„ä¸Šä¸‹æ–‡ç»„ç»‡ä»¥åŠé€‰æ‹©çš„å½¢å¼å’Œå®ç°éœ€è¦æ›´å¤šçš„æ€è€ƒ</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>ä¸ªäººé¡¹ç›®</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Jetbrains IDE</tag>
      
      <tag>Plugin</tag>
      
      <tag>Personal Projects</tag>
      
      <tag>AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AIç¼–ç åŠ©æ‰‹é˜¶æ®µæ€§æˆæœ-1</title>
    <link href="/2024/09/21/personal-projects/ai-code-assistant/AI%E7%BC%96%E7%A0%81%E5%8A%A9%E6%89%8B%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C-1/"/>
    <url>/2024/09/21/personal-projects/ai-code-assistant/AI%E7%BC%96%E7%A0%81%E5%8A%A9%E6%89%8B%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C-1/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â æ¼”ç¤ºè§†é¢‘è§ <a href="https://www.bilibili.com/video/BV19FtreAE7W/?spm_id_from=333.1365.list.card_archive.click&vd_source=e34a63b22e0fdff3024db1f903163a2c">IDEA AIç¼–ç åŠ©æ‰‹ é˜¶æ®µæ€§æˆæœ-1_å“”å“©å“”å“©_bilibili</a></p><h3 id="å·²å®ç°åŠŸèƒ½"><a href="#å·²å®ç°åŠŸèƒ½" class="headerlink" title="å·²å®ç°åŠŸèƒ½"></a>å·²å®ç°åŠŸèƒ½</h3><ul><li>æ— ä¸Šä¸‹æ–‡çš„èŠå¤©</li></ul><h3 id="å¾…å®ç°åŠŸèƒ½"><a href="#å¾…å®ç°åŠŸèƒ½" class="headerlink" title="å¾…å®ç°åŠŸèƒ½"></a>å¾…å®ç°åŠŸèƒ½</h3><ul><li><p>UIä¼˜åŒ–ï¼ˆè¿™ä¸ªéšç¼˜å§ï¼‰</p></li><li><p>å¸¦ä¸Šä¸‹æ–‡çš„èŠå¤©ã€ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„èŠå¤©ã€æ¸…ç©ºä¸Šä¸‹æ–‡å¹¶æ–°å»ºèŠå¤©ã€é‡æ–°ç”ŸæˆAIå›å¤</p></li><li><p>AIå›å¤ä¸­ä»£ç åŒºåŸŸåŠŸèƒ½æ€§æŒ‰é’®ï¼ˆå¤åˆ¶ç­‰ï¼‰è°ƒç ”å®ç°</p></li><li><p>â€¦â€¦</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>ä¸ªäººé¡¹ç›®</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Jetbrains IDE</tag>
      
      <tag>Plugin</tag>
      
      <tag>Personal Projects</tag>
      
      <tag>AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä½¿ç”¨Giteaå®ç°æœ¬åœ°åŒ–çš„AIä»£ç å®¡æŸ¥</title>
    <link href="/2024/09/08/personal-projects/%E4%BD%BF%E7%94%A8Gitea%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E5%8C%96%E7%9A%84AI%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5/"/>
    <url>/2024/09/08/personal-projects/%E4%BD%BF%E7%94%A8Gitea%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E5%8C%96%E7%9A%84AI%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â æŸå¤©ä¸Šç½‘å†²æµªæ—¶å‘ç°ä¸€ä¸ªå¼€æºé¡¹ç›®giteaï¼ˆ<a href="https://github.com/go-gitea/gitea">go-gitea&#x2F;gitea: Git with a cup of tea! Painless self-hosted all-in-one software development service, including Git hosting, code review, team collaboration, package registry and CI&#x2F;CD (github.com)</a>ï¼‰ï¼Œè¯•äº†ä¸€ä¸‹åæ„Ÿè§‰å¤ªæ£’äº†ã€‚äºæ˜¯æˆ‘æœæ–­åœ¨åƒç°çš„mac-miniä¸Šéƒ¨ç½²äº†ä¸€å¥—ï¼Œç„¶åå°±å¼€å§‹ç¢ç£¨æ€ä¹ˆä½¿ç”¨giteaå®ŒæˆAIä»£ç å®¡æŸ¥ï¼ˆæ„Ÿè°¢å°å‚…å“¥ï¼ï¼‰</p><h3 id="1-éƒ¨ç½²gitea"><a href="#1-éƒ¨ç½²gitea" class="headerlink" title="1. éƒ¨ç½²gitea"></a>1. éƒ¨ç½²gitea</h3><p>Â Â Â Â éƒ¨ç½²å®Œçš„giteaé•¿ä¸‹é¢çš„æ ·å­ï¼Œä½¿ç”¨å’Œgithubå·®ä¸å¤šï¼Œå°±ä¸å¤šå•°å—¦äº†</p><p><img src="/2024/09/08/personal-projects/%E4%BD%BF%E7%94%A8Gitea%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E5%8C%96%E7%9A%84AI%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5/2024-09-08-21-13-17-image.png"></p><h3 id="2-å®ç°AIä»£ç å®¡æŸ¥"><a href="#2-å®ç°AIä»£ç å®¡æŸ¥" class="headerlink" title="2. å®ç°AIä»£ç å®¡æŸ¥"></a>2. å®ç°AIä»£ç å®¡æŸ¥</h3><p>Â Â Â Â ç”±äºæˆ‘çš„æŠ€æœ¯æ ˆæ˜¯<code>Java</code>ï¼Œæ‰€ä»¥æˆ‘é€‰æ‹©ç”¨<code>Kotlin</code>å®ç°AIä»£ç å®¡æŸ¥çš„å…·ä½“åŠŸèƒ½ï¼ˆå†™ä¹ æƒ¯<code>Kotlin</code>ä¹‹åå‘ç°<code>Kotlin</code>å®åœ¨æ˜¯å¤ªé¦™äº†ï¼ŒåŠ ä¸Š<code>Kotlin</code>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>Java</code>ç”Ÿæ€çš„å¾ˆå¤šç»„ä»¶ï¼Œå¦‚<code>Spring</code>é‚£ä¸€å¥—å¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ï¼‰ã€‚</p><blockquote><p>PSï¼šæ„Ÿè§‰è¿™ç§ä¸šåŠ¡ä¸Šå¹¶ä¸å¤æ‚çš„åŠŸèƒ½å¯ä»¥æ›´è½»é‡çš„å®ç°ï¼Œå¦‚ä½¿ç”¨<code>go</code>ï¼Œå†ä½¿ç”¨å‡½æ•°å³æœåŠ¡ï¼ˆ<code>Faas</code>ï¼‰åº”è¯¥æ˜¯æœ€ä¼˜é›…çš„ã€‚å¥ˆä½•ç›®å‰Javaéƒ½å­¦ä¸è¿‡æ¥äº†ï¼Œå°±ä¸æŠ˜è…¾è¿™ä¹ˆå¤šäº†</p></blockquote><p>Â Â Â Â è°ƒç ”ä¸€ç•ªä¹‹åå†³å®šä½¿ç”¨<code>Spring AI</code>ï¼Œå¤§æ¨¡å‹çš„è¯æŒ‘æŒ‘é€‰é€‰ä¸€ç•ªåå°±å†³å®šæ˜¯<code>DeepSeek</code>äº†ï¼ˆè¿™é‡Œæˆ‘æ˜¯ç”¨äº†äº‘æœåŠ¡ï¼Œå¦‚æœè¿½æ±‚å®Œå…¨çš„æœ¬åœ°åŒ–çš„è¯ä¹Ÿå¯ä»¥åœ¨æœ¬åœ°å¦‚ç”¨<code>ollama</code>éƒ¨ç½²å¤§æ¨¡å‹åä½¿ç”¨<code>Spring AI</code>ç›¸åº”çš„ä¾èµ–å°±è¡Œäº†ï¼‰ã€‚</p><p>Â Â Â Â ç„¶åæ˜¯ç”¨äº† <code>weixin-java-mp</code>å’Œå¾®ä¿¡å…¬ä¼—å·æµ‹è¯•è´¦å·å®ç°æ¨é€æ¨¡æ¿æ¶ˆæ¯ã€‚</p><p>Â Â Â Â è‡³æ­¤æˆ‘æƒ³è¦çš„åŠŸèƒ½å°±å®ç°å¾—å·®ä¸å¤šäº†</p><p>Â Â Â Â ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">    <span class="hljs-meta">@PostMapping(<span class="hljs-string">&quot;code-review&quot;</span>)</span><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">codeReview</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> request: <span class="hljs-type">WebHookRequestDTO</span>)</span></span> &#123;<br>        <span class="hljs-keyword">val</span> diffRequestUrl: String = (Gitea.GITEA_API_URL<br>                + MessageFormat.format(<br>            Gitea.DIFF_REQUEST_PATTERN, request.repository?.owner?.username,<br>            request.repository?.name, request.head_commit?.id<br>        ))<br>        <span class="hljs-keyword">val</span> diffContent = restTemplate.getForEntity(diffRequestUrl, String::<span class="hljs-keyword">class</span>.java).body<br><br>        <span class="hljs-keyword">val</span> prompt =<br>                    <span class="hljs-string">&quot;è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç diffå·®å¼‚å¹¶æä¾›è¯¦ç»†çš„ä»£ç å®¡æŸ¥æ„è§\n&quot;</span> +<br>                    <span class="hljs-string">&quot;é’ˆå¯¹æ–°å¢çš„ä»£ç ï¼Œæä¾›æ”¹è¿›æ„è§ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä»£ç è´¨é‡ã€å¯è¯»æ€§ã€æ€§èƒ½ã€å®‰å…¨æ€§ç­‰æ–¹é¢ï¼Œç»™å‡ºä½ è§‰å¾—éœ€è¦æ”¹è¿›çš„ä»£ç å¹¶æ˜¾ç¤ºæ”¹è¿›å‰åçš„ä»£ç å·®å¼‚\n&quot;</span> +<br>                    <span class="hljs-string">&quot;é’ˆå¯¹åˆ é™¤çš„ä»£ç ï¼Œæå‡ºå¯èƒ½ä¼šé€ æˆçš„å½±å“ï¼Œå¹¶æå‡ºå»ºè®®\n&quot;</span> +<br>                    <span class="hljs-string">&quot;æœ€åï¼Œç»¼åˆæ‰€æœ‰æ›´æ”¹åšä¸ªè¨€ç®€æ„èµ…çš„æ€»ç»“\n&quot;</span> +<br>                    <span class="hljs-string">&quot;<span class="hljs-variable">$diffContent</span>\n&quot;</span><br><br>        coroutineScope.launch &#123;<br>            <span class="hljs-keyword">val</span> content = chatModel.call(<br>                Prompt(<br>                    prompt, OpenAiChatOptions.builder()<br><span class="hljs-comment">//                        .withModel(AIModel.ZHIPU_CODE_MODEL)</span><br><span class="hljs-comment">//                        .withMaxTokens(8192)</span><br>                        .build()<br>                )<br>            ).result.output.content<br><br>            <span class="hljs-keyword">val</span> aiCodeReviewPo = AiCodeReviewPo()<br>            aiCodeReviewPo.userName = request.repository?.owner?.username<br>            aiCodeReviewPo.repositoryName = request.repository?.name<br>            aiCodeReviewPo.commitId = request.head_commit?.id<br>            aiCodeReviewPo.commitUrl = request.head_commit?.url<br>            aiCodeReviewPo.content = content<br>            aiCodeReviewPo.createTime = Date()<br>            mongoTemplate.insert(aiCodeReviewPo, MongoDB.AI_CODE_REVIEW_COLLECTION)<br><br>            logger.info(LogInfo.CODE_REVIEW_SUCCESS)<br>            logger.info(<span class="hljs-string">&quot;å¼€å§‹å‘é€å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯!&quot;</span>)<br><br>            wxMpService.templateMsgService.sendTemplateMsg(buildWxMpTemplateMessage(aiCodeReviewPo.userName, aiCodeReviewPo.repositoryName, aiCodeReviewPo.commitId, aiCodeReviewPo.commitUrl))<br>            logger.info(<span class="hljs-string">&quot;å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯å‘é€æˆåŠŸ!&quot;</span>)<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">buildWxMpTemplateMessage</span><span class="hljs-params">(userName: <span class="hljs-type">String</span>?, repositoryName: <span class="hljs-type">String</span>?, commitId: <span class="hljs-type">String</span>?, commitUrl: <span class="hljs-type">String</span>?)</span></span> : WxMpTemplateMessage &#123;<br>        <span class="hljs-keyword">val</span> templateMessage = WxMpTemplateMessage()<br>        templateMessage.toUser = wxProperties.userId<br>        templateMessage.templateId = wxProperties.templateId<br>        templateMessage.url = <span class="hljs-string">&quot;<span class="hljs-subst">$&#123;RES_ACCESS_URL_PREFIX&#125;</span>?userName=<span class="hljs-subst">$&#123;userName&#125;</span>&amp;repositoryName=<span class="hljs-subst">$&#123;repositoryName&#125;</span>&amp;commitId=<span class="hljs-subst">$&#123;commitId&#125;</span>&quot;</span><br><br>        templateMessage.addData(WxMpTemplateData(<span class="hljs-string">&quot;userName&quot;</span>, userName))<br>            .addData(WxMpTemplateData(<span class="hljs-string">&quot;repositoryName&quot;</span>, repositoryName))<br>            .addData(WxMpTemplateData(<span class="hljs-string">&quot;commitUrl&quot;</span>, commitUrl))<br><br>        <span class="hljs-keyword">return</span> templateMessage<br>    &#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â ç„¶åæ˜¯åµŒå…¥åˆ°<code>SpringBoot</code>é¡¹ç›®çš„htmlé¡µé¢ç”¨äºå±•ç¤ºå•æ¬¡ä»£ç å®¡æ ¸ç»“æœ</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>AI ä»£ç å®¡æŸ¥ç»“æœ<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;info&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;error&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;content&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;loading&quot;</span>&gt;</span>æ­£åœ¨åŠ è½½å†…å®¹...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span><br><span class="language-xml"><span class="language-handlebars">        document.addEventListener(&#x27;DOMContentLoaded&#x27;, function() &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">            const urlParams = new URLSearchParams(window.location.search);</span></span><br><span class="language-xml"><span class="language-handlebars">            const userName = urlParams.get(&#x27;userName&#x27;);</span></span><br><span class="language-xml"><span class="language-handlebars">            const repositoryName = urlParams.get(&#x27;repositoryName&#x27;);</span></span><br><span class="language-xml"><span class="language-handlebars">            const commitId = urlParams.get(&#x27;commitId&#x27;);</span></span><br><span class="language-xml"><span class="language-handlebars"></span></span><br><span class="language-xml"><span class="language-handlebars">            const infoElement = document.getElementById(&#x27;info&#x27;);</span></span><br><span class="language-xml"><span class="language-handlebars">            const errorElement = document.getElementById(&#x27;error&#x27;);</span></span><br><span class="language-xml"><span class="language-handlebars">            const contentElement = document.getElementById(&#x27;content&#x27;);</span></span><br><span class="language-xml"><span class="language-handlebars"></span></span><br><span class="language-xml"><span class="language-handlebars">            if (!userName || !repositoryName || !commitId) &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">                errorElement.textContent = &#x27;é”™è¯¯ï¼šç¼ºå°‘å¿…è¦çš„å‚æ•°ã€‚è¯·ç¡®ä¿æä¾›äº†userNameã€repositoryNameå’ŒcommitIdã€‚&#x27;;</span></span><br><span class="language-xml"><span class="language-handlebars">                contentElement.classList.remove(&#x27;loading&#x27;);</span></span><br><span class="language-xml"><span class="language-handlebars">                contentElement.style.display = &#x27;none&#x27;;</span></span><br><span class="language-xml"><span class="language-handlebars">                return;</span></span><br><span class="language-xml"><span class="language-handlebars">            &#125;</span></span><br><span class="language-xml"><span class="language-handlebars"></span></span><br><span class="language-xml"><span class="language-handlebars">            const apiUrl = `http://192.168.1.201:8080/code-review/queryByCommitId?userName=$&#123;encodeURIComponent(userName)&#125;&amp;repositoryName=$&#123;encodeURIComponent(repositoryName)&#125;&amp;commitId=$&#123;encodeURIComponent(commitId)&#125;`;</span></span><br><span class="language-xml"><span class="language-handlebars"></span></span><br><span class="language-xml"><span class="language-handlebars">            fetch(apiUrl)</span></span><br><span class="language-xml"><span class="language-handlebars">                .then(response =&gt; &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">                    if (!response.ok) &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">                        throw new Error(&#x27;ç½‘ç»œå“åº”ä¸æ­£å¸¸&#x27;);</span></span><br><span class="language-xml"><span class="language-handlebars">                    &#125;</span></span><br><span class="language-xml"><span class="language-handlebars">                    return response.json();</span></span><br><span class="language-xml"><span class="language-handlebars">                &#125;)</span></span><br><span class="language-xml"><span class="language-handlebars">                .then(data =&gt; &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">                    if (data &amp;&amp; data.content) &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">                        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯</span></span><br><span class="language-xml"><span class="language-handlebars">                        infoElement.innerHTML = `</span></span><br><span class="language-xml"><span class="language-handlebars">                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>ç”¨æˆ·åç§°ï¼š<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>$&#123;escapeHtml(userName)&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span></span><br><span class="language-xml"><span class="language-handlebars">                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>ä»“åº“åç§°ï¼š<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>$&#123;escapeHtml(repositoryName)&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span></span><br><span class="language-xml"><span class="language-handlebars">                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>Commit URLï¼š<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;$&#123;escapeHtml(data.commitUrl)&#125;&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span>æŸ¥çœ‹ Commit<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span></span><br><span class="language-xml"><span class="language-handlebars">                        `;</span></span><br><span class="language-xml"><span class="language-handlebars">                        contentElement.innerHTML = marked.parse(data.content);</span></span><br><span class="language-xml"><span class="language-handlebars">                    &#125; else &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">                        contentElement.textContent = &#x27;æœªæ‰¾åˆ°å†…å®¹æˆ–å“åº”æ ¼å¼ä¸æ­£ç¡®ã€‚&#x27;;</span></span><br><span class="language-xml"><span class="language-handlebars">                    &#125;</span></span><br><span class="language-xml"><span class="language-handlebars">                &#125;)</span></span><br><span class="language-xml"><span class="language-handlebars">                .catch(error =&gt; &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">                    console.error(&#x27;è·å–æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:&#x27;, error);</span></span><br><span class="language-xml"><span class="language-handlebars">                    contentElement.textContent = &#x27;è·å–æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚&#x27;;</span></span><br><span class="language-xml"><span class="language-handlebars">                &#125;)</span></span><br><span class="language-xml"><span class="language-handlebars">                .finally(() =&gt; &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">                    contentElement.classList.remove(&#x27;loading&#x27;);</span></span><br><span class="language-xml"><span class="language-handlebars">                &#125;);</span></span><br><span class="language-xml"><span class="language-handlebars">        &#125;);</span></span><br><span class="language-xml"><span class="language-handlebars"></span></span><br><span class="language-xml"><span class="language-handlebars">        // è¾…åŠ©å‡½æ•°ï¼šè½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦</span></span><br><span class="language-xml"><span class="language-handlebars">        function escapeHtml(unsafe) &#123;</span></span><br><span class="language-xml"><span class="language-handlebars">            return unsafe</span></span><br><span class="language-xml"><span class="language-handlebars">                .replace(/&amp;/g, &quot;&amp;&quot;)</span></span><br><span class="language-xml"><span class="language-handlebars">                .replace(/&lt;/g, &quot;&lt;&quot;)</span></span><br><span class="language-xml"><span class="language-handlebars">                .replace(/&gt;/g, &quot;&gt;&quot;)</span></span><br><span class="language-xml"><span class="language-handlebars">                .replace(/&quot;/g, &quot;&quot;&quot;)</span></span><br><span class="language-xml"><span class="language-handlebars">                .replace(/&#x27;/g, &quot;<span class="hljs-symbol">&amp;#039;</span>&quot;);</span></span><br><span class="language-xml"><span class="language-handlebars">        &#125;</span></span><br><span class="language-xml"><span class="language-handlebars">    </span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="3-éƒ¨ç½²é¡¹ç›®"><a href="#3-éƒ¨ç½²é¡¹ç›®" class="headerlink" title="3. éƒ¨ç½²é¡¹ç›®"></a>3. éƒ¨ç½²é¡¹ç›®</h3><p>Â Â Â Â æ­£å¥½è¿˜æœ‰ä¸€å°æ— ç•Œsä¹Ÿå¤„äºåƒç°çŠ¶æ€ï¼Œå°±éƒ¨ç½²åˆ°è¿™ä¸Šé¢å§ã€‚å†åŠ ä¸Šæˆ‘åœ¨å»ºé¡¹ç›®çš„æ—¶å€™å‹¾äº†<code>GraalVM Native Support</code>é€‰é¡¹ï¼Œæˆ‘å†³å®šå°è¯•ä¸€ä¸‹æ„å»º<code>native-iamge</code>ã€‚</p><p><img src="/2024/09/08/personal-projects/%E4%BD%BF%E7%94%A8Gitea%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E5%8C%96%E7%9A%84AI%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5/2024-09-08-21-31-31-image.png"></p><p>Â Â Â Â å› ä¸ºæˆ‘ä¸æƒ³åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…<code>gradle</code>ã€<code>kotlin</code>ç¯å¢ƒï¼Œå°±æƒ³ç€æœ¬åœ°æ‰“ä¸ªjaråŒ…åå†å°†jaråŒ…è½¬æˆ<code>native-image</code>ï¼Œç„¶åæˆ‘é—®äº†åŠå¤©GPTéƒ½æ— æ³•è§£å†³æ‰¾ä¸åˆ°<code>MainClass</code>çš„é—®é¢˜ï¼Œæœ€åå»ç¿»Springçš„æ–‡æ¡£æ‰¾åˆ°äº†ä¸€ä¸²è„šæœ¬å‘½ä»¤ï¼Œè¯•äº†ä¸€ä¸‹åæœçœŸèƒ½è¡Œã€‚</p><blockquote><p>Springå®˜æ–¹æ–‡æ¡£è¿˜åˆ—å‡ºäº†æ­¤æ–¹å¼çš„ä¼˜ç‚¹ï¼Œè§<a href="https://docs.spring.io/spring-boot/reference/packaging/native-image/advanced-topics.html#packaging.native-image.advanced.converting-executable-jars">Advanced Native Images Topics :: Spring Boot</a></p><p>æˆ–è€…ç›´æ¥çœ‹ä¸­æ–‡æ–‡æ¡£ï¼š<a href="https://springdoc.cn/spring-boot/native-image.html#native-image.advanced.converting-executable-jars">GraalVM åŸç”Ÿé•œåƒï¼ˆImageï¼‰æ”¯æŒ (springdoc.cn)</a></p></blockquote><p>Â Â Â Â æŠŠjaråŒ…ä¸Šä¼ åˆ°æœåŠ¡å™¨ç„¶åè¿è¡Œè„šæœ¬å°±èƒ½ä¸€é”®æ„å»ºå¹¶å¯åŠ¨äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#/bin/bash</span><br><br><span class="hljs-built_in">rm</span> -rf target/native<br><span class="hljs-built_in">mkdir</span> -p target/native<br><span class="hljs-built_in">cd</span> target/native<br>jar -xvf ../../ai-code-review-kotlin-0.0.1-SNAPSHOT.jar<br>native-image -H:Name=ai-code-review-kotlin -H:Class=cn.handsyoung.ai.code.review.AiCodeReviewKotlinApplicationKt --report-unsupported-elements-at-runtime --no-fallback --install-exit-handlers -<span class="hljs-built_in">cp</span> .:BOOT-INF/classes:`find BOOT-INF/lib | <span class="hljs-built_in">tr</span> <span class="hljs-string">&#x27;\n&#x27;</span> <span class="hljs-string">&#x27;:&#x27;</span>`<br><span class="hljs-built_in">mv</span> ai-code-review-kotlin ../../<br><span class="hljs-built_in">cd</span> ../../<br><span class="hljs-built_in">nohup</span> ./ai-code-review-kotlin &amp;<br></code></pre></td></tr></table></figure><h3 id="4-æ•ˆæœ"><a href="#4-æ•ˆæœ" class="headerlink" title="4. æ•ˆæœ"></a>4. æ•ˆæœ</h3><p>Â Â <img src="/2024/09/08/personal-projects/%E4%BD%BF%E7%94%A8Gitea%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E5%8C%96%E7%9A%84AI%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5/2024-09-08-21-46-24-image.png"></p><p>Â Â Â Â å½“æˆ‘æäº¤æ¨é€åˆ°æœ¬åœ°ä»“åº“æ—¶ï¼Œä¼šè§¦å‘é¢„å…ˆå®šä¹‰å¥½çš„Web é’©å­ï¼Œå³è¯·æ±‚ä¸Šé¢éƒ¨ç½²å¥½çš„AIä»£ç å®¡æŸ¥æœåŠ¡çš„æ¥å£ï¼Œç„¶åæ‰§è¡ŒAIä»£ç å®¡æŸ¥ï¼Œå°†å®¡æŸ¥ç»“æœä¿å­˜åˆ°æ•°æ®åº“åï¼Œæ¨é€å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯</p><p>Â Â Â Â Â <img src="/2024/09/08/personal-projects/%E4%BD%BF%E7%94%A8Gitea%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E5%8C%96%E7%9A%84AI%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5/2024-09-08-21-50-32-image.png"></p><p>Â Â Â Â ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ï¼Œå°±èƒ½è·³è½¬åˆ°AIä»£ç å®¡æŸ¥ç»“æœé¡µé¢</p><p><img src="/2024/09/08/personal-projects/%E4%BD%BF%E7%94%A8Gitea%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E5%8C%96%E7%9A%84AI%E4%BB%A3%E7%A0%81%E5%AE%A1%E6%9F%A5/2024-09-08-23-56-35-image.png"></p><h3 id="5-æ€»ç»“"><a href="#5-æ€»ç»“" class="headerlink" title="5. æ€»ç»“"></a>5. æ€»ç»“</h3><p>Â Â Â Â é€šè¿‡ä¸Šé¢çš„åŠªåŠ›ï¼ŒåŸºæœ¬å®ç°äº†ä¸€ä¸ªå¯ç”¨çš„AIä»£ç å®¡æŸ¥æœåŠ¡ï¼ˆå†™æç¤ºè¯çœŸæ˜¯ä¸ªæŠ€æœ¯æ´»ï¼‰ã€‚ä¸ªäººè§‰å¾—åç»­å¯ä¼˜åŒ–çš„ç‚¹å¦‚ä¸‹ï¼š</p><ol><li><p>å‰ç«¯é¡µé¢ä¼˜åŒ–</p></li><li><p>æç¤ºè¯ï¼ˆPromptï¼‰æŒç»­ä¼˜åŒ–</p></li><li><p>å¯ä»¥é€šè¿‡å†…ç½‘ç©¿é€å°†ä»£ç ä»“åº“å’ŒAIä»£ç å®¡æŸ¥æœåŠ¡æš´éœ²åˆ°å…¬ç½‘ï¼Œä»¥ä¾¿éšæ—¶éšåœ°æäº¤ä»£ç åŠæ¥æ”¶å’ŒæŸ¥çœ‹ä»£ç å®¡æŸ¥ç»“æœ</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>ä¸ªäººé¡¹ç›®</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Personal Projects</tag>
      
      <tag>AI</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>è¾“å…¥æ³•è‡ªåŠ¨åˆ‡æ¢æ’ä»¶é˜¶æ®µæ€§æ€»ç»“</title>
    <link href="/2024/07/18/personal-projects/%E8%BE%93%E5%85%A5%E6%B3%95%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2%E6%8F%92%E4%BB%B6%E9%98%B6%E6%AE%B5%E6%80%A7%E6%80%BB%E7%BB%93/"/>
    <url>/2024/07/18/personal-projects/%E8%BE%93%E5%85%A5%E6%B3%95%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2%E6%8F%92%E4%BB%B6%E9%98%B6%E6%AE%B5%E6%80%A7%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â è¿™ç¯‡åšæ–‡æ˜¯å¯¹ä¸‹é¢commitçš„è¿›ä¸€æ­¥æ€è€ƒã€å®è·µï¼Œè¿›è€Œå¯¹è¾“å…¥æ³•è‡ªåŠ¨åˆ‡æ¢æ’ä»¶å¼€å‘å†ç¨‹çš„ä¸€ä¸ªæ€»ç»“</p><p><img src="/2024/07/18/personal-projects/%E8%BE%93%E5%85%A5%E6%B3%95%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2%E6%8F%92%E4%BB%B6%E9%98%B6%E6%AE%B5%E6%80%A7%E6%80%BB%E7%BB%93/2024-07-18-20-24-03-image.png"></p><h3 id="å¼€å‘å‰"><a href="#å¼€å‘å‰" class="headerlink" title="å¼€å‘å‰"></a>å¼€å‘å‰</h3><p>Â Â Â Â åœ¨ä¸€å¼€å§‹ï¼Œæˆ‘å°±å°†æ’ä»¶çš„æ€§èƒ½æ”¾åœ¨äº†ä¼˜å…ˆè€ƒè™‘çš„ä½ç½®ã€‚å› ä¸ºè¾“å…¥æ³•çš„åˆ‡æ¢ä¸å…‰æ ‡ä½ç½®çš„æ”¹å˜ç›¸å…³è”ï¼Œè€Œå…‰æ ‡ä½ç½®çš„æ”¹å˜åœ¨IDEä¸­å¯ä»¥è¯´æ˜¯æœ€é¢‘ç¹çš„è¡Œä¸ºï¼ˆå†™ä»£ç å˜›ï¼‰ã€‚å¦‚æœè¾“å…¥æ³•åˆ‡æ¢åŠŸèƒ½è€—æ—¶è¿‡é•¿æˆ–è€…å…‰æ ‡å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘è¾“å…¥æ³•åˆ‡æ¢çš„æ¦‚ç‡è¿‡å¤§ï¼Œé‚£ä¹ˆå°†ä¼šå¯¹IDEçš„æ€§èƒ½é€ æˆæ˜æ˜¾çš„å½±å“ï¼Œè¿™å¯¹ç›®çš„æ˜¯è¿›è¡ŒIDEåŠŸèƒ½å¢å¼ºçš„æ’ä»¶æ¥è¯´æ˜¯ä¸å¯æ¥å—çš„ã€‚</p><h3 id="å¼€å‘ä¸­"><a href="#å¼€å‘ä¸­" class="headerlink" title="å¼€å‘ä¸­"></a>å¼€å‘ä¸­</h3><p>Â Â Â Â ç»è¿‡ä¸€ç•ªç ”ç©¶ä¹‹åï¼Œå†³å®šé€šè¿‡ä¸ºæ¯ä¸ª<code>editor</code>æ·»åŠ ä¸€ä¸ªå…‰æ ‡ä½ç½®æ”¹å˜ç›‘å¬å™¨<code>SwitchIMECaretListener</code>ï¼Œç”¨äºç›‘å¬å…‰æ ‡ä½ç½®æ”¹å˜äº‹ä»¶ï¼›åŠ ä¸ŠJetbrains IDEæä¾›çš„é¼ æ ‡äº‹ä»¶ã€å›è½¦äº‹ä»¶ã€ç¼–è¾‘å™¨actionäº‹ä»¶ã€å­—ç¬¦è¾“å…¥äº‹ä»¶ï¼ˆtypedï¼‰æ‰©å±•ç‚¹ï¼Œèƒ½è¾ƒä¼˜é›…ä¸”æ€§èƒ½æŸè€—è¾ƒä½åœ°å®ç°æ˜¯å¦åº”è¯¥è¿›è¡Œè¾“å…¥æ³•åˆ‡æ¢çš„åˆ¤æ–­</p><p>Â Â Â Â è¾“å…¥æ³•è‡ªåŠ¨åˆ‡æ¢æ˜¯é€šè¿‡jnaï¼ˆJetbrains IDEè‡ªå¸¦çš„ï¼‰è°ƒç”¨ç³»ç»Ÿåº“å®ç°çš„</p><p>Â Â Â Â å®ç°äº†ä¸Šé¢çš„æ–¹æ¡ˆåï¼Œæˆ‘åœ¨æœ¬åœ°ç¬”è®°æœ¬ï¼ˆamd r7 5800h + 3060ï¼‰ä¸Šä½¿ç”¨æ—¶æ„ŸçŸ¥ä¸åˆ°è‡ªåŠ¨è¾“å…¥æ³•åˆ‡æ¢å¸¦æ¥çš„å¡é¡¿ï¼ˆç›®çš„è¾¾æˆï¼ï¼‰ï¼Œæ‰€ä»¥å°±ä¸€è¾¹ç”¨ä¸€è¾¹å¯¹ç°æœ‰çš„è¾“å…¥æ³•åˆ‡æ¢çš„åˆ¤æ–­é€»è¾‘è¿›è¡Œä¿®ä¿®è¡¥è¡¥ï¼Œç›´åˆ°æœ‰ä¸€å¤©â€¦â€¦</p><h3 id="æ— æ³•å¿å—ç°æœ‰è¾“å…¥æ³•åˆ‡æ¢åˆ¤æ–­é€»è¾‘"><a href="#æ— æ³•å¿å—ç°æœ‰è¾“å…¥æ³•åˆ‡æ¢åˆ¤æ–­é€»è¾‘" class="headerlink" title="æ— æ³•å¿å—ç°æœ‰è¾“å…¥æ³•åˆ‡æ¢åˆ¤æ–­é€»è¾‘"></a>æ— æ³•å¿å—ç°æœ‰è¾“å…¥æ³•åˆ‡æ¢åˆ¤æ–­é€»è¾‘</h3><p>Â Â Â Â ç”±äºæˆ‘åœ¨å¼€å‘æ—¶æƒ³ç€å°½é‡é¿å…è°ƒç”¨æ¥å£è¿›è¡Œè¾“å…¥æ³•åˆ‡æ¢ã€‚æ‰€ä»¥æˆ‘åœ¨åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œè¾“å…¥æ³•åˆ‡æ¢æ—¶ï¼Œå…ˆåˆ¤æ–­å…‰æ ‡æ˜¯å¦ä½äºæ³¨é‡ŠåŒºï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åˆ‡æ¢è¾“å…¥æ³•ä¸ºä¸­æ–‡ï¼›å†åˆ¤æ–­å…‰æ ‡æ˜¯å¦ä½äºä»£ç åŒºï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åˆ‡æ¢ä¸ºè‹±æ–‡ï¼›å¦‚æœå…‰æ ‡æ—¢ä¸ä½äºæ³¨é‡ŠåŒºåˆä¸ä½äºä»£ç åŒºï¼Œåˆ™å•¥ä¹Ÿä¸åšã€‚</p><p>Â Â Â Â æƒ³æ³•æ˜¯ç¾å¥½çš„ã€‚å¯æ˜¯åˆ°äº†å®ç°æ—¶ï¼Œæˆ‘å‘ç°å…‰æ˜¯Javaè¯­è¨€ï¼ŒPsiElementå°±æœ‰å…³é”®å­—ã€å­—ç¬¦ä¸²ã€è¡¨è¾¾å¼ã€è¯­å¥ã€æ ‡è¯†ç¬¦ç­‰ç­‰ç±»å‹ã€‚åªæ˜¯è¿™äº›éƒ½è¿˜å¥½ï¼Œæ¯•ç«Ÿå¯ä»¥ä¸€è¾¹ç”¨ä¸€è¾¹æŸ¥æ¼è¡¥ç¼ºåœ°åŠ ä¸Šç›¸åº”çš„åˆ¤æ–­ï¼›è¦å‘½çš„æ˜¯ç©ºæ ¼ï¼Œä½äºè¿™äº›PsiElementå‰ã€PsiElementåã€PsiElementä¸­ã€ç›¸é‚»çš„PsiElementä¸­é—´çš„ç©ºæ ¼ï¼›å…‰æ ‡ä½äºè¿™äº›ç©ºæ ¼çš„æ—¶å€™ä¸€èˆ¬éœ€è¦åˆ‡æ¢åˆ°è‹±æ–‡ï¼Œä¹Ÿå³æˆ‘éœ€è¦åœ¨ä»£ç åŒºåˆ¤æ–­é€»è¾‘ä¸­å‡†ç¡®ä¸é—æ¼åœ°è¯†åˆ«æ‰€æœ‰è¿™äº›åœºæ™¯ï¼›é—æ†¾çš„æ˜¯ï¼Œè¿™äº›åœºæ™¯ä¼¼ä¹å¤ªå¤šäº†ï¼Œä»¥è‡³äºæˆ‘åœ¨ä½¿ç”¨æ’ä»¶æ—¶æ—¶ä¸æ—¶å°±ä¼šå‡ºç°åº”è¯¥åˆ‡æ¢ä¸ºè‹±æ–‡è€Œæ’ä»¶å´ä¸å·¥ä½œçš„æƒ…å†µã€‚</p><p>Â Â Â Â äºæ˜¯ï¼Œè¿™ä¸€å¤©ï¼Œæˆ‘æ”¾å¼ƒæŒ£æ‰äº†ã€‚å°†ä»£ç åŒºåˆ¤æ–­å‡½æ•°ä¿®æ”¹ä¸ºæ°¸è¿œè¿”å›trueï¼Œå³åœ¨å‘ç”Ÿå…‰æ ‡å˜åŒ–æ—¶ï¼Œä¸æ˜¯åŒ¹é…ä¸Šæ³¨é‡ŠåŒºè€Œå°†è¾“å…¥æ³•åˆ‡æ¢ä¸ºä¸­æ–‡ï¼Œå°±æ˜¯è¿›è¡Œé»˜è®¤çš„å°†è¾“å…¥æ³•åˆ‡æ¢ä¸ºè‹±æ–‡åŠ¨ä½œã€‚</p><p>Â Â Â Â ç”±æ­¤å¸¦æ¥çš„å¥½å¤„æ˜¯éå¸¸æ˜æ˜¾çš„ï¼Œä»¥åæˆ‘åªéœ€å…³æ³¨å…‰æ ‡æ˜¯å¦ä½äºæ³¨é‡ŠåŒºï¼Œè€Œä¸ç”¨è€ƒè™‘ä¸Šé¢æåˆ°çš„å¤æ‚çš„ä»£ç åŒºåœºæ™¯ã€‚åå¤„ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œè¾“å…¥æ³•åˆ‡æ¢æ¥å£è°ƒç”¨çš„é¢‘ç‡ä¼šå¢åŠ ï¼Œæˆ‘å¿…é¡»è€ƒè™‘ç”±æ­¤å¸¦æ¥çš„æ€§èƒ½ä¸Šçš„å½±å“ï¼›è™½ç„¶ä¿®æ”¹ä¹‹ååœ¨æˆ‘æœ¬åœ°å’Œä¹‹å‰ä½¿ç”¨ä½“éªŒå¹¶æ— åŒºåˆ«ï¼Œä½†æˆ‘è¿˜æ˜¯å†³å®šå°½æˆ‘æ‰€èƒ½åšåˆ°æœ€å¥½ã€‚</p><p>Â Â Â Â æ‰€ä»¥ï¼Œæƒ³ä¸€ä¸‹è¯¥æ€ä¹ˆä¼˜åŒ–å§</p><h3 id="ä¼˜åŒ–å°è¯•åŠæ”¾å¼ƒ"><a href="#ä¼˜åŒ–å°è¯•åŠæ”¾å¼ƒ" class="headerlink" title="ä¼˜åŒ–å°è¯•åŠæ”¾å¼ƒ"></a>ä¼˜åŒ–å°è¯•åŠæ”¾å¼ƒ</h3><p>Â Â Â Â å¾ˆè‡ªç„¶åœ°ä¼šæƒ³åˆ°åœ¨IDEä¸­åŒæ­¥ç”µè„‘è¾“å…¥æ³•çš„çŠ¶æ€ï¼Œåœ¨éœ€è¦è¿›è¡Œè¾“å…¥æ³•åˆ‡æ¢æ—¶ï¼Œå…ˆåˆ¤æ–­å½“å‰è¾“å…¥æ³•çŠ¶æ€å’Œç›®æ ‡çŠ¶æ€æ˜¯å¦ç›¸åŒï¼Œåªæœ‰çŠ¶æ€ä¸ç›¸åŒæ—¶ï¼Œæ‰è°ƒç”¨æ¥å£è¿›è¡Œè¾“å…¥æ³•åˆ‡æ¢ã€‚</p><p>Â Â Â Â æˆ‘å…ˆæŸ¥è¯¢äº†Jetbrainsæä¾›çš„é”®ç›˜è¾“å…¥ç›¸å…³æ‰©å±•ç‚¹ï¼Œæ‰¾äº†å¥½å‡ ä¸ªï¼Œå‘ç°æœ€ç»ˆéƒ½æ˜¯å¯¹åº”<code>Java</code>çš„<code>KeyListener</code>å’Œ<code>KeyEvent</code>ã€‚ç„¶è€Œåœ¨è°ƒè¯•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å‘ç°æ¥æ”¶åˆ°çš„<code>KeyEvent</code>æ˜¯æµå¼çš„ï¼Œå°±æ˜¯è¯´ä½ ä¸€ç›´æŒ‰ä¸‹<code>shift</code>é”®ç„¶åæ¾å¼€ï¼Œæ¥å—åˆ°çš„ä¼šæ˜¯Nä¸ª<code>shift pressed SHIFT KeyEvent</code>å’Œä¸€ä¸ª<code>shift released SHIFT KeyEvent</code>äº‹ä»¶ï¼›åŒæ—¶æŒ‰å¤šä¸ªé”®çš„è¯ä¸€æ ·ï¼Œäº‹ä»¶çš„é¡ºåºå’Œé”®ä½è¢«æŒ‰ä¸‹çš„é¡ºåºç›¸åŒã€‚é€šè¿‡è¿™äº›äº‹ä»¶æ¥åŒæ­¥è¾“å…¥æ³•çŠ¶æ€ä¼¼ä¹ä¸å¤ªå¯èƒ½â€¦â€¦</p><p>Â Â Â Â å› æ­¤æˆ‘æƒ³äº†åˆ«çš„æ–¹æ¡ˆ</p><ol><li><p>æ—¢ç„¶IDEæ²¡æœ‰æä¾›ç›¸å…³çš„æ‰©å±•ç‚¹ï¼Œå¹²è„†ç›´æ¥ç›‘å¬ç”µè„‘è¾“å…¥æ³•åˆ‡æ¢äº‹ä»¶ï¼Œç„¶åæˆ‘æŸ¥äº†ä¸‹GPTï¼Œemmmï¼Œç®—äº†ï¼Œå…ˆè€ƒè™‘åˆ«çš„æ–¹æ¡ˆå§</p></li><li><p>IDEæä¾›çš„é”®ç›˜äº‹ä»¶æ— æ³•å®ç°ç›®æ ‡ï¼Œä½•ä¸ç›‘å¬é”®ç›˜çŠ¶æ€ï¼Œå½“é”®ç›˜å‡ºç°è¿ç»­çš„<strong>åªæœ‰shifté”®æŒ‰ä¸‹</strong>å’Œ<strong>shifté”®æ¾å¼€çš„åŒæ—¶æ²¡æœ‰ä»»ä½•é”®æŒ‰ä¸‹</strong>çŠ¶æ€æ—¶ï¼ˆæˆ–è€…è¿˜æœ‰å…¶ä»–æ²¡è€ƒè™‘åˆ°çš„æƒ…å†µï¼‰ï¼Œè®¤ä¸ºç”µè„‘è¿›è¡Œäº†è¾“å…¥æ³•åˆ‡æ¢ï¼Œæ›´æ–°IDEå­˜å‚¨çš„è¾“å…¥æ³•çŠ¶æ€</p></li></ol><p>Â Â Â Â åœ¨è¿›ä¸€æ­¥æ€è€ƒä¸Šè¿°æ–¹æ¡ˆçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘è€ƒè™‘äº†å¤šçº¿ç¨‹é—®é¢˜ï¼ˆè¾“å…¥æ³•çŠ¶æ€åŒæ­¥çº¿ç¨‹å’Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œè¾“å…¥æ³•åˆ‡æ¢çš„çº¿ç¨‹é€šå¸¸ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œå®è·µä¹‹åå‘ç°è·Ÿæˆ‘æƒ³çš„å®Œå…¨ä¸ä¸€æ ·ã€è€ƒè™‘äº†è¾“å…¥æ³•çŠ¶æ€åŒæ­¥æœ¬èº«å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€è€ƒè™‘äº†Jetbrains IDEè¿›è¡Œjnaè°ƒç”¨æ˜¯å¼‚æ­¥çš„</p><p>Â Â Â Â æœ€åå¾—å‡ºç»“è®ºï¼Œæˆ‘å¤ªèœäº†ï¼Œè¿˜æ˜¯è€è€å®å®ç›´æ¥è°ƒç”¨æ¥å£è¿›è¡Œè¾“å…¥æ³•åˆ‡æ¢å§</p>]]></content>
    
    
    <categories>
      
      <category>ä¸ªäººé¡¹ç›®</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Jetbrains IDE</tag>
      
      <tag>Plugin</tag>
      
      <tag>Personal Projects</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringCloud-OpenFeignæ•´åˆBeanValidationå­¦ä¹ </title>
    <link href="/2024/05/29/Spring/SpringCloud/SpringCloud-OpenFeign%E6%95%B4%E5%90%88BeanValidation%E5%AD%A6%E4%B9%A0/"/>
    <url>/2024/05/29/Spring/SpringCloud/SpringCloud-OpenFeign%E6%95%B4%E5%90%88BeanValidation%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â æµ‹è¯•ç”¨éƒ¨åˆ†ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MockUser</span> &#123;<br><br>    <span class="hljs-meta">@Positive</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br><br>    <span class="hljs-meta">@NotBlank</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">// 0è¡¨ç¤ºç”·,1è¡¨ç¤ºå¥³</span><br>    <span class="hljs-meta">@Min(value = 0, message = &quot;æ€§åˆ«å€¼åªèƒ½å…è®¸0æˆ–1&quot;)</span><br>    <span class="hljs-meta">@Max(value = 1, message = &quot;æ€§åˆ«å€¼åªèƒ½å…è®¸0æˆ–1&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> sex;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;MockUser&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;id=&quot;</span> + id +<br>                <span class="hljs-string">&quot;, name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, sex=&quot;</span> + sex +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;feign-test-service&quot;, configuration = ServiceFeignClientConfiguration.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FeignTestService</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/user/registerUser&quot;, produces = &quot;application/json;v=1&quot;)</span><br>    Result <span class="hljs-title function_">registerUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Valid</span> MockUser user)</span> <span class="hljs-keyword">throws</span> RuntimeException;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/user/registerUser&quot;, produces = &quot;application/json;v=1.1&quot;)</span><br>    <span class="hljs-keyword">default</span> Result <span class="hljs-title function_">registerUserV11</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Valid</span> MockUser user)</span> <span class="hljs-keyword">throws</span> RuntimeException&#123;<br>        <span class="hljs-keyword">return</span> Result.error();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â åªæ˜¯è¿™æ ·åœ¨feign interfaceçš„æ–¹æ³•ä¸ŠåŠ ä¸Š@Validæ³¨è§£çš„è¯ï¼Œå»è°ƒç”¨æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°bean validationæ˜¯æ²¡èµ·ä½œç”¨çš„ã€‚å½’æ ¹ç»“åº•æ˜¯å› ä¸ºSpringCloud-OpenFeignä½¿ç”¨çš„<strong>SynchronousMethodHandler</strong>æ²¡æœ‰åƒSpringMVCä½¿ç”¨çš„<strong>InvocableHandlerMethod</strong>ä¸€æ ·åœ¨å¤„ç†æ–¹æ³•å‚æ•°æ—¶æœ‰å‚æ•°æ ¡éªŒçš„é€»è¾‘ã€‚</p><p>Â Â Â Â æ‰€ä»¥å¦‚æœæƒ³åœ¨SpringCloud-OpenFeignä¸­æ•´åˆBean Validationè¿˜å¾—æƒ³æƒ³åŠæ³•ï¼Œä¸‹é¢æ˜¯æˆ‘æ•´ç†çš„å‡ ç§æ–¹æ³•</p><h4 id="ä¸€ï¼šSpringæä¾›çš„-Validatedæ³¨è§£"><a href="#ä¸€ï¼šSpringæä¾›çš„-Validatedæ³¨è§£" class="headerlink" title="ä¸€ï¼šSpringæä¾›çš„@Validatedæ³¨è§£"></a>ä¸€ï¼šSpringæä¾›çš„@Validatedæ³¨è§£</h4><p>Â Â Â Â ç±»ä¼¼ä¸‹é¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;feign-test-service&quot;, configuration = ServiceFeignClientConfiguration.class)</span><br><span class="hljs-meta">@Validated</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FeignTestService</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/user/registerUser&quot;, produces = &quot;application/json;v=1&quot;)</span><br>    Result <span class="hljs-title function_">registerUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Valid</span> MockUser user)</span> <span class="hljs-keyword">throws</span> RuntimeException;<br><br>    <span class="hljs-meta">@PostMapping(value = &quot;/user/registerUser&quot;, produces = &quot;application/json;v=1.1&quot;)</span><br>    <span class="hljs-keyword">default</span> Result <span class="hljs-title function_">registerUserV11</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Valid</span> MockUser user)</span> <span class="hljs-keyword">throws</span> RuntimeException&#123;<br>        <span class="hljs-keyword">return</span> Result.error();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â ç„¶åå†è°ƒç”¨<strong>Controller</strong>æ¥å£ï¼ˆè°ƒç”¨å †æ ˆå¦‚ä¸‹å›¾ä¸€æ‰€ç¤ºï¼Œå‘ç°æ­¤æ—¶çš„feignTestServiceï¼‰å˜æˆäº†<strong>JdkDynamicAopProxy</strong>ï¼Œç„¶åæ‰æ˜¯<strong>ReflectiveFeign$FeignInvocationHandler</strong>ï¼Œå¯ä»¥å¯¹æ¯”ä¸‹å›¾äºŒçœ‹ä¸‹ä¸¤è€…çš„åŒºåˆ«ã€‚<br><img src="/2024/05/29/Spring/SpringCloud/SpringCloud-OpenFeign%E6%95%B4%E5%90%88BeanValidation%E5%AD%A6%E4%B9%A0/1169988201774600.png"><br>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â å›¾ä¸€</p><p><img src="/2024/05/29/Spring/SpringCloud/SpringCloud-OpenFeign%E6%95%B4%E5%90%88BeanValidation%E5%AD%A6%E4%B9%A0/1170331843533300.png"></p><p>Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â å›¾äºŒ</p><p>Â Â Â Â çœ‹åˆ°èµ°åˆ°äº† <strong>JdkDynamicAopProxy</strong> é‡Œé¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkDynamicAopProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AopProxy</span>, InvocationHandler, Serializable &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        ......<br>        <span class="hljs-comment">// Get the interception chain for this method. </span><br>        <span class="hljs-comment">// è¿™é‡Œçš„chainåªæœ‰ä¸€ä¸ªå…ƒç´  MethodValidationInterceptor </span><br>        List&lt;Object&gt; chain = <span class="hljs-built_in">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);<br><br>        <span class="hljs-comment">// Check whether we have any advice. If we don&#x27;t, we can fallback on direct</span><br>        <span class="hljs-comment">// reflective invocation of the target, and avoid creating a MethodInvocation.</span><br>        <span class="hljs-keyword">if</span> (chain.isEmpty()) &#123;<br>            <span class="hljs-comment">// We can skip creating a MethodInvocation: just invoke the target directly</span><br>            <span class="hljs-comment">// Note that the final invoker must be an InvokerInterceptor so we know it does</span><br>            <span class="hljs-comment">// nothing but a reflective operation on the target, and no hot swapping or fancy proxying.</span><br>            Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);<br>            retVal = AopUtils.invokeJoinpointUsingReflection(target, method, argsToUse);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// è¿™é‡Œçš„chainéç©ºï¼Œæ‰€ä»¥èµ°çš„ä¸‹é¢çš„é€»è¾‘</span><br>            <span class="hljs-comment">// We need to create a method invocation...</span><br>            <span class="hljs-type">MethodInvocation</span> <span class="hljs-variable">invocation</span> <span class="hljs-operator">=</span><br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectiveMethodInvocation</span>(proxy, target, method, args, targetClass, chain);<br>            <span class="hljs-comment">// Proceed to the joinpoint through the interceptor chain.</span><br>            retVal = invocation.proceed();<br>        &#125; <br>        ......<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â ä¸€ç›´<strong>debug</strong>åˆ° <strong>MethodValidationInterceptor</strong> çš„ <strong>invoke</strong>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodValidationInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(MethodInvocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-comment">// Avoid Validator invocation on FactoryBean.getObjectType/isSingleton</span><br>        <span class="hljs-keyword">if</span> (isFactoryBeanMetadataMethod(invocation.getMethod())) &#123;<br>            <span class="hljs-keyword">return</span> invocation.proceed();<br>        &#125;<br><br>        Class&lt;?&gt;[] groups = determineValidationGroups(invocation);<br><br>        <span class="hljs-comment">// Standard Bean Validation 1.1 API</span><br>        <span class="hljs-type">ExecutableValidator</span> <span class="hljs-variable">execVal</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.validator.forExecutables();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">methodToValidate</span> <span class="hljs-operator">=</span> invocation.getMethod();<br>        Set&lt;ConstraintViolation&lt;Object&gt;&gt; result;<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> invocation.getThis();<br>        Assert.state(target != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;Target must not be null&quot;</span>);<br><br>        <span class="hljs-comment">// æ ¡éªŒå‚æ•°</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            result = execVal.validateParameters(target, methodToValidate, invocation.getArguments(), groups);<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (IllegalArgumentException ex) &#123;<br>            <span class="hljs-comment">// Probably a generic type mismatch between interface and impl as reported in SPR-12237 / HV-1011</span><br>            <span class="hljs-comment">// Let&#x27;s try to find the bridged method on the implementation class...</span><br>            methodToValidate = BridgeMethodResolver.findBridgedMethod(<br>                    ClassUtils.getMostSpecificMethod(invocation.getMethod(), target.getClass()));<br>            result = execVal.validateParameters(target, methodToValidate, invocation.getArguments(), groups);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!result.isEmpty()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstraintViolationException</span>(result);<br>        &#125;<br><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">returnValue</span> <span class="hljs-operator">=</span> invocation.proceed();<br>        <span class="hljs-comment">// æ ¡éªŒè¿”å›å€¼ï¼ˆæ²¡è§è¿‡ovoï¼‰</span><br>        result = execVal.validateReturnValue(target, methodToValidate, returnValue, groups);<br>        <span class="hljs-keyword">if</span> (!result.isEmpty()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstraintViolationException</span>(result);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> returnValue;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â å¯ä»¥çœ‹åˆ°åœ¨feignæ¥å£ä¸Šæ·»åŠ @Validatedæ³¨è§£åå®é™…ä¸Šæ˜¯å°†feignå®ä¾‹è¿›è¡Œäº†åŠ¨æ€ä»£ç†ï¼Œåœ¨feignæ–¹æ³•æ‰§è¡Œå‰åç”±ä¸“é—¨çš„æ‹¦æˆªå™¨ MethodValidationInterceptor è¿›è¡Œå‚æ•°æ ¡éªŒã€‚</p><p>Â Â  ä¸‹é¢ç ”ç©¶ä¸‹Springæ˜¯å¦‚ä½•æ ¹æ®@Validatedæ³¨è§£å¯¹feign clientå®ä¾‹è¿›è¡ŒåŠ¨æ€ä»£ç†çš„ï¼Œemmmï¼Œä¸»è¦æ¶‰åŠä¸‰ä¸ªç±»<strong>AbstractAdvisingBeanPostProcessor</strong>ã€<strong>AbstractBeanFactoryAwareAdvisingPostProcessor</strong>ã€<strong>MethodValidationPostProcessor</strong>ï¼Œè¿˜æœ‰ä¸€ä¸ª<strong>FilteredMethodValidationPostProcessor</strong>å¯ä»¥æ³¨å…¥ä¸€äº›<strong>MethodValidationExcludeFilter</strong>æ ‡æ³¨æ ¡éªŒæ—¶æ’é™¤å“ªäº›ç±»ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œç ”ç©¶</p><h4 id="äºŒï¼šå®ç°-RequestInterceptor-æ¥å£-ä½¿ç”¨è¯·æ±‚æ¨¡æ¿ä¸Šçš„æ–¹æ³•æ¥æ£€æŸ¥æŸ¥è¯¢å’Œå€¼"><a href="#äºŒï¼šå®ç°-RequestInterceptor-æ¥å£-ä½¿ç”¨è¯·æ±‚æ¨¡æ¿ä¸Šçš„æ–¹æ³•æ¥æ£€æŸ¥æŸ¥è¯¢å’Œå€¼" class="headerlink" title="äºŒï¼šå®ç°Â RequestInterceptor æ¥å£Â ä½¿ç”¨è¯·æ±‚æ¨¡æ¿ä¸Šçš„æ–¹æ³•æ¥æ£€æŸ¥æŸ¥è¯¢å’Œå€¼"></a>äºŒï¼šå®ç°Â RequestInterceptor æ¥å£Â ä½¿ç”¨è¯·æ±‚æ¨¡æ¿ä¸Šçš„æ–¹æ³•æ¥æ£€æŸ¥æŸ¥è¯¢å’Œå€¼</h4><p>Â Â Â Â å®ç°åŸç†ï¼šSynchronousMethodHandlerï¼ˆClassï¼‰ &#x3D;&gt; invokeï¼ˆMethodï¼‰ &#x3D;&gt; executeAndDecodeï¼ˆMethodï¼‰ &#x3D;&gt; targetRequestï¼ˆMethodï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Request <span class="hljs-title function_">targetRequest</span><span class="hljs-params">(RequestTemplate template)</span> &#123;<br>  <span class="hljs-keyword">for</span> (RequestInterceptor interceptor : requestInterceptors) &#123;<br>    interceptor.apply(template);<br>  &#125;<br>  <span class="hljs-keyword">return</span> target.apply(template);<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â è¿™é‡Œä¼šè°ƒç”¨æ¯ä¸ªæ‹¦æˆªå™¨çš„applyæ–¹æ³•ä»¥ä¾¿åœ¨è¿œç¨‹æ–¹æ³•è°ƒç”¨ä¹‹å‰å¯¹ RequestTemplate è¿›è¡Œè‡ªå®šä¹‰æ“ä½œï¼ˆæ³¨æ„ï¼Œè¿™é‡Œåªèƒ½å¤„ç†è¯·æ±‚å¤´å’ŒæŸ¥è¯¢å­—ç¬¦ä¸²å‚æ•°ï¼‰</p><h4 id="ä¸‰ï¼šå®ç°Encoder-æ¥å£æ¥æ ¡éªŒå¯¹è±¡"><a href="#ä¸‰ï¼šå®ç°Encoder-æ¥å£æ¥æ ¡éªŒå¯¹è±¡" class="headerlink" title="ä¸‰ï¼šå®ç°Encoder æ¥å£æ¥æ ¡éªŒå¯¹è±¡"></a>ä¸‰ï¼šå®ç°Encoder æ¥å£æ¥æ ¡éªŒå¯¹è±¡</h4><p>Â Â Â Â å®ç°åŸç†ï¼šSynchronousMethodHandlerï¼ˆClassï¼‰ &#x3D;&gt; buildTemplateFromArgs.createï¼ˆMethodï¼‰&#x3D;&gt; resolveï¼ˆMethodï¼‰&#x3D;&gt; encoder.encodeï¼ˆMethodï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">encode</span><span class="hljs-params">(Object object, Type bodyType, RequestTemplate template)</span> <span class="hljs-keyword">throws</span> EncodeException;<br></code></pre></td></tr></table></figure><p>Â Â Â Â å…¶ä¸­objectæ˜¯å‚æ•°ï¼ŒbodyTypeæ˜¯å‚æ•°ç±»å‹</p><p>Â Â Â Â è¿™é‡Œæˆ‘ä»¬æ‹¿åˆ°äº†å‚æ•°ï¼Œå°±å¯ä»¥é€šè¿‡Validatoræ¥å¯¹è¯·æ±‚ä½“è¿›è¡Œå‚æ•°æ ¡éªŒäº†ï¼ˆæ³¨æ„ï¼šRequestTemplateæœ‰ä¸€ä¸ªå±æ€§ä¸ºMethodMetadata methodMetadataï¼Œèƒ½æ‹¿åˆ°æ–¹æ³•ä¿¡æ¯ï¼Œå¯ä»¥æ®æ­¤åˆ¤æ–­å‚æ•°æ˜¯å¦éœ€è¦æ ¡éªŒï¼‰</p><h4 id="å››ï¼šé€šè¿‡ä¸ºå‚æ•°æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„Expander-æ¥éªŒè¯å•ä¸ªå‚æ•°"><a href="#å››ï¼šé€šè¿‡ä¸ºå‚æ•°æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„Expander-æ¥éªŒè¯å•ä¸ªå‚æ•°" class="headerlink" title="å››ï¼šé€šè¿‡ä¸ºå‚æ•°æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„Expander æ¥éªŒè¯å•ä¸ªå‚æ•°"></a>å››ï¼šé€šè¿‡ä¸ºå‚æ•°æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„Expander æ¥éªŒè¯å•ä¸ªå‚æ•°</h4><p>Â Â Â Â åœ¨Spring Cloud OpenFeignä¸­ï¼Œ<code>Expander</code>æ¥å£å…è®¸ä½ è‡ªå®šä¹‰å‚æ•°çš„å±•å¼€é€»è¾‘ï¼Œè¿™å¯¹äºå¤„ç†å¤æ‚çš„URLæ¨¡æ¿å‚æ•°éå¸¸æœ‰ç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ éœ€è¦å°†æŸä¸ªå¤æ‚å¯¹è±¡è½¬æ¢ä¸ºURLè·¯å¾„çš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…å¯¹æŸ¥è¯¢å‚æ•°è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œå°±å¯ä»¥å®ç°è‡ªå®šä¹‰çš„<code>Expander</code>ã€‚</p><p>Â Â Â Â ä½¿ç”¨ç¤ºä¾‹ï¼Œå¯ä»¥åœ¨å‚æ•°expandå‰è¿›è¡Œæ ¡éªŒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> feign.Expander;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomExpander</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Expander</span>&lt;Object&gt; &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">expand</span><span class="hljs-params">(Object value)</span> &#123;<br>        <span class="hljs-comment">// å‡è®¾æˆ‘ä»¬å¤„ç†çš„æ˜¯Mapç±»å‹ï¼Œå°†å…¶è½¬æ¢ä¸ºæŸ¥è¯¢å‚æ•°å­—ç¬¦ä¸²</span><br>        <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Map) &#123;<br>            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>            Map&lt;String, String&gt; map = (Map&lt;String, String&gt;) value;<br>            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : map.entrySet()) &#123;<br>                <span class="hljs-keyword">if</span> (sb.length() &gt; <span class="hljs-number">0</span>) &#123;<br>                    sb.append(<span class="hljs-string">&quot;&amp;&quot;</span>);<br>                &#125;<br>                sb.append(entry.getKey()).append(<span class="hljs-string">&quot;=&quot;</span>).append(entry.getValue());<br>            &#125;<br>            <span class="hljs-keyword">return</span> sb.toString();<br>        &#125;<br>        <span class="hljs-comment">// å¦‚æœä¸æ˜¯é¢„æœŸçš„ç±»å‹ï¼Œå¯ä»¥æŠ›å‡ºå¼‚å¸¸æˆ–è€…è¿”å›é»˜è®¤å¤„ç†</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Unsupported type for expansion&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â æ·±å…¥ä½¿ç”¨å¯ä»¥ç»“åˆ<strong>AnnotatedParameterProcessor</strong>ï¼Œå¯ä»¥å‚è€ƒï¼ˆ<a href="https://stackoverflow.com/questions/57811421/how-to-validate-request-parameters-on-feign-client">validation - How to validate request parameters on feign client - Stack Overflow</a>ï¼‰å’Œï¼ˆ<a href="https://stackoverflow.com/questions/35621062/how-to-custom-feignclient-expander-to-convert-param/35835085#35835085">spring - How to custom @FeignClient Expander to convert paramï¼Ÿ - Stack Overflow</a>ï¼‰</p>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SpringCloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringCloud-OpenFeignæ–¹æ³•è°ƒç”¨æµç¨‹å­¦ä¹ </title>
    <link href="/2024/05/27/Spring/SpringCloud/SpringCloud-OpenFeign%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E5%AD%A6%E4%B9%A0/"/>
    <url>/2024/05/27/Spring/SpringCloud/SpringCloud-OpenFeign%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â ä»¥ä¸‹é¢çš„ä»£ç ä½œä¸ºæµ‹è¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/feign&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignClientController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FeignTestService feignTestService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/testFeignCall&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">testFeignCall</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">MockUser</span> <span class="hljs-variable">mockUser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MockUser</span>();<br>        mockUser.setId(<span class="hljs-number">1</span>);<br>        mockUser.setName(<span class="hljs-string">&quot;Handsome Young&quot;</span>);<br>        mockUser.setSex(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> feignTestService.registerUser(mockUser);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â é€šè¿‡ä¹‹å‰feignåˆå§‹åŒ–æµç¨‹å­¦ä¹ ï¼Œæˆ‘ä»¬ç›´åˆ°springåœ¨å¯åŠ¨æ—¶ä¼šå»æ‰«æ@FeignClientæ³¨è§£ä¿®é¥°çš„ç±»ï¼Œç”¨JDKä»£ç†ï¼ˆå¯¹åº”çš„InvocationHandlerä¸º<strong>ReflectiveFeign$FeignInvocationHandler</strong>ï¼‰åæ³¨å…¥åˆ°Springå®¹å™¨ä¸­</p><p>Â Â Â Â ä¸‹é¢æ˜¯è¯·æ±‚ä¸Šé¢çš„æ¥å£æ—¶çš„è°ƒç”¨å †æ ˆï¼ˆå¯ä»¥çœ‹åˆ°@Autowiredæ³¨è§£ä»Spring IOCå®¹å™¨ä¸­æ‹¿åˆ°çš„ä¹Ÿæ˜¯ä¹‹å‰å¡åˆ°å®¹å™¨ä¸­çš„JDKä»£ç†ç±»ï¼‰<br><img src="/2024/05/27/Spring/SpringCloud/SpringCloud-OpenFeign%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B%E5%AD%A6%E4%B9%A0/1063168451020299.png"></p><p>Â Â Â Â ç„¶åèµ°åˆ°äº†ä»£ç†ç±»çš„invokeæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectiveFeign</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Feign</span> &#123;<br><br>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123; <br><br>    FeignInvocationHandler(Target target, Map&lt;Method, MethodHandler&gt; dispatch) &#123;<br>      <span class="hljs-built_in">this</span>.target = checkNotNull(target, <span class="hljs-string">&quot;target&quot;</span>);<br>      <span class="hljs-built_in">this</span>.dispatch = checkNotNull(dispatch, <span class="hljs-string">&quot;dispatch for %s&quot;</span>, target);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;equals&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-type">Object</span> <span class="hljs-variable">otherHandler</span> <span class="hljs-operator">=</span><br>              args.length &gt; <span class="hljs-number">0</span> &amp;&amp; args[<span class="hljs-number">0</span>] != <span class="hljs-literal">null</span> ? Proxy.getInvocationHandler(args[<span class="hljs-number">0</span>]) : <span class="hljs-literal">null</span>;<br>          <span class="hljs-keyword">return</span> equals(otherHandler);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;hashCode&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-keyword">return</span> hashCode();<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;toString&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-keyword">return</span> toString();<br>      &#125;<br>      <span class="hljs-comment">// é™¤äº† equalsã€hashcodeã€toStringç­‰æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•å§”æ‰˜ç»™dispatch</span><br>      <span class="hljs-comment">// è·å–åˆ°å¯¹åº”çš„ MethodHandler åå†è°ƒç”¨</span><br>      <span class="hljs-keyword">return</span> dispatch.get(method).invoke(args);<br>    &#125; <br><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â è¿™é‡Œçš„<strong>MethodHandler</strong>ä¸€èˆ¬æ˜¯<strong>SynchronousMethodHandler</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronousMethodHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodHandler</span> &#123; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object[] argv)</span> <span class="hljs-keyword">throws</span> Throwable &#123; <br>    <span class="hljs-comment">// åœ¨ä¸‹é¢æ–¹æ³•çš„resolveæ–¹æ³•é‡Œä¼šä½¿ç”¨encoderè¿›è¡Œç¼–ç å¤„ç†</span><br>    <span class="hljs-type">RequestTemplate</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> buildTemplateFromArgs.create(argv);<br>    <span class="hljs-type">Options</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> findOptions(argv);<br>    <span class="hljs-type">Retryer</span> <span class="hljs-variable">retryer</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.retryer.clone();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> executeAndDecode(template, options);<br>      &#125; <span class="hljs-keyword">catch</span> (RetryableException e) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// é‡è¯•é€»è¾‘</span><br>          retryer.continueOrPropagate(e);<br>        &#125; <span class="hljs-keyword">catch</span> (RetryableException th) &#123;<br>          <span class="hljs-type">Throwable</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> th.getCause();<br>          <span class="hljs-keyword">if</span> (propagationPolicy == UNWRAP &amp;&amp; cause != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> cause;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> th;<br>          &#125;<br>        &#125;<br>        ......<br>        <span class="hljs-keyword">continue</span>;<br>      &#125;<br>    &#125;<br>  &#125;    <br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â æ¥ä¸‹æ¥å°±åˆ°äº†é‡ç‚¹çš„æ‰§è¡Œé€»è¾‘äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronousMethodHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodHandler</span> &#123; <br><br>  Object <span class="hljs-title function_">executeAndDecode</span><span class="hljs-params">(RequestTemplate template, Options options)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-comment">// è°ƒç”¨æ‰€æœ‰Spring IOCå®¹å™¨ä¸­çš„ RequestInterceptor å¯¹ template è¿›è¡Œä¿®é¥°</span><br>    <span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> targetRequest(template);<br><br>    <span class="hljs-keyword">if</span> (logLevel != Logger.Level.NONE) &#123;<br>      logger.logRequest(metadata.configKey(), logLevel, request);<br>    &#125;<br><br>    Response response;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// è¿™é‡Œçš„clientæ˜¯ FeignBlockingLoadBalancerClient</span><br>      response = client.execute(request, options);<br>      <span class="hljs-comment">// ensure the request is set. <span class="hljs-doctag">TODO:</span> remove in Feign 12</span><br>      response = response.toBuilder()<br>          .request(request)<br>          .requestTemplate(template)<br>          .build();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>      <span class="hljs-keyword">if</span> (logLevel != Logger.Level.NONE) &#123;<br>        logger.logIOException(metadata.configKey(), logLevel, e, elapsedTime(start));<br>      &#125;<br>      <span class="hljs-keyword">throw</span> errorExecuting(request, e);<br>    &#125;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">elapsedTime</span> <span class="hljs-operator">=</span> TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - start);<br>    <span class="hljs-comment">// é»˜è®¤æƒ…å†µä¸‹ SynchronousMethodHandler çš„ forceDecoding å±æ€§ä¸ºfalse</span><br>    <span class="hljs-comment">// å¯¹åº”çš„decoderä¸ºnull</span><br>    <span class="hljs-comment">// forDecodingä¸ºtrueæ—¶æºç ä¸­çš„æ³¨é‡Šä¸ºï¼š</span><br>    <span class="hljs-comment">// internal only: usual handling will be short-circuited, </span><br>    <span class="hljs-comment">// and all responses will be passed to decoder directly!</span><br>    <span class="hljs-comment">// ä»…é™å†…éƒ¨:é€šå¸¸çš„å¤„ç†å°†è¢«çŸ­è·¯ï¼Œæ‰€æœ‰å“åº”å°†ç›´æ¥ä¼ é€’ç»™è§£ç å™¨ï¼</span><br>    <span class="hljs-keyword">if</span> (decoder != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> responseInterceptor<br>          .aroundDecode(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InvocationContext</span>(decoder, metadata.returnType(), response));<br>    &#125;<br><br>    CompletableFuture&lt;Object&gt; resultFuture = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>&lt;&gt;();<br>    asyncResponseHandler.handleResponse(resultFuture, metadata.configKey(), response,<br>        metadata.returnType(), elapsedTime);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (!resultFuture.isDone())<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Response handling not done&quot;</span>);<br>      <span class="hljs-keyword">return</span> resultFuture.join();<br>    &#125; <span class="hljs-keyword">catch</span> (CompletionException e) &#123;<br>      <span class="hljs-type">Throwable</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> e.getCause();<br>      <span class="hljs-keyword">if</span> (cause != <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">throw</span> cause;<br>      <span class="hljs-keyword">throw</span> e;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignBlockingLoadBalancerClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Client</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">execute</span><span class="hljs-params">(Request request, Request.Options options)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">URI</span> <span class="hljs-variable">originalUri</span> <span class="hljs-operator">=</span> URI.create(request.url());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">serviceId</span> <span class="hljs-operator">=</span> originalUri.getHost();<br>        Assert.state(serviceId != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;Request URI does not contain a valid hostname: &quot;</span> + originalUri);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">hint</span> <span class="hljs-operator">=</span> getHint(serviceId);<br>        DefaultRequest&lt;RequestDataContext&gt; lbRequest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRequest</span>&lt;&gt;(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestDataContext</span>(buildRequestData(request), hint));<br>        <span class="hljs-comment">// ä»å®¹å™¨ä¸­è·å–æ‰€æœ‰æ”¯æŒçš„ LoadBalancerLifecycle </span><br>        Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors = LoadBalancerLifecycleValidator<br>                .getSupportedLifecycleProcessors(<br>                        loadBalancerClientFactory.getInstances(serviceId, LoadBalancerLifecycle.class),<br>                        RequestDataContext.class, ResponseData.class, ServiceInstance.class);<br>        <span class="hljs-comment">// æ‰§è¡Œ LoadBalancerLifecycle çš„ onStartæ–¹æ³•</span><br>        supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onStart(lbRequest));<br>        <span class="hljs-comment">// é€šè¿‡loadbalanceé€‰æ‹© ServiceInstance</span><br>        <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> loadBalancerClient.choose(serviceId, lbRequest);<br>        org.springframework.cloud.client.loadbalancer.Response&lt;ServiceInstance&gt; lbResponse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResponse</span>(<br>                instance);<br>        <span class="hljs-comment">// loadbalanceæ²¡æœ‰æ‰¾åˆ°ç›¸åº”çš„serviceInstanceï¼Œè¿”å›503</span><br>        <span class="hljs-comment">// SERVICE_UNAVAILABLE</span><br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Load balancer does not contain an instance for the service &quot;</span> + serviceId;<br>            <span class="hljs-keyword">if</span> (LOG.isWarnEnabled()) &#123;<br>                LOG.warn(message);<br>            &#125;<br>            supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle<br>                    .onComplete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionContext</span>&lt;ResponseData, ServiceInstance, RequestDataContext&gt;(<br>                            CompletionContext.Status.DISCARD, lbRequest, lbResponse)));<br>            <span class="hljs-keyword">return</span> Response.builder().request(request).status(HttpStatus.SERVICE_UNAVAILABLE.value())<br>                    .body(message, StandardCharsets.UTF_8).build();<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">reconstructedUrl</span> <span class="hljs-operator">=</span> loadBalancerClient.reconstructURI(instance, originalUri).toString();<br>        <span class="hljs-type">Request</span> <span class="hljs-variable">newRequest</span> <span class="hljs-operator">=</span> buildRequest(request, reconstructedUrl);<br>        <span class="hljs-type">LoadBalancerProperties</span> <span class="hljs-variable">loadBalancerProperties</span> <span class="hljs-operator">=</span> loadBalancerClientFactory.getProperties(serviceId);<br>        <span class="hljs-keyword">return</span> executeWithLoadBalancerLifecycleProcessing(delegate, options, newRequest, lbRequest, lbResponse,<br>                supportedLifecycleProcessors, loadBalancerProperties.isUseRawStatusCodeInResponseData());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;T&gt; ServiceInstance <span class="hljs-title function_">choose</span><span class="hljs-params">(String serviceId, Request&lt;T&gt; request)</span> &#123;<br>    <span class="hljs-comment">// è¿™é‡Œæ˜¯ä»Spring å®¹å™¨ä¸­è·å– ReactiveLoadBalancer&lt;ServiceInstance&gt; å¯¹è±¡</span><br>    ReactiveLoadBalancer&lt;ServiceInstance&gt; loadBalancer = loadBalancerClientFactory.getInstance(serviceId);<br>    <span class="hljs-keyword">if</span> (loadBalancer == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    Response&lt;ServiceInstance&gt; loadBalancerResponse = Mono.from(loadBalancer.choose(request)).block();<br>    <span class="hljs-keyword">if</span> (loadBalancerResponse == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> loadBalancerResponse.getServer();<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â ç„¶åèµ°åˆ° <strong>LoadBalancerUtils</strong> çš„ <strong>executeWithLoadBalancerLifecycleProcessing</strong> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadBalancerUtils</span> &#123;<br><br>    <span class="hljs-keyword">static</span> Response <span class="hljs-title function_">executeWithLoadBalancerLifecycleProcessing</span><span class="hljs-params">(Client feignClient, Request.Options options,</span><br><span class="hljs-params">            Request feignRequest, org.springframework.cloud.client.loadbalancer.Request lbRequest,</span><br><span class="hljs-params">            org.springframework.cloud.client.loadbalancer.Response&lt;ServiceInstance&gt; lbResponse,</span><br><span class="hljs-params">            Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors, <span class="hljs-type">boolean</span> loadBalanced, <span class="hljs-type">boolean</span> useRawStatusCodes)</span><br>            <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// æ‰¹é‡æ‰§è¡Œæ‰§è¡Œ LoadBalancerLifecycle çš„ onStartRequest æ–¹æ³•</span><br>        supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onStartRequest(lbRequest, lbResponse));<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è¿™é‡Œçš„feignClientæ˜¯ Client$DefaultClient</span><br>            <span class="hljs-comment">// è¯·æ±‚å‘é€å’Œå¤„ç†æ˜¯ç”± HttpURLConnection å®Œæˆ</span><br>            <span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> feignClient.execute(feignRequest, options);<br>            <span class="hljs-keyword">if</span> (loadBalanced) &#123;<br>                supportedLifecycleProcessors.forEach(<br>                        lifecycle -&gt; lifecycle.onComplete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionContext</span>&lt;&gt;(CompletionContext.Status.SUCCESS,<br>                                lbRequest, lbResponse, buildResponseData(response, useRawStatusCodes))));<br>            &#125;<br>            <span class="hljs-keyword">return</span> response;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Exception exception) &#123;<br>            <span class="hljs-keyword">if</span> (loadBalanced) &#123;<br>                supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onComplete(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletionContext</span>&lt;&gt;(CompletionContext.Status.FAILED, exception, lbRequest, lbResponse)));<br>            &#125;<br>            <span class="hljs-keyword">throw</span> exception;<br>        &#125;<br>    &#125;   <br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â æœ€åç”±<strong>asyncResponseHandler</strong>æ¥å¤„ç†response</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncResponseHandler</span> &#123;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResponse</span><span class="hljs-params">(CompletableFuture&lt;Object&gt; resultFuture,</span><br><span class="hljs-params">                      String configKey,</span><br><span class="hljs-params">                      Response response,</span><br><span class="hljs-params">                      Type returnType,</span><br><span class="hljs-params">                      <span class="hljs-type">long</span> elapsedTime)</span> &#123;<br>    <span class="hljs-comment">// copied fairly liberally from SynchronousMethodHandler</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">shouldClose</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (logLevel != Level.NONE) &#123;<br>        response = logger.logAndRebufferResponse(configKey, logLevel, response,<br>            elapsedTime);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (Response.class == returnType) &#123;<br>        <span class="hljs-keyword">if</span> (response.body() == <span class="hljs-literal">null</span>) &#123;<br>          resultFuture.complete(response);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response.body().length() == <span class="hljs-literal">null</span><br>            || response.body().length() &gt; MAX_RESPONSE_BUFFER_SIZE) &#123;<br>          shouldClose = <span class="hljs-literal">false</span>;<br>          resultFuture.complete(response);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// Ensure the response body is disconnected</span><br>          <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] bodyData = Util.toByteArray(response.body().asInputStream());<br>          resultFuture.complete(response.toBuilder().body(bodyData).build());<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response.status() &gt;= <span class="hljs-number">200</span> &amp;&amp; response.status() &lt; <span class="hljs-number">300</span>) &#123;<br>        <span class="hljs-keyword">if</span> (isVoidType(returnType)) &#123;<br>          resultFuture.complete(<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// è¿”å›å€¼ç±»å‹ä¸æ˜¯voidçš„è¯ï¼Œå…ˆè§£ç ï¼Œè¿™é‡Œçš„è§£ç å™¨decoderæ˜¯åœ¨ä¹‹å‰é…ç½®feignçš„æ—¶å€™</span><br>          <span class="hljs-comment">// é…ç½®çš„</span><br>          <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> decode(response, returnType);<br>          shouldClose = closeAfterDecode;<br>          resultFuture.complete(result);<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dismiss404 &amp;&amp; response.status() == <span class="hljs-number">404</span> &amp;&amp; !isVoidType(returnType)) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> decode(response, returnType);<br>        shouldClose = closeAfterDecode;<br>        resultFuture.complete(result);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¼‚å¸¸å¤„ç†ï¼ˆè¿™é‡Œä¼šè°ƒç”¨errorDecoderè¿›è¡Œè§£ç ï¼‰</span><br>        resultFuture.completeExceptionally(errorDecoder.decode(configKey, response));<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> IOException e) &#123;<br>      <span class="hljs-keyword">if</span> (logLevel != Level.NONE) &#123;<br>        logger.logIOException(configKey, logLevel, e, elapsedTime);<br>      &#125;<br>      resultFuture.completeExceptionally(errorReading(response.request(), response, e));<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> Exception e) &#123;<br>      resultFuture.completeExceptionally(e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (shouldClose) &#123;<br>        ensureClosed(response.body());<br>      &#125;<br>    &#125;<br><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â æœ€åé€šè¿‡ <strong>resultFuture.join()</strong> è¿”å›è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„è¿”å›å€¼ï¼Œè‡³æ­¤ï¼Œä¸€ä¸ªfeignçš„æ–¹æ³•è°ƒç”¨è¿‡ç¨‹å·®ä¸å¤šå°±ç»“æŸäº†</p>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SpringCloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringCloud-OpenFeignåˆå§‹åŒ–æµç¨‹å­¦ä¹ </title>
    <link href="/2024/05/24/Spring/SpringCloud/SpringCloud-OpenFeign%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E5%AD%A6%E4%B9%A0/"/>
    <url>/2024/05/24/Spring/SpringCloud/SpringCloud-OpenFeign%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â ä»@EnableFeignClients æ³¨è§£å¼€å§‹è®²èµ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(FeignClientsRegistrar.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableFeignClients &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Alias for the &#123;<span class="hljs-doctag">@link</span> #basePackages()&#125; attribute. Allows for more concise annotation</span><br><span class="hljs-comment">     * declarations e.g.: &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@ComponentScan</span>(&quot;org.my.pkg&quot;)&#125; instead of</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@ComponentScan</span>(basePackages=&quot;org.my.pkg&quot;)&#125;.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the array of &#x27;basePackages&#x27;.</span><br><span class="hljs-comment">     */</span><br>    String[] value() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Base packages to scan for annotated components.</span><br><span class="hljs-comment">     * &lt;p&gt;</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> #value()&#125; is an alias for (and mutually exclusive with) this attribute.</span><br><span class="hljs-comment">     * &lt;p&gt;</span><br><span class="hljs-comment">     * Use &#123;<span class="hljs-doctag">@link</span> #basePackageClasses()&#125; for a type-safe alternative to String-based</span><br><span class="hljs-comment">     * package names.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the array of &#x27;basePackages&#x27;.</span><br><span class="hljs-comment">     */</span><br>    String[] basePackages() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Type-safe alternative to &#123;<span class="hljs-doctag">@link</span> #basePackages()&#125; for specifying the packages to</span><br><span class="hljs-comment">     * scan for annotated components. The package of each class specified will be scanned.</span><br><span class="hljs-comment">     * &lt;p&gt;</span><br><span class="hljs-comment">     * Consider creating a special no-op marker class or interface in each package that</span><br><span class="hljs-comment">     * serves no purpose other than being referenced by this attribute.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the array of &#x27;basePackageClasses&#x27;.</span><br><span class="hljs-comment">     */</span><br>    Class&lt;?&gt;[] basePackageClasses() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * A custom &lt;code&gt;<span class="hljs-doctag">@Configuration</span>&lt;/code&gt; for all feign clients. Can contain override</span><br><span class="hljs-comment">     * &lt;code&gt;<span class="hljs-doctag">@Bean</span>&lt;/code&gt; definition for the pieces that make up the client, for instance</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> feign.codec.Decoder&#125;, &#123;<span class="hljs-doctag">@link</span> feign.codec.Encoder&#125;, &#123;<span class="hljs-doctag">@link</span> feign.Contract&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> FeignClientsConfiguration for the defaults</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> list of default configurations</span><br><span class="hljs-comment">     */</span><br>    Class&lt;?&gt;[] defaultConfiguration() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * List of classes annotated with <span class="hljs-doctag">@FeignClient</span>. If not empty, disables classpath</span><br><span class="hljs-comment">     * scanning.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> list of FeignClient classes</span><br><span class="hljs-comment">     */</span><br>    Class&lt;?&gt;[] clients() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ³¨è§£ import äº†ä¸€ä¸ªåä¸º <strong>FeignClientsRegistrar</strong>çš„ç±»ï¼Œå…¶å®ç°äº†<strong>ImportBeanDefinitionRegistrar</strong>æ¥å£ï¼Œåœ¨æ³¨å†Œbean definitionçš„æœ€åï¼ˆæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹<strong>ConfigurationClassPostProcessor çš„ processConfigBeanDefinitions</strong>æ–¹æ³•ï¼‰è°ƒç”¨å…¶<strong>registerBeanDefinitions</strong>æ–¹æ³•æ³¨å†Œç›¸å…³çš„bean definition</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignClientsRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware, EnvironmentAware &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;                    <br>        <span class="hljs-comment">// æ³¨å†Œå…¨å±€é…ç½®ç±»</span><br>        registerDefaultConfiguration(metadata, registry);<br>        <span class="hljs-comment">// æ³¨å†Œfeign client</span><br>        registerFeignClients(metadata, registry);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerDefaultConfiguration</span><span class="hljs-params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;<br>    Map&lt;String, Object&gt; defaultAttrs = metadata.getAnnotationAttributes(EnableFeignClients.class.getName(), <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-keyword">if</span> (defaultAttrs != <span class="hljs-literal">null</span> &amp;&amp; defaultAttrs.containsKey(<span class="hljs-string">&quot;defaultConfiguration&quot;</span>)) &#123;<br>        String name;<br>        <span class="hljs-keyword">if</span> (metadata.hasEnclosingClass()) &#123;<br>            name = <span class="hljs-string">&quot;default.&quot;</span> + metadata.getEnclosingClassName();<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            name = <span class="hljs-string">&quot;default.&quot;</span> + metadata.getClassName();<br>        &#125;<br>        <span class="hljs-comment">// è¿™ä¸ªæ–¹æ³•å…¶å®æ˜¯å¾€ registry ä¸­æ³¨å†Œä¸€ä¸ªåä¸º name + &quot;.&quot; + FeignClientSpecification.class.getSimpleName()</span><br>        <span class="hljs-comment">// å‚æ•°åˆ†åˆ«ä¸º nameã€configurationçš„ FeignClientSpecification</span><br>        registerClientConfiguration(registry, name, defaultAttrs.get(<span class="hljs-string">&quot;defaultConfiguration&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerClientConfiguration</span><span class="hljs-params">(BeanDefinitionRegistry registry, Object name, Object configuration)</span> &#123;<br>    <span class="hljs-type">BeanDefinitionBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(FeignClientSpecification.class);<br>    builder.addConstructorArgValue(name);<br>    builder.addConstructorArgValue(configuration);<br>    registry.registerBeanDefinition(name + <span class="hljs-string">&quot;.&quot;</span> + FeignClientSpecification.class.getSimpleName(),<br>            builder.getBeanDefinition());<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerFeignClients</span><span class="hljs-params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;<br><br>    LinkedHashSet&lt;BeanDefinition&gt; candidateComponents = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br>    Map&lt;String, Object&gt; attrs = metadata.getAnnotationAttributes(EnableFeignClients.class.getName());<br>    <span class="hljs-keyword">final</span> Class&lt;?&gt;[] clients = attrs == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : (Class&lt;?&gt;[]) attrs.get(<span class="hljs-string">&quot;clients&quot;</span>);<br>    <span class="hljs-comment">// æ²¡æœ‰æŒ‡å®šclientsï¼Œåˆ™åœ¨æŒ‡å®šç±»è·¯å¾„ä¸‹æ‰«æç­›é€‰æ‰€æœ‰è¢«</span><br>    <span class="hljs-comment">// @FeignClientæ³¨è§£ä¿®é¥°çš„ç±»</span><br>    <span class="hljs-keyword">if</span> (clients == <span class="hljs-literal">null</span> || clients.length == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">ClassPathScanningCandidateComponentProvider</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> getScanner();<br>        scanner.setResourceLoader(<span class="hljs-built_in">this</span>.resourceLoader);<br>        scanner.addIncludeFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeFilter</span>(FeignClient.class));<br>        Set&lt;String&gt; basePackages = getBasePackages(metadata);<br>        <span class="hljs-keyword">for</span> (String basePackage : basePackages) &#123;<br>            candidateComponents.addAll(scanner.findCandidateComponents(basePackage));<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// å¦åˆ™ï¼Œæ·»åŠ clientsä¸­æŒ‡å®šçš„ç±»</span><br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">for</span> (Class&lt;?&gt; clazz : clients) &#123;<br>            candidateComponents.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotatedGenericBeanDefinition</span>(clazz));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (BeanDefinition candidateComponent : candidateComponents) &#123;<br>        <span class="hljs-keyword">if</span> (candidateComponent <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition) &#123;<br>            <span class="hljs-comment">// verify annotated class is an interface</span><br>            <span class="hljs-type">AnnotatedBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> (AnnotatedBeanDefinition) candidateComponent;<br>            <span class="hljs-type">AnnotationMetadata</span> <span class="hljs-variable">annotationMetadata</span> <span class="hljs-operator">=</span> beanDefinition.getMetadata();<br>            Assert.isTrue(annotationMetadata.isInterface(), <span class="hljs-string">&quot;@FeignClient can only be specified on an interface&quot;</span>);<br><br>            Map&lt;String, Object&gt; attributes = annotationMetadata<br>                    .getAnnotationAttributes(FeignClient.class.getCanonicalName());<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> getClientName(attributes);<br>            <span class="hljs-comment">// æ³¨å†ŒfeignClientå¯¹åº”çš„é…ç½®ç±»</span><br>            registerClientConfiguration(registry, name, attributes.get(<span class="hljs-string">&quot;configuration&quot;</span>));<br>            <span class="hljs-comment">// æ³¨å†ŒfeigClient</span><br>            registerFeignClient(registry, annotationMetadata, attributes);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerFeignClient</span><span class="hljs-params">(BeanDefinitionRegistry registry, AnnotationMetadata annotationMetadata,</span><br><span class="hljs-params">Map&lt;String, Object&gt; attributes)</span> &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> annotationMetadata.getClassName();<br><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> ClassUtils.resolveClassName(className, <span class="hljs-literal">null</span>);<br><span class="hljs-type">ConfigurableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> registry <span class="hljs-keyword">instanceof</span> ConfigurableBeanFactory<br>? (ConfigurableBeanFactory) registry : <span class="hljs-literal">null</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">contextId</span> <span class="hljs-operator">=</span> getContextId(beanFactory, attributes);<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> getName(attributes);<br>    <span class="hljs-comment">// feignClientå®ä¾‹å§”æ‰˜ç»™ FeignClientFactoryBean åˆ›å»º</span><br><span class="hljs-type">FeignClientFactoryBean</span> <span class="hljs-variable">factoryBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FeignClientFactoryBean</span>();<br>factoryBean.setBeanFactory(beanFactory);<br>factoryBean.setName(name);<br>factoryBean.setContextId(contextId);<br>factoryBean.setType(clazz);<br>factoryBean.setRefreshableClient(isClientRefreshEnabled());<br><span class="hljs-type">BeanDefinitionBuilder</span> <span class="hljs-variable">definition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(clazz, () -&gt; &#123;<br>factoryBean.setUrl(getUrl(beanFactory, attributes));<br>factoryBean.setPath(getPath(beanFactory, attributes));<br>factoryBean.setDecode404(Boolean.parseBoolean(String.valueOf(attributes.get(<span class="hljs-string">&quot;decode404&quot;</span>))));<br><span class="hljs-type">Object</span> <span class="hljs-variable">fallback</span> <span class="hljs-operator">=</span> attributes.get(<span class="hljs-string">&quot;fallback&quot;</span>);<br><span class="hljs-keyword">if</span> (fallback != <span class="hljs-literal">null</span>) &#123;<br>factoryBean.setFallback(fallback <span class="hljs-keyword">instanceof</span> Class ? (Class&lt;?&gt;) fallback<br>: ClassUtils.resolveClassName(fallback.toString(), <span class="hljs-literal">null</span>));<br>&#125;<br><span class="hljs-type">Object</span> <span class="hljs-variable">fallbackFactory</span> <span class="hljs-operator">=</span> attributes.get(<span class="hljs-string">&quot;fallbackFactory&quot;</span>);<br><span class="hljs-keyword">if</span> (fallbackFactory != <span class="hljs-literal">null</span>) &#123;<br>factoryBean.setFallbackFactory(fallbackFactory <span class="hljs-keyword">instanceof</span> Class ? (Class&lt;?&gt;) fallbackFactory<br>: ClassUtils.resolveClassName(fallbackFactory.toString(), <span class="hljs-literal">null</span>));<br>&#125;<br><span class="hljs-keyword">return</span> factoryBean.getObject();<br>&#125;);<br>definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);<br>definition.setLazyInit(<span class="hljs-literal">true</span>);<br>validate(attributes);<br><br><span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> definition.getBeanDefinition();<br>beanDefinition.setAttribute(FactoryBean.OBJECT_TYPE_ATTRIBUTE, className);<br>beanDefinition.setAttribute(<span class="hljs-string">&quot;feignClientsRegistrarFactoryBean&quot;</span>, factoryBean);<br><br><span class="hljs-comment">// has a default, won&#x27;t be null</span><br><span class="hljs-type">boolean</span> <span class="hljs-variable">primary</span> <span class="hljs-operator">=</span> (Boolean) attributes.get(<span class="hljs-string">&quot;primary&quot;</span>);<br><br>beanDefinition.setPrimary(primary);<br>    <br>    <span class="hljs-comment">// è·å–æŒ‡å®šçš„å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†</span><br>String[] qualifiers = getQualifiers(attributes);<br><span class="hljs-keyword">if</span> (ObjectUtils.isEmpty(qualifiers)) &#123;<br>        <span class="hljs-comment">// é»˜è®¤å€¼æ˜¯ contextId + &quot;FeignClient&quot;</span><br>qualifiers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; contextId + <span class="hljs-string">&quot;FeignClient&quot;</span> &#125;;<br>&#125;<br><br><span class="hljs-type">BeanDefinitionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(beanDefinition, className, qualifiers);<br>    <span class="hljs-comment">// æ³¨å†Œbean definition</span><br>BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);<br><br>    <span class="hljs-comment">// è¿™ä¸ªæ–¹æ³•æ—¨åœ¨åˆ›å»ºå¸¦æœ‰refreshScopeé€‰é¡¹çš„Request.options bean definition</span><br>registerOptionsBeanDefinition(registry, contextId);<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â ä¸‹é¢é‡ç‚¹å°±æ˜¯çœ‹ FeignClientFactoryBean æ˜¯å¦‚ä½•ç”Ÿæˆå·¥å‚beançš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignClientFactoryBean</span><br><span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;Object&gt;, InitializingBean, ApplicationContextAware, BeanFactoryAware &#123;<br>    <br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-keyword">return</span> getTarget();<br>&#125; <br><br>    <span class="hljs-comment">// è¿”å›ç”¨æŒ‡å®šæ•°æ®å’Œä¸Šä¸‹æ–‡ä¿¡æ¯åˆ›å»ºçš„Feign client</span><br>&lt;T&gt; T <span class="hljs-title function_">getTarget</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">FeignContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> beanFactory != <span class="hljs-literal">null</span> ? beanFactory.getBean(FeignContext.class)<br>: applicationContext.getBean(FeignContext.class);<br>Feign.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> feign(context);<br>        ......<br>&#125;    <br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â å…ˆçœ‹ä¸‹ <strong>feign(context)</strong> æ–¹æ³•ï¼Œæ­¤æ–¹æ³•å¯¹feignè¿›è¡Œç›¸å…³é…ç½®ï¼Œå¦‚æ—¥å¿—ã€Encoderã€Decoderã€Contractç­‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Feign.Builder <span class="hljs-title function_">feign</span><span class="hljs-params">(FeignContext context)</span> &#123;<br><span class="hljs-type">FeignLoggerFactory</span> <span class="hljs-variable">loggerFactory</span> <span class="hljs-operator">=</span> get(context, FeignLoggerFactory.class);<br><span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> loggerFactory.create(type);<br><br><span class="hljs-comment">// @formatter:off</span><br>Feign.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> get(context, Feign.Builder.class)<br><span class="hljs-comment">// required values</span><br>.logger(logger)<br>            <span class="hljs-comment">// é»˜è®¤æ˜¯ SpringEncoder</span><br>.encoder(get(context, Encoder.class))<br>            <span class="hljs-comment">// é»˜è®¤æ˜¯ OptionalDecoder</span><br>.decoder(get(context, Decoder.class))<br>            <span class="hljs-comment">// é»˜è®¤æ˜¯ SpringMvcContract</span><br>.contract(get(context, Contract.class));<br><span class="hljs-comment">// @formatter:on</span><br>    <br>    <span class="hljs-comment">// æ­¤æ–¹æ³•é‡Œè¿›è¡Œäº†å¾ˆå¤šfeignçš„é…ç½®ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹</span><br>configureFeign(context, builder);<br><br><span class="hljs-keyword">return</span> builder;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â æ¥ç€å¾€ä¸‹çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;T&gt; T <span class="hljs-title function_">getTarget</span><span class="hljs-params">()</span> &#123;<br>    ......<br>    <span class="hljs-comment">// æ²¡æœ‰æŒ‡å®šurlï¼Œé€šè¿‡load-balanceé€‰æ‹©ä¸€ä¸ªå®ä¾‹</span><br><span class="hljs-keyword">if</span> (!StringUtils.hasText(url)) &#123;<br><br><span class="hljs-keyword">if</span> (LOG.isInfoEnabled()) &#123;<br>LOG.info(<span class="hljs-string">&quot;For &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27; URL not provided. Will try picking an instance via load-balancing.&quot;</span>);<br>&#125;<br><span class="hljs-keyword">if</span> (!name.startsWith(<span class="hljs-string">&quot;http&quot;</span>)) &#123;<br>url = <span class="hljs-string">&quot;http://&quot;</span> + name;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>url = name;<br>&#125;<br>url += cleanPath();<br><span class="hljs-keyword">return</span> (T) loadBalance(builder, context, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HardCodedTarget</span>&lt;&gt;(type, name, url));<br>&#125;<br>Â Â Â Â ......<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">loadBalance</span><span class="hljs-params">(Feign.Builder builder, FeignContext context, HardCodedTarget&lt;T&gt; target)</span> &#123;<br><span class="hljs-type">Client</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> getOptional(context, Client.class);<br><span class="hljs-keyword">if</span> (client != <span class="hljs-literal">null</span>) &#123;<br>builder.client(client);<br>        <span class="hljs-comment">// åº”ç”¨ FeignBuilderCustomizer å¯¹builderè¿›è¡Œå®šåˆ¶åŒ–</span><br>applyBuildCustomizers(context, builder);<br>        <span class="hljs-comment">// è¿™é‡Œæ‹¿åˆ°çš„æ˜¯ DefaultTargeter</span><br><span class="hljs-type">Targeter</span> <span class="hljs-variable">targeter</span> <span class="hljs-operator">=</span> get(context, Targeter.class);<br>        <span class="hljs-comment">// å¯¹targetè¿›è¡Œä»£ç†</span><br><span class="hljs-keyword">return</span> targeter.target(<span class="hljs-built_in">this</span>, builder, context, target);<br>&#125;<br><br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br><span class="hljs-string">&quot;No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-loadbalancer?&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â æ¥ç€å¾€ä¸‹çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;T&gt; T <span class="hljs-title function_">getTarget</span><span class="hljs-params">()</span> &#123;<br>    ......<br>    <span class="hljs-comment">// ä¸‹é¢çš„æ“ä½œå’Œloadbalanceæ—¶å·®ä¸å¤š</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.url + cleanPath();<br><span class="hljs-type">Client</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> getOptional(context, Client.class);<br><span class="hljs-keyword">if</span> (client != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (client <span class="hljs-keyword">instanceof</span> FeignBlockingLoadBalancerClient) &#123;<br><span class="hljs-comment">// not load balancing because we have a url,</span><br><span class="hljs-comment">// but Spring Cloud LoadBalancer is on the classpath, so unwrap</span><br>client = ((FeignBlockingLoadBalancerClient) client).getDelegate();<br>&#125;<br><span class="hljs-keyword">if</span> (client <span class="hljs-keyword">instanceof</span> RetryableFeignBlockingLoadBalancerClient) &#123;<br><span class="hljs-comment">// not load balancing because we have a url,</span><br><span class="hljs-comment">// but Spring Cloud LoadBalancer is on the classpath, so unwrap</span><br>client = ((RetryableFeignBlockingLoadBalancerClient) client).getDelegate();<br>&#125;<br>builder.client(client);<br>&#125;<br><br>applyBuildCustomizers(context, builder);<br><br><span class="hljs-type">Targeter</span> <span class="hljs-variable">targeter</span> <span class="hljs-operator">=</span> get(context, Targeter.class);<br><span class="hljs-keyword">return</span> (T) targeter.target(<span class="hljs-built_in">this</span>, builder, context, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HardCodedTarget</span>&lt;&gt;(type, name, url));<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â æ¥ä¸‹æ¥çœ‹ä¸‹Targeteræ˜¯å¦‚ä½•ä»£ç†feignClientçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultTargeter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Targeter</span> &#123;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">target</span><span class="hljs-params">(FeignClientFactoryBean factory, Feign.Builder feign, FeignContext context,</span><br><span class="hljs-params">Target.HardCodedTarget&lt;T&gt; target)</span> &#123;<br>        <span class="hljs-comment">// å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯å§”æ‰˜ç»™äº†Feign.Builder.target æ–¹æ³•</span><br><span class="hljs-keyword">return</span> feign.target(target);<br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Feign</span> &#123;<br>    <br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span>&lt;Builder&gt; &#123;<br>    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">target</span><span class="hljs-params">(Target&lt;T&gt; target)</span> &#123;<br>      <span class="hljs-keyword">return</span> build().newInstance(target);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Feign <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-built_in">super</span>.enrich();<br><br>      SynchronousMethodHandler.<span class="hljs-type">Factory</span> <span class="hljs-variable">synchronousMethodHandlerFactory</span> <span class="hljs-operator">=</span><br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousMethodHandler</span>.Factory(client, retryer, requestInterceptors,<br>              responseInterceptor, logger, logLevel, dismiss404, closeAfterDecode,<br>              propagationPolicy, forceDecoding);<br>      <span class="hljs-type">ParseHandlersByName</span> <span class="hljs-variable">handlersByName</span> <span class="hljs-operator">=</span><br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParseHandlersByName</span>(contract, options, encoder, decoder, queryMapEncoder,<br>              errorDecoder, synchronousMethodHandlerFactory);<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectiveFeign</span>(handlersByName, invocationHandlerFactory, queryMapEncoder);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â å¯ä»¥çœ‹åˆ°æœ€ç»ˆæ˜¯å§”æ‰˜ç»™äº†<strong>ReflectiveFeign</strong>çš„<strong>newInstance</strong>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectiveFeign</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Feign</span> &#123;<br>    <br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">newInstance</span><span class="hljs-params">(Target&lt;T&gt; target)</span> &#123;<br>    <span class="hljs-comment">// éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ MethodHandler éƒ½æ˜¯ä¸Šé¢çš„ </span><br>    <span class="hljs-comment">// SynchronousMethodHandler.Factory åˆ›å»ºçš„ SynchronousMethodHandler</span><br>    Map&lt;String, MethodHandler&gt; nameToHandler = targetToHandlersByName.apply(target);<br>    Map&lt;Method, MethodHandler&gt; methodToHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;Method, MethodHandler&gt;();<br>    List&lt;DefaultMethodHandler&gt; defaultMethodHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;DefaultMethodHandler&gt;();<br><br>    <span class="hljs-keyword">for</span> (Method method : target.type().getMethods()) &#123;<br>      <span class="hljs-keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;<br>        <span class="hljs-keyword">continue</span>;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Util.isDefault(method)) &#123;<br>        <span class="hljs-type">DefaultMethodHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMethodHandler</span>(method);<br>        defaultMethodHandlers.add(handler);<br>        methodToHandler.put(method, handler);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        methodToHandler.put(method, nameToHandler.get(Feign.configKey(target.type(), method)));<br>      &#125;<br>    &#125; <br>    <span class="hljs-comment">// è¿™é‡Œåˆ›å»ºçš„æ˜¯æœ¬ç±»ï¼ˆReflectiveFeignï¼‰çš„é™æ€å†…éƒ¨ç±» FeignInvocationHandler</span><br>    <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> factory.create(target, methodToHandler);<br>    <span class="hljs-comment">// åˆ›å»ºä»£ç†ç±»</span><br>    <span class="hljs-type">T</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (T) Proxy.newProxyInstance(target.type().getClassLoader(),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[] &#123;target.type()&#125;, handler);<br><br>    <span class="hljs-keyword">for</span> (DefaultMethodHandler defaultMethodHandler : defaultMethodHandlers) &#123;<br>      defaultMethodHandler.bindTo(proxy);<br>    &#125;<br>    <span class="hljs-keyword">return</span> proxy;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â è‡³æ­¤ï¼Œfeignçš„åˆå§‹åŒ–æµç¨‹å·®ä¸å¤šå°±å­¦ä¹ å®Œäº†ï¼ˆå½“ç„¶ï¼Œæˆ‘ä¹Ÿåªæ˜¯ç ”ç©¶äº†ä¸€ä¸‹ä¸»è¦æµç¨‹ï¼Œå¾ˆå¤šç»†èŠ‚éƒ½æ²¡æœ‰è€ƒè™‘åˆ°ï¼‰</p>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SpringCloud</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringBootæ•´åˆhibernate-validatorè¯·æ±‚æµç¨‹</title>
    <link href="/2024/05/11/Spring/SpringBoot/SpringBoot%E6%95%B4%E5%90%88hibernate-validator%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B/"/>
    <url>/2024/05/11/Spring/SpringBoot/SpringBoot%E6%95%B4%E5%90%88hibernate-validator%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â validation-apiæ˜¯Bean Validationè§„èŒƒå®šä¹‰çš„APIï¼Œhibernate-validatoræ˜¯å¯¹åº”çš„é»˜è®¤å®ç°å’Œäº‹å®æ ‡å‡†.SpringBootå¼•å…¥validation-apiå’Œhibernate-validatorä¾èµ–å³å¯è·å¾—å¼€ç®±å³ç”¨çš„Bean Validationèƒ½åŠ›</p><p>Â Â Â Â æµ‹è¯•æ‰€ç”¨beançš„Controllerç›¸å…³ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MockUser</span> &#123;<br><br>    <span class="hljs-meta">@Positive</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br><br>    <span class="hljs-meta">@NotBlank</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-comment">// 0è¡¨ç¤ºç”·,1è¡¨ç¤ºå¥³</span><br>    <span class="hljs-meta">@Min(value = 0, message = &quot;æ€§åˆ«å€¼åªèƒ½å…è®¸0æˆ–1&quot;)</span><br>    <span class="hljs-meta">@Max(value = 1, message = &quot;æ€§åˆ«å€¼åªèƒ½å…è®¸0æˆ–1&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> sex;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;MockUser&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;id=&quot;</span> + id +<br>                <span class="hljs-string">&quot;, name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&quot;, sex=&quot;</span> + sex +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/testValidationApi&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">testValidationApi</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Valid</span> MockUser mockUser)</span> &#123;<br>    <span class="hljs-keyword">return</span> Result.ok(mockUser);<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â å½“è¯·æ±‚ &#x2F;testValidationApi æ¥å£æ—¶(å¿½ç•¥ä¸æœ¬ä¸»é¢˜æ— å…³çš„æµç¨‹)</p><p>Â Â Â Â è¯·æ±‚å…ˆåˆ°è¾¾ DispatcherServlet</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DispatcherServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FrameworkServlet</span> &#123;<br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doDispatch</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        ......<br>        <span class="hljs-comment">// Actually invoke the handler.</span><br>mv = ha.handle(processedRequest, response, mappedHandler.getHandler()); <br>        ......<br>    &#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â ç”±äºä¸@RequestMappingç›¸å…³çš„è¯·æ±‚ä¼šå§”æ‰˜ç»™RequestMappingHandlerAdapterå¤„ç†,æ‰€ä»¥æ¥ä¸‹æ¥ä¼šåˆ°è¾¾RequestMappingHandlerAdapter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestMappingHandlerAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractHandlerMethodAdapter</span><br><span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanFactoryAware</span>, InitializingBean &#123;<br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">protected</span> ModelAndView <span class="hljs-title function_">invokeHandlerMethod</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">HttpServletResponse response, HandlerMethod handlerMethod)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        ......<br>        invocableMethod.invokeAndHandle(webRequest, mavContainer); <br>        ......<br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServletInvocableHandlerMethod</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InvocableHandlerMethod</span> &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeAndHandle</span><span class="hljs-params">(ServletWebRequest webRequest, ModelAndViewContainer mavContainer,</span><br><span class="hljs-params">Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">returnValue</span> <span class="hljs-operator">=</span> invokeForRequest(webRequest, mavContainer, providedArgs); <br>        ......       <br>    &#125;   <br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InvocableHandlerMethod</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HandlerMethod</span> &#123; <br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invokeForRequest</span><span class="hljs-params">(NativeWebRequest request, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer,</span><br><span class="hljs-params">Object... providedArgs)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br>Object[] args = getMethodArgumentValues(request, mavContainer, providedArgs);<br>        ......       <br>    &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InvocableHandlerMethod</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HandlerMethod</span> &#123; <br><span class="hljs-keyword">protected</span> Object[] getMethodArgumentValues(NativeWebRequest request, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer,<br>Object... providedArgs) <span class="hljs-keyword">throws</span> Exception &#123; <br>......<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameters.length; i++) &#123; <br>            ......<br>            args[i] = <span class="hljs-built_in">this</span>.resolvers.resolveArgument(parameter, mavContainer, request, <span class="hljs-built_in">this</span>.dataBinderFactory); <br>            ......<br>        &#125;<br>        ......        <br>    &#125;   <br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â è¿™é‡Œçš„resolversæ˜¯ HandlerMethodArgumentResolverComposite ,å…¶æ˜¯å¾ˆå¤šç§HandlerMethodArgumentResolverçš„ç»„åˆ,åœ¨å…·ä½“è§£æå‚æ•°æ˜¯,å…ˆå†³å®šè¦ä½¿ç”¨å“ªç§HandlerMethodArgumentResolver,ç„¶åå§”æ‰˜ç»™ç‰¹å®šçš„HandlerMethodArgumentResolverè¿›è¡Œè§£æ(ä¸‹é¢çš„getArgumentResolver()æ–¹æ³•ä¼šå…ˆä»ç¼“å­˜ä¸­æ‹¿,ç¼“å­˜ä¸­æ²¡æœ‰å†ä»argumentResolversä¸­å–,ç„¶åæ”¾è¿›ç¼“å­˜ä¸­,æ„Ÿå…´è¶£å¯ä»¥è‡ªå·±å»äº†è§£)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HandlerMethodArgumentResolverComposite</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(MethodParameter parameter, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer,</span><br><span class="hljs-params">NativeWebRequest webRequest, <span class="hljs-meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception &#123; <br><span class="hljs-type">HandlerMethodArgumentResolver</span> <span class="hljs-variable">resolver</span> <span class="hljs-operator">=</span> getArgumentResolver(parameter);<br><span class="hljs-keyword">if</span> (resolver == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Unsupported parameter type [&quot;</span> +<br>parameter.getParameterType().getName() + <span class="hljs-string">&quot;]. supportsParameter should be called first.&quot;</span>);<br>&#125;<br><span class="hljs-keyword">return</span> resolver.resolveArgument(parameter, mavContainer, webRequest, binderFactory);Â Â Â Â Â Â Â Â <br>Â Â Â Â &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â è¿™é‡Œå¯¹åº”çš„HandlerMethodArgumentResolveræ˜¯RequestResponseBodyMethodProcessor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestResponseBodyMethodProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMessageConverterMethodProcessor</span> &#123; <br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(MethodParameter parameter, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer,</span><br><span class="hljs-params">NativeWebRequest webRequest, <span class="hljs-meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception &#123; <br>parameter = parameter.nestedIfOptional();<br>        <span class="hljs-comment">// è¿™é‡Œæ˜¯é€šè¿‡ MessageConverter å¯¹æ¶ˆæ¯è¿›è¡Œè½¬æ¢</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">arg</span> <span class="hljs-operator">=</span> readWithMessageConverters(webRequest, parameter, parameter.getNestedGenericParameterType());<br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> Conventions.getVariableNameForParameter(parameter);<br><br><span class="hljs-keyword">if</span> (binderFactory != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-type">WebDataBinder</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> binderFactory.createBinder(webRequest, arg, name);<br><span class="hljs-keyword">if</span> (arg != <span class="hljs-literal">null</span>) &#123; <br>                <span class="hljs-comment">// åœ¨è¿™é‡Œæ ¡éªŒå‚æ•°</span><br>validateIfApplicable(binder, parameter);<br><span class="hljs-keyword">if</span> (binder.getBindingResult().hasErrors() &amp;&amp; isBindExceptionRequired(binder, parameter)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodArgumentNotValidException</span>(parameter, binder.getBindingResult());<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (mavContainer != <span class="hljs-literal">null</span>) &#123;<br>mavContainer.addAttribute(BindingResult.MODEL_KEY_PREFIX + name, binder.getBindingResult());<br>&#125;<br>&#125;<br>        <span class="hljs-comment">// å¯¹Optionalå‚æ•°è¿›è¡Œå¤„ç†</span><br><span class="hljs-keyword">return</span> adaptArgumentIfNecessary(arg, parameter);        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractMessageConverterMethodArgumentResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerMethodArgumentResolver</span> &#123;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateIfApplicable</span><span class="hljs-params">(WebDataBinder binder, MethodParameter parameter)</span> &#123; <br>Annotation[] annotations = parameter.getParameterAnnotations();<br><span class="hljs-keyword">for</span> (Annotation ann : annotations) &#123; <br>            <span class="hljs-comment">// æ‰¾ä¸æ ¡éªŒæœ‰å…³çš„æ³¨è§£</span><br>Object[] validationHints = ValidationAnnotationUtils.determineValidationHints(ann);<br><span class="hljs-keyword">if</span> (validationHints != <span class="hljs-literal">null</span>) &#123;<br>binder.validate(validationHints);<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;        <br>    &#125;    <br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â å§”æ‰˜ç»™ DataBinder è¿›è¡Œæ ¡éªŒ(ä¸‹é¢çš„validatoræ˜¯ValidatorAdapter)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataBinder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PropertyEditorRegistry</span>, TypeConverter &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(Object... validationHints)</span> &#123; <br><span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> getTarget();<br>Assert.state(target != <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;No target to validate&quot;</span>);<br><span class="hljs-type">BindingResult</span> <span class="hljs-variable">bindingResult</span> <span class="hljs-operator">=</span> getBindingResult();<br><span class="hljs-comment">// Call each validator with the same binding result</span><br><span class="hljs-keyword">for</span> (Validator validator : getValidators()) &#123;<br><span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(validationHints) &amp;&amp; validator <span class="hljs-keyword">instanceof</span> SmartValidator) &#123;<br>((SmartValidator) validator).validate(target, bindingResult, validationHints);<br>&#125; <br>            <span class="hljs-comment">// æˆ‘è¿™é‡Œèµ°çš„æ˜¯ä¸‹é¢çš„åˆ†æ”¯(ä¼¼ä¹æ˜¯å› ä¸ºæ²¡æœ‰æŒ‡å®šåˆ†ç»„)</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (validator != <span class="hljs-literal">null</span>) &#123;<br>validator.validate(target, bindingResult);<br>&#125;<br>&#125;        <br>    &#125;    <br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidatorAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SmartValidator</span>, ApplicationContextAware, InitializingBean, DisposableBean &#123;<br>    <span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(Object target, Errors errors)</span> &#123; <br>        <span class="hljs-comment">// è¿™é‡Œçš„target æ˜¯ SpringValidatorAdapter</span><br><span class="hljs-built_in">this</span>.target.validate(target, errors);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â SpringValidatorAdapteræ—¢å®ç°äº†Springè‡ªå·±çš„SmartValidator(ç»§æ‰¿org.springframework.validation.Validator)ç›¸å…³æ¥å£,ä¹Ÿå®ç°äº†javax.validation.Validatoræ¥å£,å…¼å®¹validation-api</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringValidatorAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SmartValidator</span>, javax.validation.Validator &#123;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(Object target, Errors errors)</span> &#123; <br>        <span class="hljs-comment">// è¿™é‡Œçš„ targetValidator æ˜¯ hibernate-validator æä¾›çš„</span><br>        <span class="hljs-comment">// javax.validation.Validator å®ç°ç±» ValidatorImpl</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.targetValidator != <span class="hljs-literal">null</span>) &#123;<br>processConstraintViolations(<span class="hljs-built_in">this</span>.targetValidator.validate(target), errors);<br>&#125;<br>&#125;    <br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â å†å¾€ä¸‹å°±æ˜¯å…·ä½“çš„æ ¡éªŒå®ç°äº†,çœ‹ç€å¾ˆå¤æ‚,å°±å…ˆä¸çœ‹äº†</p><p>Â Â Â æœ€åæ˜¯ processConstraintViolations æ–¹æ³•å¤„ç†æ ¡éªŒç»“æœ</p>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SpringMVC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringMVC-@ControllerAdviceæ³¨è§£å­¦ä¹ </title>
    <link href="/2024/05/08/Spring/SpringMVC/SpringMVC-ControllerAdvice%E6%B3%A8%E8%A7%A3%E5%AD%A6%E4%B9%A0/"/>
    <url>/2024/05/08/Spring/SpringMVC/SpringMVC-ControllerAdvice%E6%B3%A8%E8%A7%A3%E5%AD%A6%E4%B9%A0/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â åœ¨SpringMVCä¸­,å¯ä»¥é€šè¿‡ä½¿ç”¨@ControllerAdviceæ³¨è§£ä¿®é¥°ç±»åŠ@ExceptionHandler,@InitBinder,@ModelAttributeæ³¨è§£ä¿®é¥°æ–¹æ³•å¯¹Controllerè¿›è¡Œå…¨å±€çš„å¼‚å¸¸å¤„ç†,æ³¨å†Œè‡ªå®šä¹‰çš„å‚æ•°è§£æå™¨,ä»¥åŠå°†Controllerçš„æ–¹æ³•å‚æ•°å’ŒControllerAdviceBeançš„æ–¹æ³•è¿”å›å€¼ç»‘å®š</p><h4 id="ç”¨æ³•åŠå¦‚ä½•æ³¨å†Œ"><a href="#ç”¨æ³•åŠå¦‚ä½•æ³¨å†Œ" class="headerlink" title="ç”¨æ³•åŠå¦‚ä½•æ³¨å†Œ"></a>ç”¨æ³•åŠå¦‚ä½•æ³¨å†Œ</h4><p>Â Â Â Â ä¸‹é¢æ˜¯å…·ä½“çš„ç”¨æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomControllerAdvice</span> &#123;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@ExceptionHandler(TestException.class)</span><br>    <span class="hljs-comment">// è¿™é‡Œè¡¨ç¤ºControlleræŠ›å‡ºçš„ TestException å¼‚å¸¸ç”±æ­¤æ–¹æ³•å¤„ç†</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">testException</span><span class="hljs-params">(TestException e)</span> &#123;<br>        <span class="hljs-keyword">return</span> Result.error(e.getMessage());<br>    &#125;<br><br>    <span class="hljs-meta">@ModelAttribute(&quot;MockUser&quot;)</span><br>    <span class="hljs-comment">// è¿™ä¸ªæ–¹æ³•ä¼šåœ¨Controlleræ–¹æ³•ä¹‹å‰æ‰§è¡Œ,å°†åç§°(MockUser)å’Œè¿”å›å€¼(MockUser()å¯¹è±¡)</span><br>    <span class="hljs-comment">// å¡åˆ°modelAndViewContainerä¸­,åœ¨è§£æControlleræ–¹æ³•çš„å‚æ•°æ—¶ä¼šæ ¹æ®å‚æ•°ä¸Šæ˜¯å¦æœ‰</span><br>    <span class="hljs-comment">// @ModelAttributeæ³¨è§£è¿›è¡Œç›¸åº”çš„å¤„ç†</span><br>    <span class="hljs-keyword">public</span> MockUser <span class="hljs-title function_">getMockUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MockUser</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Handsome Young&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@ModelAttribute(&quot;MockUserContrast&quot;)</span><br>    <span class="hljs-comment">// å’Œä¸Šé¢çš„æ–¹æ³•ç±»ä¼¼</span><br>    <span class="hljs-keyword">public</span> MockUser <span class="hljs-title function_">getMockUserContrast</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MockUser</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;Handsome Young Shadow&quot;</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@InitBinder</span><br>    <span class="hljs-comment">// @InitBinderæ³¨è§£æ ‡æ³¨çš„initBinder()æ–¹æ³•è¡¨ç¤ºæ³¨å†Œä¸€ä¸ªDateç±»å‹çš„ç±»å‹è½¬æ¢å™¨ï¼Œç”¨äºå°†ç±»ä¼¼è¿™æ ·çš„2024-05-08</span><br>    <span class="hljs-comment">// æ—¥æœŸæ ¼å¼çš„å­—ç¬¦ä¸²è½¬æ¢æˆDateå¯¹è±¡</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initBinder</span><span class="hljs-params">(WebDataBinder binder)</span> &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">dateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>);<br>        dateFormat.setLenient(<span class="hljs-literal">false</span>);<br>        binder.registerCustomEditor(Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomDateEditor</span>(dateFormat,<span class="hljs-literal">false</span>));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â å†çœ‹ä¸‹SpringMVCæ˜¯å¦‚ä½•æ³¨å†Œè¢«@ControllerAdviceæ³¨è§£ä¿®é¥°çš„ç±»åŠè¢«@ExceptionHandler,@InitBinder,@ModelAttributeæ³¨è§£ä¿®é¥°çš„æ–¹æ³•</p><p>Â Â Â Â é¦–å…ˆå‰ç«¯æ§åˆ¶å™¨DispatcherServletå¯¹è±¡åœ¨åˆ›å»ºæ—¶ä¼šåˆå§‹åŒ–ä¸€ç³»åˆ—çš„å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initStrategies</span><span class="hljs-params">(ApplicationContext context)</span> &#123;<br>    initMultipartResolver(context);<br>    initLocaleResolver(context);<br>    initThemeResolver(context);<br>    initHandlerMappings(context);<br>    initHandlerAdapters(context);<br>    initHandlerExceptionResolvers(context);<br>    initRequestToViewNameTranslator(context);<br>    initViewResolvers(context);<br>    initFlashMapManager(context);<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â å¯¹äºä»Šå¤©å…³æ³¨çš„@ControllerAdviceæ³¨è§£,æˆ‘ä»¬åªéœ€è¦å…³æ³¨ initHandlerAdapters å’Œ initHandlerExceptionResolversæ–¹æ³•</p><p>Â Â Â Â initHandlerAdapters(context)æ–¹æ³•ä¼šå–å¾—æ‰€æœ‰å®ç°äº†HandlerAdapteræ¥å£çš„beanå¹¶ä¿å­˜èµ·æ¥ï¼Œå…¶ä¸­å°±æœ‰ä¸€ä¸ªç±»å‹ä¸ºRequestMappingHandlerAdapterçš„beanï¼Œè¿™ä¸ªbeanå°±æ˜¯@RequestMappingæ³¨è§£èƒ½èµ·ä½œç”¨çš„å…³é”®ï¼Œè¿™ä¸ªbeanåœ¨åº”ç”¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè·å–æ‰€æœ‰è¢«@ControllerAdviceæ³¨è§£æ ‡æ³¨çš„beanå¯¹è±¡åšè¿›ä¸€æ­¥å¤„ç†ï¼Œå…³é”®ä»£ç åœ¨è¿™é‡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Do this first, it may add ResponseBody advice beans</span><br>    initControllerAdviceCache();<br><br>    ......<br>&#125; <br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initControllerAdviceCache</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (getApplicationContext() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    List&lt;ControllerAdviceBean&gt; adviceBeans = ControllerAdviceBean.findAnnotatedBeans(getApplicationContext());<br><br>    List&lt;Object&gt; requestResponseBodyAdviceBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">for</span> (ControllerAdviceBean adviceBean : adviceBeans) &#123;<br>        Class&lt;?&gt; beanType = adviceBean.getBeanType();<br>        <span class="hljs-keyword">if</span> (beanType == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Unresolvable type for ControllerAdviceBean: &quot;</span> + adviceBean);<br>        &#125; <br>        <span class="hljs-comment">// æ‰¾åˆ°æ‰€æœ‰ModelAttributeæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å¹¶ç¼“å­˜èµ·æ¥</span><br>        Set&lt;Method&gt; attrMethods = MethodIntrospector.selectMethods(beanType, MODEL_ATTRIBUTE_METHODS);<br>        <span class="hljs-keyword">if</span> (!attrMethods.isEmpty()) &#123;<br>            <span class="hljs-built_in">this</span>.modelAttributeAdviceCache.put(adviceBean, attrMethods);<br>        &#125; <br>        <span class="hljs-comment">// æ‰¾åˆ°æ‰€æœ‰InitBinderæ³¨è§£æ ‡æ³¨çš„æ–¹æ³•å¹¶ç¼“å­˜èµ·æ¥</span><br>        Set&lt;Method&gt; binderMethods = MethodIntrospector.selectMethods(beanType, INIT_BINDER_METHODS);<br>        <span class="hljs-keyword">if</span> (!binderMethods.isEmpty()) &#123;<br>            <span class="hljs-built_in">this</span>.initBinderAdviceCache.put(adviceBean, binderMethods);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (RequestBodyAdvice.class.isAssignableFrom(beanType) || ResponseBodyAdvice.class.isAssignableFrom(beanType)) &#123;<br>            requestResponseBodyAdviceBeans.add(adviceBean);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!requestResponseBodyAdviceBeans.isEmpty()) &#123;<br>        <span class="hljs-built_in">this</span>.requestResponseBodyAdvice.addAll(<span class="hljs-number">0</span>, requestResponseBodyAdviceBeans);<br>    &#125; <br><br>Â Â Â Â ......<br>&#125;    <br></code></pre></td></tr></table></figure><p>ç»è¿‡è¿™é‡Œå¤„ç†ä¹‹åï¼Œ@ModelAttributeå’Œ@InitBinderå°±èƒ½èµ·ä½œç”¨äº†</p><p>Â Â Â Â å†æ¥çœ‹DispatcherServletçš„initHandlerExceptionResolvers(context)æ–¹æ³•ï¼Œæ–¹æ³•ä¼šå–å¾—æ‰€æœ‰å®ç°äº†HandlerExceptionResolveræ¥å£çš„beanå¹¶ä¿å­˜èµ·æ¥ï¼Œå…¶ä¸­å°±æœ‰ä¸€ä¸ªç±»å‹ä¸ºExceptionHandlerExceptionResolverçš„beanï¼Œè¿™ä¸ªbeanåœ¨åº”ç”¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè·å–æ‰€æœ‰è¢«@ControllerAdviceæ³¨è§£æ ‡æ³¨çš„beanå¯¹è±¡åšè¿›ä¸€æ­¥å¤„ç†ï¼Œå…³é”®ä»£ç åœ¨è¿™é‡Œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Do this first, it may add ResponseBodyAdvice beans</span><br>    initExceptionHandlerAdviceCache();<br><br>    ......<br>&#125; <br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initExceptionHandlerAdviceCache</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (getApplicationContext() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    List&lt;ControllerAdviceBean&gt; adviceBeans = ControllerAdviceBean.findAnnotatedBeans(getApplicationContext());<br>    <span class="hljs-keyword">for</span> (ControllerAdviceBean adviceBean : adviceBeans) &#123;<br>        Class&lt;?&gt; beanType = adviceBean.getBeanType();<br>        <span class="hljs-keyword">if</span> (beanType == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Unresolvable type for ControllerAdviceBean: &quot;</span> + adviceBean);<br>        &#125;<br>        <span class="hljs-type">ExceptionHandlerMethodResolver</span> <span class="hljs-variable">resolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionHandlerMethodResolver</span>(beanType);<br>        <span class="hljs-keyword">if</span> (resolver.hasExceptionMappings()) &#123;<br>            <span class="hljs-built_in">this</span>.exceptionHandlerAdviceCache.put(adviceBean, resolver);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (ResponseBodyAdvice.class.isAssignableFrom(beanType)) &#123;<br>            <span class="hljs-built_in">this</span>.responseBodyAdvice.add(adviceBean);<br>        &#125;<br>    &#125;<br><br>Â Â Â Â ......<br>&#125;    <br></code></pre></td></tr></table></figure><p>å½“ControlleræŠ›å‡ºå¼‚å¸¸æ—¶ï¼ŒDispatcherServleté€šè¿‡ExceptionHandlerExceptionResolveræ¥è§£æå¼‚å¸¸ï¼Œè€ŒExceptionHandlerExceptionResolveråˆé€šè¿‡ExceptionHandlerMethodResolver æ¥è§£æå¼‚å¸¸ï¼Œ ExceptionHandlerMethodResolver æœ€ç»ˆè§£æå¼‚å¸¸æ‰¾åˆ°é€‚ç”¨çš„@ExceptionHandleræ ‡æ³¨çš„æ–¹æ³•æ˜¯è¿™é‡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionHandlerMethodResolver</span> &#123;<br>    <span class="hljs-comment">// ......</span><br>    <span class="hljs-keyword">private</span> Method <span class="hljs-title function_">getMappedMethod</span><span class="hljs-params">(Class&lt;? extends Throwable&gt; exceptionType)</span> &#123;<br>        List&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;&gt; matches = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;&gt;();<br>        <span class="hljs-comment">// æ‰¾åˆ°æ‰€æœ‰é€‚ç”¨äºControlleræŠ›å‡ºå¼‚å¸¸çš„å¤„ç†æ–¹æ³•,ä¾‹å¦‚ControlleræŠ›å‡ºçš„å¼‚å¸¸</span><br>        <span class="hljs-comment">// æ˜¯BizException(ç»§æ‰¿è‡ªRuntimeException),é‚£ä¹ˆ@ExceptionHandler(BizException.class)å’Œ</span><br>        <span class="hljs-comment">// @ExceptionHandler(Exception.class)æ ‡æ³¨çš„æ–¹æ³•éƒ½é€‚ç”¨æ­¤å¼‚å¸¸</span><br>        <span class="hljs-keyword">for</span> (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt; mappedException : <span class="hljs-built_in">this</span>.mappedMethods.keySet()) &#123;<br>            <span class="hljs-keyword">if</span> (mappedException.isAssignableFrom(exceptionType)) &#123;<br>                matches.add(mappedException);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!matches.isEmpty()) &#123;<br>            <span class="hljs-comment">// è¿™é‡Œé€šè¿‡æ’åºæ‰¾åˆ°æœ€é€‚ç”¨çš„æ–¹æ³•,æ’åºçš„è§„åˆ™ä¾æ®æŠ›å‡ºå¼‚å¸¸ç›¸å¯¹äºå£°æ˜å¼‚å¸¸çš„æ·±åº¦,ä¾‹å¦‚</span><br>            <span class="hljs-comment">// ControlleræŠ›å‡ºçš„å¼‚å¸¸æ˜¯BizException(ç»§æ‰¿è‡ªRuntimeException),é‚£ä¹ˆBizException</span><br>            <span class="hljs-comment">// ç›¸å¯¹äº@ExceptionHandler(BizException.class)å£°æ˜çš„BizException.classå…¶æ·±åº¦æ˜¯0,</span><br>            <span class="hljs-comment">// ç›¸å¯¹äº@ExceptionHandler(Exception.class)å£°æ˜çš„Exception.classå…¶æ·±åº¦æ˜¯2,æ‰€ä»¥</span><br>            <span class="hljs-comment">// @ExceptionHandler(BizException.class)æ ‡æ³¨çš„æ–¹æ³•ä¼šæ’åœ¨å‰é¢</span><br>            Collections.sort(matches, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionDepthComparator</span>(exceptionType));<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.mappedMethods.get(matches.get(<span class="hljs-number">0</span>));<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// ......</span><br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â ä¸‹é¢æ ¹æ®è‡ªå·±æ‰’æºç çš„æˆæœåšè¿›ä¸€æ­¥è¯´æ˜</p><h4 id="ExceptionHandler"><a href="#ExceptionHandler" class="headerlink" title="@ExceptionHandler"></a>@ExceptionHandler</h4><p>Â Â Â Â é¦–å…ˆæ˜¯@ExceptionHandleræ³¨è§£ç”Ÿæ•ˆæ—¶çš„è°ƒç”¨å †æ ˆ</p><p><img src="/2024/05/08/Spring/SpringMVC/SpringMVC-ControllerAdvice%E6%B3%A8%E8%A7%A3%E5%AD%A6%E4%B9%A0/137083072664200.png"></p><p>Â Â Â Â ä¸»è¦é€»è¾‘å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doDispatch</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    ......<br><span class="hljs-keyword">try</span> &#123;<br>processedRequest = checkMultipart(request);<br>multipartRequestParsed = (processedRequest != request);<br><br><span class="hljs-comment">// Determine handler for the current request.</span><br>mappedHandler = getHandler(processedRequest);<br><span class="hljs-keyword">if</span> (mappedHandler == <span class="hljs-literal">null</span>) &#123;<br>noHandlerFound(processedRequest, response);<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">// Determine handler adapter for the current request.</span><br><span class="hljs-type">HandlerAdapter</span> <span class="hljs-variable">ha</span> <span class="hljs-operator">=</span> getHandlerAdapter(mappedHandler.getHandler());<br><br><span class="hljs-comment">// Process last-modified header, if supported by the handler.</span><br><span class="hljs-type">String</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> request.getMethod();<br><span class="hljs-type">boolean</span> <span class="hljs-variable">isGet</span> <span class="hljs-operator">=</span> HttpMethod.GET.matches(method);<br><span class="hljs-keyword">if</span> (isGet || HttpMethod.HEAD.matches(method)) &#123;<br><span class="hljs-type">long</span> <span class="hljs-variable">lastModified</span> <span class="hljs-operator">=</span> ha.getLastModified(request, mappedHandler.getHandler());<br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletWebRequest</span>(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">// Actually invoke the handler.</span><br>mv = ha.handle(processedRequest, response, mappedHandler.getHandler());<br><br><span class="hljs-keyword">if</span> (asyncManager.isConcurrentHandlingStarted()) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br>applyDefaultViewName(processedRequest, mv);<br>mappedHandler.applyPostHandle(processedRequest, response, mv);<br>&#125;<br><span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>dispatchException = ex;<br>&#125;<br><span class="hljs-keyword">catch</span> (Throwable err) &#123;<br><span class="hljs-comment">// As of 4.3, we&#x27;re processing Errors thrown from handler methods as well,</span><br><span class="hljs-comment">// making them available for @ExceptionHandler methods and other scenarios.</span><br>dispatchException = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NestedServletException</span>(<span class="hljs-string">&quot;Handler dispatch failed&quot;</span>, err);<br>&#125;<br>processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException); <br>    ......   <br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„try-catchå—æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¼šè¢«æ•è·,ç„¶ååœ¨processDispatchResultæ–¹æ³•ä¸­è¿›è¡Œå¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processDispatchResult</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span><br><span class="hljs-params"><span class="hljs-meta">@Nullable</span> HandlerExecutionChain mappedHandler, <span class="hljs-meta">@Nullable</span> ModelAndView mv,</span><br><span class="hljs-params"><span class="hljs-meta">@Nullable</span> Exception exception)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br><span class="hljs-type">boolean</span> <span class="hljs-variable">errorView</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br><span class="hljs-keyword">if</span> (exception != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> ModelAndViewDefiningException) &#123;<br>logger.debug(<span class="hljs-string">&quot;ModelAndViewDefiningException encountered&quot;</span>, exception);<br>mv = ((ModelAndViewDefiningException) exception).getModelAndView();<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (mappedHandler != <span class="hljs-literal">null</span> ? mappedHandler.getHandler() : <span class="hljs-literal">null</span>);<br>mv = processHandlerException(request, response, handler, exception);<br>errorView = (mv != <span class="hljs-literal">null</span>);<br>&#125;<br>&#125; <br>Â Â Â Â ......   <br>&#125;<br></code></pre></td></tr></table></figure><p>å…·ä½“å¤„ç†çš„ç»†èŠ‚å¯ä»¥å‚è€ƒä¸Šé¢çš„è°ƒç”¨å †æ ˆè‡ªå·±debugçœ‹ä¸‹</p><h4 id="ModelAttribute"><a href="#ModelAttribute" class="headerlink" title="@ModelAttribute"></a>@ModelAttribute</h4><p>Â Â Â Â ç„¶åæ˜¯@ModelAttributeæ³¨è§£çš„å¤„ç†æ–¹å¼</p><p>Â Â Â Â åœ¨RequestMappingHandlerAdapter(è¿™é‡Œåªè€ƒè™‘è¿™ä¸ªadapter)çš„invokeHandlerMethodä¸­,æœ‰ä¸€è¡Œè¯­å¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">modelFactory.initModel(webRequest, mavContainer, invocableMethod);<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initModel</span><span class="hljs-params">(NativeWebRequest request, ModelAndViewContainer container, HandlerMethod handlerMethod)</span><br><span class="hljs-keyword">throws</span> Exception &#123;<br><br>Map&lt;String, ?&gt; sessionAttributes = <span class="hljs-built_in">this</span>.sessionAttributesHandler.retrieveAttributes(request);<br>container.mergeAttributes(sessionAttributes);<br>invokeModelAttributeMethods(request, container);<br><br><span class="hljs-keyword">for</span> (String name : findSessionAttributeArguments(handlerMethod)) &#123;<br><span class="hljs-keyword">if</span> (!container.containsAttribute(name)) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.sessionAttributesHandler.retrieveAttribute(request, name);<br><span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpSessionRequiredException</span>(<span class="hljs-string">&quot;Expected session attribute &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27;&quot;</span>, name);<br>&#125;<br>container.addAttribute(name, value);<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•é‡Œæˆ‘ä»¬ä¸»è¦å…³æ³¨  invokeModelAttributeMethods æ–¹æ³•,è¿™ä¸ªæ–¹æ³•åšçš„äº‹æ˜¯æ‰§è¡Œæ‰€æœ‰çš„ç¬¦åˆæ¡ä»¶çš„è¢«@ModelAttributeæ³¨è§£ä¿®é¥°çš„æ–¹æ³•å¹¶å°†è¿”å›å€¼åŠè¿”å›å€¼åç§°ä½œä¸ºå±æ€§å¡åˆ°ModelAndViewContainerä¸­</p><p>ç„¶åæ˜¯åœ¨ ServletInvocableHandlerMethod æ‰§è¡Œæ–¹æ³•æ—¶ä¼šè·å–å¹¶è§£ææ–¹æ³•å‚æ•°,å¯¹äºControllerä¸­è¢«@ModelAttributeæ³¨è§£ä¿®é¥°çš„å‚æ•°ä¼šå§”æ‰˜ç»™ ModelAttributeMethodProcessor è¿›è¡Œè§£æ,è€ŒModelAttributeMethodProcessoråœ¨è§£æå‚æ•°æ—¶ä¼šå…ˆä»ModelAndViewContainerä¸­æ‰¾</p><p>Â Â Â Â æ€»ç»“ä¸€ä¸‹å°±æ˜¯æ¯æ¬¡æ‰§è¡Œè¯·æ±‚å‰å…ˆæ‰§è¡Œæ‰€æœ‰çš„@ModelAttributeæ³¨è§£ä¿®é¥°çš„æ–¹æ³•,å°†ç»“æœç¼“å­˜,åœ¨æ‰§è¡Œæ–¹æ³•è§£æå‚æ•°æ—¶çœ‹éœ€è¦ä»ç¼“å­˜ä¸­å–ç›¸åº”çš„è¿”å›å€¼(PS:æ„Ÿè§‰è¿™æ ·å®ç°ä¸å¤ªä¼˜é›…)</p><h4 id="InitBinder"><a href="#InitBinder" class="headerlink" title="@InitBinder"></a>@InitBinder</h4><p>Â Â Â Â å…·ä½“çš„å¤„ç†é€»è¾‘åœ¨AbstractNamedValueMethodArgumentResolverç±»çš„ resolveArgument æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Nullable</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Object <span class="hljs-title function_">resolveArgument</span><span class="hljs-params">(MethodParameter parameter, <span class="hljs-meta">@Nullable</span> ModelAndViewContainer mavContainer,</span><br><span class="hljs-params">NativeWebRequest webRequest, <span class="hljs-meta">@Nullable</span> WebDataBinderFactory binderFactory)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    ......<br>    <span class="hljs-keyword">if</span> (binderFactory != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-type">WebDataBinder</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> binderFactory.createBinder(webRequest, <span class="hljs-literal">null</span>, namedValueInfo.name);<br><span class="hljs-keyword">try</span> &#123;<br>arg = binder.convertIfNecessary(arg, parameter.getParameterType(), parameter);<br>&#125;<br>Â Â Â Â ......<br>&#125; <br></code></pre></td></tr></table></figure><p>Â Â Â <br>Â Â Â Â åœ¨Spring MVCä¸­ï¼Œ<code>@InitBinder</code>æ³¨è§£ç”¨äºæ³¨å†Œè‡ªå®šä¹‰çš„å±æ€§ç¼–è¾‘å™¨ï¼Œè¿™äº›ç¼–è¾‘å™¨ä¸»è¦ç”¨äºå°†è¯·æ±‚å‚æ•°ï¼ˆé€šå¸¸æ˜¯å­—ç¬¦ä¸²ï¼‰è½¬æ¢ä¸ºç‰¹å®šçš„Javaç±»å‹]ã€‚ç„¶è€Œï¼Œ<code>@RequestBody</code>æ³¨è§£ç”¨äºå¤„ç†HTTPè¯·æ±‚ä½“ä¸­çš„JSONæ•°æ®ï¼Œå¹¶å°†å…¶æ˜ å°„åˆ°å¯¹åº”çš„Javaå¯¹è±¡.</p><h5 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h5><p>(<a href="https://zhuanlan.zhihu.com/p/73087879">Springçš„@ControllerAdviceæ³¨è§£ä½œç”¨åŸç†æ¢ç©¶ - çŸ¥ä¹ (zhihu.com)</a>)</p><p>(<a href="https://blog.csdn.net/m0_37343985/article/details/84438039">SpringMVCä¹‹ModelFactory_modelfactory spring-CSDNåšå®¢</a>)</p>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SpringMVC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringMVCè¯·æ±‚æµç¨‹å›¾</title>
    <link href="/2024/04/20/Spring/SpringMVC/SpringMVC%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%9B%BE/"/>
    <url>/2024/04/20/Spring/SpringMVC/SpringMVC%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%9B%BE/</url>
    
    <content type="html"><![CDATA[<p><img src="/2024/04/20/Spring/SpringMVC/SpringMVC%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%E5%9B%BE/351472880691300.jpg"></p>]]></content>
    
    
    <categories>
      
      <category>æµç¨‹å›¾</category>
      
    </categories>
    
    
    <tags>
      
      <tag>SpringMVC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ScheduledThreadPoolExecutoræºç è§£æ</title>
    <link href="/2023/11/06/java-source-code/ScheduledThreadPoolExecutor%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/11/06/java-source-code/ScheduledThreadPoolExecutor%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * A &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor&#125; that can additionally schedule</span><br><span class="hljs-comment"> * commands to run after a given delay, or to execute periodically.</span><br><span class="hljs-comment"> * This class is preferable to &#123;<span class="hljs-doctag">@link</span> java.util.Timer&#125; when multiple</span><br><span class="hljs-comment"> * worker threads are needed, or when the additional flexibility or</span><br><span class="hljs-comment"> * capabilities of &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor&#125; (which this class</span><br><span class="hljs-comment"> * extends) are required.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Delayed tasks execute no sooner than they are enabled, but</span><br><span class="hljs-comment"> * without any real-time guarantees about when, after they are</span><br><span class="hljs-comment"> * enabled, they will commence. Tasks scheduled for exactly the same</span><br><span class="hljs-comment"> * execution time are enabled in first-in-first-out (FIFO) order of</span><br><span class="hljs-comment"> * submission.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;When a submitted task is cancelled before it is run, execution</span><br><span class="hljs-comment"> * is suppressed.  By default, such a cancelled task is not</span><br><span class="hljs-comment"> * automatically removed from the work queue until its delay elapses.</span><br><span class="hljs-comment"> * While this enables further inspection and monitoring, it may also</span><br><span class="hljs-comment"> * cause unbounded retention of cancelled tasks.  To avoid this, use</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> #setRemoveOnCancelPolicy&#125; to cause tasks to be immediately</span><br><span class="hljs-comment"> * removed from the work queue at time of cancellation.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Successive executions of a periodic task scheduled via</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> #scheduleAtFixedRate scheduleAtFixedRate&#125; or</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> #scheduleWithFixedDelay scheduleWithFixedDelay&#125;</span><br><span class="hljs-comment"> * do not overlap. While different executions may be performed by</span><br><span class="hljs-comment"> * different threads, the effects of prior executions</span><br><span class="hljs-comment"> * &lt;a href=&quot;package-summary.html#MemoryVisibility&quot;&gt;&lt;i&gt;happen-before&lt;/i&gt;&lt;/a&gt;</span><br><span class="hljs-comment"> * those of subsequent ones.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;While this class inherits from &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor&#125;, a few</span><br><span class="hljs-comment"> * of the inherited tuning methods are not useful for it. In</span><br><span class="hljs-comment"> * particular, because it acts as a fixed-sized pool using</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> corePoolSize&#125; threads and an unbounded queue, adjustments</span><br><span class="hljs-comment"> * to &#123;<span class="hljs-doctag">@code</span> maximumPoolSize&#125; have no useful effect. Additionally, it</span><br><span class="hljs-comment"> * is almost never a good idea to set &#123;<span class="hljs-doctag">@code</span> corePoolSize&#125; to zero or</span><br><span class="hljs-comment"> * use &#123;<span class="hljs-doctag">@code</span> allowCoreThreadTimeOut&#125; because this may leave the pool</span><br><span class="hljs-comment"> * without threads to handle tasks once they become eligible to run.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;As with &#123;<span class="hljs-doctag">@code</span> ThreadPoolExecutor&#125;, if not otherwise specified,</span><br><span class="hljs-comment"> * this class uses &#123;<span class="hljs-doctag">@link</span> Executors#defaultThreadFactory&#125; as the</span><br><span class="hljs-comment"> * default thread factory, and &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor.AbortPolicy&#125;</span><br><span class="hljs-comment"> * as the default rejected execution handler.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;&lt;b&gt;Extension notes:&lt;/b&gt; This class overrides the</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor#execute(Runnable) execute&#125; and</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> AbstractExecutorService#submit(Runnable) submit&#125;</span><br><span class="hljs-comment"> * methods to generate internal &#123;<span class="hljs-doctag">@link</span> ScheduledFuture&#125; objects to</span><br><span class="hljs-comment"> * control per-task delays and scheduling.  To preserve</span><br><span class="hljs-comment"> * functionality, any further overrides of these methods in</span><br><span class="hljs-comment"> * subclasses must invoke superclass versions, which effectively</span><br><span class="hljs-comment"> * disables additional task customization.  However, this class</span><br><span class="hljs-comment"> * provides alternative protected extension method</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> decorateTask&#125; (one version each for &#123;<span class="hljs-doctag">@code</span> Runnable&#125; and</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> Callable&#125;) that can be used to customize the concrete task</span><br><span class="hljs-comment"> * types used to execute commands entered via &#123;<span class="hljs-doctag">@code</span> execute&#125;,</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> submit&#125;, &#123;<span class="hljs-doctag">@code</span> schedule&#125;, &#123;<span class="hljs-doctag">@code</span> scheduleAtFixedRate&#125;,</span><br><span class="hljs-comment"> * and &#123;<span class="hljs-doctag">@code</span> scheduleWithFixedDelay&#125;.  By default, a</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> ScheduledThreadPoolExecutor&#125; uses a task type extending</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> FutureTask&#125;. However, this may be modified or replaced using</span><br><span class="hljs-comment"> * subclasses of the form:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;pre&gt; &#123;<span class="hljs-doctag">@code</span></span><br><span class="hljs-comment"> * public class CustomScheduledExecutor extends ScheduledThreadPoolExecutor &#123;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *   static class CustomTask&lt;V&gt; implements RunnableScheduledFuture&lt;V&gt; &#123; ... &#125;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *   protected &lt;V&gt; RunnableScheduledFuture&lt;V&gt; decorateTask(</span><br><span class="hljs-comment"> *                Runnable r, RunnableScheduledFuture&lt;V&gt; task) &#123;</span><br><span class="hljs-comment"> *       return new CustomTask&lt;V&gt;(r, task);</span><br><span class="hljs-comment"> *   &#125;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *   protected &lt;V&gt; RunnableScheduledFuture&lt;V&gt; decorateTask(</span><br><span class="hljs-comment"> *                Callable&lt;V&gt; c, RunnableScheduledFuture&lt;V&gt; task) &#123;</span><br><span class="hljs-comment"> *       return new CustomTask&lt;V&gt;(c, task);</span><br><span class="hljs-comment"> *   &#125;</span><br><span class="hljs-comment"> *   // ... add constructors, etc.</span><br><span class="hljs-comment"> * &#125;&#125;&lt;/pre&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.5</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Doug Lea</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduledThreadPoolExecutor</span><br>        <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadPoolExecutor</span><br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ScheduledExecutorService</span> &#123;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * This class specializes ThreadPoolExecutor implementation by</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 1. Using a custom task type ScheduledFutureTask, even for tasks</span><br><span class="hljs-comment">     *    that don&#x27;t require scheduling because they are submitted</span><br><span class="hljs-comment">     *    using ExecutorService rather than ScheduledExecutorService</span><br><span class="hljs-comment">     *    methods, which are treated as tasks with a delay of zero.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 2. Using a custom queue (DelayedWorkQueue), a variant of</span><br><span class="hljs-comment">     *    unbounded DelayQueue. The lack of capacity constraint and</span><br><span class="hljs-comment">     *    the fact that corePoolSize and maximumPoolSize are</span><br><span class="hljs-comment">     *    effectively identical simplifies some execution mechanics</span><br><span class="hljs-comment">     *    (see delayedExecute) compared to ThreadPoolExecutor.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 3. Supporting optional run-after-shutdown parameters, which</span><br><span class="hljs-comment">     *    leads to overrides of shutdown methods to remove and cancel</span><br><span class="hljs-comment">     *    tasks that should NOT be run after shutdown, as well as</span><br><span class="hljs-comment">     *    different recheck logic when task (re)submission overlaps</span><br><span class="hljs-comment">     *    with a shutdown.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 4. Task decoration methods to allow interception and</span><br><span class="hljs-comment">     *    instrumentation, which are needed because subclasses cannot</span><br><span class="hljs-comment">     *    otherwise override submit methods to get this effect. These</span><br><span class="hljs-comment">     *    don&#x27;t have any impact on pool control logic though.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 1.ä½¿ç”¨è‡ªå®šä¹‰ä»»åŠ¡ç±»å‹ScheduledFutureTaskï¼Œå³ä½¿å¯¹äºä¸éœ€è¦è®¡åˆ’çš„ä»»åŠ¡ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œ</span><br><span class="hljs-comment">     *   å› ä¸ºå®ƒä»¬æ˜¯ä½¿ç”¨ExecutorServiceè€Œä¸æ˜¯ScheduledExecutorServiceæ–¹æ³•æäº¤çš„ï¼Œåè€…è¢«è§†ä¸ºå»¶è¿Ÿä¸ºé›¶çš„ä»»åŠ¡ã€‚</span><br><span class="hljs-comment">     * 2.ä½¿ç”¨è‡ªå®šä¹‰é˜Ÿåˆ—ï¼ˆDelayedWorkQueueï¼‰ï¼Œå®ƒæ˜¯æ— ç•Œå»¶è¿Ÿé˜Ÿåˆ—ï¼ˆDelayQueueï¼‰çš„ä¸€ä¸ªå˜ä½“ã€‚</span><br><span class="hljs-comment">     *   ä¸ ThreadPoolExecutor ç›¸æ¯”ï¼Œç”±äºæ²¡æœ‰å®¹é‡é™åˆ¶ï¼Œè€Œä¸” corePoolSize å’Œ maximumPoolSize å®é™…ä¸Šæ˜¯ç›¸åŒçš„ï¼Œ</span><br><span class="hljs-comment">     *   å› æ­¤ç®€åŒ–äº†ä¸€äº›æ‰§è¡Œæœºåˆ¶ï¼ˆå‚è§ delayedExecuteï¼‰ã€‚</span><br><span class="hljs-comment">     * 3.æ”¯æŒå¯é€‰çš„å…³é—­åè¿è¡Œå‚æ•°ï¼Œè¿™å¯¼è‡´è¦†ç›–å…³é—­æ–¹æ³•ä»¥ç§»é™¤å’Œå–æ¶ˆå…³é—­åä¸åº”è¿è¡Œçš„ä»»åŠ¡ï¼Œ</span><br><span class="hljs-comment">     *   ä»¥åŠå½“ä»»åŠ¡(é‡æ–°)æäº¤ä¸å…³é—­é‡å æ—¶ä¸åŒçš„é‡æ–°æ£€æŸ¥é€»è¾‘ã€‚</span><br><span class="hljs-comment">     * 4.ä»»åŠ¡ä¿®é¥°æ–¹æ³•ï¼Œä»¥å…è®¸æ‹¦æˆªå’Œæ’è£…ï¼Œè¿™æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºå­ç±»ä¸èƒ½é€šè¿‡é‡å†™æäº¤æ–¹æ³•æ¥è·å¾—è¿™ç§æ•ˆæœã€‚</span><br><span class="hljs-comment">     *   ä½†æ˜¯è¿™äº›å¯¹æ± æ§åˆ¶é€»è¾‘æ²¡æœ‰ä»»ä½•å½±å“ã€‚</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ThreadPoolExecutor.runWorker(Worker w) æ–¹æ³•æ³¨é‡Š</span><br><span class="hljs-comment">     * ä¸» Worker è¿è¡Œå¾ªç¯ã€‚é‡å¤ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œå®ƒä»¬ï¼ŒåŒæ—¶å¤„ç†ä¸€ç³»åˆ—é—®é¢˜ï¼š</span><br><span class="hljs-comment">     * 1. æˆ‘ä»¬å¯èƒ½ä¸€å¼€å§‹å°±æœ‰ä¸€ä¸ªåˆå§‹ä»»åŠ¡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦è·å–ç¬¬ä¸€ä¸ªä»»åŠ¡ã€‚</span><br><span class="hljs-comment">     *    å¦åˆ™ï¼Œåªè¦æ± è¿˜åœ¨è¿è¡Œï¼Œæˆ‘ä»¬å°±ä» getTask è·å–ä»»åŠ¡ã€‚</span><br><span class="hljs-comment">     *    å¦‚æœè¿”å›ç©ºå€¼ï¼Œåˆ™è¡¨ç¤º Worker å› æ± çŠ¶æ€æˆ–é…ç½®å‚æ•°å‘ç”Ÿå˜åŒ–è€Œé€€å‡ºã€‚</span><br><span class="hljs-comment">     *    å…¶ä»–é€€å‡ºæ˜¯ç”±äºå¤–éƒ¨ä»£ç æŠ›å‡ºäº†å¼‚å¸¸ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ completedAbruptly ä¿æŒä¸å˜ï¼Œ</span><br><span class="hljs-comment">     *    è¿™é€šå¸¸ä¼šå¯¼è‡´ processWorkerExit æ›¿ä»£è¯¥çº¿ç¨‹ã€‚</span><br><span class="hljs-comment">     * 2. åœ¨è¿è¡Œä»»ä½•ä»»åŠ¡ä¹‹å‰ï¼Œæˆ‘ä»¬éƒ½ä¼šè·å–é”ï¼Œä»¥é˜²æ­¢ä»»åŠ¡æ‰§è¡Œæ—¶å‘ç”Ÿå…¶ä»–æ± ä¸­æ–­ï¼Œ</span><br><span class="hljs-comment">     *    ç„¶åç¡®ä¿é™¤éæ± åœæ­¢è¿è¡Œï¼Œå¦åˆ™æœ¬çº¿ç¨‹ä¸ä¼šè®¾ç½®ä¸­æ–­ã€‚</span><br><span class="hljs-comment">     * 3. æ¯ä¸ªä»»åŠ¡è¿è¡Œå‰éƒ½ä¼šè°ƒç”¨ beforeExecuteï¼Œå®ƒå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œ</span><br><span class="hljs-comment">     *    åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸å¤„ç†ä»»åŠ¡çš„æƒ…å†µä¸‹å¯¼è‡´çº¿ç¨‹æ­»äº¡ï¼ˆåœ¨ completedAbruptly ä¸º true çš„æƒ…å†µä¸‹ä¸­æ–­å¾ªç¯ï¼‰ã€‚</span><br><span class="hljs-comment">     * 4. å‡è®¾ beforeExecute æ­£å¸¸å®Œæˆï¼Œæˆ‘ä»¬è¿è¡Œä»»åŠ¡ï¼Œæ”¶é›†æŠ›å‡ºçš„å¼‚å¸¸å¹¶å‘é€ç»™ afterExecuteã€‚</span><br><span class="hljs-comment">     *    æˆ‘ä»¬ä¼šåˆ†åˆ«å¤„ç† RuntimeExceptionã€Errorï¼ˆè§„èŒƒä¿è¯æˆ‘ä»¬ä¼šæ•è·è¿™ä¸¤ç§å¼‚å¸¸ï¼‰å’Œä»»æ„ Throwablesã€‚</span><br><span class="hljs-comment">     *    ç”±äºæˆ‘ä»¬æ— æ³•åœ¨ Runnable.run ä¸­é‡æ–°æŠ›å‡º Throwablesï¼Œ</span><br><span class="hljs-comment">     *    å› æ­¤æˆ‘ä»¬åœ¨æŠ›å‡ºæ—¶å°†å®ƒä»¬å°è£…åœ¨ Errors ä¸­ï¼ˆäº¤ç»™çº¿ç¨‹çš„ UncaughtExceptionHandlerï¼‰ã€‚</span><br><span class="hljs-comment">     *    ä»»ä½•æŠ›å‡ºçš„å¼‚å¸¸éƒ½ä¼šå¯¼è‡´çº¿ç¨‹æ­»äº¡ã€‚</span><br><span class="hljs-comment">     * 5. åœ¨ task.run å®Œæˆåï¼Œæˆ‘ä»¬è°ƒç”¨ afterExecuteï¼Œå®ƒä¹Ÿå¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´çº¿ç¨‹æ­»äº¡ã€‚</span><br><span class="hljs-comment">     *    æ ¹æ® JLS ç¬¬ 14.20 èŠ‚ï¼Œå³ä½¿ task.run æŠ›å‡ºï¼Œè¯¥å¼‚å¸¸ä¹Ÿä¼šç”Ÿæ•ˆã€‚</span><br><span class="hljs-comment">     *    å¼‚å¸¸æœºåˆ¶çš„å‡€æ•ˆæœæ˜¯ï¼ŒafterExecute å’Œçº¿ç¨‹çš„</span><br><span class="hljs-comment">     *    UncaughtExceptionHandler å¯ä»¥è·å¾—æˆ‘ä»¬æ‰€èƒ½æä¾›çš„å…³äºç”¨æˆ·ä»£ç æ‰€é‡åˆ°çš„ä»»ä½•é—®é¢˜çš„å‡†ç¡®ä¿¡æ¯</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * False if should cancel/suppress periodic tasks on shutdown.</span><br><span class="hljs-comment">     * å¦‚æœå€¼ä¸ºfalseï¼Œåˆ™åœ¨shutdownæ—¶ï¼Œcancel/supresså‘¨æœŸæ€§ä»»åŠ¡æ—¶</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> continueExistingPeriodicTasksAfterShutdown;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * False if should cancel non-periodic not-yet-expired tasks on shutdown.</span><br><span class="hljs-comment">     * å¦‚æœå€¼ä¸ºfalseï¼Œåˆ™åœ¨shutdownæ—¶ï¼Œcanceléå‘¨æœŸæ€§ã€è¿˜æœªè¿‡æœŸçš„ä»»åŠ¡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">executeExistingDelayedTasksAfterShutdown</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * True if ScheduledFutureTask.cancel should remove from queue.</span><br><span class="hljs-comment">     * å¦‚æœå€¼ä¸ºtrueï¼Œåˆ™cancelçŠ¶æ€çš„ScheduledFutureTaskåº”è¯¥ä»é˜Ÿåˆ—ä¸­ç§»é™¤</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> removeOnCancel;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Sequence number to break scheduling ties, and in turn to</span><br><span class="hljs-comment">     * guarantee FIFO order among tied entries.</span><br><span class="hljs-comment">     * æ‰“ç ´è°ƒåº¦è”ç³»çš„åºåˆ—å·ï¼Œè¿›è€Œä¿è¯è”ç³»æ¡ç›®ä¹‹é—´çš„FIFOé¡ºåºã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">sequencer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduledFutureTask</span>&lt;V&gt;<br>            <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FutureTask</span>&lt;V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RunnableScheduledFuture</span>&lt;V&gt; &#123;<br><br>        <span class="hljs-comment">/** Sequence number to break ties FIFO */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> sequenceNumber;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * The nanoTime-based time when the task is enabled to execute.</span><br><span class="hljs-comment">         * ä»»åŠ¡å…è®¸æ‰§è¡Œçš„æ—¶é—´ï¼ˆä»¥çº³ç§’è®°ï¼‰</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> time;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Period for repeating tasks, in nanoseconds.</span><br><span class="hljs-comment">         * A positive value indicates fixed-rate execution.</span><br><span class="hljs-comment">         * A negative value indicates fixed-delay execution.</span><br><span class="hljs-comment">         * A value of 0 indicates a non-repeating (one-shot) task.</span><br><span class="hljs-comment">         * é‡å¤æ‰§è¡Œä»»åŠ¡çš„å‘¨æœŸï¼Œä»¥çº³ç§’è®°</span><br><span class="hljs-comment">         * æ­£æ•°è¡¨ç¤ºå›ºå®šé¢‘ç‡çš„æ‰§è¡Œ</span><br><span class="hljs-comment">         * è´Ÿæ•°è¡¨ç¤ºå›ºå®šå»¶è¿Ÿçš„æ‰§è¡Œ</span><br><span class="hljs-comment">         * 0è¡¨ç¤ºéå‘¨æœŸæ€§ä»»åŠ¡ï¼ˆå³åªæ‰§è¡Œä¸€æ¬¡ï¼‰</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> period;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * The actual task to be re-enqueued by reExecutePeriodic</span><br><span class="hljs-comment">         * reExecutePeriodicæ–¹æ³•é‡æ–°å…¥é˜Ÿçš„å®é™…çš„ä»»åŠ¡</span><br><span class="hljs-comment">         */</span><br>        RunnableScheduledFuture&lt;V&gt; outerTask = <span class="hljs-built_in">this</span>;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Index into delay queue, to support faster cancellation.</span><br><span class="hljs-comment">         * å»¶è¿Ÿé˜Ÿåˆ—ç´¢å¼•ï¼Œä»¥æ”¯æŒæ›´å¿«çš„å–æ¶ˆ</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">int</span> heapIndex;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Creates a one-shot action with given nanoTime-based trigger time.</span><br><span class="hljs-comment">         */</span><br>        ScheduledFutureTask(Runnable r, V result, <span class="hljs-type">long</span> triggerTime,<br>                            <span class="hljs-type">long</span> sequenceNumber) &#123;<br>            <span class="hljs-built_in">super</span>(r, result);<br>            <span class="hljs-built_in">this</span>.time = triggerTime;<br>            <span class="hljs-built_in">this</span>.period = <span class="hljs-number">0</span>;<br>            <span class="hljs-built_in">this</span>.sequenceNumber = sequenceNumber;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Creates a periodic action with given nanoTime-based initial</span><br><span class="hljs-comment">         * trigger time and period.</span><br><span class="hljs-comment">         */</span><br>        ScheduledFutureTask(Runnable r, V result, <span class="hljs-type">long</span> triggerTime,<br>                            <span class="hljs-type">long</span> period, <span class="hljs-type">long</span> sequenceNumber) &#123;<br>            <span class="hljs-built_in">super</span>(r, result);<br>            <span class="hljs-built_in">this</span>.time = triggerTime;<br>            <span class="hljs-built_in">this</span>.period = period;<br>            <span class="hljs-built_in">this</span>.sequenceNumber = sequenceNumber;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Creates a one-shot action with given nanoTime-based trigger time.</span><br><span class="hljs-comment">         */</span><br>        ScheduledFutureTask(Callable&lt;V&gt; callable, <span class="hljs-type">long</span> triggerTime,<br>                            <span class="hljs-type">long</span> sequenceNumber) &#123;<br>            <span class="hljs-built_in">super</span>(callable);<br>            <span class="hljs-built_in">this</span>.time = triggerTime;<br>            <span class="hljs-built_in">this</span>.period = <span class="hljs-number">0</span>;<br>            <span class="hljs-built_in">this</span>.sequenceNumber = sequenceNumber;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * è·å–ä»»åŠ¡ä¸‹ä¸€æ¬¡æ‰§è¡Œçš„å»¶è¿Ÿ</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getDelay</span><span class="hljs-params">(TimeUnit unit)</span> &#123;<br>            <span class="hljs-keyword">return</span> unit.convert(time - System.nanoTime(), NANOSECONDS);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * æ¯”è¾ƒä¸¤ä¸ªä»»åŠ¡è°å…ˆè¿›è¡Œä¸‹ä¸€æ¬¡æ‰§è¡Œ</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> other the object to be compared.</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compareTo</span><span class="hljs-params">(Delayed other)</span> &#123;<br>            <span class="hljs-keyword">if</span> (other == <span class="hljs-built_in">this</span>) <span class="hljs-comment">// compare zero if same object</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">instanceof</span> ScheduledFutureTask) &#123;<br>                ScheduledFutureTask&lt;?&gt; x = (ScheduledFutureTask&lt;?&gt;)other;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">diff</span> <span class="hljs-operator">=</span> time - x.time;<br>                <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &gt; <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sequenceNumber &lt; x.sequenceNumber)<br>                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">else</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>            &#125;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">diff</span> <span class="hljs-operator">=</span> getDelay(NANOSECONDS) - other.getDelay(NANOSECONDS);<br>            <span class="hljs-keyword">return</span> (diff &lt; <span class="hljs-number">0</span>) ? -<span class="hljs-number">1</span> : (diff &gt; <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Returns &#123;<span class="hljs-doctag">@code</span> true&#125; if this is a periodic (not a one-shot) action.</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> true&#125; if periodic</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isPeriodic</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> period != <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Sets the next time to run for a periodic task.</span><br><span class="hljs-comment">         * è®¾ç½®å‘¨æœŸæ€§ä»»åŠ¡çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNextRunTime</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> period;<br>            <span class="hljs-keyword">if</span> (p &gt; <span class="hljs-number">0</span>)<br>                time += p;<br>            <span class="hljs-keyword">else</span><br>                time = triggerTime(-p);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(<span class="hljs-type">boolean</span> mayInterruptIfRunning)</span> &#123;<br>            <span class="hljs-comment">// The racy read of heapIndex below is benign:</span><br>            <span class="hljs-comment">// if heapIndex &lt; 0, then OOTA guarantees that we have surely</span><br>            <span class="hljs-comment">// been removed; else we recheck under lock in remove()</span><br>            <span class="hljs-comment">// ä¸‹é¢å¯¹ heapIndex çš„ç²—ç•¥è¯»å–æ˜¯æ— å®³çš„ï¼šå¦‚æœ heapIndex &lt; 0ï¼Œåˆ™ OOTA ä¿è¯æˆ‘ä»¬è‚¯å®šå·²è¢«ç§»é™¤ï¼›</span><br>            <span class="hljs-comment">// å¦åˆ™ï¼Œæˆ‘ä»¬åœ¨ remove() ä¸­çš„é”ä¸‹é‡æ–°æ£€æŸ¥</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">cancelled</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.cancel(mayInterruptIfRunning);<br>            <span class="hljs-keyword">if</span> (cancelled &amp;&amp; removeOnCancel &amp;&amp; heapIndex &gt;= <span class="hljs-number">0</span>)<br>                remove(<span class="hljs-built_in">this</span>);<br>            <span class="hljs-keyword">return</span> cancelled;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Overrides FutureTask version so as to reset/requeue if periodic.</span><br><span class="hljs-comment">         * é‡å†™FutureTaskçš„runæ–¹æ³•ï¼Œä»¥åœ¨éœ€è¦å‘¨æœŸæ€§æ‰§è¡Œä»»åŠ¡æ—¶reset/requeueä»»åŠ¡</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span> (!canRunInCurrentRunState(<span class="hljs-built_in">this</span>))<br>                cancel(<span class="hljs-literal">false</span>);<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isPeriodic())<br>                <span class="hljs-built_in">super</span>.run();<br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">super</span>.runAndReset()) &#123;<br>                setNextRunTime();<br>                reExecutePeriodic(outerTask);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns true if can run a task given current run state and</span><br><span class="hljs-comment">     * run-after-shutdown parameters.</span><br><span class="hljs-comment">     * å¦‚æœèƒ½åœ¨ç»™å®šå½“å‰çŠ¶æ€å’Œrun-after-shutdownå‚æ•°ä¸‹æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™è¿”å›true</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">canRunInCurrentRunState</span><span class="hljs-params">(RunnableScheduledFuture&lt;?&gt; task)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!isShutdown())<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (isStopped())<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">// å·²ç»shutdown è¿˜æœª stop</span><br>        <span class="hljs-comment">// å¦‚æœæ˜¯å‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦åº”è¯¥åœ¨shutdownå cancel/supress ä»»åŠ¡</span><br>        <span class="hljs-comment">// å¦åˆ™ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦åº”è¯¥åœ¨shutdownåæ”¾å¼ƒéå‘¨æœŸã€è¿˜æœªé‡Šæ”¾å’Œä»»åŠ¡æ˜¯å¦å¯ä»¥ç«‹å³æ‰§è¡Œ</span><br>        <span class="hljs-keyword">return</span> task.isPeriodic()<br>                ? continueExistingPeriodicTasksAfterShutdown<br>                : (executeExistingDelayedTasksAfterShutdown<br>                || task.getDelay(NANOSECONDS) &lt;= <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Main execution method for delayed or periodic tasks.  If pool</span><br><span class="hljs-comment">     * is shut down, rejects the task. Otherwise adds task to queue</span><br><span class="hljs-comment">     * and starts a thread, if necessary, to run it.  (We cannot</span><br><span class="hljs-comment">     * prestart the thread to run the task because the task (probably)</span><br><span class="hljs-comment">     * shouldn&#x27;t be run yet.)  If the pool is shut down while the task</span><br><span class="hljs-comment">     * is being added, cancel and remove it if required by state and</span><br><span class="hljs-comment">     * run-after-shutdown parameters.</span><br><span class="hljs-comment">     * å¯¹äºå»¶è¿Ÿçš„æˆ–è€…å‘¨æœŸæ€§æ‰§è¡Œçš„ä»»åŠ¡çš„ä¸»è¦æ‰§è¡Œæ–¹æ³•ã€‚å¦‚æœçº¿ç¨‹æ± å…³é—­ï¼Œæ‹’ç»ä»»åŠ¡ã€‚</span><br><span class="hljs-comment">     * å¦åˆ™æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—ä¸­å¹¶ä¸”å¦‚æœæœ‰å¿…è¦çš„è¯ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰§è¡Œä»»åŠ¡ã€‚ï¼ˆ</span><br><span class="hljs-comment">     * æˆ‘ä»¬ä¸èƒ½é¢„å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ¥è¿è¡Œä»»åŠ¡å› ä¸ºä»»åŠ¡ï¼ˆå¯èƒ½ï¼‰ è¿˜ä¸åº”è¯¥è¿è¡Œï¼‰</span><br><span class="hljs-comment">     * å¦‚æœçº¿ç¨‹æ± å…³é—­æ—¶ä»»åŠ¡æ­£åœ¨æ·»åŠ ï¼Œcancelå’Œremoveä»»åŠ¡å–å†³äºçŠ¶æ€å’Œ</span><br><span class="hljs-comment">     * run-after-shutdownå‚æ•°çš„éœ€æ±‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task the task</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delayedExecute</span><span class="hljs-params">(RunnableScheduledFuture&lt;?&gt; task)</span> &#123;<br>        <span class="hljs-keyword">if</span> (isShutdown())<br>            reject(task);<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">super</span>.getQueue().add(task);<br>            <span class="hljs-keyword">if</span> (!canRunInCurrentRunState(task) &amp;&amp; remove(task))<br>                task.cancel(<span class="hljs-literal">false</span>);<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-comment">// ä¸ preartCoreThread ç›¸åŒï¼Œä½†ä¼šå®‰æ’è‡³å°‘ä¸€ä¸ª çº¿ç¨‹è¢«å¯åŠ¨ï¼Œå³ä½¿ corePoolSize ä¸º 0ã€‚</span><br>                ensurePrestart();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Requeues a periodic task unless current run state precludes it.</span><br><span class="hljs-comment">     * Same idea as delayedExecute except drops task rather than rejecting.</span><br><span class="hljs-comment">     * é‡æ–°å°†å‘¨æœŸæ€§ä»»åŠ¡å…¥é˜Ÿï¼Œé™¤éå½“å‰è¿è¡ŒçŠ¶æ€ä¸å…è®¸</span><br><span class="hljs-comment">     * ä¸delayedExecuteæƒ³æ³•ç›¸åŒï¼Œä½†ä¼šæ”¾å¼ƒä»»åŠ¡è€Œä¸æ˜¯æ‹’ç»</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task the task</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">reExecutePeriodic</span><span class="hljs-params">(RunnableScheduledFuture&lt;?&gt; task)</span> &#123;<br>        <span class="hljs-keyword">if</span> (canRunInCurrentRunState(task)) &#123;<br>            <span class="hljs-built_in">super</span>.getQueue().add(task);<br>            <span class="hljs-keyword">if</span> (canRunInCurrentRunState(task) || !remove(task)) &#123;<br>                ensurePrestart();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br>        task.cancel(<span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Cancels and clears the queue of all tasks that should not be run</span><br><span class="hljs-comment">     * due to shutdown policy.  Invoked within super.shutdown.</span><br><span class="hljs-comment">     * å–æ¶ˆå¹¶æ¸…é™¤é˜Ÿåˆ—ä¸­æ‰€æœ‰å› å…³æœºç­–ç•¥è€Œä¸åº”è¿è¡Œçš„ä»»åŠ¡ã€‚ åœ¨ super.shutdown ä¸­è°ƒç”¨ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onShutdown</span><span class="hljs-params">()</span> &#123;<br>        BlockingQueue&lt;Runnable&gt; q = <span class="hljs-built_in">super</span>.getQueue();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">keepDelayed</span> <span class="hljs-operator">=</span><br>                getExecuteExistingDelayedTasksAfterShutdownPolicy();<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">keepPeriodic</span> <span class="hljs-operator">=</span><br>                getContinueExistingPeriodicTasksAfterShutdownPolicy();<br>        <span class="hljs-comment">// Traverse snapshot to avoid iterator exceptions</span><br>        <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> implement and use efficient removeIf</span><br>        <span class="hljs-comment">// super.getQueue().removeIf(...);</span><br>        <span class="hljs-keyword">for</span> (Object e : q.toArray()) &#123;<br>            <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> RunnableScheduledFuture) &#123;<br>                RunnableScheduledFuture&lt;?&gt; t = (RunnableScheduledFuture&lt;?&gt;)e;<br>                <span class="hljs-comment">// è¿™é‡Œæœ‰ t.getDelay(NANOSECONDS) &gt; 0 åˆ¤æ–­æ¡ä»¶</span><br>                <span class="hljs-comment">// ä¸ä¼šremove å’Œ cancelå·²ç»å¼€å§‹æ‰§è¡Œæˆ–ï¼ˆæ­£è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Ÿï¼‰</span><br>                <span class="hljs-keyword">if</span> ((t.isPeriodic()<br>                        ? !keepPeriodic<br>                        : (!keepDelayed &amp;&amp; t.getDelay(NANOSECONDS) &gt; <span class="hljs-number">0</span>))<br>                        || t.isCancelled()) &#123; <span class="hljs-comment">// also remove if already cancelled</span><br>                    <span class="hljs-keyword">if</span> (q.remove(t))<br>                        t.cancel(<span class="hljs-literal">false</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>        tryTerminate();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Modifies or replaces the task used to execute a runnable.</span><br><span class="hljs-comment">     * This method can be used to override the concrete</span><br><span class="hljs-comment">     * class used for managing internal tasks.</span><br><span class="hljs-comment">     * The default implementation simply returns the given task.</span><br><span class="hljs-comment">     * ä¿®æ”¹æˆ–æ›¿æ¢ç”¨äºæ‰§è¡Œ runnable çš„ä»»åŠ¡ã€‚</span><br><span class="hljs-comment">     * è¯¥æ–¹æ³•å¯ç”¨äºè¦†ç›–ç”¨äºç®¡ç†å†…éƒ¨ä»»åŠ¡çš„å…·ä½“ç±»ã€‚ é»˜è®¤å®ç°åªæ˜¯è¿”å›ç»™å®šçš„ä»»åŠ¡ã€‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> runnable the submitted Runnable</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task the task created to execute the runnable</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;V&gt; the type of the task&#x27;s result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a task that can execute the runnable</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@since</span> 1.6</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> &lt;V&gt; RunnableScheduledFuture&lt;V&gt; <span class="hljs-title function_">decorateTask</span><span class="hljs-params">(</span><br><span class="hljs-params">            Runnable runnable, RunnableScheduledFuture&lt;V&gt; task)</span> &#123;<br>        <span class="hljs-keyword">return</span> task;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Modifies or replaces the task used to execute a callable.</span><br><span class="hljs-comment">     * This method can be used to override the concrete</span><br><span class="hljs-comment">     * class used for managing internal tasks.</span><br><span class="hljs-comment">     * The default implementation simply returns the given task.</span><br><span class="hljs-comment">     * ä¿®æ”¹æˆ–æ›¿æ¢ç”¨äºæ‰§è¡Œ runnable çš„ä»»åŠ¡ã€‚</span><br><span class="hljs-comment">     * è¯¥æ–¹æ³•å¯ç”¨äºè¦†ç›–ç”¨äºç®¡ç†å†…éƒ¨ä»»åŠ¡çš„å…·ä½“ç±»ã€‚ é»˜è®¤å®ç°åªæ˜¯è¿”å›ç»™å®šçš„ä»»åŠ¡ã€‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> callable the submitted Callable</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> task the task created to execute the callable</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> &lt;V&gt; the type of the task&#x27;s result</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> a task that can execute the callable</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@since</span> 1.6</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> &lt;V&gt; RunnableScheduledFuture&lt;V&gt; <span class="hljs-title function_">decorateTask</span><span class="hljs-params">(</span><br><span class="hljs-params">            Callable&lt;V&gt; callable, RunnableScheduledFuture&lt;V&gt; task)</span> &#123;<br>        <span class="hljs-keyword">return</span> task;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * The default keep-alive time for pool threads.</span><br><span class="hljs-comment">     * çº¿ç¨‹æ± é»˜è®¤çš„keep-alive æ—¶é—´</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * Normally, this value is unused because all pool threads will be</span><br><span class="hljs-comment">     * core threads, but if a user creates a pool with a corePoolSize</span><br><span class="hljs-comment">     * of zero (against our advice), we keep a thread alive as long as</span><br><span class="hljs-comment">     * there are queued tasks.  If the keep alive time is zero (the</span><br><span class="hljs-comment">     * historic value), we end up hot-spinning in getTask, wasting a</span><br><span class="hljs-comment">     * CPU.  But on the other hand, if we set the value too high, and</span><br><span class="hljs-comment">     * users create a one-shot pool which they don&#x27;t cleanly shutdown,</span><br><span class="hljs-comment">     * the pool&#x27;s non-daemon threads will prevent JVM termination.  A</span><br><span class="hljs-comment">     * small but non-zero value (relative to a JVM&#x27;s lifetime) seems</span><br><span class="hljs-comment">     * best.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">DEFAULT_KEEPALIVE_MILLIS</span> <span class="hljs-operator">=</span> <span class="hljs-number">10L</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Creates a new &#123;<span class="hljs-doctag">@code</span> ScheduledThreadPoolExecutor&#125; with the</span><br><span class="hljs-comment">     * given core pool size.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> corePoolSize the number of threads to keep in the pool, even</span><br><span class="hljs-comment">     *        if they are idle, unless &#123;<span class="hljs-doctag">@code</span> allowCoreThreadTimeOut&#125; is set</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> corePoolSize &lt; 0&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScheduledThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize)</span> &#123;<br>        <span class="hljs-built_in">super</span>(corePoolSize, Integer.MAX_VALUE,<br>                DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedWorkQueue</span>());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Creates a new &#123;<span class="hljs-doctag">@code</span> ScheduledThreadPoolExecutor&#125; with the</span><br><span class="hljs-comment">     * given initial parameters.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> corePoolSize the number of threads to keep in the pool, even</span><br><span class="hljs-comment">     *        if they are idle, unless &#123;<span class="hljs-doctag">@code</span> allowCoreThreadTimeOut&#125; is set</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when the executor</span><br><span class="hljs-comment">     *        creates a new thread</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> corePoolSize &lt; 0&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if &#123;<span class="hljs-doctag">@code</span> threadFactory&#125; is null</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScheduledThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,</span><br><span class="hljs-params">                                       ThreadFactory threadFactory)</span> &#123;<br>        <span class="hljs-built_in">super</span>(corePoolSize, Integer.MAX_VALUE,<br>                DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedWorkQueue</span>(), threadFactory);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Creates a new &#123;<span class="hljs-doctag">@code</span> ScheduledThreadPoolExecutor&#125; with the</span><br><span class="hljs-comment">     * given initial parameters.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> corePoolSize the number of threads to keep in the pool, even</span><br><span class="hljs-comment">     *        if they are idle, unless &#123;<span class="hljs-doctag">@code</span> allowCoreThreadTimeOut&#125; is set</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler the handler to use when execution is blocked</span><br><span class="hljs-comment">     *        because the thread bounds and queue capacities are reached</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> corePoolSize &lt; 0&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if &#123;<span class="hljs-doctag">@code</span> handler&#125; is null</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScheduledThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,</span><br><span class="hljs-params">                                       RejectedExecutionHandler handler)</span> &#123;<br>        <span class="hljs-built_in">super</span>(corePoolSize, Integer.MAX_VALUE,<br>                DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedWorkQueue</span>(), handler);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Creates a new &#123;<span class="hljs-doctag">@code</span> ScheduledThreadPoolExecutor&#125; with the</span><br><span class="hljs-comment">     * given initial parameters.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> corePoolSize the number of threads to keep in the pool, even</span><br><span class="hljs-comment">     *        if they are idle, unless &#123;<span class="hljs-doctag">@code</span> allowCoreThreadTimeOut&#125; is set</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> threadFactory the factory to use when the executor</span><br><span class="hljs-comment">     *        creates a new thread</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> handler the handler to use when execution is blocked</span><br><span class="hljs-comment">     *        because the thread bounds and queue capacities are reached</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException if &#123;<span class="hljs-doctag">@code</span> corePoolSize &lt; 0&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException if &#123;<span class="hljs-doctag">@code</span> threadFactory&#125; or</span><br><span class="hljs-comment">     *         &#123;<span class="hljs-doctag">@code</span> handler&#125; is null</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScheduledThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,</span><br><span class="hljs-params">                                       ThreadFactory threadFactory,</span><br><span class="hljs-params">                                       RejectedExecutionHandler handler)</span> &#123;<br>        <span class="hljs-built_in">super</span>(corePoolSize, Integer.MAX_VALUE,<br>                DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedWorkQueue</span>(), threadFactory, handler);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns the nanoTime-based trigger time of a delayed action.</span><br><span class="hljs-comment">     * è¿”å›å»¶è¿ŸåŠ¨ä½œåŸºäº nanoTime çš„è§¦å‘æ—¶é—´ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">triggerTime</span><span class="hljs-params">(<span class="hljs-type">long</span> delay, TimeUnit unit)</span> &#123;<br>        <span class="hljs-keyword">return</span> triggerTime(unit.toNanos((delay &lt; <span class="hljs-number">0</span>) ? <span class="hljs-number">0</span> : delay));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns the nanoTime-based trigger time of a delayed action.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">long</span> <span class="hljs-title function_">triggerTime</span><span class="hljs-params">(<span class="hljs-type">long</span> delay)</span> &#123;<br>        <span class="hljs-keyword">return</span> System.nanoTime() +<br>                ((delay &lt; (Long.MAX_VALUE &gt;&gt; <span class="hljs-number">1</span>)) ? delay : overflowFree(delay));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Constrains the values of all delays in the queue to be within</span><br><span class="hljs-comment">     * Long.MAX_VALUE of each other, to avoid overflow in compareTo.</span><br><span class="hljs-comment">     * This may occur if a task is eligible to be dequeued, but has</span><br><span class="hljs-comment">     * not yet been, while some other task is added with a delay of</span><br><span class="hljs-comment">     * Long.MAX_VALUE.</span><br><span class="hljs-comment">     * ä¸ºäº†é¿å… compareTo ä¸­çš„æº¢å‡ºï¼Œé˜Ÿåˆ—ä¸­æ‰€æœ‰å»¶è¿Ÿçš„å€¼éƒ½å¿…é¡»åœ¨ Long.MAX_VALUE èŒƒå›´å†…ã€‚</span><br><span class="hljs-comment">     * å¦‚æœä¸€ä¸ªä»»åŠ¡ç¬¦åˆå‡ºé˜Ÿæ¡ä»¶ï¼Œä½†å°šæœªå‡ºé˜Ÿï¼Œè€Œå…¶ä»–ä»»åŠ¡è¢«æ·»åŠ äº†ä¸€ä¸ª Long.MAX_VALUE çš„å»¶è¿Ÿï¼Œåˆ™å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">overflowFree</span><span class="hljs-params">(<span class="hljs-type">long</span> delay)</span> &#123;<br>        <span class="hljs-type">Delayed</span> <span class="hljs-variable">head</span> <span class="hljs-operator">=</span> (Delayed) <span class="hljs-built_in">super</span>.getQueue().peek();<br>        <span class="hljs-keyword">if</span> (head != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">headDelay</span> <span class="hljs-operator">=</span> head.getDelay(NANOSECONDS);<br>            <span class="hljs-keyword">if</span> (headDelay &lt; <span class="hljs-number">0</span> &amp;&amp; (delay - headDelay &lt; <span class="hljs-number">0</span>))<br>                delay = Long.MAX_VALUE + headDelay;<br>        &#125;<br>        <span class="hljs-keyword">return</span> delay;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException       &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; schedule(Runnable command,<br>                                       <span class="hljs-type">long</span> delay,<br>                                       TimeUnit unit) &#123;<br>        <span class="hljs-keyword">if</span> (command == <span class="hljs-literal">null</span> || unit == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        <span class="hljs-comment">// è¿™é‡Œè£…é¥°taskå…¶å®å•¥éƒ½æ²¡åš</span><br>        RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledFutureTask</span>&lt;Void&gt;(command, <span class="hljs-literal">null</span>,<br>                        triggerTime(delay, unit),<br>                        sequencer.getAndIncrement()));<br>        delayedExecute(t);<br>        <span class="hljs-keyword">return</span> t;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException       &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> &lt;V&gt; ScheduledFuture&lt;V&gt; <span class="hljs-title function_">schedule</span><span class="hljs-params">(Callable&lt;V&gt; callable,</span><br><span class="hljs-params">                                           <span class="hljs-type">long</span> delay,</span><br><span class="hljs-params">                                           TimeUnit unit)</span> &#123;<br>        <span class="hljs-keyword">if</span> (callable == <span class="hljs-literal">null</span> || unit == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        RunnableScheduledFuture&lt;V&gt; t = decorateTask(callable,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledFutureTask</span>&lt;V&gt;(callable,<br>                        triggerTime(delay, unit),<br>                        sequencer.getAndIncrement()));<br>        delayedExecute(t);<br>        <span class="hljs-keyword">return</span> t;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Submits a periodic action that becomes enabled first after the</span><br><span class="hljs-comment">     * given initial delay, and subsequently with the given period;</span><br><span class="hljs-comment">     * that is, executions will commence after</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> initialDelay&#125;, then &#123;<span class="hljs-doctag">@code</span> initialDelay + period&#125;, then</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> initialDelay + 2 * period&#125;, and so on.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;The sequence of task executions continues indefinitely until</span><br><span class="hljs-comment">     * one of the following exceptional completions occur:</span><br><span class="hljs-comment">     * &lt;ul&gt;</span><br><span class="hljs-comment">     * &lt;li&gt;The task is &#123;<span class="hljs-doctag">@linkplain</span> Future#cancel explicitly cancelled&#125;</span><br><span class="hljs-comment">     * via the returned future.</span><br><span class="hljs-comment">     * &lt;li&gt;Method &#123;<span class="hljs-doctag">@link</span> #shutdown&#125; is called and the &#123;<span class="hljs-doctag">@linkplain</span></span><br><span class="hljs-comment">     * #getContinueExistingPeriodicTasksAfterShutdownPolicy policy on</span><br><span class="hljs-comment">     * whether to continue after shutdown&#125; is not set true, or method</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> #shutdownNow&#125; is called; also resulting in task</span><br><span class="hljs-comment">     * cancellation.</span><br><span class="hljs-comment">     * &lt;li&gt;An execution of the task throws an exception.  In this case</span><br><span class="hljs-comment">     * calling &#123;<span class="hljs-doctag">@link</span> Future#get() get&#125; on the returned future will throw</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> ExecutionException&#125;, holding the exception as its cause.</span><br><span class="hljs-comment">     * &lt;/ul&gt;</span><br><span class="hljs-comment">     * Subsequent executions are suppressed.  Subsequent calls to</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> Future#isDone isDone()&#125; on the returned future will</span><br><span class="hljs-comment">     * return &#123;<span class="hljs-doctag">@code</span> true&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;If any execution of this task takes longer than its period, then</span><br><span class="hljs-comment">     * subsequent executions may start late, but will not concurrently</span><br><span class="hljs-comment">     * execute.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException       &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException   &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command,<br>                                                  <span class="hljs-type">long</span> initialDelay,<br>                                                  <span class="hljs-type">long</span> period,<br>                                                  TimeUnit unit) &#123;<br>        <span class="hljs-keyword">if</span> (command == <span class="hljs-literal">null</span> || unit == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        <span class="hljs-keyword">if</span> (period &lt;= <span class="hljs-number">0L</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>        ScheduledFutureTask&lt;Void&gt; sft =<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledFutureTask</span>&lt;Void&gt;(command,<br>                        <span class="hljs-literal">null</span>,<br>                        triggerTime(initialDelay, unit),<br>                        unit.toNanos(period),<br>                        sequencer.getAndIncrement());<br>        RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command, sft);<br>        sft.outerTask = t;<br>        delayedExecute(t);<br>        <span class="hljs-keyword">return</span> t;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Submits a periodic action that becomes enabled first after the</span><br><span class="hljs-comment">     * given initial delay, and subsequently with the given delay</span><br><span class="hljs-comment">     * between the termination of one execution and the commencement of</span><br><span class="hljs-comment">     * the next.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;The sequence of task executions continues indefinitely until</span><br><span class="hljs-comment">     * one of the following exceptional completions occur:</span><br><span class="hljs-comment">     * &lt;ul&gt;</span><br><span class="hljs-comment">     * &lt;li&gt;The task is &#123;<span class="hljs-doctag">@linkplain</span> Future#cancel explicitly cancelled&#125;</span><br><span class="hljs-comment">     * via the returned future.</span><br><span class="hljs-comment">     * &lt;li&gt;Method &#123;<span class="hljs-doctag">@link</span> #shutdown&#125; is called and the &#123;<span class="hljs-doctag">@linkplain</span></span><br><span class="hljs-comment">     * #getContinueExistingPeriodicTasksAfterShutdownPolicy policy on</span><br><span class="hljs-comment">     * whether to continue after shutdown&#125; is not set true, or method</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> #shutdownNow&#125; is called; also resulting in task</span><br><span class="hljs-comment">     * cancellation.</span><br><span class="hljs-comment">     * &lt;li&gt;An execution of the task throws an exception.  In this case</span><br><span class="hljs-comment">     * calling &#123;<span class="hljs-doctag">@link</span> Future#get() get&#125; on the returned future will throw</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> ExecutionException&#125;, holding the exception as its cause.</span><br><span class="hljs-comment">     * &lt;/ul&gt;</span><br><span class="hljs-comment">     * Subsequent executions are suppressed.  Subsequent calls to</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> Future#isDone isDone()&#125; on the returned future will</span><br><span class="hljs-comment">     * return &#123;<span class="hljs-doctag">@code</span> true&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException       &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IllegalArgumentException   &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command,<br>                                                     <span class="hljs-type">long</span> initialDelay,<br>                                                     <span class="hljs-type">long</span> delay,<br>                                                     TimeUnit unit) &#123;<br>        <span class="hljs-keyword">if</span> (command == <span class="hljs-literal">null</span> || unit == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        <span class="hljs-keyword">if</span> (delay &lt;= <span class="hljs-number">0L</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>        ScheduledFutureTask&lt;Void&gt; sft =<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledFutureTask</span>&lt;Void&gt;(command,<br>                        <span class="hljs-literal">null</span>,<br>                        triggerTime(initialDelay, unit),<br>                        -unit.toNanos(delay),<br>                        sequencer.getAndIncrement());<br>        RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command, sft);<br>        sft.outerTask = t;<br>        delayedExecute(t);<br>        <span class="hljs-keyword">return</span> t;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Executes &#123;<span class="hljs-doctag">@code</span> command&#125; with zero required delay.</span><br><span class="hljs-comment">     * This has effect equivalent to</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> #schedule(Runnable,long,TimeUnit) schedule(command, 0, anyUnit)&#125;.</span><br><span class="hljs-comment">     * Note that inspections of the queue and of the list returned by</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> shutdownNow&#125; will access the zero-delayed</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@link</span> ScheduledFuture&#125;, not the &#123;<span class="hljs-doctag">@code</span> command&#125; itself.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;A consequence of the use of &#123;<span class="hljs-doctag">@code</span> ScheduledFuture&#125; objects is</span><br><span class="hljs-comment">     * that &#123;<span class="hljs-doctag">@link</span> ThreadPoolExecutor#afterExecute afterExecute&#125; is always</span><br><span class="hljs-comment">     * called with a null second &#123;<span class="hljs-doctag">@code</span> Throwable&#125; argument, even if the</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> command&#125; terminated abruptly.  Instead, the &#123;<span class="hljs-doctag">@code</span> Throwable&#125;</span><br><span class="hljs-comment">     * thrown by such a task can be obtained via &#123;<span class="hljs-doctag">@link</span> Future#get&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException at discretion of</span><br><span class="hljs-comment">     *         &#123;<span class="hljs-doctag">@code</span> RejectedExecutionHandler&#125;, if the task</span><br><span class="hljs-comment">     *         cannot be accepted for execution because the</span><br><span class="hljs-comment">     *         executor has been shut down</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable command)</span> &#123;<br>        schedule(command, <span class="hljs-number">0</span>, NANOSECONDS);<br>    &#125;<br><br>    <span class="hljs-comment">// Override AbstractExecutorService methods</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException       &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;<br>        <span class="hljs-keyword">return</span> schedule(task, <span class="hljs-number">0</span>, NANOSECONDS);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException       &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Runnable task, T result)</span> &#123;<br>        <span class="hljs-keyword">return</span> schedule(Executors.callable(task, result), <span class="hljs-number">0</span>, NANOSECONDS);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RejectedExecutionException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> NullPointerException       &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Callable&lt;T&gt; task)</span> &#123;<br>        <span class="hljs-keyword">return</span> schedule(task, <span class="hljs-number">0</span>, NANOSECONDS);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Sets the policy on whether to continue executing existing</span><br><span class="hljs-comment">     * periodic tasks even when this executor has been &#123;<span class="hljs-doctag">@code</span> shutdown&#125;.</span><br><span class="hljs-comment">     * In this case, executions will continue until &#123;<span class="hljs-doctag">@code</span> shutdownNow&#125;</span><br><span class="hljs-comment">     * or the policy is set to &#123;<span class="hljs-doctag">@code</span> false&#125; when already shutdown.</span><br><span class="hljs-comment">     * This value is by default &#123;<span class="hljs-doctag">@code</span> false&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value if &#123;<span class="hljs-doctag">@code</span> true&#125;, continue after shutdown, else don&#x27;t</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #getContinueExistingPeriodicTasksAfterShutdownPolicy</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContinueExistingPeriodicTasksAfterShutdownPolicy</span><span class="hljs-params">(<span class="hljs-type">boolean</span> value)</span> &#123;<br>        continueExistingPeriodicTasksAfterShutdown = value;<br>        <span class="hljs-keyword">if</span> (!value &amp;&amp; isShutdown())<br>            onShutdown();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Gets the policy on whether to continue executing existing</span><br><span class="hljs-comment">     * periodic tasks even when this executor has been &#123;<span class="hljs-doctag">@code</span> shutdown&#125;.</span><br><span class="hljs-comment">     * In this case, executions will continue until &#123;<span class="hljs-doctag">@code</span> shutdownNow&#125;</span><br><span class="hljs-comment">     * or the policy is set to &#123;<span class="hljs-doctag">@code</span> false&#125; when already shutdown.</span><br><span class="hljs-comment">     * This value is by default &#123;<span class="hljs-doctag">@code</span> false&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> true&#125; if will continue after shutdown</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #setContinueExistingPeriodicTasksAfterShutdownPolicy</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getContinueExistingPeriodicTasksAfterShutdownPolicy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> continueExistingPeriodicTasksAfterShutdown;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Sets the policy on whether to execute existing delayed</span><br><span class="hljs-comment">     * tasks even when this executor has been &#123;<span class="hljs-doctag">@code</span> shutdown&#125;.</span><br><span class="hljs-comment">     * In this case, these tasks will only terminate upon</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> shutdownNow&#125;, or after setting the policy to</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> false&#125; when already shutdown.</span><br><span class="hljs-comment">     * This value is by default &#123;<span class="hljs-doctag">@code</span> true&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value if &#123;<span class="hljs-doctag">@code</span> true&#125;, execute after shutdown, else don&#x27;t</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #getExecuteExistingDelayedTasksAfterShutdownPolicy</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecuteExistingDelayedTasksAfterShutdownPolicy</span><span class="hljs-params">(<span class="hljs-type">boolean</span> value)</span> &#123;<br>        executeExistingDelayedTasksAfterShutdown = value;<br>        <span class="hljs-keyword">if</span> (!value &amp;&amp; isShutdown())<br>            onShutdown();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Gets the policy on whether to execute existing delayed</span><br><span class="hljs-comment">     * tasks even when this executor has been &#123;<span class="hljs-doctag">@code</span> shutdown&#125;.</span><br><span class="hljs-comment">     * In this case, these tasks will only terminate upon</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> shutdownNow&#125;, or after setting the policy to</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> false&#125; when already shutdown.</span><br><span class="hljs-comment">     * This value is by default &#123;<span class="hljs-doctag">@code</span> true&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> true&#125; if will execute after shutdown</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #setExecuteExistingDelayedTasksAfterShutdownPolicy</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getExecuteExistingDelayedTasksAfterShutdownPolicy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> executeExistingDelayedTasksAfterShutdown;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Sets the policy on whether cancelled tasks should be immediately</span><br><span class="hljs-comment">     * removed from the work queue at time of cancellation.  This value is</span><br><span class="hljs-comment">     * by default &#123;<span class="hljs-doctag">@code</span> false&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> value if &#123;<span class="hljs-doctag">@code</span> true&#125;, remove on cancellation, else don&#x27;t</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #getRemoveOnCancelPolicy</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@since</span> 1.7</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRemoveOnCancelPolicy</span><span class="hljs-params">(<span class="hljs-type">boolean</span> value)</span> &#123;<br>        removeOnCancel = value;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Gets the policy on whether cancelled tasks should be immediately</span><br><span class="hljs-comment">     * removed from the work queue at time of cancellation.  This value is</span><br><span class="hljs-comment">     * by default &#123;<span class="hljs-doctag">@code</span> false&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> true&#125; if cancelled tasks are immediately removed</span><br><span class="hljs-comment">     *         from the queue</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@see</span> #setRemoveOnCancelPolicy</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@since</span> 1.7</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">getRemoveOnCancelPolicy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> removeOnCancel;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Initiates an orderly shutdown in which previously submitted</span><br><span class="hljs-comment">     * tasks are executed, but no new tasks will be accepted.</span><br><span class="hljs-comment">     * Invocation has no additional effect if already shut down.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;This method does not wait for previously submitted tasks to</span><br><span class="hljs-comment">     * complete execution.  Use &#123;<span class="hljs-doctag">@link</span> #awaitTermination awaitTermination&#125;</span><br><span class="hljs-comment">     * to do that.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;If the &#123;<span class="hljs-doctag">@code</span> ExecuteExistingDelayedTasksAfterShutdownPolicy&#125;</span><br><span class="hljs-comment">     * has been set &#123;<span class="hljs-doctag">@code</span> false&#125;, existing delayed tasks whose delays</span><br><span class="hljs-comment">     * have not yet elapsed are cancelled.  And unless the &#123;<span class="hljs-doctag">@code</span></span><br><span class="hljs-comment">     * ContinueExistingPeriodicTasksAfterShutdownPolicy&#125; has been set</span><br><span class="hljs-comment">     * &#123;<span class="hljs-doctag">@code</span> true&#125;, future executions of existing periodic tasks will</span><br><span class="hljs-comment">     * be cancelled.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> SecurityException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">super</span>.shutdown();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Attempts to stop all actively executing tasks, halts the</span><br><span class="hljs-comment">     * processing of waiting tasks, and returns a list of the tasks</span><br><span class="hljs-comment">     * that were awaiting execution. These tasks are drained (removed)</span><br><span class="hljs-comment">     * from the task queue upon return from this method.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;This method does not wait for actively executing tasks to</span><br><span class="hljs-comment">     * terminate.  Use &#123;<span class="hljs-doctag">@link</span> #awaitTermination awaitTermination&#125; to</span><br><span class="hljs-comment">     * do that.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;There are no guarantees beyond best-effort attempts to stop</span><br><span class="hljs-comment">     * processing actively executing tasks.  This implementation</span><br><span class="hljs-comment">     * interrupts tasks via &#123;<span class="hljs-doctag">@link</span> Thread#interrupt&#125;; any task that</span><br><span class="hljs-comment">     * fails to respond to interrupts may never terminate.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> list of tasks that never commenced execution.</span><br><span class="hljs-comment">     *         Each element of this list is a &#123;<span class="hljs-doctag">@link</span> ScheduledFuture&#125;.</span><br><span class="hljs-comment">     *         For tasks submitted via one of the &#123;<span class="hljs-doctag">@code</span> schedule&#125;</span><br><span class="hljs-comment">     *         methods, the element will be identical to the returned</span><br><span class="hljs-comment">     *         &#123;<span class="hljs-doctag">@code</span> ScheduledFuture&#125;.  For tasks submitted using</span><br><span class="hljs-comment">     *         &#123;<span class="hljs-doctag">@link</span> #execute execute&#125;, the element will be a</span><br><span class="hljs-comment">     *         zero-delay &#123;<span class="hljs-doctag">@code</span> ScheduledFuture&#125;.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> SecurityException &#123;<span class="hljs-doctag">@inheritDoc</span>&#125;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;Runnable&gt; <span class="hljs-title function_">shutdownNow</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.shutdownNow();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns the task queue used by this executor.  Access to the</span><br><span class="hljs-comment">     * task queue is intended primarily for debugging and monitoring.</span><br><span class="hljs-comment">     * This queue may be in active use.  Retrieving the task queue</span><br><span class="hljs-comment">     * does not prevent queued tasks from executing.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;Each element of this queue is a &#123;<span class="hljs-doctag">@link</span> ScheduledFuture&#125;.</span><br><span class="hljs-comment">     * For tasks submitted via one of the &#123;<span class="hljs-doctag">@code</span> schedule&#125; methods, the</span><br><span class="hljs-comment">     * element will be identical to the returned &#123;<span class="hljs-doctag">@code</span> ScheduledFuture&#125;.</span><br><span class="hljs-comment">     * For tasks submitted using &#123;<span class="hljs-doctag">@link</span> #execute execute&#125;, the element</span><br><span class="hljs-comment">     * will be a zero-delay &#123;<span class="hljs-doctag">@code</span> ScheduledFuture&#125;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt;Iteration over this queue is &lt;em&gt;not&lt;/em&gt; guaranteed to traverse</span><br><span class="hljs-comment">     * tasks in the order in which they will execute.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the task queue</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> BlockingQueue&lt;Runnable&gt; <span class="hljs-title function_">getQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getQueue();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Specialized delay queue. To mesh with TPE declarations, this</span><br><span class="hljs-comment">     * class must be declared as a BlockingQueue&lt;Runnable&gt; even though</span><br><span class="hljs-comment">     * it can only hold RunnableScheduledFutures.</span><br><span class="hljs-comment">     * ä¸“ç”¨å»¶è¿Ÿé˜Ÿåˆ—ã€‚ä¸ºäº†ä¸ TPE å£°æ˜ä¿æŒä¸€è‡´ï¼Œè¯¥ç±»å¿…é¡»å£°æ˜ä¸º BlockingQueue&lt;Runnable&gt; ç±»ï¼Œ</span><br><span class="hljs-comment">     * å³ä½¿ å®ƒåªèƒ½å®¹çº³ RunnableScheduledFuturesã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayedWorkQueue</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueue</span>&lt;Runnable&gt;<br>            <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BlockingQueue</span>&lt;Runnable&gt; &#123;<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * A DelayedWorkQueue is based on a heap-based data structure</span><br><span class="hljs-comment">         * like those in DelayQueue and PriorityQueue, except that</span><br><span class="hljs-comment">         * every ScheduledFutureTask also records its index into the</span><br><span class="hljs-comment">         * heap array. This eliminates the need to find a task upon</span><br><span class="hljs-comment">         * cancellation, greatly speeding up removal (down from O(n)</span><br><span class="hljs-comment">         * to O(log n)), and reducing garbage retention that would</span><br><span class="hljs-comment">         * otherwise occur by waiting for the element to rise to top</span><br><span class="hljs-comment">         * before clearing. But because the queue may also hold</span><br><span class="hljs-comment">         * RunnableScheduledFutures that are not ScheduledFutureTasks,</span><br><span class="hljs-comment">         * we are not guaranteed to have such indices available, in</span><br><span class="hljs-comment">         * which case we fall back to linear search. (We expect that</span><br><span class="hljs-comment">         * most tasks will not be decorated, and that the faster cases</span><br><span class="hljs-comment">         * will be much more common.)</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * All heap operations must record index changes -- mainly</span><br><span class="hljs-comment">         * within siftUp and siftDown. Upon removal, a task&#x27;s</span><br><span class="hljs-comment">         * heapIndex is set to -1. Note that ScheduledFutureTasks can</span><br><span class="hljs-comment">         * appear at most once in the queue (this need not be true for</span><br><span class="hljs-comment">         * other kinds of tasks or work queues), so are uniquely</span><br><span class="hljs-comment">         * identified by heapIndex.</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * DelayedWorkQueue åŸºäºå †æ•°æ®ç»“æ„ï¼Œå°±åƒ DelayQueue å’Œ PriorityQueue ä¸­çš„æ•°æ®ç»“æ„ä¸€æ ·ï¼Œ</span><br><span class="hljs-comment">         * åªæ˜¯æ¯ä¸ª ScheduledFutureTask ä¹Ÿå°†å…¶ç´¢å¼•è®°å½•åˆ°å †æ•°ç»„ä¸­ã€‚</span><br><span class="hljs-comment">         * è¿™æ ·å°±ä¸éœ€è¦åœ¨å–æ¶ˆä»»åŠ¡æ—¶æŸ¥æ‰¾ä»»åŠ¡ï¼Œä»è€Œå¤§å¤§åŠ å¿«äº†ç§»é™¤é€Ÿåº¦ï¼ˆä» O(n) é™è‡³ O(log n)ï¼‰ï¼Œ</span><br><span class="hljs-comment">         * å¹¶å‡å°‘äº†å› ç­‰å¾…å…ƒç´ å‡è‡³é¡¶ç«¯åå†æ¸…é™¤è€Œäº§ç”Ÿçš„åƒåœ¾æ»ç•™ã€‚</span><br><span class="hljs-comment">         * ä½†æ˜¯ï¼Œç”±äºé˜Ÿåˆ—ä¸­ä¹Ÿå¯èƒ½åŒ…å«ä¸æ˜¯ ScheduledFutureTasks çš„ RunnableScheduledFuturesï¼Œ</span><br><span class="hljs-comment">         * æˆ‘ä»¬ä¸èƒ½ä¿è¯ä¸€å®šä¼šæœ‰è¿™æ ·çš„ç´¢å¼•ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±ä¼šé€€å›åˆ°çº¿æ€§æœç´¢ã€‚</span><br><span class="hljs-comment">         * (æˆ‘ä»¬é¢„è®¡å¤§å¤šæ•°ä»»åŠ¡ä¸ä¼šè¢«è£…é¥°ï¼Œè€Œé€Ÿåº¦æ›´å¿«çš„æƒ…å†µå°†æ›´ä¸ºå¸¸è§ï¼‰ã€‚</span><br><span class="hljs-comment">         * æ‰€æœ‰å †æ“ä½œéƒ½å¿…é¡»è®°å½•ç´¢å¼•å˜åŒ– -- ä¸»è¦æ˜¯åœ¨ siftUp å’Œ siftDown ä¸­ã€‚</span><br><span class="hljs-comment">         * åˆ é™¤æ—¶ï¼Œä»»åŠ¡çš„ heapIndex å°†è¢«è®¾ç½®ä¸º-1ã€‚</span><br><span class="hljs-comment">         * è¯·æ³¨æ„ï¼ŒScheduledFutureTasks åœ¨é˜Ÿåˆ—ä¸­æœ€å¤šåªèƒ½å‡ºç°ä¸€æ¬¡ï¼ˆå…¶ä»–ç±»å‹çš„ä»»åŠ¡æˆ–å·¥ä½œé˜Ÿåˆ—åˆ™ä¸éœ€è¦å¦‚æ­¤ï¼‰ï¼Œ</span><br><span class="hljs-comment">         * å› æ­¤ç”± heapIndex å”¯ä¸€æ ‡è¯†ã€‚ç”± heapIndex å”¯ä¸€æ ‡è¯†ã€‚</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INITIAL_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;<br>        <span class="hljs-keyword">private</span> RunnableScheduledFuture&lt;?&gt;[] queue =<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">RunnableScheduledFuture</span>&lt;?&gt;[INITIAL_CAPACITY];<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Thread designated to wait for the task at the head of the</span><br><span class="hljs-comment">         * queue.  This variant of the Leader-Follower pattern</span><br><span class="hljs-comment">         * (http://www.cs.wustl.edu/~schmidt/POSA/POSA2/) serves to</span><br><span class="hljs-comment">         * minimize unnecessary timed waiting.  When a thread becomes</span><br><span class="hljs-comment">         * the leader, it waits only for the next delay to elapse, but</span><br><span class="hljs-comment">         * other threads await indefinitely.  The leader thread must</span><br><span class="hljs-comment">         * signal some other thread before returning from take() or</span><br><span class="hljs-comment">         * poll(...), unless some other thread becomes leader in the</span><br><span class="hljs-comment">         * interim.  Whenever the head of the queue is replaced with a</span><br><span class="hljs-comment">         * task with an earlier expiration time, the leader field is</span><br><span class="hljs-comment">         * invalidated by being reset to null, and some waiting</span><br><span class="hljs-comment">         * thread, but not necessarily the current leader, is</span><br><span class="hljs-comment">         * signalled.  So waiting threads must be prepared to acquire</span><br><span class="hljs-comment">         * and lose leadership while waiting.</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * æŒ‡å®šçº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—å¤´éƒ¨çš„ä»»åŠ¡ã€‚</span><br><span class="hljs-comment">         * è¿™ç§ &quot;é¢†å¯¼è€…-è¿½éšè€… &quot;æ¨¡å¼ï¼ˆhttp://www.cs.wustl.edu/~schmidt/POSA/POSA2/ï¼‰çš„å˜ä½“</span><br><span class="hljs-comment">         * å¯æœ€å¤§é™åº¦åœ°å‡å°‘ä¸å¿…è¦çš„å®šæ—¶ç­‰å¾…ã€‚</span><br><span class="hljs-comment">         * å½“ä¸€ä¸ªçº¿ç¨‹æˆä¸ºé¢†å¯¼è€…æ—¶ï¼Œå®ƒåªç­‰å¾…ä¸‹ä¸€æ¬¡å»¶è¿Ÿçš„åˆ°æ¥ï¼Œè€Œå…¶ä»–çº¿ç¨‹åˆ™æ— é™æœŸåœ°ç­‰å¾…ã€‚</span><br><span class="hljs-comment">         * åœ¨ä» take() æˆ– poll(...) è¿”å›ä¹‹å‰ï¼Œé¢†å¯¼çº¿ç¨‹å¿…é¡»å‘å…¶ä»–çº¿ç¨‹å‘å‡ºä¿¡å·ï¼Œé™¤éå…¶ä»–çº¿ç¨‹åœ¨æ­¤æœŸé—´æˆä¸ºé¢†å¯¼çº¿ç¨‹ã€‚</span><br><span class="hljs-comment">         * æ¯å½“é˜Ÿåˆ—çš„å¤´è¢«ä¸€ä¸ªåˆ°æœŸæ—¶é—´æ›´æ—©çš„ä»»åŠ¡å–ä»£æ—¶ï¼Œé¢†å¯¼è€…å­—æ®µå°±ä¼šè¢«é‡ç½®ä¸ºç©ºè€Œå¤±æ•ˆï¼Œ</span><br><span class="hljs-comment">         * åŒæ—¶ä¸€äº›ç­‰å¾…çº¿ç¨‹ï¼ˆä½†ä¸ä¸€å®šæ˜¯å½“å‰çš„é¢†å¯¼è€…ï¼‰ä¼šæ”¶åˆ°ä¿¡å·ã€‚</span><br><span class="hljs-comment">         * å› æ­¤ï¼Œç­‰å¾…çº¿ç¨‹å¿…é¡»åšå¥½åœ¨ç­‰å¾…æœŸé—´è·å¾—å’Œå¤±å»é¢†å¯¼è€…çš„å‡†å¤‡ã€‚</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> Thread leader;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Condition signalled when a newer task becomes available at the</span><br><span class="hljs-comment">         * head of the queue or a new thread may need to become leader.</span><br><span class="hljs-comment">         * å½“é˜Ÿåˆ—å¤´éƒ¨æœ‰æ–°ä»»åŠ¡å¯ç”¨æˆ–æ–°çº¿ç¨‹éœ€è¦æˆä¸ºé¢†å¯¼æ—¶ï¼Œå°±ä¼šå‘å‡ºä¿¡å·ã€‚</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> lock.newCondition();<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Sets f&#x27;s heapIndex if it is a ScheduledFutureTask.</span><br><span class="hljs-comment">         * å¦‚æœ f æ˜¯ ScheduledFutureTaskï¼Œåˆ™è®¾ç½®å…¶ heapIndexã€‚</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIndex</span><span class="hljs-params">(RunnableScheduledFuture&lt;?&gt; f, <span class="hljs-type">int</span> idx)</span> &#123;<br>            <span class="hljs-keyword">if</span> (f <span class="hljs-keyword">instanceof</span> ScheduledFutureTask)<br>                ((ScheduledFutureTask)f).heapIndex = idx;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Sifts element added at bottom up to its heap-ordered spot.</span><br><span class="hljs-comment">         * Call only when holding lock.</span><br><span class="hljs-comment">         * å°†åº•éƒ¨æ·»åŠ çš„å…ƒç´ ä¸Šç§»åˆ°å †ä¸­æœ‰åºçš„ä½ç½®ã€‚ä»…åœ¨æŒæœ‰é”æ—¶è°ƒç”¨</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftUp</span><span class="hljs-params">(<span class="hljs-type">int</span> k, RunnableScheduledFuture&lt;?&gt; key)</span> &#123;<br>            <span class="hljs-keyword">while</span> (k &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> (k - <span class="hljs-number">1</span>) &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>                RunnableScheduledFuture&lt;?&gt; e = queue[parent];<br>                <span class="hljs-keyword">if</span> (key.compareTo(e) &gt;= <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">break</span>;<br>                queue[k] = e;<br>                setIndex(e, k);<br>                k = parent;<br>            &#125;<br>            queue[k] = key;<br>            setIndex(key, k);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Sifts element added at top down to its heap-ordered spot.</span><br><span class="hljs-comment">         * Call only when holding lock.</span><br><span class="hljs-comment">         * å°†é¡¶éƒ¨æ·»åŠ çš„å…ƒç´ ä¸‹ç§»åˆ°å †ä¸­æœ‰åºçš„ä½ç½®ã€‚ä»…åœ¨æŒæœ‰é”æ—¶è°ƒç”¨</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">siftDown</span><span class="hljs-params">(<span class="hljs-type">int</span> k, RunnableScheduledFuture&lt;?&gt; key)</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">half</span> <span class="hljs-operator">=</span> size &gt;&gt;&gt; <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span> (k &lt; half) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> (k &lt;&lt; <span class="hljs-number">1</span>) + <span class="hljs-number">1</span>;<br>                RunnableScheduledFuture&lt;?&gt; c = queue[child];<br>                <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> child + <span class="hljs-number">1</span>;<br>                <span class="hljs-comment">// é™¤äº†è¾¹ç•Œå¤„ï¼Œåº”è¯¥ä¸€èˆ¬éƒ½æ»¡è¶³ä¸‹é¢çš„æ¡ä»¶</span><br>                <span class="hljs-keyword">if</span> (right &lt; size &amp;&amp; c.compareTo(queue[right]) &gt; <span class="hljs-number">0</span>)<br>                    c = queue[child = right];<br>                <span class="hljs-keyword">if</span> (key.compareTo(c) &lt;= <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">break</span>;<br>                queue[k] = c;<br>                setIndex(c, k);<br>                k = child;<br>            &#125;<br>            queue[k] = key;<br>            setIndex(key, k);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Resizes the heap array.  Call only when holding lock.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">grow</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">oldCapacity</span> <span class="hljs-operator">=</span> queue.length;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">newCapacity</span> <span class="hljs-operator">=</span> oldCapacity + (oldCapacity &gt;&gt; <span class="hljs-number">1</span>); <span class="hljs-comment">// grow 50%</span><br>            <span class="hljs-keyword">if</span> (newCapacity &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">// overflow</span><br>                newCapacity = Integer.MAX_VALUE;<br>            queue = Arrays.copyOf(queue, newCapacity);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Finds index of given object, or -1 if absent.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(Object x)</span> &#123;<br>            <span class="hljs-keyword">if</span> (x != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (x <span class="hljs-keyword">instanceof</span> ScheduledFutureTask) &#123;<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> ((ScheduledFutureTask) x).heapIndex;<br>                    <span class="hljs-comment">// Sanity check; x could conceivably be a</span><br>                    <span class="hljs-comment">// ScheduledFutureTask from some other pool.</span><br>                    <span class="hljs-comment">// ç†æ™ºæ£€æŸ¥ï¼›xæœ‰å¯èƒ½æ˜¯æ¥è‡ªå…¶ä»–ä»»åŠ¡æ± çš„ScheduledFutureTaskã€‚</span><br>                    <span class="hljs-keyword">if</span> (i &gt;= <span class="hljs-number">0</span> &amp;&amp; i &lt; size &amp;&amp; queue[i] == x)<br>                        <span class="hljs-keyword">return</span> i;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++)<br>                        <span class="hljs-keyword">if</span> (x.equals(queue[i]))<br>                            <span class="hljs-keyword">return</span> i;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(Object x)</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> indexOf(x) != -<span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">remove</span><span class="hljs-params">(Object x)</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> indexOf(x);<br>                <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>                setIndex(queue[i], -<span class="hljs-number">1</span>);<br>                <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> --size;<br>                RunnableScheduledFuture&lt;?&gt; replacement = queue[s];<br>                queue[s] = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">if</span> (s != i) &#123;<br>                    siftDown(i, replacement);<br>                    <span class="hljs-comment">// æ²¡æœ‰ä¸‹ç§»ï¼Œä¸Šç§»</span><br>                    <span class="hljs-keyword">if</span> (queue[i] == replacement)<br>                        siftUp(i, replacement);<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> size;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> size() == <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">remainingCapacity</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> Integer.MAX_VALUE;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> RunnableScheduledFuture&lt;?&gt; peek() &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> queue[<span class="hljs-number">0</span>];<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * å¾€é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ </span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> x the element to add</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">offer</span><span class="hljs-params">(Runnable x)</span> &#123;<br>            <span class="hljs-keyword">if</span> (x == <span class="hljs-literal">null</span>)<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>            RunnableScheduledFuture&lt;?&gt; e = (RunnableScheduledFuture&lt;?&gt;)x;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> size;<br>                <span class="hljs-keyword">if</span> (i &gt;= queue.length)<br>                    grow();<br>                size = i + <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) &#123;<br>                    queue[<span class="hljs-number">0</span>] = e;<br>                    setIndex(e, <span class="hljs-number">0</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    siftUp(i, e);<br>                &#125;<br>                <span class="hljs-keyword">if</span> (queue[<span class="hljs-number">0</span>] == e) &#123;<br>                    leader = <span class="hljs-literal">null</span>;<br>                    available.signal();<br>                &#125;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Runnable e)</span> &#123;<br>            offer(e);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Runnable e)</span> &#123;<br>            <span class="hljs-keyword">return</span> offer(e);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">offer</span><span class="hljs-params">(Runnable e, <span class="hljs-type">long</span> timeout, TimeUnit unit)</span> &#123;<br>            <span class="hljs-keyword">return</span> offer(e);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Performs common bookkeeping for poll and take: Replaces</span><br><span class="hljs-comment">         * first element with last and sifts it down.  Call only when</span><br><span class="hljs-comment">         * holding lock.</span><br><span class="hljs-comment">         * ä¸ºè½®è¯¢å’Œå–å€¼æ‰§è¡Œæ™®é€šç°¿è®°ï¼š å°†ç¬¬ä¸€ä¸ªå…ƒç´ æ›¿æ¢ä¸ºæœ€åä¸€ä¸ªå…ƒç´ å¹¶å‘ä¸‹ç­›é€‰ã€‚ä»…åœ¨æŒæœ‰é”æ—¶è°ƒç”¨ã€‚</span><br><span class="hljs-comment">         * <span class="hljs-doctag">@param</span> f the task to remove and return</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> RunnableScheduledFuture&lt;?&gt; finishPoll(RunnableScheduledFuture&lt;?&gt; f) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> --size;<br>            RunnableScheduledFuture&lt;?&gt; x = queue[s];<br>            queue[s] = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>                siftDown(<span class="hljs-number">0</span>, x);<br>            setIndex(f, -<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">return</span> f;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> RunnableScheduledFuture&lt;?&gt; poll() &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                RunnableScheduledFuture&lt;?&gt; first = queue[<span class="hljs-number">0</span>];<br>                <span class="hljs-keyword">return</span> (first == <span class="hljs-literal">null</span> || first.getDelay(NANOSECONDS) &gt; <span class="hljs-number">0</span>)<br>                        ? <span class="hljs-literal">null</span><br>                        : finishPoll(first);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> RunnableScheduledFuture&lt;?&gt; take() <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lockInterruptibly();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">for</span> (;;) &#123;<br>                    RunnableScheduledFuture&lt;?&gt; first = queue[<span class="hljs-number">0</span>];<br>                    <span class="hljs-keyword">if</span> (first == <span class="hljs-literal">null</span>)<br>                        available.await();<br>                    <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-type">long</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> first.getDelay(NANOSECONDS);<br>                        <span class="hljs-keyword">if</span> (delay &lt;= <span class="hljs-number">0L</span>)<br>                            <span class="hljs-keyword">return</span> finishPoll(first);<br>                        first = <span class="hljs-literal">null</span>; <span class="hljs-comment">// don&#x27;t retain ref while waiting</span><br>                        <span class="hljs-keyword">if</span> (leader != <span class="hljs-literal">null</span>)<br>                            available.await();<br>                        <span class="hljs-keyword">else</span> &#123;<br>                            <span class="hljs-type">Thread</span> <span class="hljs-variable">thisThread</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>                            leader = thisThread;<br>                            <span class="hljs-keyword">try</span> &#123;<br>                                available.awaitNanos(delay);<br>                            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                                <span class="hljs-keyword">if</span> (leader == thisThread)<br>                                    leader = <span class="hljs-literal">null</span>;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (leader == <span class="hljs-literal">null</span> &amp;&amp; queue[<span class="hljs-number">0</span>] != <span class="hljs-literal">null</span>)<br>                    available.signal();<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> RunnableScheduledFuture&lt;?&gt; poll(<span class="hljs-type">long</span> timeout, TimeUnit unit)<br>                <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">nanos</span> <span class="hljs-operator">=</span> unit.toNanos(timeout);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lockInterruptibly();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">for</span> (;;) &#123;<br>                    RunnableScheduledFuture&lt;?&gt; first = queue[<span class="hljs-number">0</span>];<br>                    <span class="hljs-keyword">if</span> (first == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">if</span> (nanos &lt;= <span class="hljs-number">0L</span>)<br>                            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                        <span class="hljs-keyword">else</span><br>                            nanos = available.awaitNanos(nanos);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-type">long</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> first.getDelay(NANOSECONDS);<br>                        <span class="hljs-keyword">if</span> (delay &lt;= <span class="hljs-number">0L</span>)<br>                            <span class="hljs-keyword">return</span> finishPoll(first);<br>                        <span class="hljs-keyword">if</span> (nanos &lt;= <span class="hljs-number">0L</span>)<br>                            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                        first = <span class="hljs-literal">null</span>; <span class="hljs-comment">// don&#x27;t retain ref while waiting</span><br>                        <span class="hljs-keyword">if</span> (nanos &lt; delay || leader != <span class="hljs-literal">null</span>)<br>                            nanos = available.awaitNanos(nanos);<br>                        <span class="hljs-keyword">else</span> &#123;<br>                            <span class="hljs-type">Thread</span> <span class="hljs-variable">thisThread</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>                            leader = thisThread;<br>                            <span class="hljs-keyword">try</span> &#123;<br>                                <span class="hljs-type">long</span> <span class="hljs-variable">timeLeft</span> <span class="hljs-operator">=</span> available.awaitNanos(delay);<br>                                nanos -= delay - timeLeft;<br>                            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                                <span class="hljs-keyword">if</span> (leader == thisThread)<br>                                    leader = <span class="hljs-literal">null</span>;<br>                            &#125;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-keyword">if</span> (leader == <span class="hljs-literal">null</span> &amp;&amp; queue[<span class="hljs-number">0</span>] != <span class="hljs-literal">null</span>)<br>                    available.signal();<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++) &#123;<br>                    RunnableScheduledFuture&lt;?&gt; t = queue[i];<br>                    <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) &#123;<br>                        queue[i] = <span class="hljs-literal">null</span>;<br>                        setIndex(t, -<span class="hljs-number">1</span>);<br>                    &#125;<br>                &#125;<br>                size = <span class="hljs-number">0</span>;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">drainTo</span><span class="hljs-params">(Collection&lt;? <span class="hljs-built_in">super</span> Runnable&gt; c)</span> &#123;<br>            <span class="hljs-keyword">return</span> drainTo(c, Integer.MAX_VALUE);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">drainTo</span><span class="hljs-params">(Collection&lt;? <span class="hljs-built_in">super</span> Runnable&gt; c, <span class="hljs-type">int</span> maxElements)</span> &#123;<br>            Objects.requireNonNull(c);<br>            <span class="hljs-keyword">if</span> (c == <span class="hljs-built_in">this</span>)<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>            <span class="hljs-keyword">if</span> (maxElements &lt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">for</span> (RunnableScheduledFuture&lt;?&gt; first;<br>                     n &lt; maxElements<br>                             &amp;&amp; (first = queue[<span class="hljs-number">0</span>]) != <span class="hljs-literal">null</span><br>                             &amp;&amp; first.getDelay(NANOSECONDS) &lt;= <span class="hljs-number">0</span>;) &#123;<br>                    c.add(first);   <span class="hljs-comment">// In this order, in case add() throws.</span><br>                    finishPoll(first);<br>                    ++n;<br>                &#125;<br>                <span class="hljs-keyword">return</span> n;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> Object[] toArray() &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> Arrays.copyOf(queue, size, Object[].class);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        <span class="hljs-keyword">public</span> &lt;T&gt; T[] toArray(T[] a) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (a.length &lt; size)<br>                    <span class="hljs-keyword">return</span> (T[]) Arrays.copyOf(queue, size, a.getClass());<br>                System.arraycopy(queue, <span class="hljs-number">0</span>, a, <span class="hljs-number">0</span>, size);<br>                <span class="hljs-keyword">if</span> (a.length &gt; size)<br>                    a[size] = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">return</span> a;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> Iterator&lt;Runnable&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.lock;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Itr</span>(Arrays.copyOf(queue, size));<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Snapshot iterator that works off copy of underlying q array.</span><br><span class="hljs-comment">         * ä»åº•å±‚ q æ•°ç»„çš„å‰¯æœ¬å¼€å§‹å·¥ä½œçš„å¿«ç…§è¿­ä»£å™¨ã€‚</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Itr</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterator</span>&lt;Runnable&gt; &#123;<br>            <span class="hljs-keyword">final</span> RunnableScheduledFuture&lt;?&gt;[] array;<br>            <span class="hljs-type">int</span> cursor;        <span class="hljs-comment">// index of next element to return; initially 0</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">lastRet</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;  <span class="hljs-comment">// index of last element returned; -1 if no such</span><br><br>            Itr(RunnableScheduledFuture&lt;?&gt;[] array) &#123;<br>                <span class="hljs-built_in">this</span>.array = array;<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> cursor &lt; array.length;<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> Runnable <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">if</span> (cursor &gt;= array.length)<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoSuchElementException</span>();<br>                <span class="hljs-keyword">return</span> array[lastRet = cursor++];<br>            &#125;<br><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">if</span> (lastRet &lt; <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>();<br>                DelayedWorkQueue.<span class="hljs-built_in">this</span>.remove(array[lastRet]);<br>                lastRet = -<span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JUC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JEP-444:è™šæ‹Ÿçº¿ç¨‹</title>
    <link href="/2023/10/03/java-source-code/JEP-444-%E8%99%9A%E6%8B%9F%E7%BA%BF%E7%A8%8B/"/>
    <url>/2023/10/03/java-source-code/JEP-444-%E8%99%9A%E6%8B%9F%E7%BA%BF%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h3 id="JEP-444-è™šæ‹Ÿçº¿ç¨‹"><a href="#JEP-444-è™šæ‹Ÿçº¿ç¨‹" class="headerlink" title="JEP 444 è™šæ‹Ÿçº¿ç¨‹"></a><a href="https://openjdk.org/jeps/444">JEP 444 è™šæ‹Ÿçº¿ç¨‹</a></h3><table><thead><tr><th>Author</th><th>Ron Pressler &amp; Alan Bateman</th></tr></thead><tbody><tr><td>Owner</td><td>Alan Bateman</td></tr><tr><td>Type</td><td>Feature</td></tr><tr><td>Scope</td><td>SE</td></tr><tr><td>Status</td><td>Closedâ€‰&#x2F;â€‰Delivered</td></tr><tr><td>Release</td><td>21</td></tr><tr><td>Component</td><td>core-libs</td></tr><tr><td>Discussion</td><td>loom dash dev at openjdk dot org</td></tr><tr><td>Relates to</td><td><a href="https://openjdk.org/jeps/436">JEP 436: Virtual Threads (Second Preview)</a></td></tr><tr><td>Reviewed by</td><td>Alex Buckley</td></tr><tr><td>Endorsed by</td><td>Brian Goetz</td></tr><tr><td>Created</td><td>2023&#x2F;03&#x2F;06 18:00</td></tr><tr><td>Updated</td><td>2023&#x2F;09&#x2F;22 16:54</td></tr><tr><td>Issue</td><td><a href="https://bugs.openjdk.org/browse/JDK-8303683">8303683</a></td></tr></tbody></table><h4 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h4><p>â€‹ å°†è™šæ‹Ÿçº¿ç¨‹å¼•å…¥Javaå¹³å°ã€‚è™šæ‹Ÿçº¿ç¨‹æ˜¯è½»é‡çº§çº¿ç¨‹ï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘ç¼–å†™ã€ç»´æŠ¤å’Œè§‚å¯Ÿé«˜ååé‡å¹¶å‘åº”ç”¨ç¨‹åºçš„å·¥ä½œé‡</p><h4 id="History"><a href="#History" class="headerlink" title="History"></a>History</h4><p>â€‹ è™šæ‹Ÿçº¿ç¨‹ç”±JEP 425æè®®ä½œä¸ºé¢„è§ˆç‰¹æ€§ï¼Œå¹¶é¦–å…ˆåœ¨JDK 19ä¸­æä¾›ã€‚ä¸ºäº†ç•™å‡ºæ—¶é—´è¿›è¡Œåé¦ˆå¹¶è·å¾—æ›´å¤šä½“éªŒï¼ŒJEP 436å†æ¬¡æè®®å°†è™šæ‹Ÿçº¿ç¨‹ä½œä¸ºé¢„è§ˆç‰¹æ€§ï¼ˆfeatureï¼‰å¹¶åœ¨JDK 20ä¸­æä¾›ã€‚æ ¹æ®å¼€å‘è€…åé¦ˆï¼Œæ­¤JEPå»ºè®®åœ¨JDK 21ä¸­å®Œæˆè™šæ‹Ÿçº¿ç¨‹ï¼Œå¹¶å¯¹JDK20è¿›è¡Œä»¥ä¸‹æ›´æ”¹ï¼š</p><ul><li>è™šæ‹Ÿçº¿ç¨‹ç°åœ¨å§‹ç»ˆæ”¯æŒçº¿ç¨‹å±€éƒ¨å˜é‡ã€‚ä¸é¢„è§ˆç‰ˆæœ¬ä¸­ä¸€æ ·ï¼Œä¸å†å…è®¸åˆ›å»ºä¸èƒ½æŒæœ‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„è™šæ‹Ÿçº¿ç¨‹ã€‚å¯¹çº¿ç¨‹å±€éƒ¨å˜é‡çš„æœ‰ä¿è¯çš„æ”¯æŒç¡®ä¿äº†æ›´å¤šç°æœ‰åº“å¯ä»¥åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­ä¸åŠ ä¿®æ”¹åœ°ä½¿ç”¨ï¼Œå¹¶æœ‰åŠ©äºå°†é¢å‘ä»£ç çš„ä»»åŠ¡è¿ç§»åˆ°ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹ã€‚</li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œç›´æ¥ä½¿ç”¨ Thread.Builder API åˆ›å»ºçš„è™šæ‹Ÿçº¿ç¨‹ï¼ˆè€Œä¸æ˜¯é€šè¿‡ Executors.newVirtualThreadPerTaskExecutor() åˆ›å»ºçš„è™šæ‹Ÿçº¿ç¨‹ï¼‰ç°åœ¨ä¹Ÿåœ¨å…¶æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­å—åˆ°ç›‘è§†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ <em>Observing virtual threads</em> ç« èŠ‚æè¿°çš„æ–°çš„çº¿ç¨‹å †æ ˆè§‚å¯Ÿ</li></ul><h4 id="Goals"><a href="#Goals" class="headerlink" title="Goals"></a>Goals</h4><ul><li>ä½¿å¾—ä»¥ç®€å•çš„ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹çš„é£æ ¼ç¼–å†™çš„æœåŠ¡åº”ç”¨ç¨‹åºèƒ½å¤Ÿä»¥æ¥è¿‘æœ€ä½³çš„ç¡¬ä»¶åˆ©ç”¨ç‡è¿›è¡Œæ‰©å±•</li><li>ä½¿å¾—ä½¿ç”¨java.lang.Thread APIçš„ç°æœ‰ä»£ç èƒ½å¤Ÿä»¥æœ€å°çš„æ”¹åŠ¨é€‚é…è™šæ‹Ÿçº¿ç¨‹</li><li>èƒ½å¤Ÿä½¿ç”¨ç°æœ‰çš„JDKå·¥å…·è¿›è¡Œè½»æ¾çš„è™šæ‹Ÿçº¿ç¨‹æ•…éšœæ’é™¤(troubleshooting)ã€è°ƒè¯•(debugging)å’Œåˆ†æ(profiling)</li></ul><h4 id="Non-Goals"><a href="#Non-Goals" class="headerlink" title="Non-Goals"></a>Non-Goals</h4><ul><li>ç§»é™¤ä¼ ç»Ÿçš„çº¿ç¨‹å®ç°æˆ–æ˜¯å°†ç°æœ‰åº”ç”¨ç¨‹åºé™é»˜åœ°è¿ç§»è‡³ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹å¹¶ä¸æ˜¯æˆ‘ä»¬çš„ç›®æ ‡</li><li>æ”¹å˜Javaçš„åŸºæœ¬å¹¶å‘æ¨¡å‹ä¹Ÿä¸æ˜¯ç›®æ ‡</li><li>åœ¨Javaè¯­è¨€æˆ–Javaåº“ä¸­æä¾›æ–°çš„æ•°æ®å¹¶è¡Œç»“æ„å¹¶ä¸æ˜¯æˆ‘ä»¬çš„ç›®æ ‡ã€‚Stream APIä»ç„¶æ˜¯å¹¶è¡Œå¤„ç†å¤§å‹æ•°æ®é›†çš„é¦–é€‰æ–¹å¼</li></ul><h4 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h4><p>â€‹ è¿‘ä¸‰åå¹´æ¥ï¼ŒJavaå¼€å‘äººå‘˜ä¸€ç›´ä¾èµ–çº¿ç¨‹ä½œä¸ºå¹¶å‘æœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„æ„å»ºå—ã€‚æ¯ä¸ªæ–¹æ³•çš„æ¯ä¸ªè¯­å¥éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹å†…æ‰§è¡Œï¼Œå¹¶ä¸”ç”±äºJavaæ˜¯å¤šçº¿ç¨‹çš„ï¼Œå› æ­¤å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡ŒåŒæ—¶å‘ç”Ÿã€‚çº¿ç¨‹æ˜¯Javaçš„å¹¶å‘å•å…ƒï¼šä¸€æ®µä¸å…¶å®ƒæ­¤ç±»å•å…ƒåŒæ—¶è¿è¡Œä¸”å¾ˆå¤§ç¨‹åº¦ä¸Šç‹¬ç«‹çš„é¡ºåºä»£ç ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½æä¾›ä¸€ä¸ªå †æ ˆæ¥å­˜å‚¨å±€éƒ¨å˜é‡å’Œåè°ƒæ–¹æ³•è°ƒç”¨ï¼Œä»¥åŠå‡ºç°é—®é¢˜æ—¶çš„ä¸Šä¸‹æ–‡ï¼šå¼‚å¸¸æ˜¯ç”±åŒä¸€çº¿ç¨‹ä¸­çš„æ–¹æ³•æŠ›å‡ºå’Œæ•è·çš„ï¼Œå› æ­¤å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨çº¿ç¨‹çš„å †æ ˆè·Ÿè¸ªæ¥æ‰¾å‡ºå‘ç”Ÿäº†ä»€ä¹ˆã€‚çº¿ç¨‹ä¹Ÿæ˜¯ä¸€äº›å·¥å…·çš„æ ¸å¿ƒæ¦‚å¿µï¼šè°ƒè¯•å™¨é€æ­¥æ‰§è¡Œçº¿ç¨‹æ–¹æ³•ä¸­çš„è¯­å¥ï¼›åˆ†æå™¨å¯è§†åŒ–å¤šä¸ªçº¿ç¨‹çš„è¡Œä¸ºä»¥å¸®åŠ©äº†è§£å…¶æ€§èƒ½ã€‚</p><h4 id="The-thread-per-request-style"><a href="#The-thread-per-request-style" class="headerlink" title="The thread-per-request style"></a>The thread-per-request style</h4><p>â€‹ æœåŠ¡å™¨åº”ç”¨ç¨‹åºé€šå¸¸å¤„ç†å½¼æ­¤ç‹¬ç«‹çš„å¹¶å‘ç”¨æˆ·è¯·æ±‚ï¼Œå› æ­¤åº”ç”¨ç¨‹åºé€šè¿‡ ä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹åœ¨æ­¤è¯·æ±‚çš„æŒç»­æ—¶é—´å†…ä¸“ç”¨äºæ­¤è¯·æ±‚ æ¥å¤„ç†è¯·æ±‚æ˜¯æœ‰æ„ä¹‰çš„ã€‚è¿™ç§ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹çš„é£æ ¼æ˜“äºç†è§£ã€æ˜“äºç¼–ç¨‹ã€æ˜“äºè°ƒè¯•å’Œåˆ†æï¼Œå› ä¸ºå®ƒä½¿ç”¨å¹³å°çš„å¹¶å‘å•å…ƒæ¥è¡¨ç¤ºåº”ç”¨ç¨‹åºçš„å¹¶å‘å•å…ƒã€‚</p><p>â€‹ æœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„å¯æ‰©å±•æ€§æ”¶åˆ°åˆ©ç‰¹å°”å®šå¾‹ï¼ˆLittleâ€˜s Lawï¼‰çš„çº¦æŸï¼Œè¯¥å®šå¾‹ä¸å»¶è¿Ÿã€å¹¶å‘æ€§ã€ååé‡ç›¸å…³ï¼šå¯¹äºç»™å®šçš„è¯·æ±‚å¤„ç†æŒç»­æ—¶é—´ï¼ˆå³å»¶è¿Ÿï¼‰ï¼Œåº”ç”¨ç¨‹åºåŒæ—¶å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼ˆå³å¹¶å‘æ€§ï¼‰å¿…é¡»ä¸åˆ°è¾¾ç‡ï¼ˆå³ååé‡ï¼‰æˆæ¯”ä¾‹å¢é•¿ã€‚å‡å¦‚ï¼Œå‡è®¾å¹³å‡å»¶è¿Ÿä¸º50msçš„åº”ç”¨ç¨‹åºé€šè¿‡åŒæ—¶å¤„ç†10ä¸ªè¯·æ±‚ï¼Œå®ç°äº†æ¯ç§’200ä¸ªè¯·æ±‚çš„ååé‡ã€‚ä¸ºäº†ä½¿è¯¥åº”ç”¨ç¨‹åºæ‰©å±•åˆ°æ¯ç§’2000ä¸ªè¯·æ±‚çš„ååé‡ï¼Œéœ€è¦åŒæ—¶å¤„ç†100ä¸ªè¯·æ±‚ã€‚å¦‚æœæ¯ä¸ªè¯·æ±‚åœ¨è¯·æ±‚æŒç»­æ—¶é—´å†…éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¤„ç†ï¼Œé‚£ä¹ˆä¸ºäº†è®©åº”ç”¨ç¨‹åºè·Ÿä¸Šï¼Œçº¿ç¨‹æ•°é‡å¿…é¡»éšç€ååé‡çš„å¢é•¿è€Œå¢é•¿ã€‚</p><p>â€‹ ä¸å¹¸çš„æ˜¯ï¼Œå¯ç”¨çº¿ç¨‹çš„æ•°é‡æ˜¯æœ‰é™çš„ï¼Œå› ä¸ºJDKé€šè¿‡åŒ…è£…æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰çº¿ç¨‹æ¥å®ç°çº¿ç¨‹ã€‚æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„æˆæœ¬å¾ˆé«˜ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½æ‹¥æœ‰å¤ªå¤šçº¿ç¨‹ï¼Œè¿™ä½¿å¾—JDKçš„çº¿ç¨‹å®ç°ä¸é€‚åˆä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹çš„é£æ ¼ã€‚å¦‚æœæ¯ä¸ªè¯·æ±‚åœ¨å…¶æŒç»­æ—¶é—´å†…å ç”¨ï¼ˆåŸæ–‡ç”¨çš„æ˜¯consumeï¼Œæˆ‘è§‰å¾—ç¿»è¯‘æˆå ç”¨æ›´åˆé€‚ï¼‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä»è€Œå ç”¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œé‚£ä¹ˆåœ¨å…¶å®ƒèµ„æºï¼ˆä¾‹å¦‚CPUæˆ–ç½‘ç»œè¿æ¥ï¼‰è€—å°½ä¹‹å‰ï¼Œçº¿ç¨‹æ•°é‡é€šå¸¸ä¼šæˆä¸ºé™åˆ¶å› ç´ ã€‚JDKå½“å‰çš„çº¿ç¨‹å®ç°å°†åº”ç”¨ç¨‹åºçš„ååé‡é™åˆ¶åœ¨è¿œä½äºç¡¬ä»¶å¯æ”¯æŒçš„æ°´å¹³ã€‚å³ä½¿çº¿ç¨‹è¢«æ± åŒ–ï¼Œä¹Ÿä¼šå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå› ä¸ºæ± åŒ–æœ‰åŠ©äºé¿å…å¯åŠ¨æ–°çº¿ç¨‹çš„é«˜æˆæœ¬ï¼Œä½†ä¸ä¼šå¢åŠ çº¿ç¨‹æ€»æ•°ã€‚</p><h4 id="Improving-scalability-with-the-asynchronous-style"><a href="#Improving-scalability-with-the-asynchronous-style" class="headerlink" title="Improving scalability with the asynchronous style"></a>Improving scalability with the asynchronous style</h4><p>â€‹ ä¸€äº›å¸Œæœ›å……åˆ†åˆ©ç”¨ç¡¬ä»¶çš„å¼€å‘äººå‘˜å·²ç»æ”¾å¼ƒäº†ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹çš„é£æ ¼ï¼Œè½¬è€Œé‡‡ç”¨çº¿ç¨‹å…±äº«é£æ ¼ã€‚è¯·æ±‚å¤„ç†ä»£ç ä¸æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šä»å¤´åˆ°å°¾å¤„ç†è¯·æ±‚ï¼Œè€Œæ˜¯åœ¨ç­‰å¾…å¦ä¸€I&#x2F;Oæ“ä½œå®Œæˆæ—¶å°†å…¶çº¿ç¨‹è¿”å›åˆ°æ± ä¸­ï¼Œä»¥ä¾¿è¯¥çº¿ç¨‹å¯ä»¥ä¸ºå…¶å®ƒè¯·æ±‚æä¾›æœåŠ¡ã€‚è¿™ç§ç»†ç²’åº¦çš„çº¿ç¨‹å…±äº«â€“åœ¨è¿™ç§å…±äº«ä¸­çº¿ç¨‹ä»…åœ¨æ‰§è¡Œè®¡ç®—æ—¶è€Œä¸æ˜¯åœ¨ç­‰å¾…I&#x2F;Oæ—¶æŒæœ‰çº¿ç¨‹â€“å…è®¸å¤§é‡çš„å¹¶å‘æ“ä½œè€Œæ— éœ€å ç”¨å¤§é‡çº¿ç¨‹ã€‚è™½ç„¶å®ƒæ¶ˆé™¤äº†æ“ä½œç³»ç»Ÿçº¿ç¨‹ç¨€ç¼ºå¯¹ååé‡çš„é™åˆ¶ï¼Œä½†å®ƒçš„ä»£ä»·å¾ˆé«˜ï¼šå®ƒéœ€è¦æ‰€è°“çš„å¼‚æ­¥ç¼–ç¨‹é£æ ¼ï¼Œé‡‡ç”¨ä¸€ç»„å•ç‹¬çš„I&#x2F;Oæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ç­‰å¾…I&#x2F;Oæ“ä½œå®Œæˆï¼Œè€Œæ˜¯ç¨åå‘å›è°ƒå‘å‡ºå…¶å®Œæˆä¿¡å·ã€‚å¦‚æœæ²¡æœ‰ä¸“ç”¨çº¿ç¨‹ï¼Œå¼€å‘äººå‘˜å¿…é¡»å°†ä»–ä»¬çš„è¯·æ±‚å¤„ç†é€»è¾‘åˆ†è§£ä¸ºä¸€äº›å°æ­¥éª¤ï¼Œé€šå¸¸ç¼–å†™ä¸ºlambdaè¡¨è¾¾å¼ï¼Œç„¶åä½¿ç”¨APIå°†å¥¹ä»¬ç»„åˆæˆé¡ºåºç®¡é“ï¼ˆä¾‹å¦‚ï¼Œå¯ä»¥å‚è€ƒCompletableFutureæˆ–æ‰€è°“çš„â€œååº”å¼â€æ¡†æ¶ï¼‰ã€‚å› æ­¤ï¼Œå®ƒä»¬æ”¾å¼ƒäº†è¯­è¨€çš„åŸºæœ¬é¡ºåºç»„åˆè¿ç®—ç¬¦ï¼Œä¾‹å¦‚å¾ªç¯å’Œtry&#x2F;catchå—ã€‚</p><p>â€‹ åœ¨å¼‚æ­¥é£æ ¼ä¸­ï¼Œè¯·æ±‚çš„æ¯ä¸ªé˜¶æ®µå¯èƒ½åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸ªçº¿ç¨‹ä»¥äº¤é”™çš„æ–¹å¼è¿è¡Œå±äºä¸åŒè¯·æ±‚çš„é˜¶æ®µã€‚è¿™å¯¹äºç†è§£ç¨‹åºè¡Œä¸ºå…·æœ‰æ·±è¿œçš„å½±å“ï¼šå †æ ˆè·Ÿè¸ªä¸æä¾›å¯ç”¨çš„ä¸Šä¸‹æ–‡ï¼Œè°ƒè¯•å™¨æ— æ³•å•æ­¥æ‰§è¡Œè¯·æ±‚å¤„ç†é€»è¾‘ï¼Œåˆ†æå™¨æ— æ³•å°†æ“ä½œçš„æˆæœ¬ä¸å…¶è°ƒç”¨è€…å…³è”èµ·æ¥ã€‚å½“ä½¿ç”¨Javaçš„æµAPIå¤„ç†çŸ­ç®¡é“ä¸­çš„æ•°æ®æ—¶ï¼Œç¼–å†™lambdaè¡¨è¾¾å¼æ˜¯å¯ä»¥ç®¡ç†çš„ï¼Œä½†å½“åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰è¯·æ±‚å¤„ç†ä»£ç å¿…é¡»ä»¥è¿™ç§æ–¹å¼ç¼–å†™æ—¶ï¼Œå°±ä¼šå‡ºç°é—®é¢˜ã€‚è¿™ç§ç¼–ç¨‹é£æ ¼ä¸Javaå¹³å°ä¸ä¸€è‡´ï¼Œå› ä¸ºåº”ç”¨ç¨‹åºçš„å¹¶å‘å•ä½ï¼ˆå¼‚æ­¥ç®¡é“ï¼‰ä¸å†æ˜¯å¹³å°çš„å¹¶å‘å•ä½ã€‚</p><h4 id="Preserving-the-thread-per-request-style-with-virtual-threads"><a href="#Preserving-the-thread-per-request-style-with-virtual-threads" class="headerlink" title="Preserving the thread-per-request style with virtual threads"></a>Preserving the thread-per-request style with virtual threads</h4><p>â€‹ ä¸ºäº†ä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿæ‰©å±•ï¼ŒåŒæ—¶ä¸å¹³å°ä¿æŒå’Œè°ï¼Œæˆ‘ä»¬åº”è¯¥åŠªåŠ›ä¿ç•™ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹çš„é£æ ¼ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ›´æœ‰æ•ˆåœ°å®ç°çº¿ç¨‹æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œè¿™æ ·å®ƒä»¬å°±å¯ä»¥æ›´åŠ ä¸°å¯Œã€‚æ“ä½œç³»ç»Ÿæ— æ³•æ›´æœ‰æ•ˆåœ°å®ç°æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œå› ä¸ºä¸åŒçš„è¯­è¨€å’Œè¿è¡Œæ—¶ä»¥ä¸åŒçš„æ–¹å¼ä½¿ç”¨çº¿ç¨‹å †æ ˆã€‚ç„¶è€Œï¼ŒJavaè¿è¡Œæ—¶å¯ä»¥é€šè¿‡åˆ‡æ–­Javaçº¿ç¨‹ä¸æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„ä¸€å¯¹ä¸€å¯¹åº”å…³ç³»çš„æ–¹å¼æ¥å®ç°Javaçº¿ç¨‹ã€‚æ­£å¦‚æ“ä½œç³»ç»Ÿé€šè¿‡å°†å¤§çš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜ å°„åˆ°æœ‰é™çš„ç‰©ç†RAMæ¥æä¾›å……è¶³å†…å­˜çš„å‡è±¡ä¸€æ ·ï¼ŒJavaè¿è¡Œæ—¶ä¹Ÿå¯ä»¥é€šè¿‡å°†å¤§é‡çš„è™šæ‹Ÿçº¿ç¨‹æ˜ å°„åˆ°å°‘é‡æ“ä½œç³»ç»Ÿçº¿ç¨‹æ¥æä¾›å……è¶³çº¿ç¨‹çš„å‡è±¡ã€‚</p><p>â€‹ è™šæ‹Ÿçº¿ç¨‹æ˜¯java.lang.Threadçš„ä¸€ä¸ªå®ä¾‹ï¼Œå®ƒä¸ä¾èµ–äºç‰¹å®šçš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¹³å°çº¿ç¨‹æ˜¯ä»¥ä¼ ç»Ÿæ–¹å¼å®ç°çš„java.lang.Threadå®ä¾‹ï¼Œä½œä¸ºæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„è–„åŒ…è£…å™¨ã€‚</p><p>â€‹ ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹é£æ ¼çš„åº”ç”¨ç¨‹åºä»£ç å¯ä»¥åœ¨è¯·æ±‚çš„æ•´ä¸ªæŒç»­æ—¶é—´å†…åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­è¿è¡Œï¼Œä½†è™šæ‹Ÿçº¿ç¨‹ä»…åœ¨CPUä¸Šæ‰§è¡Œè®¡ç®—æ—¶æ‰ä¼šå ç”¨æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚è¿™æ ·çš„ç»“æœæ˜¯ä¸å¼‚æ­¥é£æ ¼ç›¸åŒçš„å¯æ‰©å±•æ€§ï¼Œåªä¸è¿‡å®ƒæ˜¯é€æ˜å®ç°çš„ï¼šå½“è™šæ‹Ÿçº¿ç¨‹ä¸­è¿è¡Œçš„ä»£ç è°ƒç”¨java.*APIä¸­çš„é˜»å¡I&#x2F;Oæ“ä½œæ—¶ï¼Œè¿è¡Œæ—¶ä¼šæ‰§è¡Œéé˜»å¡æ“ä½œç³»ç»Ÿè°ƒç”¨å¹¶è‡ªåŠ¨æŒ‚èµ·è™šæ‹Ÿçº¿ç¨‹ï¼ŒçŸ¥é“ç¨åI&#x2F;Oæ“ä½œæ‰§è¡Œå®Œåè™šæ‹Ÿçº¿ç¨‹å¯ä»¥æ¢å¤ã€‚å¯¹äºJavaå¼€å‘äººå‘˜æ¥è¯´ï¼Œè™šæ‹Ÿçº¿ç¨‹åªæ˜¯åˆ›å»ºæˆæœ¬ä½å»‰ä¸”æ•°é‡å‡ ä¹æ— é™çš„çº¿ç¨‹ã€‚ç¡¬ä»¶åˆ©ç”¨ç‡æ¥è¿‘æœ€ä½³ï¼Œå…è®¸é«˜æ°´å¹³çš„å¹¶å‘æ€§ï¼Œä»è€Œå®ç°é«˜ååé‡ï¼ŒåŒæ—¶åº”ç”¨ç¨‹åºä¸Javaå¹³å°åŠå…¶å·¥å…·çš„å¤šçº¿ç¨‹è®¾è®¡ä¿æŒåè°ƒã€‚</p><h4 id="Implications-of-virtual-threads"><a href="#Implications-of-virtual-threads" class="headerlink" title="Implications of virtual threads"></a>Implications of virtual threads</h4><p>â€‹ è™šæ‹Ÿçº¿ç¨‹æˆæœ¬ä½å»‰ä¸”å……è¶³ï¼Œå› æ­¤æ°¸è¿œä¸åº”è¯¥è¢«æ± åŒ–ï¼šåº”è¯¥ä¸ºæ¯ä¸ªåº”ç”¨ç¨‹åºä»»åŠ¡åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿçº¿ç¨‹ã€‚å› æ­¤ï¼Œå¤§å¤šæ•°è™šæ‹Ÿçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸéƒ½å¾ˆçŸ­ï¼Œå¹¶ä¸”å…·æœ‰è¾ƒæµ…çš„è°ƒç”¨å †æ ˆï¼Œåªæ‰§è¡Œå•ä¸ªHTTPå®¢æˆ·ç«¯è°ƒç”¨æˆ–å•ä¸ªJDBCæŸ¥è¯¢ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¹³å°çº¿ç¨‹é‡ä¸”æ˜‚è´µï¼Œå› æ­¤é€šå¸¸å¿…é¡»è¿›è¡Œæ± åŒ–ã€‚å®ƒä»¬å¾€å¾€å¯¿å‘½å¾ˆé•¿ï¼Œå…·æœ‰å¾ˆæ·±çš„è°ƒç”¨å †æ ˆï¼Œå¹¶ä¸”åœ¨è®¸å¤šä»»åŠ¡ä¹‹é—´å…±äº«ã€‚</p><p>â€‹ æ€»è€Œè¨€ä¹‹ï¼Œè™šæ‹Ÿçº¿ç¨‹ä¿ç•™äº†å¯é çš„ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹çš„é£æ ¼ï¼Œè¯¥é£æ ¼ä¸Javaå¹³å°çš„è®¾è®¡ç›¸åè°ƒï¼ŒåŒæ—¶æœ€ä½³åœ°åˆ©ç”¨äº†å¯ç”¨çš„ç¡¬ä»¶ã€‚ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹ä¸éœ€è¦å­¦ä¹ æ–°æ¦‚å¿µï¼Œå°½ç®¡å®ƒå¯èƒ½éœ€è¦æ”¾å¼ƒä¸ºåº”å¯¹å½“ä»Šçº¿ç¨‹çš„é«˜æˆæœ¬è€Œå…»æˆçš„ä¹ æƒ¯ã€‚è™šæ‹Ÿçº¿ç¨‹ä¸ä»…å¯ä»¥å¸®åŠ©åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ï¼Œè¿˜å¯ä»¥å¸®åŠ©æ¡†æ¶è®¾è®¡äººå‘˜æä¾›æ˜“äºä½¿ç”¨ã€ä¸å½±å“æ‰©å±•æ€§çš„APIï¼Œå¹¶ä¸”è¿™äº›APIä¸å¹³å°çš„è®¾è®¡å…¼å®¹ã€‚</p><h4 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h4><p>â€‹ å¦‚ä»Šï¼ŒJDKä¸­java.lang.Threadçš„æ¯ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªå¹³å°çº¿ç¨‹ã€‚å¹³å°çº¿ç¨‹åœ¨åº•å±‚æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šè¿è¡ŒJavaä»£ç ï¼Œå¹¶åœ¨ä»£ç çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å æœ‰æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚å¹³å°çº¿ç¨‹æ•°å—é™äºæ“ä½œç³»ç»Ÿçº¿ç¨‹æ•°ã€‚</p><p>â€‹ è™šæ‹Ÿçº¿ç¨‹æ˜¯java.lang.Threadçš„ä¸€ä¸ªå®ä¾‹ï¼Œå®ƒåœ¨åº•å±‚æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šè¿è¡ŒJavaä»£ç ï¼Œä½†ä¸ä¼šåœ¨ä»£ç çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å æœ‰æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚è¿™æ„å‘³ç€è®¸å¤šè™šæ‹Ÿçº¿ç¨‹å¯ä»¥åœ¨åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šè¿è¡Œå®ƒä»¬çš„Javaä»£ç ï¼Œä»è€Œæœ‰æ•ˆåœ°å…±äº«æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚å¹³å°çº¿ç¨‹ç‹¬å å®è´µçš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œä½†è™šæ‹Ÿçº¿ç¨‹ä¸ç„¶ã€‚è™šæ‹Ÿçº¿ç¨‹çš„æ•°é‡å¯ä»¥æ¯”æ“ä½œç³»ç»Ÿçº¿ç¨‹å¤§å¾—å¤šã€‚</p><p>â€‹ è™šæ‹Ÿçº¿ç¨‹æ˜¯JDKè€Œä¸æ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„è½»é‡çº§çº¿ç¨‹å®ç°ã€‚å®ƒä»¬æ˜¯ç”¨æˆ·æ¨¡å¼çº¿ç¨‹çš„ä¸€ç§å½¢å¼ï¼Œåœ¨å…¶å®ƒå¤šçº¿ç¨‹è¯­è¨€ä¸­å·²ç»å–å¾—äº†æˆåŠŸï¼ˆä¾‹å¦‚ï¼ŒGoä¸­çš„goroutineå’ŒErlangä¸­çš„è¿›ç¨‹ï¼‰ã€‚å½“æ“ä½œç³»ç»Ÿçº¿ç¨‹å°šæœªæˆç†Ÿå’Œæ™®åŠæ—¶ï¼Œç”¨æˆ·æ¨¡å¼çº¿ç¨‹ç”šè‡³åœ¨Javaçš„æ—©æœŸç‰ˆæœ¬ä¸­è¢«ç§°ä¸ºæ‰€è°“çš„[â€œç»¿è‰²çº¿ç¨‹â€](<a href="https://en.wikipedia.org/wiki/Green_thread">Green thread - Wikipedia</a>)ã€‚ç„¶è€Œï¼ŒJavaçš„ç»¿è‰²çº¿ç¨‹éƒ½å…±äº«ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼ˆM:1è°ƒåº¦ï¼‰ï¼Œå¹¶ä¸”æœ€ç»ˆè¢«ä½œä¸ºæ“ä½œç³»ç»Ÿçº¿ç¨‹åŒ…è£…å™¨å®ç°çš„å¹³å°çº¿ç¨‹æ‰€è¶…è¶Šï¼ˆ1:1è°ƒåº¦ï¼‰ã€‚è™šæ‹Ÿçº¿ç¨‹é‡‡ç”¨M:Nè°ƒåº¦ï¼Œå…¶ä¸­å¤§é‡ï¼ˆMï¼‰è™šæ‹Ÿçº¿ç¨‹è¢«è°ƒåº¦åœ¨è¾ƒå°‘æ•°é‡ï¼ˆNï¼‰çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šè¿è¡Œã€‚</p><h4 id="Using-virtual-threads-vs-platform-threads"><a href="#Using-virtual-threads-vs-platform-threads" class="headerlink" title="Using virtual threads vs. platform threads"></a>Using virtual threads vs. platform threads</h4><p>â€‹ å¼€å‘è€…å¯ä»¥é€‰æ‹©ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹è¿˜æ˜¯å¹³å°çº¿ç¨‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ›å»ºå¤§é‡è™šæ‹Ÿçº¿ç¨‹çš„ç¤ºä¾‹ç¨‹åºã€‚ç¨‹åºé¦–å…ˆè·å–ä¸€ä¸ªExecutorServiceï¼Œå®ƒå°†ä¸ºæ¯ä¸ªæäº¤çš„ä»»åŠ¡åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿçº¿ç¨‹ã€‚ç„¶åå®ƒæäº¤10000ä¸ªä»»åŠ¡å¹¶ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) &#123;<br>    IntStream.range(<span class="hljs-number">0</span>, <span class="hljs-number">10_000</span>).forEach(i -&gt; &#123;<br>        executor.submit(() -&gt; &#123;<br>            Thread.sleep(Duration.ofSeconds(<span class="hljs-number">1</span>));<br>            <span class="hljs-keyword">return</span> i;<br>        &#125;);<br>    &#125;);<br>&#125;  <span class="hljs-comment">// executor.close() is called implicitly, and waits</span><br></code></pre></td></tr></table></figure><p>æ­¤ç¤ºä¾‹ä¸­çš„ä»»åŠ¡æ˜¯ç®€å•çš„ä»£ç ï¼ˆä¼‘çœ ä¸€ç§’é’Ÿï¼‰ï¼Œç°ä»£ç¡¬ä»¶å¯ä»¥è½»æ¾æ”¯æŒ10000ä¸ªè™šæ‹Ÿçº¿ç¨‹åŒæ—¶è¿è¡Œæ­¤ç±»ä»£ç ã€‚åœ¨åå°ï¼ŒJDKåœ¨å°‘é‡æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼ˆå¯èƒ½åªæœ‰ä¸€ä¸ªï¼‰ä¸Šè¿è¡Œä»£ç ã€‚</p><p>â€‹ å¦‚æœè¯¥ç¨‹åºä½¿ç”¨ExecutorServiceä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªæ–°çš„å¹³å°çº¿ç¨‹ï¼Œä¾‹å¦‚Executors.newCachedThreadPool(),æƒ…å†µå°†ä¼šéå¸¸ä¸åŒã€‚ExecutorServiceå°†å°è¯•åˆ›å»º10000ä¸ªå¹³å°çº¿ç¨‹ï¼Œä»è€Œåˆ›å»º10000ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œå¹¶ä¸”ç¨‹åºå¯èƒ½ä¼šå´©æºƒï¼Œè¿™å…·ä½“å–å†³äºè®¡ç®—æœºå’Œæ“ä½œç³»ç»Ÿã€‚</p><p>â€‹ å¦‚æœç¨‹åºä½¿ç”¨ä»æ± ä¸­è·å–å¹³å°çº¿ç¨‹çš„ExecutorServiceï¼Œä¾‹å¦‚Executors.newFixedThreadPool(200)ï¼Œæƒ…å†µä¹Ÿä¸ä¼šå¥½å¤šå°‘ã€‚ExecutorServiceå°†åˆ›å»º200ä¸ªå¹³å°çº¿ç¨‹ä¾›æ‰€æœ‰10000ä¸ªä»»åŠ¡å…±äº«ï¼Œå› æ­¤è®¸å¤šä»»åŠ¡å°†é¡ºåºè¿è¡Œè€Œä¸æ˜¯å¹¶å‘è¿è¡Œï¼Œå¹¶ä¸”ç¨‹åºå°†éœ€è¦å¾ˆé•¿æ—¶é—´æ‰èƒ½å®Œæˆã€‚å¯¹äºè¯¥ç¨‹åºï¼Œå…·æœ‰200ä¸ªå¹³å°çº¿ç¨‹çš„æ± åªèƒ½å®ç°æ¯ç§’200ä¸ªä»»åŠ¡çš„ååé‡ï¼Œè€Œè™šæ‹Ÿçº¿ç¨‹å¯å®ç°æ¯ç§’çº¦10000ä¸ªä»»åŠ¡çš„ååé‡ï¼ˆåœ¨å……åˆ†é¢„çƒ­åï¼‰ã€‚æ­¤å¤–ï¼Œå¦‚æœç¤ºä¾‹ç¨‹åºä¸­çš„10_000æ›´æ”¹ä¸º1_000_000ï¼Œåˆ™è¯¥ç¨‹åºå°†æäº¤1000000ä¸ªä»»åŠ¡ï¼Œåˆ›å»º1000000ä¸ªå¹¶å‘è¿è¡Œçš„è™šæ‹Ÿçº¿ç¨‹ï¼Œå¹¶ï¼ˆåœ¨å……åˆ†é¢„çƒ­åï¼‰ï¼Œå®ç°æ¯ç§’çº¦1000000ä¸ªä»»åŠ¡çš„ååé‡ã€‚</p><p>â€‹ å¦‚æœè¯¥ç¨‹åºä¸­çš„ä»»åŠ¡æ‰§è¡Œä¸€ç§’é’Ÿçš„è®¡ç®—ï¼ˆä¾‹å¦‚ï¼Œå¯¹ä¸€ä¸ªå·¨å¤§çš„æ•°ç»„è¿›è¡Œæ’åºï¼‰ï¼Œè€Œä¸æ˜¯ä»…ä»…ä¼‘çœ ï¼Œé‚£ä¹ˆå¢åŠ çº¿ç¨‹æ•°é‡è¶…å‡ºå¤„ç†å™¨æ ¸å¿ƒçš„æ•°é‡å°†æ— æµäºäº‹ï¼Œæ— è®ºå®ƒä»¬æ˜¯è™šæ‹Ÿçº¿ç¨‹è¿˜æ˜¯å¹³å°çº¿ç¨‹ã€‚è™šæ‹Ÿçº¿ç¨‹å¹¶ä¸æ˜¯æ›´å¿«çš„çº¿ç¨‹â€”-å®ƒä»¬è¿è¡Œä»£ç çš„é€Ÿåº¦å¹¶ä¸å¿…å¹³å°çº¿ç¨‹å¿«ã€‚<strong>å®ƒä»¬çš„å­˜åœ¨æ˜¯ä¸ºäº†æä¾›è§„æ¨¡ï¼ˆæ›´é«˜çš„ååé‡ï¼‰ï¼Œè€Œä¸æ˜¯é€Ÿåº¦ï¼ˆæ›´ä½çš„å»¶è¿Ÿï¼‰</strong>ã€‚å®ƒä»¬çš„æ•°é‡å¯ä»¥æ¯”å¹³å°çº¿ç¨‹å¤šå¾—å¤šï¼Œå› æ­¤æ ¹æ®åˆ©ç‰¹å°”å®šå¾‹ï¼Œå®ƒä»¬ä½¿å¾—æ›´é«˜ååé‡æ‰€éœ€çš„æ›´é«˜å¹¶å‘æ€§æˆä¸ºå¯èƒ½ã€‚</p><p>â€‹ æ¢å¥è¯è¯´ï¼Œå½“æ»¡è¶³ä¸‹é¢æƒ…å†µæ—¶ï¼Œè™šæ‹Ÿçº¿ç¨‹å¯ä»¥æ˜¾è‘—æé«˜åº”ç”¨ç¨‹åºçš„ååé‡</p><ul><li>å¹¶å‘ä»»åŠ¡æ•°è¾ƒé«˜ï¼ˆæ•°åƒä»¥ä¸Šï¼‰</li><li>å·¥ä½œè´Ÿè½½ä¸å—CPUé™åˆ¶ï¼Œå› ä¸ºåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ•°å¤šäºå¤„ç†å™¨æ ¸å¿ƒæ•°æ— æ³•æé«˜ååé‡</li></ul><p>â€‹ è™šæ‹Ÿçº¿ç¨‹æœ‰åŠ©äºæé«˜å…¸å‹æœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„ååé‡ï¼Œå› ä¸ºæ­¤ç±»åº”ç”¨ç¨‹åºç”±å¤§é‡å¹¶å‘ä»»åŠ¡ç»„æˆï¼Œè€Œè¿™äº›ä»»åŠ¡å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…ã€‚</p><p>â€‹ å¹³å°çº¿ç¨‹å¯ä»¥è¿è¡Œçš„ä»»ä½•ä»£ç ï¼Œè™šæ‹Ÿçº¿ç¨‹éƒ½å¯ä»¥è¿è¡Œã€‚ç‰¹åˆ«æ˜¯ï¼Œè™šæ‹Ÿçº¿ç¨‹æ”¯æŒçº¿ç¨‹å±€éƒ¨å˜é‡å’Œçº¿ç¨‹ä¸­æ–­ï¼Œå°±åƒå¹³å°çº¿ç¨‹ä¸€æ ·ã€‚è¿™æ„å‘³ç€å¤„ç†è¯·æ±‚çš„ç°æœ‰Javaä»£ç å¯ä»¥è½»æ¾åœ°åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­è¿è¡Œã€‚è®¸å¤šæœåŠ¡å™¨æ¡†æ¶ä¼šé€‰æ‹©è‡ªåŠ¨åœ°ä¸ºæ¯ä¸ªä¼ å…¥è¯·æ±‚å¯åŠ¨ä¸€ä¸ªæ–°çš„è™šæ‹Ÿçº¿ç¨‹å¹¶åœ¨å…¶ä¸­è¿è¡Œåº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘ã€‚</p><p>â€‹ ä¸‹é¢æ˜¯èšåˆå…¶å®ƒä¸¤ä¸ªæœåŠ¡çš„ç»“æœçš„æœåŠ¡å™¨åº”ç”¨ç¨‹åºçš„ç¤ºä¾‹ã€‚å‡è®¾æœ‰ä¸€ä¸ªæœåŠ¡å™¨æ¡†æ¶ï¼ˆæœªå‡ºç¤ºï¼‰ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿçº¿ç¨‹ï¼Œå¹¶åœ¨è¯¥è™šæ‹Ÿçº¿ç¨‹ä¸­è¿è¡Œåº”ç”¨ç¨‹åºçš„å¥æŸ„ä»£ç ã€‚åº”ç”¨ç¨‹åºä»£ç åè¿‡æ¥åˆ›å»ºä¸¤ä¸ªæ–°çš„è™šæ‹Ÿçº¿ç¨‹ï¼Œé€šè¿‡ä¸ç¬¬ä¸€ä¸ªç¤ºä¾‹ç›¸åŒçš„ExecutorServiceåŒæ—¶è·å–å¤šä¸ªèµ„æºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(Request request, Response response)</span> &#123;<br>    <span class="hljs-type">var</span> <span class="hljs-variable">url1</span> <span class="hljs-operator">=</span> ...<br>    <span class="hljs-type">var</span> <span class="hljs-variable">url2</span> <span class="hljs-operator">=</span> ...<br><br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) &#123;<br>        <span class="hljs-type">var</span> <span class="hljs-variable">future1</span> <span class="hljs-operator">=</span> executor.submit(() -&gt; fetchURL(url1));<br>        <span class="hljs-type">var</span> <span class="hljs-variable">future2</span> <span class="hljs-operator">=</span> executor.submit(() -&gt; fetchURL(url2));<br>        response.send(future1.get() + future2.get());<br>    &#125; <span class="hljs-keyword">catch</span> (ExecutionException | InterruptedException e) &#123;<br>        response.fail(e);<br>    &#125;<br>&#125;<br><br>String <span class="hljs-title function_">fetchURL</span><span class="hljs-params">(URL url)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> url.openStream()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(in.readAllBytes(), StandardCharsets.UTF_8);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åƒè¿™æ ·çš„æœåŠ¡å™¨åº”ç”¨ç¨‹åºå…·æœ‰ç®€å•çš„é˜»å¡ä»£ç ï¼Œå¯ä»¥å¾ˆå¥½åœ°æ‰©å±•ï¼Œå› ä¸ºå®ƒå¯ä»¥ä½¿ç”¨å¤§é‡çš„è™šæ‹Ÿçº¿ç¨‹ã€‚</p><p>â€‹ Executor.newVirtualThreadPerTaskExecutor()å¹¶ä¸æ˜¯åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹çš„å”¯ä¸€æ–¹æ³•ã€‚ä¸‹é¢è¦è®¨è®ºçš„æ–°java.lang.Thread.Builder APIå¯ä»¥åˆ›å»ºå’Œå¯åŠ¨è™šæ‹Ÿçº¿ç¨‹ã€‚æ­¤å¤–ï¼Œç»“æ„åŒ–å¹¶å‘æä¾›äº†æ›´å¼ºå¤§çš„APIæ¥åˆ›å»ºå’Œç®¡ç†è™šæ‹Ÿçº¿ç¨‹ï¼Œç‰¹åˆ«æ˜¯åœ¨ç±»ä¼¼äºè¿™ä¸ªæœåŠ¡å™¨ç¤ºä¾‹çš„ä»£ç ä¸­ï¼Œç”±æ­¤å¹³å°åŠå…¶å·¥å…·å¯ä»¥äº†è§£çº¿ç¨‹ä¹‹é—´çš„å…³ç³»ã€‚</p><h4 id="Do-not-pool-virtual-threads"><a href="#Do-not-pool-virtual-threads" class="headerlink" title="Do not pool virtual threads"></a>Do not pool virtual threads</h4><p>â€‹ å¼€å‘äººå‘˜é€šå¸¸ä¼šå°†åº”ç”¨ç¨‹åºä»£ç ä»åŸºäºä¼ ç»Ÿçº¿ç¨‹æ± çš„ExecutorServiceè¿ç§»åˆ°ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹çš„ExecutorServiceã€‚ä¸ä»»ä½•èµ„æºæ± ä¸€æ ·ï¼Œçº¿ç¨‹æ± æ—¨åœ¨å…±äº«æ˜‚è´µçš„èµ„æºï¼Œä½†è™šæ‹Ÿçº¿ç¨‹å¹¶ä¸æ˜‚è´µï¼Œå› æ­¤ä¸éœ€è¦å°†å®ƒä»¬æ± åŒ–ã€‚</p><p>â€‹ å¼€å‘äººå‘˜æœ‰æ—¶ä¼šä½¿ç”¨çº¿ç¨‹æ± æ¥é™åˆ¶å¯¹æœ‰é™èµ„æºçš„å¹¶å‘è®¿é—®ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæŸä¸ªæœåŠ¡æ— æ³•å¤„ç†è¶…è¿‡20ä¸ªå¹¶å‘è¯·æ±‚ï¼Œåˆ™é€šè¿‡æäº¤åˆ°å¤§å°ä¸º20çš„çº¿ç¨‹æ± çš„ä»»åŠ¡å‘è¯¥æœåŠ¡å‘é€è¯·æ±‚æ¥ç¡®ä¿å¯¹æœåŠ¡èµ„æºçš„é™åˆ¶è®¿é—®ã€‚è¿™ç§ä¹ æƒ¯ç”¨æ³•å·²ç»å˜å¾—æ— å¤„ä¸åœ¨ï¼Œå› ä¸ºå¹³å°çº¿ç¨‹çš„é«˜æˆæœ¬ä½¿å¾—çº¿ç¨‹æ± æ— å¤„ä¸åœ¨ï¼Œä½†ä¸è¦è¯•å›¾æ± åŒ–è™šæ‹Ÿçº¿ç¨‹ä»¥é™åˆ¶å¹¶å‘æ€§ã€‚ç›¸åï¼Œè¯·ä½¿ç”¨ä¸“é—¨ä¸ºæ­¤ç›®çš„è®¾è®¡çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚ä¿¡å·é‡ã€‚</p><p>â€‹ ç»“åˆçº¿ç¨‹æ± ï¼Œå¼€å‘äººå‘˜æœ‰æ—¶ä¾¯ä¼šä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡åœ¨å…±äº«åŒä¸€çº¿ç¨‹çš„å¤šä¸ªä»»åŠ¡ä¹‹é—´å…±äº«æ˜‚è´µçš„èµ„æºã€‚ä¾‹å¦‚ï¼Œå¦‚æœåˆ›å»ºæ•°æ®åº“è¿æ¥çš„æˆæœ¬å¾ˆé«˜ï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥æ‰“å¼€ä¸€æ¬¡æ•°æ®åº“è¿æ¥å¹¶å°†å…¶å­˜å‚¨åœ¨çº¿ç¨‹å±€éƒ¨å˜é‡ä¸­ï¼Œä»¥ä¾›åŒä¸€çº¿ç¨‹ä¸­çš„å…¶ä»–ä»»åŠ¡ç¨åä½¿ç”¨ã€‚å¦‚æœæ‚¨å°†ä»£ç ä»ä½¿ç”¨çº¿ç¨‹æ± è¿ç§»åˆ°ä½¿ç”¨ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œè¯·è°¨æ…ä½¿ç”¨æ­¤ä¹ æƒ¯ç”¨æ³•ï¼Œå› ä¸ºä¸ºæ¯ä¸ªè™šæ‹Ÿçº¿ç¨‹åˆ›å»ºæ˜‚è´µçš„èµ„æºå¯èƒ½ä¼šæ˜¾è‘—é™ä½æ€§èƒ½ã€‚æ›´æ”¹æ­¤ç±»ä»£ç è‡³ä½¿ç”¨å¯æ›¿ä»£çš„ç¼“å­˜ç­–ç•¥ï¼Œä»¥ä¾¿å¯ä»¥åœ¨å¤§é‡è™šæ‹Ÿçº¿ç¨‹ä¹‹é—´æœ‰æ•ˆå…±äº«æ˜‚è´µçš„èµ„æºã€‚</p><h4 id="Observing-virtual-threads"><a href="#Observing-virtual-threads" class="headerlink" title="Observing virtual threads"></a>Observing virtual threads</h4><p>â€‹ ç¼–å†™æ¸…æ™°çš„ä»£ç å¹¶ä¸æ˜¯æ•…äº‹çš„å…¨éƒ¨ã€‚æ¸…æ™°åœ°å‘ˆç°æ­£åœ¨è¿è¡Œåœ°ç¨‹åºåœ°çŠ¶æ€å¯¹äºæ•…éšœæ’æŸ¥ã€ç»´æŠ¤å’Œä¼˜åŒ–ä¹Ÿè‡³å…³é‡è¦ï¼Œå¹¶ä¸”JDKé•¿æœŸä»¥æ¥ä¸€ç›´æä¾›è°ƒè¯•ã€åˆ†æå’Œç›‘æ§çº¿ç¨‹çš„æœºåˆ¶ã€‚è¿™äº›å·¥å…·åº”è¯¥å¯¹è™šæ‹Ÿçº¿ç¨‹åŒæ ·æœ‰æ•ˆâ€“ä¹Ÿè®¸ä¼šæ ¹æ®å®ƒä»¬å¾ˆå¤§çš„æ•°é‡è¿›è¡Œä¸€äº›è°ƒæ•´â€“å› ä¸ºå®ƒä»¬æ¯•ç«Ÿæ˜¯Java.lang.Threadçš„å®ä¾‹ã€‚</p><p>Javaè°ƒè¯•å™¨å¯ä»¥å•æ­¥æ‰§è¡Œè™šæ‹Ÿçº¿ç¨‹ã€æ˜¾ç¤ºè°ƒç”¨å †æ ˆä»¥åŠæŸ¥çœ‹å †æ ˆå¸§ä¸­çš„å˜é‡ã€‚JDK Flight Recorderï¼ˆJFRï¼‰æ˜¯JDKçš„ä½å¼€é”€åˆ†æå’Œç›‘æ§å·¥å…·ï¼Œå¯ä»¥å°†åº”ç”¨ç¨‹åºä»£ç ä¸­çš„äº‹ä»¶ï¼ˆä¾‹å¦‚å¯¹è±¡åˆ†é…å’ŒI&#x2F;Oæ“ä½œï¼‰ä¸æ­£ç¡®çš„è™šæ‹Ÿçº¿ç¨‹å…³è”èµ·æ¥ã€‚è¿™äº›å·¥å…·æ— æ³•ä¸ºä»¥å¼‚æ­¥é£æ ¼ç¼–å†™çš„åº”ç”¨ç¨‹åºæ‰§è¡Œè¿™äº›æ“ä½œã€‚åœ¨å¼‚æ­¥é£æ ¼ä¸­ï¼Œä»»åŠ¡ä¸çº¿ç¨‹æ— å…³ï¼Œå› æ­¤è°ƒè¯•å™¨æ— æ³•æ˜¾ç¤ºæˆ–æ“ä½œä»»åŠ¡çš„çŠ¶æ€ï¼Œå¹¶ä¸”åˆ†æå™¨æ— æ³•åˆ¤æ–­ä»»åŠ¡èŠ±è´¹äº†å¤šå°‘æ—¶é—´ç­‰å¾…I&#x2F;Oã€‚</p><p>çº¿ç¨‹dumpæ˜¯å¦ä¸€ç§æµè¡Œçš„å·¥å…·ï¼Œç”¨äºå¯¹ä»¥ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹é£æ ¼ç¼–å†™çš„åº”ç”¨ç¨‹åºè¿›è¡Œæ•…éšœæ’é™¤ã€‚ä¸å¹¸çš„æ˜¯ï¼ŒJDKçš„ä¼ ç»Ÿçº¿ç¨‹è½¬å‚¨ï¼ˆä½¿ç”¨jstackæˆ–jcmdè·å¾—ï¼‰æä¾›äº†ä¸€ä¸ªç®€å•çš„çº¿ç¨‹åˆ—è¡¨ã€‚è¿™é€‚ç”¨äºæ•°åæˆ–æ•°ç™¾ä¸ªå¹³å°çº¿ç¨‹ï¼Œä½†ä¸é€‚åˆæ•°åƒæˆ–æ•°ç™¾ä¸‡è™šæ‹Ÿçº¿ç¨‹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸ä¼šæ‰©å±•ä¼ ç»Ÿçš„çº¿ç¨‹è½¬å‚¨ä»¥åŒ…å«è™šæ‹Ÿçº¿ç¨‹ï¼›ç›¸åï¼Œæˆ‘ä»¬å°†åœ¨ jcmd ä¸­å¼•å…¥ä¸€ç§æ–°å‹çº¿ç¨‹è½¬å‚¨ï¼Œä»¥å°†è™šæ‹Ÿçº¿ç¨‹ä¸å¹³å°çº¿ç¨‹ä¸€èµ·å‘ˆç°ï¼Œæ‰€æœ‰è¿™äº›éƒ½ä»¥æœ‰æ„ä¹‰çš„æ–¹å¼åˆ†ç»„ã€‚å½“ç¨‹åºä½¿ç”¨[ç»“æ„åŒ–å¹¶å‘](<a href="https://openjdk.org/jeps/428">JEP 428: Structured Concurrency (Incubator) (openjdk.org)</a>)æ—¶ï¼Œå¯ä»¥æ˜¾ç¤ºçº¿ç¨‹ä¹‹é—´æ›´ä¸°å¯Œçš„å…³ç³»ã€‚</p><p>ç”±äºå¯è§†åŒ–å’Œåˆ†æå¤§é‡çº¿ç¨‹å¯ä»¥ä»åˆ†æä¸­æ”¶ç›Šï¼Œå› æ­¤é™¤äº†å­˜æ–‡æœ¬ä¹‹å¤–ï¼Œjcmdè¿˜å¯ä»¥ä»¥jsonæ ¼å¼å‘å‡ºæ–°çš„çº¿ç¨‹dumpå‘½ä»¤ï¼š</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs tcl">$ jcmd &lt;<span class="hljs-keyword">pid</span>&gt; Thread.dump_to_file -<span class="hljs-keyword">format</span>=json &lt;<span class="hljs-keyword">file</span>&gt;<br></code></pre></td></tr></table></figure><p>æ–°çš„çº¿ç¨‹dumpæ ¼å¼ä¸åŒ…æ‹¬å¯¹è±¡åœ°å€ã€é”ã€JNIç»Ÿè®¡ä¿¡æ¯ã€å †ç»Ÿè®¡ä¿¡æ¯ä»¥åŠä¼ ç»Ÿçº¿ç¨‹dumpä¸­å‡ºç°çš„å…¶ä»–ç»Ÿè®¡ä¿¡æ¯ã€‚æ­¤å¤–ï¼Œç”±äºå®ƒå¯èƒ½éœ€è¦åˆ—å‡ºå¤§é‡çº¿ç¨‹ï¼Œå› æ­¤ç”Ÿæˆæ–°çš„çº¿ç¨‹dumpä¸ä¼šæš‚åœåº”ç”¨ç¨‹åºã€‚</p><p>å¦‚æœç³»ç»Ÿå±æ€§<code>jdk.trackAllThreads</code>è®¾ç½®ä¸ºfalseï¼Œå³ä½¿ç”¨<code>-Djdk.trackAllThreads=false</code>å‘½ä»¤è¡Œé€‰é¡¹ï¼Œä½¿ç”¨Thread.Builder APIç›´æ¥åˆ›å»ºçš„è™šæ‹Ÿçº¿ç¨‹ä¸ä¼šå§‹ç»ˆè¢«è¿è¡Œæ—¶è·Ÿè¸ªï¼Œå¹¶ä¸”å¯èƒ½ä¸ä¼šå‡ºç°åœ¨æ–°çš„çº¿ç¨‹dumpä¸­ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ–°çš„çº¿ç¨‹dumpå°†åˆ—å‡ºåœ¨ç½‘ç»œI&#x2F;Oæ“ä½œä¸­è¢«é˜»æ­¢çš„è™šæ‹Ÿçº¿ç¨‹ï¼Œä»¥åŠç”±ä¸Šé¢æ‰€ç¤ºçš„æ–°çš„ä¸€ä¸ªä»»åŠ¡ä¸€ä¸ªçº¿ç¨‹é£æ ¼çš„ExecutorServiceåˆ›å»ºçš„è™šæ‹Ÿçº¿ç¨‹ã€‚</p><p>ä»¥ä¸‹æ˜¯æ­¤ç±»çº¿ç¨‹è½¬å‚¨çš„ç¤ºä¾‹ï¼Œå–è‡ªä¸ä¸Šé¢ç¬¬äºŒä¸ªç¤ºä¾‹ç±»ä¼¼çš„åº”ç”¨ç¨‹åºï¼Œåœ¨ JSON æŸ¥çœ‹å™¨ä¸­å‘ˆç°ï¼ˆå•å‡»å¯æ”¾å¤§ï¼‰ï¼š</p><p><img src="https://bugs.openjdk.org/secure/attachment/98212/threaddump-700.png"></p><p>ç”±äºè™šæ‹Ÿçº¿ç¨‹æ˜¯åœ¨ JDK ä¸­å®ç°çš„ï¼Œå¹¶ä¸”ä¸ä¾èµ–äºä»»ä½•ç‰¹å®šçš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œå› æ­¤å®ƒä»¬å¯¹äºæ“ä½œç³»ç»Ÿæ¥è¯´æ˜¯ä¸å¯è§çš„ï¼Œæ“ä½œç³»ç»Ÿä¸çŸ¥é“å®ƒä»¬çš„å­˜åœ¨ã€‚æ“ä½œç³»ç»Ÿçº§çš„ç›‘æ§å°†è§‚å¯Ÿåˆ° JDK è¿›ç¨‹ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹å°‘äºè™šæ‹Ÿçº¿ç¨‹ã€‚</p><h4 id="Scheduling-virtual-threads"><a href="#Scheduling-virtual-threads" class="headerlink" title="Scheduling virtual threads"></a>Scheduling virtual threads</h4><p>ä¸ºäº†å®Œæˆæœ‰ç”¨çš„å·¥ä½œï¼Œéœ€è¦è°ƒåº¦çº¿ç¨‹ï¼Œå³åˆ†é…çº¿ç¨‹åœ¨å¤„ç†å™¨æ ¸å¿ƒä¸Šå·¥ä½œã€‚å¯¹äºä½œä¸ºæ“ä½œç³»ç»Ÿçº¿ç¨‹å®ç°çš„å¹³å°çº¿ç¨‹ï¼ŒJDKä¾èµ–äºæ“ä½œç³»ç»Ÿä¸­çš„è°ƒåº¦ç¨‹åºã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œå¯¹äºè™šæ‹Ÿçº¿ç¨‹ï¼ŒJDKæœ‰è‡ªå·±çš„è°ƒåº¦ç¨‹åºã€‚JDKçš„è°ƒåº¦ç¨‹åºä¸æ˜¯ç›´æ¥å°†è™šæ‹Ÿçº¿ç¨‹åˆ†é…ç»™å¤„ç†å™¨ï¼Œè€Œæ˜¯å°†è™šæ‹Ÿçº¿ç¨‹åˆ†é…ç»™å¹³å°çº¿ç¨‹ï¼ˆè¿™å°±æ˜¯å‰é¢æåˆ°çš„è™šæ‹Ÿçº¿ç¨‹çš„M:Nè°ƒåº¦ï¼‰ã€‚ç„¶åï¼Œæ“ä½œç³»ç»Ÿåƒå¾€å¸¸ä¸€æ ·è°ƒåº¦å¹³å°çº¿ç¨‹ã€‚</p><p>JDKçš„è™šæ‹Ÿçº¿ç¨‹è°ƒåº¦ç¨‹åºæ˜¯ä¸€ä¸ªwork-stealingçš„ForkJoinPoolï¼Œå®ƒä»¥FIFOæ¨¡å¼è¿è¡Œã€‚è°ƒåº¦ç¨‹åºçš„å¹¶è¡Œåº¦æ˜¯å¯ç”¨äºè°ƒåº¦è™šæ‹Ÿçº¿ç¨‹çš„å¹³å°çº¿ç¨‹æ•°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒç­‰äºå¯ç”¨å¤„ç†å™¨çš„æ•°é‡ï¼Œä½†å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå±æ€§jdk.virtualThreadScheduler.parallelismè¿›è¡Œè°ƒæ•´ã€‚æ­¤ForkJoinPoolä¸ä¸€èˆ¬çš„æ± ä¸åŒï¼Œä¸€èˆ¬çš„æ± ç”¨äºä¾‹å¦‚å¹¶è¡Œæµçš„å®ç°ï¼Œä»¥LIFOæ¨¡å¼è¿è¡Œã€‚</p><p>è°ƒåº¦ç¨‹åºä¸ºå…¶åˆ†é…è™šæ‹Ÿçº¿ç¨‹çš„å¹³å°çº¿ç¨‹ç§°ä¸ºè™šæ‹Ÿçº¿ç¨‹çš„è½½ä½“ã€‚è™šæ‹Ÿçº¿ç¨‹åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…å¯ä»¥è¢«è°ƒåº¦åˆ°ä¸åŒçš„è½½ä½“ä¸Šï¼›æ¢å¥è¯è¯´ï¼Œè°ƒåº¦ç¨‹åºä¸ç»´æŠ¤è™šæ‹Ÿçº¿ç¨‹å’Œä»»ä½•ç‰¹å®šå¹³å°çº¿ç¨‹ä¹‹é—´çš„å…³è”æ€§ã€‚ä»Javaä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è™šæ‹Ÿçº¿ç¨‹åœ¨é€»è¾‘ä¸Šç‹¬ç«‹äºå®ƒå½“å‰çš„è½½ä½“ï¼š</p><ul><li><p>è™šæ‹Ÿçº¿ç¨‹æ— æ³•è·å–è½½ä½“çš„èº«ä»½ã€‚ Thread.currentThread() è¿”å›çš„å€¼å§‹ç»ˆæ˜¯è™šæ‹Ÿçº¿ç¨‹æœ¬èº«ã€‚</p></li><li><p>è½½ä½“å’Œè™šæ‹Ÿçº¿ç¨‹çš„å †æ ˆè·Ÿè¸ªæ˜¯åˆ†å¼€çš„ã€‚ è™šæ‹Ÿçº¿ç¨‹ä¸­æŠ›å‡ºçš„å¼‚å¸¸å°†ä¸åŒ…æ‹¬è½½ä½“çš„å †æ ˆå¸§ã€‚ çº¿ç¨‹dumpä¸ä¼šæ˜¾ç¤ºè™šæ‹Ÿçº¿ç¨‹å †æ ˆä¸­è½½ä½“çš„å †æ ˆå¸§ï¼Œåä¹‹äº¦ç„¶ã€‚</p></li><li><p>è½½ä½“çš„çº¿ç¨‹å±€éƒ¨å˜é‡å¯¹äºè™šæ‹Ÿçº¿ç¨‹ä¸å¯ç”¨ï¼Œåä¹‹äº¦ç„¶ã€‚</p></li></ul><p>å¦å¤–ï¼Œä»Javaä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œè™šæ‹Ÿçº¿ç¨‹åŠå…¶è½½ä½“æš‚æ—¶å…±äº«ä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹è¿™ä¸€äº‹å®æ˜¯ä¸å¯è§çš„ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œä»nativeä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œè™šæ‹Ÿçº¿ç¨‹åŠå…¶è½½ä½“éƒ½è¿è¡Œåœ¨åŒä¸€ä¸ªnativeçº¿ç¨‹ä¸Šã€‚å› æ­¤ï¼Œåœ¨åŒä¸€è™šæ‹Ÿçº¿ç¨‹ä¸Šå¤šæ¬¡è°ƒç”¨çš„nativeä»£ç å¯èƒ½ä¼šåœ¨æ¯æ¬¡è°ƒç”¨æ—¶è§‚å¯Ÿåˆ°ä¸åŒçš„æ“ä½œç³»ç»Ÿçº¿ç¨‹æ ‡è¯†ç¬¦ã€‚</p><p>è°ƒåº¦ç¨‹åºç›®å‰æ²¡æœ‰å®ç°è™šæ‹Ÿçº¿ç¨‹çš„æ—¶é—´å…±äº«ã€‚æ—¶é—´å…±äº«æ˜¯å¯¹æ¶ˆè€—äº†åˆ†é…çš„ CPU æ—¶é—´çš„çº¿ç¨‹è¿›è¡Œå¼ºåˆ¶æŠ¢å ã€‚è™½ç„¶å½“å¹³å°çº¿ç¨‹æ•°é‡ç›¸å¯¹è¾ƒå°‘ä¸” CPU åˆ©ç”¨ç‡ä¸º 100% æ—¶ï¼Œæ—¶é—´å…±äº«å¯ä»¥æœ‰æ•ˆå‡å°‘æŸäº›ä»»åŠ¡çš„å»¶è¿Ÿï¼Œä½†å°šä¸æ¸…æ¥šæ—¶é—´å…±äº«å¯¹äº 100 ä¸‡ä¸ªè™šæ‹Ÿçº¿ç¨‹æ˜¯å¦åŒæ ·æœ‰æ•ˆã€‚</p><h4 id="Executing-virtual-threads"><a href="#Executing-virtual-threads" class="headerlink" title="Executing virtual threads"></a>Executing virtual threads</h4><p>è¦ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹ï¼Œæ— éœ€é‡å†™ç¨‹åºã€‚è™šæ‹Ÿçº¿ç¨‹ä¸éœ€è¦æˆ–æœŸæœ›åº”ç”¨ç¨‹åºä»£ç å°†æ§åˆ¶æƒæ˜¾å¼äº¤è¿˜ç»™è°ƒåº¦ç¨‹åºï¼›æ¢å¥è¯è¯´ï¼Œè™šæ‹Ÿçº¿ç¨‹æ˜¯ä¸åˆä½œçš„ã€‚ç”¨æˆ·ä»£ç ä¸å¾—å¯¹å¦‚ä½•æˆ–ä½•æ—¶å°†è™šæ‹Ÿçº¿ç¨‹åˆ†é…ç»™å¹³å°çº¿ç¨‹åšå‡ºä»»ä½•å‡è®¾ï¼Œå°±åƒä¸å¾—å¯¹å¦‚ä½•æˆ–ä½•æ—¶å°†å¹³å°çº¿ç¨‹åˆ†é…ç»™å¤„ç†å™¨å†…æ ¸åšå‡ºå‡è®¾ä¸€æ ·ã€‚</p><p>ä¸ºäº†åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­è¿è¡Œä»£ç ï¼ŒJDKçš„è™šæ‹Ÿçº¿ç¨‹è°ƒåº¦ç¨‹åºé€šè¿‡å°†è™šæ‹Ÿçº¿ç¨‹æŒ‚è½½åˆ°å¹³å°çº¿ç¨‹ä¸Šæ¥åˆ†é…è™šæ‹Ÿçº¿ç¨‹åœ¨å¹³å°çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚è¿™ä½¿å¾—å¹³å°çº¿ç¨‹æˆä¸ºè™šæ‹Ÿçº¿ç¨‹çš„è½½ä½“ã€‚ç¨åï¼Œåœ¨è¿è¡Œä¸€äº›ä»£ç åï¼Œè™šæ‹Ÿçº¿ç¨‹å¯ä»¥ä»å…¶è½½ä½“ä¸Šå¸è½½ã€‚æ­¤æ—¶å¹³å°çº¿ç¨‹æ˜¯ç©ºé—²çš„ï¼Œå› æ­¤è°ƒåº¦ç¨‹åºå¯ä»¥åœ¨å…¶ä¸ŠæŒ‚è½½å¦ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œä»è€Œä½¿å…¶å†æ¬¡æˆä¸ºè½½ä½“ã€‚</p><p>é€šå¸¸ï¼Œå½“è™šæ‹Ÿçº¿ç¨‹è¢« I&#x2F;O æ“ä½œæˆ– JDK ä¸­çš„æŸäº›å…¶ä»–é˜»å¡æ“ä½œï¼ˆä¾‹å¦‚ BlockingQueue.take()ï¼‰é˜»å¡æ—¶ï¼Œå®ƒå°†å¸è½½ã€‚å½“é˜»å¡æ“ä½œå‡†å¤‡å®Œæˆæ—¶ï¼ˆä¾‹å¦‚ï¼Œå¥—æ¥å­—ä¸Šå·²æ¥æ”¶åˆ°å­—èŠ‚ï¼‰ï¼Œå®ƒå°†è™šæ‹Ÿçº¿ç¨‹æäº¤å›è°ƒåº¦ç¨‹åºï¼Œè°ƒåº¦ç¨‹åºå°†è™šæ‹Ÿçº¿ç¨‹æŒ‚è½½åœ¨è½½ä½“ä¸Šä»¥æ¢å¤æ‰§è¡Œã€‚</p><p>è™šæ‹Ÿçº¿ç¨‹çš„æŒ‚è½½å’Œå¸è½½é¢‘ç¹ä¸”é€æ˜åœ°å‘ç”Ÿï¼Œå¹¶ä¸”ä¸ä¼šé˜»å¡ä»»ä½•æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚ä¾‹å¦‚ï¼Œå‰é¢æ˜¾ç¤ºçš„æœåŠ¡å™¨åº”ç”¨ç¨‹åºåŒ…å«ä»¥ä¸‹ä»£ç è¡Œï¼Œå…¶ä¸­åŒ…å«å¯¹é˜»å¡æ“ä½œçš„è°ƒç”¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">response.send(future1.get() + future2.get());<br></code></pre></td></tr></table></figure><p>é€šå¸¸æ¯æ¬¡è°ƒç”¨ get() ä¸€æ¬¡ï¼Œå¹¶ä¸”å¯èƒ½åœ¨ send(â€¦) æ‰§è¡Œ I&#x2F;O çš„è¿‡ç¨‹ä¸­å¤šæ¬¡ã€‚</p><p>JDKä¸­ç»å¤§å¤šæ•°çš„é˜»å¡æ“ä½œéƒ½ä¼šå¸è½½è™šæ‹Ÿçº¿ç¨‹ï¼Œé‡Šæ”¾å…¶è½½ä½“å’Œåº•å±‚OSçº¿ç¨‹æ¥æ‰¿æ‹…æ–°çš„å·¥ä½œã€‚ç„¶è€Œï¼ŒJDKä¸­çš„ä¸€äº›é˜»å¡æ“ä½œä¸ä¼šå¸è½½è™šæ‹Ÿçº¿ç¨‹ï¼Œä»è€Œé˜»å¡å…¶è½½ä½“å’Œåº•å±‚æ“ä½œç³»ç»Ÿçº¿ç¨‹ã€‚è¿™æ˜¯å› ä¸ºæ“ä½œç³»ç»Ÿçº§åˆ«ï¼ˆä¾‹å¦‚ï¼Œè®¸å¤šæ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼‰æˆ– JDK çº§åˆ«ï¼ˆä¾‹å¦‚ï¼ŒObject.wait()ï¼‰çš„é™åˆ¶ã€‚è¿™äº›é˜»å¡æ“ä½œçš„å®ç°é€šè¿‡æš‚æ—¶æ‰©å±•è°ƒåº¦ç¨‹åºçš„å¹¶è¡Œæ€§æ¥è¡¥å¿æ“ä½œç³»ç»Ÿçº¿ç¨‹çš„æ•è·ã€‚å› æ­¤ï¼Œè°ƒåº¦ç¨‹åºçš„ ForkJoinPool ä¸­çš„å¹³å°çº¿ç¨‹æ•°é‡å¯èƒ½ä¼šæš‚æ—¶è¶…è¿‡å¯ç”¨å¤„ç†å™¨çš„æ•°é‡ã€‚è°ƒåº¦ç¨‹åºå¯ç”¨çš„æœ€å¤§å¹³å°çº¿ç¨‹æ•°å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå±æ€§ jdk.virtualThreadScheduler.maxPoolSize è¿›è¡Œè°ƒæ•´ã€‚</p><p>åœ¨ä¸¤ç§æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿçº¿ç¨‹åœ¨é˜»å¡æ“ä½œæœŸé—´æ— æ³•å¸è½½ï¼Œå› ä¸ºå®ƒè¢«å›ºå®šåˆ°å…¶è½½ä½“ä¸Šï¼š</p><ol><li><p>å½“å®ƒåœ¨åŒæ­¥å—æˆ–æ–¹æ³•å†…æ‰§è¡Œä»£ç æ—¶ï¼Œæˆ–è€…</p></li><li><p>å½“å®ƒæ‰§è¡Œnativeæ–¹æ³•æˆ–å¤–éƒ¨å‡½æ•°æ—¶</p></li></ol><p>å›ºå®šï¼ˆPinningï¼‰ä¸ä¼šä½¿åº”ç”¨ç¨‹åºä¸æ­£ç¡®ï¼Œä½†å¯èƒ½ä¼šå¦¨ç¢å…¶å¯æ‰©å±•æ€§ã€‚å¦‚æœè™šæ‹Ÿçº¿ç¨‹åœ¨å›ºå®šæ—¶æ‰§è¡Œé˜»å¡æ“ä½œï¼Œä¾‹å¦‚ I&#x2F;O æˆ– BlockingQueue.take()ï¼Œåˆ™å…¶è½½ä½“å’Œåº•å±‚æ“ä½œç³»ç»Ÿçº¿ç¨‹åœ¨æ“ä½œæœŸé—´å°†è¢«é˜»å¡ã€‚é•¿æ—¶é—´é¢‘ç¹å›ºå®šå¯èƒ½ä¼šé€šè¿‡æ•è·è½½ä½“æ¥æŸå®³åº”ç”¨ç¨‹åºçš„å¯æ‰©å±•æ€§ã€‚</p><p>è°ƒåº¦ç¨‹åºä¸ä¼šé€šè¿‡æ‰©å±•å…¶å¹¶è¡Œæ€§æ¥è¡¥å¿å›ºå®šã€‚ç›¸åï¼Œé€šè¿‡ä¿®æ”¹ç»å¸¸è¿è¡Œçš„åŒæ­¥ä»£ç å—æˆ–æ–¹æ³•æ¥é¿å…é¢‘ç¹ä¸” é•¿æœŸçš„å›ºå®šï¼Œä½¿ç”¨java.util.concurrent.locks.ReentrantLockæ¥ä¿æŠ¤æ½œåœ¨çš„é•¿æ—¶é—´I&#x2F;Oæ“ä½œã€‚æ— éœ€æ›¿æ¢ä¸ç»å¸¸ä½¿ç”¨ï¼ˆä¾‹å¦‚ï¼Œä»…åœ¨å¯åŠ¨æ—¶æ‰§è¡Œï¼‰æˆ–ä¿æŠ¤å†…å­˜ä¸­çš„æ“ä½œçš„åŒæ­¥å—å’Œæ–¹æ³•ã€‚ä¸€å¦‚æ—¢å¾€ï¼ŒåŠªåŠ›ä¿æŒåŠ é”ç­–ç•¥ç®€å•æ˜äº†ã€‚</p><p>æ–°çš„è¯Šæ–­æœ‰åŠ©äºå°†ä»£ç è¿ç§»åˆ°è™šæ‹Ÿçº¿ç¨‹ï¼Œå¹¶è¯„ä¼°æ˜¯å¦åº”è¯¥ç”¨ java.util.concurrent é”æ›¿æ¢åŒæ­¥çš„ç‰¹å®šç”¨æ³•ï¼š</p><ul><li><p>A JDK Flight Recorder (JFR) event is emitted when a thread blocks while pinned (seeÂ <a href="https://openjdk.org/jeps/444#JDK-Flight-Recorder-JFR">JDK Flight Recorder</a>).</p></li><li><p>å½“çº¿ç¨‹åœ¨å›ºå®šçŠ¶æ€ä¸‹é˜»å¡æ—¶ï¼Œç³»ç»Ÿå±æ€§ jdk.tracePinnedThreads ä¼šè§¦å‘å †æ ˆè·Ÿè¸ªã€‚å½“çº¿ç¨‹åœ¨å›ºå®šæ—¶é˜»å¡æ—¶ï¼Œå¸¦æœ‰ -Djdk.tracePinnedThreads&#x3D;full å±æ€§ä¼šæ‰“å°å®Œæ•´çš„å †æ ˆè·Ÿè¸ªï¼Œçªå‡ºæ˜¾ç¤ºæœ¬æœºå¸§å’ŒæŒæœ‰ç›‘è§†å™¨çš„å¸§ã€‚ -Djdk.tracePinnedThreads&#x3D;short å°†é™åˆ¶ä»…è¾“å‡ºæœ‰é—®é¢˜çš„å¸§ã€‚</p></li></ul><h4 id="Memory-use-and-interaction-with-garbage-collection"><a href="#Memory-use-and-interaction-with-garbage-collection" class="headerlink" title="Memory use and interaction with garbage collection"></a>Memory use and interaction with garbage collection</h4><p>è™šæ‹Ÿçº¿ç¨‹çš„å †æ ˆä½œä¸ºå †æ ˆå—å¯¹è±¡å­˜å‚¨åœ¨ Java çš„åƒåœ¾æ”¶é›†å †ä¸­ã€‚å †æ ˆéšç€åº”ç”¨ç¨‹åºçš„è¿è¡Œè€Œå¢é•¿å’Œç¼©å°ï¼Œæ—¢æ˜¯ä¸ºäº†æé«˜å†…å­˜æ•ˆç‡ï¼Œä¹Ÿæ˜¯ä¸ºäº†å®¹çº³æ·±åº¦è¾¾åˆ° JVM é…ç½®çš„å¹³å°çº¿ç¨‹å †æ ˆå¤§å°çš„å †æ ˆã€‚è¿™ç§æ•ˆç‡ä½¿å¾—å¤§é‡è™šæ‹Ÿçº¿ç¨‹æˆä¸ºå¯èƒ½ï¼Œä»è€Œä½¿æœåŠ¡å™¨åº”ç”¨ç¨‹åºä¸­ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹é£æ ¼ä¿æŒæŒç»­çš„å¯è¡Œæ€§ã€‚</p><p>åœ¨ä¸Šé¢çš„ç¬¬äºŒä¸ªç¤ºä¾‹ä¸­ï¼Œå›æƒ³ä¸€ä¸‹å‡è®¾çš„æ¡†æ¶é€šè¿‡åˆ›å»ºæ–°çš„è™šæ‹Ÿçº¿ç¨‹å¹¶è°ƒç”¨å¥æŸ„æ–¹æ³•æ¥å¤„ç†æ¯ä¸ªè¯·æ±‚ã€‚å³ä½¿å®ƒåœ¨æ·±åº¦è°ƒç”¨å †æ ˆçš„æœ«å°¾è°ƒç”¨å¥æŸ„ï¼ˆåœ¨èº«ä»½éªŒè¯ã€äº‹åŠ¡ç­‰ä¹‹åï¼‰ï¼Œå¥æŸ„æœ¬èº«ä¹Ÿä¼šç”Ÿæˆå¤šä¸ªä»…æ‰§è¡ŒçŸ­æœŸä»»åŠ¡çš„è™šæ‹Ÿçº¿ç¨‹ã€‚å› æ­¤ï¼Œå¯¹äºæ¯ä¸ªå…·æœ‰æ·±è°ƒç”¨å †æ ˆçš„è™šæ‹Ÿçº¿ç¨‹ï¼Œéƒ½ä¼šæœ‰å¤šä¸ªå…·æœ‰æµ…è°ƒç”¨å †æ ˆçš„è™šæ‹Ÿçº¿ç¨‹ï¼Œæ¶ˆè€—å¾ˆå°‘çš„å†…å­˜ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œè™šæ‹Ÿçº¿ç¨‹æ‰€éœ€çš„å †ç©ºé—´å’Œåƒåœ¾æ”¶é›†å™¨æ´»åŠ¨é‡å¾ˆéš¾ä¸å¼‚æ­¥ä»£ç è¿›è¡Œæ¯”è¾ƒã€‚ä¸€ç™¾ä¸‡ä¸ªè™šæ‹Ÿçº¿ç¨‹éœ€è¦è‡³å°‘ä¸€ç™¾ä¸‡ä¸ªå¯¹è±¡ï¼Œä½†å…±äº«å¹³å°çº¿ç¨‹æ± çš„ä¸€ç™¾ä¸‡ä¸ªä»»åŠ¡ä¹Ÿéœ€è¦ä¸€ç™¾ä¸‡ä¸ªå¯¹è±¡ã€‚æ­¤å¤–ï¼Œå¤„ç†è¯·æ±‚çš„åº”ç”¨ç¨‹åºä»£ç é€šå¸¸ä¼šè·¨ I&#x2F;O æ“ä½œç»´æŠ¤æ•°æ®ã€‚ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹é£æ ¼çš„ä»£ç å¯ä»¥å°†è¯¥æ•°æ®ä¿å­˜åœ¨å±€éƒ¨å˜é‡ä¸­ï¼Œè¿™äº›å˜é‡å­˜å‚¨åœ¨å †ä¸­çš„è™šæ‹Ÿçº¿ç¨‹å †æ ˆä¸Šï¼Œè€Œå¼‚æ­¥ä»£ç å¿…é¡»å°†ç›¸åŒçš„æ•°æ®ä¿å­˜åœ¨ä»ç®¡é“çš„ä¸€ä¸ªé˜¶æ®µä¼ é€’åˆ°ä¸‹ä¸€é˜¶æ®µçš„å †å¯¹è±¡ä¸­ã€‚ä¸€æ–¹é¢ï¼Œè™šæ‹Ÿçº¿ç¨‹æ‰€éœ€çš„æ ˆå¸§å¸ƒå±€æ¯”ç´§å‡‘å¯¹è±¡æ›´æµªè´¹ï¼›å¦ä¸€æ–¹é¢ï¼Œè™šæ‹Ÿçº¿ç¨‹å¯ä»¥åœ¨è®¸å¤šæƒ…å†µä¸‹æ”¹å˜å’Œé‡ç”¨å®ƒä»¬çš„å †æ ˆï¼ˆå–å†³äºä½çº§ GC äº¤äº’ï¼‰ï¼Œè€Œå¼‚æ­¥ç®¡é“æ€»æ˜¯éœ€è¦åˆ†é…æ–°å¯¹è±¡ï¼Œå› æ­¤è™šæ‹Ÿçº¿ç¨‹å¯èƒ½éœ€è¦æ›´å°‘çš„åˆ†é…ã€‚æ€»ä½“è€Œè¨€ï¼Œæ¯ä¸ªè¯·æ±‚çº¿ç¨‹ä¸å¼‚æ­¥ä»£ç çš„å †æ¶ˆè€—å’Œåƒåœ¾æ”¶é›†å™¨æ´»åŠ¨åº”è¯¥å¤§è‡´ç›¸ä¼¼ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬å¸Œæœ›ä½¿è™šæ‹Ÿçº¿ç¨‹å †æ ˆçš„å†…éƒ¨è¡¨ç¤ºæ›´åŠ ç´§å‡‘ã€‚</p><p>ä¸å¹³å°çº¿ç¨‹å †æ ˆä¸åŒï¼Œè™šæ‹Ÿçº¿ç¨‹å †æ ˆä¸æ˜¯ GC rootã€‚å› æ­¤ï¼Œå®ƒä»¬åŒ…å«çš„å¼•ç”¨ä¸ä¼šè¢«æ‰§è¡Œå¹¶å‘å †æ‰«æçš„åƒåœ¾æ”¶é›†å™¨ï¼ˆä¾‹å¦‚ G1ï¼‰åœ¨stop-the-worldæš‚åœçš„æƒ…å†µä¸‹éå†ã€‚è¿™ä¹Ÿæ„å‘³ç€ï¼Œå¦‚æœä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹è¢«é˜»å¡ï¼Œä¾‹å¦‚ï¼ŒBlockingQueue.take()ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–çº¿ç¨‹å¯ä»¥è·å¾—å¯¹è™šæ‹Ÿçº¿ç¨‹æˆ–é˜Ÿåˆ—çš„å¼•ç”¨ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å¯ä»¥è¢«åƒåœ¾æ”¶é›†â€”â€”è¿™å¾ˆå¥½ï¼Œå› ä¸ºè¿™ç§è™šæ‹Ÿçº¿ç¨‹æ°¸è¿œä¸ä¼šè¢«ä¸­æ–­æˆ–è§£é™¤é˜»å¡ã€‚å½“ç„¶ï¼Œå¦‚æœè™šæ‹Ÿçº¿ç¨‹æ­£åœ¨è¿è¡Œæˆ–è€…è¢«é˜»å¡å¹¶ä¸”å¯ä»¥è¢«è§£é™¤é˜»å¡ï¼Œåˆ™å®ƒä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚</p><p>å½“å‰å¯¹è™šæ‹Ÿçº¿ç¨‹çš„é™åˆ¶æ˜¯ G1 GC ä¸æ”¯æŒå·¨å¤§çš„å †æ ˆå—å¯¹è±¡ã€‚å¦‚æœè™šæ‹Ÿçº¿ç¨‹çš„å †æ ˆè¾¾åˆ°åŒºåŸŸå¤§å°çš„ä¸€åŠï¼ˆå¯èƒ½å°è‡³ 512KBï¼‰ï¼Œåˆ™å¯èƒ½ä¼šå¼•å‘ StackOverflowErrorã€‚</p><h4 id="Detail-changes"><a href="#Detail-changes" class="headerlink" title="Detail changes"></a>Detail changes</h4><p>å…¶ä½™å°èŠ‚è¯¦ç»†æè¿°äº†æˆ‘ä»¬åœ¨ Java å¹³å°åŠå…¶å®ç°ä¸­æå‡ºçš„æ›´æ”¹ï¼š</p><ul><li><a href="https://openjdk.org/jeps/444#java-lang-Thread">java.lang.Thread</a></li><li><a href="https://openjdk.org/jeps/444#Thread-local-variables">Thread-local variables</a></li><li><a href="https://openjdk.org/jeps/444#java-util-concurrent">java.util.concurrent</a></li><li><a href="https://openjdk.org/jeps/444#Networking">Networking</a></li><li><a href="https://openjdk.org/jeps/444#java-io">java.io</a></li><li><a href="https://openjdk.org/jeps/444#Java-Native-Interface-JNI">Java Native Interface (JNI)</a></li><li><a href="https://openjdk.org/jeps/444#Debugging">Debugging (JVM TI, JDWP, and JDI)</a></li><li><a href="https://openjdk.org/jeps/444#JDK-Flight-Recorder-JFR">JDK Flight Recorder (JFR)</a></li><li><a href="https://openjdk.org/jeps/444#Java-Management-Extensions-JMX">Java Management Extensions (JMX)</a></li></ul><h5 id="java-lang-Thread"><a href="#java-lang-Thread" class="headerlink" title="java.lang.Thread"></a>java.lang.Thread</h5><p>æˆ‘ä»¬æ›´æ–° java.lang.Thread API å¦‚ä¸‹ï¼š</p><ul><li><p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Thread.Builder.html"><code>Thread.Builder</code></a>,Â <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Thread.html#ofVirtual()"><code>Thread.ofVirtual()</code></a>, andÂ <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Thread.html#ofPlatform()"><code>Thread.ofPlatform()</code></a>Â æ˜¯ç”¨äºåˆ›å»ºè™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹çš„æ–° APIã€‚ä¾‹å¦‚ï¼Œ</p><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-keyword">Thread</span> <span class="hljs-keyword">thread</span> = <span class="hljs-keyword">Thread</span>.ofVirtual().name(<span class="hljs-string">&quot;duke&quot;</span>).unstarted(runnable)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªåä¸ºâ€œdukeâ€çš„æ–°çš„æœªå¯åŠ¨è™šæ‹Ÿçº¿ç¨‹ã€‚</p></li><li><p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Thread.html#startVirtualThread(java.lang.Runnable)"><code>Thread.startVirtualThread(Runnable)</code></a>æ˜¯åˆ›å»ºç„¶åå¯åŠ¨è™šæ‹Ÿçº¿ç¨‹çš„ä¾¿æ·æ–¹æ³•ã€‚</p></li><li><p>Thread.Builder å¯ä»¥åˆ›å»ºçº¿ç¨‹æˆ– <a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/concurrent/ThreadFactory.html"><code>ThreadFactory</code></a>ï¼Œç„¶å ThreadFactory å¯ä»¥åˆ›å»ºå…·æœ‰ç›¸åŒå±æ€§çš„å¤šä¸ªçº¿ç¨‹ã€‚</p></li><li><p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Thread.html#isVirtual()"><code>Thread.isVirtual()</code></a>æµ‹è¯•çº¿ç¨‹æ˜¯å¦æ˜¯è™šæ‹Ÿçº¿ç¨‹ã€‚</p></li><li><p><a href="https://docs.oracle.com/en/java/javase/21/docs/docs/api/java.base/java/lang/Thread.html#getAllStackTraces()"><code>Thread.getAllStackTraces()</code></a> ç°åœ¨è¿”å›æ‰€æœ‰å¹³å°çº¿ç¨‹çš„æ˜ å°„ï¼Œè€Œä¸æ˜¯æ‰€æœ‰çº¿ç¨‹ã€‚</p></li></ul><p>java.lang.Thread API åœ¨å…¶ä»–æ–¹é¢åœ¨æ­¤ JEP ä¸­æ²¡æœ‰æ”¹å˜ã€‚ä¸ä»¥å‰ä¸€æ ·ï¼ŒThread ç±»å®šä¹‰çš„æ„é€ å‡½æ•°åˆ›å»ºå¹³å°çº¿ç¨‹ã€‚æ²¡æœ‰æ–°çš„å…¬å…±æ„é€ å‡½æ•°ã€‚</p><p>ï¼ˆThread ä¸­ä¸ºè™šæ‹Ÿçº¿ç¨‹æŠ›å‡º UnsupportedOperationException çš„ä¸‰ä¸ªæ–¹æ³• â€” stop()ã€suspend() å’Œresume() â€” åœ¨ JDK 20 ä¸­è¿›è¡Œäº†æ›´æ”¹ï¼Œä¹Ÿä¸ºå¹³å°çº¿ç¨‹æŠ›å‡º UnsupportedOperationExceptionã€‚ï¼‰</p><p>è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹ä¹‹é—´çš„ä¸»è¦ API å·®å¼‚æ˜¯ï¼š</p><ul><li><p>å…¬å…± Thread æ„é€ å‡½æ•°æ— æ³•åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ã€‚</p></li><li><p>è™šæ‹Ÿçº¿ç¨‹å§‹ç»ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ ã€‚Thread.setDaemon(boolean)æ–¹æ³•æ— æ³•å°†è™šæ‹Ÿçº¿ç¨‹æ›´æ”¹ä¸ºéå®ˆæŠ¤çº¿ç¨‹ã€‚</p></li><li><p>è™šæ‹Ÿçº¿ç¨‹å…·æœ‰å›ºå®šçš„ä¼˜å…ˆçº§ Thread.NORM_PRIORITYã€‚ Thread.setPriority(int) æ–¹æ³•å¯¹è™šæ‹Ÿçº¿ç¨‹æ²¡æœ‰å½±å“ã€‚æœªæ¥ç‰ˆæœ¬ä¸­å¯èƒ½ä¼šé‡æ–°è€ƒè™‘æ­¤é™åˆ¶ã€‚</p></li><li><p>è™šæ‹Ÿçº¿ç¨‹ä¸æ˜¯çº¿ç¨‹ç»„çš„æ´»åŠ¨æˆå‘˜ã€‚åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸Šè°ƒç”¨æ—¶ï¼ŒThread.getThreadGroup() è¿”å›ä¸€ä¸ªåä¸ºâ€œVirtualThreadsâ€çš„å ä½ç¬¦çº¿ç¨‹ç»„ã€‚Thread.Builder API æ²¡æœ‰å®šä¹‰è®¾ç½®è™šæ‹Ÿçº¿ç¨‹çš„çº¿ç¨‹ç»„çš„æ–¹æ³•ã€‚</p></li><li><p>å½“ä½¿ç”¨ SecurityManager é›†è¿è¡Œæ—¶ï¼Œè™šæ‹Ÿçº¿ç¨‹æ²¡æœ‰æƒé™ã€‚</p></li></ul><h5 id="Thread-local-variables"><a href="#Thread-local-variables" class="headerlink" title="Thread-local variables"></a>Thread-local variables</h5><p>è™šæ‹Ÿçº¿ç¨‹æ”¯æŒçº¿ç¨‹å±€éƒ¨å˜é‡ (ThreadLocal) å’Œå¯ç»§æ‰¿çš„çº¿ç¨‹å±€éƒ¨å˜é‡ (InheritableThreadLocal)ï¼Œå°±åƒå¹³å°çº¿ç¨‹ä¸€æ ·ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥è¿è¡Œä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡çš„ç°æœ‰ä»£ç ã€‚ä½†æ˜¯ï¼Œç”±äºè™šæ‹Ÿçº¿ç¨‹å¯èƒ½éå¸¸å¤šï¼Œå› æ­¤åªæœ‰åœ¨ä»”ç»†è€ƒè™‘åæ‰èƒ½ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚ç‰¹åˆ«æ˜¯ï¼Œä¸è¦ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡åœ¨çº¿ç¨‹æ± ä¸­å…±äº«åŒä¸€çº¿ç¨‹çš„å¤šä¸ªä»»åŠ¡ä¹‹é—´æ± åŒ–æ˜‚è´µçš„èµ„æºã€‚è™šæ‹Ÿçº¿ç¨‹æ°¸è¿œä¸åº”è¯¥è¢«æ± åŒ–ï¼Œå› ä¸ºæ¯ä¸ªè™šæ‹Ÿçº¿ç¨‹åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…åªè¿è¡Œä¸€ä¸ªä»»åŠ¡ã€‚æˆ‘ä»¬ä» JDK çš„ java.base æ¨¡å—ä¸­åˆ é™¤äº†è®¸å¤šçº¿ç¨‹å±€éƒ¨å˜é‡çš„ä½¿ç”¨ï¼Œä¸ºè™šæ‹Ÿçº¿ç¨‹åšå‡†å¤‡ï¼Œä»¥ä¾¿åœ¨è¿è¡Œæ•°ç™¾ä¸‡ä¸ªçº¿ç¨‹æ—¶å‡å°‘å†…å­˜å ç”¨ã€‚</p><p>å½“è™šæ‹Ÿçº¿ç¨‹è®¾ç½®ä»»ä½•çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼æ—¶ï¼Œç³»ç»Ÿå±æ€§ jdk.traceVirtualThreadLocals å¯ç”¨äºè§¦å‘å †æ ˆè·Ÿè¸ªã€‚å½“è¿ç§»ä»£ç ä»¥ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹æ—¶ï¼Œæ­¤è¯Šæ–­è¾“å‡ºå¯èƒ½æœ‰åŠ©äºåˆ é™¤çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚å°†ç³»ç»Ÿå±æ€§è®¾ç½®ä¸º true ä»¥è§¦å‘å †æ ˆè·Ÿè¸ªï¼›é»˜è®¤å€¼ä¸º falseã€‚</p><p>å¯¹äºæŸäº›ç”¨ä¾‹ï¼Œä½œç”¨åŸŸå€¼ï¼ˆ<a href="https://openjdk.org/jeps/429">JEP 429</a>ï¼‰å¯èƒ½è¢«è¯æ˜æ˜¯çº¿ç¨‹å±€éƒ¨å˜é‡çš„æ›´å¥½æ›¿ä»£æ–¹æ¡ˆã€‚</p><h5 id="java-util-concurrent"><a href="#java-util-concurrent" class="headerlink" title="java.util.concurrent"></a>java.util.concurrent</h5><p>æ”¯æŒé”å®šçš„åŸå§‹ API java.util.concurrent.LockSupport ç°åœ¨æ”¯æŒè™šæ‹Ÿçº¿ç¨‹ï¼šparkè™šæ‹Ÿçº¿ç¨‹ä¼šé‡Šæ”¾åº•å±‚å¹³å°çº¿ç¨‹ä»¥æ‰§è¡Œå…¶ä»–å·¥ä½œï¼Œunparkè™šæ‹Ÿçº¿ç¨‹ä¼šå®‰æ’å…¶ç»§ç»­è¿è¡Œã€‚å¯¹ LockSupport çš„è¿™ä¸€æ›´æ”¹ä½¿æ‰€æœ‰ä½¿ç”¨å®ƒçš„ APIï¼ˆLock,Â Semaphores, blocking queuesç­‰ï¼‰åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­è°ƒç”¨æ—¶èƒ½å¤Ÿæ­£å¸¸åœæ”¾ã€‚</p><p>æ­¤å¤–ï¼ŒExecutors.newThreadPerTaskExecutor(ThreadFactory) å’Œ Executors.newVirtualThreadPerTaskExecutor() åˆ›å»ºä¸€ä¸ª ExecutorServiceï¼Œä¸ºæ¯ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ã€‚è¿™äº›æ–¹æ³•æ”¯æŒä¸ä½¿ç”¨çº¿ç¨‹æ± å’Œ ExecutorService çš„ç°æœ‰ä»£ç è¿›è¡Œè¿ç§»å’Œäº’æ“ä½œã€‚</p><h5 id="Networking"><a href="#Networking" class="headerlink" title="Networking"></a>Networking</h5><p>java.net å’Œ java.nio.channels åŒ…ä¸­ç½‘ç»œ API çš„å®ç°ç°åœ¨å¯ä»¥ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹ï¼šè™šæ‹Ÿçº¿ç¨‹ä¸Šçš„æ“ä½œä¼šé˜»å¡ï¼Œä¾‹å¦‚å»ºç«‹ç½‘ç»œè¿æ¥æˆ–ä»å¥—æ¥å­—è¯»å–ï¼Œé‡Šæ”¾åº•å±‚å¹³å°çº¿ç¨‹ä»¥æ‰§è¡Œå…¶ä»–å·¥ä½œã€‚</p><p>ä¸ºäº†å…è®¸ä¸­æ–­å’Œå–æ¶ˆï¼Œç”± java.net.Socketã€ServerSocket å’Œ DatagramSocket å®šä¹‰çš„é˜»å¡ I&#x2F;O æ–¹æ³•ç°åœ¨è¢«æŒ‡å®šä¸ºåœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­è°ƒç”¨æ—¶å¯ä¸­æ–­ï¼šä¸­æ–­å¥—æ¥å­—ä¸Šé˜»å¡çš„è™šæ‹Ÿçº¿ç¨‹å°†å–æ¶ˆè¯¥çº¿ç¨‹çš„é©»ç•™å¹¶å…³é—­å¥—æ¥å­—ã€‚ä» InterruptibleChannel è·å–æ—¶ï¼Œè¿™äº›ç±»å‹çš„å¥—æ¥å­—ä¸Šçš„é˜»å¡ I&#x2F;O æ“ä½œå§‹ç»ˆæ˜¯å¯ä¸­æ–­çš„ï¼Œå› æ­¤æ­¤æ›´æ”¹ä½¿è¿™äº› API åœ¨ä½¿ç”¨å…¶æ„é€ å‡½æ•°åˆ›å»ºæ—¶çš„è¡Œä¸ºä¸ä»é€šé“è·å–æ—¶çš„è¡Œä¸ºä¿æŒä¸€è‡´ã€‚</p><h5 id="java-io"><a href="#java-io" class="headerlink" title="java.io"></a>java.io</h5><p>java.io åŒ…æä¾›äº†å­—èŠ‚æµå’Œå­—ç¬¦æµçš„ APIã€‚è¿™äº› API çš„å®ç°é«˜åº¦åŒæ­¥ï¼Œéœ€è¦è¿›è¡Œæ›´æ”¹ä»¥é¿å…åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸­ä½¿ç”¨å®ƒä»¬æ—¶å›ºå®šã€‚</p><p>ä½œä¸ºèƒŒæ™¯ï¼Œé¢å‘å­—èŠ‚çš„è¾“å…¥&#x2F;è¾“å‡ºæµæœªæŒ‡å®šä¸ºçº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”æœªæŒ‡å®šåœ¨è¯»å–æˆ–å†™å…¥æ–¹æ³•ä¸­é˜»å¡çº¿ç¨‹æ—¶è°ƒç”¨ close() æ—¶çš„é¢„æœŸè¡Œä¸ºã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½¿ç”¨æ¥è‡ªå¤šä¸ªå¹¶å‘çº¿ç¨‹çš„ç‰¹å®šè¾“å…¥æˆ–è¾“å‡ºæµæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚é¢å‘å­—ç¬¦çš„è¯»å–å™¨&#x2F;å†™å…¥å™¨ä¹ŸæœªæŒ‡å®šä¸ºçº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å®ƒä»¬ç¡®å®ä¸ºå­ç±»å…¬å¼€äº†é”å¯¹è±¡ã€‚é™¤äº†å›ºå®šä¹‹å¤–ï¼Œè¿™äº›ç±»ä¸­çš„åŒæ­¥ä¹Ÿå­˜åœ¨é—®é¢˜ä¸”ä¸ä¸€è‡´ï¼›ä¾‹å¦‚ï¼ŒInputStreamReader å’Œ OutputStreamWriter ä½¿ç”¨çš„æµè§£ç å™¨å’Œç¼–ç å™¨åœ¨æµå¯¹è±¡è€Œä¸æ˜¯é”å®šå¯¹è±¡ä¸ŠåŒæ­¥ã€‚</p><p>ä¸ºäº†é˜²æ­¢å›ºå®šï¼Œç°åœ¨çš„å®ç°å¦‚ä¸‹ï¼š</p><ul><li><p>BufferedInputStreamã€BufferedOutputStreamã€BufferedReaderã€BufferedWriterã€PrintStream å’Œ PrintWriter ç°åœ¨åœ¨ç›´æ¥ä½¿ç”¨æ—¶ä½¿ç”¨æ˜¾å¼é”è€Œä¸æ˜¯monitorã€‚è¿™äº›ç±»åœ¨è¢«å­ç±»åŒ–æ—¶ä¼šåƒä»¥å‰ä¸€æ ·åŒæ­¥ã€‚</p></li><li><p>InputStreamReader å’Œ OutputStreamWriter ä½¿ç”¨çš„æµè§£ç å™¨å’Œç¼–ç å™¨ç°åœ¨ä½¿ç”¨ä¸å°é—­çš„ InputStreamReader æˆ– OutputStreamWriter ç›¸åŒçš„é”ã€‚</p></li></ul><p>è¿›ä¸€æ­¥æ¶ˆé™¤æ‰€æœ‰è¿™äº›é€šå¸¸ä¸å¿…è¦çš„é”å®šè¶…å‡ºäº†æœ¬ JEP çš„èŒƒå›´ã€‚</p><p>æ­¤å¤–ï¼ŒBufferedOutputStreamã€BufferedWriter å’Œ OutputStreamWriter çš„æµç¼–ç å™¨ä½¿ç”¨çš„ç¼“å†²åŒºçš„åˆå§‹å¤§å°ç°åœ¨æ›´å°ï¼Œä»¥ä¾¿åœ¨å †ä¸­å­˜åœ¨è®¸å¤šæµæˆ–å†™å…¥å™¨æ—¶å‡å°‘å†…å­˜ä½¿ç”¨é‡ï¼ˆå¦‚æœå­˜åœ¨ä¸€ç™¾ä¸‡ä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œåˆ™å¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼‰ ï¼Œæ¯ä¸ªåœ¨å¥—æ¥å­—è¿æ¥ä¸Šéƒ½æœ‰ä¸€ä¸ªç¼“å†²æµã€‚</p><h5 id="Java-Native-Interfaceï¼ˆJNIï¼‰"><a href="#Java-Native-Interfaceï¼ˆJNIï¼‰" class="headerlink" title="Java Native Interfaceï¼ˆJNIï¼‰"></a>Java Native Interfaceï¼ˆJNIï¼‰</h5><p>JNI å®šä¹‰äº†ä¸€ä¸ªæ–°å‡½æ•° IsVirtualThreadï¼Œç”¨äºæµ‹è¯•å¯¹è±¡æ˜¯å¦ä¸ºè™šæ‹Ÿçº¿ç¨‹ã€‚</p><p>JNI è§„èŒƒåœ¨å…¶ä»–æ–¹é¢ä¿æŒä¸å˜ã€‚</p><h4 id="Debugging"><a href="#Debugging" class="headerlink" title="Debugging"></a>Debugging</h4><p>è°ƒè¯•æ¶æ„ç”±ä¸‰ä¸ªæ¥å£ç»„æˆï¼šJVM å·¥å…·æ¥å£ (JVM TI)ã€Java è°ƒè¯•çº¿åè®® (JDWP) å’Œ Java è°ƒè¯•æ¥å£ (JDI)ã€‚æ‰€æœ‰ä¸‰ä¸ªæ¥å£ç°åœ¨éƒ½æ”¯æŒè™šæ‹Ÿçº¿ç¨‹ã€‚</p><p><a href="https://docs.oracle.com/en/java/javase/21/docs/specs/jvmti.html">JVM TI</a> çš„æ›´æ–°æ˜¯ï¼š</p><ul><li><p>ä½¿ç”¨ jthreadï¼ˆå³å¯¹ Thread å¯¹è±¡çš„ JNI å¼•ç”¨ï¼‰è°ƒç”¨çš„å¤§å¤šæ•°å‡½æ•°éƒ½å¯ä»¥é€šè¿‡å¯¹è™šæ‹Ÿçº¿ç¨‹çš„å¼•ç”¨æ¥è°ƒç”¨ã€‚è™šæ‹Ÿçº¿ç¨‹ä¸Šä¸æ”¯æŒæˆ–å¯é€‰æ‹©æ”¯æŒå°‘æ•°å‡½æ•°ï¼Œå³ AgentStartFunctionã€PopFrameã€ForceEarlyReturn<em>ã€StopThread å’Œ GetThreadCpuTimeã€‚SetLocal</em> å‡½æ•°ä»…é™äºåœ¨æ–­ç‚¹æˆ–å•æ­¥äº‹ä»¶å¤„æŒ‚èµ·çš„è™šæ‹Ÿçº¿ç¨‹çš„æœ€é¡¶å±‚æ¡†æ¶ä¸­è®¾ç½®å±€éƒ¨å˜é‡ã€‚</p></li><li><p>ç°åœ¨æŒ‡å®š GetAllThreads å’Œ GetAllStackTraces å‡½æ•°è¿”å›æ‰€æœ‰å¹³å°çº¿ç¨‹è€Œä¸æ˜¯æ‰€æœ‰çº¿ç¨‹ã€‚</p></li><li><p>é™¤æ—©æœŸ VM å¯åŠ¨æœŸé—´æˆ–å †è¿­ä»£æœŸé—´å‘å¸ƒçš„äº‹ä»¶å¤–ï¼Œæ‰€æœ‰äº‹ä»¶éƒ½å¯ä»¥åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨äº‹ä»¶å›è°ƒã€‚</p></li><li><p>æŒ‚èµ·&#x2F;æ¢å¤å®ç°å…è®¸è°ƒè¯•å™¨æŒ‚èµ·å’Œæ¢å¤è™šæ‹Ÿçº¿ç¨‹ï¼Œå¹¶ä¸”å…è®¸åœ¨æŒ‚è½½è™šæ‹Ÿçº¿ç¨‹æ—¶æŒ‚èµ·å¹³å°çº¿ç¨‹ã€‚</p></li><li><p>æ–°åŠŸèƒ½ can_support_virtual_threads ä½¿ä»£ç†å¯ä»¥æ›´å¥½åœ°æ§åˆ¶è™šæ‹Ÿçº¿ç¨‹çš„çº¿ç¨‹å¯åŠ¨å’Œç»“æŸäº‹ä»¶ã€‚</p></li><li><p>æ–°åŠŸèƒ½æ”¯æŒè™šæ‹Ÿçº¿ç¨‹æ‰¹é‡æš‚åœå’Œæ¢å¤ï¼›è¿™äº›éœ€è¦ can_support_virtual_threads åŠŸèƒ½ã€‚</p></li></ul><p>ç°æœ‰çš„ JVM TI ä»£ç†å¤§éƒ¨åˆ†ä¼šåƒä»¥å‰ä¸€æ ·å·¥ä½œï¼Œä½†å¦‚æœå®ƒä»¬è°ƒç”¨è™šæ‹Ÿçº¿ç¨‹ä¸æ”¯æŒçš„å‡½æ•°ï¼Œåˆ™å¯èƒ½ä¼šé‡åˆ°é”™è¯¯ã€‚å½“ä¸çŸ¥é“è™šæ‹Ÿçº¿ç¨‹çš„ä»£ç†ä¸ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹çš„åº”ç”¨ç¨‹åºä¸€èµ·ä½¿ç”¨æ—¶ï¼Œå°±ä¼šå‡ºç°è¿™äº›é—®é¢˜ã€‚å¯¹ GetAllThreads è¿›è¡Œæ›´æ”¹ä»¥è¿”å›ä»…åŒ…å«å¹³å°çº¿ç¨‹çš„æ•°ç»„å¯¹äºæŸäº›ä»£ç†æ¥è¯´å¯èƒ½æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚å¯ç”¨ ThreadStart å’Œ ThreadEnd äº‹ä»¶çš„ç°æœ‰ä»£ç†å¯èƒ½ä¼šé‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬ç¼ºä¹å°†è¿™äº›äº‹ä»¶é™åˆ¶ä¸ºå¹³å°çº¿ç¨‹çš„èƒ½åŠ›ã€‚</p><p><a href="https://docs.oracle.com/en/java/javase/21/docs/specs/jdwp/jdwp-protocol.html">JDWP</a> çš„æ›´æ–°å¦‚ä¸‹ï¼š</p><ul><li><p>æ–°å‘½ä»¤å…è®¸è°ƒè¯•å™¨æµ‹è¯•çº¿ç¨‹æ˜¯å¦æ˜¯è™šæ‹Ÿçº¿ç¨‹ã€‚</p></li><li><p>EventRequest å‘½ä»¤ä¸Šçš„æ–°ä¿®é¥°ç¬¦å…è®¸è°ƒè¯•å™¨å°†çº¿ç¨‹å¯åŠ¨å’Œç»“æŸäº‹ä»¶é™åˆ¶ä¸ºå¹³å°çº¿ç¨‹ã€‚</p></li></ul><p><a href="https://docs.oracle.com/en/java/javase/21/docs/api/jdk.jdi/module-summary.html">JDI</a>çš„æ›´æ–°å¦‚ä¸‹ï¼š</p><ul><li><p>com.sun.jdi.ThreadReference ä¸­çš„æ–°æ–¹æ³•æµ‹è¯•çº¿ç¨‹æ˜¯å¦ä¸ºè™šæ‹Ÿçº¿ç¨‹ã€‚</p></li><li><p>com.sun.jdi.request.ThreadStartRequest å’Œ com.sun.jdi.request.ThreadDeathRequest ä¸­çš„æ–°æ–¹æ³•é™åˆ¶äº†ä¸ºå¹³å°çº¿ç¨‹è¯·æ±‚ç”Ÿæˆçš„äº‹ä»¶ã€‚</p></li></ul><p>å¦‚ä¸Šæ‰€è¿°ï¼Œè™šæ‹Ÿçº¿ç¨‹ä¸è¢«è§†ä¸ºçº¿ç¨‹ç»„ä¸­çš„æ´»åŠ¨çº¿ç¨‹ã€‚å› æ­¤ï¼ŒJVM TI å‡½æ•° GetThreadGroupChildrenã€JDWP å‘½ä»¤ ThreadGroupReference&#x2F;Children å’Œ JDI æ–¹æ³• com.sun.jdi.ThreadGroupReference.threads() è¿”å›çš„çº¿ç¨‹åˆ—è¡¨ä»…åŒ…å«å¹³å°çº¿ç¨‹ã€‚</p><h4 id="JDK-Flight-Recorderï¼ˆJFRï¼‰"><a href="#JDK-Flight-Recorderï¼ˆJFRï¼‰" class="headerlink" title="JDK Flight Recorderï¼ˆJFRï¼‰"></a>JDK Flight Recorderï¼ˆJFRï¼‰</h4><p>JFR æ”¯æŒå…·æœ‰å¤šä¸ªæ–°äº‹ä»¶çš„è™šæ‹Ÿçº¿ç¨‹ï¼š</p><ul><li><p>jdk.VirtualThreadStart å’Œ jdk.VirtualThreadEnd è¡¨ç¤ºè™šæ‹Ÿçº¿ç¨‹çš„å¼€å§‹å’Œç»“æŸã€‚é»˜è®¤æƒ…å†µä¸‹ç¦ç”¨è¿™äº›äº‹ä»¶ã€‚</p></li><li><p>jdk.VirtualThreadPinned è¡¨ç¤ºè™šæ‹Ÿçº¿ç¨‹åœ¨å›ºå®šæ—¶è¢«parkï¼Œå³æ²¡æœ‰é‡Šæ”¾å…¶å¹³å°çº¿ç¨‹ï¼ˆè§ä¸Šæ–‡ï¼‰ã€‚è¯¥äº‹ä»¶é»˜è®¤å¯ç”¨ï¼Œé˜ˆå€¼ä¸º 20 æ¯«ç§’ã€‚</p></li><li><p>dk.VirtualThreadSubmitFailed è¡¨ç¤ºå¯åŠ¨æˆ–å–æ¶ˆåœæ”¾è™šæ‹Ÿçº¿ç¨‹å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç”±äºèµ„æºé—®é¢˜ã€‚è¯¥äº‹ä»¶é»˜è®¤å¯ç”¨ã€‚</p></li></ul><h4 id="Java-Management-Extensionsï¼ˆJMXï¼‰"><a href="#Java-Management-Extensionsï¼ˆJMXï¼‰" class="headerlink" title="Java Management Extensionsï¼ˆJMXï¼‰"></a>Java Management Extensionsï¼ˆJMXï¼‰</h4><p>java.lang.management.ThreadMXBean ä»…æ”¯æŒå¹³å°çº¿ç¨‹çš„ç›‘æ§å’Œç®¡ç†ã€‚findDeadlockedThreads() æ–¹æ³•æŸ¥æ‰¾å¤„äºæ­»é”çŠ¶æ€çš„å¹³å°çº¿ç¨‹çš„å‘¨æœŸï¼›å®ƒä¸æ‰¾å¤„äºæ­»é”çŠ¶æ€çš„è™šæ‹Ÿçº¿ç¨‹å¾ªç¯ã€‚</p><p>com.sun.management.HotSpotDiagnosticsMXBean ä¸­çš„æ–°æ–¹æ³•ç”Ÿæˆä¸Šè¿°æ–°å‹çº¿ç¨‹dumpã€‚è¿˜å¯ä»¥é€šè¿‡å¹³å° MBeanServer ä»æœ¬åœ°æˆ–è¿œç¨‹ JMX å·¥å…·é—´æ¥è°ƒç”¨æ­¤æ–¹æ³•ã€‚</p><h4 id="Alternatives"><a href="#Alternatives" class="headerlink" title="Alternatives"></a>Alternatives</h4><ul><li><p>ç»§ç»­ä¾èµ–å¼‚æ­¥APIã€‚å¼‚æ­¥ API å¾ˆéš¾ä¸åŒæ­¥ API é›†æˆï¼Œåˆ›å»ºç›¸åŒ I&#x2F;O æ“ä½œçš„ä¸¤ç§è¡¨ç¤ºçš„åˆ†è£‚ä¸–ç•Œï¼Œå¹¶ä¸”æ²¡æœ‰æä¾›å¯ä¾›å¹³å°ç”¨ä½œæ•…éšœæ’é™¤ã€ç›‘è§†ã€è°ƒè¯•ä¸Šä¸‹æ–‡çš„æ“ä½œåºåˆ—çš„ç»Ÿä¸€æ¦‚å¿µ å’Œåˆ†æã€‚</p></li><li><p>å°†å¥æ³•æ— å †æ ˆåç¨‹ï¼ˆå³ async&#x2F;awaitï¼‰æ·»åŠ åˆ° Java è¯­è¨€ä¸­ã€‚è¿™äº›æ¯”ç”¨æˆ·æ¨¡å¼çº¿ç¨‹æ›´å®¹æ˜“å®ç°ï¼Œå¹¶ä¸”å°†æä¾›è¡¨ç¤ºæ“ä½œåºåˆ—ä¸Šä¸‹æ–‡çš„ç»Ÿä¸€æ„é€ ã€‚</p><p>ç„¶è€Œï¼Œè¯¥æ„é€ å°†æ˜¯æ–°çš„ï¼Œå¹¶ä¸”ä¸çº¿ç¨‹åˆ†å¼€ï¼Œåœ¨è®¸å¤šæ–¹é¢ä¸çº¿ç¨‹ç›¸ä¼¼ï¼Œä½†åœ¨æŸäº›ç»†å¾®å·®åˆ«ä¸Šæœ‰æ‰€ä¸åŒã€‚å®ƒå°†åœ¨ä¸ºçº¿ç¨‹è®¾è®¡çš„ API å’Œä¸ºåç¨‹è®¾è®¡çš„ API ä¹‹é—´åˆ’åˆ†ä¸–ç•Œï¼Œå¹¶ä¸”éœ€è¦å°†æ–°çš„ç±»ä¼¼çº¿ç¨‹çš„æ„é€ å¼•å…¥åˆ°å¹³å°åŠå…¶å·¥å…·çš„æ‰€æœ‰å±‚ä¸­ã€‚è¿™å°†éœ€è¦æ›´é•¿çš„æ—¶é—´æ‰èƒ½è¢«ç”Ÿæ€ç³»ç»Ÿé‡‡ç”¨ï¼Œå¹¶ä¸”ä¸ä¼šåƒç”¨æˆ·æ¨¡å¼çº¿ç¨‹é‚£æ ·ä¸å¹³å°ä¼˜é›…å’Œè°ã€‚</p><p>å¤§å¤šæ•°é‡‡ç”¨è¯­æ³•åç¨‹çš„è¯­è¨€éƒ½æ˜¯ç”±äºæ— æ³•å®ç°ç”¨æˆ·æ¨¡å¼çº¿ç¨‹ï¼ˆä¾‹å¦‚ Kotlinï¼‰ã€é—ç•™è¯­ä¹‰ä¿è¯ï¼ˆä¾‹å¦‚å›ºæœ‰çš„å•çº¿ç¨‹ JavaScriptï¼‰æˆ–ç‰¹å®šäºè¯­è¨€çš„æŠ€æœ¯é™åˆ¶ï¼ˆä¾‹å¦‚ C++ï¼‰è€Œè¿™æ ·åšçš„ã€‚ ï¼‰ã€‚ è¿™äº›é™åˆ¶ä¸é€‚ç”¨äº Javaã€‚</p></li><li><p>å¼•å…¥ä¸€ä¸ªæ–°çš„å…¬å…±ç±»æ¥è¡¨ç¤ºç”¨æˆ·æ¨¡å¼çº¿ç¨‹ï¼Œä¸ java.lang.Thread æ— å…³ã€‚è¿™å°†æ˜¯ä¸€ä¸ªæŠ›å¼ƒ Thread ç±» 25 å¹´æ¥ç§¯ç´¯çš„ä¸éœ€è¦çš„åŒ…è¢±çš„æœºä¼šã€‚æˆ‘ä»¬æ¢ç´¢å¹¶åŸå‹åŒ–äº†è¿™ç§æ–¹æ³•çš„å‡ ç§å˜ä½“ï¼Œä½†åœ¨æ¯ç§æƒ…å†µä¸‹éƒ½è¦è§£å†³å¦‚ä½•è¿è¡Œç°æœ‰ä»£ç çš„é—®é¢˜ã€‚</p><p>ä¸»è¦é—®é¢˜æ˜¯ Thread.currentThread() åœ¨ç°æœ‰ä»£ç ä¸­ç›´æ¥æˆ–é—´æ¥æ™®éä½¿ç”¨ï¼ˆä¾‹å¦‚ï¼Œç¡®å®šé”æ‰€æœ‰æƒæˆ–çº¿ç¨‹å±€éƒ¨å˜é‡ï¼‰ã€‚æ­¤æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ªè¡¨ç¤ºå½“å‰æ‰§è¡Œçº¿ç¨‹çš„å¯¹è±¡ã€‚å¦‚æœæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªæ–°ç±»æ¥è¡¨ç¤ºç”¨æˆ·æ¨¡å¼çº¿ç¨‹ï¼Œé‚£ä¹ˆ currentThread() å¿…é¡»è¿”å›æŸç§çœ‹èµ·æ¥åƒ Thread ä½†å§”æ‰˜ç»™ç”¨æˆ·æ¨¡å¼çº¿ç¨‹å¯¹è±¡çš„åŒ…è£…å¯¹è±¡ã€‚</p><p>è®©ä¸¤ä¸ªå¯¹è±¡ä»£è¡¨å½“å‰æ‰§è¡Œçº¿ç¨‹ä¼šä»¤äººå›°æƒ‘ï¼Œå› æ­¤æˆ‘ä»¬æœ€ç»ˆå¾—å‡ºç»“è®ºï¼Œä¿ç•™æ—§çš„ Thread API å¹¶ä¸æ˜¯ä¸€ä¸ªé‡å¤§éšœç¢ã€‚é™¤äº† currentThread() ç­‰å°‘æ•°æ–¹æ³•å¤–ï¼Œå¼€å‘äººå‘˜å¾ˆå°‘ç›´æ¥ä½¿ç”¨ Thread APIï¼›å®ƒä»¬ä¸»è¦ä½¿ç”¨æ›´é«˜çº§åˆ«çš„ APIï¼ˆä¾‹å¦‚ ExecutorServiceï¼‰è¿›è¡Œäº¤äº’ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œæˆ‘ä»¬å°†é€šè¿‡å¼ƒç”¨å’Œåˆ é™¤è¿‡æ—¶çš„æ–¹æ³•ï¼Œä» Thread ç±»å’Œç›¸å…³ç±»ï¼ˆä¾‹å¦‚ ThreadGroupï¼‰ä¸­æŠ›å¼ƒä¸éœ€è¦çš„åŒ…è¢±ã€‚</p></li></ul><h4 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h4><ul><li><p>ç°æœ‰çš„æµ‹è¯•å°†ç¡®ä¿æˆ‘ä»¬åœ¨æ­¤æå‡ºçš„æ›´æ”¹ä¸ä¼šå¯¼è‡´è¿è¡Œå®ƒä»¬çš„å¤šç§é…ç½®å’Œæ‰§è¡Œæ¨¡å¼å‡ºç°æ„å¤–çš„å›å½’ã€‚</p></li><li><p>æˆ‘ä»¬å°†æ‰©å±• jtreg æµ‹è¯•å·¥å…·ï¼Œä»¥å…è®¸ç°æœ‰æµ‹è¯•åœ¨è™šæ‹Ÿçº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚è¿™å°†é¿å…éœ€è¦è®¸å¤šæµ‹è¯•å‡ºç°ä¸¤ä¸ªç‰ˆæœ¬ã€‚</p></li><li><p>æ–°çš„æµ‹è¯•å°†æµ‹è¯•æ‰€æœ‰æ–°çš„å’Œä¿®è®¢çš„ APIï¼Œå¹¶ä¸”æ‰€æœ‰åŒºåŸŸéƒ½å°†æ›´æ”¹ä¸ºæ”¯æŒè™šæ‹Ÿçº¿ç¨‹ã€‚</p></li><li><p>æ–°çš„å‹åŠ›æµ‹è¯•å°†é’ˆå¯¹å¯¹å¯é æ€§å’Œæ€§èƒ½è‡³å…³é‡è¦çš„é¢†åŸŸã€‚</p></li><li><p>æ–°çš„å¾®åŸºå‡†æµ‹è¯•å°†é’ˆå¯¹æ€§èƒ½å…³é”®é¢†åŸŸã€‚</p></li><li><p>æˆ‘ä»¬å°†ä½¿ç”¨è®¸å¤šç°æœ‰æœåŠ¡å™¨ï¼ˆåŒ…æ‹¬ Helidon å’Œ Jettyï¼‰è¿›è¡Œæ›´å¤§è§„æ¨¡çš„æµ‹è¯•ã€‚</p></li></ul><h4 id="Risks-and-Assumptions"><a href="#Risks-and-Assumptions" class="headerlink" title="Risks and Assumptions"></a>Risks and Assumptions</h4><p>è¯¥ææ¡ˆçš„ä¸»è¦é£é™©æ˜¯ç”±äºç°æœ‰ API åŠå…¶å®ç°çš„å˜åŒ–è€Œå¯¼è‡´çš„å…¼å®¹æ€§é£é™©ï¼š</p><ul><li>java.io.BufferedInputStreamã€BufferedOutputStreamã€BufferedReaderã€BufferedWriterã€PrintStream å’Œ PrintWriter ç±»ä¸­ä½¿ç”¨çš„å†…éƒ¨ï¼ˆæœªè®°å½•çš„ï¼‰é”å®šåè®®çš„ä¿®è®¢å¯èƒ½ä¼šå½±å“å‡å®š I&#x2F;O æ–¹æ³•åœ¨è°ƒç”¨å®ƒä»¬çš„æµä¸ŠåŒæ­¥çš„ä»£ç  ã€‚ è¿™äº›æ›´æ”¹ä¸ä¼šå½±å“ç»§æ‰¿è¿™äº›ç±»å¹¶å‡å®šç”±è¶…ç±»é”å®šçš„ä»£ç ï¼Œä¹Ÿä¸ä¼šå½±å“ç»§æ‰¿ java.io.Reader æˆ– java.io.Writer å¹¶ä½¿ç”¨è¿™äº› API å…¬å¼€çš„é”å¯¹è±¡çš„ä»£ç ã€‚</li></ul><p>ä¸€äº›æºä»£ç å’ŒäºŒè¿›åˆ¶æ–‡ä»¶ä¸å…¼å®¹çš„æ›´æ”¹å¯èƒ½ä¼šå½±å“ç»§æ‰¿ java.lang.Thread çš„ä»£ç ï¼š</p><ul><li><p>Thread å®šä¹‰äº†å‡ ä¸ªæ–°æ–¹æ³•ã€‚å¦‚æœç°æœ‰æºæ–‡ä»¶ä¸­çš„ä»£ç ç»§æ‰¿äº† Thread å¹¶ä¸”å­ç±»ä¸­çš„æ–¹æ³•ä¸ä»»ä½•æ–°çš„ Thread æ–¹æ³•å‘ç”Ÿå†²çªï¼Œåˆ™è¯¥æ–‡ä»¶å°†æ— æ³•åœ¨ä¸è¿›è¡Œæ›´æ”¹çš„æƒ…å†µä¸‹è¿›è¡Œç¼–è¯‘ã€‚</p></li><li><p>Thread.Builder æ˜¯ä¸€ä¸ªæ–°çš„åµŒå¥—æ¥å£ã€‚å¦‚æœç°æœ‰æºæ–‡ä»¶ä¸­çš„ä»£ç ç»§æ‰¿äº† Threadï¼Œå¯¼å…¥åä¸º Builder çš„ç±»ï¼Œå¹¶ä¸”å­ç±»ä¸­çš„ä»£ç å¼•ç”¨ Builder ä½œä¸ºç®€å•åç§°ï¼Œåˆ™è¯¥æ–‡ä»¶å°†æ— æ³•åœ¨ä¸è¿›è¡Œæ›´æ”¹çš„æƒ…å†µä¸‹è¿›è¡Œç¼–è¯‘ã€‚</p></li><li><p>Thread.isVirtual() æ˜¯ä¸€ä¸ªæ–°çš„finalæ–¹æ³•ã€‚å¦‚æœå­˜åœ¨ç»§æ‰¿ Thread çš„ç°æœ‰ç¼–è¯‘ä»£ç ï¼Œå¹¶ä¸”å­ç±»å£°æ˜äº†å…·æœ‰ç›¸åŒåç§°å’Œè¿”å›ç±»å‹çš„æ–¹æ³•ï¼Œåˆ™åœ¨åŠ è½½å­ç±»æ—¶å°†åœ¨è¿è¡Œæ—¶æŠ›å‡º IncompleteClassChangeError ã€‚</p></li></ul><p>å°†ç°æœ‰ä»£ç ä¸ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹æˆ–æ–° API çš„æ–°ä»£ç æ··åˆæ—¶ï¼Œå¯èƒ½ä¼šè§‚å¯Ÿåˆ°å¹³å°çº¿ç¨‹å’Œè™šæ‹Ÿçº¿ç¨‹ä¹‹é—´çš„ä¸€äº›è¡Œä¸ºå·®å¼‚ï¼ˆä¸Šé¢éƒ½æåˆ°è¿‡ï¼Œè¿™é‡Œåšäº†æ€»ç»“ï¼‰ï¼š</p><ul><li><p>Thread.setPriority(int) æ–¹æ³•å¯¹è™šæ‹Ÿçº¿ç¨‹æ²¡æœ‰å½±å“ï¼Œè™šæ‹Ÿçº¿ç¨‹å§‹ç»ˆå…·æœ‰ Thread.NORM_PRIORITY ä¼˜å…ˆçº§ã€‚</p></li><li><p>Thread.setDaemon(boolean) æ–¹æ³•å¯¹è™šæ‹Ÿçº¿ç¨‹æ²¡æœ‰å½±å“ï¼Œè™šæ‹Ÿçº¿ç¨‹å§‹ç»ˆæ˜¯å®ˆæŠ¤çº¿ç¨‹ã€‚</p></li><li><p>Thread.getAllStackTraces() ç°åœ¨è¿”å›æ‰€æœ‰å¹³å°çº¿ç¨‹çš„æ˜ å°„ï¼Œè€Œä¸æ˜¯æ‰€æœ‰çº¿ç¨‹çš„æ˜ å°„ã€‚</p></li><li><p>ç°åœ¨ï¼Œå½“åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨æ—¶ï¼Œç”± java.net.Socketã€ServerSocket å’Œ DatagramSocket å®šä¹‰çš„é˜»å¡ I&#x2F;O æ–¹æ³•æ˜¯å¯ä¸­æ–­çš„ã€‚å½“åœ¨å¥—æ¥å­—æ“ä½œä¸Šé˜»å¡çš„çº¿ç¨‹è¢«ä¸­æ–­æ—¶ï¼Œç°æœ‰ä»£ç å¯èƒ½ä¼šä¸­æ–­ï¼Œè¿™å°†å”¤é†’çº¿ç¨‹å¹¶å…³é—­å¥—æ¥å­—ã€‚</p></li><li><p>è™šæ‹Ÿçº¿ç¨‹ä¸æ˜¯çº¿ç¨‹ç»„çš„æ´»åŠ¨æˆå‘˜ã€‚åœ¨è™šæ‹Ÿçº¿ç¨‹ä¸Šè°ƒç”¨ Thread.getThreadGroup() å°†è¿”å›ä¸€ä¸ªç©ºçš„è™šæ‹Ÿâ€œVirtualThreadsâ€ç»„ã€‚</p></li><li><p>å½“ä½¿ç”¨å®‰å…¨ç®¡ç†å™¨é›†è¿è¡Œæ—¶ï¼Œè™šæ‹Ÿçº¿ç¨‹æ²¡æœ‰æƒé™ã€‚æœ‰å…³åœ¨ Java 17 åŠæ›´é«˜ç‰ˆæœ¬ä¸Šè¿è¡Œå®‰å…¨ç®¡ç†å™¨çš„ä¿¡æ¯ï¼Œè¯·å‚é˜… <a href="https://openjdk.org/jeps/411">JEPÂ 411 (Deprecate the Security Manager for Removal)</a>ã€‚</p></li><li><p>åœ¨ JVM TI ä¸­ï¼ŒGetAllThreads å’Œ GetAllStackTraces å‡½æ•°ä¸è¿”å›è™šæ‹Ÿçº¿ç¨‹ã€‚å¯ç”¨ ThreadStart å’Œ ThreadEnd äº‹ä»¶çš„ç°æœ‰ä»£ç†å¯èƒ½ä¼šé‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå®ƒä»¬ç¼ºä¹å°†äº‹ä»¶é™åˆ¶ä¸ºå¹³å°çº¿ç¨‹çš„èƒ½åŠ›ã€‚</p></li><li><p>java.lang.management.ThreadMXBean API æ”¯æŒå¹³å°çº¿ç¨‹çš„ç›‘è§†å’Œç®¡ç†ï¼Œä½†ä¸æ”¯æŒè™šæ‹Ÿçº¿ç¨‹ã€‚</p></li><li><p>-XX:+PreserveFramePointer æ ‡å¿—å¯¹è™šæ‹Ÿçº¿ç¨‹æ€§èƒ½æœ‰å·¨å¤§çš„è´Ÿé¢å½±å“ã€‚</p></li></ul><h4 id="Dependencies"><a href="#Dependencies" class="headerlink" title="Dependencies"></a>Dependencies</h4><ul><li><p>JDK 18 ä¸­çš„ <a href="https://openjdk.java.net/jeps/416">JEP 416 (Reimplement Core Reflection with Method Handles)</a>åˆ é™¤äº†è™šæ‹Ÿæœºæœ¬æœºåå°„å®ç°ã€‚è¿™å…è®¸è™šæ‹Ÿçº¿ç¨‹åœ¨åå°„è°ƒç”¨æ–¹æ³•æ—¶ä¼˜é›…åœ°parkã€‚</p></li><li><p>JDK 13 ä¸­çš„<a href="https://openjdk.java.net/jeps/353">JEP 353 (Reimplement the Legacy Socket API)</a>å’Œ JDK 15 ä¸­çš„ Â <a href="https://openjdk.java.net/jeps/373">JEP 373 (Reimplement the Legacy DatagramSocket API)</a>ç”¨è®¾è®¡ç”¨äºè™šæ‹Ÿçº¿ç¨‹çš„æ–°å®ç°æ›¿æ¢äº† java.net.Socketã€ServerSocket å’Œ DatagramSocket çš„å®ç° ã€‚</p></li><li><p>JDK 18 ä¸­çš„ <a href="https://openjdk.java.net/jeps/418">JEP 418 (Internet-Address Resolution SPI)</a>å®šä¹‰äº†ç”¨äºä¸»æœºåå’Œåœ°å€æŸ¥æ‰¾çš„æœåŠ¡æä¾›è€…æ¥å£ã€‚ è¿™å°†å…è®¸ç¬¬ä¸‰æ–¹åº“å®ç°æ›¿ä»£çš„ java.net.InetAddress è§£æå™¨ï¼Œè¿™äº›è§£æå™¨åœ¨ä¸»æœºæŸ¥æ‰¾æœŸé—´ä¸ä¼šå›ºå®šçº¿ç¨‹ã€‚</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>æ–‡ç« ç¿»è¯‘</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>mybatis-configurationç±»</title>
    <link href="/2023/09/05/mybatis-source-code/mybatis-configuration%E7%B1%BB/"/>
    <url>/2023/09/05/mybatis-source-code/mybatis-configuration%E7%B1%BB/</url>
    
    <content type="html"><![CDATA[<h4 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h4><p>Â Â Â Â é…ç½®ä¸­å¿ƒï¼Œé‡Œé¢å¥½å¤šé…ç½®é¡¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span> &#123; <br><br>  <span class="hljs-comment">// å†³å®šåŠ è½½å“ªç§ç¯å¢ƒï¼ˆå¼€å‘|ç”Ÿäº§ï¼‰</span><br>  <span class="hljs-keyword">protected</span> Environment environment; <br><br>  <span class="hljs-comment">//---------ä»¥ä¸‹éƒ½æ˜¯&lt;settings&gt;èŠ‚ç‚¹-------</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">safeRowBoundsEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">safeResultHandlerEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">mapUnderscoreToCamelCase</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">aggressiveLazyLoading</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">multipleResultSetsEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">useGeneratedKeys</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">useColumnLabel</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>; <br><br>  <span class="hljs-comment">// é»˜è®¤å¯ç”¨ç¼“å­˜ï¼ˆExecutorç¼“å­˜ï¼‰</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">callSettersOnNulls</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>; <br><br>  <span class="hljs-comment">// æ—¥å¿—å‰ç¼€ï¼Œç”¨äºè·å–æ—¥å¿—</span><br>  <span class="hljs-keyword">protected</span> String logPrefix;<br>  <span class="hljs-comment">// æ—¥å¿—å®ç°ç±»</span><br>  <span class="hljs-keyword">protected</span> Class &lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Log</span>&gt; logImpl;<br>  <span class="hljs-comment">// æœ¬åœ°ç¼“å­˜çº§åˆ«ï¼Œé»˜è®¤ä¸ºsession</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">LocalCacheScope</span> <span class="hljs-variable">localCacheScope</span> <span class="hljs-operator">=</span> LocalCacheScope.SESSION;<br>  <span class="hljs-comment">// nullå¯¹åº”çš„JdbcType</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcTypeForNull</span> <span class="hljs-operator">=</span> JdbcType.OTHER;<br>  <span class="hljs-comment">// æ‡’åŠ è½½è§¦å‘æ–¹æ³•</span><br>  <span class="hljs-keyword">protected</span> Set&lt;String&gt; lazyLoadTriggerMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;(Arrays.asList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;equals&quot;</span>, <span class="hljs-string">&quot;clone&quot;</span>, <span class="hljs-string">&quot;hashCode&quot;</span>, <span class="hljs-string">&quot;toString&quot;</span> &#125;));<br>  <span class="hljs-comment">// è¯­å¥é»˜è®¤è¶…æ—¶æ—¶é—´</span><br>  <span class="hljs-keyword">protected</span> Integer defaultStatementTimeout;<br>  <span class="hljs-comment">// é»˜è®¤ä¸ºç®€å•æ‰§è¡Œå™¨</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">ExecutorType</span> <span class="hljs-variable">defaultExecutorType</span> <span class="hljs-operator">=</span> ExecutorType.SIMPLE;<br>  <span class="hljs-comment">// é»˜è®¤ä¸ºéƒ¨åˆ†æ˜ å°„ï¼Œå³ä¸å¤„ç†åµŒå¥—ç­‰å¤æ‚æ˜ å°„è¡Œä¸º</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">AutoMappingBehavior</span> <span class="hljs-variable">autoMappingBehavior</span> <span class="hljs-operator">=</span> AutoMappingBehavior.PARTIAL; <br>  <span class="hljs-comment">//---------ä»¥ä¸Šéƒ½æ˜¯&lt;settings&gt;èŠ‚ç‚¹-------</span><br><br>  <span class="hljs-comment">// å…¨å±€å±æ€§</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">Properties</span> <span class="hljs-variable">variables</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>  <span class="hljs-comment">// å¯¹è±¡å·¥å‚å’Œå¯¹è±¡åŒ…è£…å™¨å·¥å‚</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">ObjectFactory</span> <span class="hljs-variable">objectFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultObjectFactory</span>();<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">ObjectWrapperFactory</span> <span class="hljs-variable">objectWrapperFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultObjectWrapperFactory</span>();<br>  <span class="hljs-comment">// æ˜ å°„æ³¨å†Œæœº</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">MapperRegistry</span> <span class="hljs-variable">mapperRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperRegistry</span>(<span class="hljs-built_in">this</span>);<br><br>  <span class="hljs-comment">// é»˜è®¤ç¦ç”¨å»¶è¿ŸåŠ è½½</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">lazyLoadingEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-comment">// é»˜è®¤ä»£ç†å·¥å‚ä¸º JavassistProxyFactory</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">ProxyFactory</span> <span class="hljs-variable">proxyFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavassistProxyFactory</span>(); <span class="hljs-comment">// #224 Using internal Javassist instead of OGNL</span><br><br>  <span class="hljs-comment">// æ•°æ®åº“id</span><br>  <span class="hljs-keyword">protected</span> String databaseId;<br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Configuration factory class.</span><br><span class="hljs-comment">   * Used to create Configuration for loading deserialized unread properties.</span><br><span class="hljs-comment">   * é…ç½®å·¥å‚ç±»ï¼Œç”¨äºåˆ›å»ºåŠ è½½ååºåˆ—åŒ–çš„æœªè¯»å±æ€§çš„é…ç½®</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> &lt;a href=&#x27;https://code.google.com/p/mybatis/issues/detail?id=300&#x27;&gt;Issue 300&lt;/a&gt; (google code)</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> Class&lt;?&gt; configurationFactory;<br><br>  <span class="hljs-comment">// æ‹¦æˆªå™¨é“¾</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">InterceptorChain</span> <span class="hljs-variable">interceptorChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterceptorChain</span>();<br>  <span class="hljs-comment">// ç±»å‹å¤„ç†å™¨æ³¨å†Œæœº</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">TypeHandlerRegistry</span> <span class="hljs-variable">typeHandlerRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeHandlerRegistry</span>();<br>  <span class="hljs-comment">// ç±»å‹åˆ«åæ³¨å†Œæœº</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">TypeAliasRegistry</span> <span class="hljs-variable">typeAliasRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeAliasRegistry</span>();<br>  <span class="hljs-comment">// è¯­è¨€é©±åŠ¨æ³¨å†Œæœº</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">LanguageDriverRegistry</span> <span class="hljs-variable">languageRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LanguageDriverRegistry</span>();<br><br>  <span class="hljs-comment">// æ˜ å°„çš„è¯­å¥,å­˜åœ¨Mapé‡Œ</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, MappedStatement&gt; mappedStatements = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;MappedStatement&gt;(<span class="hljs-string">&quot;Mapped Statements collection&quot;</span>);<br>  <span class="hljs-comment">// ç¼“å­˜,å­˜åœ¨Mapé‡Œ</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, Cache&gt; caches = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;Cache&gt;(<span class="hljs-string">&quot;Caches collection&quot;</span>);<br>  <span class="hljs-comment">// ç»“æœæ˜ å°„,å­˜åœ¨Mapé‡Œ</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, ResultMap&gt; resultMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;ResultMap&gt;(<span class="hljs-string">&quot;Result Maps collection&quot;</span>);<br>  <span class="hljs-comment">// å‚æ•°æ˜ å°„</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, ParameterMap&gt; parameterMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;ParameterMap&gt;(<span class="hljs-string">&quot;Parameter Maps collection&quot;</span>);<br>  <span class="hljs-comment">// é”®å€¼ç”Ÿæˆå™¨</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, KeyGenerator&gt; keyGenerators = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;KeyGenerator&gt;(<span class="hljs-string">&quot;Key Generators collection&quot;</span>);<br><br>  <span class="hljs-comment">// å·²ç»åŠ è½½çš„èµ„æº</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; loadedResources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();<br>  <span class="hljs-comment">// sqlç‰‡æ®µ</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, XNode&gt; sqlFragments = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;XNode&gt;(<span class="hljs-string">&quot;XML fragments parsed from previous mappers&quot;</span>);<br><br>  <span class="hljs-comment">// ä¸å®Œæ•´çš„SQLè¯­å¥</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Collection&lt;XMLStatementBuilder&gt; incompleteStatements = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;XMLStatementBuilder&gt;();<br>  <span class="hljs-comment">// ç¼“å­˜å¼•ç”¨è§£æå™¨</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Collection&lt;CacheRefResolver&gt; incompleteCacheRefs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;CacheRefResolver&gt;();<br>  <span class="hljs-comment">// ç»“æœæ˜ å°„è§£æå™¨</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Collection&lt;ResultMapResolver&gt; incompleteResultMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;ResultMapResolver&gt;();<br>  <span class="hljs-comment">// æ–¹æ³•è§£æå™¨</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Collection&lt;MethodResolver&gt; incompleteMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;MethodResolver&gt;();<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * A map holds cache-ref relationship. The key is the namespace that</span><br><span class="hljs-comment">   * references a cache bound to another namespace and the value is the</span><br><span class="hljs-comment">   * namespace which the actual cache is bound to.</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * é”®æ˜¯ å¼•ç”¨ ç»‘å®šåˆ°å¦ä¸€ä¸ªåç§°ç©ºé—´çš„ç¼“å­˜çš„åç§°ç©ºé—´ï¼Œå€¼æ˜¯å®é™…ç¼“å­˜ç»‘å®šåˆ°çš„åç§°ç©ºé—´ã€‚</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; cacheRefMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;(); <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">Configuration</span><span class="hljs-params">(Environment environment)</span> &#123;<br>    <span class="hljs-built_in">this</span>();<br>    <span class="hljs-built_in">this</span>.environment = environment;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">Configuration</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// æ³¨å†Œæ›´å¤šçš„ç±»å‹åˆ«åï¼Œè‡³äºä¸ºä½•ä¸ç›´æ¥åœ¨TypeAliasRegistryé‡Œæ³¨å†Œï¼Œè¿˜éœ€è¿›ä¸€æ­¥ç ”ç©¶</span><br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;JDBC&quot;</span>, JdbcTransactionFactory.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;MANAGED&quot;</span>, ManagedTransactionFactory.class);<br><br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;JNDI&quot;</span>, JndiDataSourceFactory.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;POOLED&quot;</span>, PooledDataSourceFactory.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;UNPOOLED&quot;</span>, UnpooledDataSourceFactory.class);<br><br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;PERPETUAL&quot;</span>, PerpetualCache.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;FIFO&quot;</span>, FifoCache.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;LRU&quot;</span>, LruCache.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;SOFT&quot;</span>, SoftCache.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;WEAK&quot;</span>, WeakCache.class);<br><br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;DB_VENDOR&quot;</span>, VendorDatabaseIdProvider.class);<br><br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;XML&quot;</span>, XMLLanguageDriver.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;RAW&quot;</span>, RawLanguageDriver.class);<br><br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;SLF4J&quot;</span>, Slf4jImpl.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;COMMONS_LOGGING&quot;</span>, JakartaCommonsLoggingImpl.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;LOG4J&quot;</span>, Log4jImpl.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;LOG4J2&quot;</span>, Log4j2Impl.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;JDK_LOGGING&quot;</span>, Jdk14LoggingImpl.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;STDOUT_LOGGING&quot;</span>, StdOutImpl.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;NO_LOGGING&quot;</span>, NoLoggingImpl.class);<br><br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;CGLIB&quot;</span>, CglibProxyFactory.class);<br>    typeAliasRegistry.registerAlias(<span class="hljs-string">&quot;JAVASSIST&quot;</span>, JavassistProxyFactory.class);<br><br>    languageRegistry.setDefaultDriverClass(XMLLanguageDriver.class);<br>    languageRegistry.register(RawLanguageDriver.class);<br>  &#125; <br><br>  <span class="hljs-comment">// ç•¥è¿‡æ²¡æœ‰ç‰¹æ®Šå¤„ç†çš„set/getæ–¹æ³•</span><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLogImpl</span><span class="hljs-params">(Class&lt;?&gt; logImpl)</span> &#123;<br>    <span class="hljs-keyword">if</span> (logImpl != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-built_in">this</span>.logImpl = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Log</span>&gt;) logImpl;<br>      LogFactory.useCustomLogging(<span class="hljs-built_in">this</span>.logImpl);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ·»åŠ å·²åŠ è½½çš„èµ„æº</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addLoadedResource</span><span class="hljs-params">(String resource)</span> &#123;<br>    loadedResources.add(resource);<br>  &#125;<br><br>  <span class="hljs-comment">// èµ„æºæ˜¯å¦å·²åŠ è½½</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isResourceLoaded</span><span class="hljs-params">(String resource)</span> &#123;<br>    <span class="hljs-keyword">return</span> loadedResources.contains(resource);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProxyFactory</span><span class="hljs-params">(ProxyFactory proxyFactory)</span> &#123;<br>    <span class="hljs-keyword">if</span> (proxyFactory == <span class="hljs-literal">null</span>) &#123; <br>      <span class="hljs-comment">// é»˜è®¤ä¸ºJavassistProxyFactory</span><br>      proxyFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavassistProxyFactory</span>();<br>    &#125;<br>    <span class="hljs-built_in">this</span>.proxyFactory = proxyFactory;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDefaultScriptingLanguage</span><span class="hljs-params">(Class&lt;?&gt; driver)</span> &#123;<br>    <span class="hljs-keyword">if</span> (driver == <span class="hljs-literal">null</span>) &#123; <br>      <span class="hljs-comment">// é»˜è®¤ä¸º XMLLanguageDriver</span><br>      driver = XMLLanguageDriver.class;<br>    &#125;<br>    getLanguageRegistry().setDefaultDriverClass(driver);<br>  &#125; <br><br>  <span class="hljs-comment">// åˆ›å»ºå…ƒå¯¹è±¡</span><br>  <span class="hljs-keyword">public</span> MetaObject <span class="hljs-title function_">newMetaObject</span><span class="hljs-params">(Object object)</span> &#123;<br>    <span class="hljs-keyword">return</span> MetaObject.forObject(object, objectFactory, objectWrapperFactory);<br>  &#125; <br><br>  <span class="hljs-comment">// åˆ›å»ºå‚æ•°å¤„ç†å™¨</span><br>  <span class="hljs-keyword">public</span> ParameterHandler <span class="hljs-title function_">newParameterHandler</span><span class="hljs-params">(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-comment">// åˆ›å»ºParameterHandler</span><br>    <span class="hljs-type">ParameterHandler</span> <span class="hljs-variable">parameterHandler</span> <span class="hljs-operator">=</span> mappedStatement.getLang().createParameterHandler(mappedStatement, parameterObject, boundSql);<br>    <span class="hljs-comment">// æ’ä»¶åœ¨è¿™é‡Œæ’å…¥</span><br>    parameterHandler = (ParameterHandler) interceptorChain.pluginAll(parameterHandler);<br>    <span class="hljs-keyword">return</span> parameterHandler;<br>  &#125; <br><br>  <span class="hljs-comment">// åˆ›å»ºç»“æœé›†å¤„ç†å™¨</span><br>  <span class="hljs-keyword">public</span> ResultSetHandler <span class="hljs-title function_">newResultSetHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, RowBounds rowBounds, ParameterHandler parameterHandler,</span><br><span class="hljs-params">      ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-comment">// åˆ›å»ºDefaultResultSetHandler(ç¨è€ä¸€ç‚¹çš„ç‰ˆæœ¬3.1æ˜¯åˆ›å»ºNestedResultSetHandleræˆ–è€…FastResultSetHandler)</span><br>    <span class="hljs-type">ResultSetHandler</span> <span class="hljs-variable">resultSetHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResultSetHandler</span>(executor, mappedStatement, parameterHandler, resultHandler, boundSql, rowBounds);<br>    <span class="hljs-comment">// æ’ä»¶åœ¨è¿™é‡Œæ’å…¥</span><br>    resultSetHandler = (ResultSetHandler) interceptorChain.pluginAll(resultSetHandler);<br>    <span class="hljs-keyword">return</span> resultSetHandler;<br>  &#125; <br><br>  <span class="hljs-comment">// åˆ›å»ºè¯­å¥å¤„ç†å™¨</span><br>  <span class="hljs-keyword">public</span> StatementHandler <span class="hljs-title function_">newStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-comment">// åˆ›å»ºè·¯ç”±é€‰æ‹©è¯­å¥å¤„ç†å™¨</span><br>    <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">statementHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RoutingStatementHandler</span>(executor, mappedStatement, parameterObject, rowBounds, resultHandler, boundSql);<br>    <span class="hljs-comment">// æ’ä»¶åœ¨è¿™é‡Œæ’å…¥</span><br>    statementHandler = (StatementHandler) interceptorChain.pluginAll(statementHandler);<br>    <span class="hljs-keyword">return</span> statementHandler;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">(Transaction transaction)</span> &#123;<br>    <span class="hljs-keyword">return</span> newExecutor(transaction, defaultExecutorType);<br>  &#125; <br><br>  <span class="hljs-comment">// äº§ç”Ÿæ‰§è¡Œå™¨</span><br>  <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">(Transaction transaction, ExecutorType executorType)</span> &#123;<br>    executorType = executorType == <span class="hljs-literal">null</span> ? defaultExecutorType : executorType;<br>    <span class="hljs-comment">// è¿™å¥å†åšä¸€ä¸‹ä¿æŠ¤,å›§,é˜²æ­¢ç²—å¿ƒå¤§æ„çš„äººå°†defaultExecutorTypeè®¾æˆnull?</span><br>    executorType = executorType == <span class="hljs-literal">null</span> ? ExecutorType.SIMPLE : executorType;<br>    Executor executor;<br>    <span class="hljs-comment">// ç„¶åå°±æ˜¯ç®€å•çš„3ä¸ªåˆ†æ”¯ï¼Œäº§ç”Ÿ3ç§æ‰§è¡Œå™¨BatchExecutor/ReuseExecutor/SimpleExecutor</span><br>    <span class="hljs-keyword">if</span> (ExecutorType.BATCH == executorType) &#123;<br>      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchExecutor</span>(<span class="hljs-built_in">this</span>, transaction);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ExecutorType.REUSE == executorType) &#123;<br>      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReuseExecutor</span>(<span class="hljs-built_in">this</span>, transaction);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleExecutor</span>(<span class="hljs-built_in">this</span>, transaction);<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœè¦æ±‚ç¼“å­˜ï¼Œç”Ÿæˆå¦ä¸€ç§CachingExecutor(é»˜è®¤å°±æ˜¯æœ‰ç¼“å­˜),è£…é¥°è€…æ¨¡å¼,æ‰€ä»¥é»˜è®¤éƒ½æ˜¯è¿”å›CachingExecutor</span><br>    <span class="hljs-keyword">if</span> (cacheEnabled) &#123;<br>      executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachingExecutor</span>(executor);<br>    &#125;<br>    <span class="hljs-comment">// æ­¤å¤„è°ƒç”¨æ’ä»¶,é€šè¿‡æ’ä»¶å¯ä»¥æ”¹å˜Executorè¡Œä¸º</span><br>    executor = (Executor) interceptorChain.pluginAll(executor);<br>    <span class="hljs-keyword">return</span> executor;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addResultMap</span><span class="hljs-params">(ResultMap rm)</span> &#123;<br>    resultMaps.put(rm.getId(), rm);<br>    checkLocallyForDiscriminatedNestedResultMaps(rm);<br>    checkGloballyForDiscriminatedNestedResultMaps(rm);<br>  &#125; <br><br>  <span class="hljs-comment">// Slow but a one time cost. A better solution is welcome.</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkGloballyForDiscriminatedNestedResultMaps</span><span class="hljs-params">(ResultMap rm)</span> &#123;<br>    <span class="hljs-keyword">if</span> (rm.hasNestedResultMaps()) &#123;<br>      <span class="hljs-keyword">for</span> (Map.Entry&lt;String, ResultMap&gt; entry : resultMaps.entrySet()) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> entry.getValue();<br>        <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> ResultMap) &#123;<br>          <span class="hljs-type">ResultMap</span> <span class="hljs-variable">entryResultMap</span> <span class="hljs-operator">=</span> (ResultMap) value;<br>          <span class="hljs-keyword">if</span> (!entryResultMap.hasNestedResultMaps() &amp;&amp; entryResultMap.getDiscriminator() != <span class="hljs-literal">null</span>) &#123;<br>            Collection&lt;String&gt; discriminatedResultMapNames = entryResultMap.getDiscriminator().getDiscriminatorMap().values();<br>            <span class="hljs-keyword">if</span> (discriminatedResultMapNames.contains(rm.getId())) &#123;<br>              entryResultMap.forceNestedResultMaps();<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Slow but a one time cost. A better solution is welcome.</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkLocallyForDiscriminatedNestedResultMaps</span><span class="hljs-params">(ResultMap rm)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!rm.hasNestedResultMaps() &amp;&amp; rm.getDiscriminator() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : rm.getDiscriminator().getDiscriminatorMap().entrySet()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">discriminatedResultMapName</span> <span class="hljs-operator">=</span> entry.getValue();<br>        <span class="hljs-keyword">if</span> (hasResultMap(discriminatedResultMapName)) &#123;<br>          <span class="hljs-type">ResultMap</span> <span class="hljs-variable">discriminatedResultMap</span> <span class="hljs-operator">=</span> resultMaps.get(discriminatedResultMapName);<br>          <span class="hljs-keyword">if</span> (discriminatedResultMap.hasNestedResultMaps()) &#123;<br>            rm.forceNestedResultMaps();<br>            <span class="hljs-keyword">break</span>;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Collection&lt;String&gt; <span class="hljs-title function_">getMappedStatementNames</span><span class="hljs-params">()</span> &#123;<br>    buildAllStatements();<br>    <span class="hljs-keyword">return</span> mappedStatements.keySet();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Collection&lt;MappedStatement&gt; <span class="hljs-title function_">getMappedStatements</span><span class="hljs-params">()</span> &#123;<br>    buildAllStatements();<br>    <span class="hljs-keyword">return</span> mappedStatements.values();<br>  &#125; <br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * Parses all the unprocessed statement nodes in the cache. It is recommended</span><br><span class="hljs-comment">   * to call this method once all the mappers are added as it provides fail-fast</span><br><span class="hljs-comment">   * statement validation.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildAllStatements</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (!incompleteResultMaps.isEmpty()) &#123;<br>      <span class="hljs-keyword">synchronized</span> (incompleteResultMaps) &#123;<br>        <span class="hljs-comment">// This always throws a BuilderException.</span><br>        incompleteResultMaps.iterator().next().resolve();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!incompleteCacheRefs.isEmpty()) &#123;<br>      <span class="hljs-keyword">synchronized</span> (incompleteCacheRefs) &#123;<br>        <span class="hljs-comment">// This always throws a BuilderException.</span><br>        incompleteCacheRefs.iterator().next().resolveCacheRef();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!incompleteStatements.isEmpty()) &#123;<br>      <span class="hljs-keyword">synchronized</span> (incompleteStatements) &#123;<br>        <span class="hljs-comment">// This always throws a BuilderException.</span><br>        incompleteStatements.iterator().next().parseStatementNode();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!incompleteMethods.isEmpty()) &#123;<br>      <span class="hljs-keyword">synchronized</span> (incompleteMethods) &#123;<br>        <span class="hljs-comment">// This always throws a BuilderException.</span><br>        incompleteMethods.iterator().next().resolve();<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ç”±DefaultSqlSession.selectListè°ƒç”¨è¿‡æ¥</span><br>  <span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title function_">getMappedStatement</span><span class="hljs-params">(String id)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getMappedStatement(id, <span class="hljs-literal">true</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title function_">getMappedStatement</span><span class="hljs-params">(String id, <span class="hljs-type">boolean</span> validateIncompleteStatements)</span> &#123;<br>    <span class="hljs-comment">// å…ˆæ„å»ºæ‰€æœ‰è¯­å¥ï¼Œå†è¿”å›è¯­å¥</span><br>    <span class="hljs-keyword">if</span> (validateIncompleteStatements) &#123;<br>      buildAllStatements();<br>    &#125;<br>    <span class="hljs-keyword">return</span> mappedStatements.get(id);<br>  &#125; <br><br>  <span class="hljs-comment">// å°†åŒ…ä¸‹æ‰€æœ‰ç±»åŠ å…¥åˆ°mapper</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMappers</span><span class="hljs-params">(String packageName, Class&lt;?&gt; superType)</span> &#123;<br>    mapperRegistry.addMappers(packageName, superType);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasStatement</span><span class="hljs-params">(String statementName, <span class="hljs-type">boolean</span> validateIncompleteStatements)</span> &#123;<br>    <span class="hljs-keyword">if</span> (validateIncompleteStatements) &#123;<br>      buildAllStatements();<br>    &#125;<br>    <span class="hljs-keyword">return</span> mappedStatements.containsKey(statementName);<br>  &#125; <br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * Extracts namespace from fully qualified statement id.</span><br><span class="hljs-comment">   * ä»å®Œå…¨é™å®šçš„è¯­å¥idä¸­æå–å‘½åç©ºé—´ã€‚</span><br><span class="hljs-comment">   * @param statementId</span><br><span class="hljs-comment">   * @return namespace or null when id does not contain period.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">extractNamespace</span><span class="hljs-params">(String statementId)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">lastPeriod</span> <span class="hljs-operator">=</span> statementId.lastIndexOf(<span class="hljs-string">&#x27;.&#x27;</span>);<br>    <span class="hljs-keyword">return</span> lastPeriod &gt; <span class="hljs-number">0</span> ? statementId.substring(<span class="hljs-number">0</span>, lastPeriod) : <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// é™æ€å†…éƒ¨ç±»,ä¸¥æ ¼çš„Mapï¼Œä¸å…è®¸å¤šæ¬¡è¦†ç›–keyæ‰€å¯¹åº”çš„value</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StrictMap</span>&lt;V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>&lt;String, V&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">4950446264854982944L</span>;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StrictMap</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> initialCapacity, <span class="hljs-type">float</span> loadFactor)</span> &#123;<br>      <span class="hljs-built_in">super</span>(initialCapacity, loadFactor);<br>      <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StrictMap</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> initialCapacity)</span> &#123;<br>      <span class="hljs-built_in">super</span>(initialCapacity);<br>      <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StrictMap</span><span class="hljs-params">(String name)</span> &#123;<br>      <span class="hljs-built_in">super</span>();<br>      <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StrictMap</span><span class="hljs-params">(String name, Map&lt;String, ? extends V&gt; m)</span> &#123;<br>      <span class="hljs-built_in">super</span>(m);<br>      <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(String key, V value)</span> &#123;<br>      <span class="hljs-keyword">if</span> (containsKey(key)) &#123;<br>        <span class="hljs-comment">// å¦‚æœå·²ç»å­˜åœ¨æ­¤keyäº†ï¼Œç›´æ¥æŠ¥é”™</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(name + <span class="hljs-string">&quot; already contains value for &quot;</span> + key);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (key.contains(<span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>        <span class="hljs-comment">// å¦‚æœæœ‰.ç¬¦å·ï¼Œå–å¾—çŸ­åç§°ï¼Œå¤§è‡´ç”¨æ„å°±æ˜¯åŒ…åä¸åŒï¼Œç±»åç›¸åŒï¼Œæä¾›æ¨¡ç³ŠæŸ¥è¯¢çš„åŠŸèƒ½</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">shortKey</span> <span class="hljs-operator">=</span> getShortName(key);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">super</span>.get(shortKey) == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-comment">// å¦‚æœæ²¡æœ‰è¿™ä¸ªç¼©ç•¥ï¼Œåˆ™æ”¾ä¸€ä¸ªç¼©ç•¥</span><br>          <span class="hljs-built_in">super</span>.put(shortKey, value);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// å¦‚æœå·²ç»æœ‰æ­¤ç¼©ç•¥ï¼Œè¡¨ç¤ºæ¨¡ç³Šï¼Œæ”¾ä¸€ä¸ªAmbiguityå‹çš„</span><br>          <span class="hljs-built_in">super</span>.put(shortKey, (V) <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ambiguity</span>(shortKey));<br>        &#125;<br>      &#125;<br>      <span class="hljs-comment">// å†æ”¾ä¸€ä¸ªå…¨å</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.put(key, value);<br>      <span class="hljs-comment">// å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæœ‰åŒ…åï¼Œä¼šæ”¾2ä¸ªkeyåˆ°è¿™ä¸ªmapï¼Œä¸€ä¸ªç¼©ç•¥ï¼Œä¸€ä¸ªå…¨å</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>      <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.get(key);<br>      <span class="hljs-comment">// å¦‚æœæ‰¾ä¸åˆ°ç›¸åº”çš„keyï¼Œç›´æ¥æŠ¥é”™</span><br>      <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(name + <span class="hljs-string">&quot; does not contain value for &quot;</span> + key);<br>      &#125;<br>      <span class="hljs-comment">// å¦‚æœæ˜¯æ¨¡ç³Šå‹çš„ï¼Œä¹ŸæŠ¥é”™ï¼Œæç¤ºç”¨æˆ·</span><br>      <span class="hljs-comment">// åŸæ¥è¿™ä¸ªæ¨¡ç³Šå‹å°±æ˜¯ä¸ºäº†æç¤ºç”¨æˆ·å•Š</span><br>      <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Ambiguity) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(((Ambiguity) value).getSubject() + <span class="hljs-string">&quot; is ambiguous in &quot;</span> + name<br>            + <span class="hljs-string">&quot; (try using the full name including the namespace, or rename one of the entries)&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">return</span> value;<br>    &#125;<br><br>    <span class="hljs-comment">// å–å¾—çŸ­åç§°ï¼Œä¹Ÿå°±æ˜¯å–å¾—æœ€åé‚£ä¸ªå¥å·çš„åé¢é‚£éƒ¨åˆ†</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getShortName</span><span class="hljs-params">(String key)</span> &#123;<br>      <span class="hljs-keyword">final</span> String[] keyparts = key.split(<span class="hljs-string">&quot;\\.&quot;</span>);<br>      <span class="hljs-keyword">return</span> keyparts[keyparts.length - <span class="hljs-number">1</span>];<br>    &#125;<br><br>    <span class="hljs-comment">// æ¨¡ç³Šï¼Œå±…ç„¶æ”¾åœ¨Mapé‡Œé¢çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œ</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Ambiguity</span> &#123;<br>      <span class="hljs-comment">//æä¾›ä¸€ä¸ªä¸»é¢˜</span><br>      <span class="hljs-keyword">private</span> String subject;<br><br>      <span class="hljs-keyword">public</span> <span class="hljs-title function_">Ambiguity</span><span class="hljs-params">(String subject)</span> &#123;<br>        <span class="hljs-built_in">this</span>.subject = subject;<br>      &#125;<br><br>      <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSubject</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> subject;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>17-plugin</title>
    <link href="/2023/09/04/mybatis-source-code/17-plugin/"/>
    <url>/2023/09/04/mybatis-source-code/17-plugin/</url>
    
    <content type="html"><![CDATA[<h4 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h4><p>Â Â Â Â ç­¾å</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Signature &#123;<br>  <span class="hljs-comment">// å°±æ˜¯å®šä¹‰å“ªäº›ç±»ï¼Œæ–¹æ³•ï¼Œå‚æ•°éœ€è¦è¢«æ‹¦æˆª</span><br>  Class&lt;?&gt; type();<br><br>  String <span class="hljs-title function_">method</span><span class="hljs-params">()</span>;<br><br>  Class&lt;?&gt;[] args();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Intercepts"><a href="#Intercepts" class="headerlink" title="Intercepts"></a>Intercepts</h4><p>Â Â Â Â <code>@Intercepts</code>æ³¨è§£ç”¨äºè¡¨æ˜å½“å‰çš„å¯¹è±¡æ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨ã€‚å…¶é…ç½®å€¼æ˜¯ä¸€ä¸ª<code>@Signature</code>æ•°ç»„ï¼Œè€Œ<code>@Signature</code>åˆ™ç”¨äºå£°æ˜è¦æ‹¦æˆªçš„æ¥å£ã€æ–¹æ³•ä»¥åŠå¯¹åº”çš„å‚æ•°åˆ—è¡¨.æ‰€è°“æ‹¦æˆªå™¨çš„ä½œç”¨å°±æ˜¯å¯ä»¥æ‹¦æˆªæŸäº›æ–¹æ³•çš„è°ƒç”¨ï¼Œå’ŒSpringä¸­çš„AOPæ˜¯å®Œå…¨ä¸€è‡´çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Intercepts &#123;<br>  Signature[] value();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Interceptor"><a href="#Interceptor" class="headerlink" title="Interceptor"></a>Interceptor</h4><p>Â Â Â Â æ‹¦æˆªå™¨æŠ½è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Interceptor</span> &#123;<br><br>  <span class="hljs-comment">// æ‹¦æˆª</span><br>  Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Invocation invocation)</span> <span class="hljs-keyword">throws</span> Throwable;<br><br>  <span class="hljs-comment">// è¿”å›ä»£ç†ç±»</span><br>  Object <span class="hljs-title function_">plugin</span><span class="hljs-params">(Object target)</span>;<br><br>  <span class="hljs-comment">// è®¾ç½®å±æ€§</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Plugin"><a href="#Plugin" class="headerlink" title="Plugin"></a>Plugin</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Plugin</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123; <br><br>  <span class="hljs-comment">// è¢«ä»£ç†çš„å¯¹è±¡</span><br>  <span class="hljs-keyword">private</span> Object target;<br>  <span class="hljs-comment">// æ‹¦æˆªå™¨</span><br>  <span class="hljs-keyword">private</span> Interceptor interceptor;<br>  <span class="hljs-comment">// è¦ä»£ç†çš„æ–¹æ³•</span><br>  <span class="hljs-keyword">private</span> Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">Plugin</span><span class="hljs-params">(Object target, Interceptor interceptor, Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap)</span> &#123;<br>    <span class="hljs-built_in">this</span>.target = target;<br>    <span class="hljs-built_in">this</span>.interceptor = interceptor;<br>    <span class="hljs-built_in">this</span>.signatureMap = signatureMap;<br>  &#125; <br><br>  <span class="hljs-comment">// ç”Ÿæˆä»£ç†ç±»</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">wrap</span><span class="hljs-params">(Object target, Interceptor interceptor)</span> &#123;<br>    <span class="hljs-comment">// å–å¾—ç­¾åMap</span><br>    Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap = getSignatureMap(interceptor);<br>    <span class="hljs-comment">// å–å¾—è¦æ”¹å˜è¡Œä¸ºçš„ç±»(ParameterHandler|ResultSetHandler|StatementHandler|Executor)</span><br>    Class&lt;?&gt; type = target.getClass();<br>    <span class="hljs-comment">// å–å¾—æ¥å£</span><br>    Class&lt;?&gt;[] interfaces = getAllInterfaces(type, signatureMap);<br>    <span class="hljs-comment">// äº§ç”Ÿä»£ç†</span><br>    <span class="hljs-keyword">if</span> (interfaces.length &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<br>          type.getClassLoader(),<br>          interfaces,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">Plugin</span>(target, interceptor, signatureMap));<br>    &#125;<br>    <span class="hljs-keyword">return</span> target;<br>  &#125; <br><br>  <span class="hljs-comment">// å–å¾—ç­¾åMap</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; getSignatureMap(Interceptor interceptor) &#123;<br>    <span class="hljs-comment">// å–Interceptsæ³¨è§£ï¼Œä¾‹å­å¯å‚è§ExamplePlugin.java</span><br>    <span class="hljs-type">Intercepts</span> <span class="hljs-variable">interceptsAnnotation</span> <span class="hljs-operator">=</span> interceptor.getClass().getAnnotation(Intercepts.class);<br>    <span class="hljs-comment">// issue #251</span><br>    <span class="hljs-comment">// å¿…é¡»å¾—æœ‰Interceptsæ³¨è§£ï¼Œæ²¡æœ‰æŠ¥é”™</span><br>    <span class="hljs-keyword">if</span> (interceptsAnnotation == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PluginException</span>(<span class="hljs-string">&quot;No @Intercepts annotation was found in interceptor &quot;</span> + interceptor.getClass().getName());      <br>    &#125;<br>    <span class="hljs-comment">// valueæ˜¯æ•°ç»„å‹ï¼ŒSignatureçš„æ•°ç»„</span><br>    Signature[] sigs = interceptsAnnotation.value();<br>    <span class="hljs-comment">// æ¯ä¸ªclassé‡Œæœ‰å¤šä¸ªMethodéœ€è¦è¢«æ‹¦æˆª,æ‰€ä»¥è¿™ä¹ˆå®šä¹‰</span><br>    Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt;();<br>    <span class="hljs-keyword">for</span> (Signature sig : sigs) &#123;<br>      Set&lt;Method&gt; methods = signatureMap.get(sig.type());<br>      <span class="hljs-keyword">if</span> (methods == <span class="hljs-literal">null</span>) &#123;<br>        methods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Method&gt;();<br>        signatureMap.put(sig.type(), methods);<br>      &#125;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> sig.type().getMethod(sig.method(), sig.args());<br>        methods.add(method);<br>      &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PluginException</span>(<span class="hljs-string">&quot;Could not find method on &quot;</span> + sig.type() + <span class="hljs-string">&quot; named &quot;</span> + sig.method() + <span class="hljs-string">&quot;. Cause: &quot;</span> + e, e);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> signatureMap;<br>  &#125; <br><br>  <span class="hljs-comment">// å–å¾—æ¥å£</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Class&lt;?&gt;[] getAllInterfaces(Class&lt;?&gt; type, Map&lt;Class&lt;?&gt;, Set&lt;Method&gt;&gt; signatureMap) &#123;<br>    Set&lt;Class&lt;?&gt;&gt; interfaces = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Class&lt;?&gt;&gt;();<br>    <span class="hljs-keyword">while</span> (type != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (Class&lt;?&gt; c : type.getInterfaces()) &#123;<br>        <span class="hljs-comment">// è²Œä¼¼åªèƒ½æ‹¦æˆªParameterHandler|ResultSetHandler|StatementHandler|Executor</span><br>        <span class="hljs-comment">// æ‹¦æˆªå…¶ä»–çš„æ— æ•ˆ</span><br>        <span class="hljs-comment">// å½“ç„¶æˆ‘ä»¬å¯ä»¥è¦†ç›–Plugin.wrapæ–¹æ³•ï¼Œè¾¾åˆ°æ‹¦æˆªå…¶ä»–ç±»çš„åŠŸèƒ½</span><br>        <span class="hljs-keyword">if</span> (signatureMap.containsKey(c)) &#123;<br>          interfaces.add(c);<br>        &#125;<br>      &#125;<br>      type = type.getSuperclass();<br>    &#125;<br>    <span class="hljs-keyword">return</span> interfaces.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[interfaces.size()]);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// çœ‹çœ‹å¦‚ä½•æ‹¦æˆª</span><br>      Set&lt;Method&gt; methods = signatureMap.get(method.getDeclaringClass());<br>      <span class="hljs-comment">// çœ‹å“ªäº›æ–¹æ³•éœ€è¦æ‹¦æˆª</span><br>      <span class="hljs-keyword">if</span> (methods != <span class="hljs-literal">null</span> &amp;&amp; methods.contains(method)) &#123;<br>        <span class="hljs-comment">// è°ƒç”¨Interceptor.interceptï¼Œä¹Ÿå³æ’å…¥äº†æˆ‘ä»¬è‡ªå·±çš„é€»è¾‘</span><br>        <span class="hljs-keyword">return</span> interceptor.intercept(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Invocation</span>(target, method, args));<br>      &#125;<br>      <span class="hljs-comment">// æ²¡æœ‰æ‹¦æˆªçš„è¯æ‰§è¡ŒåŸæ¥é€»è¾‘</span><br>      <span class="hljs-keyword">return</span> method.invoke(target, args);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(e);<br>    &#125;<br>  &#125; <br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Invocation"><a href="#Invocation" class="headerlink" title="Invocation"></a>Invocation</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Invocation</span> &#123;<br><br>  <span class="hljs-comment">// è°ƒç”¨çš„å¯¹è±¡</span><br>  <span class="hljs-keyword">private</span> Object target;<br>  <span class="hljs-comment">// è°ƒç”¨çš„æ–¹æ³•</span><br>  <span class="hljs-keyword">private</span> Method method;<br>  <span class="hljs-comment">// å‚æ•°</span><br>  <span class="hljs-keyword">private</span> Object[] args;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">Invocation</span><span class="hljs-params">(Object target, Method method, Object[] args)</span> &#123;<br>    <span class="hljs-built_in">this</span>.target = target;<br>    <span class="hljs-built_in">this</span>.method = method;<br>    <span class="hljs-built_in">this</span>.args = args;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getTarget</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> target;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Method <span class="hljs-title function_">getMethod</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> method;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Object[] getArgs() &#123;<br>    <span class="hljs-keyword">return</span> args;<br>  &#125;<br><br>  <span class="hljs-comment">// ç»§ç»­åšä¸‹å»</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">proceed</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InvocationTargetException, IllegalAccessException &#123;<br>    <span class="hljs-keyword">return</span> method.invoke(target, args);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="InterceptorChain"><a href="#InterceptorChain" class="headerlink" title="InterceptorChain"></a>InterceptorChain</h4><p>Â Â Â Â æ‹¦æˆªå™¨é“¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorChain</span> &#123;<br><br>  <span class="hljs-comment">// å†…éƒ¨å°±æ˜¯ä¸€ä¸ªæ‹¦æˆªå™¨çš„List</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Interceptor&gt; interceptors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Interceptor&gt;();<br><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">pluginAll</span><span class="hljs-params">(Object target)</span> &#123;<br>    <span class="hljs-comment">// å¾ªç¯è°ƒç”¨æ¯ä¸ªInterceptor.pluginæ–¹æ³•</span><br>    <span class="hljs-keyword">for</span> (Interceptor interceptor : interceptors) &#123;<br>      target = interceptor.plugin(target);<br>    &#125;<br>    <span class="hljs-keyword">return</span> target;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptor</span><span class="hljs-params">(Interceptor interceptor)</span> &#123;<br>    interceptors.add(interceptor);<br>  &#125;<br>  <br>  <span class="hljs-keyword">public</span> List&lt;Interceptor&gt; <span class="hljs-title function_">getInterceptors</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Collections.unmodifiableList(interceptors);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>16-executor</title>
    <link href="/2023/08/28/mybatis-source-code/16-executor/"/>
    <url>/2023/08/28/mybatis-source-code/16-executor/</url>
    
    <content type="html"><![CDATA[<h4 id="ExecutionPlaceholder"><a href="#ExecutionPlaceholder" class="headerlink" title="ExecutionPlaceholder"></a>ExecutionPlaceholder</h4><p>Â Â Â Â å ä½ç¬¦,DeferredLoadåˆ¤æ–­æ˜¯å¦èƒ½åŠ è½½æ—¶ç”¨åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ExecutionPlaceholder</span> &#123;<br>  EXECUTION_PLACEHOLDER<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ErrorContext"><a href="#ErrorContext" class="headerlink" title="ErrorContext"></a>ErrorContext</h4><p>Â Â Â Â é”™è¯¯ä¸Šä¸‹æ–‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorContext</span> &#123; <br><br>  <span class="hljs-comment">// è·å¾— \n ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸ä¸€æ ·</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LINE_SEPARATOR</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;line.separator&quot;</span>,<span class="hljs-string">&quot;\n&quot;</span>);<br>  <span class="hljs-comment">// æ¯ä¸ªçº¿ç¨‹ç»™å¼€ä¸€ä¸ªé”™è¯¯ä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢å¤šçº¿ç¨‹é—®é¢˜</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ErrorContext&gt; LOCAL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;ErrorContext&gt;(); <br><br>  <span class="hljs-keyword">private</span> ErrorContext stored;<br>  <span class="hljs-keyword">private</span> String resource;<br>  <span class="hljs-keyword">private</span> String activity;<br>  <span class="hljs-keyword">private</span> String object;<br>  <span class="hljs-keyword">private</span> String message;<br>  <span class="hljs-keyword">private</span> String sql;<br>  <span class="hljs-keyword">private</span> Throwable cause; <br><br>  <span class="hljs-comment">// å•ä¾‹æ¨¡å¼</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">ErrorContext</span><span class="hljs-params">()</span> &#123;<br>  &#125; <br><br>  <span class="hljs-comment">// å·¥å‚æ–¹æ³•ï¼Œå¾—åˆ°ä¸€ä¸ªå®ä¾‹</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ErrorContext <span class="hljs-title function_">instance</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// å› ä¸ºæ˜¯å¤šçº¿ç¨‹ï¼Œæ‰€ä»¥ç”¨äº†ThreadLocal  çº¿ç¨‹å®‰å…¨</span><br>    <span class="hljs-type">ErrorContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> LOCAL.get();<br>    <span class="hljs-comment">// æ‡’æ±‰ å•ä¾‹æ¨¡å¼</span><br>    <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) &#123;<br>      context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorContext</span>();<br>      LOCAL.set(context);<br>    &#125;<br>    <span class="hljs-keyword">return</span> context;<br>  &#125; <br><br>  <span class="hljs-comment">// çœ‹ä»£ç çš„æ„æ€æ˜¯æŠŠErrorContextå­˜èµ·æ¥ä¾›åç”¨ï¼Œå¹¶æŠŠThreadLocalé‡Œçš„ä¸œè¥¿æ¸…ç©ºäº†</span><br>  <span class="hljs-comment">// è¿™é‡Œçš„ä»£ç ä¼¼ä¹æœ‰ç‚¹é—®é¢˜</span><br>  <span class="hljs-comment">// ä¿®å¤ä»£ç å’Œç›¸å…³ä¿¡æ¯åœ¨ä¸‹é¢çš„commitä¸­</span><br>  <span class="hljs-comment">// https://github.com/mybatis/mybatis-3/commit/1e224840c362367d42fa2617581f2446025f7ff4</span><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">store</span><span class="hljs-params">()</span> &#123;<br>    stored = <span class="hljs-built_in">this</span>;<br>    LOCAL.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorContext</span>());<br>    <span class="hljs-keyword">return</span> LOCAL.get();<br>  &#125; <br><br>  <span class="hljs-comment">// åº”è¯¥æ˜¯å’Œstoreç›¸å¯¹åº”çš„æ–¹æ³•ï¼Œstoreæ˜¯å­˜å‚¨èµ·æ¥ï¼Œrecallæ˜¯å¬å›</span><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">recall</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (stored != <span class="hljs-literal">null</span>) &#123;<br>      LOCAL.set(stored);<br>      stored = <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> LOCAL.get();<br>  &#125; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹éƒ½æ˜¯å»ºé€ è€…æ¨¡å¼</span><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">resource</span><span class="hljs-params">(String resource)</span> &#123;<br>    <span class="hljs-built_in">this</span>.resource = resource;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">activity</span><span class="hljs-params">(String activity)</span> &#123;<br>    <span class="hljs-built_in">this</span>.activity = activity;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">object</span><span class="hljs-params">(String object)</span> &#123;<br>    <span class="hljs-built_in">this</span>.object = object;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">message</span><span class="hljs-params">(String message)</span> &#123;<br>    <span class="hljs-built_in">this</span>.message = message;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">sql</span><span class="hljs-params">(String sql)</span> &#123;<br>    <span class="hljs-built_in">this</span>.sql = sql;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">cause</span><span class="hljs-params">(Throwable cause)</span> &#123;<br>    <span class="hljs-built_in">this</span>.cause = cause;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// å…¨éƒ¨æ¸…ç©ºé‡ç½®</span><br>  <span class="hljs-keyword">public</span> ErrorContext <span class="hljs-title function_">reset</span><span class="hljs-params">()</span> &#123;<br>    resource = <span class="hljs-literal">null</span>;<br>    activity = <span class="hljs-literal">null</span>;<br>    object = <span class="hljs-literal">null</span>;<br>    message = <span class="hljs-literal">null</span>;<br>    sql = <span class="hljs-literal">null</span>;<br>    cause = <span class="hljs-literal">null</span>;<br>    LOCAL.remove();<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// æ‰“å°ä¿¡æ¯ä¾›äººé˜…è¯»</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>    <span class="hljs-comment">// message</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.message != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### &quot;</span>);<br>      description.append(<span class="hljs-built_in">this</span>.message);<br>    &#125;<br><br>    <span class="hljs-comment">// resource</span><br>    <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### The error may exist in &quot;</span>);<br>      description.append(resource);<br>    &#125;<br><br>    <span class="hljs-comment">// object</span><br>    <span class="hljs-keyword">if</span> (object != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### The error may involve &quot;</span>);<br>      description.append(object);<br>    &#125;<br><br>    <span class="hljs-comment">// activity</span><br>    <span class="hljs-keyword">if</span> (activity != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### The error occurred while &quot;</span>);<br>      description.append(activity);<br>    &#125;<br><br>    <span class="hljs-comment">// activity</span><br>    <span class="hljs-keyword">if</span> (sql != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### SQL: &quot;</span>);<br>      <span class="hljs-comment">// æŠŠsqlå‹ç¼©åˆ°ä¸€è¡Œé‡Œ</span><br>      description.append(sql.replace(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>).replace(<span class="hljs-string">&#x27;\r&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>).replace(<span class="hljs-string">&#x27;\t&#x27;</span>, <span class="hljs-string">&#x27; &#x27;</span>).trim());<br>    &#125;<br><br>    <span class="hljs-comment">// cause</span><br>    <span class="hljs-keyword">if</span> (cause != <span class="hljs-literal">null</span>) &#123;<br>      description.append(LINE_SEPARATOR);<br>      description.append(<span class="hljs-string">&quot;### Cause: &quot;</span>);<br>      description.append(cause.toString());<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> description.toString();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultExtractor"><a href="#ResultExtractor" class="headerlink" title="ResultExtractor"></a>ResultExtractor</h4><p>Â Â Â Â ç»“æœæŠ½å–å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultExtractor</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Configuration configuration;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResultExtractor</span><span class="hljs-params">(Configuration configuration, ObjectFactory objectFactory)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>  &#125; <br><br>  <span class="hljs-comment">// å¯¹targetTypeä¸ºListã€Collectionå’ŒArrayæ—¶åšè½¬æ¢å¤„ç†</span><br>  <span class="hljs-comment">// å¦åˆ™ï¼Œæ£€æŸ¥å¹¶åªè¿”å›ä¸€é¡¹</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">extractObjectFromList</span><span class="hljs-params">(List&lt;Object&gt; list, Class&lt;?&gt; targetType)</span> &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (targetType != <span class="hljs-literal">null</span> &amp;&amp; targetType.isAssignableFrom(list.getClass())) &#123;<br>      <span class="hljs-comment">// 1.å¦‚æœtargetTypeæ˜¯listï¼Œç›´æ¥è¿”å›list</span><br>      value = list;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (targetType != <span class="hljs-literal">null</span> &amp;&amp; objectFactory.isCollection(targetType)) &#123;<br>      <span class="hljs-comment">// 2.å¦‚æœtargetTypeæ˜¯Collectionï¼Œè¿”å›åŒ…è£…å¥½çš„list</span><br>      value = objectFactory.create(targetType);<br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(value);<br>      metaObject.addAll(list);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (targetType != <span class="hljs-literal">null</span> &amp;&amp; targetType.isArray()) &#123;<br>      <span class="hljs-comment">// 3.å¦‚æœtargetTypeæ˜¯æ•°ç»„ï¼Œåˆ™listè½¬æ•°ç»„</span><br>      Class&lt;?&gt; arrayComponentType = targetType.getComponentType();<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">array</span> <span class="hljs-operator">=</span> Array.newInstance(arrayComponentType, list.size());<br>      <span class="hljs-keyword">if</span> (arrayComponentType.isPrimitive()) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; list.size(); i++) &#123;<br>          Array.set(array, i, list.get(i));<br>        &#125;<br>        value = array;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        value = list.toArray((Object[])array);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 4.å¦åˆ™è¿”å›listçš„ç¬¬0ä¸ªå…ƒç´ </span><br>      <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span> &amp;&amp; list.size() &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Statement returned more than one row, where no more than one was expected.&quot;</span>);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span> &amp;&amp; list.size() == <span class="hljs-number">1</span>) &#123;<br>        value = list.get(<span class="hljs-number">0</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="KeyGenerator"><a href="#KeyGenerator" class="headerlink" title="KeyGenerator"></a>KeyGenerator</h4><p>Â Â Â Â é”®å€¼ç”Ÿæˆå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">KeyGenerator</span> &#123;<br><br>  <span class="hljs-comment">// å®šäº†2ä¸ªå›è°ƒæ–¹æ³•ï¼ŒprocessBefore,processAfter</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBefore</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">processAfter</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="NoKeyGenerator"><a href="#NoKeyGenerator" class="headerlink" title="NoKeyGenerator"></a>NoKeyGenerator</h4><p>Â Â Â Â ä¸ç”¨é”®å€¼ç”Ÿæˆå™¨,MappedStatementæœ‰ä¸€ä¸ªkeyGeneratorå±æ€§ï¼Œé»˜è®¤çš„å°±ç”¨NoKeyGenerator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NoKeyGenerator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">KeyGenerator</span> &#123;<br><br>  <span class="hljs-comment">// éƒ½æ˜¯ç©ºæ–¹æ³•</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBefore</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    <span class="hljs-comment">// Do Nothing</span><br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processAfter</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    <span class="hljs-comment">// Do Nothing</span><br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Jdbc3KeyGenerator"><a href="#Jdbc3KeyGenerator" class="headerlink" title="Jdbc3KeyGenerator"></a>Jdbc3KeyGenerator</h4><p>Â Â Â Â JDBC3é”®å€¼ç”Ÿæˆå™¨,æ ¸å¿ƒæ˜¯ä½¿ç”¨JDBC3çš„Statement.getGeneratedKeys</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Jdbc3KeyGenerator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">KeyGenerator</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBefore</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    <span class="hljs-comment">// do nothing</span><br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processAfter</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    List&lt;Object&gt; parameters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>    parameters.add(parameter);<br>    processBatch(ms, stmt, parameters);<br>  &#125; <br><br>  <span class="hljs-comment">// æ‰¹å¤„ç†</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBatch</span><span class="hljs-params">(MappedStatement ms, Statement stmt, List&lt;Object&gt; parameters)</span> &#123;<br>    <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// æ ¸å¿ƒæ˜¯ä½¿ç”¨JDBC3çš„Statement.getGeneratedKeys</span><br>      rs = stmt.getGeneratedKeys();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">TypeHandlerRegistry</span> <span class="hljs-variable">typeHandlerRegistry</span> <span class="hljs-operator">=</span> configuration.getTypeHandlerRegistry();<br>      <span class="hljs-keyword">final</span> String[] keyProperties = ms.getKeyProperties();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">rsmd</span> <span class="hljs-operator">=</span> rs.getMetaData();<br>      TypeHandler&lt;?&gt;[] typeHandlers = <span class="hljs-literal">null</span>; <br>      <span class="hljs-comment">// ResultSet è¿”å›çš„åˆ—å¤§äºç­‰äºå®šä¹‰çš„è¿”å›åˆ—çš„æ•°é‡</span><br>      <span class="hljs-keyword">if</span> (keyProperties != <span class="hljs-literal">null</span> &amp;&amp; rsmd.getColumnCount() &gt;= keyProperties.length) &#123;<br>        <span class="hljs-keyword">for</span> (Object parameter : parameters) &#123;<br>          <span class="hljs-comment">// there should be one row for each statement (also one for each parameter)</span><br>          <span class="hljs-keyword">if</span> (!rs.next()) &#123;<br>            <span class="hljs-keyword">break</span>;<br>          &#125;<br>          <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaParam</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameter);<br>          <span class="hljs-keyword">if</span> (typeHandlers == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// å…ˆå–å¾—ç±»å‹å¤„ç†å™¨</span><br>            typeHandlers = getTypeHandlers(typeHandlerRegistry, metaParam, keyProperties);<br>          &#125;<br>          <span class="hljs-comment">// å¡«å……é”®å€¼</span><br>          populateKeys(rs, metaParam, keyProperties, typeHandlers);<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error getting generated key or setting result to parameter object. Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (rs != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          rs.close();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-comment">// ignore</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> TypeHandler&lt;?&gt;[] getTypeHandlers(TypeHandlerRegistry typeHandlerRegistry, MetaObject metaParam, String[] keyProperties) &#123;<br>    TypeHandler&lt;?&gt;[] typeHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;[keyProperties.length];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keyProperties.length; i++) &#123;<br>      <span class="hljs-keyword">if</span> (metaParam.hasSetter(keyProperties[i])) &#123;<br>        Class&lt;?&gt; keyPropertyType = metaParam.getSetterType(keyProperties[i]);<br>        TypeHandler&lt;?&gt; th = typeHandlerRegistry.getTypeHandler(keyPropertyType);<br>        typeHandlers[i] = th;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> typeHandlers;<br>  &#125; <br><br>  <span class="hljs-comment">// ç»™keyå±æ€§èµ‹å€¼</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">populateKeys</span><span class="hljs-params">(ResultSet rs, MetaObject metaParam, String[] keyProperties, TypeHandler&lt;?&gt;[] typeHandlers)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keyProperties.length; i++) &#123;<br>      TypeHandler&lt;?&gt; th = typeHandlers[i];<br>      <span class="hljs-keyword">if</span> (th != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> th.getResult(rs, i + <span class="hljs-number">1</span>);<br>        metaParam.setValue(keyProperties[i], value);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SelectKeyGenerator"><a href="#SelectKeyGenerator" class="headerlink" title="SelectKeyGenerator"></a>SelectKeyGenerator</h4><p>Â Â Â Â è‡ªå®šä¹‰æŸ¥è¯¢è¯­å¥KeyGenerator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SelectKeyGenerator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">KeyGenerator</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SELECT_KEY_SUFFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;!selectKey&quot;</span>;<br>  <span class="hljs-comment">// å¯ä»¥è‡ªå®šä¹‰åœ¨sqlè¯­å¥æ‰§è¡Œä¹‹å‰è¿˜æ˜¯ä¹‹åæ‰§è¡ŒselectKeyè¯­å¥</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> executeBefore;<br>  <span class="hljs-keyword">private</span> MappedStatement keyStatement; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SelectKeyGenerator</span><span class="hljs-params">(MappedStatement keyStatement, <span class="hljs-type">boolean</span> executeBefore)</span> &#123;<br>    <span class="hljs-built_in">this</span>.executeBefore = executeBefore;<br>    <span class="hljs-built_in">this</span>.keyStatement = keyStatement;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processBefore</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">if</span> (executeBefore) &#123;<br>      processGeneratedKeys(executor, ms, parameter);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processAfter</span><span class="hljs-params">(Executor executor, MappedStatement ms, Statement stmt, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!executeBefore) &#123;<br>      processGeneratedKeys(executor, ms, parameter);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processGeneratedKeys</span><span class="hljs-params">(Executor executor, MappedStatement ms, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (parameter != <span class="hljs-literal">null</span> &amp;&amp; keyStatement != <span class="hljs-literal">null</span> &amp;&amp; keyStatement.getKeyProperties() != <span class="hljs-literal">null</span>) &#123;<br>        String[] keyProperties = keyStatement.getKeyProperties();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaParam</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameter);<br>        <span class="hljs-keyword">if</span> (keyProperties != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-comment">// Do not close keyExecutor.</span><br>          <span class="hljs-comment">// The transaction will be closed by parent executor.</span><br>          <span class="hljs-type">Executor</span> <span class="hljs-variable">keyExecutor</span> <span class="hljs-operator">=</span> configuration.newExecutor(executor.getTransaction(), ExecutorType.SIMPLE);<br>          List&lt;Object&gt; values = keyExecutor.query(keyStatement, parameter, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER);<br>          <span class="hljs-keyword">if</span> (values.size() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;SelectKey returned no data.&quot;</span>);            <br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (values.size() &gt; <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;SelectKey returned more than one value.&quot;</span>);<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaResult</span> <span class="hljs-operator">=</span> configuration.newMetaObject(values.get(<span class="hljs-number">0</span>));<br>            <span class="hljs-keyword">if</span> (keyProperties.length == <span class="hljs-number">1</span>) &#123;<br>              <span class="hljs-keyword">if</span> (metaResult.hasGetter(keyProperties[<span class="hljs-number">0</span>])) &#123;<br>                setValue(metaParam, keyProperties[<span class="hljs-number">0</span>], metaResult.getValue(keyProperties[<span class="hljs-number">0</span>]));<br>              &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// no getter for the property - maybe just a single value object</span><br>                <span class="hljs-comment">// so try that</span><br>                setValue(metaParam, keyProperties[<span class="hljs-number">0</span>], values.get(<span class="hljs-number">0</span>));<br>              &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              handleMultipleProperties(keyProperties, metaParam, metaResult);<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (ExecutorException e) &#123;<br>      <span class="hljs-keyword">throw</span> e;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error selecting key or setting result to parameter object. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(MetaObject metaParam, String property, Object value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (metaParam.hasSetter(property)) &#123;<br>      metaParam.setValue(property, value);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;No setter found for the keyProperty &#x27;&quot;</span> + property + <span class="hljs-string">&quot;&#x27; in &quot;</span> + metaParam.getOriginalObject().getClass().getName() + <span class="hljs-string">&quot;.&quot;</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMultipleProperties</span><span class="hljs-params">(String[] keyProperties,</span><br><span class="hljs-params">      MetaObject metaParam, MetaObject metaResult)</span> &#123;<br>    String[] keyColumns = keyStatement.getKeyColumns();<br><br>    <span class="hljs-keyword">if</span> (keyColumns == <span class="hljs-literal">null</span> || keyColumns.length == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// no key columns specified, just use the property names </span><br>      <span class="hljs-comment">// æ²¡æœ‰æŒ‡å®škey propertyå¯¹åº”çš„columns</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keyProperties.length; i++) &#123;<br>        setValue(metaParam, keyProperties[i], metaResult.getValue(keyProperties[i]));<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (keyColumns.length != keyProperties.length) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;If SelectKey has key columns, the number must match the number of key properties.&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; keyProperties.length; i++) &#123;<br>        setValue(metaParam, keyProperties[i], metaResult.getValue(keyColumns[i]));<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ProxyFactory"><a href="#ProxyFactory" class="headerlink" title="ProxyFactory"></a>ProxyFactory</h4><p>Â Â Â Â ä»£ç†å·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProxyFactory</span> &#123;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span>;<br><br>  Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultLoader"><a href="#ResultLoader" class="headerlink" title="ResultLoader"></a>ResultLoader</h4><p>Â Â Â Â ç»“æœå»¶è¿ŸåŠ è½½å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultLoader</span> &#123; <br><br>  <span class="hljs-comment">// é…ç½®</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Configuration configuration;<br>  <span class="hljs-comment">// æ‰§è¡Œå™¨</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Executor executor;<br>  <span class="hljs-comment">// æ˜ å°„çš„è¯­å¥</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> MappedStatement mappedStatement;<br>  <span class="hljs-comment">// å‚æ•°</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Object parameterObject;<br>  <span class="hljs-comment">// å®šä¹‰çš„è¿”å›ç±»å‹</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; targetType;<br>  <span class="hljs-comment">// å¯¹è±¡å·¥å‚</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory;<br>  <span class="hljs-comment">// cache key</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> CacheKey cacheKey;<br>  <span class="hljs-comment">// ç»‘å®šçš„sqlï¼ŒåŒ…æ‹¬?å’Œç»‘å®šçš„å‚æ•°</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> BoundSql boundSql;<br>  <span class="hljs-comment">// ç»“æœæŠ½å–å™¨</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ResultExtractor resultExtractor;<br>  <span class="hljs-comment">// åˆ›å»ºçº¿ç¨‹</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> creatorThreadId;<br>  <span class="hljs-comment">// æ˜¯å¦åŠ è½½</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> loaded;<br>  <span class="hljs-comment">// ç»“æœ</span><br>  <span class="hljs-keyword">protected</span> Object resultObject; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResultLoader</span><span class="hljs-params">(Configuration config, Executor executor, MappedStatement mappedStatement, Object parameterObject, Class&lt;?&gt; targetType, CacheKey cacheKey, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = config;<br>    <span class="hljs-built_in">this</span>.executor = executor;<br>    <span class="hljs-built_in">this</span>.mappedStatement = mappedStatement;<br>    <span class="hljs-built_in">this</span>.parameterObject = parameterObject;<br>    <span class="hljs-built_in">this</span>.targetType = targetType;<br>    <span class="hljs-built_in">this</span>.objectFactory = configuration.getObjectFactory();<br>    <span class="hljs-built_in">this</span>.cacheKey = cacheKey;<br>    <span class="hljs-built_in">this</span>.boundSql = boundSql;<br>    <span class="hljs-built_in">this</span>.resultExtractor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultExtractor</span>(configuration, objectFactory);<br>    <span class="hljs-built_in">this</span>.creatorThreadId = Thread.currentThread().getId();<br>  &#125; <br><br>  <span class="hljs-comment">// åŠ è½½ç»“æœ</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">loadResult</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// 1.selectList</span><br>    List&lt;Object&gt; list = selectList();<br>    <span class="hljs-comment">// 2.ResultExtractor.extractObjectFromList</span><br>    resultObject = resultExtractor.extractObjectFromList(list, targetType);<br>    <span class="hljs-keyword">return</span> resultObject;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Executor</span> <span class="hljs-variable">localExecutor</span> <span class="hljs-operator">=</span> executor;<br>    <span class="hljs-comment">// å¦‚æœexecutorå·²ç»è¢«å…³é—­äº†ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„</span><br>    <span class="hljs-keyword">if</span> (Thread.currentThread().getId() != <span class="hljs-built_in">this</span>.creatorThreadId || localExecutor.isClosed()) &#123;<br>      localExecutor = newExecutor();<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å§”æ‰˜ç»™Executor.query</span><br>      <span class="hljs-keyword">return</span> localExecutor.&lt;E&gt; query(mappedStatement, parameterObject, RowBounds.DEFAULT, Executor.NO_RESULT_HANDLER, cacheKey, boundSql);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (localExecutor != executor) &#123;<br>        localExecutor.close(<span class="hljs-literal">false</span>);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> configuration.getEnvironment();<br>    <span class="hljs-keyword">if</span> (environment == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;ResultLoader could not load lazily.  Environment was not configured.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">DataSource</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> environment.getDataSource();<br>    <span class="hljs-keyword">if</span> (ds == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;ResultLoader could not load lazily.  DataSource was not configured.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">transactionFactory</span> <span class="hljs-operator">=</span> environment.getTransactionFactory();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Transaction</span> <span class="hljs-variable">tx</span> <span class="hljs-operator">=</span> transactionFactory.newTransaction(ds, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">// å¦‚æœexecutorå·²ç»è¢«å…³é—­äº†ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„SimpleExecutor</span><br>    <span class="hljs-keyword">return</span> configuration.newExecutor(tx, ExecutorType.SIMPLE);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">wasNull</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> resultObject == <span class="hljs-literal">null</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultLoaderMap"><a href="#ResultLoaderMap" class="headerlink" title="ResultLoaderMap"></a>ResultLoaderMap</h4><p>Â Â Â Â ç»“æœå»¶è¿ŸåŠ è½½å™¨æ˜ å°„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultLoaderMap</span> &#123; <br><br>  <span class="hljs-comment">// åŠ è½½å¯¹åº”çš„hashmap</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, LoadPair&gt; loaderMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, LoadPair&gt;();<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Property which was not loaded yet.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// é™æ€å†…éƒ¨ç±»ï¼ŒåŠ è½½å¯¹</span><br>  <span class="hljs-comment">// å°šæœªåŠ è½½çš„å±æ€§</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadPair</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">20130412</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Name of factory method which returns database connection.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FACTORY_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;getConfiguration&quot;</span>; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Object to check whether we went through serialization..</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">transient</span> <span class="hljs-type">Object</span> <span class="hljs-variable">serializationCheck</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Meta object which sets loaded properties.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> MetaObject metaResultObject; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Result loader which loads unread properties.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// é€šè¿‡ResultLoaderåŠ è½½å±æ€§</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> ResultLoader resultLoader; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Wow, logger.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Log log; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Factory class through which we get database connection.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; configurationFactory; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Name of the unread property.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// å°šæœªåŠ è½½çš„å±æ€§åç§°</span><br>    <span class="hljs-keyword">private</span> String property; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ID of SQL statement which loads the property.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String mappedStatement; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Parameter of the sql statement.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Serializable mappedParameter; <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">LoadPair</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String property, MetaObject metaResultObject, ResultLoader resultLoader)</span> &#123;<br>      <span class="hljs-built_in">this</span>.property = property;<br>      <span class="hljs-built_in">this</span>.metaResultObject = metaResultObject;<br>      <span class="hljs-built_in">this</span>.resultLoader = resultLoader;<br><br>      <span class="hljs-comment">/* Save required information only if original object can be serialized. */</span><br>      <span class="hljs-keyword">if</span> (metaResultObject != <span class="hljs-literal">null</span> &amp;&amp; metaResultObject.getOriginalObject() <span class="hljs-keyword">instanceof</span> Serializable) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">mappedStatementParameter</span> <span class="hljs-operator">=</span> resultLoader.parameterObject;<br><br>        <span class="hljs-comment">/* @todo May the parameter be null? */</span><br>        <span class="hljs-keyword">if</span> (mappedStatementParameter <span class="hljs-keyword">instanceof</span> Serializable) &#123;<br>          <span class="hljs-built_in">this</span>.mappedStatement = resultLoader.mappedStatement.getId();<br>          <span class="hljs-built_in">this</span>.mappedParameter = (Serializable) mappedStatementParameter;<br><br>          <span class="hljs-built_in">this</span>.configurationFactory = resultLoader.configuration.getConfigurationFactory();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-built_in">this</span>.getLogger().debug(<span class="hljs-string">&quot;Property [&quot;</span> + <span class="hljs-built_in">this</span>.property + <span class="hljs-string">&quot;] of [&quot;</span><br>                  + metaResultObject.getOriginalObject().getClass() + <span class="hljs-string">&quot;] cannot be loaded &quot;</span><br>                  + <span class="hljs-string">&quot;after deserialization. Make sure it&#x27;s loaded before serializing &quot;</span><br>                  + <span class="hljs-string">&quot;forenamed object.&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-comment">/* These field should not be null unless the loadpair was serialized.</span><br><span class="hljs-comment">       * Yet in that case this method should not be called. */</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.metaResultObject == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;metaResultObject is null&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.resultLoader == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;resultLoader is null&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-built_in">this</span>.load(<span class="hljs-literal">null</span>);<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-comment">/* These field should not be null unless the loadpair was serialized.</span><br><span class="hljs-comment">       * Yet in that case this method should not be called. */</span><br>      <span class="hljs-comment">// é™¤éloadpairå¯åºåˆ—åŒ–ï¼Œå¦åˆ™ this.metaResultObject å’Œ</span><br>      <span class="hljs-comment">// this.resultLoaderåº”è¯¥éç©º</span><br>      <span class="hljs-comment">// è€Œloadpairå¯åºåˆ—åŒ–æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•ä¸åº”è¯¥è¢«è°ƒç”¨</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.metaResultObject == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;metaResultObject is null&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.resultLoader == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;resultLoader is null&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-built_in">this</span>.load(<span class="hljs-literal">null</span>);<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object userObject)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.metaResultObject == <span class="hljs-literal">null</span> || <span class="hljs-built_in">this</span>.resultLoader == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.mappedParameter == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-comment">// å¯¹åº”æ„é€ å‡½æ•°ä¸­çš„åˆ¤æ–­</span><br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Property [&quot;</span> + <span class="hljs-built_in">this</span>.property + <span class="hljs-string">&quot;] cannot be loaded because &quot;</span><br>                  + <span class="hljs-string">&quot;required parameter of mapped statement [&quot;</span><br>                  + <span class="hljs-built_in">this</span>.mappedStatement + <span class="hljs-string">&quot;] is not serializable.&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Configuration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getConfiguration();<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> config.getMappedStatement(<span class="hljs-built_in">this</span>.mappedStatement);<br>        <span class="hljs-keyword">if</span> (ms == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot lazy load property [&quot;</span> + <span class="hljs-built_in">this</span>.property<br>                  + <span class="hljs-string">&quot;] of deserialized object [&quot;</span> + userObject.getClass()<br>                  + <span class="hljs-string">&quot;] because configuration does not contain statement [&quot;</span><br>                  + <span class="hljs-built_in">this</span>.mappedStatement + <span class="hljs-string">&quot;]&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-built_in">this</span>.metaResultObject = config.newMetaObject(userObject);<br>        <span class="hljs-built_in">this</span>.resultLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoader</span>(config, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClosedExecutor</span>(), ms, <span class="hljs-built_in">this</span>.mappedParameter,<br>                metaResultObject.getSetterType(<span class="hljs-built_in">this</span>.property), <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>      &#125;<br><br>      <span class="hljs-comment">/* We are using a new executor because we may be (and likely are) on a new thread</span><br><span class="hljs-comment">       * and executors aren&#x27;t thread safe. (Is this sufficient?)</span><br><span class="hljs-comment">       *</span><br><span class="hljs-comment">       * A better approach would be making executors thread safe. */</span><br>      <span class="hljs-comment">// å¯èƒ½æ˜¯åœ¨æ–°çš„çº¿ç¨‹ä¸­ï¼Œè€Œexecutorä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ç”¨äº†ä¸€ä¸ªæ–°çš„excutor</span><br>      <span class="hljs-comment">// æ›´å¥½çš„æ–¹æ³•æ˜¯ä½¿å¾—executorsçº¿ç¨‹å®‰å…¨</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.serializationCheck == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ResultLoader</span> <span class="hljs-variable">old</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.resultLoader;<br>        <span class="hljs-built_in">this</span>.resultLoader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoader</span>(old.configuration, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClosedExecutor</span>(), old.mappedStatement,<br>                old.parameterObject, old.targetType, old.cacheKey, old.boundSql);<br>      &#125;<br>      <span class="hljs-comment">// å°±æ˜¯æ„é€ resultLoaderåè®¾ç½®å±æ€§</span><br>      <span class="hljs-built_in">this</span>.metaResultObject.setValue(property, <span class="hljs-built_in">this</span>.resultLoader.loadResult());<br>    &#125; <br><br>    <span class="hljs-comment">// é€šè¿‡åå°„è·å–é…ç½®</span><br>    <span class="hljs-keyword">private</span> Configuration <span class="hljs-title function_">getConfiguration</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.configurationFactory == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as configuration factory was not set.&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-type">Object</span> <span class="hljs-variable">configurationObject</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Method</span> <span class="hljs-variable">factoryMethod</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.configurationFactory.getDeclaredMethod(FACTORY_METHOD);<br>        <span class="hljs-keyword">if</span> (!Modifier.isStatic(factoryMethod.getModifiers())) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as factory method [&quot;</span><br>                  + <span class="hljs-built_in">this</span>.configurationFactory + <span class="hljs-string">&quot;]#[&quot;</span><br>                  + FACTORY_METHOD + <span class="hljs-string">&quot;] is not static.&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!factoryMethod.isAccessible()) &#123;<br>          configurationObject = AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedExceptionAction</span>&lt;Object&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>              <span class="hljs-keyword">try</span> &#123;<br>                factoryMethod.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-keyword">return</span> factoryMethod.invoke(<span class="hljs-literal">null</span>);<br>              &#125; <span class="hljs-keyword">finally</span> &#123;<br>                factoryMethod.setAccessible(<span class="hljs-literal">false</span>);<br>              &#125;<br>            &#125;<br>          &#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          configurationObject = factoryMethod.invoke(<span class="hljs-literal">null</span>);<br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> NoSuchMethodException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as factory class [&quot;</span><br>                + <span class="hljs-built_in">this</span>.configurationFactory + <span class="hljs-string">&quot;] is missing factory method of name [&quot;</span><br>                + FACTORY_METHOD + <span class="hljs-string">&quot;].&quot;</span>, ex);<br>      &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> PrivilegedActionException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as factory method [&quot;</span><br>                + <span class="hljs-built_in">this</span>.configurationFactory + <span class="hljs-string">&quot;]#[&quot;</span><br>                + FACTORY_METHOD + <span class="hljs-string">&quot;] threw an exception.&quot;</span>, ex.getCause());<br>      &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> Exception ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as factory method [&quot;</span><br>                + <span class="hljs-built_in">this</span>.configurationFactory + <span class="hljs-string">&quot;]#[&quot;</span><br>                + FACTORY_METHOD + <span class="hljs-string">&quot;] threw an exception.&quot;</span>, ex);<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (!(configurationObject <span class="hljs-keyword">instanceof</span> Configuration)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot get Configuration as factory method [&quot;</span><br>                + <span class="hljs-built_in">this</span>.configurationFactory + <span class="hljs-string">&quot;]#[&quot;</span><br>                + FACTORY_METHOD + <span class="hljs-string">&quot;] didn&#x27;t return [&quot;</span> + Configuration.class + <span class="hljs-string">&quot;] but [&quot;</span><br>                + (configurationObject == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;null&quot;</span> : configurationObject.getClass()) + <span class="hljs-string">&quot;].&quot;</span>);<br>      &#125;<br><br>      <span class="hljs-keyword">return</span> Configuration.class.cast(configurationObject);<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> Log <span class="hljs-title function_">getLogger</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.log == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-built_in">this</span>.log = LogFactory.getLog(<span class="hljs-built_in">this</span>.getClass());<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.log;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å…³é—­äº†çš„Excutorï¼Œå•¥éƒ½ä¸èƒ½å¹²</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClosedExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ClosedExecutor</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-built_in">super</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isClosed</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Not supported.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Not supported.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Not supported.&quot;</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æŠŠè¦å»¶è¿ŸåŠ è½½çš„å±æ€§è®°åˆ°ResultLoaderMapé‡Œï¼ˆä¸€ä¸ªå“ˆå¸Œè¡¨ï¼‰</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addLoader</span><span class="hljs-params">(String property, MetaObject metaResultObject, ResultLoader resultLoader)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">upperFirst</span> <span class="hljs-operator">=</span> getUppercaseFirstProperty(property);<br>    <span class="hljs-keyword">if</span> (!upperFirst.equalsIgnoreCase(property) &amp;&amp; loaderMap.containsKey(upperFirst)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Nested lazy loaded result property &#x27;&quot;</span> + property +<br>              <span class="hljs-string">&quot;&#x27; for query id &#x27;&quot;</span> + resultLoader.mappedStatement.getId() +<br>              <span class="hljs-string">&quot; already exists in the result map. The leftmost property of all lazy loaded properties must be unique within a result map.&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// keyæ˜¯propertyï¼Œè¿™æ ·å½“å®¢æˆ·ç«¯è°ƒç”¨getteræ¥å–çœŸå®å€¼æ—¶ï¼Œä¼šåˆ¤æ–­è¿™ä¸ªå±æ€§æ˜¯å¦æ˜¯å»¶è¿ŸåŠ è½½å±æ€§ï¼Œæ˜¯æ‰å»åŠ è½½</span><br>    <span class="hljs-comment">// å¯å‚è§CglibProxyFactoryçš„ä»£ç </span><br>    <span class="hljs-comment">//    if (lazyLoader.hasLoader(property)) &#123;</span><br>    <span class="hljs-comment">//        lazyLoader.load(property);</span><br>    <span class="hljs-comment">//    &#125;</span><br>    loaderMap.put(upperFirst, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadPair</span>(property, metaResultObject, resultLoader));<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getUppercaseFirstProperty</span><span class="hljs-params">(String property)</span> &#123;<br>    String[] parts = property.split(<span class="hljs-string">&quot;\\.&quot;</span>);<br>    <span class="hljs-keyword">return</span> parts[<span class="hljs-number">0</span>].toUpperCase(Locale.ENGLISH);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Map&lt;String, LoadPair&gt; <span class="hljs-title function_">getProperties</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, LoadPair&gt;(<span class="hljs-built_in">this</span>.loaderMap);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title function_">getPropertyNames</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> loaderMap.keySet();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> loaderMap.size();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasLoader</span><span class="hljs-params">(String property)</span> &#123;<br>    <span class="hljs-keyword">return</span> loaderMap.containsKey(property.toUpperCase(Locale.ENGLISH));<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">load</span><span class="hljs-params">(String property)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// å…ˆåˆ é™¤keyï¼Œé˜²æ­¢ç¬¬äºŒæ¬¡åˆå»æŸ¥æ•°æ®åº“å°±ä¸å¯¹äº†</span><br>    <span class="hljs-type">LoadPair</span> <span class="hljs-variable">pair</span> <span class="hljs-operator">=</span> loaderMap.remove(property.toUpperCase(Locale.ENGLISH));<br>    <span class="hljs-keyword">if</span> (pair != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// å»æ•°æ®åº“æŸ¥</span><br>      pair.load();<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> Set&lt;String&gt; methodNameSet = loaderMap.keySet();<br>    <span class="hljs-comment">// ä¸ºå•¥è¦è½¬æˆArray...</span><br>    String[] methodNames = methodNameSet.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[methodNameSet.size()]);<br>    <span class="hljs-keyword">for</span> (String methodName : methodNames) &#123;<br>      load(methodName);<br>    &#125;<br>  &#125; <br><br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="WriteReplaceInterface"><a href="#WriteReplaceInterface" class="headerlink" title="WriteReplaceInterface"></a>WriteReplaceInterface</h4><p>Â Â Â Â è¿™ä¸ªæ¥å£åœ¨è¿™ä¸ªç‰ˆæœ¬çš„mybatisä¸­ä¼¼ä¹æ²¡æœ‰ç”¨åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">WriteReplaceInterface</span> &#123;<br><br>  Object <span class="hljs-title function_">writeReplace</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ObjectStreamException;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ProxyFactory-1"><a href="#ProxyFactory-1" class="headerlink" title="ProxyFactory"></a>ProxyFactory</h4><p>Â Â Â Â å»¶è¿ŸåŠ è½½ä»£ç†å·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProxyFactory</span> &#123;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span>;<br><br>  Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="AbstractSerialStateHolder"><a href="#AbstractSerialStateHolder" class="headerlink" title="AbstractSerialStateHolder"></a>AbstractSerialStateHolder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractSerialStateHolder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Externalizable</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8940388717901644661L</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ObjectOutputStream&gt; stream = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;ObjectOutputStream&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] userBeanBytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">private</span> Object userBean;<br>  <span class="hljs-keyword">private</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties;<br>  <span class="hljs-keyword">private</span> ObjectFactory objectFactory;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt;[] constructorArgTypes;<br>  <span class="hljs-keyword">private</span> Object[] constructorArgs;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractSerialStateHolder</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractSerialStateHolder</span><span class="hljs-params">(</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Object userBean,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes,</span><br><span class="hljs-params">          List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-built_in">this</span>.userBean = userBean;<br>    <span class="hljs-built_in">this</span>.unloadedProperties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, ResultLoaderMap.LoadPair&gt;(unloadedProperties);<br>    <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>    <span class="hljs-built_in">this</span>.constructorArgTypes = constructorArgTypes.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[constructorArgTypes.size()]);<br>    <span class="hljs-built_in">this</span>.constructorArgs = constructorArgs.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[constructorArgs.size()]);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeExternal</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ObjectOutput out)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">firstRound</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">baos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>    <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> stream.get();<br>    <span class="hljs-keyword">if</span> (os == <span class="hljs-literal">null</span>) &#123;<br>      os = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(baos);<br>      firstRound = <span class="hljs-literal">true</span>;<br>      stream.set(os);<br>    &#125;<br><br>    os.writeObject(<span class="hljs-built_in">this</span>.userBean);<br>    os.writeObject(<span class="hljs-built_in">this</span>.unloadedProperties);<br>    os.writeObject(<span class="hljs-built_in">this</span>.objectFactory);<br>    os.writeObject(<span class="hljs-built_in">this</span>.constructorArgTypes);<br>    os.writeObject(<span class="hljs-built_in">this</span>.constructorArgs);<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] bytes = baos.toByteArray();<br>    out.writeObject(bytes);<br><br>    <span class="hljs-keyword">if</span> (firstRound) &#123;<br>      stream.remove();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readExternal</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ObjectInput in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> in.readObject();<br>    <span class="hljs-keyword">if</span> (data.getClass().isArray()) &#123;<br>      <span class="hljs-built_in">this</span>.userBeanBytes = (<span class="hljs-type">byte</span>[]) data;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">this</span>.userBean = data;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Object <span class="hljs-title function_">readResolve</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ObjectStreamException &#123;<br>    <span class="hljs-comment">/* Second run */</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.userBean != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.userBeanBytes.length == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.userBean;<br>    &#125;<br><br>    <span class="hljs-comment">/* First run */</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(<span class="hljs-built_in">this</span>.userBeanBytes));<br>      <span class="hljs-built_in">this</span>.userBean = in.readObject();<br>      <span class="hljs-built_in">this</span>.unloadedProperties = (Map&lt;String, ResultLoaderMap.LoadPair&gt;) in.readObject();<br>      <span class="hljs-built_in">this</span>.objectFactory = (ObjectFactory) in.readObject();<br>      <span class="hljs-built_in">this</span>.constructorArgTypes = (Class&lt;?&gt;[]) in.readObject();<br>      <span class="hljs-built_in">this</span>.constructorArgs = (Object[]) in.readObject();<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> IOException ex) &#123;<br>      <span class="hljs-keyword">throw</span> (ObjectStreamException) <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamCorruptedException</span>().initCause(ex);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-keyword">final</span> ClassNotFoundException ex) &#123;<br>      <span class="hljs-keyword">throw</span> (ObjectStreamException) <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidClassException</span>(ex.getLocalizedMessage()).initCause(ex);<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; arrayProps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, ResultLoaderMap.LoadPair&gt;(<span class="hljs-built_in">this</span>.unloadedProperties);<br>    <span class="hljs-keyword">final</span> List&lt;Class&lt;?&gt;&gt; arrayTypes = Arrays.asList(<span class="hljs-built_in">this</span>.constructorArgTypes);<br>    <span class="hljs-keyword">final</span> List&lt;Object&gt; arrayValues = Arrays.asList(<span class="hljs-built_in">this</span>.constructorArgs);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createDeserializationProxy(userBean, arrayProps, objectFactory, arrayTypes, arrayValues);<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Object <span class="hljs-title function_">createDeserializationProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="AbstractEnhancedDeserializationProxy"><a href="#AbstractEnhancedDeserializationProxy" class="headerlink" title="AbstractEnhancedDeserializationProxy"></a>AbstractEnhancedDeserializationProxy</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractEnhancedDeserializationProxy</span> &#123; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FINALIZE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;finalize&quot;</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WRITE_REPLACE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;writeReplace&quot;</span>;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>  <span class="hljs-keyword">private</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties;<br>  <span class="hljs-keyword">private</span> ObjectFactory objectFactory;<br>  <span class="hljs-keyword">private</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes;<br>  <span class="hljs-keyword">private</span> List&lt;Object&gt; constructorArgs;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object reloadingPropertyLock;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> reloadingProperty; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">AbstractEnhancedDeserializationProxy</span><span class="hljs-params">(Class&lt;?&gt; type, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties,</span><br><span class="hljs-params">          ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-built_in">this</span>.type = type;<br>    <span class="hljs-built_in">this</span>.unloadedProperties = unloadedProperties;<br>    <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>    <span class="hljs-built_in">this</span>.constructorArgTypes = constructorArgTypes;<br>    <span class="hljs-built_in">this</span>.constructorArgs = constructorArgs;<br>    <span class="hljs-built_in">this</span>.reloadingPropertyLock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-built_in">this</span>.reloadingProperty = <span class="hljs-literal">false</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object enhanced, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (WRITE_REPLACE_METHOD.equals(methodName)) &#123;<br>        <span class="hljs-keyword">final</span> Object original;<br>        <span class="hljs-keyword">if</span> (constructorArgTypes.isEmpty()) &#123;<br>          original = objectFactory.create(type);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          original = objectFactory.create(type, constructorArgTypes, constructorArgs);<br>        &#125;<br><br>        PropertyCopier.copyBeanProperties(type, enhanced, original);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.newSerialStateHolder(original, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.reloadingPropertyLock) &#123;<br>          <span class="hljs-keyword">if</span> (!FINALIZE_METHOD.equals(methodName) &amp;&amp; PropertyNamer.isProperty(methodName) &amp;&amp; !reloadingProperty) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> PropertyNamer.methodToProperty(methodName);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">propertyKey</span> <span class="hljs-operator">=</span> property.toUpperCase(Locale.ENGLISH);<br>            <span class="hljs-keyword">if</span> (unloadedProperties.containsKey(propertyKey)) &#123;<br>              <span class="hljs-keyword">final</span> ResultLoaderMap.<span class="hljs-type">LoadPair</span> <span class="hljs-variable">loadPair</span> <span class="hljs-operator">=</span> unloadedProperties.remove(propertyKey);<br>              <span class="hljs-keyword">if</span> (loadPair != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                  reloadingProperty = <span class="hljs-literal">true</span>;<br>                  loadPair.load(enhanced);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                  reloadingProperty = <span class="hljs-literal">false</span>;<br>                &#125;<br>              &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">/* I&#x27;m not sure if this case can really happen or is just in tests -</span><br><span class="hljs-comment">                 * we have an unread property but no loadPair to load it. */</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;An attempt has been made to read a not loaded lazy property &#x27;&quot;</span><br>                        + property + <span class="hljs-string">&quot;&#x27; of a disconnected object&quot;</span>);<br>              &#125;<br>            &#125;<br>          &#125;<br><br>          <span class="hljs-keyword">return</span> enhanced;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> AbstractSerialStateHolder <span class="hljs-title function_">newSerialStateHolder</span><span class="hljs-params">(</span><br><span class="hljs-params">          Object userBean,</span><br><span class="hljs-params">          Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties,</span><br><span class="hljs-params">          ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes,</span><br><span class="hljs-params">          List&lt;Object&gt; constructorArgs)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CglibProxyFactory"><a href="#CglibProxyFactory" class="headerlink" title="CglibProxyFactory"></a>CglibProxyFactory</h4><p>Â Â Â Â Cglibå»¶è¿ŸåŠ è½½ä»£ç†å·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibProxyFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ProxyFactory</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(CglibProxyFactory.class);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FINALIZE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;finalize&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WRITE_REPLACE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;writeReplace&quot;</span>; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CglibProxyFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å…ˆæ£€æŸ¥æ˜¯å¦æœ‰Cglib</span><br>      Resources.classForName(<span class="hljs-string">&quot;net.sf.cglib.proxy.Enhancer&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Cannot enable lazy loading because CGLIB is not available. Add CGLIB to your classpath.&quot;</span>, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> EnhancedResultObjectProxyImpl.createProxy(target, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">createDeserializationProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> EnhancedDeserializationProxyImpl.createProxy(target, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span> &#123;<br>      <span class="hljs-comment">// Not Implemented</span><br>  &#125;<br><br>  <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">crateProxy</span><span class="hljs-params">(Class&lt;?&gt; type, Callback callback, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-comment">// æ ¸å¿ƒå°±æ˜¯ç”¨cglibçš„Enhancer</span><br>    <span class="hljs-type">Enhancer</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Enhancer</span>();<br>    enhancer.setCallback(callback);<br>    enhancer.setSuperclass(type);<br>    <span class="hljs-keyword">try</span> &#123;<br>      type.getDeclaredMethod(WRITE_REPLACE_METHOD);<br>      <span class="hljs-comment">// ObjectOutputStream will call writeReplace of objects returned by writeReplace</span><br>      log.debug(WRITE_REPLACE_METHOD + <span class="hljs-string">&quot; method was found on bean &quot;</span> + type + <span class="hljs-string">&quot;, make sure it returns this&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>      enhancer.setInterfaces(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;WriteReplaceInterface.class&#125;);<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>      <span class="hljs-comment">// nothing to do here</span><br>    &#125;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (constructorArgTypes.isEmpty()) &#123;<br>      enhanced = enhancer.create();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      Class&lt;?&gt;[] typesArray = constructorArgTypes.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[constructorArgTypes.size()]);<br>      Object[] valuesArray = constructorArgs.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[constructorArgs.size()]);<br>      enhanced = enhancer.create(typesArray, valuesArray);<br>    &#125;<br>    <span class="hljs-keyword">return</span> enhanced;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedResultObjectProxyImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>    <span class="hljs-keyword">private</span> ResultLoaderMap lazyLoader;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> aggressive;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; lazyLoadTriggerMethods;<br>    <span class="hljs-keyword">private</span> ObjectFactory objectFactory;<br>    <span class="hljs-keyword">private</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes;<br>    <span class="hljs-keyword">private</span> List&lt;Object&gt; constructorArgs; <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">EnhancedResultObjectProxyImpl</span><span class="hljs-params">(Class&lt;?&gt; type, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-built_in">this</span>.type = type;<br>      <span class="hljs-built_in">this</span>.lazyLoader = lazyLoader;<br>      <span class="hljs-built_in">this</span>.aggressive = configuration.isAggressiveLazyLoading();<br>      <span class="hljs-built_in">this</span>.lazyLoadTriggerMethods = configuration.getLazyLoadTriggerMethods();<br>      <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>      <span class="hljs-built_in">this</span>.constructorArgTypes = constructorArgTypes;<br>      <span class="hljs-built_in">this</span>.constructorArgs = constructorArgs;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; type = target.getClass();<br>      <span class="hljs-type">EnhancedResultObjectProxyImpl</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnhancedResultObjectProxyImpl</span>(type, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> crateProxy(type, callback, constructorArgTypes, constructorArgs);<br>      PropertyCopier.copyBeanProperties(type, target, enhanced);<br>      <span class="hljs-keyword">return</span> enhanced;<br>    &#125; <br><br>    <span class="hljs-comment">// cglibæ‹¦æˆªæ–¹æ³•</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object enhanced, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (lazyLoader) &#123;<br>          <span class="hljs-keyword">if</span> (WRITE_REPLACE_METHOD.equals(methodName)) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">original</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (constructorArgTypes.isEmpty()) &#123;<br>              original = objectFactory.create(type);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              original = objectFactory.create(type, constructorArgTypes, constructorArgs);<br>            &#125;<br>            PropertyCopier.copyBeanProperties(type, enhanced, original);<br>            <span class="hljs-keyword">if</span> (lazyLoader.size() &gt; <span class="hljs-number">0</span>) &#123;<br>              <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CglibSerialStateHolder</span>(original, lazyLoader.getProperties(), objectFactory, constructorArgTypes, constructorArgs);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-keyword">return</span> original;<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// è¿™é‡Œæ˜¯å…³é”®ï¼Œå»¶è¿ŸåŠ è½½å°±æ˜¯è°ƒç”¨ResultLoaderMap.loadAll()</span><br>            <span class="hljs-keyword">if</span> (lazyLoader.size() &gt; <span class="hljs-number">0</span> &amp;&amp; !FINALIZE_METHOD.equals(methodName)) &#123;<br>              <span class="hljs-keyword">if</span> (aggressive || lazyLoadTriggerMethods.contains(methodName)) &#123;<br>                lazyLoader.loadAll();<br>              &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (PropertyNamer.isProperty(methodName)) &#123;<br>                  <span class="hljs-comment">// æˆ–è€…è°ƒç”¨ResultLoaderMap.load()</span><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> PropertyNamer.methodToProperty(methodName);<br>                <span class="hljs-keyword">if</span> (lazyLoader.hasLoader(property)) &#123;<br>                  lazyLoader.load(property);<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> methodProxy.invokeSuper(enhanced, args);<br>      &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// è¿™ä¸ªä»£ç†åˆ¤æ–­æ–¹æ³•åç§°æ˜¯ WRITE_REPLACE_METHODï¼Œåˆ™è¿”å› AbstractSerialStateHolder</span><br>  <span class="hljs-comment">// å¦åˆ™è¿›è¡Œå»¶è¿ŸåŠ è½½</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedDeserializationProxyImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractEnhancedDeserializationProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodInterceptor</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">EnhancedDeserializationProxyImpl</span><span class="hljs-params">(Class&lt;?&gt; type, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-built_in">super</span>(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; type = target.getClass();<br>      <span class="hljs-type">EnhancedDeserializationProxyImpl</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnhancedDeserializationProxyImpl</span>(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> crateProxy(type, callback, constructorArgTypes, constructorArgs);<br>      PropertyCopier.copyBeanProperties(type, target, enhanced);<br>      <span class="hljs-keyword">return</span> enhanced;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(Object enhanced, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.invoke(enhanced, method, args);<br>      <span class="hljs-keyword">return</span> (o <span class="hljs-keyword">instanceof</span> AbstractSerialStateHolder) ? o : methodProxy.invokeSuper(o, args);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AbstractSerialStateHolder <span class="hljs-title function_">newSerialStateHolder</span><span class="hljs-params">(Object userBean, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CglibSerialStateHolder</span>(userBean, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CglibSerialStateHolder"><a href="#CglibSerialStateHolder" class="headerlink" title="CglibSerialStateHolder"></a>CglibSerialStateHolder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CglibSerialStateHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSerialStateHolder</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8940388717901644661L</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CglibSerialStateHolder</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CglibSerialStateHolder</span><span class="hljs-params">(</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Object userBean,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes,</span><br><span class="hljs-params">          List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-built_in">super</span>(userBean, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createDeserializationProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CglibProxyFactory</span>().createDeserializationProxy(target, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="JavassistProxyFactory"><a href="#JavassistProxyFactory" class="headerlink" title="JavassistProxyFactory"></a>JavassistProxyFactory</h4><p>Â Â Â Â Javassistå»¶è¿ŸåŠ è½½ä»£ç†å·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavassistProxyFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">org</span>.apache.ibatis.executor.loader.ProxyFactory &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(JavassistProxyFactory.class);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FINALIZE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;finalize&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">WRITE_REPLACE_METHOD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;writeReplace&quot;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JavassistProxyFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//å…ˆæ£€æŸ¥æ˜¯å¦æœ‰javassist</span><br>      Resources.classForName(<span class="hljs-string">&quot;javassist.util.proxy.ProxyFactory&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Cannot enable lazy loading because Javassist is not available. Add Javassist to your classpath.&quot;</span>, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> EnhancedResultObjectProxyImpl.createProxy(target, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">createDeserializationProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> EnhancedDeserializationProxyImpl.createProxy(target, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span> &#123;<br>      <span class="hljs-comment">// Not Implemented</span><br>  &#125;<br><br>  <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">crateProxy</span><span class="hljs-params">(Class&lt;?&gt; type, MethodHandler callback, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br><br>    <span class="hljs-comment">// æ ¸å¿ƒå°±æ˜¯ç”¨javassistçš„ProxyFactory,æ²¡å•¥å¯è¯´çš„ï¼Œä¸‹é¢é€»è¾‘éƒ½æ˜¯cglibçš„ç¿»ç‰ˆ</span><br>    <span class="hljs-type">ProxyFactory</span> <span class="hljs-variable">enhancer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyFactory</span>();<br>    enhancer.setSuperclass(type);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      type.getDeclaredMethod(WRITE_REPLACE_METHOD);<br>      <span class="hljs-comment">// ObjectOutputStream will call writeReplace of objects returned by writeReplace</span><br>      log.debug(WRITE_REPLACE_METHOD + <span class="hljs-string">&quot; method was found on bean &quot;</span> + type + <span class="hljs-string">&quot;, make sure it returns this&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>      enhancer.setInterfaces(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;WriteReplaceInterface.class&#125;);<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>      <span class="hljs-comment">// nothing to do here</span><br>    &#125;<br><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    Class&lt;?&gt;[] typesArray = constructorArgTypes.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[constructorArgTypes.size()]);<br>    Object[] valuesArray = constructorArgs.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[constructorArgs.size()]);<br>    <span class="hljs-keyword">try</span> &#123;<br>      enhanced = enhancer.create(typesArray, valuesArray);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error creating lazy proxy.  Cause: &quot;</span> + e, e);<br>    &#125;<br>    ((Proxy) enhanced).setHandler(callback);<br>    <span class="hljs-keyword">return</span> enhanced;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedResultObjectProxyImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodHandler</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>    <span class="hljs-keyword">private</span> ResultLoaderMap lazyLoader;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> aggressive;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; lazyLoadTriggerMethods;<br>    <span class="hljs-keyword">private</span> ObjectFactory objectFactory;<br>    <span class="hljs-keyword">private</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes;<br>    <span class="hljs-keyword">private</span> List&lt;Object&gt; constructorArgs;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">EnhancedResultObjectProxyImpl</span><span class="hljs-params">(Class&lt;?&gt; type, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-built_in">this</span>.type = type;<br>      <span class="hljs-built_in">this</span>.lazyLoader = lazyLoader;<br>      <span class="hljs-built_in">this</span>.aggressive = configuration.isAggressiveLazyLoading();<br>      <span class="hljs-built_in">this</span>.lazyLoadTriggerMethods = configuration.getLazyLoadTriggerMethods();<br>      <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>      <span class="hljs-built_in">this</span>.constructorArgTypes = constructorArgTypes;<br>      <span class="hljs-built_in">this</span>.constructorArgs = constructorArgs;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, ResultLoaderMap lazyLoader, Configuration configuration, ObjectFactory objectFactory, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; type = target.getClass();<br>      <span class="hljs-type">EnhancedResultObjectProxyImpl</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnhancedResultObjectProxyImpl</span>(type, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> crateProxy(type, callback, constructorArgTypes, constructorArgs);<br>      PropertyCopier.copyBeanProperties(type, target, enhanced);<br>      <span class="hljs-keyword">return</span> enhanced;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object enhanced, Method method, Method methodProxy, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (lazyLoader) &#123;<br>          <span class="hljs-keyword">if</span> (WRITE_REPLACE_METHOD.equals(methodName)) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">original</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (constructorArgTypes.isEmpty()) &#123;<br>              original = objectFactory.create(type);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              original = objectFactory.create(type, constructorArgTypes, constructorArgs);<br>            &#125;<br>            PropertyCopier.copyBeanProperties(type, enhanced, original);<br>            <span class="hljs-keyword">if</span> (lazyLoader.size() &gt; <span class="hljs-number">0</span>) &#123;<br>              <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavassistSerialStateHolder</span>(original, lazyLoader.getProperties(), objectFactory, constructorArgTypes, constructorArgs);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-keyword">return</span> original;<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (lazyLoader.size() &gt; <span class="hljs-number">0</span> &amp;&amp; !FINALIZE_METHOD.equals(methodName)) &#123;<br>              <span class="hljs-keyword">if</span> (aggressive || lazyLoadTriggerMethods.contains(methodName)) &#123;<br>                lazyLoader.loadAll();<br>              &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (PropertyNamer.isProperty(methodName)) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> PropertyNamer.methodToProperty(methodName);<br>                <span class="hljs-keyword">if</span> (lazyLoader.hasLoader(property)) &#123;<br>                  lazyLoader.load(property);<br>                &#125;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> methodProxy.invoke(enhanced, args);<br>      &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedDeserializationProxyImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractEnhancedDeserializationProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MethodHandler</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">EnhancedDeserializationProxyImpl</span><span class="hljs-params">(Class&lt;?&gt; type, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-built_in">super</span>(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">createProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; type = target.getClass();<br>      <span class="hljs-type">EnhancedDeserializationProxyImpl</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnhancedDeserializationProxyImpl</span>(type, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">enhanced</span> <span class="hljs-operator">=</span> crateProxy(type, callback, constructorArgTypes, constructorArgs);<br>      PropertyCopier.copyBeanProperties(type, target, enhanced);<br>      <span class="hljs-keyword">return</span> enhanced;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object enhanced, Method method, Method methodProxy, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.invoke(enhanced, method, args);<br>      <span class="hljs-keyword">return</span> (o <span class="hljs-keyword">instanceof</span> AbstractSerialStateHolder) ? o : methodProxy.invoke(o, args);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AbstractSerialStateHolder <span class="hljs-title function_">newSerialStateHolder</span><span class="hljs-params">(Object userBean, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">            List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavassistSerialStateHolder</span>(userBean, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>    &#125;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="JavassistSerialStateHolder"><a href="#JavassistSerialStateHolder" class="headerlink" title="JavassistSerialStateHolder"></a>JavassistSerialStateHolder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JavassistSerialStateHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSerialStateHolder</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8940388717901644661L</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JavassistSerialStateHolder</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JavassistSerialStateHolder</span><span class="hljs-params">(</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Object userBean,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties,</span><br><span class="hljs-params">          <span class="hljs-keyword">final</span> ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes,</span><br><span class="hljs-params">          List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-built_in">super</span>(userBean, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createDeserializationProxy</span><span class="hljs-params">(Object target, Map&lt;String, ResultLoaderMap.LoadPair&gt; unloadedProperties, ObjectFactory objectFactory,</span><br><span class="hljs-params">          List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JavassistProxyFactory</span>().createDeserializationProxy(target, unloadedProperties, objectFactory, constructorArgTypes, constructorArgs);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ParameterHandler"><a href="#ParameterHandler" class="headerlink" title="ParameterHandler"></a>ParameterHandler</h4><p>Â Â Â Â å‚æ•°å¤„ç†å™¨,å…¶å®ç°ç±»DefaultParameterHandlerå·²åœ¨scriptingæ¨¡å—è®²è¿‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ParameterHandler</span> &#123;<br><br>  <span class="hljs-comment">// å¾—åˆ°å‚æ•°</span><br>  Object <span class="hljs-title function_">getParameterObject</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">// è®¾ç½®å‚æ•°</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameters</span><span class="hljs-params">(PreparedStatement ps)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DefaultResultHandler"><a href="#DefaultResultHandler" class="headerlink" title="DefaultResultHandler"></a>DefaultResultHandler</h4><p>Â Â Â Â é»˜è®¤ç»“æœå¤„ç†å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultResultHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResultHandler</span> &#123;<br><br>  <span class="hljs-comment">// å†…éƒ¨å®ç°æ˜¯å­˜äº†ä¸€ä¸ªList</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Object&gt; list;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultResultHandler</span><span class="hljs-params">()</span> &#123;<br>    list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>  &#125;<br><br>  <span class="hljs-comment">// ä½†ä¸ä¸€å®šæ˜¯ArrayList,ä¹Ÿå¯ä»¥é€šè¿‡ObjectFactoryæ¥äº§ç”Ÿç‰¹å®šçš„List</span><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultResultHandler</span><span class="hljs-params">(ObjectFactory objectFactory)</span> &#123;<br>    list = objectFactory.create(List.class);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResult</span><span class="hljs-params">(ResultContext context)</span> &#123;<br>    <span class="hljs-comment">// å¤„ç†å¾ˆç®€å•ï¼Œå°±æ˜¯æŠŠè®°å½•åŠ å…¥List</span><br>    list.add(context.getResultObject());<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">getResultList</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> list;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DefaultResultContext"><a href="#DefaultResultContext" class="headerlink" title="DefaultResultContext"></a>DefaultResultContext</h4><p>Â Â Â Â é»˜è®¤ç»“æœä¸Šä¸‹æ–‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultResultContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResultContext</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Object resultObject;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> resultCount;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> stopped;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultResultContext</span><span class="hljs-params">()</span> &#123;<br>    resultObject = <span class="hljs-literal">null</span>;<br>    resultCount = <span class="hljs-number">0</span>;<br>    stopped = <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getResultObject</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> resultObject;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getResultCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> resultCount;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStopped</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> stopped;<br>  &#125;<br><br>  <span class="hljs-comment">// åº”è¯¥æ˜¯æ¯æ¬¡è°ƒç”¨nextResultObjectè¿™ä¸ªæ–¹æ³•ï¼Œè¿™æ ·å†…éƒ¨countå°±åŠ 1</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nextResultObject</span><span class="hljs-params">(Object resultObject)</span> &#123;<br>    resultCount++;<br>    <span class="hljs-built_in">this</span>.resultObject = resultObject;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.stopped = <span class="hljs-literal">true</span>;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DefaultMapResultHandler"><a href="#DefaultMapResultHandler" class="headerlink" title="DefaultMapResultHandler"></a>DefaultMapResultHandler</h4><p>Â Â Â Â é»˜è®¤Mapç»“æœå¤„ç†å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultMapResultHandler</span>&lt;K, V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResultHandler</span> &#123;<br><br>  <span class="hljs-comment">// å†…éƒ¨å®ç°æ˜¯å­˜äº†ä¸€ä¸ªMap</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;K, V&gt; mappedResults;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String mapKey;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectWrapperFactory objectWrapperFactory;<br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultMapResultHandler</span><span class="hljs-params">(String mapKey, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory)</span> &#123;<br>    <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>    <span class="hljs-built_in">this</span>.objectWrapperFactory = objectWrapperFactory;<br>    <span class="hljs-built_in">this</span>.mappedResults = objectFactory.create(Map.class);<br>    <span class="hljs-built_in">this</span>.mapKey = mapKey;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResult</span><span class="hljs-params">(ResultContext context)</span> &#123;<br>    <span class="hljs-comment">// TODO is that assignment always true?</span><br>    <span class="hljs-comment">// å¾—åˆ°ä¸€æ¡è®°å½•</span><br>    <span class="hljs-comment">// è¿™è¾¹é»„è‰²è­¦å‘Šæ²¡æ³•å»æ‰äº†ï¼Ÿå› ä¸ºè¿”å›Objectå‹</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) context.getResultObject();<br>    <span class="hljs-comment">// MetaObject.forObject,åŒ…è£…ä¸€ä¸‹è®°å½•</span><br>    <span class="hljs-comment">// MetaObjectæ˜¯ç”¨åå°„æ¥åŒ…è£…å„ç§ç±»å‹</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">mo</span> <span class="hljs-operator">=</span> MetaObject.forObject(value, objectFactory, objectWrapperFactory);<br>    <span class="hljs-comment">// TODO is that assignment always true?</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) mo.getValue(mapKey);<br>    mappedResults.put(key, value);<br>    <span class="hljs-comment">// è¿™ä¸ªç±»ä¸»è¦ç›®çš„æ˜¯æŠŠå¾—åˆ°çš„Listè½¬ä¸ºMap</span><br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Map&lt;K, V&gt; <span class="hljs-title function_">getMappedResults</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> mappedResults;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultSetHandler"><a href="#ResultSetHandler" class="headerlink" title="ResultSetHandler"></a>ResultSetHandler</h4><p>Â Â Â Â ç»“æœé›†å¤„ç†å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResultSetHandler</span> &#123;<br><br>  <span class="hljs-comment">// å¤„ç†ç»“æœé›†</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">handleResultSets</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// å¤„ç†OUTå‚æ•°</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOutputParameters</span><span class="hljs-params">(CallableStatement cs)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultSetWrapper"><a href="#ResultSetWrapper" class="headerlink" title="ResultSetWrapper"></a>ResultSetWrapper</h4><p>Â Â Â Â ResultSetåŒ…è£…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultSetWrapper</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResultSet resultSet;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeHandlerRegistry typeHandlerRegistry;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; columnNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; classNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;JdbcType&gt; jdbcTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;JdbcType&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;&gt; typeHandlerMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;&gt;();<br>  <span class="hljs-keyword">private</span> Map&lt;String, List&lt;String&gt;&gt; mappedColumnNamesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, List&lt;String&gt;&gt;();<br>  <span class="hljs-keyword">private</span> Map&lt;String, List&lt;String&gt;&gt; unMappedColumnNamesMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, List&lt;String&gt;&gt;(); <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResultSetWrapper</span><span class="hljs-params">(ResultSet rs, Configuration configuration)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-built_in">super</span>();<br>    <span class="hljs-built_in">this</span>.typeHandlerRegistry = configuration.getTypeHandlerRegistry();<br>    <span class="hljs-built_in">this</span>.resultSet = rs;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> rs.getMetaData();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">columnCount</span> <span class="hljs-operator">=</span> metaData.getColumnCount();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= columnCount; i++) &#123;<br>      columnNames.add(configuration.isUseColumnLabel() ? metaData.getColumnLabel(i) : metaData.getColumnName(i));<br>      jdbcTypes.add(JdbcType.forCode(metaData.getColumnType(i)));<br>      classNames.add(metaData.getColumnClassName(i));<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Gets the type handler to use when reading the result set.</span><br><span class="hljs-comment">   * Tries to get from the TypeHandlerRegistry by searching for the property type.</span><br><span class="hljs-comment">   * If not found it gets the column JDBC type and tries to get a handler for it.</span><br><span class="hljs-comment">   * </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> propertyType</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> columnName</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> TypeHandler&lt;?&gt; getTypeHandler(Class&lt;?&gt; propertyType, String columnName) &#123;<br>    TypeHandler&lt;?&gt; handler = <span class="hljs-literal">null</span>; <br>    <span class="hljs-comment">// åˆ—åå¯¹åº”çš„å±æ€§ç±»å‹å’ŒTypeHandler</span><br>    <span class="hljs-comment">// è¿™é‡Œè€ƒè™‘åˆ°äº†åœ¨ä¸åŒçš„statementä¸­åˆ—åé‡å¤ï¼Œå±æ€§ç±»å‹ä¸åŒçš„é—®é¢˜</span><br>    Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; columnHandlers = typeHandlerMap.get(columnName);<br>    <span class="hljs-keyword">if</span> (columnHandlers == <span class="hljs-literal">null</span>) &#123;<br>      columnHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;();<br>      typeHandlerMap.put(columnName, columnHandlers);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      handler = columnHandlers.get(propertyType);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>      handler = typeHandlerRegistry.getTypeHandler(propertyType);<br>      <span class="hljs-comment">// Replicate logic of UnknownTypeHandler#resolveTypeHandler</span><br>      <span class="hljs-comment">// See issue #59 comment 10</span><br>      <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span> || handler <span class="hljs-keyword">instanceof</span> UnknownTypeHandler) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> columnNames.indexOf(columnName);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> jdbcTypes.get(index);<br>        <span class="hljs-keyword">final</span> Class&lt;?&gt; javaType = resolveClass(classNames.get(index));<br>        <span class="hljs-keyword">if</span> (javaType != <span class="hljs-literal">null</span> &amp;&amp; jdbcType != <span class="hljs-literal">null</span>) &#123;<br>          handler = typeHandlerRegistry.getTypeHandler(javaType, jdbcType);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (javaType != <span class="hljs-literal">null</span>) &#123;<br>          handler = typeHandlerRegistry.getTypeHandler(javaType);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (jdbcType != <span class="hljs-literal">null</span>) &#123;<br>          handler = typeHandlerRegistry.getTypeHandler(jdbcType);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span> || handler <span class="hljs-keyword">instanceof</span> UnknownTypeHandler) &#123;<br>        handler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectTypeHandler</span>();<br>      &#125;<br>      columnHandlers.put(propertyType, handler);<br>    &#125;<br>    <span class="hljs-keyword">return</span> handler;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; resolveClass(String className) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> Resources.classForName(className);<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getMappedColumnNames</span><span class="hljs-params">(ResultMap resultMap, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;String&gt; mappedColumnNames = mappedColumnNamesMap.get(getMapKey(resultMap, columnPrefix));<br>    <span class="hljs-keyword">if</span> (mappedColumnNames == <span class="hljs-literal">null</span>) &#123;<br>      loadMappedAndUnmappedColumnNames(resultMap, columnPrefix);<br>      mappedColumnNames = mappedColumnNamesMap.get(getMapKey(resultMap, columnPrefix));<br>    &#125;<br>    <span class="hljs-keyword">return</span> mappedColumnNames;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMapKey</span><span class="hljs-params">(ResultMap resultMap, String columnPrefix)</span> &#123;<br>    <span class="hljs-keyword">return</span> resultMap.getId() + <span class="hljs-string">&quot;:&quot;</span> + columnPrefix;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadMappedAndUnmappedColumnNames</span><span class="hljs-params">(ResultMap resultMap, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;String&gt; mappedColumnNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; unmappedColumnNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">upperColumnPrefix</span> <span class="hljs-operator">=</span> columnPrefix == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : columnPrefix.toUpperCase(Locale.ENGLISH);<br>    <span class="hljs-keyword">final</span> Set&lt;String&gt; mappedColumns = prependPrefixes(resultMap.getMappedColumns(), upperColumnPrefix);<br>    <span class="hljs-keyword">for</span> (String columnName : columnNames) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">upperColumnName</span> <span class="hljs-operator">=</span> columnName.toUpperCase(Locale.ENGLISH);<br>      <span class="hljs-keyword">if</span> (mappedColumns.contains(upperColumnName)) &#123;<br>        mappedColumnNames.add(upperColumnName);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        unmappedColumnNames.add(columnName);<br>      &#125;<br>    &#125; <br>    <span class="hljs-comment">// è¿™é‡Œçš„æ ¹æ®resultMapçš„mappedColumnså±æ€§åˆ¤æ–­æ˜ å°„çš„åˆ—å</span><br>    mappedColumnNamesMap.put(getMapKey(resultMap, columnPrefix), mappedColumnNames);<br>    unMappedColumnNamesMap.put(getMapKey(resultMap, columnPrefix), unmappedColumnNames);<br>  &#125; <br><br>  <span class="hljs-comment">// æœªåˆ—ååŠ ä¸Šå‰ç¼€</span><br>  <span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">prependPrefixes</span><span class="hljs-params">(Set&lt;String&gt; columnNames, String prefix)</span> &#123;<br>    <span class="hljs-keyword">if</span> (columnNames == <span class="hljs-literal">null</span> || columnNames.isEmpty() || prefix == <span class="hljs-literal">null</span> || prefix.length() == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">return</span> columnNames;<br>    &#125;<br>    <span class="hljs-keyword">final</span> Set&lt;String&gt; prefixed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();<br>    <span class="hljs-keyword">for</span> (String columnName : columnNames) &#123;<br>      prefixed.add(prefix + columnName);<br>    &#125;<br>    <span class="hljs-keyword">return</span> prefixed;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getUnmappedColumnNames</span><span class="hljs-params">(ResultMap resultMap, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;String&gt; unMappedColumnNames = unMappedColumnNamesMap.get(getMapKey(resultMap, columnPrefix));<br>    <span class="hljs-keyword">if</span> (unMappedColumnNames == <span class="hljs-literal">null</span>) &#123;<br>      loadMappedAndUnmappedColumnNames(resultMap, columnPrefix);<br>      unMappedColumnNames = unMappedColumnNamesMap.get(getMapKey(resultMap, columnPrefix));<br>    &#125;<br>    <span class="hljs-keyword">return</span> unMappedColumnNames;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DefaultResultSetHandler"><a href="#DefaultResultSetHandler" class="headerlink" title="DefaultResultSetHandler"></a>DefaultResultSetHandler</h4><p>Â Â Â Â é»˜è®¤ç»“æœé›†å¤„ç†å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultResultSetHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResultSetHandler</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">NO_VALUE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor executor;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Configuration configuration;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MappedStatement mappedStatement;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RowBounds rowBounds;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ParameterHandler parameterHandler;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResultHandler resultHandler;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BoundSql boundSql;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeHandlerRegistry typeHandlerRegistry;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory;<br><br>  <span class="hljs-comment">// nested resultmaps</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;CacheKey, Object&gt; nestedResultObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;CacheKey, Object&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;CacheKey, Object&gt; ancestorObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;CacheKey, Object&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; ancestorColumnPrefix = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br><br>  <span class="hljs-comment">// multiple resultsets</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, ResultMapping&gt; nextResultMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, ResultMapping&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;CacheKey, List&lt;PendingRelation&gt;&gt; pendingRelations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;CacheKey, List&lt;PendingRelation&gt;&gt;();<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PendingRelation</span> &#123;<br>    <span class="hljs-keyword">public</span> MetaObject metaObject;<br>    <span class="hljs-keyword">public</span> ResultMapping propertyMapping;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultResultSetHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, ParameterHandler parameterHandler, ResultHandler resultHandler, BoundSql boundSql,</span><br><span class="hljs-params">      RowBounds rowBounds)</span> &#123;<br>    <span class="hljs-built_in">this</span>.executor = executor;<br>    <span class="hljs-built_in">this</span>.configuration = mappedStatement.getConfiguration();<br>    <span class="hljs-built_in">this</span>.mappedStatement = mappedStatement;<br>    <span class="hljs-built_in">this</span>.rowBounds = rowBounds;<br>    <span class="hljs-built_in">this</span>.parameterHandler = parameterHandler;<br>    <span class="hljs-built_in">this</span>.boundSql = boundSql;<br>    <span class="hljs-built_in">this</span>.typeHandlerRegistry = configuration.getTypeHandlerRegistry();<br>    <span class="hljs-built_in">this</span>.objectFactory = configuration.getObjectFactory();<br>    <span class="hljs-built_in">this</span>.resultHandler = resultHandler;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOutputParameters</span><span class="hljs-params">(CallableStatement cs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> parameterHandler.getParameterObject();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaParam</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameterObject);<br>    <span class="hljs-keyword">final</span> List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();<br>    <span class="hljs-comment">// å¾ªç¯å¤„ç†æ¯ä¸ªå‚æ•°</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameterMappings.size(); i++) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ParameterMapping</span> <span class="hljs-variable">parameterMapping</span> <span class="hljs-operator">=</span> parameterMappings.get(i);<br>      <span class="hljs-comment">// åªå¤„ç†OUT|INOUT</span><br>      <span class="hljs-keyword">if</span> (parameterMapping.getMode() == ParameterMode.OUT || parameterMapping.getMode() == ParameterMode.INOUT) &#123;<br>        <span class="hljs-keyword">if</span> (ResultSet.class.equals(parameterMapping.getJavaType())) &#123;<br>          <span class="hljs-comment">// å¦‚æœæ˜¯ResultSetå‹(æ¸¸æ ‡)</span><br>          <span class="hljs-comment">// #&#123;result, jdbcType=CURSOR, mode=OUT, javaType=ResultSet, resultMap=userResultMap&#125;</span><br>          <span class="hljs-comment">// å…ˆç”¨CallableStatement.getObjectå–å¾—è¿™ä¸ªæ¸¸æ ‡ï¼Œä½œä¸ºå‚æ•°ä¼ è¿›å»</span><br>          handleRefCursorOutputParameter((ResultSet) cs.getObject(i + <span class="hljs-number">1</span>), parameterMapping, metaParam);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// å¦åˆ™æ˜¯æ™®é€šå‹ï¼Œæ ¸å¿ƒå°±æ˜¯CallableStatement.getXXXå–å¾—å€¼</span><br>          <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = parameterMapping.getTypeHandler();<br>          metaParam.setValue(parameterMapping.getProperty(), typeHandler.getResult(cs, i + <span class="hljs-number">1</span>));<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å¤„ç†æ¸¸æ ‡(OUTå‚æ•°)</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRefCursorOutputParameter</span><span class="hljs-params">(ResultSet rs, ParameterMapping parameterMapping, MetaObject metaParam)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">resultMapId</span> <span class="hljs-operator">=</span> parameterMapping.getResultMapId();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(resultMapId);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">DefaultResultHandler</span> <span class="hljs-variable">resultHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResultHandler</span>(objectFactory);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultSetWrapper</span> <span class="hljs-variable">rsw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultSetWrapper</span>(rs, configuration);<br>      <span class="hljs-comment">// é‡Œé¢å°±å’Œä¸€èˆ¬ResultSetå¤„ç†æ²¡ä¸¤æ ·äº†</span><br>      handleRowValues(rsw, resultMap, resultHandler, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RowBounds</span>(), <span class="hljs-literal">null</span>);<br>      metaParam.setValue(parameterMapping.getProperty(), resultHandler.getResultList());<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// issue #228 (close resultsets)</span><br>      closeResultSet(rs);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRowValues</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultMapping parentMapping)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (resultMap.hasNestedResultMaps()) &#123;<br>      ensureNoRowBounds();<br>      checkResultHandler();<br>      handleRowValuesForNestedResultMap(rsw, resultMap, resultHandler, rowBounds, parentMapping);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      handleRowValuesForSimpleResultMap(rsw, resultMap, resultHandler, rowBounds, parentMapping);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRowValuesForSimpleResultMap</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultMapping parentMapping)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">DefaultResultContext</span> <span class="hljs-variable">resultContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResultContext</span>();<br>    skipRows(rsw.getResultSet(), rowBounds);<br>    <span class="hljs-keyword">while</span> (shouldProcessMoreRows(resultContext, rowBounds) &amp;&amp; rsw.getResultSet().next()) &#123;<br>      <span class="hljs-type">ResultMap</span> <span class="hljs-variable">discriminatedResultMap</span> <span class="hljs-operator">=</span> resolveDiscriminatedResultMap(rsw.getResultSet(), resultMap, <span class="hljs-literal">null</span>);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">rowValue</span> <span class="hljs-operator">=</span> getRowValue(rsw, discriminatedResultMap);<br>      storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">skipRows</span><span class="hljs-params">(ResultSet rs, RowBounds rowBounds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (rs.getType() != ResultSet.TYPE_FORWARD_ONLY) &#123;<br>      <span class="hljs-keyword">if</span> (rowBounds.getOffset() != RowBounds.NO_ROW_OFFSET) &#123;<br>        rs.absolute(rowBounds.getOffset());<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; rowBounds.getOffset(); i++) &#123;<br>        rs.next();<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldProcessMoreRows</span><span class="hljs-params">(ResultContext context, RowBounds rowBounds)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> !context.isStopped() &amp;&amp; context.getResultCount() &lt; rowBounds.getLimit();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ResultMap <span class="hljs-title function_">resolveDiscriminatedResultMap</span><span class="hljs-params">(ResultSet rs, ResultMap resultMap, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    Set&lt;String&gt; pastDiscriminators = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();<br>    <span class="hljs-type">Discriminator</span> <span class="hljs-variable">discriminator</span> <span class="hljs-operator">=</span> resultMap.getDiscriminator();<br>    <span class="hljs-comment">// è¿™é‡Œåº”è¯¥æ˜¯å¤„ç†åµŒå¥—çš„Discriminator</span><br>    <span class="hljs-keyword">while</span> (discriminator != <span class="hljs-literal">null</span>) &#123; <br>      <span class="hljs-comment">// æ‹¿åˆ°Discriminatorçš„å€¼</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getDiscriminatorValue(rs, discriminator, columnPrefix);<br>      <span class="hljs-comment">// æ‹¿åˆ°å€¼å¯¹åº”çš„ResultMap id</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">discriminatedMapId</span> <span class="hljs-operator">=</span> discriminator.getMapIdFor(String.valueOf(value));<br>      <span class="hljs-keyword">if</span> (configuration.hasResultMap(discriminatedMapId)) &#123;<br>        resultMap = configuration.getResultMap(discriminatedMapId);<br>        <span class="hljs-type">Discriminator</span> <span class="hljs-variable">lastDiscriminator</span> <span class="hljs-operator">=</span> discriminator;<br>        discriminator = resultMap.getDiscriminator();<br>        <span class="hljs-keyword">if</span> (discriminator == lastDiscriminator || !pastDiscriminators.add(discriminatedMapId)) &#123;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultMap;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getDiscriminatorValue</span><span class="hljs-params">(ResultSet rs, Discriminator discriminator, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">resultMapping</span> <span class="hljs-operator">=</span> discriminator.getResultMapping();<br>    <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = resultMapping.getTypeHandler();<br>    <span class="hljs-keyword">return</span> typeHandler.getResult(rs, prependPrefix(resultMapping.getColumn(), columnPrefix));<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¸å¿ƒï¼Œå–å¾—ä¸€è¡Œçš„å€¼</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getRowValue</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// å®ä¾‹åŒ–ResultLoaderMap(å»¶è¿ŸåŠ è½½å™¨)</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">ResultLoaderMap</span> <span class="hljs-variable">lazyLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoaderMap</span>();<br>    <span class="hljs-comment">// è°ƒç”¨è‡ªå·±çš„createResultObject,å†…éƒ¨å°±æ˜¯newä¸€ä¸ªå¯¹è±¡(å¦‚æœæ˜¯ç®€å•ç±»å‹ï¼Œnewå®Œä¹ŸæŠŠå€¼èµ‹è¿›å»)</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">resultObject</span> <span class="hljs-operator">=</span> createResultObject(rsw, resultMap, lazyLoader, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">if</span> (resultObject != <span class="hljs-literal">null</span> &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;<br>      <span class="hljs-comment">// ä¸€èˆ¬ä¸æ˜¯ç®€å•ç±»å‹ä¸ä¼šæœ‰typehandler,è¿™ä¸ªifä¼šè¿›æ¥</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(resultObject);<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> !resultMap.getConstructorResultMappings().isEmpty();<br>      <span class="hljs-keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="hljs-literal">false</span>)) &#123;        <br>        <span class="hljs-comment">// è‡ªåŠ¨æ˜ å°„</span><br>        <span class="hljs-comment">// è¿™é‡ŒæŠŠæ¯ä¸ªåˆ—çš„å€¼éƒ½èµ‹åˆ°ç›¸åº”çš„å­—æ®µé‡Œå»äº†</span><br>        foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, <span class="hljs-literal">null</span>) || foundValues;<br>      &#125;<br>      foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, <span class="hljs-literal">null</span>) || foundValues;<br>      foundValues = lazyLoader.size() &gt; <span class="hljs-number">0</span> || foundValues;<br>      resultObject = foundValues ? resultObject : <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">return</span> resultObject;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultObject;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createResultObject</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, ResultLoaderMap lazyLoader, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> List&lt;Class&lt;?&gt;&gt; constructorArgTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Class&lt;?&gt;&gt;();<br>    <span class="hljs-keyword">final</span> List&lt;Object&gt; constructorArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">resultObject</span> <span class="hljs-operator">=</span> createResultObject(rsw, resultMap, constructorArgTypes, constructorArgs, columnPrefix);<br>    <span class="hljs-keyword">if</span> (resultObject != <span class="hljs-literal">null</span> &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;<br>      <span class="hljs-keyword">final</span> List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();<br>      <span class="hljs-keyword">for</span> (ResultMapping propertyMapping : propertyMappings) &#123;<br>        <span class="hljs-comment">// issue gcode #109 &amp;&amp; issue #149</span><br>        <span class="hljs-keyword">if</span> (propertyMapping.getNestedQueryId() != <span class="hljs-literal">null</span> &amp;&amp; propertyMapping.isLazy()) &#123;<br>          <span class="hljs-comment">// ä½¿ç”¨ä»£ç†(cglib/javaassist)</span><br>          <span class="hljs-keyword">return</span> configuration.getProxyFactory().createProxy(resultObject, lazyLoader, configuration, objectFactory, constructorArgTypes, constructorArgs);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultObject;<br>  &#125; <br><br>  <span class="hljs-comment">// åˆ›å»ºç»“æœå¯¹è±¡</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createResultObject</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, String columnPrefix)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// å¾—åˆ°result type</span><br>    <span class="hljs-keyword">final</span> Class&lt;?&gt; resultType = resultMap.getType();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaType</span> <span class="hljs-operator">=</span> MetaClass.forClass(resultType);<br>    <span class="hljs-keyword">final</span> List&lt;ResultMapping&gt; constructorMappings = resultMap.getConstructorResultMappings();<br>    <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(resultType)) &#123;<br>      <span class="hljs-comment">// åŸºæœ¬å‹</span><br>      <span class="hljs-keyword">return</span> createPrimitiveResultObject(rsw, resultMap, columnPrefix);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!constructorMappings.isEmpty()) &#123;<br>      <span class="hljs-comment">// æœ‰å‚æ•°çš„æ„é€ å‡½æ•°</span><br>      <span class="hljs-keyword">return</span> createParameterizedResultObject(rsw, resultType, constructorMappings, constructorArgTypes, constructorArgs, columnPrefix);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resultType.isInterface() || metaType.hasDefaultConstructor()) &#123;<br>      <span class="hljs-comment">// æ™®é€šbeanç±»å‹</span><br>      <span class="hljs-keyword">return</span> objectFactory.create(resultType);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="hljs-literal">false</span>)) &#123;<br>      <span class="hljs-comment">// è‡ªåŠ¨æ˜ å°„</span><br>      <span class="hljs-keyword">return</span> createByConstructorSignature(rsw, resultType, constructorArgTypes, constructorArgs, columnPrefix);<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Do not know how to create an instance of &quot;</span> + resultType);<br>  &#125; <br><br>  <span class="hljs-comment">// ç®€å•ç±»å‹èµ°è¿™é‡Œ</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createPrimitiveResultObject</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> Class&lt;?&gt; resultType = resultMap.getType();<br>    <span class="hljs-keyword">final</span> String columnName;<br>    <span class="hljs-comment">// å› ä¸ºåªæœ‰1åˆ—ï¼Œæ‰€ä»¥å–å¾—è¿™ä¸€åˆ—çš„åå­—</span><br>    <span class="hljs-keyword">if</span> (!resultMap.getResultMappings().isEmpty()) &#123;<br>      <span class="hljs-keyword">final</span> List&lt;ResultMapping&gt; resultMappingList = resultMap.getResultMappings();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">mapping</span> <span class="hljs-operator">=</span> resultMappingList.get(<span class="hljs-number">0</span>);<br>      columnName = prependPrefix(mapping.getColumn(), columnPrefix);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      columnName = rsw.getColumnNames().get(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(resultType, columnName);<br>    <span class="hljs-keyword">return</span> typeHandler.getResult(rsw.getResultSet(), columnName);<br>  &#125; <br><br>  <span class="hljs-comment">// è®¾ç½®äº†æ„é€ å‡½æ•°å‚æ•°</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createParameterizedResultObject</span><span class="hljs-params">(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; constructorMappings,</span><br><span class="hljs-params">      List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (ResultMapping constructorMapping : constructorMappings) &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; parameterType = constructorMapping.getJavaType();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> constructorMapping.getColumn();<br>      <span class="hljs-keyword">final</span> Object value;<br>      <span class="hljs-keyword">if</span> (constructorMapping.getNestedQueryId() != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// å€¼ç”±åµŒå¥—æŸ¥è¯¢è·å¾—</span><br>        value = getNestedQueryConstructorValue(rsw.getResultSet(), constructorMapping, columnPrefix);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (constructorMapping.getNestedResultMapId() != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(constructorMapping.getNestedResultMapId());<br>        <span class="hljs-comment">// é€’å½’è·å–ä¸€è¡Œçš„å€¼</span><br>        value = getRowValue(rsw, resultMap);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// é€šè¿‡typeHandlerè·å–å€¼</span><br>        <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = constructorMapping.getTypeHandler();<br>        value = typeHandler.getResult(rsw.getResultSet(), prependPrefix(column, columnPrefix));<br>      &#125;<br>      constructorArgTypes.add(parameterType);<br>      constructorArgs.add(value);<br>      foundValues = value != <span class="hljs-literal">null</span> || foundValues;<br>    &#125;<br>    <span class="hljs-keyword">return</span> foundValues ? objectFactory.create(resultType, constructorArgTypes, constructorArgs) : <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getNestedQueryConstructorValue</span><span class="hljs-params">(ResultSet rs, ResultMapping constructorMapping, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">nestedQueryId</span> <span class="hljs-operator">=</span> constructorMapping.getNestedQueryId();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">nestedQuery</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(nestedQueryId);<br>    <span class="hljs-keyword">final</span> Class&lt;?&gt; nestedQueryParameterType = nestedQuery.getParameterMap().getType();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">nestedQueryParameterObject</span> <span class="hljs-operator">=</span> prepareParameterForNestedQuery(rs, constructorMapping, nestedQueryParameterType, columnPrefix);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (nestedQueryParameterObject != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">BoundSql</span> <span class="hljs-variable">nestedBoundSql</span> <span class="hljs-operator">=</span> nestedQuery.getBoundSql(nestedQueryParameterObject);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> executor.createCacheKey(nestedQuery, nestedQueryParameterObject, RowBounds.DEFAULT, nestedBoundSql);<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; targetType = constructorMapping.getJavaType();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultLoader</span> <span class="hljs-variable">resultLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoader</span>(configuration, executor, nestedQuery, nestedQueryParameterObject, targetType, key, nestedBoundSql);<br>      value = resultLoader.loadResult();<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">prepareParameterForNestedQuery</span><span class="hljs-params">(ResultSet rs, ResultMapping resultMapping, Class&lt;?&gt; parameterType, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (resultMapping.isCompositeResult()) &#123;<br>      <span class="hljs-keyword">return</span> prepareCompositeKeyParameter(rs, resultMapping, parameterType, columnPrefix);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> prepareSimpleKeyParameter(rs, resultMapping, parameterType, columnPrefix);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">prepareCompositeKeyParameter</span><span class="hljs-params">(ResultSet rs, ResultMapping resultMapping, Class&lt;?&gt; parameterType, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> instantiateParameterObject(parameterType);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameterObject);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (ResultMapping innerResultMapping : resultMapping.getComposites()) &#123;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; propType = metaObject.getSetterType(innerResultMapping.getProperty());<br>      <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = typeHandlerRegistry.getTypeHandler(propType);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">propValue</span> <span class="hljs-operator">=</span> typeHandler.getResult(rs, prependPrefix(innerResultMapping.getColumn(), columnPrefix));<br>      <span class="hljs-comment">// issue #353 &amp; #560 do not execute nested query if key is null</span><br>      <span class="hljs-keyword">if</span> (propValue != <span class="hljs-literal">null</span>) &#123;<br>        metaObject.setValue(innerResultMapping.getProperty(), propValue);<br>        foundValues = <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> foundValues ? parameterObject : <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">instantiateParameterObject</span><span class="hljs-params">(Class&lt;?&gt; parameterType)</span> &#123;<br>    <span class="hljs-keyword">if</span> (parameterType == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Object, Object&gt;();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> objectFactory.create(parameterType);<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">prepareSimpleKeyParameter</span><span class="hljs-params">(ResultSet rs, ResultMapping resultMapping, Class&lt;?&gt; parameterType, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler;<br>    <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterType)) &#123;<br>      typeHandler = typeHandlerRegistry.getTypeHandler(parameterType);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      typeHandler = typeHandlerRegistry.getUnknownTypeHandler();<br>    &#125;<br>    <span class="hljs-keyword">return</span> typeHandler.getResult(rs, prependPrefix(resultMapping.getColumn(), columnPrefix));<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldApplyAutomaticMappings</span><span class="hljs-params">(ResultMap resultMap, <span class="hljs-type">boolean</span> isNested)</span> &#123;<br>    <span class="hljs-keyword">if</span> (resultMap.getAutoMapping() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> resultMap.getAutoMapping();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (isNested) &#123;<br>        <span class="hljs-keyword">return</span> AutoMappingBehavior.FULL == configuration.getAutoMappingBehavior();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> AutoMappingBehavior.NONE != configuration.getAutoMappingBehavior();<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">createByConstructorSignature</span><span class="hljs-params">(ResultSetWrapper rsw, Class&lt;?&gt; resultType, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs,</span><br><span class="hljs-params">      String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">for</span> (Constructor&lt;?&gt; constructor : resultType.getDeclaredConstructors()) &#123;<br>       <span class="hljs-comment">// è¿”å›çš„ä¸€è¡Œæ•°æ®çš„ç±»å‹æ­£å¥½å¯¹åº”ä¸Šä¸€ç§æ„é€ å‡½æ•°çš„å‚æ•°ç±»å‹</span><br>       <span class="hljs-keyword">if</span> (typeNames(constructor.getParameterTypes()).equals(rsw.getClassNames())) &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; constructor.getParameterTypes().length; i++) &#123;<br>          Class&lt;?&gt; parameterType = constructor.getParameterTypes()[i];<br>          <span class="hljs-type">String</span> <span class="hljs-variable">columnName</span> <span class="hljs-operator">=</span> rsw.getColumnNames().get(i);<br>          TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(parameterType, columnName);<br>          <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> typeHandler.getResult(rsw.getResultSet(), prependPrefix(columnName, columnPrefix));<br>          constructorArgTypes.add(parameterType);<br>          constructorArgs.add(value);<br>          foundValues = value != <span class="hljs-literal">null</span> || foundValues;<br>        &#125;<br>        <span class="hljs-comment">//ä¸Šé¢æ˜¯æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡ï¼Œä¸‹é¢æ˜¯å¯¹è±¡å·¥å‚æ¥åˆ›å»º</span><br>        <span class="hljs-keyword">return</span> foundValues ? objectFactory.create(resultType, constructorArgTypes, constructorArgs) : <span class="hljs-literal">null</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;No constructor found in &quot;</span> + resultType.getName() + <span class="hljs-string">&quot; matching &quot;</span> + rsw.getClassNames());<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">typeNames</span><span class="hljs-params">(Class&lt;?&gt;[] parameterTypes)</span> &#123;<br>    List&lt;String&gt; names = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    <span class="hljs-keyword">for</span> (Class&lt;?&gt; type : parameterTypes) &#123;<br>      names.add(type.getName());<br>    &#125;<br>    <span class="hljs-keyword">return</span> names;<br>  &#125; <br><br>  <span class="hljs-comment">// è‡ªåŠ¨æ˜ å°„æ²¡æœ‰æ‰‹åŠ¨å®šä¹‰æ˜ å°„çš„åˆ—</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">applyAutomaticMappings</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> List&lt;String&gt; unmappedColumnNames = rsw.getUnmappedColumnNames(resultMap, columnPrefix);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (String columnName : unmappedColumnNames) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> columnName;<br>      <span class="hljs-keyword">if</span> (columnPrefix != <span class="hljs-literal">null</span> &amp;&amp; !columnPrefix.isEmpty()) &#123;<br>        <span class="hljs-comment">// When columnPrefix is specified,</span><br>        <span class="hljs-comment">// ignore columns without the prefix.</span><br>        <span class="hljs-keyword">if</span> (columnName.toUpperCase(Locale.ENGLISH).startsWith(columnPrefix)) &#123;<br>          propertyName = columnName.substring(columnPrefix.length());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">continue</span>;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> metaObject.findProperty(propertyName, configuration.isMapUnderscoreToCamelCase());<br>      <span class="hljs-keyword">if</span> (property != <span class="hljs-literal">null</span> &amp;&amp; metaObject.hasSetter(property)) &#123;<br>        <span class="hljs-keyword">final</span> Class&lt;?&gt; propertyType = metaObject.getSetterType(property);<br>        <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(propertyType)) &#123;<br>          <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = rsw.getTypeHandler(propertyType, columnName);<br>          <span class="hljs-comment">// å·§å¦™çš„ç”¨TypeHandlerå–å¾—ç»“æœ</span><br>          <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> typeHandler.getResult(rsw.getResultSet(), columnName);<br>          <span class="hljs-comment">// issue #377, call setter on nulls</span><br>          <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> || configuration.isCallSettersOnNulls()) &#123;<br>            <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> || !propertyType.isPrimitive()) &#123;<br>              <span class="hljs-comment">// ç„¶åå·§å¦™çš„ç”¨åå°„æ¥è®¾ç½®åˆ°å¯¹è±¡</span><br>              metaObject.setValue(property, value);<br>            &#125;<br>            foundValues = <span class="hljs-literal">true</span>;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> foundValues;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">applyPropertyMappings</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, ResultLoaderMap lazyLoader, String columnPrefix)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> List&lt;String&gt; mappedColumnNames = rsw.getMappedColumnNames(resultMap, columnPrefix);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">final</span> List&lt;ResultMapping&gt; propertyMappings = resultMap.getPropertyResultMappings();<br>    <span class="hljs-keyword">for</span> (ResultMapping propertyMapping : propertyMappings) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> prependPrefix(propertyMapping.getColumn(), columnPrefix);<br>      <span class="hljs-keyword">if</span> (propertyMapping.isCompositeResult() <br>          || (column != <span class="hljs-literal">null</span> &amp;&amp; mappedColumnNames.contains(column.toUpperCase(Locale.ENGLISH))) <br>          || propertyMapping.getResultSet() != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getPropertyMappingValue(rsw.getResultSet(), metaObject, propertyMapping, lazyLoader, columnPrefix);<br>        <span class="hljs-comment">// issue #541 make property optional</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> propertyMapping.getProperty();<br>        <span class="hljs-comment">// issue #377, call setter on nulls</span><br>        <span class="hljs-keyword">if</span> (value != NO_VALUE &amp;&amp; property != <span class="hljs-literal">null</span> &amp;&amp; (value != <span class="hljs-literal">null</span> || configuration.isCallSettersOnNulls())) &#123;<br>          <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span> || !metaObject.getSetterType(property).isPrimitive()) &#123;<br>            metaObject.setValue(property, value);<br>          &#125;<br>          foundValues = <span class="hljs-literal">true</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> foundValues;<br>  &#125; <br><br>  <span class="hljs-comment">// è·å–å±æ€§æ˜ å°„çš„å€¼</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getPropertyMappingValue</span><span class="hljs-params">(ResultSet rs, MetaObject metaResultObject, ResultMapping propertyMapping, ResultLoaderMap lazyLoader, String columnPrefix)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (propertyMapping.getNestedQueryId() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> getNestedQueryMappingValue(rs, metaResultObject, propertyMapping, lazyLoader, columnPrefix);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (propertyMapping.getResultSet() != <span class="hljs-literal">null</span>) &#123;<br>      addPendingChildRelation(rs, metaResultObject, propertyMapping);<br>      <span class="hljs-keyword">return</span> NO_VALUE;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (propertyMapping.getNestedResultMapId() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// the user added a column attribute to a nested result map, ignore it</span><br>      <span class="hljs-keyword">return</span> NO_VALUE;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; typeHandler = propertyMapping.getTypeHandler();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> prependPrefix(propertyMapping.getColumn(), columnPrefix);<br>      <span class="hljs-keyword">return</span> typeHandler.getResult(rs, column);<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-comment">// å¾—åˆ°åµŒå¥—æŸ¥è¯¢å€¼</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getNestedQueryMappingValue</span><span class="hljs-params">(ResultSet rs, MetaObject metaResultObject, ResultMapping propertyMapping, ResultLoaderMap lazyLoader, String columnPrefix)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">nestedQueryId</span> <span class="hljs-operator">=</span> propertyMapping.getNestedQueryId();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> propertyMapping.getProperty();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">nestedQuery</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(nestedQueryId);<br>    <span class="hljs-keyword">final</span> Class&lt;?&gt; nestedQueryParameterType = nestedQuery.getParameterMap().getType();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">nestedQueryParameterObject</span> <span class="hljs-operator">=</span> prepareParameterForNestedQuery(rs, propertyMapping, nestedQueryParameterType, columnPrefix);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> NO_VALUE;<br>    <span class="hljs-keyword">if</span> (nestedQueryParameterObject != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">BoundSql</span> <span class="hljs-variable">nestedBoundSql</span> <span class="hljs-operator">=</span> nestedQuery.getBoundSql(nestedQueryParameterObject);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> executor.createCacheKey(nestedQuery, nestedQueryParameterObject, RowBounds.DEFAULT, nestedBoundSql);<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt; targetType = propertyMapping.getJavaType();<br>      <span class="hljs-keyword">if</span> (executor.isCached(nestedQuery, key)) &#123;<br>        <span class="hljs-comment">// å¦‚æœå·²ç»æœ‰ä¸€çº§ç¼“å­˜äº†ï¼Œåˆ™å»¶è¿ŸåŠ è½½(å®é™…ä¸ŠdeferLoadæ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°åˆ™æ˜¯ç«‹å³åŠ è½½)</span><br>        executor.deferLoad(nestedQuery, metaResultObject, property, key, targetType);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦åˆ™lazyLoader.addLoader éœ€è¦å»¶è¿ŸåŠ è½½åˆ™addLoader</span><br>        <span class="hljs-comment">// æˆ–è€…ResultLoader.loadResult ä¸éœ€è¦å»¶è¿ŸåŠ è½½åˆ™ç«‹å³åŠ è½½</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ResultLoader</span> <span class="hljs-variable">resultLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoader</span>(configuration, executor, nestedQuery, nestedQueryParameterObject, targetType, key, nestedBoundSql);<br>        <span class="hljs-keyword">if</span> (propertyMapping.isLazy()) &#123;<br>          lazyLoader.addLoader(property, metaResultObject, resultLoader);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          value = resultLoader.loadResult();<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>  &#125; <br><br>  <span class="hljs-comment">// åé¢çš„ä¸æƒ³çœ‹äº†ï¼Œä»¥åå†çœ‹</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPendingChildRelation</span><span class="hljs-params">(ResultSet rs, MetaObject metaResultObject, ResultMapping parentMapping)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> createKeyForMultipleResults(rs, parentMapping, parentMapping.getColumn(), parentMapping.getColumn());<br>    <span class="hljs-type">PendingRelation</span> <span class="hljs-variable">deferLoad</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PendingRelation</span>();<br>    deferLoad.metaObject = metaResultObject;<br>    deferLoad.propertyMapping = parentMapping;<br>    List&lt;PendingRelation&gt; relations = pendingRelations.get(cacheKey);<br>    <span class="hljs-comment">// issue #255</span><br>    <span class="hljs-keyword">if</span> (relations == <span class="hljs-literal">null</span>) &#123;<br>      relations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;DefaultResultSetHandler.PendingRelation&gt;();<br>      pendingRelations.put(cacheKey, relations);<br>    &#125;<br>    relations.add(deferLoad);<br>    <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">previous</span> <span class="hljs-operator">=</span> nextResultMaps.get(parentMapping.getResultSet());<br>    <span class="hljs-keyword">if</span> (previous == <span class="hljs-literal">null</span>) &#123;<br>      nextResultMaps.put(parentMapping.getResultSet(), parentMapping);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (!previous.equals(parentMapping)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Two different properties are mapped to the same resultSet&quot;</span>);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">storeObject</span><span class="hljs-params">(ResultHandler resultHandler, DefaultResultContext resultContext, Object rowValue, ResultMapping parentMapping, ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (parentMapping != <span class="hljs-literal">null</span>) &#123;<br>      linkToParents(rs, parentMapping, rowValue);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      callResultHandler(resultHandler, resultContext, rowValue);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// MULTIPLE RESULT SETS</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">linkToParents</span><span class="hljs-params">(ResultSet rs, ResultMapping parentMapping, Object rowValue)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">parentKey</span> <span class="hljs-operator">=</span> createKeyForMultipleResults(rs, parentMapping, parentMapping.getColumn(), parentMapping.getForeignColumn());<br>    List&lt;PendingRelation&gt; parents = pendingRelations.get(parentKey);<br>    <span class="hljs-keyword">for</span> (PendingRelation parent : parents) &#123;<br>      <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">collectionProperty</span> <span class="hljs-operator">=</span> instantiateCollectionPropertyIfAppropriate(parent.propertyMapping, parent.metaObject);<br>        <span class="hljs-keyword">if</span> (rowValue != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">if</span> (collectionProperty != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">targetMetaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(collectionProperty);<br>            targetMetaObject.add(rowValue);<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            parent.metaObject.setValue(parent.propertyMapping.getProperty(), rowValue);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-keyword">private</span> CacheKey <span class="hljs-title function_">createKeyForMultipleResults</span><span class="hljs-params">(ResultSet rs, ResultMapping resultMapping, String names, String columns)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheKey</span>();<br>    cacheKey.update(resultMapping);<br>    <span class="hljs-keyword">if</span> (columns != <span class="hljs-literal">null</span> &amp;&amp; names != <span class="hljs-literal">null</span>) &#123;<br>      String[] columnsArray = columns.split(<span class="hljs-string">&quot;,&quot;</span>);<br>      String[] namesArray = names.split(<span class="hljs-string">&quot;,&quot;</span>);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> ; i &lt; columnsArray.length ; i++) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rs.getString(columnsArray[i]);<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>          cacheKey.update(namesArray[i]);<br>          cacheKey.update(value);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> cacheKey;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">instantiateCollectionPropertyIfAppropriate</span><span class="hljs-params">(ResultMapping resultMapping, MetaObject metaObject)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> resultMapping.getProperty();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">propertyValue</span> <span class="hljs-operator">=</span> metaObject.getValue(propertyName);<br>    <span class="hljs-keyword">if</span> (propertyValue == <span class="hljs-literal">null</span>) &#123;<br>      Class&lt;?&gt; type = resultMapping.getJavaType();<br>      <span class="hljs-keyword">if</span> (type == <span class="hljs-literal">null</span>) &#123;<br>        type = metaObject.getSetterType(propertyName);<br>      &#125;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (objectFactory.isCollection(type)) &#123;<br>          propertyValue = objectFactory.create(type);<br>          metaObject.setValue(propertyName, propertyValue);<br>          <span class="hljs-keyword">return</span> propertyValue;<br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error instantiating collection property for result &#x27;&quot;</span> + resultMapping.getProperty() + <span class="hljs-string">&quot;&#x27;.  Cause: &quot;</span> + e, e);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (objectFactory.isCollection(propertyValue.getClass())) &#123;<br>      <span class="hljs-keyword">return</span> propertyValue;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callResultHandler</span><span class="hljs-params">(ResultHandler resultHandler, DefaultResultContext resultContext, Object rowValue)</span> &#123;<br>    resultContext.nextResultObject(rowValue);<br>    resultHandler.handleResult(resultContext);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureNoRowBounds</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (configuration.isSafeRowBoundsEnabled() &amp;&amp; rowBounds != <span class="hljs-literal">null</span> &amp;&amp; (rowBounds.getLimit() &lt; RowBounds.NO_ROW_LIMIT || rowBounds.getOffset() &gt; RowBounds.NO_ROW_OFFSET)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Mapped Statements with nested result mappings cannot be safely constrained by RowBounds. &quot;</span><br>          + <span class="hljs-string">&quot;Use safeRowBoundsEnabled=false setting to bypass this check.&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkResultHandler</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (resultHandler != <span class="hljs-literal">null</span> &amp;&amp; configuration.isSafeResultHandlerEnabled() &amp;&amp; !mappedStatement.isResultOrdered()) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Mapped Statements with nested result mappings cannot be safely used with a custom ResultHandler. &quot;</span><br>          + <span class="hljs-string">&quot;Use safeResultHandlerEnabled=false setting to bypass this check &quot;</span> <br>          + <span class="hljs-string">&quot;or ensure your statement returns ordered data and set resultOrdered=true on it.&quot;</span>);<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// HANDLE NESTED RESULT MAPS</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleRowValuesForNestedResultMap</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, ResultHandler resultHandler, RowBounds rowBounds, ResultMapping parentMapping)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">DefaultResultContext</span> <span class="hljs-variable">resultContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResultContext</span>();<br>    skipRows(rsw.getResultSet(), rowBounds);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">rowValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">while</span> (shouldProcessMoreRows(resultContext, rowBounds) &amp;&amp; rsw.getResultSet().next()) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">discriminatedResultMap</span> <span class="hljs-operator">=</span> resolveDiscriminatedResultMap(rsw.getResultSet(), resultMap, <span class="hljs-literal">null</span>);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">rowKey</span> <span class="hljs-operator">=</span> createRowKey(discriminatedResultMap, rsw, <span class="hljs-literal">null</span>);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">partialObject</span> <span class="hljs-operator">=</span> nestedResultObjects.get(rowKey);<br>      <span class="hljs-comment">// issue #577 &amp;&amp; #542</span><br>      <span class="hljs-keyword">if</span> (mappedStatement.isResultOrdered()) &#123;<br>        <span class="hljs-keyword">if</span> (partialObject == <span class="hljs-literal">null</span> &amp;&amp; rowValue != <span class="hljs-literal">null</span>) &#123;<br>          nestedResultObjects.clear();<br>          storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());<br>        &#125;<br>        rowValue = getRowValue(rsw, discriminatedResultMap, rowKey, rowKey, <span class="hljs-literal">null</span>, partialObject);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        rowValue = getRowValue(rsw, discriminatedResultMap, rowKey, rowKey, <span class="hljs-literal">null</span>, partialObject);<br>        <span class="hljs-keyword">if</span> (partialObject == <span class="hljs-literal">null</span>) &#123;<br>          storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (rowValue != <span class="hljs-literal">null</span> &amp;&amp; mappedStatement.isResultOrdered() &amp;&amp; shouldProcessMoreRows(resultContext, rowBounds)) &#123;<br>      storeObject(resultHandler, resultContext, rowValue, parentMapping, rsw.getResultSet());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// UNIQUE RESULT KEY</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-keyword">private</span> CacheKey <span class="hljs-title function_">createRowKey</span><span class="hljs-params">(ResultMap resultMap, ResultSetWrapper rsw, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheKey</span>();<br>    cacheKey.update(resultMap.getId());<br>    List&lt;ResultMapping&gt; resultMappings = getResultMappingsForRowKey(resultMap);<br>    <span class="hljs-keyword">if</span> (resultMappings.size() == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">if</span> (Map.class.isAssignableFrom(resultMap.getType())) &#123;<br>        createRowKeyForMap(rsw, cacheKey);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        createRowKeyForUnmappedProperties(resultMap, rsw, cacheKey, columnPrefix);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      createRowKeyForMappedProperties(resultMap, rsw, cacheKey, resultMappings, columnPrefix);<br>    &#125;<br>    <span class="hljs-keyword">return</span> cacheKey;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; <span class="hljs-title function_">getResultMappingsForRowKey</span><span class="hljs-params">(ResultMap resultMap)</span> &#123;<br>    List&lt;ResultMapping&gt; resultMappings = resultMap.getIdResultMappings();<br>    <span class="hljs-keyword">if</span> (resultMappings.size() == <span class="hljs-number">0</span>) &#123;<br>      resultMappings = resultMap.getPropertyResultMappings();<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultMappings;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createRowKeyForMap</span><span class="hljs-params">(ResultSetWrapper rsw, CacheKey cacheKey)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;String&gt; columnNames = rsw.getColumnNames();<br>    <span class="hljs-keyword">for</span> (String columnName : columnNames) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rsw.getResultSet().getString(columnName);<br>      <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>        cacheKey.update(columnName);<br>        cacheKey.update(value);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createRowKeyForUnmappedProperties</span><span class="hljs-params">(ResultMap resultMap, ResultSetWrapper rsw, CacheKey cacheKey, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaType</span> <span class="hljs-operator">=</span> MetaClass.forClass(resultMap.getType());<br>    List&lt;String&gt; unmappedColumnNames = rsw.getUnmappedColumnNames(resultMap, columnPrefix);<br>    <span class="hljs-keyword">for</span> (String column : unmappedColumnNames) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> column;<br>      <span class="hljs-keyword">if</span> (columnPrefix != <span class="hljs-literal">null</span> &amp;&amp; !columnPrefix.isEmpty()) &#123;<br>        <span class="hljs-comment">// When columnPrefix is specified, ignore columns without the prefix.</span><br>        <span class="hljs-keyword">if</span> (column.toUpperCase(Locale.ENGLISH).startsWith(columnPrefix)) &#123;<br>          property = column.substring(columnPrefix.length());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">continue</span>;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (metaType.findProperty(property, configuration.isMapUnderscoreToCamelCase()) != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rsw.getResultSet().getString(column);<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>          cacheKey.update(column);<br>          cacheKey.update(value);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createRowKeyForMappedProperties</span><span class="hljs-params">(ResultMap resultMap, ResultSetWrapper rsw, CacheKey cacheKey, List&lt;ResultMapping&gt; resultMappings, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">for</span> (ResultMapping resultMapping : resultMappings) &#123;<br>      <span class="hljs-keyword">if</span> (resultMapping.getNestedResultMapId() != <span class="hljs-literal">null</span> &amp;&amp; resultMapping.getResultSet() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// Issue #392</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">nestedResultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(resultMapping.getNestedResultMapId());<br>        createRowKeyForMappedProperties(nestedResultMap, rsw, cacheKey, nestedResultMap.getConstructorResultMappings(),<br>            prependPrefix(resultMapping.getColumnPrefix(), columnPrefix));<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resultMapping.getNestedQueryId() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> prependPrefix(resultMapping.getColumn(), columnPrefix);<br>        <span class="hljs-keyword">final</span> TypeHandler&lt;?&gt; th = resultMapping.getTypeHandler();<br>        List&lt;String&gt; mappedColumnNames = rsw.getMappedColumnNames(resultMap, columnPrefix);<br>        <span class="hljs-comment">// Issue #114</span><br>        <span class="hljs-keyword">if</span> (column != <span class="hljs-literal">null</span> &amp;&amp; mappedColumnNames.contains(column.toUpperCase(Locale.ENGLISH))) &#123;<br>          <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> th.getResult(rsw.getResultSet(), column);<br>          <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>            cacheKey.update(column);<br>            cacheKey.update(value);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// GET VALUE FROM ROW FOR NESTED RESULT MAP</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getRowValue</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, CacheKey combinedKey, CacheKey absoluteKey, String columnPrefix, Object partialObject)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">resultMapId</span> <span class="hljs-operator">=</span> resultMap.getId();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">resultObject</span> <span class="hljs-operator">=</span> partialObject;<br>    <span class="hljs-keyword">if</span> (resultObject != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(resultObject);<br>      putAncestor(absoluteKey, resultObject, resultMapId, columnPrefix);<br>      applyNestedResultMappings(rsw, resultMap, metaObject, columnPrefix, combinedKey, <span class="hljs-literal">false</span>);<br>      ancestorObjects.remove(absoluteKey);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">ResultLoaderMap</span> <span class="hljs-variable">lazyLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultLoaderMap</span>();<br>      resultObject = createResultObject(rsw, resultMap, lazyLoader, columnPrefix);<br>      <span class="hljs-keyword">if</span> (resultObject != <span class="hljs-literal">null</span> &amp;&amp; !typeHandlerRegistry.hasTypeHandler(resultMap.getType())) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(resultObject);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> !resultMap.getConstructorResultMappings().isEmpty();<br>        <span class="hljs-keyword">if</span> (shouldApplyAutomaticMappings(resultMap, <span class="hljs-literal">true</span>)) &#123;<br>          foundValues = applyAutomaticMappings(rsw, resultMap, metaObject, columnPrefix) || foundValues;<br>        &#125;        <br>        foundValues = applyPropertyMappings(rsw, resultMap, metaObject, lazyLoader, columnPrefix) || foundValues;<br>        putAncestor(absoluteKey, resultObject, resultMapId, columnPrefix);<br>        foundValues = applyNestedResultMappings(rsw, resultMap, metaObject, columnPrefix, combinedKey, <span class="hljs-literal">true</span>) || foundValues;<br>        ancestorObjects.remove(absoluteKey);<br>        foundValues = lazyLoader.size() &gt; <span class="hljs-number">0</span> || foundValues;<br>        resultObject = foundValues ? resultObject : <span class="hljs-literal">null</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (combinedKey != CacheKey.NULL_CACHE_KEY) &#123;<br>        nestedResultObjects.put(combinedKey, resultObject);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resultObject;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putAncestor</span><span class="hljs-params">(CacheKey rowKey, Object resultObject, String resultMapId, String columnPrefix)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!ancestorColumnPrefix.containsKey(resultMapId)) &#123;<br>      ancestorColumnPrefix.put(resultMapId, columnPrefix);<br>    &#125;<br>    ancestorObjects.put(rowKey, resultObject);<br>  &#125; <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// NESTED RESULT MAP (JOIN MAPPING)</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">applyNestedResultMappings</span><span class="hljs-params">(ResultSetWrapper rsw, ResultMap resultMap, MetaObject metaObject, String parentPrefix, CacheKey parentRowKey, <span class="hljs-type">boolean</span> newObject)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">foundValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (ResultMapping resultMapping : resultMap.getPropertyResultMappings()) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">nestedResultMapId</span> <span class="hljs-operator">=</span> resultMapping.getNestedResultMapId();<br>      <span class="hljs-keyword">if</span> (nestedResultMapId != <span class="hljs-literal">null</span> &amp;&amp; resultMapping.getResultSet() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">columnPrefix</span> <span class="hljs-operator">=</span> getColumnPrefix(parentPrefix, resultMapping);<br>          <span class="hljs-keyword">final</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">nestedResultMap</span> <span class="hljs-operator">=</span> getNestedResultMap(rsw.getResultSet(), nestedResultMapId, columnPrefix);<br>          <span class="hljs-type">CacheKey</span> <span class="hljs-variable">rowKey</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>          <span class="hljs-type">Object</span> <span class="hljs-variable">ancestorObject</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>          <span class="hljs-keyword">if</span> (ancestorColumnPrefix.containsKey(nestedResultMapId)) &#123;<br>            rowKey = createRowKey(nestedResultMap, rsw, ancestorColumnPrefix.get(nestedResultMapId));<br>            ancestorObject = ancestorObjects.get(rowKey);<br>          &#125;<br>          <span class="hljs-keyword">if</span> (ancestorObject != <span class="hljs-literal">null</span>) &#123; <br>            <span class="hljs-keyword">if</span> (newObject) &#123;<br>              metaObject.setValue(resultMapping.getProperty(), ancestorObject);<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            rowKey = createRowKey(nestedResultMap, rsw, columnPrefix);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">combinedKey</span> <span class="hljs-operator">=</span> combineKeys(rowKey, parentRowKey);            <br>            <span class="hljs-type">Object</span> <span class="hljs-variable">rowValue</span> <span class="hljs-operator">=</span> nestedResultObjects.get(combinedKey);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">knownValue</span> <span class="hljs-operator">=</span> (rowValue != <span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">collectionProperty</span> <span class="hljs-operator">=</span> instantiateCollectionPropertyIfAppropriate(resultMapping, metaObject);            <br>            <span class="hljs-keyword">if</span> (anyNotNullColumnHasValue(resultMapping, columnPrefix, rsw.getResultSet())) &#123;<br>              rowValue = getRowValue(rsw, nestedResultMap, combinedKey, rowKey, columnPrefix, rowValue);<br>              <span class="hljs-keyword">if</span> (rowValue != <span class="hljs-literal">null</span> &amp;&amp; !knownValue) &#123;<br>                <span class="hljs-keyword">if</span> (collectionProperty != <span class="hljs-literal">null</span>) &#123;<br>                  <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">targetMetaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(collectionProperty);<br>                  targetMetaObject.add(rowValue);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                  metaObject.setValue(resultMapping.getProperty(), rowValue);<br>                &#125;<br>                foundValues = <span class="hljs-literal">true</span>;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error getting nested result map values for &#x27;&quot;</span> + resultMapping.getProperty() + <span class="hljs-string">&quot;&#x27;.  Cause: &quot;</span> + e, e);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> foundValues;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getColumnPrefix</span><span class="hljs-params">(String parentPrefix, ResultMapping resultMapping)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">columnPrefixBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">if</span> (parentPrefix != <span class="hljs-literal">null</span>) &#123;<br>      columnPrefixBuilder.append(parentPrefix);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (resultMapping.getColumnPrefix() != <span class="hljs-literal">null</span>) &#123;<br>      columnPrefixBuilder.append(resultMapping.getColumnPrefix());<br>    &#125;<br>    <span class="hljs-keyword">return</span> columnPrefixBuilder.length() == <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : columnPrefixBuilder.toString().toUpperCase(Locale.ENGLISH);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> ResultMap <span class="hljs-title function_">getNestedResultMap</span><span class="hljs-params">(ResultSet rs, String nestedResultMapId, String columnPrefix)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">ResultMap</span> <span class="hljs-variable">nestedResultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(nestedResultMapId);<br>    <span class="hljs-keyword">return</span> resolveDiscriminatedResultMap(rs, nestedResultMap, columnPrefix);<br>  &#125;  <br><br>  <span class="hljs-keyword">private</span> CacheKey <span class="hljs-title function_">combineKeys</span><span class="hljs-params">(CacheKey rowKey, CacheKey parentRowKey)</span> &#123;<br>    <span class="hljs-keyword">if</span> (rowKey.getUpdateCount() &gt; <span class="hljs-number">1</span> &amp;&amp; parentRowKey.getUpdateCount() &gt; <span class="hljs-number">1</span>) &#123;<br>      CacheKey combinedKey;<br>      <span class="hljs-keyword">try</span> &#123;<br>        combinedKey = rowKey.clone();<br>      &#125; <span class="hljs-keyword">catch</span> (CloneNotSupportedException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error cloning cache key.  Cause: &quot;</span> + e, e);<br>      &#125;<br>      combinedKey.update(parentRowKey);<br>      <span class="hljs-keyword">return</span> combinedKey;<br>    &#125;<br>    <span class="hljs-keyword">return</span> CacheKey.NULL_CACHE_KEY;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">anyNotNullColumnHasValue</span><span class="hljs-params">(ResultMapping resultMapping, String columnPrefix, ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    Set&lt;String&gt; notNullColumns = resultMapping.getNotNullColumns();<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">anyNotNullColumnHasValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">if</span> (notNullColumns != <span class="hljs-literal">null</span> &amp;&amp; !notNullColumns.isEmpty()) &#123;<br>      anyNotNullColumnHasValue = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">for</span> (String column: notNullColumns) &#123;<br>        rs.getObject(prependPrefix(column, columnPrefix));<br>        <span class="hljs-keyword">if</span> (!rs.wasNull()) &#123;<br>          anyNotNullColumnHasValue = <span class="hljs-literal">true</span>;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> anyNotNullColumnHasValue;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeResultSet</span><span class="hljs-params">(ResultSet rs)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (rs != <span class="hljs-literal">null</span>) &#123;<br>        rs.close();<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-comment">// ignore</span><br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// HANDLE RESULT SETS</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">handleResultSets</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    ErrorContext.instance().activity(<span class="hljs-string">&quot;handling results&quot;</span>).object(mappedStatement.getId());<br><br>    <span class="hljs-keyword">final</span> List&lt;Object&gt; multipleResults = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">resultSetCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">ResultSetWrapper</span> <span class="hljs-variable">rsw</span> <span class="hljs-operator">=</span> getFirstResultSet(stmt);<br><br>    List&lt;ResultMap&gt; resultMaps = mappedStatement.getResultMaps();<br>    <span class="hljs-comment">// ä¸€èˆ¬resultMapsé‡Œåªæœ‰ä¸€ä¸ªå…ƒç´ </span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">resultMapCount</span> <span class="hljs-operator">=</span> resultMaps.size();<br>    validateResultMapsCount(rsw, resultMapCount);<br>    <span class="hljs-keyword">while</span> (rsw != <span class="hljs-literal">null</span> &amp;&amp; resultMapCount &gt; resultSetCount) &#123;<br>      <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> resultMaps.get(resultSetCount);<br>      handleResultSet(rsw, resultMap, multipleResults, <span class="hljs-literal">null</span>);<br>      rsw = getNextResultSet(stmt);<br>      cleanUpAfterHandlingResultSet();<br>      resultSetCount++;<br>    &#125;<br><br>    String[] resultSets = mappedStatement.getResulSets();<br>    <span class="hljs-keyword">if</span> (resultSets != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">while</span> (rsw != <span class="hljs-literal">null</span> &amp;&amp; resultSetCount &lt; resultSets.length) &#123;<br>        <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">parentMapping</span> <span class="hljs-operator">=</span> nextResultMaps.get(resultSets[resultSetCount]);<br>        <span class="hljs-keyword">if</span> (parentMapping != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">nestedResultMapId</span> <span class="hljs-operator">=</span> parentMapping.getNestedResultMapId();<br>          <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(nestedResultMapId);<br>          handleResultSet(rsw, resultMap, <span class="hljs-literal">null</span>, parentMapping);<br>        &#125;<br>        rsw = getNextResultSet(stmt);<br>        cleanUpAfterHandlingResultSet();<br>        resultSetCount++;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> collapseSingleResultList(multipleResults);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> ResultSetWrapper <span class="hljs-title function_">getFirstResultSet</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.getResultSet();<br>    <span class="hljs-comment">// HSQLDB2.1ç‰¹æ®Šæƒ…å†µå¤„ç†</span><br>    <span class="hljs-keyword">while</span> (rs == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// move forward to get the first resultset in case the driver</span><br>      <span class="hljs-comment">// doesn&#x27;t return the resultset as the first result (HSQLDB 2.1)</span><br>      <span class="hljs-keyword">if</span> (stmt.getMoreResults()) &#123;<br>        rs = stmt.getResultSet();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (stmt.getUpdateCount() == -<span class="hljs-number">1</span>) &#123;<br>          <span class="hljs-comment">// no more results. Must be no resultset</span><br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> rs != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultSetWrapper</span>(rs, configuration) : <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateResultMapsCount</span><span class="hljs-params">(ResultSetWrapper rsw, <span class="hljs-type">int</span> resultMapCount)</span> &#123;<br>    <span class="hljs-keyword">if</span> (rsw != <span class="hljs-literal">null</span> &amp;&amp; resultMapCount &lt; <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;A query was run and no Result Maps were found for the Mapped Statement &#x27;&quot;</span> + mappedStatement.getId()<br>          + <span class="hljs-string">&quot;&#x27;.  It&#x27;s likely that neither a Result Type nor a Result Map was specified.&quot;</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> ResultSetWrapper <span class="hljs-title function_">getNextResultSet</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// Making this method tolerant of bad JDBC drivers</span><br>    <span class="hljs-comment">// ä½¿å¾—è¯¥æ–¹æ³•èƒ½å¤Ÿå®¹å¿ä¸è‰¯çš„JDBCé©±åŠ¨ç¨‹åº</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (stmt.getConnection().getMetaData().supportsMultipleResultSets()) &#123;<br>        <span class="hljs-comment">// Crazy Standard JDBC way of determining if there are more results</span><br>        <span class="hljs-keyword">if</span> (!((!stmt.getMoreResults()) &amp;&amp; (stmt.getUpdateCount() == -<span class="hljs-number">1</span>))) &#123;<br>          <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.getResultSet();<br>          <span class="hljs-keyword">return</span> rs != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultSetWrapper</span>(rs, configuration) : <span class="hljs-literal">null</span>;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-comment">// Intentionally ignored.</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanUpAfterHandlingResultSet</span><span class="hljs-params">()</span> &#123;<br>    nestedResultObjects.clear();<br>    ancestorColumnPrefix.clear();<br>  &#125; <br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">private</span> List&lt;Object&gt; <span class="hljs-title function_">collapseSingleResultList</span><span class="hljs-params">(List&lt;Object&gt; multipleResults)</span> &#123;<br>    <span class="hljs-keyword">return</span> multipleResults.size() == <span class="hljs-number">1</span> ? (List&lt;Object&gt;) multipleResults.get(<span class="hljs-number">0</span>) : multipleResults;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="StatementHandler"><a href="#StatementHandler" class="headerlink" title="StatementHandler"></a>StatementHandler</h4><p>Â Â Â Â è¯­å¥å¤„ç†å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StatementHandler</span> &#123;<br><br>  <span class="hljs-comment">// å‡†å¤‡è¯­å¥</span><br>  Statement <span class="hljs-title function_">prepare</span><span class="hljs-params">(Connection connection)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// å‚æ•°åŒ–</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// æ‰¹å¤„ç†</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">batch</span><span class="hljs-params">(Statement statement)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// update</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// select--&gt;ç»“æœç»™ResultHandler</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span><br>      <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// å¾—åˆ°ç»‘å®šsql</span><br>  BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">// å¾—åˆ°å‚æ•°å¤„ç†å™¨</span><br>  ParameterHandler <span class="hljs-title function_">getParameterHandler</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BaseStatementHandler"><a href="#BaseStatementHandler" class="headerlink" title="BaseStatementHandler"></a>BaseStatementHandler</h4><p>Â Â Â Â  Â è¯­å¥å¤„ç†å™¨çš„åŸºç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseStatementHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StatementHandler</span> &#123;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Configuration configuration;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> TypeHandlerRegistry typeHandlerRegistry;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ResultSetHandler resultSetHandler;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ParameterHandler parameterHandler;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Executor executor;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> MappedStatement mappedStatement;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> RowBounds rowBounds;<br><br>  <span class="hljs-keyword">protected</span> BoundSql boundSql;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">BaseStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = mappedStatement.getConfiguration();<br>    <span class="hljs-built_in">this</span>.executor = executor;<br>    <span class="hljs-built_in">this</span>.mappedStatement = mappedStatement;<br>    <span class="hljs-built_in">this</span>.rowBounds = rowBounds;<br><br>    <span class="hljs-built_in">this</span>.typeHandlerRegistry = configuration.getTypeHandlerRegistry();<br>    <span class="hljs-built_in">this</span>.objectFactory = configuration.getObjectFactory();<br><br>    <span class="hljs-keyword">if</span> (boundSql == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// issue #435, get the key before calculating the statement</span><br>      generateKeys(parameterObject);<br>      boundSql = mappedStatement.getBoundSql(parameterObject);<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.boundSql = boundSql;<br><br>    <span class="hljs-comment">// ç”ŸæˆparameterHandler</span><br>    <span class="hljs-built_in">this</span>.parameterHandler = configuration.newParameterHandler(mappedStatement, parameterObject, boundSql);<br>    <span class="hljs-comment">// ç”ŸæˆresultSetHandler</span><br>    <span class="hljs-built_in">this</span>.resultSetHandler = configuration.newResultSetHandler(executor, mappedStatement, rowBounds, parameterHandler, resultHandler, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> boundSql;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> ParameterHandler <span class="hljs-title function_">getParameterHandler</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> parameterHandler;<br>  &#125;<br><br>  <span class="hljs-comment">// å‡†å¤‡è¯­å¥</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Statement <span class="hljs-title function_">prepare</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    ErrorContext.instance().sql(boundSql.getSql());<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å®ä¾‹åŒ–Statement</span><br>      statement = instantiateStatement(connection);<br>      <span class="hljs-comment">// è®¾ç½®è¶…æ—¶</span><br>      setStatementTimeout(statement);<br>      <span class="hljs-comment">// è®¾ç½®è¯»å–æ¡æ•°</span><br>      setFetchSize(statement);<br>      <span class="hljs-keyword">return</span> statement;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      closeStatement(statement);<br>      <span class="hljs-keyword">throw</span> e;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      closeStatement(statement);<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Error preparing statement.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// å¦‚ä½•å®ä¾‹åŒ–Statementï¼Œäº¤ç»™å­ç±»åš</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// è®¾ç½®è¶…æ—¶,å…¶å®å°±æ˜¯è°ƒç”¨Statement.setQueryTimeout</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatementTimeout</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> mappedStatement.getTimeout();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">defaultTimeout</span> <span class="hljs-operator">=</span> configuration.getDefaultStatementTimeout();<br>    <span class="hljs-keyword">if</span> (timeout != <span class="hljs-literal">null</span>) &#123;<br>      stmt.setQueryTimeout(timeout);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (defaultTimeout != <span class="hljs-literal">null</span>) &#123;<br>      stmt.setQueryTimeout(defaultTimeout);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// è®¾ç½®è¯»å–æ¡æ•°,å…¶å®å°±æ˜¯è°ƒç”¨Statement.setFetchSize</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFetchSize</span><span class="hljs-params">(Statement stmt)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> mappedStatement.getFetchSize();<br>    <span class="hljs-keyword">if</span> (fetchSize != <span class="hljs-literal">null</span>) &#123;<br>      stmt.setFetchSize(fetchSize);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// å…³é—­è¯­å¥</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeStatement</span><span class="hljs-params">(Statement statement)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (statement != <span class="hljs-literal">null</span>) &#123;<br>        statement.close();<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-comment">// ignore</span><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// ç”Ÿæˆkey</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generateKeys</span><span class="hljs-params">(Object parameter)</span> &#123;<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();<br>    ErrorContext.instance().store();<br>    keyGenerator.processBefore(executor, mappedStatement, <span class="hljs-literal">null</span>, parameter);<br>    ErrorContext.instance().recall();<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SimpleStatementHandler"><a href="#SimpleStatementHandler" class="headerlink" title="SimpleStatementHandler"></a>SimpleStatementHandler</h4><p>Â Â Â Â ç®€å•è¯­å¥å¤„ç†å™¨(STATEMENT)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleStatementHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseStatementHandler</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-built_in">super</span>(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> boundSql.getParameterObject();<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();<br>    <span class="hljs-type">int</span> rows;<br>    <span class="hljs-keyword">if</span> (keyGenerator <span class="hljs-keyword">instanceof</span> Jdbc3KeyGenerator) &#123;<br>      statement.execute(sql, Statement.RETURN_GENERATED_KEYS);<br>      rows = statement.getUpdateCount();<br>      keyGenerator.processAfter(executor, mappedStatement, statement, parameterObject);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keyGenerator <span class="hljs-keyword">instanceof</span> SelectKeyGenerator) &#123;<br>      statement.execute(sql);<br>      rows = statement.getUpdateCount();<br>      keyGenerator.processAfter(executor, mappedStatement, statement, parameterObject);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å¦‚æœæ²¡æœ‰keyGenerator,ç›´æ¥è°ƒç”¨Statement.executeå’ŒStatement.getUpdateCount</span><br>      statement.execute(sql);<br>      rows = statement.getUpdateCount();<br>    &#125;<br>    <span class="hljs-keyword">return</span> rows;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batch</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-comment">// è°ƒç”¨Statement.addBatch</span><br>    statement.addBatch(sql);<br>  &#125;<br><br>  <span class="hljs-comment">// select--&gt;ç»“æœç»™ResultHandler</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    statement.execute(sql);<br>    <span class="hljs-comment">// å…ˆæ‰§è¡ŒStatement.executeï¼Œç„¶åäº¤ç»™ResultSetHandler.handleResultSets</span><br>    <span class="hljs-keyword">return</span> resultSetHandler.&lt;E&gt;handleResultSets(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// è°ƒç”¨Connection.createStatement</span><br>    <span class="hljs-keyword">if</span> (mappedStatement.getResultSetType() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> connection.createStatement(mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> connection.createStatement();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// N/A</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PreparedStatementHandler"><a href="#PreparedStatementHandler" class="headerlink" title="PreparedStatementHandler"></a>PreparedStatementHandler</h4><p>Â Â Â Â é¢„å¤„ç†è¯­å¥å¤„ç†å™¨(PREPARED)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreparedStatementHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseStatementHandler</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PreparedStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-built_in">super</span>(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// è°ƒç”¨PreparedStatement.executeå’ŒPreparedStatement.getUpdateCount</span><br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> (PreparedStatement) statement;<br>    ps.execute();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> ps.getUpdateCount();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> boundSql.getParameterObject();<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();<br>    keyGenerator.processAfter(executor, mappedStatement, ps, parameterObject);<br>    <span class="hljs-keyword">return</span> rows;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batch</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> (PreparedStatement) statement;<br>    ps.addBatch();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> (PreparedStatement) statement;<br>    ps.execute();<br>    <span class="hljs-keyword">return</span> resultSetHandler.&lt;E&gt; handleResultSets(ps);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// è°ƒç”¨Connection.prepareStatement</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-keyword">if</span> (mappedStatement.getKeyGenerator() <span class="hljs-keyword">instanceof</span> Jdbc3KeyGenerator) &#123;<br>      String[] keyColumnNames = mappedStatement.getKeyColumns();<br>      <span class="hljs-keyword">if</span> (keyColumnNames == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> connection.prepareStatement(sql, PreparedStatement.RETURN_GENERATED_KEYS);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> connection.prepareStatement(sql, keyColumnNames);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappedStatement.getResultSetType() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> connection.prepareStatement(sql, mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> connection.prepareStatement(sql);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// è°ƒç”¨ParameterHandler.setParameters</span><br>    parameterHandler.setParameters((PreparedStatement) statement);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CallableStatementHandler"><a href="#CallableStatementHandler" class="headerlink" title="CallableStatementHandler"></a>CallableStatementHandler</h4><p>Â Â Â Â  Â å­˜å‚¨è¿‡ç¨‹è¯­å¥å¤„ç†å™¨(CALLABLE)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CallableStatementHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseStatementHandler</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CallableStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement mappedStatement, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-built_in">super</span>(executor, mappedStatement, parameter, rowBounds, resultHandler, boundSql);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// è¿™ä¸ªæ–¹æ³•å’ŒPreparedStatementHandlerä»£ç åŸºæœ¬ä¸€æ ·,å°±å¤šäº†æœ€åçš„handleOutputParameters</span><br>    <span class="hljs-comment">// è°ƒç”¨Statement.executeå’ŒStatement.getUpdateCount</span><br>    <span class="hljs-type">CallableStatement</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> (CallableStatement) statement;<br>    cs.execute();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> cs.getUpdateCount();<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> boundSql.getParameterObject();<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> mappedStatement.getKeyGenerator();<br>    keyGenerator.processAfter(executor, mappedStatement, cs, parameterObject);<br>    <span class="hljs-comment">// ç„¶åäº¤ç»™ResultSetHandler.handleOutputParameters</span><br>    resultSetHandler.handleOutputParameters(cs);<br>    <span class="hljs-keyword">return</span> rows;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batch</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">CallableStatement</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> (CallableStatement) statement;<br>    cs.addBatch();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">CallableStatement</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> (CallableStatement) statement;<br>    cs.execute();<br>    List&lt;E&gt; resultList = resultSetHandler.&lt;E&gt;handleResultSets(cs);<br>    resultSetHandler.handleOutputParameters(cs);<br>    <span class="hljs-keyword">return</span> resultList;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">protected</span> Statement <span class="hljs-title function_">instantiateStatement</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// è°ƒç”¨Connection.prepareCall</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-keyword">if</span> (mappedStatement.getResultSetType() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> connection.prepareCall(sql, mappedStatement.getResultSetType().getValue(), ResultSet.CONCUR_READ_ONLY);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> connection.prepareCall(sql);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// æ³¨å†ŒOUTå‚æ•°</span><br>    registerOutputParameters((CallableStatement) statement);<br>    <span class="hljs-comment">// è°ƒç”¨ParameterHandler.setParameters</span><br>    parameterHandler.setParameters((CallableStatement) statement);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerOutputParameters</span><span class="hljs-params">(CallableStatement cs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = parameterMappings.size(); i &lt; n; i++) &#123;<br>      <span class="hljs-type">ParameterMapping</span> <span class="hljs-variable">parameterMapping</span> <span class="hljs-operator">=</span> parameterMappings.get(i);<br>      <span class="hljs-comment">//åªå¤„ç†OUT|INOUT</span><br>      <span class="hljs-keyword">if</span> (parameterMapping.getMode() == ParameterMode.OUT || parameterMapping.getMode() == ParameterMode.INOUT) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == parameterMapping.getJdbcType()) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;The JDBC Type must be specified for output parameter.  Parameter: &quot;</span> + parameterMapping.getProperty());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">if</span> (parameterMapping.getNumericScale() != <span class="hljs-literal">null</span> &amp;&amp; (parameterMapping.getJdbcType() == JdbcType.NUMERIC || parameterMapping.getJdbcType() == JdbcType.DECIMAL)) &#123;<br>            cs.registerOutParameter(i + <span class="hljs-number">1</span>, parameterMapping.getJdbcType().TYPE_CODE, parameterMapping.getNumericScale());<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//æ ¸å¿ƒæ˜¯è°ƒç”¨CallableStatement.registerOutParameter</span><br>            <span class="hljs-keyword">if</span> (parameterMapping.getJdbcTypeName() == <span class="hljs-literal">null</span>) &#123;<br>              cs.registerOutParameter(i + <span class="hljs-number">1</span>, parameterMapping.getJdbcType().TYPE_CODE);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              cs.registerOutParameter(i + <span class="hljs-number">1</span>, parameterMapping.getJdbcType().TYPE_CODE, parameterMapping.getJdbcTypeName());<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="RoutingStatementHandler"><a href="#RoutingStatementHandler" class="headerlink" title="RoutingStatementHandler"></a>RoutingStatementHandler</h4><p>Â Â Â Â  Â è·¯ç”±é€‰æ‹©è¯­å¥å¤„ç†å™¨,æœ‰ç‚¹åƒä»£ç†æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutingStatementHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StatementHandler</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StatementHandler delegate;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">RoutingStatementHandler</span><span class="hljs-params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> &#123;<br><br>    <span class="hljs-comment">// æ ¹æ®è¯­å¥ç±»å‹ï¼Œå§”æ´¾åˆ°ä¸åŒçš„è¯­å¥å¤„ç†å™¨(STATEMENT|PREPARED|CALLABLE)</span><br>    <span class="hljs-keyword">switch</span> (ms.getStatementType()) &#123;<br>      <span class="hljs-keyword">case</span> STATEMENT:<br>        delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> PREPARED:<br>        delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PreparedStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> CALLABLE:<br>        delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CallableStatementHandler</span>(executor, ms, parameter, rowBounds, resultHandler, boundSql);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Unknown statement type: &quot;</span> + ms.getStatementType());<br>    &#125;<br><br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Statement <span class="hljs-title function_">prepare</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> delegate.prepare(connection);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterize</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    delegate.parameterize(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batch</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    delegate.batch(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Statement statement)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> delegate.update(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(Statement statement, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> delegate.&lt;E&gt;query(statement, resultHandler);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.getBoundSql();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> ParameterHandler <span class="hljs-title function_">getParameterHandler</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.getParameterHandler();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h4><p>Â Â Â Â æ‰§è¡Œå™¨æŠ½è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Executor</span> &#123;<br><br>  <span class="hljs-comment">// ä¸éœ€è¦ResultHandler</span><br>  <span class="hljs-type">ResultHandler</span> <span class="hljs-variable">NO_RESULT_HANDLER</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-comment">// æ›´æ–°</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// æŸ¥è¯¢ï¼Œå¸¦åˆ†é¡µï¼Œå¸¦ç¼“å­˜ï¼ŒBoundSql</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey cacheKey, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// æŸ¥è¯¢ï¼Œå¸¦åˆ†é¡µ</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// åˆ·æ–°æ‰¹å¤„ç†è¯­å¥</span><br>  List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// æäº¤å’Œå›æ»šï¼Œå‚æ•°æ˜¯æ˜¯å¦è¦å¼ºåˆ¶</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// åˆ›å»ºCacheKey</span><br>  CacheKey <span class="hljs-title function_">createCacheKey</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span>;<br><br>  <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦ç¼“å­˜äº†</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCached</span><span class="hljs-params">(MappedStatement ms, CacheKey key)</span>;<br><br>  <span class="hljs-comment">// æ¸…ç†Sessionç¼“å­˜</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearLocalCache</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">// å»¶è¿ŸåŠ è½½</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">deferLoad</span><span class="hljs-params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span>;<br><br>  Transaction <span class="hljs-title function_">getTransaction</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">(<span class="hljs-type">boolean</span> forceRollback)</span>;<br><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">isClosed</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecutorWrapper</span><span class="hljs-params">(Executor executor)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BaseExecutor"><a href="#BaseExecutor" class="headerlink" title="BaseExecutor"></a>BaseExecutor</h4><p>Â Â Â Â æ‰§è¡Œå™¨åŸºç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(BaseExecutor.class);<br><br>  <span class="hljs-keyword">protected</span> Transaction transaction;<br>  <span class="hljs-keyword">protected</span> Executor wrapper;<br><br>  <span class="hljs-comment">// å»¶è¿ŸåŠ è½½é˜Ÿåˆ—ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰</span><br>  <span class="hljs-keyword">protected</span> ConcurrentLinkedQueue&lt;DeferredLoad&gt; deferredLoads;<br>  <span class="hljs-comment">// æœ¬åœ°ç¼“å­˜æœºåˆ¶ï¼ˆLocal Cacheï¼‰é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼ˆcircular referencesï¼‰å’ŒåŠ é€Ÿé‡å¤åµŒå¥—æŸ¥è¯¢(ä¸€çº§ç¼“å­˜)</span><br>  <span class="hljs-comment">// æœ¬åœ°ç¼“å­˜</span><br>  <span class="hljs-keyword">protected</span> PerpetualCache localCache;<br>  <span class="hljs-comment">// æœ¬åœ°è¾“å‡ºå‚æ•°ç¼“å­˜</span><br>  <span class="hljs-keyword">protected</span> PerpetualCache localOutputParameterCache;<br>  <span class="hljs-keyword">protected</span> Configuration configuration;<br><br>  <span class="hljs-comment">// æŸ¥è¯¢å †æ ˆ</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">queryStack</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> closed; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">BaseExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> &#123;<br>    <span class="hljs-built_in">this</span>.transaction = transaction;<br>    <span class="hljs-built_in">this</span>.deferredLoads = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedQueue</span>&lt;DeferredLoad&gt;();<br>    <span class="hljs-built_in">this</span>.localCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerpetualCache</span>(<span class="hljs-string">&quot;LocalCache&quot;</span>);<br>    <span class="hljs-built_in">this</span>.localOutputParameterCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerpetualCache</span>(<span class="hljs-string">&quot;LocalOutputParameterCache&quot;</span>);<br>    <span class="hljs-built_in">this</span>.closed = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.wrapper = <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Transaction <span class="hljs-title function_">getTransaction</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> transaction;<br>  &#125; <br><br>  <span class="hljs-comment">// å…³é—­æ‰§è¡Œå™¨</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">(<span class="hljs-type">boolean</span> forceRollback)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123; <br>        <span class="hljs-comment">// æ¸…é™¤æœ¬åœ°ç¼“å­˜ï¼Œflushï¼Œå›æ»š</span><br>        rollback(forceRollback);<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) &#123;<br>          transaction.close();<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-comment">// Ignore.  There&#x27;s nothing that can be done at this point.</span><br>      log.warn(<span class="hljs-string">&quot;Unexpected exception on closing transaction.  Cause: &quot;</span> + e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      transaction = <span class="hljs-literal">null</span>;<br>      deferredLoads = <span class="hljs-literal">null</span>;<br>      localCache = <span class="hljs-literal">null</span>;<br>      localOutputParameterCache = <span class="hljs-literal">null</span>;<br>      closed = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (!closed) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        clearLocalCache();<br>        flushStatements(<span class="hljs-literal">true</span>);<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (required) &#123;<br>          transaction.rollback();<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearLocalCache</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (!closed) &#123;<br>      localCache.clear();<br>      localOutputParameterCache.clear();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> flushStatements(<span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// åˆ·æ–°è¯­å¥ï¼ŒBatchç”¨</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollBack)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> doFlushStatements(isRollBack);<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span><br>      <span class="hljs-keyword">throws</span> SQLException; <br><br>  <span class="hljs-comment">// SqlSession.update/insert/deleteä¼šè°ƒç”¨æ­¤æ–¹æ³•</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing an update&quot;</span>).object(ms.getId());<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// å…ˆæ¸…å±€éƒ¨ç¼“å­˜ï¼Œå†æ›´æ–°ï¼Œå¦‚ä½•æ›´æ–°äº¤ç”±å­ç±»ï¼Œæ¨¡æ¿æ–¹æ³•æ¨¡å¼</span><br>    clearLocalCache();<br>    <span class="hljs-keyword">return</span> doUpdate(ms, parameter);<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span><br>      <span class="hljs-keyword">throws</span> SQLException;  <br><br>  <span class="hljs-comment">// SqlSession.selectListä¼šè°ƒç”¨æ­¤æ–¹æ³•</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// å¾—åˆ°ç»‘å®šsql</span><br>    <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> ms.getBoundSql(parameter);<br>    <span class="hljs-comment">// åˆ›å»ºç¼“å­˜Key</span><br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> createCacheKey(ms, parameter, rowBounds, boundSql);<br>    <span class="hljs-comment">// æŸ¥è¯¢</span><br>    <span class="hljs-keyword">return</span> query(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>  &#125; <br><br>  <span class="hljs-comment">// åˆ›å»ºç¼“å­˜Key</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> CacheKey <span class="hljs-title function_">createCacheKey</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheKey</span>();<br>    <span class="hljs-comment">// MyBatis å¯¹äºå…¶ Key çš„ç”Ÿæˆé‡‡å–è§„åˆ™ä¸ºï¼š[mappedStementId + offset + limit + SQL + queryParams + environment]ç”Ÿæˆä¸€ä¸ªå“ˆå¸Œç </span><br>    cacheKey.update(ms.getId());<br>    cacheKey.update(Integer.valueOf(rowBounds.getOffset()));<br>    cacheKey.update(Integer.valueOf(rowBounds.getLimit()));<br>    cacheKey.update(boundSql.getSql());<br>    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings();<br>    <span class="hljs-type">TypeHandlerRegistry</span> <span class="hljs-variable">typeHandlerRegistry</span> <span class="hljs-operator">=</span> ms.getConfiguration().getTypeHandlerRegistry();<br>    <span class="hljs-comment">// mimic DefaultParameterHandler logic</span><br>    <span class="hljs-comment">// æ¨¡ä»¿DefaultParameterHandlerçš„é€»è¾‘,ä¸å†é‡å¤ï¼Œè¯·å‚è€ƒDefaultParameterHandler</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameterMappings.size(); i++) &#123;<br>      <span class="hljs-type">ParameterMapping</span> <span class="hljs-variable">parameterMapping</span> <span class="hljs-operator">=</span> parameterMappings.get(i);<br>      <span class="hljs-comment">// è¾“å…¥å‹å‚æ•°</span><br>      <span class="hljs-keyword">if</span> (parameterMapping.getMode() != ParameterMode.OUT) &#123;<br>        Object value;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> parameterMapping.getProperty();<br>        <span class="hljs-keyword">if</span> (boundSql.hasAdditionalParameter(propertyName)) &#123;<br>          value = boundSql.getAdditionalParameter(propertyName);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterObject == <span class="hljs-literal">null</span>) &#123;<br>          value = <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) &#123;<br>          value = parameterObject;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameterObject);<br>          value = metaObject.getValue(propertyName);<br>        &#125;<br>        cacheKey.update(value);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (configuration.getEnvironment() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// issue #176</span><br>      cacheKey.update(configuration.getEnvironment().getId());<br>    &#125;<br>    <span class="hljs-keyword">return</span> cacheKey;<br>  &#125; <br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    ErrorContext.instance().resource(ms.getResource()).activity(<span class="hljs-string">&quot;executing a query&quot;</span>).object(ms.getId());<br>    <span class="hljs-comment">// å¦‚æœå·²ç»å…³é—­ï¼ŒæŠ¥é”™</span><br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// å…ˆæ¸…å±€éƒ¨ç¼“å­˜ï¼Œå†æŸ¥è¯¢.ä½†ä»…æŸ¥è¯¢å †æ ˆä¸º0ï¼Œæ‰æ¸…ã€‚ä¸ºäº†å¤„ç†é€’å½’è°ƒç”¨</span><br>    <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;<br>      clearLocalCache();<br>    &#125;<br>    List&lt;E&gt; list;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// åŠ ä¸€,è¿™æ ·é€’å½’è°ƒç”¨åˆ°ä¸Šé¢çš„æ—¶å€™å°±ä¸ä¼šå†æ¸…å±€éƒ¨ç¼“å­˜äº†</span><br>      queryStack++;<br>      <span class="hljs-comment">// å…ˆæ ¹æ®cachekeyä»localCacheå»æŸ¥</span><br>      list = resultHandler == <span class="hljs-literal">null</span> ? (List&lt;E&gt;) localCache.getObject(key) : <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">if</span> (list != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// è‹¥æŸ¥åˆ°localCacheç¼“å­˜ï¼Œå¤„ç†localOutputParameterCache</span><br>        handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ä»æ•°æ®åº“æŸ¥</span><br>        list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);<br>      &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// æ¸…ç©ºå †æ ˆ</span><br>      queryStack--;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// åŠ è½½å»¶è¿ŸåŠ è½½é˜Ÿåˆ—</span><br>      <span class="hljs-keyword">for</span> (DeferredLoad deferredLoad : deferredLoads) &#123;<br>        deferredLoad.load();<br>      &#125;<br>      <span class="hljs-comment">// issue #601</span><br>      <span class="hljs-comment">// æ¸…ç©ºå»¶è¿ŸåŠ è½½é˜Ÿåˆ—</span><br>      deferredLoads.clear();<br>      <span class="hljs-keyword">if</span> (configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;<br>        <span class="hljs-comment">// issue #482</span><br>    <span class="hljs-comment">// å¦‚æœLocalCacheScopeæ˜¯STATEMENTï¼Œæ¸…æœ¬åœ°ç¼“å­˜</span><br>        clearLocalCache();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> list;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLocallyCachedOutputParameters</span><span class="hljs-params">(MappedStatement ms, CacheKey key, Object parameter, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-comment">// å¤„ç†å­˜å‚¨è¿‡ç¨‹çš„OUTå‚æ•°</span><br>    <span class="hljs-keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">cachedParameter</span> <span class="hljs-operator">=</span> localOutputParameterCache.getObject(key);<br>      <span class="hljs-keyword">if</span> (cachedParameter != <span class="hljs-literal">null</span> &amp;&amp; parameter != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// å°†cachedParameterä¸­å±æ€§èµ‹å€¼ç»™parameterä¸­å¯¹åº”çš„å±æ€§</span><br>        <span class="hljs-comment">// å±æ€§ç”± ParameterMapping æŒ‡å®š</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaCachedParameter</span> <span class="hljs-operator">=</span> configuration.newMetaObject(cachedParameter);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaParameter</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameter);<br>        <span class="hljs-keyword">for</span> (ParameterMapping parameterMapping : boundSql.getParameterMappings()) &#123;<br>          <span class="hljs-keyword">if</span> (parameterMapping.getMode() != ParameterMode.IN) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">parameterName</span> <span class="hljs-operator">=</span> parameterMapping.getProperty();<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">cachedValue</span> <span class="hljs-operator">=</span> metaCachedParameter.getValue(parameterName);<br>            metaParameter.setValue(parameterName, cachedValue);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ä»æ•°æ®åº“æŸ¥</span><br>  <span class="hljs-keyword">private</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">queryFromDatabase</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;E&gt; list;<br>    <span class="hljs-comment">// å…ˆå‘ç¼“å­˜ä¸­æ”¾å…¥å ä½ç¬¦ï¼Ÿï¼Ÿï¼Ÿ</span><br>    localCache.putObject(key, EXECUTION_PLACEHOLDER);<br>    <span class="hljs-keyword">try</span> &#123;<br>      list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// æœ€ååˆ é™¤å ä½ç¬¦</span><br>      localCache.removeObject(key);<br>    &#125;<br>    <span class="hljs-comment">// åŠ å…¥ç¼“å­˜</span><br>    localCache.putObject(key, list);<br>    <span class="hljs-comment">// å¦‚æœæ˜¯å­˜å‚¨è¿‡ç¨‹ï¼ŒOUTå‚æ•°ä¹ŸåŠ å…¥ç¼“å­˜</span><br>    <span class="hljs-keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;<br>      localOutputParameterCache.putObject(key, parameter);<br>    &#125;<br>    <span class="hljs-keyword">return</span> list;<br>  &#125; <br><br>  <span class="hljs-comment">//query--&gt;queryFromDatabase--&gt;doQuery</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span><br>      <span class="hljs-keyword">throws</span> SQLException; <br><br>  <span class="hljs-comment">// å»¶è¿ŸåŠ è½½ï¼ŒDefaultResultSetHandler.getNestedQueryMappingValueè°ƒç”¨.å±äºåµŒå¥—æŸ¥è¯¢ï¼Œæ¯”è¾ƒé«˜çº§.</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deferLoad</span><span class="hljs-params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span> &#123;<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Executor was closed.&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">DeferredLoad</span> <span class="hljs-variable">deferredLoad</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeferredLoad</span>(resultObject, property, key, localCache, configuration, targetType);<br>    <span class="hljs-comment">// å¦‚æœèƒ½åŠ è½½ï¼Œåˆ™ç«‹åˆ»åŠ è½½ï¼Œå¦åˆ™åŠ å…¥åˆ°å»¶è¿ŸåŠ è½½é˜Ÿåˆ—ä¸­</span><br>    <span class="hljs-keyword">if</span> (deferredLoad.canLoad()) &#123;<br>      deferredLoad.load();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// è¿™é‡Œæ€ä¹ˆåˆnewäº†ä¸€ä¸ªæ–°çš„ï¼Œæ€§èƒ½æœ‰ç‚¹é—®é¢˜</span><br>      deferredLoads.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DeferredLoad</span>(resultObject, property, key, localCache, configuration, targetType));<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCached</span><span class="hljs-params">(MappedStatement ms, CacheKey key)</span> &#123;<br>    <span class="hljs-keyword">return</span> localCache.getObject(key) != <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (closed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Cannot commit, transaction is already closed&quot;</span>);<br>    &#125;<br>    clearLocalCache();<br>    flushStatements();<br>    <span class="hljs-keyword">if</span> (required) &#123;<br>      transaction.commit();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeStatement</span><span class="hljs-params">(Statement statement)</span> &#123;<br>    <span class="hljs-keyword">if</span> (statement != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        statement.close();<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-comment">// ignore</span><br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> transaction.getConnection();<br>    <span class="hljs-keyword">if</span> (statementLog.isDebugEnabled()) &#123;<br>      <span class="hljs-comment">// å¦‚æœéœ€è¦æ‰“å°Connectionçš„æ—¥å¿—ï¼Œè¿”å›ä¸€ä¸ªConnectionLogger(ä»£ç†æ¨¡å¼, AOPæ€æƒ³)</span><br>      <span class="hljs-keyword">return</span> ConnectionLogger.newInstance(connection, statementLog, queryStack);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> connection;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecutorWrapper</span><span class="hljs-params">(Executor wrapper)</span> &#123;<br>    <span class="hljs-built_in">this</span>.wrapper = wrapper;<br>  &#125; <br><br>  <span class="hljs-comment">// å»¶è¿ŸåŠ è½½</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeferredLoad</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MetaObject resultObject;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String property;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; targetType;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CacheKey key;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PerpetualCache localCache;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectFactory objectFactory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResultExtractor resultExtractor;<br><br>    <span class="hljs-comment">// issue #781</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DeferredLoad</span><span class="hljs-params">(MetaObject resultObject,</span><br><span class="hljs-params">                        String property,</span><br><span class="hljs-params">                        CacheKey key,</span><br><span class="hljs-params">                        PerpetualCache localCache,</span><br><span class="hljs-params">                        Configuration configuration,</span><br><span class="hljs-params">                        Class&lt;?&gt; targetType)</span> &#123;<br>      <span class="hljs-built_in">this</span>.resultObject = resultObject;<br>      <span class="hljs-built_in">this</span>.property = property;<br>      <span class="hljs-built_in">this</span>.key = key;<br>      <span class="hljs-built_in">this</span>.localCache = localCache;<br>      <span class="hljs-built_in">this</span>.objectFactory = configuration.getObjectFactory();<br>      <span class="hljs-built_in">this</span>.resultExtractor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultExtractor</span>(configuration, objectFactory);<br>      <span class="hljs-built_in">this</span>.targetType = targetType;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">canLoad</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// ç¼“å­˜ä¸­æ‰¾åˆ°ï¼Œä¸”ä¸ä¸ºå ä½ç¬¦ï¼Œä»£è¡¨å¯ä»¥åŠ è½½</span><br>      <span class="hljs-keyword">return</span> localCache.getObject(key) != <span class="hljs-literal">null</span> &amp;&amp; localCache.getObject(key) != EXECUTION_PLACEHOLDER;<br>    &#125;<br><br><span class="hljs-comment">// åŠ è½½</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-meta">@SuppressWarnings( &quot;unchecked&quot; )</span><br>      <span class="hljs-comment">// we suppose we get back a List</span><br>      List&lt;Object&gt; list = (List&lt;Object&gt;) localCache.getObject(key);<br>      <span class="hljs-comment">// è°ƒç”¨ResultExtractor.extractObjectFromList</span><br>      <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> resultExtractor.extractObjectFromList(list, targetType);<br>      resultObject.setValue(property, value);<br>    &#125;<br><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SimpleExecutor"><a href="#SimpleExecutor" class="headerlink" title="SimpleExecutor"></a>SimpleExecutor</h4><p>Â Â Â Â ç®€å•æ‰§è¡Œå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> &#123;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration, transaction);<br>  &#125;<br><br>  <span class="hljs-comment">// update</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>      <span class="hljs-comment">// æ–°å»ºä¸€ä¸ªStatementHandler</span><br>      <span class="hljs-comment">// è¿™é‡Œçœ‹åˆ°ResultHandlerä¼ å…¥çš„æ˜¯null</span><br>      <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(<span class="hljs-built_in">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>      <span class="hljs-comment">// å‡†å¤‡è¯­å¥</span><br>      stmt = prepareStatement(handler, ms.getStatementLog());<br>      <span class="hljs-comment">// StatementHandler.update</span><br>      <span class="hljs-keyword">return</span> handler.update(stmt);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      closeStatement(stmt);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// select</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>      <span class="hljs-comment">// æ–°å»ºä¸€ä¸ªStatementHandler</span><br>      <span class="hljs-comment">// è¿™é‡Œçœ‹åˆ°ResultHandlerä¼ å…¥äº†</span><br>      <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);<br>      <span class="hljs-comment">// å‡†å¤‡è¯­å¥</span><br>      stmt = prepareStatement(handler, ms.getStatementLog());<br>      <span class="hljs-comment">// StatementHandler.query</span><br>      <span class="hljs-keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      closeStatement(stmt);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><span class="hljs-comment">// doFlushStatementsåªæ˜¯ç»™batchç”¨çš„ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›ç©º</span><br>    <span class="hljs-keyword">return</span> Collections.emptyList();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> Statement <span class="hljs-title function_">prepareStatement</span><span class="hljs-params">(StatementHandler handler, Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    Statement stmt;<br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getConnection(statementLog);<br>    <span class="hljs-comment">// è°ƒç”¨StatementHandler.prepare</span><br>    stmt = handler.prepare(connection);<br>    <span class="hljs-comment">// è°ƒç”¨StatementHandler.parameterize</span><br>    handler.parameterize(stmt);<br>    <span class="hljs-keyword">return</span> stmt;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ReuseExecutor"><a href="#ReuseExecutor" class="headerlink" title="ReuseExecutor"></a>ReuseExecutor</h4><p>Â Â Â Â å¯é‡ç”¨æ‰§è¡Œå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReuseExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> &#123; <br><br>  <span class="hljs-comment">// å¯é‡ç”¨çš„æ‰§è¡Œå™¨å†…éƒ¨ç”¨äº†ä¸€ä¸ªmapï¼Œç”¨æ¥ç¼“å­˜SQLè¯­å¥å¯¹åº”çš„Statement</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Statement&gt; statementMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Statement&gt;();<br> <br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReuseExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration, transaction);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameter)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>    <span class="hljs-comment">// å’ŒSimpleExecutorä¸€æ ·ï¼Œæ–°å»ºä¸€ä¸ªStatementHandler</span><br>    <span class="hljs-comment">// è¿™é‡Œçœ‹åˆ°ResultHandlerä¼ å…¥çš„æ˜¯null</span><br>    <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(<span class="hljs-built_in">this</span>, ms, parameter, RowBounds.DEFAULT, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">// å‡†å¤‡è¯­å¥</span><br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> prepareStatement(handler, ms.getStatementLog());<br>    <span class="hljs-keyword">return</span> handler.update(stmt);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>    <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> prepareStatement(handler, ms.getStatementLog());<br>    <span class="hljs-keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Statement <span class="hljs-title function_">prepareStatement</span><span class="hljs-params">(StatementHandler handler, Log statementLog)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    Statement stmt;<br>    <span class="hljs-comment">// å¾—åˆ°ç»‘å®šçš„SQLè¯­å¥</span><br>    <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> handler.getBoundSql();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-comment">// å¦‚æœç¼“å­˜ä¸­å·²ç»æœ‰äº†ï¼Œç›´æ¥å¾—åˆ°Statement</span><br>    <span class="hljs-keyword">if</span> (hasStatementFor(sql)) &#123;<br>      stmt = getStatement(sql);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å¦‚æœç¼“å­˜æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™å’ŒSimpleExecutorå¤„ç†å®Œå…¨ä¸€æ ·ï¼Œç„¶ååŠ å…¥ç¼“å­˜</span><br>      <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getConnection(statementLog);<br>      stmt = handler.prepare(connection);<br>      putStatement(sql, stmt);<br>    &#125;<br>    handler.parameterize(stmt);<br>    <span class="hljs-keyword">return</span> stmt;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasStatementFor</span><span class="hljs-params">(String sql)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> statementMap.keySet().contains(sql) &amp;&amp; !statementMap.get(sql).getConnection().isClosed();<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Statement <span class="hljs-title function_">getStatement</span><span class="hljs-params">(String s)</span> &#123;<br>    <span class="hljs-keyword">return</span> statementMap.get(s);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putStatement</span><span class="hljs-params">(String sql, Statement stmt)</span> &#123;<br>    statementMap.put(sql, stmt);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">for</span> (Statement stmt : statementMap.values()) &#123;<br>      closeStatement(stmt);<br>    &#125;<br>    statementMap.clear();<br>    <span class="hljs-keyword">return</span> Collections.emptyList();<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BatchResult"><a href="#BatchResult" class="headerlink" title="BatchResult"></a>BatchResult</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchResult</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MappedStatement mappedStatement;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String sql;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Object&gt; parameterObjects;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] updateCounts;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BatchResult</span><span class="hljs-params">(MappedStatement mappedStatement, String sql)</span> &#123;<br>    <span class="hljs-built_in">super</span>();<br>    <span class="hljs-built_in">this</span>.mappedStatement = mappedStatement;<br>    <span class="hljs-built_in">this</span>.sql = sql;<br>    <span class="hljs-built_in">this</span>.parameterObjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BatchResult</span><span class="hljs-params">(MappedStatement mappedStatement, String sql, Object parameterObject)</span> &#123;<br>    <span class="hljs-built_in">this</span>(mappedStatement, sql);<br>    addParameterObject(parameterObject);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title function_">getMappedStatement</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> mappedStatement;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSql</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> sql;<br>  &#125;<br><br>  <span class="hljs-meta">@Deprecated</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getParameterObject</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> parameterObjects.get(<span class="hljs-number">0</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> List&lt;Object&gt; <span class="hljs-title function_">getParameterObjects</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> parameterObjects;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] getUpdateCounts() &#123;<br>    <span class="hljs-keyword">return</span> updateCounts;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUpdateCounts</span><span class="hljs-params">(<span class="hljs-type">int</span>[] updateCounts)</span> &#123;<br>    <span class="hljs-built_in">this</span>.updateCounts = updateCounts;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addParameterObject</span><span class="hljs-params">(Object parameterObject)</span> &#123;<br>    <span class="hljs-built_in">this</span>.parameterObjects.add(parameterObject);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BatchExecutor"><a href="#BatchExecutor" class="headerlink" title="BatchExecutor"></a>BatchExecutor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchExecutor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseExecutor</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BATCH_UPDATE_RETURN_VALUE</span> <span class="hljs-operator">=</span> Integer.MIN_VALUE + <span class="hljs-number">1002</span>;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Statement&gt; statementList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Statement&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;BatchResult&gt; batchResultList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;BatchResult&gt;();<br>  <span class="hljs-keyword">private</span> String currentSql;<br>  <span class="hljs-keyword">private</span> MappedStatement currentStatement; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BatchExecutor</span><span class="hljs-params">(Configuration configuration, Transaction transaction)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration, transaction);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(MappedStatement ms, Object parameterObject)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(<span class="hljs-built_in">this</span>, ms, parameterObject, RowBounds.DEFAULT, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> handler.getBoundSql();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> boundSql.getSql();<br>    <span class="hljs-keyword">final</span> Statement stmt;<br>    <span class="hljs-comment">// åªè®¾ç½®å‚æ•°</span><br>    <span class="hljs-keyword">if</span> (sql.equals(currentSql) &amp;&amp; ms.equals(currentStatement)) &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> statementList.size() - <span class="hljs-number">1</span>;<br>      stmt = statementList.get(last);<br>      <span class="hljs-type">BatchResult</span> <span class="hljs-variable">batchResult</span> <span class="hljs-operator">=</span> batchResultList.get(last);<br>      batchResult.addParameterObject(parameterObject);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// æ·»åŠ è¦æ‰§è¡Œçš„è¯­å¥å’ŒBatchResult</span><br>      <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getConnection(ms.getStatementLog());<br>      stmt = handler.prepare(connection);<br>      currentSql = sql;<br>      currentStatement = ms;<br>      statementList.add(stmt);<br>      batchResultList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchResult</span>(ms, sql, parameterObject));<br>    &#125;<br>    handler.parameterize(stmt);<br>    handler.batch(stmt);<br>    <span class="hljs-keyword">return</span> BATCH_UPDATE_RETURN_VALUE;<br>  &#125; <br><br>  <span class="hljs-comment">// æŸ¥è¯¢å’Œå…¶ä»–æ‰§è¡Œå™¨å·®ä¸å¤š</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123; <br>      <span class="hljs-comment">// ä¸åŒçš„åœ°æ–¹åœ¨äºæŸ¥è¯¢å‰å…ˆflush</span><br>      flushStatements();<br>      <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> ms.getConfiguration();<br>      <span class="hljs-type">StatementHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> configuration.newStatementHandler(wrapper, ms, parameterObject, rowBounds, resultHandler, boundSql);<br>      <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getConnection(ms.getStatementLog());<br>      stmt = handler.prepare(connection);<br>      handler.parameterize(stmt);<br>      <span class="hljs-keyword">return</span> handler.&lt;E&gt;query(stmt, resultHandler);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      closeStatement(stmt);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">doFlushStatements</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isRollback)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      List&lt;BatchResult&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;BatchResult&gt;();<br>      <span class="hljs-keyword">if</span> (isRollback) &#123;<br>        <span class="hljs-keyword">return</span> Collections.emptyList();<br>      &#125;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = statementList.size(); i &lt; n; i++) &#123;<br>        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> statementList.get(i);<br>        <span class="hljs-type">BatchResult</span> <span class="hljs-variable">batchResult</span> <span class="hljs-operator">=</span> batchResultList.get(i);<br>        <span class="hljs-keyword">try</span> &#123;<br>          batchResult.setUpdateCounts(stmt.executeBatch());<br>          <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> batchResult.getMappedStatement();<br>          List&lt;Object&gt; parameterObjects = batchResult.getParameterObjects();<br>          <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> ms.getKeyGenerator();<br>          <span class="hljs-keyword">if</span> (Jdbc3KeyGenerator.class.equals(keyGenerator.getClass())) &#123;<br>            <span class="hljs-type">Jdbc3KeyGenerator</span> <span class="hljs-variable">jdbc3KeyGenerator</span> <span class="hljs-operator">=</span> (Jdbc3KeyGenerator) keyGenerator;<br>            jdbc3KeyGenerator.processBatch(ms, stmt, parameterObjects);<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!NoKeyGenerator.class.equals(keyGenerator.getClass())) &#123; <span class="hljs-comment">//issue #141</span><br>            <span class="hljs-comment">// selectKeyGenerator</span><br>            <span class="hljs-keyword">for</span> (Object parameter : parameterObjects) &#123;<br>              keyGenerator.processAfter(<span class="hljs-built_in">this</span>, ms, stmt, parameter);<br>            &#125;<br>          &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (BatchUpdateException e) &#123;<br>          <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>          message.append(batchResult.getMappedStatement().getId())<br>              .append(<span class="hljs-string">&quot; (batch index #&quot;</span>)<br>              .append(i + <span class="hljs-number">1</span>)<br>              .append(<span class="hljs-string">&quot;)&quot;</span>)<br>              .append(<span class="hljs-string">&quot; failed.&quot;</span>);<br>          <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) &#123;<br>            message.append(<span class="hljs-string">&quot; &quot;</span>)<br>                .append(i)<br>                .append(<span class="hljs-string">&quot; prior sub executor(s) completed successfully, but will be rolled back.&quot;</span>);<br>          &#125;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchExecutorException</span>(message.toString(), e, results, batchResult);<br>        &#125;<br>        results.add(batchResult);<br>      &#125;<br>      <span class="hljs-keyword">return</span> results;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">for</span> (Statement stmt : statementList) &#123;<br>        closeStatement(stmt);<br>      &#125;<br>      currentSql = <span class="hljs-literal">null</span>;<br>      statementList.clear();<br>      batchResultList.clear();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CachingExecutor"><a href="#CachingExecutor" class="headerlink" title="CachingExecutor"></a>CachingExecutor</h4><p>Â Â Â Â äºŒçº§ç¼“å­˜æ‰§è¡Œå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachingExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Executor</span> &#123; <br><br>  <span class="hljs-keyword">private</span> Executor delegate;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">TransactionalCacheManager</span> <span class="hljs-variable">tcm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionalCacheManager</span>(); <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CachingExecutor</span><span class="hljs-params">(Executor delegate)</span> &#123;<br>    <span class="hljs-built_in">this</span>.delegate = delegate;<br>    delegate.setExecutorWrapper(<span class="hljs-built_in">this</span>);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Transaction <span class="hljs-title function_">getTransaction</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.getTransaction();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">(<span class="hljs-type">boolean</span> forceRollback)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//issues #499, #524 and #573</span><br>      <span class="hljs-keyword">if</span> (forceRollback) &#123; <br>        tcm.rollback();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        tcm.commit();<br>      &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      delegate.close(forceRollback);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isClosed</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.isClosed();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(MappedStatement ms, Object parameterObject)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><span class="hljs-comment">// åˆ·æ–°å®Œç¼“å­˜å†update</span><br>    flushCacheIfRequired(ms);<br>    <span class="hljs-keyword">return</span> delegate.update(ms, parameterObject);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flushCacheIfRequired</span><span class="hljs-params">(MappedStatement ms)</span> &#123;<br>    <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> ms.getCache();<br>    <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span> &amp;&amp; ms.isFlushCacheRequired()) &#123;      <br>      tcm.clear(cache);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> ms.getBoundSql(parameterObject);<br><span class="hljs-comment">// queryæ—¶ä¼ å…¥ä¸€ä¸ªcachekeyå‚æ•°</span><br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> createCacheKey(ms, parameterObject, rowBounds, boundSql);<br>    <span class="hljs-keyword">return</span> query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> CacheKey <span class="hljs-title function_">createCacheKey</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.createCacheKey(ms, parameterObject, rowBounds, boundSql);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> ms.getCache();<br>    <span class="hljs-comment">// é»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰å¼€å¯ç¼“å­˜çš„(äºŒçº§ç¼“å­˜).è¦å¼€å¯äºŒçº§ç¼“å­˜,ä½ éœ€è¦åœ¨ä½ çš„ SQL æ˜ å°„æ–‡ä»¶ä¸­æ·»åŠ ä¸€è¡Œ: &lt;cache/&gt;</span><br>    <span class="hljs-comment">// ç®€å•çš„è¯´ï¼Œå°±æ˜¯å…ˆæŸ¥CacheKeyï¼ŒæŸ¥ä¸åˆ°å†å§”æ‰˜ç»™å®é™…çš„æ‰§è¡Œå™¨å»æŸ¥</span><br>    <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span>) &#123;<br>      flushCacheIfRequired(ms);<br>      <span class="hljs-keyword">if</span> (ms.isUseCache() &amp;&amp; resultHandler == <span class="hljs-literal">null</span>) &#123;<br>        ensureNoOutParams(ms, parameterObject, boundSql);<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);<br>        <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span>) &#123;<br>          list = delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>          tcm.putObject(cache, key, list); <span class="hljs-comment">// issue #578 and #116</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureNoOutParams</span><span class="hljs-params">(MappedStatement ms, Object parameter, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-keyword">if</span> (ms.getStatementType() == StatementType.CALLABLE) &#123;<br>      <span class="hljs-keyword">for</span> (ParameterMapping parameterMapping : boundSql.getParameterMappings()) &#123;<br>        <span class="hljs-keyword">if</span> (parameterMapping.getMode() != ParameterMode.IN) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorException</span>(<span class="hljs-string">&quot;Caching stored procedures with OUT params is not supported.  Please configure useCache=false in &quot;</span> + ms.getId() + <span class="hljs-string">&quot; statement.&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> delegate.flushStatements();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    delegate.commit(required);<br>    tcm.commit();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(<span class="hljs-type">boolean</span> required)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      delegate.rollback(required);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (required) &#123;<br>        tcm.rollback();<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCached</span><span class="hljs-params">(MappedStatement ms, CacheKey key)</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.isCached(ms, key);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deferLoad</span><span class="hljs-params">(MappedStatement ms, MetaObject resultObject, String property, CacheKey key, Class&lt;?&gt; targetType)</span> &#123;<br>    delegate.deferLoad(ms, resultObject, property, key, targetType);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setExecutorWrapper</span><span class="hljs-params">(Executor executor)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;This method should not be called&quot;</span>);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearLocalCache</span><span class="hljs-params">()</span> &#123;<br>    delegate.clearLocalCache();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>15-binding</title>
    <link href="/2023/08/27/mybatis-source-code/15-binding/"/>
    <url>/2023/08/27/mybatis-source-code/15-binding/</url>
    
    <content type="html"><![CDATA[<h4 id="MapperMethod"><a href="#MapperMethod" class="headerlink" title="MapperMethod"></a>MapperMethod</h4><p>Â Â Â Â Mapperæ¥å£ä¸­æ–¹æ³•çš„å°è£…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperMethod</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlCommand command;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MethodSignature method; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperMethod</span><span class="hljs-params">(Class&lt;?&gt; mapperInterface, Method method, Configuration config)</span> &#123;<br>    <span class="hljs-built_in">this</span>.command = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlCommand</span>(config, mapperInterface, method);<br>    <span class="hljs-built_in">this</span>.method = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodSignature</span>(config, method);<br>  &#125; <br><br>  <span class="hljs-comment">// SQLå‘½ä»¤ï¼Œé™æ€å†…éƒ¨ç±»</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlCommand</span> &#123; <br><br>    <span class="hljs-comment">// åˆ†åˆ«å¯¹åº” MappedStatement çš„idå’Œsqlå‘½ä»¤ç±»å‹</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlCommandType type; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SqlCommand</span><span class="hljs-params">(Configuration configuration, Class&lt;?&gt; mapperInterface, Method method)</span> &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">statementName</span> <span class="hljs-operator">=</span> mapperInterface.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName();<br>      <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">if</span> (configuration.hasStatement(statementName)) &#123;<br>        ms = configuration.getMappedStatement(statementName);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!mapperInterface.getName().equals(method.getDeclaringClass().getName())) &#123; <span class="hljs-comment">// issue #35</span><br>        <span class="hljs-comment">// å¦‚æœä¸æ˜¯è¿™ä¸ªmapperæ¥å£çš„æ–¹æ³•ï¼Œå†å»æŸ¥çˆ¶ç±»</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">parentStatementName</span> <span class="hljs-operator">=</span> method.getDeclaringClass().getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName();<br>        <span class="hljs-keyword">if</span> (configuration.hasStatement(parentStatementName)) &#123;<br>          ms = configuration.getMappedStatement(parentStatementName);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (ms == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Invalid bound statement (not found): &quot;</span> + statementName);<br>      &#125;<br>      name = ms.getId();<br>      type = ms.getSqlCommandType();<br>      <span class="hljs-keyword">if</span> (type == SqlCommandType.UNKNOWN) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Unknown execution method for: &quot;</span> + name);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> SqlCommandType <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> type;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ–¹æ³•ç­¾åï¼Œé™æ€å†…éƒ¨ç±»</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodSignature</span> &#123; <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> returnsMany;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> returnsMap;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> returnsVoid;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; returnType;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String mapKey;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer resultHandlerIndex;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer rowBoundsIndex;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SortedMap&lt;Integer, String&gt; params;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> hasNamedParameters; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MethodSignature</span><span class="hljs-params">(Configuration configuration, Method method)</span> &#123;<br>      <span class="hljs-built_in">this</span>.returnType = method.getReturnType();<br>      <span class="hljs-built_in">this</span>.returnsVoid = <span class="hljs-keyword">void</span>.class.equals(<span class="hljs-built_in">this</span>.returnType);<br>      <span class="hljs-built_in">this</span>.returnsMany = (configuration.getObjectFactory().isCollection(<span class="hljs-built_in">this</span>.returnType) || <span class="hljs-built_in">this</span>.returnType.isArray());<br>      <span class="hljs-built_in">this</span>.mapKey = getMapKey(method);<br>      <span class="hljs-built_in">this</span>.returnsMap = (<span class="hljs-built_in">this</span>.mapKey != <span class="hljs-literal">null</span>);<br>      <span class="hljs-built_in">this</span>.hasNamedParameters = hasNamedParams(method);<br>      <span class="hljs-comment">// ä»¥ä¸‹é‡å¤å¾ªç¯2éè°ƒç”¨getUniqueParamIndexï¼Œæ˜¯ä¸æ˜¯é™ä½æ•ˆç‡äº†</span><br>      <span class="hljs-comment">// è®°ä¸‹RowBoundsæ˜¯ç¬¬å‡ ä¸ªå‚æ•°</span><br>      <span class="hljs-built_in">this</span>.rowBoundsIndex = getUniqueParamIndex(method, RowBounds.class);<br>      <span class="hljs-comment">// è®°ä¸‹ResultHandleræ˜¯ç¬¬å‡ ä¸ªå‚æ•°</span><br>      <span class="hljs-built_in">this</span>.resultHandlerIndex = getUniqueParamIndex(method, ResultHandler.class);<br>      <span class="hljs-built_in">this</span>.params = Collections.unmodifiableSortedMap(getParams(method, <span class="hljs-built_in">this</span>.hasNamedParameters));<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getMapKey</span><span class="hljs-params">(Method method)</span> &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">mapKey</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">if</span> (Map.class.isAssignableFrom(method.getReturnType())) &#123;<br>        <span class="hljs-comment">// å¦‚æœè¿”å›ç±»å‹æ˜¯mapç±»å‹çš„ï¼ŒæŸ¥çœ‹è¯¥methodæ˜¯å¦æœ‰MapKeyæ³¨è§£ã€‚å¦‚æœæœ‰è¿™ä¸ªæ³¨è§£ï¼Œå°†è¿™ä¸ªæ³¨è§£çš„å€¼ä½œä¸ºmapçš„key</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">MapKey</span> <span class="hljs-variable">mapKeyAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(MapKey.class);<br>        <span class="hljs-keyword">if</span> (mapKeyAnnotation != <span class="hljs-literal">null</span>) &#123;<br>          mapKey = mapKeyAnnotation.value();<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> mapKey;<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNamedParams</span><span class="hljs-params">(Method method)</span> &#123;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">hasNamedParams</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">final</span> Object[][] paramAnnos = method.getParameterAnnotations();<br>      <span class="hljs-keyword">for</span> (Object[] paramAnno : paramAnnos) &#123;<br>        <span class="hljs-keyword">for</span> (Object aParamAnno : paramAnno) &#123;<br>          <span class="hljs-keyword">if</span> (aParamAnno <span class="hljs-keyword">instanceof</span> Param) &#123;<br>            <span class="hljs-comment">// æŸ¥æ‰¾@Paramæ³¨è§£</span><br>            hasNamedParams = <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">break</span>;<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> hasNamedParams;<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> Integer <span class="hljs-title function_">getUniqueParamIndex</span><span class="hljs-params">(Method method, Class&lt;?&gt; paramType)</span> &#123;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt;[] argTypes = method.getParameterTypes();<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; argTypes.length; i++) &#123;<br>        <span class="hljs-keyword">if</span> (paramType.isAssignableFrom(argTypes[i])) &#123;<br>          <span class="hljs-keyword">if</span> (index == <span class="hljs-literal">null</span>) &#123;<br>            index = i;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(method.getName() + <span class="hljs-string">&quot; cannot have multiple &quot;</span> + paramType.getSimpleName() + <span class="hljs-string">&quot; parameters&quot;</span>);<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> index;<br>    &#125; <br><br>    <span class="hljs-comment">// å¾—åˆ°æ‰€æœ‰å‚æ•°</span><br>    <span class="hljs-keyword">private</span> SortedMap&lt;Integer, String&gt; <span class="hljs-title function_">getParams</span><span class="hljs-params">(Method method, <span class="hljs-type">boolean</span> hasNamedParameters)</span> &#123;<br>      <span class="hljs-comment">// ç”¨ä¸€ä¸ªTreeMap,è¿™æ ·å°±ä¿è¯è¿˜æ˜¯æŒ‰å‚æ•°çš„å…ˆåé¡ºåº</span><br>      <span class="hljs-keyword">final</span> SortedMap&lt;Integer, String&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>&lt;Integer, String&gt;();<br>      <span class="hljs-keyword">final</span> Class&lt;?&gt;[] argTypes = method.getParameterTypes();<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; argTypes.length; i++) &#123;<br>        <span class="hljs-comment">// æ˜¯å¦ä¸æ˜¯RowBounds/ResultHandlerç±»å‹çš„å‚æ•°</span><br>        <span class="hljs-keyword">if</span> (!RowBounds.class.isAssignableFrom(argTypes[i]) &amp;&amp; !ResultHandler.class.isAssignableFrom(argTypes[i])) &#123;<br>          <span class="hljs-comment">// å‚æ•°åå­—é»˜è®¤ä¸º0,1,2ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆxmlé‡Œé¢å¯ä»¥ç”¨#&#123;1&#125;è¿™æ ·çš„å†™æ³•æ¥è¡¨ç¤ºå‚æ•°äº†</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">paramName</span> <span class="hljs-operator">=</span> String.valueOf(params.size());<br>          <span class="hljs-keyword">if</span> (hasNamedParameters) &#123;<br>            <span class="hljs-comment">// è¿˜å¯ä»¥ç”¨æ³¨è§£@Paramæ¥é‡å‘½åå‚æ•°</span><br>            paramName = getParamNameFromAnnotation(method, i, paramName);<br>          &#125;<br>          params.put(i, paramName);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> params;<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getParamNameFromAnnotation</span><span class="hljs-params">(Method method, <span class="hljs-type">int</span> i, String paramName)</span> &#123;<br>      <span class="hljs-keyword">final</span> Object[] paramAnnos = method.getParameterAnnotations()[i];<br>      <span class="hljs-keyword">for</span> (Object paramAnno : paramAnnos) &#123;<br>        <span class="hljs-keyword">if</span> (paramAnno <span class="hljs-keyword">instanceof</span> Param) &#123;<br>          paramName = ((Param) paramAnno).value();<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> paramName;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">convertArgsToSqlCommandParam</span><span class="hljs-params">(Object[] args)</span> &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">paramCount</span> <span class="hljs-operator">=</span> params.size();<br>      <span class="hljs-keyword">if</span> (args == <span class="hljs-literal">null</span> || paramCount == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// å¦‚æœæ²¡å‚æ•°</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!hasNamedParameters &amp;&amp; paramCount == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°</span><br>        <span class="hljs-keyword">return</span> args[params.keySet().iterator().next().intValue()];<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦åˆ™ï¼Œè¿”å›ä¸€ä¸ªParamMapï¼Œä¿®æ”¹å‚æ•°åï¼Œå‚æ•°åå°±æ˜¯å…¶ä½ç½®</span><br>        <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; param = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParamMap</span>&lt;Object&gt;();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;Integer, String&gt; entry : params.entrySet()) &#123;<br>          <span class="hljs-comment">// 1.å…ˆåŠ ä¸€ä¸ª#&#123;0&#125;,#&#123;1&#125;,#&#123;2&#125;...å‚æ•°</span><br>          param.put(entry.getValue(), args[entry.getKey().intValue()]);<br>          <span class="hljs-comment">// issue #71, add param names as param1, param2...but ensure backward compatibility</span><br>          <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">genericParamName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;param&quot;</span> + String.valueOf(i + <span class="hljs-number">1</span>);<br>          <span class="hljs-keyword">if</span> (!param.containsKey(genericParamName)) &#123;<br>            <span class="hljs-comment">// 2.å†åŠ ä¸€ä¸ª#&#123;param1&#125;,#&#123;param2&#125;...å‚æ•°</span><br>            <span class="hljs-comment">// ä½ å¯ä»¥ä¼ é€’å¤šä¸ªå‚æ•°ç»™ä¸€ä¸ªæ˜ å°„å™¨æ–¹æ³•ã€‚å¦‚æœä½ è¿™æ ·åšäº†,</span><br>            <span class="hljs-comment">// é»˜è®¤æƒ…å†µä¸‹å®ƒä»¬å°†ä¼šä»¥å®ƒä»¬åœ¨å‚æ•°åˆ—è¡¨ä¸­çš„ä½ç½®æ¥å‘½å,æ¯”å¦‚:#&#123;param1&#125;,#&#123;param2&#125;ç­‰ã€‚</span><br>            <span class="hljs-comment">// å¦‚æœä½ æƒ³æ”¹å˜å‚æ•°çš„åç§°(åªåœ¨å¤šå‚æ•°æƒ…å†µä¸‹) ,é‚£ä¹ˆä½ å¯ä»¥åœ¨å‚æ•°ä¸Šä½¿ç”¨@Param(â€œparamNameâ€)æ³¨è§£ã€‚</span><br>            param.put(genericParamName, args[entry.getKey()]);<br>          &#125;<br>          i++;<br>        &#125;<br>        <span class="hljs-keyword">return</span> param;<br>      &#125;<br>    &#125; <br><br>    <span class="hljs-comment">// getæ–¹æ³•ç•¥</span><br>  &#125; <br><br>  <span class="hljs-comment">// å‚æ•°mapï¼Œé™æ€å†…éƒ¨ç±»,æ›´ä¸¥æ ¼çš„getæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ç›¸åº”çš„keyï¼ŒæŠ¥é”™</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParamMap</span>&lt;V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>&lt;String, V&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2212268410512043556L</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">super</span>.containsKey(key)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Parameter &#x27;&quot;</span> + key + <span class="hljs-string">&quot;&#x27; not found. Available parameters are &quot;</span> + keySet());<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.get(key);<br>    &#125;<br><br>  &#125; <br><br>  <span class="hljs-comment">// æ‰§è¡Œ</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(SqlSession sqlSession, Object[] args)</span> &#123;<br>    Object result;<br>    <span class="hljs-comment">// å¯ä»¥çœ‹åˆ°æ‰§è¡Œæ—¶å°±æ˜¯4ç§æƒ…å†µï¼Œinsert|update|delete|selectï¼Œåˆ†åˆ«è°ƒç”¨SqlSessionçš„4å¤§ç±»æ–¹æ³•</span><br>    <span class="hljs-keyword">if</span> (SqlCommandType.INSERT == command.getType()) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>      result = rowCountResult(sqlSession.insert(command.getName(), param));<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (SqlCommandType.UPDATE == command.getType()) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>      result = rowCountResult(sqlSession.update(command.getName(), param));<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (SqlCommandType.DELETE == command.getType()) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>      result = rowCountResult(sqlSession.delete(command.getName(), param));<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (SqlCommandType.SELECT == command.getType()) &#123;<br>      <span class="hljs-keyword">if</span> (method.returnsVoid() &amp;&amp; method.hasResultHandler()) &#123;<br>        <span class="hljs-comment">// å¦‚æœæœ‰ç»“æœå¤„ç†å™¨</span><br>        executeWithResultHandler(sqlSession, args);<br>        result = <span class="hljs-literal">null</span>;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMany()) &#123;<br>        <span class="hljs-comment">// å¦‚æœç»“æœæœ‰å¤šæ¡è®°å½•</span><br>        result = executeForMany(sqlSession, args);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.returnsMap()) &#123;<br>        <span class="hljs-comment">// å¦‚æœç»“æœæ˜¯map</span><br>        result = executeForMap(sqlSession, args);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦åˆ™å°±æ˜¯ä¸€æ¡è®°å½•</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>        result = sqlSession.selectOne(command.getName(), param);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Unknown execution method for: &quot;</span> + command.getName());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> &amp;&amp; method.getReturnType().isPrimitive() &amp;&amp; !method.returnsVoid()) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Mapper method &#x27;&quot;</span> + command.getName() <br>          + <span class="hljs-string">&quot; attempted to return null from a method with a primitive return type (&quot;</span> + method.getReturnType() + <span class="hljs-string">&quot;).&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125; <br><br>  <span class="hljs-comment">// è¿™ä¸ªæ–¹æ³•å¯¹è¿”å›å€¼çš„ç±»å‹è¿›è¡Œäº†ä¸€äº›æ£€æŸ¥ï¼Œä½¿å¾—æ›´å®‰å…¨</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">rowCountResult</span><span class="hljs-params">(<span class="hljs-type">int</span> rowCount)</span> &#123;<br>    <span class="hljs-keyword">final</span> Object result;<br>    <span class="hljs-keyword">if</span> (method.returnsVoid()) &#123;<br>      result = <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Integer.class.equals(method.getReturnType()) || Integer.TYPE.equals(method.getReturnType())) &#123;<br>      <span class="hljs-comment">// å¦‚æœè¿”å›å€¼æ˜¯å¤§intæˆ–å°int</span><br>      result = Integer.valueOf(rowCount);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Long.class.equals(method.getReturnType()) || Long.TYPE.equals(method.getReturnType())) &#123;<br>      <span class="hljs-comment">// å¦‚æœè¿”å›å€¼æ˜¯å¤§longæˆ–å°long</span><br>      result = Long.valueOf(rowCount);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Boolean.class.equals(method.getReturnType()) || Boolean.TYPE.equals(method.getReturnType())) &#123;<br>      <span class="hljs-comment">// å¦‚æœè¿”å›å€¼æ˜¯å¤§booleanæˆ–å°boolean</span><br>      result = Boolean.valueOf(rowCount &gt; <span class="hljs-number">0</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Mapper method &#x27;&quot;</span> + command.getName() + <span class="hljs-string">&quot;&#x27; has an unsupported return type: &quot;</span> + method.getReturnType());<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125; <br><br>  <span class="hljs-comment">// ç»“æœå¤„ç†å™¨</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeWithResultHandler</span><span class="hljs-params">(SqlSession sqlSession, Object[] args)</span> &#123;<br>    <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> sqlSession.getConfiguration().getMappedStatement(command.getName());<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">void</span>.class.equals(ms.getResultMaps().get(<span class="hljs-number">0</span>).getType())) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;method &quot;</span> + command.getName() <br>          + <span class="hljs-string">&quot; needs either a @ResultMap annotation, a @ResultType annotation,&quot;</span> <br>          + <span class="hljs-string">&quot; or a resultType attribute in XML so a ResultHandler can be used as a parameter.&quot;</span>);<br>    &#125;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>    <span class="hljs-keyword">if</span> (method.hasRowBounds()) &#123;<br>      <span class="hljs-type">RowBounds</span> <span class="hljs-variable">rowBounds</span> <span class="hljs-operator">=</span> method.extractRowBounds(args);<br>      sqlSession.select(command.getName(), param, rowBounds, method.extractResultHandler(args));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      sqlSession.select(command.getName(), param, method.extractResultHandler(args));<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å¤šæ¡è®°å½•</span><br>  <span class="hljs-keyword">private</span> &lt;E&gt; Object <span class="hljs-title function_">executeForMany</span><span class="hljs-params">(SqlSession sqlSession, Object[] args)</span> &#123;<br>    List&lt;E&gt; result;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>    <span class="hljs-comment">// ä»£å…¥RowBounds</span><br>    <span class="hljs-keyword">if</span> (method.hasRowBounds()) &#123;<br>      <span class="hljs-type">RowBounds</span> <span class="hljs-variable">rowBounds</span> <span class="hljs-operator">=</span> method.extractRowBounds(args);<br>      result = sqlSession.&lt;E&gt;selectList(command.getName(), param, rowBounds);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      result = sqlSession.&lt;E&gt;selectList(command.getName(), param);<br>    &#125;<br>    <span class="hljs-comment">// issue #510 Collections &amp; arrays support</span><br>    <span class="hljs-keyword">if</span> (!method.getReturnType().isAssignableFrom(result.getClass())) &#123;<br>      <span class="hljs-keyword">if</span> (method.getReturnType().isArray()) &#123;<br>        <span class="hljs-keyword">return</span> convertToArray(result);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> convertToDeclaredCollection(sqlSession.getConfiguration(), result);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125; <br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">private</span> &lt;E&gt; E[] convertToArray(List&lt;E&gt; list) &#123;<br>    E[] array = (E[]) Array.newInstance(method.getReturnType().getComponentType(), list.size());<br>    array = list.toArray(array);<br>    <span class="hljs-keyword">return</span> array;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> &lt;E&gt; Object <span class="hljs-title function_">convertToDeclaredCollection</span><span class="hljs-params">(Configuration config, List&lt;E&gt; list)</span> &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">collection</span> <span class="hljs-operator">=</span> config.getObjectFactory().create(method.getReturnType());<br>    <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> config.newMetaObject(collection);<br>    metaObject.addAll(list);<br>    <span class="hljs-keyword">return</span> collection;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> &lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-title function_">executeForMap</span><span class="hljs-params">(SqlSession sqlSession, Object[] args)</span> &#123;<br>    Map&lt;K, V&gt; result;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">param</span> <span class="hljs-operator">=</span> method.convertArgsToSqlCommandParam(args);<br>    <span class="hljs-keyword">if</span> (method.hasRowBounds()) &#123;<br>      <span class="hljs-type">RowBounds</span> <span class="hljs-variable">rowBounds</span> <span class="hljs-operator">=</span> method.extractRowBounds(args);<br>      result = sqlSession.&lt;K, V&gt;selectMap(command.getName(), param, method.getMapKey(), rowBounds);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      result = sqlSession.&lt;K, V&gt;selectMap(command.getName(), param, method.getMapKey());<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MapperProxy"><a href="#MapperProxy" class="headerlink" title="MapperProxy"></a>MapperProxy</h4><p>Â Â Â Â æ˜ å°„å™¨ä»£ç†ï¼Œä»£ç†æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxy</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span>, Serializable &#123;<br> <br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">6424540398559729838L</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSession sqlSession;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperProxy</span><span class="hljs-params">(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, Map&lt;Method, MapperMethod&gt; methodCache)</span> &#123;<br>    <span class="hljs-built_in">this</span>.sqlSession = sqlSession;<br>    <span class="hljs-built_in">this</span>.mapperInterface = mapperInterface;<br>    <span class="hljs-built_in">this</span>.methodCache = methodCache;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-comment">// ä»£ç†ä»¥åï¼Œæ‰€æœ‰Mapperçš„æ–¹æ³•è°ƒç”¨æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨è¿™ä¸ªinvokeæ–¹æ³•</span><br>    <span class="hljs-comment">// å¹¶ä¸æ˜¯ä»»ä½•ä¸€ä¸ªæ–¹æ³•éƒ½éœ€è¦æ‰§è¡Œè°ƒç”¨ä»£ç†å¯¹è±¡è¿›è¡Œæ‰§è¡Œï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯Objectä¸­é€šç”¨çš„æ–¹æ³•ï¼ˆtoStringã€hashCodeç­‰ï¼‰æ— éœ€æ‰§è¡Œ</span><br>    <span class="hljs-keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>, args);<br>      &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// è¿™é‡Œä¼˜åŒ–äº†ï¼Œå»ç¼“å­˜ä¸­æ‰¾MapperMethod</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">MapperMethod</span> <span class="hljs-variable">mapperMethod</span> <span class="hljs-operator">=</span> cachedMapperMethod(method);<br>    <span class="hljs-comment">// æ‰§è¡Œ</span><br>    <span class="hljs-keyword">return</span> mapperMethod.execute(sqlSession, args);<br>  &#125; <br><br>  <span class="hljs-comment">// å»ç¼“å­˜ä¸­æ‰¾MapperMethod</span><br>  <span class="hljs-keyword">private</span> MapperMethod <span class="hljs-title function_">cachedMapperMethod</span><span class="hljs-params">(Method method)</span> &#123;<br>    <span class="hljs-type">MapperMethod</span> <span class="hljs-variable">mapperMethod</span> <span class="hljs-operator">=</span> methodCache.get(method);<br>    <span class="hljs-keyword">if</span> (mapperMethod == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// æ‰¾ä¸åˆ°æ‰å»new</span><br>      mapperMethod = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperMethod</span>(mapperInterface, method, sqlSession.getConfiguration());<br>      methodCache.put(method, mapperMethod);<br>    &#125;<br>    <span class="hljs-keyword">return</span> mapperMethod;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MapperProxyFactory"><a href="#MapperProxyFactory" class="headerlink" title="MapperProxyFactory"></a>MapperProxyFactory</h4><p>Â Â Â Â æ˜ å°„å™¨ä»£ç†å·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxyFactory</span>&lt;T&gt; &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;<br>  <span class="hljs-keyword">private</span> Map&lt;Method, MapperMethod&gt; methodCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;Method, MapperMethod&gt;();<br> <br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperProxyFactory</span><span class="hljs-params">(Class&lt;T&gt; mapperInterface)</span> &#123;<br>    <span class="hljs-built_in">this</span>.mapperInterface = mapperInterface;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Class&lt;T&gt; <span class="hljs-title function_">getMapperInterface</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> mapperInterface;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Map&lt;Method, MapperMethod&gt; <span class="hljs-title function_">getMethodCache</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> methodCache;<br>  &#125; <br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">protected</span> T <span class="hljs-title function_">newInstance</span><span class="hljs-params">(MapperProxy&lt;T&gt; mapperProxy)</span> &#123;<br>    <span class="hljs-comment">// ç”¨JDKè‡ªå¸¦çš„åŠ¨æ€ä»£ç†ç”Ÿæˆæ˜ å°„å™¨</span><br>    <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; mapperInterface &#125;, mapperProxy);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">newInstance</span><span class="hljs-params">(SqlSession sqlSession)</span> &#123;<br>    <span class="hljs-keyword">final</span> MapperProxy&lt;T&gt; mapperProxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxy</span>&lt;T&gt;(sqlSession, mapperInterface, methodCache);<br>    <span class="hljs-keyword">return</span> newInstance(mapperProxy);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MapperRegistry"><a href="#MapperRegistry" class="headerlink" title="MapperRegistry"></a>MapperRegistry</h4><p>Â Â Â Â æ˜ å°„å™¨æ³¨å†Œæœº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperRegistry</span> &#123; <br><br>  <span class="hljs-keyword">private</span> Configuration config;<br>  <span class="hljs-comment">// å°†å·²ç»æ·»åŠ çš„æ˜ å°„éƒ½æ”¾å…¥HashMap</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt;();<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperRegistry</span><span class="hljs-params">(Configuration config)</span> &#123;<br>    <span class="hljs-built_in">this</span>.config = config;<br>  &#125; <br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-comment">// è¿”å›ä»£ç†ç±» </span><br>  <span class="hljs-comment">// åœ¨mybatisä¸­åªæœ‰Configurationç±»ç”¨åˆ°äº†è¿™ä¸ªæ–¹æ³•</span><br>  <span class="hljs-comment">// åœ¨mybatis-springä¸­åº”è¯¥ä¼šä½¿ç”¨è¿™ä¸ªæ–¹æ³•ç”ŸæˆMapperçš„ä»£ç†ç±»</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type, SqlSession sqlSession)</span> &#123;<br>    <span class="hljs-keyword">final</span> MapperProxyFactory&lt;T&gt; mapperProxyFactory = (MapperProxyFactory&lt;T&gt;) knownMappers.get(type);<br>    <span class="hljs-keyword">if</span> (mapperProxyFactory == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Type &quot;</span> + type + <span class="hljs-string">&quot; is not known to the MapperRegistry.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> mapperProxyFactory.newInstance(sqlSession);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Error getting mapper instance. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>    <span class="hljs-keyword">return</span> knownMappers.containsKey(type);<br>  &#125; <br><br>  <span class="hljs-comment">// çœ‹ä¸€ä¸‹å¦‚ä½•æ·»åŠ ä¸€ä¸ªæ˜ å°„</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>    <span class="hljs-comment">// mapperå¿…é¡»æ˜¯æ¥å£ï¼æ‰ä¼šæ·»åŠ </span><br>    <span class="hljs-keyword">if</span> (type.isInterface()) &#123;<br>      <span class="hljs-keyword">if</span> (hasMapper(type)) &#123;<br>        <span class="hljs-comment">// å¦‚æœé‡å¤æ·»åŠ äº†ï¼ŒæŠ¥é”™</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Type &quot;</span> + type + <span class="hljs-string">&quot; is already known to the MapperRegistry.&quot;</span>);<br>      &#125;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">loadCompleted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        knownMappers.put(type, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxyFactory</span>&lt;T&gt;(type));<br>        <span class="hljs-comment">// It&#x27;s important that the type is added before the parser is run</span><br>        <span class="hljs-comment">// otherwise the binding may automatically be attempted by the</span><br>        <span class="hljs-comment">// mapper parser. If the type is already known, it won&#x27;t try.</span><br>        <span class="hljs-type">MapperAnnotationBuilder</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperAnnotationBuilder</span>(config, type);<br>        parser.parse();<br>        loadCompleted = <span class="hljs-literal">true</span>;<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœåŠ è½½è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸éœ€è¦å†å°†è¿™ä¸ªmapperä»mybatisä¸­åˆ é™¤,è¿™ç§æ–¹å¼æ¯”è¾ƒä¸‘é™‹å§ï¼Œéš¾é“æ˜¯ä¸å¾—å·²è€Œä¸ºä¹‹ï¼Ÿ</span><br>        <span class="hljs-keyword">if</span> (!loadCompleted) &#123;<br>          knownMappers.remove(type);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@since</span> 3.2.2</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> Collection&lt;Class&lt;?&gt;&gt; getMappers() &#123;<br>    <span class="hljs-keyword">return</span> Collections.unmodifiableCollection(knownMappers.keySet());<br>  &#125; <br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@since</span> 3.2.2</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMappers</span><span class="hljs-params">(String packageName, Class&lt;?&gt; superType)</span> &#123;<br>    <span class="hljs-comment">// æŸ¥æ‰¾åŒ…ä¸‹æ‰€æœ‰æ˜¯superTypeçš„ç±»</span><br>    ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResolverUtil</span>&lt;Class&lt;?&gt;&gt;();<br>    resolverUtil.find(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ResolverUtil</span>.IsA(superType), packageName);<br>    Set&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Class</span>&lt;?&gt;&gt;&gt; mapperSet = resolverUtil.getClasses();<br>    <span class="hljs-keyword">for</span> (Class&lt;?&gt; mapperClass : mapperSet) &#123;<br>      addMapper(mapperClass);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@since</span> 3.2.2</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">//æŸ¥æ‰¾åŒ…ä¸‹æ‰€æœ‰ç±»</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMappers</span><span class="hljs-params">(String packageName)</span> &#123;<br>    addMappers(packageName, Object.class);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>14-builder</title>
    <link href="/2023/08/16/mybatis-source-code/14-builder/"/>
    <url>/2023/08/16/mybatis-source-code/14-builder/</url>
    
    <content type="html"><![CDATA[<h4 id="BaseBuilder"><a href="#BaseBuilder" class="headerlink" title="BaseBuilder"></a>BaseBuilder</h4><p>Â Â Â Â æ„é€ å™¨çš„åŸºç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-comment">// éœ€è¦é…ç½®ï¼Œç±»å‹åˆ«åæ³¨å†Œï¼Œç±»å‹å¤„ç†å™¨æ³¨å†Œ3ä¸ªç±»</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Configuration configuration; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> TypeAliasRegistry typeAliasRegistry;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> TypeHandlerRegistry typeHandlerRegistry; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseBuilder</span><span class="hljs-params">(Configuration configuration)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.typeAliasRegistry = <span class="hljs-built_in">this</span>.configuration.getTypeAliasRegistry();<br>    <span class="hljs-built_in">this</span>.typeHandlerRegistry = <span class="hljs-built_in">this</span>.configuration.getTypeHandlerRegistry();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Configuration <span class="hljs-title function_">getConfiguration</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> configuration;<br>  &#125; <br><br>  <span class="hljs-comment">// ä¸‹é¢çš„æ–¹æ³•éƒ½æ”¯æŒé»˜è®¤å€¼</span><br>  <span class="hljs-keyword">protected</span> Pattern <span class="hljs-title function_">parseExpression</span><span class="hljs-params">(String regex, String defaultValue)</span> &#123;<br>    <span class="hljs-keyword">return</span> Pattern.compile(regex == <span class="hljs-literal">null</span> ? defaultValue : regex);<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> Boolean <span class="hljs-title function_">booleanValueOf</span><span class="hljs-params">(String value, Boolean defaultValue)</span> &#123;<br>    <span class="hljs-keyword">return</span> value == <span class="hljs-literal">null</span> ? defaultValue : Boolean.valueOf(value);<br>  &#125;<br><br>  <span class="hljs-keyword">protected</span> Integer <span class="hljs-title function_">integerValueOf</span><span class="hljs-params">(String value, Integer defaultValue)</span> &#123;<br>    <span class="hljs-keyword">return</span> value == <span class="hljs-literal">null</span> ? defaultValue : Integer.valueOf(value);<br>  &#125; <br><br>  <span class="hljs-comment">// æŠŠä»¥é€—å·åˆ†å‰²çš„ä¸€ä¸ªå­—ç¬¦ä¸²é‡æ–°åŒ…è£…ï¼Œè¿”å›ä¸€ä¸ªSet</span><br>  <span class="hljs-keyword">protected</span> Set&lt;String&gt; <span class="hljs-title function_">stringSetValueOf</span><span class="hljs-params">(String value, String defaultValue)</span> &#123;<br>    value = (value == <span class="hljs-literal">null</span> ? defaultValue : value);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;(Arrays.asList(value.split(<span class="hljs-string">&quot;,&quot;</span>)));<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æJdbcType</span><br>  <span class="hljs-keyword">protected</span> JdbcType <span class="hljs-title function_">resolveJdbcType</span><span class="hljs-params">(String alias)</span> &#123;<br>    <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> JdbcType.valueOf(alias);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error resolving JdbcType. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æResultSetType</span><br>  <span class="hljs-keyword">protected</span> ResultSetType <span class="hljs-title function_">resolveResultSetType</span><span class="hljs-params">(String alias)</span> &#123;<br>    <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> ResultSetType.valueOf(alias);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error resolving ResultSetType. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æParameterMode(SPçš„IN/OUT/INOUT)</span><br>  <span class="hljs-keyword">protected</span> ParameterMode <span class="hljs-title function_">resolveParameterMode</span><span class="hljs-params">(String alias)</span> &#123;<br>    <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> ParameterMode.valueOf(alias);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error resolving ParameterMode. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¹æ®åˆ«åè§£æClassï¼Œç„¶ååˆ›å»ºå®ä¾‹</span><br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createInstance</span><span class="hljs-params">(String alias)</span> &#123;<br>    Class&lt;?&gt; clazz = resolveClass(alias);<br>    <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> resolveClass(alias).newInstance();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error creating instance. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¹æ®åˆ«åè§£æClass,å…¶å®æ˜¯å»æŸ¥çœ‹ ç±»å‹åˆ«åæ³¨å†Œ/äº‹åŠ¡ç®¡ç†å™¨åˆ«å</span><br>  <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(String alias) &#123;<br>    <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> resolveAlias(alias);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error resolving class. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveAlias(String alias) &#123;<br>    <span class="hljs-keyword">return</span> typeAliasRegistry.resolveAlias(alias);<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æç±»å‹å¤„ç†å™¨</span><br>  <span class="hljs-keyword">protected</span> TypeHandler&lt;?&gt; resolveTypeHandler(Class&lt;?&gt; javaType, String typeHandlerAlias) &#123;<br>    <span class="hljs-keyword">if</span> (typeHandlerAlias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// å…ˆå–å¾—åˆ«åæ‰€å±çš„Class</span><br>    Class&lt;?&gt; type = resolveClass(typeHandlerAlias);<br>    <span class="hljs-comment">// å¦‚æœä¸æ˜¯TypeHandlerçš„å­ç±»,æŠ¥é”™</span><br>    <span class="hljs-keyword">if</span> (type != <span class="hljs-literal">null</span> &amp;&amp; !TypeHandler.class.isAssignableFrom(type)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Type &quot;</span> + type.getName() + <span class="hljs-string">&quot; is not a valid TypeHandler because it does not implement TypeHandler interface&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@SuppressWarnings( &quot;unchecked&quot; )</span> <span class="hljs-comment">// already verified it is a TypeHandler</span><br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerType = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt;) type;<br>    <span class="hljs-comment">// å†å»è°ƒç”¨å¦ä¸€ä¸ªé‡è½½çš„æ–¹æ³•</span><br>    <span class="hljs-keyword">return</span> resolveTypeHandler(javaType, typeHandlerType);<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> TypeHandler&lt;?&gt; resolveTypeHandler(Class&lt;?&gt; javaType, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerType) &#123;<br>    <span class="hljs-keyword">if</span> (typeHandlerType == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// javaType ignored for injected handlers see issue #746 for full detail</span><br>    <span class="hljs-comment">// å»typeHandlerRegistryæŸ¥è¯¢å¯¹åº”çš„TypeHandler</span><br>    TypeHandler&lt;?&gt; handler = typeHandlerRegistry.getMappingTypeHandler(typeHandlerType);<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// not in registry, create a new one</span><br>      <span class="hljs-comment">// å¦‚æœæ²¡æœ‰åœ¨Registryæ‰¾åˆ°ï¼Œè°ƒç”¨typeHandlerRegistry.getInstanceæ¥newä¸€ä¸ªTypeHandlerè¿”å›</span><br>      handler = typeHandlerRegistry.getInstance(javaType, typeHandlerType);<br>    &#125;<br>    <span class="hljs-keyword">return</span> handler;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ParameterExpression"><a href="#ParameterExpression" class="headerlink" title="ParameterExpression"></a>ParameterExpression</h4><p>Â Â Â Â å‚æ•°è¡¨è¾¾å¼,ç»§æ‰¿è‡ªHashMapï¼Œå¯ä»¥å‚è€ƒParameterExpressionTest</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterExpression</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt; &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2417552199605158680L</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ParameterExpression</span><span class="hljs-params">(String expression)</span> &#123;<br>    parse(expression);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-comment">// #&#123;property,javaType=int,jdbcType=NUMERIC&#125;</span><br>    <span class="hljs-comment">// é¦–å…ˆå»é™¤ç©ºç™½,è¿”å›çš„pæ˜¯ç¬¬ä¸€ä¸ªä¸æ˜¯ç©ºç™½çš„å­—ç¬¦ä½ç½®</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> skipWS(expression, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (expression.charAt(p) == <span class="hljs-string">&#x27;(&#x27;</span>) &#123;<br>      <span class="hljs-comment">// å¤„ç†è¡¨è¾¾å¼</span><br>      expression(expression, p + <span class="hljs-number">1</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å¤„ç†å±æ€§</span><br>      property(expression, p);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">skipWS</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> p)</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> p; i &lt; expression.length(); i++) &#123;<br>      <span class="hljs-keyword">if</span> (expression.charAt(i) &gt; <span class="hljs-number">0x20</span>) &#123;<br>        <span class="hljs-keyword">return</span> i;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> expression.length();<br>  &#125; <br><br>  <span class="hljs-comment">// è¡¨è¾¾å¼å¯èƒ½æ˜¯3.2çš„æ–°åŠŸèƒ½ï¼Œå¯ä»¥å…ˆä¸ç®¡</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">expression</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> left)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> left + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">while</span> (match &gt; <span class="hljs-number">0</span>) &#123; <br>      <span class="hljs-comment">// è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†æ”¯æŒç±»ä¼¼ ((xxx)) æœ‰å¤šä¸ªåœ†æ‹¬å·çš„è¡¨è¾¾å¼</span><br>      <span class="hljs-keyword">if</span> (expression.charAt(right) == <span class="hljs-string">&#x27;)&#x27;</span>) &#123;<br>        match--;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (expression.charAt(right) == <span class="hljs-string">&#x27;(&#x27;</span>) &#123;<br>        match++;<br>      &#125;<br>      right++;<br>    &#125;<br>    put(<span class="hljs-string">&quot;expression&quot;</span>, expression.substring(left, right - <span class="hljs-number">1</span>));<br>    jdbcTypeOpt(expression, right);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jdbcTypeOpt</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> p)</span> &#123;<br>    <span class="hljs-comment">// #&#123;property,javaType=int,jdbcType=NUMERIC&#125;</span><br>    <span class="hljs-comment">// property:VARCHAR</span><br>    <span class="hljs-comment">// é¦–å…ˆå»é™¤ç©ºç™½,è¿”å›çš„pæ˜¯ç¬¬ä¸€ä¸ªä¸æ˜¯ç©ºç™½çš„å­—ç¬¦ä½ç½®</span><br>    p = skipWS(expression, p);<br>    <span class="hljs-keyword">if</span> (p &lt; expression.length()) &#123;<br>      <span class="hljs-comment">// ç¬¬ä¸€ä¸ªpropertyè§£æå®Œæœ‰ä¸¤ç§æƒ…å†µï¼Œé€—å·å’Œå†’å·</span><br>      <span class="hljs-keyword">if</span> (expression.charAt(p) == <span class="hljs-string">&#x27;:&#x27;</span>) &#123;<br>        jdbcType(expression, p + <span class="hljs-number">1</span>);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (expression.charAt(p) == <span class="hljs-string">&#x27;,&#x27;</span>) &#123;<br>        option(expression, p + <span class="hljs-number">1</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Parsing error in &#123;&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(expression) + <span class="hljs-string">&quot;&#125; in position &quot;</span> + p);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jdbcType</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> p)</span> &#123;<br>    <span class="hljs-comment">// property:VARCHAR</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> skipWS(expression, p);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> skipUntil(expression, left, <span class="hljs-string">&quot;,&quot;</span>);<br>    <span class="hljs-keyword">if</span> (right &gt; left) &#123;<br>      put(<span class="hljs-string">&quot;jdbcType&quot;</span>, trimmedStr(expression, left, right));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Parsing error in &#123;&quot;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(expression) + <span class="hljs-string">&quot;&#125; in position &quot;</span> + p);<br>    &#125;<br>    option(expression, right + <span class="hljs-number">1</span>);<br>  &#125; <br><br>  <span class="hljs-comment">// ä»expressionçš„på¤„å¼€å§‹æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªåŒ…å«åœ¨endCharsä¸­çš„å­—ç¬¦ï¼Œ</span><br>  <span class="hljs-comment">// è¿”å›endCharsçš„èµ·å§‹ä½ç½®</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">skipUntil</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> p, <span class="hljs-keyword">final</span> String endChars)</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> p; i &lt; expression.length(); i++) &#123;<br>      <span class="hljs-type">char</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> expression.charAt(i);<br>      <span class="hljs-keyword">if</span> (endChars.indexOf(c) &gt; -<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> i;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> expression.length();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">trimmedStr</span><span class="hljs-params">(String str, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> &#123;<br>    <span class="hljs-keyword">while</span> (str.charAt(start) &lt;= <span class="hljs-number">0x20</span>) &#123;<br>      start++;<br>    &#125;<br>    <span class="hljs-keyword">while</span> (str.charAt(end - <span class="hljs-number">1</span>) &lt;= <span class="hljs-number">0x20</span>) &#123;<br>      end--;<br>    &#125;<br>    <span class="hljs-keyword">return</span> start &gt;= end ? <span class="hljs-string">&quot;&quot;</span> : str.substring(start, end);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">option</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> p)</span> &#123;<br>    <span class="hljs-comment">// #&#123;property,javaType=int,jdbcType=NUMERIC&#125;</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> skipWS(expression, p);<br>    <span class="hljs-keyword">if</span> (left &lt; expression.length()) &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> skipUntil(expression, left, <span class="hljs-string">&quot;=&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> trimmedStr(expression, left, right);<br>      left = right + <span class="hljs-number">1</span>;<br>      right = skipUntil(expression, left, <span class="hljs-string">&quot;,&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> trimmedStr(expression, left, right);<br>      put(name, value);<br>      <span class="hljs-comment">// é€’å½’è°ƒç”¨optionï¼Œè¿›è¡Œé€—å·åé¢ä¸€ä¸ªå±æ€§çš„è§£æ</span><br>      option(expression, right + <span class="hljs-number">1</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å¤„ç†å±æ€§å’Œå¤„ç†è¡¨è¾¾å¼ç±»ä¼¼</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">property</span><span class="hljs-params">(String expression, <span class="hljs-type">int</span> left)</span> &#123;<br>    <span class="hljs-comment">// #&#123;property,javaType=int,jdbcType=NUMERIC&#125;</span><br>    <span class="hljs-comment">// property:VARCHAR</span><br>    <span class="hljs-keyword">if</span> (left &lt; expression.length()) &#123;<br>      <span class="hljs-comment">// é¦–å…ˆï¼Œå¾—åˆ°é€—å·æˆ–è€…å†’å·ä¹‹å‰çš„å­—ç¬¦ä¸²ï¼ŒåŠ å…¥åˆ°property</span><br>      <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> skipUntil(expression, left, <span class="hljs-string">&quot;,:&quot;</span>);<br>      put(<span class="hljs-string">&quot;property&quot;</span>, trimmedStr(expression, left, right));<br>      <span class="hljs-comment">// ç¬¬äºŒï¼Œå¤„ç†javaTypeï¼ŒjdbcType</span><br>      jdbcTypeOpt(expression, right);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="StaticSqlSource"><a href="#StaticSqlSource" class="headerlink" title="StaticSqlSource"></a>StaticSqlSource</h4><p>Â Â Â Â æ²¡å•¥å¥½è¯´çš„ï¼Œæ„Ÿå…´è¶£çš„è‡ªå·±çœ‹ä¸‹å§</p><h4 id="MapperBuilderAssistant"><a href="#MapperBuilderAssistant" class="headerlink" title="MapperBuilderAssistant"></a>MapperBuilderAssistant</h4><p>Â Â Â Â  Â æ˜ å°„æ„å»ºå™¨åŠ©æ‰‹ï¼Œå»ºé€ è€…æ¨¡å¼,ç»§æ‰¿BaseBuilder</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperBuilderAssistant</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-comment">// æ¯ä¸ªåŠ©æ‰‹éƒ½æœ‰1ä¸ªnamespace,resource,cache</span><br>  <span class="hljs-keyword">private</span> String currentNamespace;<br>  <span class="hljs-keyword">private</span> String resource;<br>  <span class="hljs-keyword">private</span> Cache currentCache;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> unresolvedCacheRef; <span class="hljs-comment">// issue #676 </span><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperBuilderAssistant</span><span class="hljs-params">(Configuration configuration, String resource)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration);<br>    ErrorContext.instance().resource(resource);<br>    <span class="hljs-built_in">this</span>.resource = resource;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCurrentNamespace</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> currentNamespace;<br>  &#125; <br><br>  <span class="hljs-comment">// currentNamespace åªèƒ½èµ‹å€¼ä¸€æ¬¡</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCurrentNamespace</span><span class="hljs-params">(String currentNamespace)</span> &#123;<br>    <span class="hljs-keyword">if</span> (currentNamespace == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;The mapper element requires a namespace attribute to be specified.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.currentNamespace != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.currentNamespace.equals(currentNamespace)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Wrong namespace. Expected &#x27;&quot;</span><br>          + <span class="hljs-built_in">this</span>.currentNamespace + <span class="hljs-string">&quot;&#x27; but found &#x27;&quot;</span> + currentNamespace + <span class="hljs-string">&quot;&#x27;.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">this</span>.currentNamespace = currentNamespace;<br>  &#125; <br><br>  <span class="hljs-comment">// ä¸ºidåŠ ä¸Šnamespaceå‰ç¼€ï¼Œå¦‚selectPerson--&gt;org.a.b.selectPerson</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">applyCurrentNamespace</span><span class="hljs-params">(String base, <span class="hljs-type">boolean</span> isReference)</span> &#123;<br>    <span class="hljs-keyword">if</span> (base == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (isReference) &#123;<br>      <span class="hljs-comment">// is it qualified with any namespace yet?</span><br>      <span class="hljs-keyword">if</span> (base.contains(<span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> base;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// is it qualified with this namespace yet?</span><br>      <span class="hljs-keyword">if</span> (base.startsWith(currentNamespace + <span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> base;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (base.contains(<span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Dots are not allowed in element names, please remove it from &quot;</span> + base);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> currentNamespace + <span class="hljs-string">&quot;.&quot;</span> + base;<br>  &#125; <br><br>  <span class="hljs-comment">// è®¾ç½®ç¼“å­˜</span><br>  <span class="hljs-keyword">public</span> Cache <span class="hljs-title function_">useCacheRef</span><span class="hljs-params">(String namespace)</span> &#123;<br>    <span class="hljs-keyword">if</span> (namespace == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;cache-ref element requires a namespace attribute.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      unresolvedCacheRef = <span class="hljs-literal">true</span>;<br>      <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> configuration.getCache(namespace);<br>      <span class="hljs-keyword">if</span> (cache == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;No cache for namespace &#x27;&quot;</span> + namespace + <span class="hljs-string">&quot;&#x27; could be found.&quot;</span>);<br>      &#125;<br>      currentCache = cache;<br>      unresolvedCacheRef = <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">return</span> cache;<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;No cache for namespace &#x27;&quot;</span> + namespace + <span class="hljs-string">&quot;&#x27; could be found.&quot;</span>, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// é€šè¿‡ä¼ å…¥çš„å‚æ•°æ„å»ºå¹¶è®¾ç½®ç¼“å­˜</span><br>  <span class="hljs-keyword">public</span> Cache <span class="hljs-title function_">useNewCache</span><span class="hljs-params">(Class&lt;? extends Cache&gt; typeClass,</span><br><span class="hljs-params">      Class&lt;? extends Cache&gt; evictionClass,</span><br><span class="hljs-params">      Long flushInterval,</span><br><span class="hljs-params">      Integer size,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> readWrite,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> blocking,</span><br><span class="hljs-params">      Properties props)</span> &#123;<br>    <span class="hljs-comment">// è¿™é‡Œé¢åˆåˆ¤æ–­äº†ä¸€ä¸‹æ˜¯å¦ä¸ºnullå°±ç”¨é»˜è®¤å€¼ï¼Œæœ‰ç‚¹å’ŒXMLMapperBuilder.cacheElementé€»è¾‘é‡å¤äº†</span><br>    typeClass = valueOrDefault(typeClass, PerpetualCache.class);<br>    evictionClass = valueOrDefault(evictionClass, LruCache.class);<br>    <span class="hljs-comment">// è°ƒç”¨CacheBuilderæ„å»ºcache,id=currentNamespace</span><br>    <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheBuilder</span>(currentNamespace)<br>        .implementation(typeClass)<br>        .addDecorator(evictionClass)<br>        .clearInterval(flushInterval)<br>        .size(size)<br>        .readWrite(readWrite)<br>        .blocking(blocking)<br>        .properties(props)<br>        .build();<br>    <span class="hljs-comment">// åŠ å…¥ç¼“å­˜</span><br>    configuration.addCache(cache);<br>    <span class="hljs-comment">// å½“å‰çš„ç¼“å­˜</span><br>    currentCache = cache;<br>    <span class="hljs-keyword">return</span> cache;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">valueOrDefault</span><span class="hljs-params">(T value, T defaultValue)</span> &#123;<br>    <span class="hljs-keyword">return</span> value == <span class="hljs-literal">null</span> ? defaultValue : value;<br>  &#125; <br><br>  <span class="hljs-comment">// å¾€configuration ä¸­æ·»åŠ  ParameterMap </span><br>  <span class="hljs-keyword">public</span> ParameterMap <span class="hljs-title function_">addParameterMap</span><span class="hljs-params">(String id, Class&lt;?&gt; parameterClass, List&lt;ParameterMapping&gt; parameterMappings)</span> &#123;<br>    id = applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>    ParameterMap.<span class="hljs-type">Builder</span> <span class="hljs-variable">parameterMapBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMap</span>.Builder(configuration, id, parameterClass, parameterMappings);<br>    <span class="hljs-type">ParameterMap</span> <span class="hljs-variable">parameterMap</span> <span class="hljs-operator">=</span> parameterMapBuilder.build();<br>    configuration.addParameterMap(parameterMap);<br>    <span class="hljs-keyword">return</span> parameterMap;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ParameterMapping <span class="hljs-title function_">buildParameterMapping</span><span class="hljs-params">(</span><br><span class="hljs-params">      Class&lt;?&gt; parameterType,</span><br><span class="hljs-params">      String property,</span><br><span class="hljs-params">      Class&lt;?&gt; javaType,</span><br><span class="hljs-params">      JdbcType jdbcType,</span><br><span class="hljs-params">      String resultMap,</span><br><span class="hljs-params">      ParameterMode parameterMode,</span><br><span class="hljs-params">      Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span><br><span class="hljs-params">      Integer numericScale)</span> &#123;<br>    resultMap = applyCurrentNamespace(resultMap, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">// Class parameterType = parameterMapBuilder.type();</span><br>    Class&lt;?&gt; javaTypeClass = resolveParameterJavaType(parameterType, property, javaType, jdbcType);<br>    TypeHandler&lt;?&gt; typeHandlerInstance = resolveTypeHandler(javaTypeClass, typeHandler);<br><br>    ParameterMapping.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMapping</span>.Builder(configuration, property, javaTypeClass);<br>    builder.jdbcType(jdbcType);<br>    builder.resultMapId(resultMap);<br>    builder.mode(parameterMode);<br>    builder.numericScale(numericScale);<br>    builder.typeHandler(typeHandlerInstance);<br>    <span class="hljs-keyword">return</span> builder.build();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; resolveParameterJavaType(Class&lt;?&gt; resultType, String property, Class&lt;?&gt; javaType, JdbcType jdbcType) &#123;<br>    <span class="hljs-keyword">if</span> (javaType == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (JdbcType.CURSOR.equals(jdbcType)) &#123;<br>        javaType = java.sql.ResultSet.class;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Map.class.isAssignableFrom(resultType)) &#123;<br>        javaType = Object.class;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaResultType</span> <span class="hljs-operator">=</span> MetaClass.forClass(resultType);<br>        javaType = metaResultType.getGetterType(property);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (javaType == <span class="hljs-literal">null</span>) &#123;<br>      javaType = Object.class;<br>    &#125;<br>    <span class="hljs-keyword">return</span> javaType;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> TypeHandler&lt;?&gt; resolveTypeHandler(Class&lt;?&gt; javaType, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerType) &#123;<br>    <span class="hljs-keyword">if</span> (typeHandlerType == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// javaType ignored for injected handlers see issue #746 for full detail</span><br>    <span class="hljs-comment">// å»typeHandlerRegistryæŸ¥è¯¢å¯¹åº”çš„TypeHandler</span><br>    TypeHandler&lt;?&gt; handler = typeHandlerRegistry.getMappingTypeHandler(typeHandlerType);<br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// not in registry, create a new one</span><br>      <span class="hljs-comment">// å¦‚æœæ²¡æœ‰åœ¨Registryæ‰¾åˆ°ï¼Œè°ƒç”¨typeHandlerRegistry.getInstanceæ¥newä¸€ä¸ªTypeHandlerè¿”å›</span><br>      handler = typeHandlerRegistry.getInstance(javaType, typeHandlerType);<br>    &#125;<br>    <span class="hljs-keyword">return</span> handler;<br>  &#125; <br><br>  <span class="hljs-comment">// å¢åŠ ResultMap</span><br>  <span class="hljs-keyword">public</span> ResultMap <span class="hljs-title function_">addResultMap</span><span class="hljs-params">(</span><br><span class="hljs-params">      String id,</span><br><span class="hljs-params">      Class&lt;?&gt; type,</span><br><span class="hljs-params">      String extend,</span><br><span class="hljs-params">      Discriminator discriminator,</span><br><span class="hljs-params">      List&lt;ResultMapping&gt; resultMappings,</span><br><span class="hljs-params">      Boolean autoMapping)</span> &#123;<br>    id = applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>    extend = applyCurrentNamespace(extend, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">// å»ºé€ è€…æ¨¡å¼</span><br>    ResultMap.<span class="hljs-type">Builder</span> <span class="hljs-variable">resultMapBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMap</span>.Builder(configuration, id, type, resultMappings, autoMapping);<br>    <span class="hljs-keyword">if</span> (extend != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!configuration.hasResultMap(extend)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Could not find a parent resultmap with id &#x27;&quot;</span> + extend + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>      &#125;<br>      <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> configuration.getResultMap(extend);<br>      List&lt;ResultMapping&gt; extendedResultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;(resultMap.getResultMappings());<br>      extendedResultMappings.removeAll(resultMappings);<br>      <span class="hljs-comment">// Remove parent constructor if this resultMap declares a constructor.</span><br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">declaresConstructor</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>      <span class="hljs-keyword">for</span> (ResultMapping resultMapping : resultMappings) &#123;<br>        <span class="hljs-keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;<br>          declaresConstructor = <span class="hljs-literal">true</span>;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (declaresConstructor) &#123;<br>        Iterator&lt;ResultMapping&gt; extendedResultMappingsIter = extendedResultMappings.iterator();<br>        <span class="hljs-keyword">while</span> (extendedResultMappingsIter.hasNext()) &#123;<br>          <span class="hljs-keyword">if</span> (extendedResultMappingsIter.next().getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;<br>            extendedResultMappingsIter.remove();<br>          &#125;<br>        &#125;<br>      &#125;<br>      resultMappings.addAll(extendedResultMappings);<br>    &#125;<br>    resultMapBuilder.discriminator(discriminator);<br>    <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> resultMapBuilder.build();<br>    configuration.addResultMap(resultMap);<br>    <span class="hljs-keyword">return</span> resultMap;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Discriminator <span class="hljs-title function_">buildDiscriminator</span><span class="hljs-params">(</span><br><span class="hljs-params">      Class&lt;?&gt; resultType,</span><br><span class="hljs-params">      String column,</span><br><span class="hljs-params">      Class&lt;?&gt; javaType,</span><br><span class="hljs-params">      JdbcType jdbcType,</span><br><span class="hljs-params">      Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span><br><span class="hljs-params">      Map&lt;String, String&gt; discriminatorMap)</span> &#123;<br>    <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">resultMapping</span> <span class="hljs-operator">=</span> buildResultMapping(<br>        resultType,<br>        <span class="hljs-literal">null</span>,<br>        column,<br>        javaType,<br>        jdbcType,<br>        <span class="hljs-literal">null</span>,<br>        <span class="hljs-literal">null</span>,<br>        <span class="hljs-literal">null</span>,<br>        <span class="hljs-literal">null</span>,<br>        typeHandler,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;(),<br>        <span class="hljs-literal">null</span>,<br>        <span class="hljs-literal">null</span>,<br>        <span class="hljs-literal">false</span>);<br>    Map&lt;String, String&gt; namespaceDiscriminatorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; e : discriminatorMap.entrySet()) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> e.getValue();<br>      resultMap = applyCurrentNamespace(resultMap, <span class="hljs-literal">true</span>);<br>      namespaceDiscriminatorMap.put(e.getKey(), resultMap);<br>    &#125;<br>    Discriminator.<span class="hljs-type">Builder</span> <span class="hljs-variable">discriminatorBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Discriminator</span>.Builder(configuration, resultMapping, namespaceDiscriminatorMap);<br>    <span class="hljs-keyword">return</span> discriminatorBuilder.build();<br>  &#125; <br><br>  <span class="hljs-comment">// å¢åŠ æ˜ å°„è¯­å¥</span><br>  <span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title function_">addMappedStatement</span><span class="hljs-params">(</span><br><span class="hljs-params">      String id,</span><br><span class="hljs-params">      SqlSource sqlSource,</span><br><span class="hljs-params">      StatementType statementType,</span><br><span class="hljs-params">      SqlCommandType sqlCommandType,</span><br><span class="hljs-params">      Integer fetchSize,</span><br><span class="hljs-params">      Integer timeout,</span><br><span class="hljs-params">      String parameterMap,</span><br><span class="hljs-params">      Class&lt;?&gt; parameterType,</span><br><span class="hljs-params">      String resultMap,</span><br><span class="hljs-params">      Class&lt;?&gt; resultType,</span><br><span class="hljs-params">      ResultSetType resultSetType,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> flushCache,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> useCache,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> resultOrdered,</span><br><span class="hljs-params">      KeyGenerator keyGenerator,</span><br><span class="hljs-params">      String keyProperty,</span><br><span class="hljs-params">      String keyColumn,</span><br><span class="hljs-params">      String databaseId,</span><br><span class="hljs-params">      LanguageDriver lang,</span><br><span class="hljs-params">      String resultSets)</span> &#123;<br><br>    <span class="hljs-keyword">if</span> (unresolvedCacheRef) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Cache-ref not yet resolved&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// ä¸ºidåŠ ä¸Šnamespaceå‰ç¼€</span><br>    id = applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">// æ˜¯å¦æ˜¯selectè¯­å¥</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSelect</span> <span class="hljs-operator">=</span> sqlCommandType == SqlCommandType.SELECT;<br><br>    <span class="hljs-comment">// åˆæ˜¯å»ºé€ è€…æ¨¡å¼</span><br>    MappedStatement.<span class="hljs-type">Builder</span> <span class="hljs-variable">statementBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MappedStatement</span>.Builder(configuration, id, sqlSource, sqlCommandType);<br>    statementBuilder.resource(resource);<br>    statementBuilder.fetchSize(fetchSize);<br>    statementBuilder.statementType(statementType);<br>    statementBuilder.keyGenerator(keyGenerator);<br>    statementBuilder.keyProperty(keyProperty);<br>    statementBuilder.keyColumn(keyColumn);<br>    statementBuilder.databaseId(databaseId);<br>    statementBuilder.lang(lang);<br>    statementBuilder.resultOrdered(resultOrdered);<br>    statementBuilder.resulSets(resultSets);<br>    setStatementTimeout(timeout, statementBuilder);<br><br>    <span class="hljs-comment">// 1.å‚æ•°æ˜ å°„</span><br>    setStatementParameterMap(parameterMap, parameterType, statementBuilder);<br>    <span class="hljs-comment">// 2.ç»“æœæ˜ å°„</span><br>    setStatementResultMap(resultMap, resultType, resultSetType, statementBuilder);<br>    setStatementCache(isSelect, flushCache, useCache, currentCache, statementBuilder);<br><br>    <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> statementBuilder.build();<br>    <span class="hljs-comment">// å»ºé€ å¥½è°ƒç”¨configuration.addMappedStatement</span><br>    configuration.addMappedStatement(statement);<br>    <span class="hljs-keyword">return</span> statement;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatementTimeout</span><span class="hljs-params">(Integer timeout, MappedStatement.Builder statementBuilder)</span> &#123;<br>    <span class="hljs-keyword">if</span> (timeout == <span class="hljs-literal">null</span>) &#123;<br>      timeout = configuration.getDefaultStatementTimeout();<br>    &#125;<br>    statementBuilder.timeout(timeout);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatementParameterMap</span><span class="hljs-params">(</span><br><span class="hljs-params">      String parameterMap,</span><br><span class="hljs-params">      Class&lt;?&gt; parameterTypeClass,</span><br><span class="hljs-params">      MappedStatement.Builder statementBuilder)</span> &#123;<br>    parameterMap = applyCurrentNamespace(parameterMap, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-keyword">if</span> (parameterMap != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        statementBuilder.parameterMap(configuration.getParameterMap(parameterMap));<br>      &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Could not find parameter map &quot;</span> + parameterMap, e);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parameterTypeClass != <span class="hljs-literal">null</span>) &#123;<br>      List&lt;ParameterMapping&gt; parameterMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ParameterMapping&gt;();<br>      ParameterMap.<span class="hljs-type">Builder</span> <span class="hljs-variable">inlineParameterMapBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMap</span>.Builder(<br>          configuration,<br>          statementBuilder.id() + <span class="hljs-string">&quot;-Inline&quot;</span>,<br>          parameterTypeClass,<br>          parameterMappings);<br>      statementBuilder.parameterMap(inlineParameterMapBuilder.build());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 2.result map</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatementResultMap</span><span class="hljs-params">(</span><br><span class="hljs-params">      String resultMap,</span><br><span class="hljs-params">      Class&lt;?&gt; resultType,</span><br><span class="hljs-params">      ResultSetType resultSetType,</span><br><span class="hljs-params">      MappedStatement.Builder statementBuilder)</span> &#123;<br>    resultMap = applyCurrentNamespace(resultMap, <span class="hljs-literal">true</span>);<br><br>    List&lt;ResultMap&gt; resultMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMap&gt;();<br>    <span class="hljs-keyword">if</span> (resultMap != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 2.1 resultMapæ˜¯é«˜çº§åŠŸèƒ½</span><br>      String[] resultMapNames = resultMap.split(<span class="hljs-string">&quot;,&quot;</span>);<br>      <span class="hljs-keyword">for</span> (String resultMapName : resultMapNames) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          resultMaps.add(configuration.getResultMap(resultMapName.trim()));<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Could not find result map &quot;</span> + resultMapName, e);<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resultType != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// 2.2 resultType,ä¸€èˆ¬ç”¨è¿™ä¸ªè¶³çŸ£äº†</span><br>      <span class="hljs-comment">// &lt;select id=&quot;selectUsers&quot; resultType=&quot;User&quot;&gt;</span><br>      <span class="hljs-comment">// è¿™ç§æƒ…å†µä¸‹,MyBatis ä¼šåœ¨å¹•åè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª ResultMap,åŸºäºå±æ€§åæ¥æ˜ å°„åˆ—åˆ° JavaBean çš„å±æ€§ä¸Šã€‚</span><br>      <span class="hljs-comment">// å¦‚æœåˆ—åæ²¡æœ‰ç²¾ç¡®åŒ¹é…,ä½ å¯ä»¥åœ¨åˆ—åä¸Šä½¿ç”¨ select å­—å¥çš„åˆ«åæ¥åŒ¹é…æ ‡ç­¾ã€‚</span><br>      <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªinline result map, æŠŠresultTypeè®¾ä¸Šå°±OKäº†ï¼Œ</span><br>      <span class="hljs-comment">// ç„¶ååé¢è¢«DefaultResultSetHandler.createResultObject()ä½¿ç”¨</span><br>      <span class="hljs-comment">// DefaultResultSetHandler.getRowValue()ä½¿ç”¨</span><br>      ResultMap.<span class="hljs-type">Builder</span> <span class="hljs-variable">inlineResultMapBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMap</span>.Builder(<br>          configuration,<br>          statementBuilder.id() + <span class="hljs-string">&quot;-Inline&quot;</span>,<br>          resultType,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;(),<br>          <span class="hljs-literal">null</span>);<br>      resultMaps.add(inlineResultMapBuilder.build());<br>    &#125;<br>    statementBuilder.resultMaps(resultMaps);<br><br>    statementBuilder.resultSetType(resultSetType);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatementCache</span><span class="hljs-params">(</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> isSelect,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> flushCache,</span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> useCache,</span><br><span class="hljs-params">      Cache cache,</span><br><span class="hljs-params">      MappedStatement.Builder statementBuilder)</span> &#123;<br>    flushCache = valueOrDefault(flushCache, !isSelect);<br>    useCache = valueOrDefault(useCache, isSelect);<br>    statementBuilder.flushCacheRequired(flushCache);<br>    statementBuilder.useCache(useCache);<br>    statementBuilder.cache(cache);<br>  &#125; <br><br>  <span class="hljs-comment">// æ„å»ºresult mapping</span><br>  <span class="hljs-keyword">public</span> ResultMapping <span class="hljs-title function_">buildResultMapping</span><span class="hljs-params">(</span><br><span class="hljs-params">      Class&lt;?&gt; resultType,</span><br><span class="hljs-params">      String property,</span><br><span class="hljs-params">      String column,</span><br><span class="hljs-params">      Class&lt;?&gt; javaType,</span><br><span class="hljs-params">      JdbcType jdbcType,</span><br><span class="hljs-params">      String nestedSelect,</span><br><span class="hljs-params">      String nestedResultMap,</span><br><span class="hljs-params">      String notNullColumn,</span><br><span class="hljs-params">      String columnPrefix,</span><br><span class="hljs-params">      Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span><br><span class="hljs-params">      List&lt;ResultFlag&gt; flags,</span><br><span class="hljs-params">      String resultSet,</span><br><span class="hljs-params">      String foreignColumn, </span><br><span class="hljs-params">      <span class="hljs-type">boolean</span> lazy)</span> &#123;<br>    Class&lt;?&gt; javaTypeClass = resolveResultJavaType(resultType, property, javaType);<br>    TypeHandler&lt;?&gt; typeHandlerInstance = resolveTypeHandler(javaTypeClass, typeHandler);<br>    <span class="hljs-comment">// è§£æå¤åˆçš„åˆ—å,ä¸€èˆ¬ç”¨ä¸åˆ°ï¼Œè¿”å›çš„æ˜¯ç©º</span><br>    List&lt;ResultMapping&gt; composites = parseCompositeColumnName(column);<br>    <span class="hljs-keyword">if</span> (composites.size() &gt; <span class="hljs-number">0</span>) &#123;<br>      column = <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// æ„å»ºresult mapping</span><br>    ResultMapping.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMapping</span>.Builder(configuration, property, column, javaTypeClass);<br>    builder.jdbcType(jdbcType);<br>    builder.nestedQueryId(applyCurrentNamespace(nestedSelect, <span class="hljs-literal">true</span>));<br>    builder.nestedResultMapId(applyCurrentNamespace(nestedResultMap, <span class="hljs-literal">true</span>));<br>    builder.resultSet(resultSet);<br>    builder.typeHandler(typeHandlerInstance);<br>    builder.flags(flags == <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;() : flags);<br>    builder.composites(composites);<br>    builder.notNullColumns(parseMultipleColumnNames(notNullColumn));<br>    builder.columnPrefix(columnPrefix);<br>    builder.foreignColumn(foreignColumn);<br>    builder.lazy(lazy);<br>    <span class="hljs-keyword">return</span> builder.build();<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æå¤åˆåˆ—åï¼Œå³åˆ—åç”±å¤šä¸ªç»„æˆï¼Œå¯ä»¥å…ˆå¿½ç•¥</span><br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; <span class="hljs-title function_">parseCompositeColumnName</span><span class="hljs-params">(String columnName)</span> &#123;<br>    List&lt;ResultMapping&gt; composites = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>    <span class="hljs-keyword">if</span> (columnName != <span class="hljs-literal">null</span> &amp;&amp; (columnName.indexOf(<span class="hljs-string">&#x27;=&#x27;</span>) &gt; -<span class="hljs-number">1</span> || columnName.indexOf(<span class="hljs-string">&#x27;,&#x27;</span>) &gt; -<span class="hljs-number">1</span>)) &#123;<br>      <span class="hljs-type">StringTokenizer</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTokenizer</span>(columnName, <span class="hljs-string">&quot;&#123;&#125;=, &quot;</span>, <span class="hljs-literal">false</span>);<br>      <span class="hljs-keyword">while</span> (parser.hasMoreTokens()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> parser.nextToken();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> parser.nextToken();<br>        ResultMapping.<span class="hljs-type">Builder</span> <span class="hljs-variable">complexBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMapping</span>.Builder(configuration, property, column, configuration.getTypeHandlerRegistry().getUnknownTypeHandler());<br>        composites.add(complexBuilder.build());<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> composites;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">parseMultipleColumnNames</span><span class="hljs-params">(String columnName)</span> &#123;<br>    Set&lt;String&gt; columns = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();<br>    <span class="hljs-keyword">if</span> (columnName != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (columnName.indexOf(<span class="hljs-string">&#x27;,&#x27;</span>) &gt; -<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-type">StringTokenizer</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTokenizer</span>(columnName, <span class="hljs-string">&quot;&#123;&#125;, &quot;</span>, <span class="hljs-literal">false</span>);<br>        <span class="hljs-keyword">while</span> (parser.hasMoreTokens()) &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> parser.nextToken();<br>          columns.add(column);<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        columns.add(columnName);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> columns;<br>  &#125; <br><br>  <span class="hljs-comment">/** Backward compatibility signature */</span><br>  <span class="hljs-comment">// å‘åå…¼å®¹æ–¹æ³•</span><br>  <span class="hljs-keyword">public</span> ResultMapping <span class="hljs-title function_">buildResultMapping</span><span class="hljs-params">(</span><br><span class="hljs-params">      Class&lt;?&gt; resultType,</span><br><span class="hljs-params">      String property,</span><br><span class="hljs-params">      String column,</span><br><span class="hljs-params">      Class&lt;?&gt; javaType,</span><br><span class="hljs-params">      JdbcType jdbcType,</span><br><span class="hljs-params">      String nestedSelect,</span><br><span class="hljs-params">      String nestedResultMap,</span><br><span class="hljs-params">      String notNullColumn,</span><br><span class="hljs-params">      String columnPrefix,</span><br><span class="hljs-params">      Class&lt;? extends TypeHandler&lt;?&gt;&gt; typeHandler,</span><br><span class="hljs-params">      List&lt;ResultFlag&gt; flags)</span> &#123;<br>      <span class="hljs-keyword">return</span> buildResultMapping(<br>        resultType, property, column, javaType, jdbcType, nestedSelect, <br>        nestedResultMap, notNullColumn, columnPrefix, typeHandler, flags, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, configuration.isLazyLoadingEnabled());<br>  &#125;   <br><br>  <span class="hljs-comment">// å–å¾—è¯­è¨€é©±åŠ¨</span><br>  <span class="hljs-keyword">public</span> LanguageDriver <span class="hljs-title function_">getLanguageDriver</span><span class="hljs-params">(Class&lt;?&gt; langClass)</span> &#123;<br>    <span class="hljs-keyword">if</span> (langClass != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// æ³¨å†Œè¯­è¨€é©±åŠ¨</span><br>      configuration.getLanguageRegistry().register(langClass);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å¦‚æœä¸ºnullï¼Œåˆ™å–å¾—é»˜è®¤é©±åŠ¨ï¼ˆmybatis3.2ä»¥å‰å¤§å®¶ä¸€ç›´ç”¨çš„æ–¹æ³•ï¼‰</span><br>      langClass = configuration.getLanguageRegistry().getDefaultDriverClass();<br>    &#125;<br>    <span class="hljs-comment">// å†å»è°ƒconfiguration</span><br>    <span class="hljs-keyword">return</span> configuration.getLanguageRegistry().getDriver(langClass);<br>  &#125; <br><br>  <span class="hljs-comment">/** Backward compatibility signature */</span><br>  <span class="hljs-comment">// å‘åå…¼å®¹æ–¹æ³•</span><br>  <span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title function_">addMappedStatement</span><span class="hljs-params">(</span><br><span class="hljs-params">    String id,</span><br><span class="hljs-params">    SqlSource sqlSource,</span><br><span class="hljs-params">    StatementType statementType,</span><br><span class="hljs-params">    SqlCommandType sqlCommandType,</span><br><span class="hljs-params">    Integer fetchSize,</span><br><span class="hljs-params">    Integer timeout,</span><br><span class="hljs-params">    String parameterMap,</span><br><span class="hljs-params">    Class&lt;?&gt; parameterType,</span><br><span class="hljs-params">    String resultMap,</span><br><span class="hljs-params">    Class&lt;?&gt; resultType,</span><br><span class="hljs-params">    ResultSetType resultSetType,</span><br><span class="hljs-params">    <span class="hljs-type">boolean</span> flushCache,</span><br><span class="hljs-params">    <span class="hljs-type">boolean</span> useCache,</span><br><span class="hljs-params">    <span class="hljs-type">boolean</span> resultOrdered,</span><br><span class="hljs-params">    KeyGenerator keyGenerator,</span><br><span class="hljs-params">    String keyProperty,</span><br><span class="hljs-params">    String keyColumn,</span><br><span class="hljs-params">    String databaseId,</span><br><span class="hljs-params">    LanguageDriver lang)</span> &#123;<br>    <span class="hljs-keyword">return</span> addMappedStatement(<br>      id, sqlSource, statementType, sqlCommandType, fetchSize, timeout, <br>      parameterMap, parameterType, resultMap, resultType, resultSetType, <br>      flushCache, useCache, resultOrdered, keyGenerator, keyProperty, <br>      keyColumn, databaseId, lang, <span class="hljs-literal">null</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CacheRefResolver"><a href="#CacheRefResolver" class="headerlink" title="CacheRefResolver"></a>CacheRefResolver</h4><p>Â Â Â Â ç¼“å­˜å¼•ç”¨è§£æå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheRefResolver</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MapperBuilderAssistant assistant;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String cacheRefNamespace;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheRefResolver</span><span class="hljs-params">(MapperBuilderAssistant assistant, String cacheRefNamespace)</span> &#123;<br>    <span class="hljs-built_in">this</span>.assistant = assistant;<br>    <span class="hljs-built_in">this</span>.cacheRefNamespace = cacheRefNamespace;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Cache <span class="hljs-title function_">resolveCacheRef</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// åè°ƒMapperBuilderAssistantè§£æ</span><br>    <span class="hljs-keyword">return</span> assistant.useCacheRef(cacheRefNamespace);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultMapResolver"><a href="#ResultMapResolver" class="headerlink" title="ResultMapResolver"></a>ResultMapResolver</h4><p>Â Â Â Â  Â ç»“æœæ˜ å°„è§£æå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultMapResolver</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MapperBuilderAssistant assistant;<br>  <span class="hljs-keyword">private</span> String id;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>  <span class="hljs-keyword">private</span> String extend;<br>  <span class="hljs-keyword">private</span> Discriminator discriminator;<br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; resultMappings;<br>  <span class="hljs-keyword">private</span> Boolean autoMapping;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResultMapResolver</span><span class="hljs-params">(MapperBuilderAssistant assistant, String id, Class&lt;?&gt; type, String extend, Discriminator discriminator, List&lt;ResultMapping&gt; resultMappings, Boolean autoMapping)</span> &#123;<br>    <span class="hljs-built_in">this</span>.assistant = assistant;<br>    <span class="hljs-built_in">this</span>.id = id;<br>    <span class="hljs-built_in">this</span>.type = type;<br>    <span class="hljs-built_in">this</span>.extend = extend;<br>    <span class="hljs-built_in">this</span>.discriminator = discriminator;<br>    <span class="hljs-built_in">this</span>.resultMappings = resultMappings;<br>    <span class="hljs-built_in">this</span>.autoMapping = autoMapping;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> ResultMap <span class="hljs-title function_">resolve</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// è§£æåˆå»è°ƒç”¨MapperBuilderAssistant.addResultMap</span><br>    <span class="hljs-keyword">return</span> assistant.addResultMap(<span class="hljs-built_in">this</span>.id, <span class="hljs-built_in">this</span>.type, <span class="hljs-built_in">this</span>.extend, <span class="hljs-built_in">this</span>.discriminator, <span class="hljs-built_in">this</span>.resultMappings, <span class="hljs-built_in">this</span>.autoMapping);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="XMLIncludeTransformer"><a href="#XMLIncludeTransformer" class="headerlink" title="XMLIncludeTransformer"></a>XMLIncludeTransformer</h4><p>Â Â Â Â XML include è½¬æ¢å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLIncludeTransformer</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Configuration configuration;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MapperBuilderAssistant builderAssistant; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLIncludeTransformer</span><span class="hljs-params">(Configuration configuration, MapperBuilderAssistant builderAssistant)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.builderAssistant = builderAssistant;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyIncludes</span><span class="hljs-params">(Node source)</span> &#123;<br>    <span class="hljs-keyword">if</span> (source.getNodeName().equals(<span class="hljs-string">&quot;include&quot;</span>)) &#123;<br>      <span class="hljs-comment">// èµ°åˆ°è¿™é‡Œï¼Œå•ç‹¬è§£æ&lt;include refid=&quot;userColumns&quot;/&gt;</span><br>      <span class="hljs-comment">// æ‹¿åˆ°SQLç‰‡æ®µ</span><br>      <span class="hljs-type">Node</span> <span class="hljs-variable">toInclude</span> <span class="hljs-operator">=</span> findSqlFragment(getStringAttribute(source, <span class="hljs-string">&quot;refid&quot;</span>));<br>      <span class="hljs-comment">// é€’å½’è°ƒç”¨--å¤„ç†toInclude Nodeé‡Œçš„ include æ ‡ç­¾</span><br>      applyIncludes(toInclude);<br>      <span class="hljs-comment">// å¦‚æœè¦å¯¼å…¥çš„sqlç‰‡æ®µtoInclude Nodeå’Œsource Nodeä¸å±äºåŒä¸€ä¸ªDocumentï¼Œ</span><br>      <span class="hljs-comment">// éœ€è¦å°†toInclude Nodeå¯¼å…¥åˆ°source Nodeæ‰€åœ¨çš„Documentä¸­</span><br>      <span class="hljs-keyword">if</span> (toInclude.getOwnerDocument() != source.getOwnerDocument()) &#123;<br>        toInclude = source.getOwnerDocument().importNode(toInclude, <span class="hljs-literal">true</span>);<br>      &#125; <br>      <span class="hljs-comment">// å°†source Nodeæ›¿æ¢æˆtoInclude Node</span><br>      source.getParentNode().replaceChild(toInclude, source);<br>      <span class="hljs-comment">// å°†toInclude Nodeçš„å­©å­èŠ‚ç‚¹æ”¾åˆ°toInclude Nodeä¹‹å‰</span><br>      <span class="hljs-comment">// æ–‡æœ¬å†…å®¹ä¹Ÿæ˜¯ childNode</span><br>      <span class="hljs-keyword">while</span> (toInclude.hasChildNodes()) &#123;<br>        toInclude.getParentNode().insertBefore(toInclude.getFirstChild(), toInclude);<br>      &#125; <br>      <span class="hljs-comment">// åˆ é™¤toInclude Node</span><br>      toInclude.getParentNode().removeChild(toInclude);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source.getNodeType() == Node.ELEMENT_NODE) &#123;<br>      <span class="hljs-comment">// ä¸€å¼€å§‹ä¼šèµ°è¿™æ®µï¼Œå–å¾—æ‰€æœ‰å„¿å­</span><br>      <span class="hljs-type">NodeList</span> <span class="hljs-variable">children</span> <span class="hljs-operator">=</span> source.getChildNodes();<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;children.getLength(); i++) &#123;<br>        <span class="hljs-comment">// é€’å½’è°ƒç”¨è‡ªå·±</span><br>        applyIncludes(children.item(i));<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Node <span class="hljs-title function_">findSqlFragment</span><span class="hljs-params">(String refid)</span> &#123;<br>    refid = PropertyParser.parse(refid, configuration.getVariables());<br>    refid = builderAssistant.applyCurrentNamespace(refid, <span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å»ä¹‹å‰å­˜åˆ°å†…å­˜mapçš„SQLç‰‡æ®µä¸­å¯»æ‰¾</span><br>      <span class="hljs-type">XNode</span> <span class="hljs-variable">nodeToInclude</span> <span class="hljs-operator">=</span> configuration.getSqlFragments().get(refid);<br>      <span class="hljs-comment">// cloneä¸€ä¸‹ï¼Œä»¥é˜²æ”¹å†™ï¼Ÿ</span><br>      <span class="hljs-keyword">return</span> nodeToInclude.getNode().cloneNode(<span class="hljs-literal">true</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompleteElementException</span>(<span class="hljs-string">&quot;Could not find SQL statement to include with refid &#x27;&quot;</span> + refid + <span class="hljs-string">&quot;&#x27;&quot;</span>, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getStringAttribute</span><span class="hljs-params">(Node node, String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> node.getAttributes().getNamedItem(name).getNodeValue();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="XMLMapperEntityResolver"><a href="#XMLMapperEntityResolver" class="headerlink" title="XMLMapperEntityResolver"></a>XMLMapperEntityResolver</h4><p>Â Â Â Â Offline entity resolver for the MyBatis DTDs  </p><p>Â Â Â Â ç›®çš„æ˜¯æœªè”ç½‘çš„æƒ…å†µä¸‹ä¹Ÿèƒ½åšDTDéªŒè¯ï¼Œå®ç°åŸç†å°±æ˜¯å°†DTDæåˆ°æœ¬åœ°ï¼Œç„¶åç”¨org.xml.sax.EntityResolverï¼Œæœ€åè°ƒç”¨DocumentBuilder.setEntityResolveræ¥è¾¾åˆ°è„±æœºéªŒè¯  </p><p>Â Â Â Â EntityResolver  </p><p>Â Â Â Â public InputSource resolveEntity (String publicId, String systemId)  </p><p>Â Â Â Â åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨æ­¤æ¥å£å°†ç³»ç»Ÿæ ‡è¯†ç¬¦é‡å®šå‘åˆ°æœ¬åœ° URI  </p><p>Â Â Â Â ä½†æ˜¯ç”¨DTDæ˜¯æ¯”è¾ƒè¿‡æ—¶çš„åšæ³•ï¼Œæ–°çš„éƒ½æ”¹ç”¨xsdäº†  </p><p>Â Â Â Â è¿™ä¸ªç±»çš„åå­—å¹¶ä¸å‡†ç¡®ï¼Œå› ä¸ºå®ƒè¢«ä¸¤ä¸ªç±»éƒ½ç”¨åˆ°ï¼ˆXMLConfigBuilder,XMLMapperBuilderï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLMapperEntityResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EntityResolver</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, String&gt; doctypeMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br><br>  <span class="hljs-comment">// &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br>  <span class="hljs-comment">// &lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span><br>  <span class="hljs-comment">// å¸¸é‡å®šä¹‰</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IBATIS_CONFIG_PUBLIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;-//ibatis.apache.org//DTD Config 3.0//EN&quot;</span>.toUpperCase(Locale.ENGLISH);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IBATIS_CONFIG_SYSTEM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://ibatis.apache.org/dtd/ibatis-3-config.dtd&quot;</span>.toUpperCase(Locale.ENGLISH);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IBATIS_MAPPER_PUBLIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;-//ibatis.apache.org//DTD Mapper 3.0//EN&quot;</span>.toUpperCase(Locale.ENGLISH);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IBATIS_MAPPER_SYSTEM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd&quot;</span>.toUpperCase(Locale.ENGLISH);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_CONFIG_PUBLIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span>.toUpperCase(Locale.ENGLISH);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_CONFIG_SYSTEM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>.toUpperCase(Locale.ENGLISH);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_MAPPER_PUBLIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>.toUpperCase(Locale.ENGLISH);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_MAPPER_SYSTEM</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>.toUpperCase(Locale.ENGLISH);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_CONFIG_DTD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org/apache/ibatis/builder/xml/mybatis-3-config.dtd&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MYBATIS_MAPPER_DTD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;org/apache/ibatis/builder/xml/mybatis-3-mapper.dtd&quot;</span>;<br><br>  <span class="hljs-keyword">static</span> &#123;<br>    <span class="hljs-comment">// å°†DOCTYPEå’ŒURLéƒ½æ˜ å°„åˆ°æœ¬åœ°ç±»è·¯å¾„ä¸‹çš„DTD</span><br>    doctypeMap.put(IBATIS_CONFIG_SYSTEM, MYBATIS_CONFIG_DTD);<br>    doctypeMap.put(IBATIS_CONFIG_PUBLIC, MYBATIS_CONFIG_DTD);<br><br>    doctypeMap.put(IBATIS_MAPPER_SYSTEM, MYBATIS_MAPPER_DTD);<br>    doctypeMap.put(IBATIS_MAPPER_PUBLIC, MYBATIS_MAPPER_DTD);<br><br>    doctypeMap.put(MYBATIS_CONFIG_SYSTEM, MYBATIS_CONFIG_DTD);<br>    doctypeMap.put(MYBATIS_CONFIG_PUBLIC, MYBATIS_CONFIG_DTD);<br><br>    doctypeMap.put(MYBATIS_MAPPER_SYSTEM, MYBATIS_MAPPER_DTD);<br>    doctypeMap.put(MYBATIS_MAPPER_PUBLIC, MYBATIS_MAPPER_DTD);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> InputSource <span class="hljs-title function_">resolveEntity</span><span class="hljs-params">(String publicId, String systemId)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br><br>    <span class="hljs-keyword">if</span> (publicId != <span class="hljs-literal">null</span>) &#123;<br>      publicId = publicId.toUpperCase(Locale.ENGLISH);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (systemId != <span class="hljs-literal">null</span>) &#123;<br>      systemId = systemId.toUpperCase(Locale.ENGLISH);<br>    &#125;<br><br>    <span class="hljs-type">InputSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å…ˆæ‰¾publicIdï¼Œæ‰¾ä¸åˆ°å†æ‰¾systemIdï¼Œè²Œä¼¼ä¸å¯èƒ½æ‰¾ä¸åˆ°</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> doctypeMap.get(publicId);<br>      source = getInputSource(path, source);<br>      <span class="hljs-keyword">if</span> (source == <span class="hljs-literal">null</span>) &#123;<br>        path = doctypeMap.get(systemId);<br>        source = getInputSource(path, source);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXException</span>(e.toString());<br>    &#125;<br>    <span class="hljs-keyword">return</span> source;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> InputSource <span class="hljs-title function_">getInputSource</span><span class="hljs-params">(String path, InputSource source)</span> &#123;<br>    <span class="hljs-keyword">if</span> (path != <span class="hljs-literal">null</span>) &#123;<br>      InputStream in;<br>      <span class="hljs-keyword">try</span> &#123;<br>        in = Resources.getResourceAsStream(path);<br>        source = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(in);<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-comment">// ignore, null is ok</span><br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> source;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="XMLConfigBuilder"><a href="#XMLConfigBuilder" class="headerlink" title="XMLConfigBuilder"></a>XMLConfigBuilder</h4><p>Â Â Â Â XML é…ç½®æ„å»ºå™¨ï¼Œå»ºé€ è€…æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLConfigBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-comment">// æ˜¯å¦å·²è§£æï¼ŒXPathè§£æå™¨,ç¯å¢ƒ</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> parsed;<br>  <span class="hljs-keyword">private</span> XPathParser parser;<br>  <span class="hljs-keyword">private</span> String environment; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹3ä¸ªä¸€ç»„</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(Reader reader)</span> &#123;<br>    <span class="hljs-built_in">this</span>(reader, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(Reader reader, String environment)</span> &#123;<br>    <span class="hljs-built_in">this</span>(reader, environment, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// æ„é€ å‡½æ•°ï¼Œè½¬æ¢æˆXPathParserå†å»è°ƒç”¨æ„é€ å‡½æ•°</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(Reader reader, String environment, Properties props)</span> &#123;<br>    <span class="hljs-comment">//æ„é€ ä¸€ä¸ªéœ€è¦éªŒè¯ï¼ŒXMLMapperEntityResolverçš„XPathParser</span><br>    <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XPathParser</span>(reader, <span class="hljs-literal">true</span>, props, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperEntityResolver</span>()), environment, props);<br>  &#125; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹3ä¸ªä¸€ç»„</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(InputStream inputStream)</span> &#123;<br>    <span class="hljs-built_in">this</span>(inputStream, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(InputStream inputStream, String environment)</span> &#123;<br>    <span class="hljs-built_in">this</span>(inputStream, environment, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(InputStream inputStream, String environment, Properties props)</span> &#123;<br>    <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XPathParser</span>(inputStream, <span class="hljs-literal">true</span>, props, <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperEntityResolver</span>()), environment, props);<br>  &#125; <br><br>  <span class="hljs-comment">// ä¸Šé¢6ä¸ªæ„é€ å‡½æ•°æœ€åéƒ½åˆæµåˆ°è¿™ä¸ªå‡½æ•°ï¼Œä¼ å…¥XPathParser</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">XMLConfigBuilder</span><span class="hljs-params">(XPathParser parser, String environment, Properties props)</span> &#123;<br>    <span class="hljs-comment">// é¦–å…ˆè°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–Configuration</span><br>    <span class="hljs-built_in">super</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>());<br>    <span class="hljs-comment">// é”™è¯¯ä¸Šä¸‹æ–‡è®¾ç½®æˆSQL Mapper Configuration(XMLæ–‡ä»¶é…ç½®),ä»¥ä¾¿åé¢å‡ºé”™äº†æŠ¥é”™ç”¨å§</span><br>    ErrorContext.instance().resource(<span class="hljs-string">&quot;SQL Mapper Configuration&quot;</span>);<br>    <span class="hljs-comment">// å°†Propertieså…¨éƒ¨è®¾ç½®åˆ°Configurationé‡Œé¢å»</span><br>    <span class="hljs-built_in">this</span>.configuration.setVariables(props);<br>    <span class="hljs-built_in">this</span>.parsed = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">this</span>.environment = environment;<br>    <span class="hljs-built_in">this</span>.parser = parser;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æé…ç½®</span><br>  <span class="hljs-keyword">public</span> Configuration <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœå·²ç»è§£æè¿‡äº†ï¼ŒæŠ¥é”™</span><br>    <span class="hljs-keyword">if</span> (parsed) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);<br>    &#125;<br>    parsed = <span class="hljs-literal">true</span>;<br><span class="hljs-comment">//  &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt; </span><br><span class="hljs-comment">//  &lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; </span><br><span class="hljs-comment">//  &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt; </span><br><span class="hljs-comment">//  &lt;configuration&gt; </span><br><span class="hljs-comment">//  &lt;environments default=&quot;development&quot;&gt; </span><br><span class="hljs-comment">//  &lt;environment id=&quot;development&quot;&gt; </span><br><span class="hljs-comment">//  &lt;transactionManager type=&quot;JDBC&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;dataSource type=&quot;POOLED&quot;&gt; </span><br><span class="hljs-comment">//  &lt;property name=&quot;driver&quot; value=&quot;$&#123;driver&#125;&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;property name=&quot;username&quot; value=&quot;$&#123;username&#125;&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;property name=&quot;password&quot; value=&quot;$&#123;password&#125;&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;/dataSource&gt; </span><br><span class="hljs-comment">//  &lt;/environment&gt; </span><br><span class="hljs-comment">//  &lt;/environments&gt;</span><br><span class="hljs-comment">//  &lt;mappers&gt; </span><br><span class="hljs-comment">//  &lt;mapper resource=&quot;org/mybatis/example/BlogMapper.xml&quot;/&gt; </span><br><span class="hljs-comment">//  &lt;/mappers&gt; </span><br><span class="hljs-comment">//  &lt;/configuration&gt;</span><br><br>    <span class="hljs-comment">// æ ¹èŠ‚ç‚¹æ˜¯configuration</span><br>    parseConfiguration(parser.evalNode(<span class="hljs-string">&quot;/configuration&quot;</span>));<br>    <span class="hljs-keyword">return</span> configuration;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æé…ç½®</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseConfiguration</span><span class="hljs-params">(XNode root)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// åˆ†æ­¥éª¤è§£æ</span><br>      <span class="hljs-comment">// issue #117 read properties first</span><br>      <span class="hljs-comment">// 1.properties</span><br>      propertiesElement(root.evalNode(<span class="hljs-string">&quot;properties&quot;</span>));<br>      <span class="hljs-comment">// 2.ç±»å‹åˆ«å</span><br>      typeAliasesElement(root.evalNode(<span class="hljs-string">&quot;typeAliases&quot;</span>));<br>      <span class="hljs-comment">// 3.æ’ä»¶</span><br>      pluginElement(root.evalNode(<span class="hljs-string">&quot;plugins&quot;</span>));<br>      <span class="hljs-comment">// 4.å¯¹è±¡å·¥å‚</span><br>      objectFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectFactory&quot;</span>));<br>      <span class="hljs-comment">// 5.å¯¹è±¡åŒ…è£…å·¥å‚</span><br>      objectWrapperFactoryElement(root.evalNode(<span class="hljs-string">&quot;objectWrapperFactory&quot;</span>));<br>      <span class="hljs-comment">// 6.è®¾ç½®</span><br>      settingsElement(root.evalNode(<span class="hljs-string">&quot;settings&quot;</span>));<br>      <span class="hljs-comment">// read it after objectFactory and objectWrapperFactory issue #631</span><br>      <span class="hljs-comment">// 7.ç¯å¢ƒ</span><br>      environmentsElement(root.evalNode(<span class="hljs-string">&quot;environments&quot;</span>));<br>      <span class="hljs-comment">// 8.databaseIdProvider</span><br>      databaseIdProviderElement(root.evalNode(<span class="hljs-string">&quot;databaseIdProvider&quot;</span>));<br>      <span class="hljs-comment">// 9.ç±»å‹å¤„ç†å™¨</span><br>      typeHandlerElement(root.evalNode(<span class="hljs-string">&quot;typeHandlers&quot;</span>));<br>      <span class="hljs-comment">// 10.æ˜ å°„å™¨</span><br>      mapperElement(root.evalNode(<span class="hljs-string">&quot;mappers&quot;</span>));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//1.properties</span><br>  <span class="hljs-comment">//&lt;properties resource=&quot;org/mybatis/example/config.properties&quot;&gt;</span><br>  <span class="hljs-comment">//    &lt;property name=&quot;username&quot; value=&quot;dev_user&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;property name=&quot;password&quot; value=&quot;F2Fa3!33TYyg&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/properties&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">propertiesElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// å¦‚æœåœ¨è¿™äº›åœ°æ–¹,å±æ€§å¤šäºä¸€ä¸ªçš„è¯,MyBatis æŒ‰ç…§å¦‚ä¸‹çš„é¡ºåºåŠ è½½å®ƒä»¬:</span><br><br>      <span class="hljs-comment">// 1.åœ¨ properties å…ƒç´ ä½“å†…æŒ‡å®šçš„å±æ€§é¦–å…ˆè¢«è¯»å–ã€‚</span><br>      <span class="hljs-comment">// 2.ä»ç±»è·¯å¾„ä¸‹èµ„æºæˆ– properties å…ƒç´ çš„ url å±æ€§ä¸­åŠ è½½çš„å±æ€§ç¬¬äºŒè¢«è¯»å–,å®ƒä¼šè¦†ç›–å·²ç»å­˜åœ¨çš„å®Œå…¨ä¸€æ ·çš„å±æ€§ã€‚</span><br>      <span class="hljs-comment">// 3.ä½œä¸ºæ–¹æ³•å‚æ•°ä¼ é€’çš„å±æ€§æœ€åè¢«è¯»å–, å®ƒä¹Ÿä¼šè¦†ç›–ä»»ä¸€å·²ç»å­˜åœ¨çš„å®Œå…¨ä¸€æ ·çš„å±æ€§,è¿™äº›å±æ€§å¯èƒ½æ˜¯ä» properties å…ƒç´ ä½“å†…å’Œèµ„æº/url å±æ€§ä¸­åŠ è½½çš„ã€‚</span><br>      <span class="hljs-comment">// ä¼ å…¥æ–¹å¼æ˜¯è°ƒç”¨æ„é€ å‡½æ•°æ—¶ä¼ å…¥ï¼Œpublic XMLConfigBuilder(Reader reader, String environment, Properties props)</span><br><br>      <span class="hljs-comment">// 1.XNode.getChildrenAsPropertieså‡½æ•°æ–¹ä¾¿å¾—åˆ°å­©å­æ‰€æœ‰Properties</span><br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">defaults</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// 2.ç„¶åæŸ¥æ‰¾resourceæˆ–è€…url,åŠ å…¥å‰é¢çš„Properties</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resource&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;url&quot;</span>);<br>      <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span> &amp;&amp; url != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;The properties element cannot specify both a URL and a resource based property file reference.  Please specify one or the other.&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span>) &#123;<br>        defaults.putAll(Resources.getResourceAsProperties(resource));<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (url != <span class="hljs-literal">null</span>) &#123;<br>        defaults.putAll(Resources.getUrlAsProperties(url));<br>      &#125;<br>      <span class="hljs-comment">// 3.Variablesä¹Ÿå…¨éƒ¨åŠ å…¥Properties</span><br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">vars</span> <span class="hljs-operator">=</span> configuration.getVariables();<br>      <span class="hljs-keyword">if</span> (vars != <span class="hljs-literal">null</span>) &#123;<br>        defaults.putAll(vars);<br>      &#125;<br>      parser.setVariables(defaults);<br>      configuration.setVariables(defaults);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//2.ç±»å‹åˆ«å</span><br>  <span class="hljs-comment">//&lt;typeAliases&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Author&quot; type=&quot;domain.blog.Author&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Blog&quot; type=&quot;domain.blog.Blog&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Comment&quot; type=&quot;domain.blog.Comment&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Post&quot; type=&quot;domain.blog.Post&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Section&quot; type=&quot;domain.blog.Section&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;typeAlias alias=&quot;Tag&quot; type=&quot;domain.blog.Tag&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/typeAliases&gt;</span><br>  <span class="hljs-comment">//or    </span><br>  <span class="hljs-comment">//&lt;typeAliases&gt;</span><br>  <span class="hljs-comment">//  &lt;package name=&quot;domain.blog&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/typeAliases&gt;  </span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">typeAliasesElement</span><span class="hljs-params">(XNode parent)</span> &#123;<br>    <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (XNode child : parent.getChildren()) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;package&quot;</span>.equals(child.getName())) &#123;<br>          <span class="hljs-comment">// å¦‚æœæ˜¯package</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">typeAliasPackage</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>          <span class="hljs-comment">//ï¼ˆä¸€ï¼‰è°ƒç”¨TypeAliasRegistry.registerAliasesï¼Œå»åŒ…ä¸‹æ‰¾æ‰€æœ‰ç±»,ç„¶åæ³¨å†Œåˆ«å(æœ‰@Aliasæ³¨è§£åˆ™ç”¨ï¼Œæ²¡æœ‰åˆ™å–ç±»çš„simpleName)</span><br>          configuration.getTypeAliasRegistry().registerAliases(typeAliasPackage);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// å¦‚æœæ˜¯typeAlias</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">alias</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;alias&quot;</span>);<br>          <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>          <span class="hljs-keyword">try</span> &#123;<br>            Class&lt;?&gt; clazz = Resources.classForName(type);<br>            <span class="hljs-comment">// æ ¹æ®Classåå­—æ¥æ³¨å†Œç±»å‹åˆ«å</span><br>            <span class="hljs-comment">//ï¼ˆäºŒï¼‰è°ƒç”¨TypeAliasRegistry.registerAlias</span><br>            <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>              <span class="hljs-comment">// aliaså¯ä»¥çœç•¥</span><br>              typeAliasRegistry.registerAlias(clazz);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              typeAliasRegistry.registerAlias(alias, clazz);<br>            &#125;<br>          &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error registering typeAlias for &#x27;&quot;</span> + alias + <span class="hljs-string">&quot;&#x27;. Cause: &quot;</span> + e, e);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//3.æ’ä»¶</span><br>  <span class="hljs-comment">//MyBatis å…è®¸ä½ åœ¨æŸä¸€ç‚¹æ‹¦æˆªå·²æ˜ å°„è¯­å¥æ‰§è¡Œçš„è°ƒç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹,MyBatis å…è®¸ä½¿ç”¨æ’ä»¶æ¥æ‹¦æˆªæ–¹æ³•è°ƒç”¨</span><br>  <span class="hljs-comment">//&lt;plugins&gt;</span><br>  <span class="hljs-comment">//  &lt;plugin interceptor=&quot;org.mybatis.example.ExamplePlugin&quot;&gt;</span><br>  <span class="hljs-comment">//    &lt;property name=&quot;someProperty&quot; value=&quot;100&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;/plugin&gt;</span><br>  <span class="hljs-comment">//&lt;/plugins&gt;  </span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pluginElement</span><span class="hljs-params">(XNode parent)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (XNode child : parent.getChildren()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;interceptor&quot;</span>);<br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> child.getChildrenAsProperties();<br>        <span class="hljs-type">Interceptor</span> <span class="hljs-variable">interceptorInstance</span> <span class="hljs-operator">=</span> (Interceptor) resolveClass(interceptor).newInstance();<br>        interceptorInstance.setProperties(properties);<br>        <span class="hljs-comment">// è°ƒç”¨InterceptorChain.addInterceptor</span><br>        configuration.addInterceptor(interceptorInstance);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//4.å¯¹è±¡å·¥å‚,å¯ä»¥è‡ªå®šä¹‰å¯¹è±¡åˆ›å»ºçš„æ–¹å¼,æ¯”å¦‚ç”¨å¯¹è±¡æ± ï¼Ÿ</span><br>  <span class="hljs-comment">//&lt;objectFactory type=&quot;org.mybatis.example.ExampleObjectFactory&quot;&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;someProperty&quot; value=&quot;100&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/objectFactory&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">objectFactoryElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-type">ObjectFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> (ObjectFactory) resolveClass(type).newInstance();<br>      factory.setProperties(properties);<br>      configuration.setObjectFactory(factory);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 5.å¯¹è±¡åŒ…è£…å·¥å‚</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">objectWrapperFactoryElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      <span class="hljs-type">ObjectWrapperFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> (ObjectWrapperFactory) resolveClass(type).newInstance();<br>      configuration.setObjectWrapperFactory(factory);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//6.è®¾ç½®</span><br>  <span class="hljs-comment">//è¿™äº›æ˜¯æå…¶é‡è¦çš„è°ƒæ•´, å®ƒä»¬ä¼šä¿®æ”¹ MyBatis åœ¨è¿è¡Œæ—¶çš„è¡Œä¸ºæ–¹å¼</span><br>  <span class="hljs-comment">//&lt;settings&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;cacheEnabled&quot; value=&quot;true&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;lazyLoadingEnabled&quot; value=&quot;true&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;multipleResultSetsEnabled&quot; value=&quot;true&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;useColumnLabel&quot; value=&quot;true&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;useGeneratedKeys&quot; value=&quot;false&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;enhancementEnabled&quot; value=&quot;false&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;defaultExecutorType&quot; value=&quot;SIMPLE&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;defaultStatementTimeout&quot; value=&quot;25000&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;safeRowBoundsEnabled&quot; value=&quot;false&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;mapUnderscoreToCamelCase&quot; value=&quot;false&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;localCacheScope&quot; value=&quot;SESSION&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;jdbcTypeForNull&quot; value=&quot;OTHER&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;setting name=&quot;lazyLoadTriggerMethods&quot; value=&quot;equals,clone,hashCode,toString&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/settings&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">settingsElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// Check that all settings are known to the configuration class</span><br>      <span class="hljs-comment">// æ£€æŸ¥ä¸‹æ˜¯å¦åœ¨Configurationç±»é‡Œéƒ½æœ‰ç›¸åº”çš„setteræ–¹æ³•ï¼ˆæ²¡æœ‰æ‹¼å†™é”™è¯¯ï¼‰</span><br>      <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaConfig</span> <span class="hljs-operator">=</span> MetaClass.forClass(Configuration.class);<br>      <span class="hljs-keyword">for</span> (Object key : props.keySet()) &#123;<br>        <span class="hljs-keyword">if</span> (!metaConfig.hasSetter(String.valueOf(key))) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;The setting &quot;</span> + key + <span class="hljs-string">&quot; is not known.  Make sure you spelled it correctly (case sensitive).&quot;</span>);<br>        &#125;<br>      &#125;<br><br>      <span class="hljs-comment">// ä¸‹é¢éå¸¸ç®€å•ï¼Œä¸€ä¸ªä¸ªè®¾ç½®å±æ€§</span><br>      <span class="hljs-comment">// å¦‚ä½•è‡ªåŠ¨æ˜ å°„åˆ—åˆ°å­—æ®µ/ å±æ€§</span><br>      configuration.setAutoMappingBehavior(AutoMappingBehavior.valueOf(props.getProperty(<span class="hljs-string">&quot;autoMappingBehavior&quot;</span>, <span class="hljs-string">&quot;PARTIAL&quot;</span>)));<br>      <span class="hljs-comment">// ç¼“å­˜</span><br>      configuration.setCacheEnabled(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;cacheEnabled&quot;</span>), <span class="hljs-literal">true</span>));<br>      <span class="hljs-comment">// proxyFactory (CGLIB | JAVASSIST)</span><br>      <span class="hljs-comment">// å»¶è¿ŸåŠ è½½çš„æ ¸å¿ƒæŠ€æœ¯å°±æ˜¯ç”¨ä»£ç†æ¨¡å¼ï¼ŒCGLIB/JAVASSISTä¸¤è€…é€‰ä¸€</span><br>      configuration.setProxyFactory((ProxyFactory) createInstance(props.getProperty(<span class="hljs-string">&quot;proxyFactory&quot;</span>)));<br>      <span class="hljs-comment">// å»¶è¿ŸåŠ è½½</span><br>      configuration.setLazyLoadingEnabled(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;lazyLoadingEnabled&quot;</span>), <span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// å»¶è¿ŸåŠ è½½æ—¶ï¼Œæ¯ç§å±æ€§æ˜¯å¦è¿˜è¦æŒ‰éœ€åŠ è½½</span><br>      configuration.setAggressiveLazyLoading(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;aggressiveLazyLoading&quot;</span>), <span class="hljs-literal">true</span>));<br>      <span class="hljs-comment">// å…ä¸å…è®¸å¤šç§ç»“æœé›†ä»ä¸€ä¸ªå•ç‹¬ çš„è¯­å¥ä¸­è¿”å›</span><br>      configuration.setMultipleResultSetsEnabled(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;multipleResultSetsEnabled&quot;</span>), <span class="hljs-literal">true</span>));<br>      <span class="hljs-comment">// ä½¿ç”¨åˆ—æ ‡ç­¾ä»£æ›¿åˆ—å</span><br>      configuration.setUseColumnLabel(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;useColumnLabel&quot;</span>), <span class="hljs-literal">true</span>));<br>      <span class="hljs-comment">// å…è®¸ JDBC æ”¯æŒç”Ÿæˆçš„é”®</span><br>      configuration.setUseGeneratedKeys(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;useGeneratedKeys&quot;</span>), <span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// é…ç½®é»˜è®¤çš„æ‰§è¡Œå™¨</span><br>      configuration.setDefaultExecutorType(ExecutorType.valueOf(props.getProperty(<span class="hljs-string">&quot;defaultExecutorType&quot;</span>, <span class="hljs-string">&quot;SIMPLE&quot;</span>)));<br>      <span class="hljs-comment">// è¶…æ—¶æ—¶é—´</span><br>      configuration.setDefaultStatementTimeout(integerValueOf(props.getProperty(<span class="hljs-string">&quot;defaultStatementTimeout&quot;</span>), <span class="hljs-literal">null</span>));<br>      <span class="hljs-comment">// æ˜¯å¦å°†DBå­—æ®µè‡ªåŠ¨æ˜ å°„åˆ°é©¼å³°å¼Javaå±æ€§ï¼ˆA_COLUMN--&gt;aColumnï¼‰</span><br>      configuration.setMapUnderscoreToCamelCase(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;mapUnderscoreToCamelCase&quot;</span>), <span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// åµŒå¥—è¯­å¥ä¸Šä½¿ç”¨RowBounds</span><br>      configuration.setSafeRowBoundsEnabled(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;safeRowBoundsEnabled&quot;</span>), <span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// é»˜è®¤ç”¨sessionçº§åˆ«çš„ç¼“å­˜</span><br>      configuration.setLocalCacheScope(LocalCacheScope.valueOf(props.getProperty(<span class="hljs-string">&quot;localCacheScope&quot;</span>, <span class="hljs-string">&quot;SESSION&quot;</span>)));<br>      <span class="hljs-comment">// ä¸ºnullå€¼è®¾ç½®jdbctype</span><br>      configuration.setJdbcTypeForNull(JdbcType.valueOf(props.getProperty(<span class="hljs-string">&quot;jdbcTypeForNull&quot;</span>, <span class="hljs-string">&quot;OTHER&quot;</span>)));<br>      <span class="hljs-comment">// Objectçš„å“ªäº›æ–¹æ³•å°†è§¦å‘å»¶è¿ŸåŠ è½½</span><br>      configuration.setLazyLoadTriggerMethods(stringSetValueOf(props.getProperty(<span class="hljs-string">&quot;lazyLoadTriggerMethods&quot;</span>), <span class="hljs-string">&quot;equals,clone,hashCode,toString&quot;</span>));<br>      <span class="hljs-comment">// ä½¿ç”¨å®‰å…¨çš„ResultHandler</span><br>      configuration.setSafeResultHandlerEnabled(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;safeResultHandlerEnabled&quot;</span>), <span class="hljs-literal">true</span>));<br>      <span class="hljs-comment">// åŠ¨æ€SQLç”Ÿæˆè¯­è¨€æ‰€ä½¿ç”¨çš„è„šæœ¬è¯­è¨€</span><br>      configuration.setDefaultScriptingLanguage(resolveClass(props.getProperty(<span class="hljs-string">&quot;defaultScriptingLanguage&quot;</span>)));<br>      <span class="hljs-comment">// å½“ç»“æœé›†ä¸­å«æœ‰Nullå€¼æ—¶æ˜¯å¦æ‰§è¡Œæ˜ å°„å¯¹è±¡çš„setteræˆ–è€…Mapå¯¹è±¡çš„putæ–¹æ³•ã€‚æ­¤è®¾ç½®å¯¹äºåŸå§‹ç±»å‹å¦‚int,booleanç­‰æ— æ•ˆã€‚ </span><br>      configuration.setCallSettersOnNulls(booleanValueOf(props.getProperty(<span class="hljs-string">&quot;callSettersOnNulls&quot;</span>), <span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// loggeråå­—çš„å‰ç¼€</span><br>      configuration.setLogPrefix(props.getProperty(<span class="hljs-string">&quot;logPrefix&quot;</span>));<br>      <span class="hljs-comment">// æ˜¾å¼å®šä¹‰ç”¨ä»€ä¹ˆlogæ¡†æ¶ï¼Œä¸å®šä¹‰åˆ™ç”¨é»˜è®¤çš„è‡ªåŠ¨å‘ç°jaråŒ…æœºåˆ¶</span><br>      configuration.setLogImpl(resolveClass(props.getProperty(<span class="hljs-string">&quot;logImpl&quot;</span>)));<br>      <span class="hljs-comment">// é…ç½®å·¥å‚</span><br>      configuration.setConfigurationFactory(resolveClass(props.getProperty(<span class="hljs-string">&quot;configurationFactory&quot;</span>)));<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//7.ç¯å¢ƒ</span><br>  <span class="hljs-comment">//    &lt;environments default=&quot;development&quot;&gt;</span><br>  <span class="hljs-comment">//      &lt;environment id=&quot;development&quot;&gt;</span><br>  <span class="hljs-comment">//        &lt;transactionManager type=&quot;JDBC&quot;&gt;</span><br>  <span class="hljs-comment">//          &lt;property name=&quot;...&quot; value=&quot;...&quot;/&gt;</span><br>  <span class="hljs-comment">//        &lt;/transactionManager&gt;</span><br>  <span class="hljs-comment">//        &lt;dataSource type=&quot;POOLED&quot;&gt;</span><br>  <span class="hljs-comment">//          &lt;property name=&quot;driver&quot; value=&quot;$&#123;driver&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//          &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//          &lt;property name=&quot;username&quot; value=&quot;$&#123;username&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//          &lt;property name=&quot;password&quot; value=&quot;$&#123;password&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//        &lt;/dataSource&gt;</span><br>  <span class="hljs-comment">//      &lt;/environment&gt;</span><br>  <span class="hljs-comment">//    &lt;/environments&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">environmentsElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (environment == <span class="hljs-literal">null</span>) &#123;<br>        environment = context.getStringAttribute(<span class="hljs-string">&quot;default&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">for</span> (XNode child : context.getChildren()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>        <span class="hljs-comment">// å¾ªç¯æ¯”è¾ƒidæ˜¯å¦å°±æ˜¯æŒ‡å®šçš„environment</span><br>        <span class="hljs-keyword">if</span> (isSpecifiedEnvironment(id)) &#123;<br>          <span class="hljs-comment">// 7.1äº‹åŠ¡ç®¡ç†å™¨</span><br>          <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">txFactory</span> <span class="hljs-operator">=</span> transactionManagerElement(child.evalNode(<span class="hljs-string">&quot;transactionManager&quot;</span>));<br>          <span class="hljs-comment">// 7.2æ•°æ®æº</span><br>          <span class="hljs-type">DataSourceFactory</span> <span class="hljs-variable">dsFactory</span> <span class="hljs-operator">=</span> dataSourceElement(child.evalNode(<span class="hljs-string">&quot;dataSource&quot;</span>));<br>          <span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> dsFactory.getDataSource();<br>          Environment.<span class="hljs-type">Builder</span> <span class="hljs-variable">environmentBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Environment</span>.Builder(id)<br>              .transactionFactory(txFactory)<br>              .dataSource(dataSource);<br>          configuration.setEnvironment(environmentBuilder.build());<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ¯”è¾ƒidå’Œenvironmentæ˜¯å¦ç›¸ç­‰</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSpecifiedEnvironment</span><span class="hljs-params">(String id)</span> &#123;<br>    <span class="hljs-keyword">if</span> (environment == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;No environment specified.&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Environment requires an id attribute.&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (environment.equals(id)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125; <br><br>  <span class="hljs-comment">//7.1äº‹åŠ¡ç®¡ç†å™¨</span><br>  <span class="hljs-comment">//&lt;transactionManager type=&quot;JDBC&quot;&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;...&quot; value=&quot;...&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/transactionManager&gt;</span><br>  <span class="hljs-keyword">private</span> TransactionFactory <span class="hljs-title function_">transactionManagerElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// æ ¹æ®type=&quot;JDBC&quot;è§£æè¿”å›é€‚å½“çš„TransactionFactory</span><br>      <span class="hljs-comment">// JDBC æ˜¯åœ¨ Configurationç±»ä¸­æ³¨å†Œçš„</span><br>      <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> (TransactionFactory) resolveClass(type).newInstance();<br>      factory.setProperties(props);<br>      <span class="hljs-keyword">return</span> factory;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Environment declaration requires a TransactionFactory.&quot;</span>);<br>  &#125; <br><br>  <span class="hljs-comment">//7.2æ•°æ®æº</span><br>  <span class="hljs-comment">//&lt;dataSource type=&quot;POOLED&quot;&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;driver&quot; value=&quot;$&#123;driver&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;url&quot; value=&quot;$&#123;url&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;username&quot; value=&quot;$&#123;username&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;property name=&quot;password&quot; value=&quot;$&#123;password&#125;&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/dataSource&gt;</span><br>  <span class="hljs-keyword">private</span> DataSourceFactory <span class="hljs-title function_">dataSourceElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// æ ¹æ®type=&quot;POOLED&quot;è§£æè¿”å›é€‚å½“çš„DataSourceFactory</span><br>      <span class="hljs-type">DataSourceFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> (DataSourceFactory) resolveClass(type).newInstance();<br>      factory.setProperties(props);<br>      <span class="hljs-keyword">return</span> factory;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Environment declaration requires a DataSourceFactory.&quot;</span>);<br>  &#125; <br><br>  <span class="hljs-comment">//8.databaseIdProvider</span><br>  <span class="hljs-comment">//å¯ä»¥æ ¹æ®ä¸åŒæ•°æ®åº“æ‰§è¡Œä¸åŒçš„SQLï¼Œsqlè¦åŠ databaseIdå±æ€§</span><br>  <span class="hljs-comment">//è¿™ä¸ªåŠŸèƒ½æ„Ÿè§‰ä¸æ˜¯å¾ˆå®ç”¨ï¼ŒçœŸè¦å¤šæ•°æ®åº“æ”¯æŒï¼Œé‚£SQLå·¥ä½œé‡å°†ä¼šæˆå€å¢é•¿ï¼Œç”¨mybatisä»¥åä¸€èˆ¬å°±ç»‘æ­»åœ¨ä¸€ä¸ªæ•°æ®åº“ä¸Šäº†ã€‚ä½†ä¹Ÿæ˜¯ä¸€ä¸ªä¸å¾—å·²çš„æ–¹æ³•å§</span><br>  <span class="hljs-comment">//å¯ä»¥å‚è€ƒorg.apache.ibatis.submitted.multidbåŒ…é‡Œçš„æµ‹è¯•ç”¨ä¾‹</span><br>  <span class="hljs-comment">//    &lt;databaseIdProvider type=&quot;VENDOR&quot;&gt;</span><br>  <span class="hljs-comment">//      &lt;property name=&quot;SQL Server&quot; value=&quot;sqlserver&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;property name=&quot;DB2&quot; value=&quot;db2&quot;/&gt;        </span><br>  <span class="hljs-comment">//      &lt;property name=&quot;Oracle&quot; value=&quot;oracle&quot; /&gt;</span><br>  <span class="hljs-comment">//    &lt;/databaseIdProvider&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">databaseIdProviderElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">DatabaseIdProvider</span> <span class="hljs-variable">databaseIdProvider</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      <span class="hljs-comment">// awful patch to keep backward compatibility</span><br>      <span class="hljs-comment">// ä¸è€ç‰ˆæœ¬å…¼å®¹</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;VENDOR&quot;</span>.equals(type)) &#123;<br>          type = <span class="hljs-string">&quot;DB_VENDOR&quot;</span>;<br>      &#125;<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// &quot;DB_VENDOR&quot;--&gt;VendorDatabaseIdProvider</span><br>      databaseIdProvider = (DatabaseIdProvider) resolveClass(type).newInstance();<br>      databaseIdProvider.setProperties(properties);<br>    &#125;<br>    <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> configuration.getEnvironment();<br>    <span class="hljs-keyword">if</span> (environment != <span class="hljs-literal">null</span> &amp;&amp; databaseIdProvider != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// å¾—åˆ°å½“å‰çš„databaseIdï¼Œå¯ä»¥è°ƒç”¨DatabaseMetaData.getDatabaseProductName()å¾—åˆ°è¯¸å¦‚&quot;Oracle (DataDirect)&quot;çš„å­—ç¬¦ä¸²ï¼Œ</span><br>      <span class="hljs-comment">// ç„¶åå’Œé¢„å®šä¹‰çš„propertyæ¯”è¾ƒ,å¾—å‡ºç›®å‰ç©¶ç«Ÿç”¨çš„æ˜¯ä»€ä¹ˆæ•°æ®åº“</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">databaseId</span> <span class="hljs-operator">=</span> databaseIdProvider.getDatabaseId(environment.getDataSource());<br>      configuration.setDatabaseId(databaseId);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//9.ç±»å‹å¤„ç†å™¨</span><br>  <span class="hljs-comment">//    &lt;typeHandlers&gt;</span><br>  <span class="hljs-comment">//      &lt;typeHandler handler=&quot;org.mybatis.example.ExampleTypeHandler&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/typeHandlers&gt;</span><br>  <span class="hljs-comment">//or</span><br>  <span class="hljs-comment">//    &lt;typeHandlers&gt;</span><br>  <span class="hljs-comment">//      &lt;package name=&quot;org.mybatis.example&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/typeHandlers&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">typeHandlerElement</span><span class="hljs-params">(XNode parent)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (XNode child : parent.getChildren()) &#123;<br>        <span class="hljs-comment">// å¦‚æœæ˜¯package</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;package&quot;</span>.equals(child.getName())) &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">typeHandlerPackage</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>          <span class="hljs-comment">//ï¼ˆä¸€ï¼‰è°ƒç”¨TypeHandlerRegistry.registerï¼Œå»åŒ…ä¸‹æ‰¾æ‰€æœ‰ç±»</span><br>          typeHandlerRegistry.register(typeHandlerPackage);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// å¦‚æœæ˜¯typeHandler</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">javaTypeName</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>);<br>          <span class="hljs-type">String</span> <span class="hljs-variable">jdbcTypeName</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;jdbcType&quot;</span>);<br>          <span class="hljs-type">String</span> <span class="hljs-variable">handlerTypeName</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;handler&quot;</span>);<br>          Class&lt;?&gt; javaTypeClass = resolveClass(javaTypeName);<br>          <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> resolveJdbcType(jdbcTypeName);<br>          Class&lt;?&gt; typeHandlerClass = resolveClass(handlerTypeName);<br>          <span class="hljs-comment">//ï¼ˆäºŒï¼‰è°ƒç”¨TypeHandlerRegistry.register(ä»¥ä¸‹æ˜¯3ç§ä¸åŒçš„å‚æ•°å½¢å¼)</span><br>          <span class="hljs-keyword">if</span> (javaTypeClass != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (jdbcType == <span class="hljs-literal">null</span>) &#123;<br>              typeHandlerRegistry.register(javaTypeClass, typeHandlerClass);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              typeHandlerRegistry.register(javaTypeClass, jdbcType, typeHandlerClass);<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            typeHandlerRegistry.register(typeHandlerClass);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//10.æ˜ å°„å™¨</span><br>  <span class="hljs-comment">//    10.1ä½¿ç”¨ç±»è·¯å¾„</span><br>  <span class="hljs-comment">//    &lt;mappers&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper resource=&quot;org/mybatis/builder/AuthorMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper resource=&quot;org/mybatis/builder/BlogMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper resource=&quot;org/mybatis/builder/PostMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/mappers&gt;</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">//    10.2ä½¿ç”¨ç»å¯¹urlè·¯å¾„</span><br>  <span class="hljs-comment">//    &lt;mappers&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper url=&quot;file:///var/mappers/AuthorMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper url=&quot;file:///var/mappers/BlogMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper url=&quot;file:///var/mappers/PostMapper.xml&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/mappers&gt;</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">//    10.3ä½¿ç”¨javaç±»å</span><br>  <span class="hljs-comment">//    &lt;mappers&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper class=&quot;org.mybatis.builder.AuthorMapper&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper class=&quot;org.mybatis.builder.BlogMapper&quot;/&gt;</span><br>  <span class="hljs-comment">//      &lt;mapper class=&quot;org.mybatis.builder.PostMapper&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/mappers&gt;</span><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">//    10.4è‡ªåŠ¨æ‰«æåŒ…ä¸‹æ‰€æœ‰æ˜ å°„å™¨</span><br>  <span class="hljs-comment">//    &lt;mappers&gt;</span><br>  <span class="hljs-comment">//      &lt;package name=&quot;org.mybatis.builder&quot;/&gt;</span><br>  <span class="hljs-comment">//    &lt;/mappers&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mapperElement</span><span class="hljs-params">(XNode parent)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (XNode child : parent.getChildren()) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;package&quot;</span>.equals(child.getName())) &#123;<br>          <span class="hljs-comment">//10.4è‡ªåŠ¨æ‰«æåŒ…ä¸‹æ‰€æœ‰æ˜ å°„å™¨</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">mapperPackage</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>          configuration.addMappers(mapperPackage);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;resource&quot;</span>);<br>          <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;url&quot;</span>);<br>          <span class="hljs-type">String</span> <span class="hljs-variable">mapperClass</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;class&quot;</span>);<br>          <span class="hljs-keyword">if</span> (resource != <span class="hljs-literal">null</span> &amp;&amp; url == <span class="hljs-literal">null</span> &amp;&amp; mapperClass == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 10.1ä½¿ç”¨ç±»è·¯å¾„</span><br>            ErrorContext.instance().resource(resource);<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getResourceAsStream(resource);<br>            <span class="hljs-comment">// æ˜ å°„å™¨æ¯”è¾ƒå¤æ‚ï¼Œè°ƒç”¨XMLMapperBuilder</span><br>            <span class="hljs-comment">// æ³¨æ„åœ¨forå¾ªç¯é‡Œæ¯ä¸ªmapperéƒ½é‡æ–°newä¸€ä¸ªXMLMapperBuilderï¼Œæ¥è§£æ</span><br>            <span class="hljs-type">XMLMapperBuilder</span> <span class="hljs-variable">mapperParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperBuilder</span>(inputStream, configuration, resource, configuration.getSqlFragments());<br>            mapperParser.parse();<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource == <span class="hljs-literal">null</span> &amp;&amp; url != <span class="hljs-literal">null</span> &amp;&amp; mapperClass == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 10.2ä½¿ç”¨ç»å¯¹urlè·¯å¾„</span><br>            ErrorContext.instance().resource(url);<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> Resources.getUrlAsStream(url);<br>            <span class="hljs-comment">// æ˜ å°„å™¨æ¯”è¾ƒå¤æ‚ï¼Œè°ƒç”¨XMLMapperBuilder</span><br>            <span class="hljs-type">XMLMapperBuilder</span> <span class="hljs-variable">mapperParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperBuilder</span>(inputStream, configuration, url, configuration.getSqlFragments());<br>            mapperParser.parse();<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resource == <span class="hljs-literal">null</span> &amp;&amp; url == <span class="hljs-literal">null</span> &amp;&amp; mapperClass != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 10.3ä½¿ç”¨javaç±»å</span><br>            Class&lt;?&gt; mapperInterface = Resources.classForName(mapperClass);<br>            <span class="hljs-comment">// ç›´æ¥æŠŠè¿™ä¸ªæ˜ å°„åŠ å…¥é…ç½®</span><br>            configuration.addMapper(mapperInterface);<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;A mapper element may only specify a url, resource or class, but not more than one.&quot;</span>);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="XMLStatementBuilder"><a href="#XMLStatementBuilder" class="headerlink" title="XMLStatementBuilder"></a>XMLStatementBuilder</h4><p>Â Â Â Â XMLè¯­å¥æ„å»ºå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLStatementBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-keyword">private</span> MapperBuilderAssistant builderAssistant;<br>  <span class="hljs-keyword">private</span> XNode context;<br>  <span class="hljs-keyword">private</span> String requiredDatabaseId; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLStatementBuilder</span><span class="hljs-params">(Configuration configuration, MapperBuilderAssistant builderAssistant, XNode context)</span> &#123;<br>    <span class="hljs-built_in">this</span>(configuration, builderAssistant, context, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLStatementBuilder</span><span class="hljs-params">(Configuration configuration, MapperBuilderAssistant builderAssistant, XNode context, String databaseId)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration);<br>    <span class="hljs-built_in">this</span>.builderAssistant = builderAssistant;<br>    <span class="hljs-built_in">this</span>.context = context;<br>    <span class="hljs-built_in">this</span>.requiredDatabaseId = databaseId;<br>  &#125; <br><br>  <span class="hljs-comment">//è§£æè¯­å¥(select|insert|update|delete)</span><br>  <span class="hljs-comment">//&lt;select</span><br>  <span class="hljs-comment">//  id=&quot;selectPerson&quot;</span><br>  <span class="hljs-comment">//  parameterType=&quot;int&quot;</span><br>  <span class="hljs-comment">//  parameterMap=&quot;deprecated&quot;</span><br>  <span class="hljs-comment">//  resultType=&quot;hashmap&quot;</span><br>  <span class="hljs-comment">//  resultMap=&quot;personResultMap&quot;</span><br>  <span class="hljs-comment">//  flushCache=&quot;false&quot;</span><br>  <span class="hljs-comment">//  useCache=&quot;true&quot;</span><br>  <span class="hljs-comment">//  timeout=&quot;10000&quot;</span><br>  <span class="hljs-comment">//  fetchSize=&quot;256&quot;</span><br>  <span class="hljs-comment">//  statementType=&quot;PREPARED&quot;</span><br>  <span class="hljs-comment">//  resultSetType=&quot;FORWARD_ONLY&quot;&gt;</span><br>  <span class="hljs-comment">//  SELECT * FROM PERSON WHERE ID = #&#123;id&#125;</span><br>  <span class="hljs-comment">//&lt;/select&gt;</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseStatementNode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">databaseId</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>);<br><br>    <span class="hljs-comment">// å¦‚æœdatabaseIdä¸åŒ¹é…ï¼Œé€€å‡º</span><br>    <span class="hljs-keyword">if</span> (!databaseIdMatchesCurrent(id, databaseId, <span class="hljs-built_in">this</span>.requiredDatabaseId)) &#123;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// æš—ç¤ºé©±åŠ¨ç¨‹åºæ¯æ¬¡æ‰¹é‡è¿”å›çš„ç»“æœè¡Œæ•°</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> context.getIntAttribute(<span class="hljs-string">&quot;fetchSize&quot;</span>);<br>    <span class="hljs-comment">// è¶…æ—¶æ—¶é—´</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> context.getIntAttribute(<span class="hljs-string">&quot;timeout&quot;</span>);<br>    <span class="hljs-comment">// å¼•ç”¨å¤–éƒ¨ parameterMap,å·²åºŸå¼ƒ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">parameterMap</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;parameterMap&quot;</span>);<br>    <span class="hljs-comment">// å‚æ•°ç±»å‹</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">parameterType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;parameterType&quot;</span>);<br>    Class&lt;?&gt; parameterTypeClass = resolveClass(parameterType);<br>    <span class="hljs-comment">// å¼•ç”¨å¤–éƒ¨çš„ resultMap(é«˜çº§åŠŸèƒ½)</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>);<br>    <span class="hljs-comment">// ç»“æœç±»å‹</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultType&quot;</span>);<br>    <span class="hljs-comment">// è„šæœ¬è¯­è¨€,mybatis3.2çš„æ–°åŠŸèƒ½</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lang</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;lang&quot;</span>);<br>    <span class="hljs-comment">// å¾—åˆ°è¯­è¨€é©±åŠ¨</span><br>    <span class="hljs-type">LanguageDriver</span> <span class="hljs-variable">langDriver</span> <span class="hljs-operator">=</span> getLanguageDriver(lang);<br><br>    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);<br>    <span class="hljs-comment">// ç»“æœé›†ç±»å‹ï¼ŒFORWARD_ONLY|SCROLL_SENSITIVE|SCROLL_INSENSITIVE ä¸­çš„ä¸€ç§</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultSetType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultSetType&quot;</span>);<br>    <span class="hljs-comment">// è¯­å¥ç±»å‹, STATEMENT|PREPARED|CALLABLE çš„ä¸€ç§</span><br>    <span class="hljs-type">StatementType</span> <span class="hljs-variable">statementType</span> <span class="hljs-operator">=</span> StatementType.valueOf(context.getStringAttribute(<span class="hljs-string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));<br>    <span class="hljs-type">ResultSetType</span> <span class="hljs-variable">resultSetTypeEnum</span> <span class="hljs-operator">=</span> resolveResultSetType(resultSetType);<br><br>    <span class="hljs-comment">// è·å–å‘½ä»¤ç±»å‹(select|insert|update|delete)</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">nodeName</span> <span class="hljs-operator">=</span> context.getNode().getNodeName();<br>    <span class="hljs-type">SqlCommandType</span> <span class="hljs-variable">sqlCommandType</span> <span class="hljs-operator">=</span> SqlCommandType.valueOf(nodeName.toUpperCase(Locale.ENGLISH));<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSelect</span> <span class="hljs-operator">=</span> sqlCommandType == SqlCommandType.SELECT;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">flushCache</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;flushCache&quot;</span>, !isSelect);<br>    <span class="hljs-comment">// æ˜¯å¦è¦ç¼“å­˜selectç»“æœ,é»˜è®¤ç¼“å­˜</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">useCache</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;useCache&quot;</span>, isSelect);<br>    <span class="hljs-comment">// ä»…é’ˆå¯¹åµŒå¥—ç»“æœ select è¯­å¥é€‚ç”¨ï¼šå¦‚æœä¸º trueï¼Œå°±æ˜¯å‡è®¾åŒ…å«äº†åµŒå¥—ç»“æœé›†æˆ–æ˜¯åˆ†ç»„äº†ï¼Œè¿™æ ·çš„è¯å½“è¿”å›ä¸€ä¸ªä¸»ç»“æœè¡Œçš„æ—¶å€™ï¼Œå°±ä¸ä¼šå‘ç”Ÿæœ‰å¯¹å‰é¢ç»“æœé›†çš„å¼•ç”¨çš„æƒ…å†µã€‚</span><br>    <span class="hljs-comment">// è¿™å°±ä½¿å¾—åœ¨è·å–åµŒå¥—çš„ç»“æœé›†çš„æ—¶å€™ä¸è‡³äºå¯¼è‡´å†…å­˜ä¸å¤Ÿç”¨ã€‚é»˜è®¤å€¼ï¼šfalseã€‚</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">resultOrdered</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;resultOrdered&quot;</span>, <span class="hljs-literal">false</span>);<br><br>    <span class="hljs-comment">// Include Fragments before parsing</span><br>    <span class="hljs-comment">// è§£æä¹‹å‰å…ˆè§£æ&lt;include&gt;SQLç‰‡æ®µ</span><br>    <span class="hljs-type">XMLIncludeTransformer</span> <span class="hljs-variable">includeParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLIncludeTransformer</span>(configuration, builderAssistant);<br>    includeParser.applyIncludes(context.getNode());<br><br>    <span class="hljs-comment">// Parse selectKey after includes and remove them.</span><br>    <span class="hljs-comment">// è§£æä¹‹å‰å…ˆè§£æ&lt;selectKey&gt;</span><br>    processSelectKeyNodes(id, parameterTypeClass, langDriver);<br><br>    <span class="hljs-comment">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)</span><br>    <span class="hljs-comment">// è§£ææˆSqlSourceï¼Œä¸€èˆ¬æ˜¯DynamicSqlSource</span><br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> langDriver.createSqlSource(configuration, context, parameterTypeClass);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultSets</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultSets&quot;</span>);<br>    <span class="hljs-comment">// (ä»…å¯¹ insert æœ‰ç”¨) æ ‡è®°ä¸€ä¸ªå±æ€§, MyBatis ä¼šé€šè¿‡ getGeneratedKeys æˆ–è€…é€šè¿‡ insert è¯­å¥çš„ selectKey å­å…ƒç´ è®¾ç½®å®ƒçš„å€¼</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyProperty</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;keyProperty&quot;</span>);<br>    <span class="hljs-comment">// (ä»…å¯¹ insert æœ‰ç”¨) æ ‡è®°ä¸€ä¸ªå±æ€§, MyBatis ä¼šé€šè¿‡ getGeneratedKeys æˆ–è€…é€šè¿‡ insert è¯­å¥çš„ selectKey å­å…ƒç´ è®¾ç½®å®ƒçš„å€¼</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyColumn</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;keyColumn&quot;</span>);<br>    KeyGenerator keyGenerator;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyStatementId</span> <span class="hljs-operator">=</span> id + SelectKeyGenerator.SELECT_KEY_SUFFIX;<br>    keyStatementId = builderAssistant.applyCurrentNamespace(keyStatementId, <span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">if</span> (configuration.hasKeyGenerator(keyStatementId)) &#123;<br>      keyGenerator = configuration.getKeyGenerator(keyStatementId);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      keyGenerator = context.getBooleanAttribute(<span class="hljs-string">&quot;useGeneratedKeys&quot;</span>,<br>          configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType))<br>          ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jdbc3KeyGenerator</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// åˆå»è°ƒåŠ©æ‰‹ç±»</span><br>    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,<br>        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,<br>        resultSetTypeEnum, flushCache, useCache, resultOrdered, <br>        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, resultSets);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">databaseIdMatchesCurrent</span><span class="hljs-params">(String id, String databaseId, String requiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">if</span> (requiredDatabaseId != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!requiredDatabaseId.equals(databaseId)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (databaseId != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>      <span class="hljs-comment">// skip this statement if there is a previous one with a not null databaseId</span><br>      id = builderAssistant.applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.configuration.hasStatement(id, <span class="hljs-literal">false</span>)) &#123;<br>        <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">previous</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.configuration.getMappedStatement(id, <span class="hljs-literal">false</span>); <span class="hljs-comment">// issue #2</span><br>        <span class="hljs-keyword">if</span> (previous.getDatabaseId() != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// å–å¾—è¯­è¨€é©±åŠ¨</span><br>  <span class="hljs-keyword">private</span> LanguageDriver <span class="hljs-title function_">getLanguageDriver</span><span class="hljs-params">(String lang)</span> &#123;<br>    Class&lt;?&gt; langClass = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (lang != <span class="hljs-literal">null</span>) &#123;<br>      langClass = resolveClass(lang);<br>    &#125;<br>    <span class="hljs-comment">// è°ƒç”¨builderAssistant</span><br>    <span class="hljs-keyword">return</span> builderAssistant.getLanguageDriver(langClass);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSelectKeyNodes</span><span class="hljs-params">(String id, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver)</span> &#123;<br>    List&lt;XNode&gt; selectKeyNodes = context.evalNodes(<span class="hljs-string">&quot;selectKey&quot;</span>);<br>    <span class="hljs-keyword">if</span> (configuration.getDatabaseId() != <span class="hljs-literal">null</span>) &#123;<br>      parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, configuration.getDatabaseId());<br>    &#125;<br>    parseSelectKeyNodes(id, selectKeyNodes, parameterTypeClass, langDriver, <span class="hljs-literal">null</span>);<br>    removeSelectKeyNodes(selectKeyNodes);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseSelectKeyNodes</span><span class="hljs-params">(String parentId, List&lt;XNode&gt; list, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver, String skRequiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">for</span> (XNode nodeToHandle : list) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> parentId + SelectKeyGenerator.SELECT_KEY_SUFFIX;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">databaseId</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>);<br>      <span class="hljs-keyword">if</span> (databaseIdMatchesCurrent(id, databaseId, skRequiredDatabaseId)) &#123;<br>        parseSelectKeyNode(id, nodeToHandle, parameterTypeClass, langDriver, databaseId);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseSelectKeyNode</span><span class="hljs-params">(String id, XNode nodeToHandle, Class&lt;?&gt; parameterTypeClass, LanguageDriver langDriver, String databaseId)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultType</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;resultType&quot;</span>);<br>    Class&lt;?&gt; resultTypeClass = resolveClass(resultType);<br>    <span class="hljs-type">StatementType</span> <span class="hljs-variable">statementType</span> <span class="hljs-operator">=</span> StatementType.valueOf(nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;statementType&quot;</span>, StatementType.PREPARED.toString()));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyProperty</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;keyProperty&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyColumn</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;keyColumn&quot;</span>);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">executeBefore</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;BEFORE&quot;</span>.equals(nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;order&quot;</span>, <span class="hljs-string">&quot;AFTER&quot;</span>));<br><br>    <span class="hljs-comment">// defaults</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">useCache</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">resultOrdered</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">flushCache</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">parameterMap</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">ResultSetType</span> <span class="hljs-variable">resultSetTypeEnum</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> langDriver.createSqlSource(configuration, nodeToHandle, parameterTypeClass);<br>    <span class="hljs-type">SqlCommandType</span> <span class="hljs-variable">sqlCommandType</span> <span class="hljs-operator">=</span> SqlCommandType.SELECT;<br><br>    <span class="hljs-comment">// è¿™é‡Œç”Ÿæˆçš„MappedStatementç”¨äºè®¾ç½® KeyGenerator</span><br>    builderAssistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType,<br>        fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass,<br>        resultSetTypeEnum, flushCache, useCache, resultOrdered,<br>        keyGenerator, keyProperty, keyColumn, databaseId, langDriver, <span class="hljs-literal">null</span>);<br><br>    id = builderAssistant.applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br><br>    <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">keyStatement</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(id, <span class="hljs-literal">false</span>);<br>    configuration.addKeyGenerator(id, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SelectKeyGenerator</span>(keyStatement, executeBefore));<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeSelectKeyNodes</span><span class="hljs-params">(List&lt;XNode&gt; selectKeyNodes)</span> &#123;<br>    <span class="hljs-keyword">for</span> (XNode nodeToHandle : selectKeyNodes) &#123;<br>      nodeToHandle.getParent().getNode().removeChild(nodeToHandle.getNode());<br>    &#125;<br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="XMLMapperBuilder"><a href="#XMLMapperBuilder" class="headerlink" title="XMLMapperBuilder"></a>XMLMapperBuilder</h4><p>Â Â Â Â XMLæ˜ å°„æ„å»ºå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLMapperBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-keyword">private</span> XPathParser parser;<br>  <span class="hljs-comment">// æ˜ å°„å™¨æ„å»ºåŠ©æ‰‹</span><br>  <span class="hljs-keyword">private</span> MapperBuilderAssistant builderAssistant;<br>  <span class="hljs-comment">// ç”¨æ¥å­˜æ”¾sqlç‰‡æ®µçš„å“ˆå¸Œè¡¨</span><br>  <span class="hljs-keyword">private</span> Map&lt;String, XNode&gt; sqlFragments;<br>  <span class="hljs-keyword">private</span> String resource; <br><br>  <span class="hljs-meta">@Deprecated</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLMapperBuilder</span><span class="hljs-params">(Reader reader, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments, String namespace)</span> &#123;<br>    <span class="hljs-built_in">this</span>(reader, configuration, resource, sqlFragments);<br>    <span class="hljs-built_in">this</span>.builderAssistant.setCurrentNamespace(namespace);<br>  &#125;<br><br>  <span class="hljs-meta">@Deprecated</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLMapperBuilder</span><span class="hljs-params">(Reader reader, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments)</span> &#123;<br>    <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XPathParser</span>(reader, <span class="hljs-literal">true</span>, configuration.getVariables(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperEntityResolver</span>()),<br>        configuration, resource, sqlFragments);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLMapperBuilder</span><span class="hljs-params">(InputStream inputStream, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments, String namespace)</span> &#123;<br>    <span class="hljs-built_in">this</span>(inputStream, configuration, resource, sqlFragments);<br>    <span class="hljs-built_in">this</span>.builderAssistant.setCurrentNamespace(namespace);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLMapperBuilder</span><span class="hljs-params">(InputStream inputStream, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments)</span> &#123;<br>    <span class="hljs-built_in">this</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XPathParser</span>(inputStream, <span class="hljs-literal">true</span>, configuration.getVariables(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperEntityResolver</span>()),<br>        configuration, resource, sqlFragments);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">XMLMapperBuilder</span><span class="hljs-params">(XPathParser parser, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration);<br>    <span class="hljs-built_in">this</span>.builderAssistant = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperBuilderAssistant</span>(configuration, resource);<br>    <span class="hljs-built_in">this</span>.parser = parser;<br>    <span class="hljs-built_in">this</span>.sqlFragments = sqlFragments;<br>    <span class="hljs-built_in">this</span>.resource = resource;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æ</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰åŠ è½½è¿‡å†åŠ è½½ï¼Œé˜²æ­¢é‡å¤åŠ è½½</span><br>    <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;<br>      <span class="hljs-comment">// é…ç½®mapper</span><br>      configurationElement(parser.evalNode(<span class="hljs-string">&quot;/mapper&quot;</span>));<br>      <span class="hljs-comment">// æ ‡è®°ä¸€ä¸‹ï¼Œå·²ç»åŠ è½½è¿‡äº†</span><br>      configuration.addLoadedResource(resource);<br>      <span class="hljs-comment">// ç»‘å®šæ˜ å°„å™¨åˆ°namespace</span><br>      bindMapperForNamespace();<br>    &#125;<br><br>    <span class="hljs-comment">// è¿˜æœ‰æ²¡è§£æå®Œçš„ä¸œä¸œè¿™é‡Œæ¥ç€è§£æï¼Ÿ  </span><br>    parsePendingResultMaps();<br>    parsePendingChacheRefs();<br>    parsePendingStatements();<br>  &#125; <br><br>  <span class="hljs-comment">// é…ç½®mapperå…ƒç´ </span><br>  <span class="hljs-comment">//    &lt;mapper namespace=&quot;org.mybatis.example.BlogMapper&quot;&gt;</span><br>  <span class="hljs-comment">//      &lt;select id=&quot;selectBlog&quot; parameterType=&quot;int&quot; resultType=&quot;Blog&quot;&gt;</span><br>  <span class="hljs-comment">//        select * from Blog where id = #&#123;id&#125;</span><br>  <span class="hljs-comment">//      &lt;/select&gt;</span><br>  <span class="hljs-comment">//    &lt;/mapper&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configurationElement</span><span class="hljs-params">(XNode context)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// 1.é…ç½®namespace</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>);<br>      <span class="hljs-keyword">if</span> (namespace.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Mapper&#x27;s namespace cannot be empty&quot;</span>);<br>      &#125;<br>      builderAssistant.setCurrentNamespace(namespace);<br>      <span class="hljs-comment">// 2.é…ç½®cache-ref</span><br>      cacheRefElement(context.evalNode(<span class="hljs-string">&quot;cache-ref&quot;</span>));<br>      <span class="hljs-comment">// 3.é…ç½®cache</span><br>      cacheElement(context.evalNode(<span class="hljs-string">&quot;cache&quot;</span>));<br>      <span class="hljs-comment">// 4.é…ç½®parameterMap(å·²ç»åºŸå¼ƒ,è€å¼é£æ ¼çš„å‚æ•°æ˜ å°„)</span><br>      parameterMapElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/parameterMap&quot;</span>));<br>      <span class="hljs-comment">// 5.é…ç½®resultMap(é«˜çº§åŠŸèƒ½)</span><br>      resultMapElements(context.evalNodes(<span class="hljs-string">&quot;/mapper/resultMap&quot;</span>));<br>      <span class="hljs-comment">// 6.é…ç½®sql(å®šä¹‰å¯é‡ç”¨çš„ SQL ä»£ç æ®µ)</span><br>      sqlElement(context.evalNodes(<span class="hljs-string">&quot;/mapper/sql&quot;</span>));<br>      <span class="hljs-comment">// 7.é…ç½®select|insert|update|delete TODO</span><br>      buildStatementFromContext(context.evalNodes(<span class="hljs-string">&quot;select|insert|update|delete&quot;</span>));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error parsing Mapper XML. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//2.é…ç½®cache-ref,åœ¨è¿™æ ·çš„ æƒ…å†µä¸‹ä½ å¯ä»¥ä½¿ç”¨ cache-ref å…ƒç´ æ¥å¼•ç”¨å¦å¤–ä¸€ä¸ªç¼“å­˜ã€‚ </span><br>  <span class="hljs-comment">//&lt;cache-ref namespace=&quot;com.someone.application.data.SomeMapper&quot;/&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacheRefElement</span><span class="hljs-params">(XNode context)</span> &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// å¢åŠ cache-ref</span><br>      configuration.addCacheRef(builderAssistant.getCurrentNamespace(), context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>));<br>      <span class="hljs-type">CacheRefResolver</span> <span class="hljs-variable">cacheRefResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheRefResolver</span>(builderAssistant, context.getStringAttribute(<span class="hljs-string">&quot;namespace&quot;</span>));<br>      <span class="hljs-keyword">try</span> &#123;<br>        cacheRefResolver.resolveCacheRef();<br>      &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>        configuration.addIncompleteCacheRef(cacheRefResolver);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//3.é…ç½®cache</span><br>  <span class="hljs-comment">//  &lt;cache</span><br>  <span class="hljs-comment">//  eviction=&quot;FIFO&quot;</span><br>  <span class="hljs-comment">//  flushInterval=&quot;60000&quot;</span><br>  <span class="hljs-comment">//  size=&quot;512&quot;</span><br>  <span class="hljs-comment">//  readOnly=&quot;true&quot;/&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacheElement</span><span class="hljs-params">(XNode context)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (context != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>, <span class="hljs-string">&quot;PERPETUAL&quot;</span>);<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; typeClass = typeAliasRegistry.resolveAlias(type);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">eviction</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;eviction&quot;</span>, <span class="hljs-string">&quot;LRU&quot;</span>);<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; evictionClass = typeAliasRegistry.resolveAlias(eviction);<br>      <span class="hljs-type">Long</span> <span class="hljs-variable">flushInterval</span> <span class="hljs-operator">=</span> context.getLongAttribute(<span class="hljs-string">&quot;flushInterval&quot;</span>);<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> context.getIntAttribute(<span class="hljs-string">&quot;size&quot;</span>);<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">readWrite</span> <span class="hljs-operator">=</span> !context.getBooleanAttribute(<span class="hljs-string">&quot;readOnly&quot;</span>, <span class="hljs-literal">false</span>);<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">blocking</span> <span class="hljs-operator">=</span> context.getBooleanAttribute(<span class="hljs-string">&quot;blocking&quot;</span>, <span class="hljs-literal">false</span>);<br>      <span class="hljs-comment">// è¯»å…¥é¢å¤–çš„é…ç½®ä¿¡æ¯ï¼Œæ˜“äºç¬¬ä¸‰æ–¹çš„ç¼“å­˜æ‰©å±•,ä¾‹:</span><br><span class="hljs-comment">//    &lt;cache type=&quot;com.domain.something.MyCustomCache&quot;&gt;</span><br><span class="hljs-comment">//      &lt;property name=&quot;cacheFile&quot; value=&quot;/tmp/my-custom-cache.tmp&quot;/&gt;</span><br><span class="hljs-comment">//    &lt;/cache&gt;</span><br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> context.getChildrenAsProperties();<br>      <span class="hljs-comment">// è°ƒç”¨builderAssistant.useNewCache</span><br>      builderAssistant.useNewCache(typeClass, evictionClass, flushInterval, size, readWrite, blocking, props);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//4.é…ç½®parameterMap</span><br>  <span class="hljs-comment">//å·²ç»è¢«åºŸå¼ƒäº†!è€å¼é£æ ¼çš„å‚æ•°æ˜ å°„ã€‚å¯ä»¥å¿½ç•¥</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parameterMapElement</span><span class="hljs-params">(List&lt;XNode&gt; list)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">for</span> (XNode parameterMapNode : list) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> parameterMapNode.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> parameterMapNode.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>);<br>      Class&lt;?&gt; parameterClass = resolveClass(type);<br>      List&lt;XNode&gt; parameterNodes = parameterMapNode.evalNodes(<span class="hljs-string">&quot;parameter&quot;</span>);<br>      List&lt;ParameterMapping&gt; parameterMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ParameterMapping&gt;();<br>      <span class="hljs-keyword">for</span> (XNode parameterNode : parameterNodes) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;property&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">javaType</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;jdbcType&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mode</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;mode&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">typeHandler</span> <span class="hljs-operator">=</span> parameterNode.getStringAttribute(<span class="hljs-string">&quot;typeHandler&quot;</span>);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">numericScale</span> <span class="hljs-operator">=</span> parameterNode.getIntAttribute(<span class="hljs-string">&quot;numericScale&quot;</span>);<br>        <span class="hljs-type">ParameterMode</span> <span class="hljs-variable">modeEnum</span> <span class="hljs-operator">=</span> resolveParameterMode(mode);<br>        Class&lt;?&gt; javaTypeClass = resolveClass(javaType);<br>        <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcTypeEnum</span> <span class="hljs-operator">=</span> resolveJdbcType(jdbcType);<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt;) resolveClass(typeHandler);<br>        <span class="hljs-type">ParameterMapping</span> <span class="hljs-variable">parameterMapping</span> <span class="hljs-operator">=</span> builderAssistant.buildParameterMapping(parameterClass, property, javaTypeClass, jdbcTypeEnum, resultMap, modeEnum, typeHandlerClass, numericScale);<br>        parameterMappings.add(parameterMapping);<br>      &#125;<br>      builderAssistant.addParameterMap(id, parameterClass, parameterMappings);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//5.é…ç½®resultMap,é«˜çº§åŠŸèƒ½</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resultMapElements</span><span class="hljs-params">(List&lt;XNode&gt; list)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// åŸºæœ¬ä¸Šå°±æ˜¯å¾ªç¯æŠŠresultMapåŠ å…¥åˆ°Configurationé‡Œå»,ä¿æŒ2ä»½ï¼Œä¸€ä»½ç¼©ç•¥ï¼Œä¸€åˆ†å…¨å</span><br>    <span class="hljs-keyword">for</span> (XNode resultMapNode : list) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// å¾ªç¯è°ƒresultMapElement</span><br>        resultMapElement(resultMapNode);<br>      &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>        <span class="hljs-comment">// ignore, it will be retried</span><br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//5.1 é…ç½®resultMap</span><br>  <span class="hljs-keyword">private</span> ResultMap <span class="hljs-title function_">resultMapElement</span><span class="hljs-params">(XNode resultMapNode)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">return</span> resultMapElement(resultMapNode, Collections.&lt;ResultMapping&gt; emptyList());<br>  &#125; <br><br>  <span class="hljs-comment">//5.1 é…ç½®resultMap</span><br>  <span class="hljs-keyword">private</span> ResultMap <span class="hljs-title function_">resultMapElement</span><span class="hljs-params">(XNode resultMapNode, List&lt;ResultMapping&gt; additionalResultMappings)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">//é”™è¯¯ä¸Šä¸‹æ–‡</span><br>    <span class="hljs-comment">//å–å¾—æ ‡ç¤ºç¬¦   (&quot;resultMap[userResultMap]&quot;)</span><br>    <span class="hljs-comment">//    &lt;resultMap id=&quot;userResultMap&quot; type=&quot;User&quot;&gt;</span><br>    <span class="hljs-comment">//      &lt;id property=&quot;id&quot; column=&quot;user_id&quot; /&gt;</span><br>    <span class="hljs-comment">//      &lt;result property=&quot;username&quot; column=&quot;username&quot;/&gt;</span><br>    <span class="hljs-comment">//      &lt;result property=&quot;password&quot; column=&quot;password&quot;/&gt;</span><br>    <span class="hljs-comment">//    &lt;/resultMap&gt;</span><br>    ErrorContext.instance().activity(<span class="hljs-string">&quot;processing &quot;</span> + resultMapNode.getValueBasedIdentifier());<br>    <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> resultMapNode.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>,<br>        resultMapNode.getValueBasedIdentifier());<br>    <span class="hljs-comment">//ä¸€èˆ¬æ‹¿typeå°±å¯ä»¥äº†ï¼Œåé¢3ä¸ªåº”è¯¥æ˜¯æ˜¯å…¼å®¹è€çš„ä»£ç </span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> resultMapNode.getStringAttribute(<span class="hljs-string">&quot;type&quot;</span>,<br>        resultMapNode.getStringAttribute(<span class="hljs-string">&quot;ofType&quot;</span>,<br>            resultMapNode.getStringAttribute(<span class="hljs-string">&quot;resultType&quot;</span>,<br>                resultMapNode.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>))));<br>    <span class="hljs-comment">//é«˜çº§åŠŸèƒ½ï¼Œè¿˜æ”¯æŒç»§æ‰¿?</span><br>    <span class="hljs-comment">//  &lt;resultMap id=&quot;carResult&quot; type=&quot;Car&quot; extends=&quot;vehicleResult&quot;&gt;</span><br>    <span class="hljs-comment">//    &lt;result property=&quot;doorCount&quot; column=&quot;door_count&quot; /&gt;</span><br>    <span class="hljs-comment">//  &lt;/resultMap&gt;</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">extend</span> <span class="hljs-operator">=</span> resultMapNode.getStringAttribute(<span class="hljs-string">&quot;extends&quot;</span>);<br>    <span class="hljs-comment">//autoMapping</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">autoMapping</span> <span class="hljs-operator">=</span> resultMapNode.getBooleanAttribute(<span class="hljs-string">&quot;autoMapping&quot;</span>);<br>    Class&lt;?&gt; typeClass = resolveClass(type);<br>    <span class="hljs-type">Discriminator</span> <span class="hljs-variable">discriminator</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    List&lt;ResultMapping&gt; resultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>    resultMappings.addAll(additionalResultMappings);<br>    List&lt;XNode&gt; resultChildren = resultMapNode.getChildren();<br>    <span class="hljs-keyword">for</span> (XNode resultChild : resultChildren) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;constructor&quot;</span>.equals(resultChild.getName())) &#123;<br>        <span class="hljs-comment">// è§£æresult mapçš„constructor</span><br>        processConstructorElement(resultChild, typeClass, resultMappings);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;discriminator&quot;</span>.equals(resultChild.getName())) &#123;<br>        <span class="hljs-comment">// è§£æresult mapçš„discriminator</span><br>        discriminator = processDiscriminatorElement(resultChild, typeClass, resultMappings);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        List&lt;ResultFlag&gt; flags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;id&quot;</span>.equals(resultChild.getName())) &#123;<br>          flags.add(ResultFlag.ID);<br>        &#125;<br>        <span class="hljs-comment">// è°ƒ5.1.1 buildResultMappingFromContext,å¾—åˆ°ResultMapping</span><br>        resultMappings.add(buildResultMappingFromContext(resultChild, typeClass, flags));<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">//æœ€åå†è°ƒResultMapResolverå¾—åˆ°ResultMap</span><br>    <span class="hljs-type">ResultMapResolver</span> <span class="hljs-variable">resultMapResolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMapResolver</span>(builderAssistant, id, typeClass, extend, discriminator, resultMappings, autoMapping);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> resultMapResolver.resolve();<br>    &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException  e) &#123;<br>      configuration.addIncompleteResultMap(resultMapResolver);<br>      <span class="hljs-keyword">throw</span> e;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">//è§£æresult mapçš„constructor</span><br>  <span class="hljs-comment">//&lt;constructor&gt;</span><br>  <span class="hljs-comment">//  &lt;idArg column=&quot;blog_id&quot; javaType=&quot;int&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/constructor&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processConstructorElement</span><span class="hljs-params">(XNode resultChild, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    List&lt;XNode&gt; argChildren = resultChild.getChildren();<br>    <span class="hljs-keyword">for</span> (XNode argChild : argChildren) &#123;<br>      List&lt;ResultFlag&gt; flags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;();<br>      <span class="hljs-comment">// ç»“æœæ ‡å¿—åŠ ä¸ŠIDå’ŒCONSTRUCTOR</span><br>      flags.add(ResultFlag.CONSTRUCTOR);<br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;idArg&quot;</span>.equals(argChild.getName())) &#123;<br>        flags.add(ResultFlag.ID);<br>      &#125;<br>      resultMappings.add(buildResultMappingFromContext(argChild, resultType, flags));<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 5.1.1 æ„å»ºresultMap</span><br>  <span class="hljs-keyword">private</span> ResultMapping <span class="hljs-title function_">buildResultMappingFromContext</span><span class="hljs-params">(XNode context, Class&lt;?&gt; resultType, List&lt;ResultFlag&gt; flags)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// &lt;id property=&quot;id&quot; column=&quot;author_id&quot;/&gt;</span><br>    <span class="hljs-comment">// &lt;result property=&quot;username&quot; column=&quot;author_username&quot;/&gt;</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;property&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;column&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">javaType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;jdbcType&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">nestedSelect</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;select&quot;</span>);<br>    <span class="hljs-comment">// å¤„ç†åµŒå¥—çš„result map</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">nestedResultMap</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>,<br>        processNestedResultMappings(context, Collections.&lt;ResultMapping&gt; emptyList()));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">notNullColumn</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;notNullColumn&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">columnPrefix</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;columnPrefix&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">typeHandler</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;typeHandler&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resulSet</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;resultSet&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">foreignColumn</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;foreignColumn&quot;</span>);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">lazy</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lazy&quot;</span>.equals(context.getStringAttribute(<span class="hljs-string">&quot;fetchType&quot;</span>, configuration.isLazyLoadingEnabled() ? <span class="hljs-string">&quot;lazy&quot;</span> : <span class="hljs-string">&quot;eager&quot;</span>));<br>    Class&lt;?&gt; javaTypeClass = resolveClass(javaType);<br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt;) resolveClass(typeHandler);<br>    <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcTypeEnum</span> <span class="hljs-operator">=</span> resolveJdbcType(jdbcType);<br>    <span class="hljs-comment">// åˆå»è°ƒbuilderAssistant.buildResultMapping</span><br>    <span class="hljs-keyword">return</span> builderAssistant.buildResultMapping(resultType, property, column, javaTypeClass, jdbcTypeEnum, nestedSelect, nestedResultMap, notNullColumn, columnPrefix, typeHandlerClass, flags, resulSet, foreignColumn, lazy);<br>  &#125; <br><br>  <span class="hljs-comment">//5.1.1.1 å¤„ç†åµŒå¥—çš„result map</span><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">processNestedResultMappings</span><span class="hljs-params">(XNode context, List&lt;ResultMapping&gt; resultMappings)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-comment">// å¤„ç†association|collection|case</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;association&quot;</span>.equals(context.getName())<br>        || <span class="hljs-string">&quot;collection&quot;</span>.equals(context.getName())<br>        || <span class="hljs-string">&quot;case&quot;</span>.equals(context.getName())) &#123;<br><br>      <span class="hljs-comment">//   &lt;resultMap id=&quot;blogResult&quot; type=&quot;Blog&quot;&gt;</span><br>      <span class="hljs-comment">//      &lt;association property=&quot;author&quot; column=&quot;author_id&quot; javaType=&quot;Author&quot; select=&quot;selectAuthor&quot;/&gt;</span><br>      <span class="hljs-comment">//   &lt;/resultMap&gt;</span><br>      <span class="hljs-comment">//å¦‚æœä¸æ˜¯åµŒå¥—æŸ¥è¯¢</span><br>      <span class="hljs-keyword">if</span> (context.getStringAttribute(<span class="hljs-string">&quot;select&quot;</span>) == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//åˆ™é€’å½’è°ƒç”¨5.1 resultMapElement</span><br>        <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> resultMapElement(context, resultMappings);<br>        <span class="hljs-keyword">return</span> resultMap.getId();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-comment">//è§£æresult mapçš„discriminator</span><br>  <span class="hljs-comment">//&lt;discriminator javaType=&quot;int&quot; column=&quot;draft&quot;&gt;</span><br>  <span class="hljs-comment">//  &lt;case value=&quot;1&quot; resultType=&quot;DraftPost&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/discriminator&gt;</span><br>  <span class="hljs-keyword">private</span> Discriminator <span class="hljs-title function_">processDiscriminatorElement</span><span class="hljs-params">(XNode context, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;column&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">javaType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;javaType&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;jdbcType&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">typeHandler</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;typeHandler&quot;</span>);<br>    Class&lt;?&gt; javaTypeClass = resolveClass(javaType);<br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandlerClass = (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt;) resolveClass(typeHandler);<br>    <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcTypeEnum</span> <span class="hljs-operator">=</span> resolveJdbcType(jdbcType);<br>    Map&lt;String, String&gt; discriminatorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br>    <span class="hljs-keyword">for</span> (XNode caseChild : context.getChildren()) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> caseChild.getStringAttribute(<span class="hljs-string">&quot;value&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> caseChild.getStringAttribute(<span class="hljs-string">&quot;resultMap&quot;</span>, processNestedResultMappings(caseChild, resultMappings));<br>      discriminatorMap.put(value, resultMap);<br>    &#125;<br>    <span class="hljs-keyword">return</span> builderAssistant.buildDiscriminator(resultType, column, javaTypeClass, jdbcTypeEnum, typeHandlerClass, discriminatorMap);<br>  &#125; <br><br>  <span class="hljs-comment">//6 é…ç½®sql(å®šä¹‰å¯é‡ç”¨çš„ SQL ä»£ç æ®µ)</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sqlElement</span><span class="hljs-params">(List&lt;XNode&gt; list)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">if</span> (configuration.getDatabaseId() != <span class="hljs-literal">null</span>) &#123;<br>      sqlElement(list, configuration.getDatabaseId());<br>    &#125;<br>    sqlElement(list, <span class="hljs-literal">null</span>);<br>  &#125; <br><br>  <span class="hljs-comment">//6.1 é…ç½®sql</span><br>  <span class="hljs-comment">//&lt;sql id=&quot;userColumns&quot;&gt; id,username,password &lt;/sql&gt;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sqlElement</span><span class="hljs-params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">for</span> (XNode context : list) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">databaseId</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> context.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>);<br>      id = builderAssistant.applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br>      <span class="hljs-comment">//æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†sqlç‰‡æ®µæ”¾å…¥hashmap,ä¸è¿‡æ­¤æ—¶è¿˜æ²¡æœ‰è§£æsqlç‰‡æ®µ</span><br>      <span class="hljs-keyword">if</span> (databaseIdMatchesCurrent(id, databaseId, requiredDatabaseId)) &#123;<br>        sqlFragments.put(id, context);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">databaseIdMatchesCurrent</span><span class="hljs-params">(String id, String databaseId, String requiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">if</span> (requiredDatabaseId != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!requiredDatabaseId.equals(databaseId)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (databaseId != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>      <span class="hljs-comment">// skip this fragment if there is a previous one with a not null databaseId</span><br>      <span class="hljs-comment">// å¦‚æœæœ‰é‡åçš„idäº†</span><br>      <span class="hljs-comment">// &lt;sql id=&quot;userColumns&quot;&gt; id,username,password &lt;/sql&gt;</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.sqlFragments.containsKey(id)) &#123;<br>        <span class="hljs-type">XNode</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.sqlFragments.get(id);<br>        <span class="hljs-comment">// å¦‚æœä¹‹å‰é‚£ä¸ªé‡åçš„sql idæœ‰databaseIdï¼Œåˆ™falseï¼Œå¦åˆ™éš¾é“trueï¼Ÿè¿™æ ·æ–°çš„sqlè¦†ç›–è€çš„sqlï¼Ÿï¼Ÿï¼Ÿ</span><br>        <span class="hljs-keyword">if</span> (context.getStringAttribute(<span class="hljs-string">&quot;databaseId&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// 7.é…ç½®select|insert|update|delete</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list)</span> &#123;<br>    <span class="hljs-comment">// è°ƒç”¨7.1æ„å»ºè¯­å¥</span><br>    <span class="hljs-keyword">if</span> (configuration.getDatabaseId() != <span class="hljs-literal">null</span>) &#123;<br>      buildStatementFromContext(list, configuration.getDatabaseId());<br>    &#125;<br>    buildStatementFromContext(list, <span class="hljs-literal">null</span>);<br>  &#125; <br><br>  <span class="hljs-comment">// 7.1æ„å»ºè¯­å¥</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">for</span> (XNode context : list) &#123;<br>      <span class="hljs-comment">// æ„å»ºæ‰€æœ‰è¯­å¥,ä¸€ä¸ªmapperä¸‹å¯ä»¥æœ‰å¾ˆå¤šselect</span><br>      <span class="hljs-comment">// è¯­å¥æ¯”è¾ƒå¤æ‚ï¼Œæ ¸å¿ƒéƒ½åœ¨è¿™é‡Œé¢ï¼Œæ‰€ä»¥è°ƒç”¨XMLStatementBuilder</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">XMLStatementBuilder</span> <span class="hljs-variable">statementParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLStatementBuilder</span>(configuration, builderAssistant, context, requiredDatabaseId);<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// æ ¸å¿ƒXMLStatementBuilder.parseStatementNode</span><br>        statementParser.parseStatementNode();<br>      &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>        <span class="hljs-comment">// å¦‚æœå‡ºç°SQLè¯­å¥ä¸å®Œæ•´ï¼ŒæŠŠå®ƒè®°ä¸‹æ¥ï¼Œå¡åˆ°configurationå»</span><br>        configuration.addIncompleteStatement(statementParser);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// 7.1æ„å»ºè¯­å¥</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildStatementFromContext</span><span class="hljs-params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;<br>    <span class="hljs-keyword">for</span> (XNode context : list) &#123;<br>      <span class="hljs-comment">// æ„å»ºæ‰€æœ‰è¯­å¥,ä¸€ä¸ªmapperä¸‹å¯ä»¥æœ‰å¾ˆå¤šselect</span><br>      <span class="hljs-comment">// è¯­å¥æ¯”è¾ƒå¤æ‚ï¼Œæ ¸å¿ƒéƒ½åœ¨è¿™é‡Œé¢ï¼Œæ‰€ä»¥è°ƒç”¨XMLStatementBuilder</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">XMLStatementBuilder</span> <span class="hljs-variable">statementParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLStatementBuilder</span>(configuration, builderAssistant, context, requiredDatabaseId);<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// æ ¸å¿ƒXMLStatementBuilder.parseStatementNode</span><br>        statementParser.parseStatementNode();<br>      &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>        <span class="hljs-comment">// å¦‚æœå‡ºç°SQLè¯­å¥ä¸å®Œæ•´ï¼ŒæŠŠå®ƒè®°ä¸‹æ¥ï¼Œå¡åˆ°configurationå»</span><br>        configuration.addIncompleteStatement(statementParser);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bindMapperForNamespace</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">namespace</span> <span class="hljs-operator">=</span> builderAssistant.getCurrentNamespace();<br>    <span class="hljs-keyword">if</span> (namespace != <span class="hljs-literal">null</span>) &#123;<br>      Class&lt;?&gt; boundType = <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        boundType = Resources.classForName(namespace);<br>      &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>        <span class="hljs-comment">//ignore, bound type is not required</span><br>      &#125;<br>      <span class="hljs-keyword">if</span> (boundType != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!configuration.hasMapper(boundType)) &#123;<br>          <span class="hljs-comment">// Spring may not know the real resource name so we set a flag</span><br>          <span class="hljs-comment">// to prevent loading again this resource from the mapper interface</span><br>          <span class="hljs-comment">// look at MapperAnnotationBuilder#loadXmlResource</span><br>          configuration.addLoadedResource(<span class="hljs-string">&quot;namespace:&quot;</span> + namespace);<br>          configuration.addMapper(boundType);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parsePendingResultMaps</span><span class="hljs-params">()</span> &#123;<br>    Collection&lt;ResultMapResolver&gt; incompleteResultMaps = configuration.getIncompleteResultMaps();<br>    <span class="hljs-keyword">synchronized</span> (incompleteResultMaps) &#123;<br>      Iterator&lt;ResultMapResolver&gt; iter = incompleteResultMaps.iterator();<br>      <span class="hljs-keyword">while</span> (iter.hasNext()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          iter.next().resolve();<br>          iter.remove();<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>          <span class="hljs-comment">// ResultMap is still missing a resource...</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parsePendingChacheRefs</span><span class="hljs-params">()</span> &#123;<br>    Collection&lt;CacheRefResolver&gt; incompleteCacheRefs = configuration.getIncompleteCacheRefs();<br>    <span class="hljs-keyword">synchronized</span> (incompleteCacheRefs) &#123;<br>      Iterator&lt;CacheRefResolver&gt; iter = incompleteCacheRefs.iterator();<br>      <span class="hljs-keyword">while</span> (iter.hasNext()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          iter.next().resolveCacheRef();<br>          iter.remove();<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>          <span class="hljs-comment">// Cache ref is still missing a resource...</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parsePendingStatements</span><span class="hljs-params">()</span> &#123;<br>    Collection&lt;XMLStatementBuilder&gt; incompleteStatements = configuration.getIncompleteStatements();<br>    <span class="hljs-keyword">synchronized</span> (incompleteStatements) &#123;<br>      Iterator&lt;XMLStatementBuilder&gt; iter = incompleteStatements.iterator();<br>      <span class="hljs-keyword">while</span> (iter.hasNext()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          iter.next().parseStatementNode();<br>          iter.remove();<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>          <span class="hljs-comment">// Statement is still missing a resource...</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ProviderSqlSource"><a href="#ProviderSqlSource" class="headerlink" title="ProviderSqlSource"></a>ProviderSqlSource</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProviderSqlSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSource</span> &#123; <br><br>  <span class="hljs-keyword">private</span> SqlSourceBuilder sqlSourceParser;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; providerType;<br>  <span class="hljs-keyword">private</span> Method providerMethod;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> providerTakesParameterObject; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ProviderSqlSource</span><span class="hljs-params">(Configuration config, Object provider)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">providerMethodName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-built_in">this</span>.sqlSourceParser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSourceBuilder</span>(config); <br>      <span class="hljs-comment">// sqlæºç æä¾›ç±»</span><br>      <span class="hljs-built_in">this</span>.providerType = (Class&lt;?&gt;) provider.getClass().getMethod(<span class="hljs-string">&quot;type&quot;</span>).invoke(provider);<br>      <span class="hljs-comment">// sqlæºç æä¾›ç±»å…·ä½“æä¾›sqlæºç çš„å‡½æ•°å</span><br>      providerMethodName = (String) provider.getClass().getMethod(<span class="hljs-string">&quot;method&quot;</span>).invoke(provider);<br><br>      <span class="hljs-keyword">for</span> (Method m : <span class="hljs-built_in">this</span>.providerType.getMethods()) &#123;<br>        <span class="hljs-keyword">if</span> (providerMethodName.equals(m.getName())) &#123;<br>          <span class="hljs-keyword">if</span> (m.getParameterTypes().length &lt; <span class="hljs-number">2</span><br>              &amp;&amp; m.getReturnType() == String.class) &#123;<br>            <span class="hljs-built_in">this</span>.providerMethod = m;<br>            <span class="hljs-built_in">this</span>.providerTakesParameterObject = m.getParameterTypes().length == <span class="hljs-number">1</span>;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error creating SqlSource for SqlProvider.  Cause: &quot;</span> + e, e);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.providerMethod == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error creating SqlSource for SqlProvider. Method &#x27;&quot;</span><br>          + providerMethodName + <span class="hljs-string">&quot;&#x27; not found in SqlProvider &#x27;&quot;</span> + <span class="hljs-built_in">this</span>.providerType.getName() + <span class="hljs-string">&quot;&#x27;.&quot;</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">(Object parameterObject)</span> &#123;<br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> createSqlSource(parameterObject);<br>    <span class="hljs-keyword">return</span> sqlSource.getBoundSql(parameterObject);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> SqlSource <span class="hljs-title function_">createSqlSource</span><span class="hljs-params">(Object parameterObject)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      String sql;<br>      <span class="hljs-keyword">if</span> (providerTakesParameterObject) &#123;<br>        sql = (String) providerMethod.invoke(providerType.newInstance(), parameterObject);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        sql = (String) providerMethod.invoke(providerType.newInstance());<br>      &#125;<br>      Class&lt;?&gt; parameterType = parameterObject == <span class="hljs-literal">null</span> ? Object.class : parameterObject.getClass();<br>      <span class="hljs-keyword">return</span> sqlSourceParser.parse(sql, parameterType, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;());<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error invoking SqlProvider method (&quot;</span><br>          + providerType.getName() + <span class="hljs-string">&quot;.&quot;</span> + providerMethod.getName()<br>          + <span class="hljs-string">&quot;).  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MapperAnnotationBuilder"><a href="#MapperAnnotationBuilder" class="headerlink" title="MapperAnnotationBuilder"></a>MapperAnnotationBuilder</h4><p>Â Â Â Â æ³¨è§£æ–¹å¼æ„å»ºmapperï¼Œä¸€èˆ¬ä¸ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperAnnotationBuilder</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt; sqlAnnotationTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt; sqlProviderAnnotationTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt;(); <br><br>  <span class="hljs-keyword">private</span> Configuration configuration;<br>  <span class="hljs-keyword">private</span> MapperBuilderAssistant assistant;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; type; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperAnnotationBuilder</span><span class="hljs-params">(Configuration configuration, Class&lt;?&gt; type)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> type.getName().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>) + <span class="hljs-string">&quot;.java (best guess)&quot;</span>;<br>    <span class="hljs-built_in">this</span>.assistant = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperBuilderAssistant</span>(configuration, resource);<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.type = type;<br><br>    sqlAnnotationTypes.add(Select.class);<br>    sqlAnnotationTypes.add(Insert.class);<br>    sqlAnnotationTypes.add(Update.class);<br>    sqlAnnotationTypes.add(Delete.class);<br><br>    sqlProviderAnnotationTypes.add(SelectProvider.class);<br>    sqlProviderAnnotationTypes.add(InsertProvider.class);<br>    sqlProviderAnnotationTypes.add(UpdateProvider.class);<br>    sqlProviderAnnotationTypes.add(DeleteProvider.class);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> type.toString();<br>    <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123; <br>      <span class="hljs-comment">// åŠ è½½å¯¹åº”çš„xmlæ–‡ä»¶</span><br>      loadXmlResource();<br>      configuration.addLoadedResource(resource);<br>      assistant.setCurrentNamespace(type.getName());<br>      parseCache();<br>      parseCacheRef();<br>      Method[] methods = type.getMethods();<br>      <span class="hljs-keyword">for</span> (Method method : methods) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">// issue #237</span><br>          <span class="hljs-keyword">if</span> (!method.isBridge()) &#123;<br>            parseStatement(method);<br>          &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>          configuration.addIncompleteMethod(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodResolver</span>(<span class="hljs-built_in">this</span>, method));<br>        &#125;<br>      &#125;<br>    &#125;<br>    parsePendingMethods();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadXmlResource</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Spring may not know the real resource name so we check a flag</span><br>    <span class="hljs-comment">// to prevent loading again a resource twice</span><br>    <span class="hljs-comment">// this flag is set at XMLMapperBuilder#bindMapperForNamespace</span><br>    <span class="hljs-keyword">if</span> (!configuration.isResourceLoaded(<span class="hljs-string">&quot;namespace:&quot;</span> + type.getName())) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">xmlResource</span> <span class="hljs-operator">=</span> type.getName().replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>) + <span class="hljs-string">&quot;.xml&quot;</span>;<br>      <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>        inputStream = Resources.getResourceAsStream(type.getClassLoader(), xmlResource);<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-comment">// ignore, resource is not required</span><br>      &#125;<br>      <span class="hljs-keyword">if</span> (inputStream != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">XMLMapperBuilder</span> <span class="hljs-variable">xmlParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperBuilder</span>(inputStream, assistant.getConfiguration(), xmlResource, configuration.getSqlFragments(), type.getName());<br>        xmlParser.parse();<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// CacheNamespace å®šä¹‰çš„æ“ä½œä¼šè¦†ç›–xmlæ–‡ä»¶ä¸­çš„ç›¸åŒæ“ä½œ</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseCache</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">CacheNamespace</span> <span class="hljs-variable">cacheDomain</span> <span class="hljs-operator">=</span> type.getAnnotation(CacheNamespace.class);<br>    <span class="hljs-keyword">if</span> (cacheDomain != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> cacheDomain.size() == <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : cacheDomain.size();<br>      <span class="hljs-type">Long</span> <span class="hljs-variable">flushInterval</span> <span class="hljs-operator">=</span> cacheDomain.flushInterval() == <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : cacheDomain.flushInterval();<br>      assistant.useNewCache(cacheDomain.implementation(), cacheDomain.eviction(), flushInterval, size, cacheDomain.readWrite(), cacheDomain.blocking(), <span class="hljs-literal">null</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseCacheRef</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">CacheNamespaceRef</span> <span class="hljs-variable">cacheDomainRef</span> <span class="hljs-operator">=</span> type.getAnnotation(CacheNamespaceRef.class);<br>    <span class="hljs-keyword">if</span> (cacheDomainRef != <span class="hljs-literal">null</span>) &#123;<br>      assistant.useCacheRef(cacheDomainRef.value().getName());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseStatement</span><span class="hljs-params">(Method method)</span> &#123;<br>    Class&lt;?&gt; parameterTypeClass = getParameterType(method);<br>    <span class="hljs-type">LanguageDriver</span> <span class="hljs-variable">languageDriver</span> <span class="hljs-operator">=</span> getLanguageDriver(method);<br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> getSqlSourceFromAnnotations(method, parameterTypeClass, languageDriver);<br>    <span class="hljs-keyword">if</span> (sqlSource != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Options</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> method.getAnnotation(Options.class);<br>      <span class="hljs-comment">// mappedStatementId ç”± ç±»å.æ–¹æ³•å ç»„æˆ</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">mappedStatementId</span> <span class="hljs-operator">=</span> type.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName();<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-type">StatementType</span> <span class="hljs-variable">statementType</span> <span class="hljs-operator">=</span> StatementType.PREPARED;<br>      <span class="hljs-type">ResultSetType</span> <span class="hljs-variable">resultSetType</span> <span class="hljs-operator">=</span> ResultSetType.FORWARD_ONLY;<br>      <span class="hljs-comment">// è·å– sql ç±»å‹</span><br>      <span class="hljs-type">SqlCommandType</span> <span class="hljs-variable">sqlCommandType</span> <span class="hljs-operator">=</span> getSqlCommandType(method);<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">isSelect</span> <span class="hljs-operator">=</span> sqlCommandType == SqlCommandType.SELECT;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">flushCache</span> <span class="hljs-operator">=</span> !isSelect;<br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">useCache</span> <span class="hljs-operator">=</span> isSelect;<br><br>      KeyGenerator keyGenerator;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">keyProperty</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;id&quot;</span>;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">keyColumn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>; <br>      <span class="hljs-comment">// INSERT æˆ–è€… UPDATE æ–¹æ³•éœ€è¦è€ƒè™‘æ˜¯å¦æŒ‡å®šäº†keyGenerator</span><br>      <span class="hljs-keyword">if</span> (SqlCommandType.INSERT.equals(sqlCommandType) || SqlCommandType.UPDATE.equals(sqlCommandType)) &#123;<br>        <span class="hljs-comment">// first check for SelectKey annotation - that overrides everything else</span><br>        <span class="hljs-type">SelectKey</span> <span class="hljs-variable">selectKey</span> <span class="hljs-operator">=</span> method.getAnnotation(SelectKey.class);<br>        <span class="hljs-keyword">if</span> (selectKey != <span class="hljs-literal">null</span>) &#123;<br>          keyGenerator = handleSelectKeyAnnotation(selectKey, mappedStatementId, getParameterType(method), languageDriver);<br>          keyProperty = selectKey.keyProperty();<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (options == <span class="hljs-literal">null</span>) &#123;<br>          keyGenerator = configuration.isUseGeneratedKeys() ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jdbc3KeyGenerator</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          keyGenerator = options.useGeneratedKeys() ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jdbc3KeyGenerator</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>          keyProperty = options.keyProperty();<br>          keyColumn = options.keyColumn();<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        keyGenerator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>      &#125;<br><br>      <span class="hljs-comment">// ä¸€äº›é¢å¤–é€‰é¡¹</span><br>      <span class="hljs-keyword">if</span> (options != <span class="hljs-literal">null</span>) &#123;<br>        flushCache = options.flushCache();<br>        useCache = options.useCache();<br>        fetchSize = options.fetchSize() &gt; -<span class="hljs-number">1</span> || options.fetchSize() == Integer.MIN_VALUE ? options.fetchSize() : <span class="hljs-literal">null</span>; <span class="hljs-comment">//issue #348</span><br>        timeout = options.timeout() &gt; -<span class="hljs-number">1</span> ? options.timeout() : <span class="hljs-literal">null</span>;<br>        statementType = options.statementType();<br>        resultSetType = options.resultSetType();<br>      &#125;<br><br>      <span class="hljs-type">String</span> <span class="hljs-variable">resultMapId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMapAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(ResultMap.class);<br>      <span class="hljs-keyword">if</span> (resultMapAnnotation != <span class="hljs-literal">null</span>) &#123;<br>        String[] resultMaps = resultMapAnnotation.value();<br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">for</span> (String resultMap : resultMaps) &#123;<br>          <span class="hljs-keyword">if</span> (sb.length() &gt; <span class="hljs-number">0</span>) &#123;<br>            sb.append(<span class="hljs-string">&quot;,&quot;</span>);<br>          &#125;<br>          sb.append(resultMap);<br>        &#125;<br>        resultMapId = sb.toString();<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isSelect) &#123;<br>        resultMapId = parseResultMap(method);<br>      &#125;<br><br>      assistant.addMappedStatement(<br>          mappedStatementId,<br>          sqlSource,<br>          statementType,<br>          sqlCommandType,<br>          fetchSize,<br>          timeout,<br>          <span class="hljs-comment">// ParameterMapID</span><br>          <span class="hljs-literal">null</span>,<br>          parameterTypeClass,<br>          resultMapId,<br>          getReturnType(method),<br>          resultSetType,<br>          flushCache,<br>          useCache,<br>          <span class="hljs-comment">// TODO issue #577</span><br>          <span class="hljs-literal">false</span>,<br>          keyGenerator,<br>          keyProperty,<br>          keyColumn,<br>          <span class="hljs-comment">// DatabaseID</span><br>          <span class="hljs-literal">null</span>,<br>          languageDriver,<br>          <span class="hljs-comment">// ResultSets</span><br>          <span class="hljs-literal">null</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; getParameterType(Method method) &#123;<br>    Class&lt;?&gt; parameterType = <span class="hljs-literal">null</span>;<br>    Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameterTypes.length; i++) &#123;<br>      <span class="hljs-keyword">if</span> (!RowBounds.class.isAssignableFrom(parameterTypes[i]) &amp;&amp; !ResultHandler.class.isAssignableFrom(parameterTypes[i])) &#123;<br>        <span class="hljs-keyword">if</span> (parameterType == <span class="hljs-literal">null</span>) &#123;<br>          parameterType = parameterTypes[i];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// issue #135</span><br>          <span class="hljs-comment">// å­˜åœ¨å¤šä¸ªå‚æ•°çš„è¯ï¼Œè®¾ç½®ä¸º ParamMap</span><br>          parameterType = ParamMap.class;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> parameterType;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> LanguageDriver <span class="hljs-title function_">getLanguageDriver</span><span class="hljs-params">(Method method)</span> &#123;<br>    <span class="hljs-type">Lang</span> <span class="hljs-variable">lang</span> <span class="hljs-operator">=</span> method.getAnnotation(Lang.class);<br>    Class&lt;?&gt; langClass = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (lang != <span class="hljs-literal">null</span>) &#123;<br>      langClass = lang.value();<br>    &#125;<br>    <span class="hljs-keyword">return</span> assistant.getLanguageDriver(langClass);<br>  &#125; <br><br>  <span class="hljs-comment">// å°†æ³¨è§£çš„å†…å®¹è½¬æ¢ä¸º SqlSource</span><br>  <span class="hljs-keyword">private</span> SqlSource <span class="hljs-title function_">getSqlSourceFromAnnotations</span><span class="hljs-params">(Method method, Class&lt;?&gt; parameterType, LanguageDriver languageDriver)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; sqlAnnotationType = getSqlAnnotationType(method);<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; sqlProviderAnnotationType = getSqlProviderAnnotationType(method);<br>      <span class="hljs-comment">// Select | Insert | Update | Delete å’Œ</span><br>      <span class="hljs-comment">// SelectProvider | InsertProvider | UpdateProvider | DeleteProviderä¸èƒ½å…±å­˜</span><br>      <span class="hljs-keyword">if</span> (sqlAnnotationType != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (sqlProviderAnnotationType != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;You cannot supply both a static SQL and SqlProvider to method named &quot;</span> + method.getName());<br>        &#125;<br>        <span class="hljs-type">Annotation</span> <span class="hljs-variable">sqlAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(sqlAnnotationType);<br>        <span class="hljs-keyword">final</span> String[] strings = (String[]) sqlAnnotation.getClass().getMethod(<span class="hljs-string">&quot;value&quot;</span>).invoke(sqlAnnotation);<br>        <span class="hljs-keyword">return</span> buildSqlSourceFromStrings(strings, parameterType, languageDriver);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sqlProviderAnnotationType != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Annotation</span> <span class="hljs-variable">sqlProviderAnnotation</span> <span class="hljs-operator">=</span> method.getAnnotation(sqlProviderAnnotationType);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProviderSqlSource</span>(assistant.getConfiguration(), sqlProviderAnnotation);<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Could not find value method on SQL annotation.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; getSqlAnnotationType(Method method) &#123;<br>    <span class="hljs-keyword">return</span> chooseAnnotationType(method, sqlAnnotationTypes);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; getSqlProviderAnnotationType(Method method) &#123;<br>    <span class="hljs-keyword">return</span> chooseAnnotationType(method, sqlProviderAnnotationTypes);                    <br>  &#125;<br>  <span class="hljs-comment">// å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªæ³¨è§£æ‰¾</span><br>  <span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; chooseAnnotationType(Method method, Set&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;&gt; types) &#123;<br>    <span class="hljs-keyword">for</span> (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt; type : types) &#123;<br>      <span class="hljs-type">Annotation</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> method.getAnnotation(type);<br>      <span class="hljs-keyword">if</span> (annotation != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> type;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;  <br><br>  <span class="hljs-keyword">private</span> SqlSource <span class="hljs-title function_">buildSqlSourceFromStrings</span><span class="hljs-params">(String[] strings, Class&lt;?&gt; parameterTypeClass, LanguageDriver languageDriver)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">for</span> (String fragment : strings) &#123;<br>      sql.append(fragment);<br>      sql.append(<span class="hljs-string">&quot; &quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> languageDriver.createSqlSource(configuration, sql.toString(), parameterTypeClass);<br>  &#125; <br><br>  <span class="hljs-comment">// å¾€configuration æ·»åŠ äº† id-&gt;SelectKeyGenerator çš„æ˜ å°„</span><br>  <span class="hljs-keyword">private</span> KeyGenerator <span class="hljs-title function_">handleSelectKeyAnnotation</span><span class="hljs-params">(SelectKey selectKeyAnnotation, String baseStatementId, Class&lt;?&gt; parameterTypeClass, LanguageDriver languageDriver)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> baseStatementId + SelectKeyGenerator.SELECT_KEY_SUFFIX;<br>    Class&lt;?&gt; resultTypeClass = selectKeyAnnotation.resultType();<br>    <span class="hljs-type">StatementType</span> <span class="hljs-variable">statementType</span> <span class="hljs-operator">=</span> selectKeyAnnotation.statementType();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyProperty</span> <span class="hljs-operator">=</span> selectKeyAnnotation.keyProperty();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">keyColumn</span> <span class="hljs-operator">=</span> selectKeyAnnotation.keyColumn();<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">executeBefore</span> <span class="hljs-operator">=</span> selectKeyAnnotation.before();<br><br>    <span class="hljs-comment">// defaults</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">useCache</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">KeyGenerator</span> <span class="hljs-variable">keyGenerator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">fetchSize</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">flushCache</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">parameterMap</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">ResultSetType</span> <span class="hljs-variable">resultSetTypeEnum</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> buildSqlSourceFromStrings(selectKeyAnnotation.statement(), parameterTypeClass, languageDriver);<br>    <span class="hljs-type">SqlCommandType</span> <span class="hljs-variable">sqlCommandType</span> <span class="hljs-operator">=</span> SqlCommandType.SELECT;<br><br>    assistant.addMappedStatement(id, sqlSource, statementType, sqlCommandType, fetchSize, timeout, parameterMap, parameterTypeClass, resultMap, resultTypeClass, resultSetTypeEnum,<br>        flushCache, useCache, <span class="hljs-literal">false</span>,<br>        keyGenerator, keyProperty, keyColumn, <span class="hljs-literal">null</span>, languageDriver, <span class="hljs-literal">null</span>);<br><br>    id = assistant.applyCurrentNamespace(id, <span class="hljs-literal">false</span>);<br><br>    <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">keyStatement</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(id, <span class="hljs-literal">false</span>);<br>    <span class="hljs-type">SelectKeyGenerator</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SelectKeyGenerator</span>(keyStatement, executeBefore);<br>    configuration.addKeyGenerator(id, answer);<br>    <span class="hljs-keyword">return</span> answer;<br>  &#125; <br><br>  <span class="hljs-comment">// æ–¹æ³•æ²¡æœ‰@ResultMapæ³¨è§£æ—¶æ ¹æ®å…¶ä»–æ³¨è§£è·å–ResultMapä¿¡æ¯</span><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">parseResultMap</span><span class="hljs-params">(Method method)</span> &#123;<br>    Class&lt;?&gt; returnType = getReturnType(method);<br>    <span class="hljs-type">ConstructorArgs</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> method.getAnnotation(ConstructorArgs.class);<br>    <span class="hljs-type">Results</span> <span class="hljs-variable">results</span> <span class="hljs-operator">=</span> method.getAnnotation(Results.class);<br>    <span class="hljs-type">TypeDiscriminator</span> <span class="hljs-variable">typeDiscriminator</span> <span class="hljs-operator">=</span> method.getAnnotation(TypeDiscriminator.class);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">resultMapId</span> <span class="hljs-operator">=</span> generateResultMapName(method);<br>    applyResultMap(resultMapId, returnType, argsIf(args), resultsIf(results), typeDiscriminator);<br>    <span class="hljs-keyword">return</span> resultMapId;<br>  &#125; <br><br>  <span class="hljs-comment">// è·å–æ–¹æ³•å¯¹åº”çš„sqlè¯­å¥çš„è¿”å›å€¼ç±»å‹</span><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; getReturnType(Method method) &#123;<br>    Class&lt;?&gt; returnType = method.getReturnType();<br>    <span class="hljs-comment">// issue #508</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">void</span>.class.equals(returnType)) &#123;<br>      <span class="hljs-type">ResultType</span> <span class="hljs-variable">rt</span> <span class="hljs-operator">=</span> method.getAnnotation(ResultType.class);<br>      <span class="hljs-keyword">if</span> (rt != <span class="hljs-literal">null</span>) &#123;<br>        returnType = rt.value();<br>      &#125; <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Collection.class.isAssignableFrom(returnType)) &#123;<br>      <span class="hljs-type">Type</span> <span class="hljs-variable">returnTypeParameter</span> <span class="hljs-operator">=</span> method.getGenericReturnType();<br>      <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>        Type[] actualTypeArguments = ((ParameterizedType) returnTypeParameter).getActualTypeArguments();<br>        <span class="hljs-keyword">if</span> (actualTypeArguments != <span class="hljs-literal">null</span> &amp;&amp; actualTypeArguments.length == <span class="hljs-number">1</span>) &#123;<br>          returnTypeParameter = actualTypeArguments[<span class="hljs-number">0</span>];<br>          <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> Class) &#123;<br>            returnType = (Class&lt;?&gt;) returnTypeParameter;<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>            <span class="hljs-comment">// (issue #443) actual type can be a also a parameterized type</span><br>            returnType = (Class&lt;?&gt;) ((ParameterizedType) returnTypeParameter).getRawType();<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> GenericArrayType) &#123;<br>            Class&lt;?&gt; componentType = (Class&lt;?&gt;) ((GenericArrayType) returnTypeParameter).getGenericComponentType();<br>            <span class="hljs-comment">// (issue #525) support List&lt;byte[]&gt;</span><br>            returnType = Array.newInstance(componentType, <span class="hljs-number">0</span>).getClass();<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (method.isAnnotationPresent(MapKey.class) &amp;&amp; Map.class.isAssignableFrom(returnType)) &#123;<br>      <span class="hljs-comment">// (issue 504) Do not look into Maps if there is not MapKey annotation</span><br>      <span class="hljs-type">Type</span> <span class="hljs-variable">returnTypeParameter</span> <span class="hljs-operator">=</span> method.getGenericReturnType();<br>      <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>        Type[] actualTypeArguments = ((ParameterizedType) returnTypeParameter).getActualTypeArguments();<br>        <span class="hljs-keyword">if</span> (actualTypeArguments != <span class="hljs-literal">null</span> &amp;&amp; actualTypeArguments.length == <span class="hljs-number">2</span>) &#123;<br>          returnTypeParameter = actualTypeArguments[<span class="hljs-number">1</span>];<br>          <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> Class) &#123;<br>            returnType = (Class&lt;?&gt;) returnTypeParameter;<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (returnTypeParameter <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>            <span class="hljs-comment">// (issue 443) actual type can be a also a parameterized type</span><br>            returnType = (Class&lt;?&gt;) ((ParameterizedType) returnTypeParameter).getRawType();<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> returnType;<br>  &#125; <br><br>  <span class="hljs-comment">// resultMapNameå½¢å¦‚</span><br>  <span class="hljs-comment">// ç±»å.æ–¹æ³•å-void(-å‚æ•°1ç±»å‹-å‚æ•°2ç±»å‹-...)</span><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateResultMapName</span><span class="hljs-params">(Method method)</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">suffix</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">for</span> (Class&lt;?&gt; c : method.getParameterTypes()) &#123;<br>      suffix.append(<span class="hljs-string">&quot;-&quot;</span>);<br>      suffix.append(c.getSimpleName());<br>    &#125;<br>    <span class="hljs-keyword">if</span> (suffix.length() &lt; <span class="hljs-number">1</span>) &#123;<br>      suffix.append(<span class="hljs-string">&quot;-void&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> type.getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName() + suffix;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Arg[] argsIf(ConstructorArgs args) &#123;<br>    <span class="hljs-keyword">return</span> args == <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Arg</span>[<span class="hljs-number">0</span>] : args.value();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Result[] resultsIf(Results results) &#123;<br>    <span class="hljs-keyword">return</span> results == <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>[<span class="hljs-number">0</span>] : results.value();<br>  &#125; <br><br>  <span class="hljs-comment">// @Arg ç”¨äºæè¿°æ„é€ æ–¹æ³•å‚æ•°çš„æ˜ å°„å…³ç³»ï¼Œ</span><br>  <span class="hljs-comment">// è€Œ @Result ç”¨äºæè¿° JavaBean å±æ€§ä¸æ•°æ®åº“åˆ—ä¹‹é—´çš„æ˜ å°„å…³ç³»</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyResultMap</span><span class="hljs-params">(String resultMapId, Class&lt;?&gt; returnType, Arg[] args, Result[] results, TypeDiscriminator discriminator)</span> &#123;<br>    List&lt;ResultMapping&gt; resultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>    applyConstructorArgs(args, returnType, resultMappings);<br>    applyResults(results, returnType, resultMappings);<br>    <span class="hljs-type">Discriminator</span> <span class="hljs-variable">disc</span> <span class="hljs-operator">=</span> applyDiscriminator(resultMapId, returnType, discriminator);<br>    <span class="hljs-comment">// TODO add AutoMappingBehaviour</span><br>    assistant.addResultMap(resultMapId, returnType, <span class="hljs-literal">null</span>, disc, resultMappings, <span class="hljs-literal">null</span>);<br>    createDiscriminatorResultMaps(resultMapId, returnType, discriminator);<br>  &#125; <br><br>  <span class="hljs-comment">// é€šè¿‡ @Arg æ³¨è§£çš„å†…å®¹æ„é€  ResultMapping</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyConstructorArgs</span><span class="hljs-params">(Arg[] args, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> &#123;<br>    <span class="hljs-keyword">for</span> (Arg arg : args) &#123;<br>      List&lt;ResultFlag&gt; flags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;();<br>      flags.add(ResultFlag.CONSTRUCTOR);<br>      <span class="hljs-keyword">if</span> (arg.id()) &#123;<br>        flags.add(ResultFlag.ID);<br>      &#125;<br>      <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">resultMapping</span> <span class="hljs-operator">=</span> assistant.buildResultMapping(<br>          resultType,<br>          <span class="hljs-literal">null</span>,<br>          nullOrEmpty(arg.column()),<br>          arg.javaType() == <span class="hljs-keyword">void</span>.class ? <span class="hljs-literal">null</span> : arg.javaType(),<br>          arg.jdbcType() == JdbcType.UNDEFINED ? <span class="hljs-literal">null</span> : arg.jdbcType(),<br>          nullOrEmpty(arg.select()),<br>          nullOrEmpty(arg.resultMap()),<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          arg.typeHandler() == UnknownTypeHandler.class ? <span class="hljs-literal">null</span> : arg.typeHandler(),<br>          flags,<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">false</span>);<br>      resultMappings.add(resultMapping);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ä¸ applyConstructorArgs ç±»ä¼¼</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyResults</span><span class="hljs-params">(Result[] results, Class&lt;?&gt; resultType, List&lt;ResultMapping&gt; resultMappings)</span> &#123;<br>    <span class="hljs-keyword">for</span> (Result result : results) &#123;<br>      List&lt;ResultFlag&gt; flags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;();<br>      <span class="hljs-keyword">if</span> (result.id()) &#123;<br>        flags.add(ResultFlag.ID);<br>      &#125;<br>      <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">resultMapping</span> <span class="hljs-operator">=</span> assistant.buildResultMapping(<br>          resultType,<br>          nullOrEmpty(result.property()),<br>          nullOrEmpty(result.column()),<br>          result.javaType() == <span class="hljs-keyword">void</span>.class ? <span class="hljs-literal">null</span> : result.javaType(),<br>          result.jdbcType() == JdbcType.UNDEFINED ? <span class="hljs-literal">null</span> : result.jdbcType(),<br>          hasNestedSelect(result) ? nestedSelectId(result) : <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          result.typeHandler() == UnknownTypeHandler.class ? <span class="hljs-literal">null</span> : result.typeHandler(),<br>          flags,<br>          <span class="hljs-literal">null</span>,<br>          <span class="hljs-literal">null</span>,<br>          isLazy(result));<br>      resultMappings.add(resultMapping);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNestedSelect</span><span class="hljs-params">(Result result)</span> &#123;<br>    <span class="hljs-keyword">if</span> (result.one().select().length() &gt; <span class="hljs-number">0</span> &amp;&amp; result.many().select().length() &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Cannot use both @One and @Many annotations in the same @Result&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> result.one().select().length() &gt; <span class="hljs-number">0</span> || result.many().select().length() &gt; <span class="hljs-number">0</span>;  <br>  &#125;  <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">nestedSelectId</span><span class="hljs-params">(Result result)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">nestedSelect</span> <span class="hljs-operator">=</span> result.one().select();<br>    <span class="hljs-keyword">if</span> (nestedSelect.length() &lt; <span class="hljs-number">1</span>) &#123;<br>      nestedSelect = result.many().select();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!nestedSelect.contains(<span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>      nestedSelect = type.getName() + <span class="hljs-string">&quot;.&quot;</span> + nestedSelect;<br>    &#125;<br>    <span class="hljs-keyword">return</span> nestedSelect;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLazy</span><span class="hljs-params">(Result result)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLazy</span> <span class="hljs-operator">=</span> configuration.isLazyLoadingEnabled();<br>    <span class="hljs-keyword">if</span> (result.one().select().length() &gt; <span class="hljs-number">0</span> &amp;&amp; FetchType.DEFAULT != result.one().fetchType()) &#123;<br>      isLazy = (result.one().fetchType() == FetchType.LAZY);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result.many().select().length() &gt; <span class="hljs-number">0</span> &amp;&amp; FetchType.DEFAULT != result.many().fetchType()) &#123;<br>      isLazy = (result.many().fetchType() == FetchType.LAZY);<br>    &#125;<br>    <span class="hljs-keyword">return</span> isLazy;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> Discriminator <span class="hljs-title function_">applyDiscriminator</span><span class="hljs-params">(String resultMapId, Class&lt;?&gt; resultType, TypeDiscriminator discriminator)</span> &#123;<br>    <span class="hljs-keyword">if</span> (discriminator != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> discriminator.column();<br>      Class&lt;?&gt; javaType = discriminator.javaType() == <span class="hljs-keyword">void</span>.class ? String.class : discriminator.javaType();<br>      <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> discriminator.jdbcType() == JdbcType.UNDEFINED ? <span class="hljs-literal">null</span> : discriminator.jdbcType();<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; typeHandler = discriminator.typeHandler() == UnknownTypeHandler.class ? <span class="hljs-literal">null</span> : discriminator.typeHandler();<br>      Case[] cases = discriminator.cases();<br>      Map&lt;String, String&gt; discriminatorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br>      <span class="hljs-keyword">for</span> (Case c : cases) &#123; <br>        <span class="hljs-comment">// caseä¸ºvalueæ—¶å¯¹åº”çš„ resultMapId</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> c.value();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">caseResultMapId</span> <span class="hljs-operator">=</span> resultMapId + <span class="hljs-string">&quot;-&quot;</span> + value;<br>        discriminatorMap.put(value, caseResultMapId);<br>      &#125;<br>      <span class="hljs-keyword">return</span> assistant.buildDiscriminator(resultType, column, javaType, jdbcType, typeHandler, discriminatorMap);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¹æ®@Case æ³¨è§£ æ·»åŠ ResultMap</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createDiscriminatorResultMaps</span><span class="hljs-params">(String resultMapId, Class&lt;?&gt; resultType, TypeDiscriminator discriminator)</span> &#123;<br>    <span class="hljs-keyword">if</span> (discriminator != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (Case c : discriminator.cases()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">caseResultMapId</span> <span class="hljs-operator">=</span> resultMapId + <span class="hljs-string">&quot;-&quot;</span> + c.value();<br>        List&lt;ResultMapping&gt; resultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>        <span class="hljs-comment">// issue #136</span><br>        applyConstructorArgs(c.constructArgs(), resultType, resultMappings);<br>        applyResults(c.results(), resultType, resultMappings);<br>        <span class="hljs-comment">// TODO add AutoMappingBehaviour</span><br>        assistant.addResultMap(caseResultMapId, c.type(), resultMapId, <span class="hljs-literal">null</span>, resultMappings, <span class="hljs-literal">null</span>);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parsePendingMethods</span><span class="hljs-params">()</span> &#123;<br>    Collection&lt;MethodResolver&gt; incompleteMethods = configuration.getIncompleteMethods();<br>    <span class="hljs-keyword">synchronized</span> (incompleteMethods) &#123;<br>      Iterator&lt;MethodResolver&gt; iter = incompleteMethods.iterator();<br>      <span class="hljs-keyword">while</span> (iter.hasNext()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          iter.next().resolve();<br>          iter.remove();<br>        &#125; <span class="hljs-keyword">catch</span> (IncompleteElementException e) &#123;<br>          <span class="hljs-comment">// This method is still missing a resource</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MethodResolver"><a href="#MethodResolver" class="headerlink" title="MethodResolver"></a>MethodResolver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodResolver</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MapperAnnotationBuilder annotationBuilder;<br>  <span class="hljs-keyword">private</span> Method method;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MethodResolver</span><span class="hljs-params">(MapperAnnotationBuilder annotationBuilder, Method method)</span> &#123;<br>    <span class="hljs-built_in">this</span>.annotationBuilder = annotationBuilder;<br>    <span class="hljs-built_in">this</span>.method = method;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolve</span><span class="hljs-params">()</span> &#123;<br>    annotationBuilder.parseStatement(method);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å†™åœ¨æœ€å"><a href="#å†™åœ¨æœ€å" class="headerlink" title="å†™åœ¨æœ€å"></a>å†™åœ¨æœ€å</h4><p>Â Â Â Â annotationsæ¨¡å—ç•¥è¿‡ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ç›¸å…³æ³¨è§£çš„ç”¨æ³•</p>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>13-scripting</title>
    <link href="/2023/08/05/mybatis-source-code/13-scripting/"/>
    <url>/2023/08/05/mybatis-source-code/13-scripting/</url>
    
    <content type="html"><![CDATA[<h4 id="LanguageDriver"><a href="#LanguageDriver" class="headerlink" title="LanguageDriver"></a>LanguageDriver</h4><p>Â Â Â Â ä¸»è¦ç”¨äºæ„é€ <code>SqlSource</code>å’Œ<code>ParameterHandler</code>å…¶ä¸­XMLLanguageDriverä¸ºXMLè¯­è¨€é©±åŠ¨ï¼Œé€šè¿‡è§£æXMLæ ‡ç­¾å®ç°äº†åŠ¨æ€sqlåŠŸèƒ½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LanguageDriver</span> &#123;<br>    <br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Creates a &#123;<span class="hljs-doctag">@link</span> ParameterHandler&#125; that passes the actual parameters to the the JDBC statement.</span><br><span class="hljs-comment">   * </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@author</span> Frank D. Martinez [mnesarco]</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@see</span> DefaultParameterHandler</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> mappedStatement The mapped statement that is being executed</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameterObject The input parameter object (can be null) </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> boundSql The resulting SQL once the dynamic language has been executed.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// åˆ›å»ºå‚æ•°å¤„ç†å™¨</span><br>  ParameterHandler <span class="hljs-title function_">createParameterHandler</span><span class="hljs-params">(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql)</span>; <br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Creates an &#123;<span class="hljs-doctag">@link</span> SqlSource&#125; that will hold the statement read from a mapper xml file. </span><br><span class="hljs-comment">   * It is called during startup, when the mapped statement is read from a class or an xml file.</span><br><span class="hljs-comment">   * </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> configuration The MyBatis configuration</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> script XNode parsed from a XML file</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameterType input parameter type got from a mapper method or specified in the parameterType xml attribute. Can be null.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// åˆ›å»ºSQLæºç (mapper xmlæ–¹å¼)</span><br>  SqlSource <span class="hljs-title function_">createSqlSource</span><span class="hljs-params">(Configuration configuration, XNode script, Class&lt;?&gt; parameterType)</span>; <br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Creates an &#123;<span class="hljs-doctag">@link</span> SqlSource&#125; that will hold the statement read from an annotation.</span><br><span class="hljs-comment">   * It is called during startup, when the mapped statement is read from a class or an xml file.</span><br><span class="hljs-comment">   * </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> configuration The MyBatis configuration</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> script The content of the annotation</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameterType input parameter type got from a mapper method or specified in the parameterType xml attribute. Can be null.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> </span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// åˆ›å»ºSQLæºç (æ³¨è§£æ–¹å¼)</span><br>  SqlSource <span class="hljs-title function_">createSqlSource</span><span class="hljs-params">(Configuration configuration, String script, Class&lt;?&gt; paramet</span><br><span class="hljs-params">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="DynamicContext"><a href="#DynamicContext" class="headerlink" title="DynamicContext"></a>DynamicContext</h4><p>Â Â Â Â åŠ¨æ€ä¸Šä¸‹æ–‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicContext</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PARAMETER_OBJECT_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;_parameter&quot;</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATABASE_ID_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;_databaseId&quot;</span>; <br><br>  <span class="hljs-keyword">static</span> &#123;<br>    <span class="hljs-comment">// TODO OgnlRuntime</span><br>    <span class="hljs-comment">// å®šä¹‰å±æ€§-&gt;getteræ–¹æ³•æ˜ å°„ï¼ŒContextMapåˆ°ContextAccessorçš„æ˜ å°„ï¼Œæ³¨å†Œåˆ°ognlè¿è¡Œæ—¶</span><br><span class="hljs-comment">// å‚è€ƒhttp://commons.apache.org/proper/commons-ognl/developer-guide.html</span><br>    OgnlRuntime.setPropertyAccessor(ContextMap.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextAccessor</span>());<br>    <span class="hljs-comment">// å°†ä¼ å…¥çš„å‚æ•°å¯¹è±¡ç»Ÿä¸€å°è£…ä¸ºContextMapå¯¹è±¡ï¼ˆç»§æ‰¿äº†HashMapå¯¹è±¡ï¼‰ï¼Œ</span><br>    <span class="hljs-comment">// ç„¶åOgnlè¿è¡Œæ—¶ç¯å¢ƒåœ¨åŠ¨æ€è®¡ç®—sqlè¯­å¥æ—¶ï¼Œ</span><br>    <span class="hljs-comment">// ä¼šæŒ‰ç…§ContextAccessorä¸­æè¿°çš„Mapæ¥å£çš„æ–¹å¼æ¥è®¿é—®å’Œè¯»å–ContextMapå¯¹è±¡ï¼Œè·å–è®¡ç®—è¿‡ç¨‹ä¸­éœ€è¦çš„å‚æ•°ã€‚</span><br>    <span class="hljs-comment">// ContextMapå¯¹è±¡å†…éƒ¨å¯èƒ½å°è£…äº†ä¸€ä¸ªæ™®é€šçš„POJOå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›´æ¥ä¼ é€’çš„Mapå¯¹è±¡ï¼Œå½“ç„¶ä»å¤–éƒ¨æ˜¯çœ‹ä¸å‡ºæ¥çš„ï¼Œå› ä¸ºéƒ½æ˜¯ä½¿ç”¨Mapçš„æ¥å£æ¥è¯»å–æ•°æ®ã€‚</span><br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ContextMap bindings;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sqlBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">uniqueNumber</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <br><br>  <span class="hljs-comment">// åœ¨DynamicContextçš„æ„é€ å‡½æ•°ä¸­ï¼Œæ ¹æ®ä¼ å…¥çš„å‚æ•°å¯¹è±¡æ˜¯å¦ä¸ºMapç±»å‹ï¼Œæœ‰ä¸¤ä¸ªä¸åŒæ„é€ ContextMapçš„æ–¹å¼ã€‚</span><br>  <span class="hljs-comment">// è€ŒContextMapä½œä¸ºä¸€ä¸ªç»§æ‰¿äº†HashMapçš„å¯¹è±¡ï¼Œä½œç”¨å°±æ˜¯ç”¨äºç»Ÿä¸€å‚æ•°çš„è®¿é—®æ–¹å¼ï¼šç”¨Mapæ¥å£æ–¹æ³•æ¥è®¿é—®æ•°æ®ã€‚</span><br>  <span class="hljs-comment">// å…·ä½“æ¥è¯´ï¼Œå½“ä¼ å…¥çš„å‚æ•°å¯¹è±¡ä¸æ˜¯Mapç±»å‹æ—¶ï¼ŒMybatisä¼šå°†ä¼ å…¥çš„POJOå¯¹è±¡ç”¨MetaObjectå¯¹è±¡æ¥å°è£…ï¼Œ</span><br>  <span class="hljs-comment">// å½“åŠ¨æ€è®¡ç®—sqlè¿‡ç¨‹éœ€è¦è·å–æ•°æ®æ—¶ï¼Œç”¨Mapæ¥å£çš„getæ–¹æ³•åŒ…è£… MetaObjectå¯¹è±¡çš„å–å€¼è¿‡ç¨‹ã€‚</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DynamicContext</span><span class="hljs-params">(Configuration configuration, Object parameterObject)</span> &#123;<br><span class="hljs-comment">// ç»å¤§å¤šæ•°è°ƒç”¨çš„åœ°æ–¹parameterObjectä¸ºnull</span><br>    <span class="hljs-comment">// parameterObject ä½œä¸ºå¯é€‰é¡¹æ¥é€šè¿‡ä¼ å…¥å¯¹è±¡æ¥ä¼ å…¥è‡ªå®šä¹‰å‚æ•°</span><br>    <span class="hljs-keyword">if</span> (parameterObject != <span class="hljs-literal">null</span> &amp;&amp; !(parameterObject <span class="hljs-keyword">instanceof</span> Map)) &#123;<br>      <span class="hljs-comment">// å¦‚æœä¸æ˜¯mapå‹</span><br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaObject</span> <span class="hljs-operator">=</span> configuration.newMetaObject(parameterObject);<br>      bindings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextMap</span>(metaObject);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      bindings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextMap</span>(<span class="hljs-literal">null</span>);<br>    &#125;<br>    bindings.put(PARAMETER_OBJECT_KEY, parameterObject);<br>    bindings.put(DATABASE_ID_KEY, configuration.getDatabaseId());<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getBindings</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> bindings;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bind</span><span class="hljs-params">(String name, Object value)</span> &#123;<br>    bindings.put(name, value);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appendSql</span><span class="hljs-params">(String sql)</span> &#123;<br>    sqlBuilder.append(sql);<br>    sqlBuilder.append(<span class="hljs-string">&quot; &quot;</span>);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSql</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlBuilder.toString().trim();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUniqueNumber</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> uniqueNumber++;<br>  &#125; <br><br>  <span class="hljs-comment">// ä¸Šä¸‹æ–‡mapï¼Œé™æ€å†…éƒ¨ç±»</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">2977601501966151582L</span>;<br><br>    <span class="hljs-keyword">private</span> MetaObject parameterMetaObject;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ContextMap</span><span class="hljs-params">(MetaObject parameterMetaObject)</span> &#123;<br>      <span class="hljs-built_in">this</span>.parameterMetaObject = parameterMetaObject;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">strKey</span> <span class="hljs-operator">=</span> (String) key;<br>      <span class="hljs-comment">// å…ˆå»mapé‡Œæ‰¾</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">super</span>.containsKey(strKey)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.get(strKey);<br>      &#125;<br><br>      <span class="hljs-comment">// å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå†ç”¨ognlè¡¨è¾¾å¼å»å–å€¼</span><br>      <span class="hljs-comment">// å¦‚person[0].birthdate.year</span><br>      <span class="hljs-keyword">if</span> (parameterMetaObject != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// issue #61 do not modify the context when reading</span><br>        <span class="hljs-keyword">return</span> parameterMetaObject.getValue(strKey);<br>      &#125;<br><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ä¸Šä¸‹æ–‡è®¿é—®å™¨ï¼Œé™æ€å†…éƒ¨ç±»,å®ç°OGNLçš„PropertyAccessor</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextAccessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PropertyAccessor</span> &#123; <br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProperty</span><span class="hljs-params">(Map context, Object target, Object name)</span><br>        <span class="hljs-keyword">throws</span> OgnlException &#123;<br>      <span class="hljs-type">Map</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> (Map) target;<br><br>      <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> map.get(name);<br>      <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> result;<br>      &#125;<br><br>      <span class="hljs-type">Object</span> <span class="hljs-variable">parameterObject</span> <span class="hljs-operator">=</span> map.get(PARAMETER_OBJECT_KEY);<br>      <span class="hljs-keyword">if</span> (parameterObject <span class="hljs-keyword">instanceof</span> Map) &#123;<br>        <span class="hljs-keyword">return</span> ((Map)parameterObject).get(name);<br>      &#125;<br><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperty</span><span class="hljs-params">(Map context, Object target, Object name, Object value)</span><br>        <span class="hljs-keyword">throws</span> OgnlException &#123;<br>      Map&lt;Object, Object&gt; map = (Map&lt;Object, Object&gt;) target;<br>      map.put(name, value);<br>    &#125; <br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSourceAccessor</span><span class="hljs-params">(OgnlContext arg0, Object arg1, Object arg2)</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSourceSetter</span><span class="hljs-params">(OgnlContext arg0, Object arg1, Object arg2)</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="OgnlClassResolver"><a href="#OgnlClassResolver" class="headerlink" title="OgnlClassResolver"></a>OgnlClassResolver</h4><p>Â Â Â Â è‡ªå®šä¹‰çš„<code>ognl ClassResolver</code>ï¼Œå’Œ<code>ognl</code>çš„<code>DefaultClassResolver</code>è¡¨ç°ç›¸è¿‘ã€‚ä¸åŒçš„æ˜¯è‡ªå®šä¹‰çš„<code>ClassResolver</code>ä½¿ç”¨<code>Resources</code>å·¥å…·ç±»è€Œä¸æ˜¯<code>Class.forName(String)</code>æ¥æ‰¾ç›®æ ‡ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OgnlClassResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClassResolver</span> &#123; <br><br>  <span class="hljs-comment">// è¿˜åŠ äº†ä¸ªç¼“å­˜</span><br>  <span class="hljs-keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; classes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Class&lt;?&gt;&gt;(<span class="hljs-number">101</span>);<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Class <span class="hljs-title function_">classForName</span><span class="hljs-params">(String className, Map context)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    Class&lt;?&gt; result = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> ((result = classes.get(className)) == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        result = Resources.classForName(className);<br>      &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e1) &#123;  <br>        <span class="hljs-comment">// æ‰¾ä¸åˆ°çš„è¯å»java.langåŒ…å†æ‰¾ä¸€ä¸‹</span><br>        <span class="hljs-keyword">if</span> (className.indexOf(<span class="hljs-string">&#x27;.&#x27;</span>) == -<span class="hljs-number">1</span>) &#123;<br>          result = Resources.classForName(<span class="hljs-string">&quot;java.lang.&quot;</span> + className);<br>          classes.put(<span class="hljs-string">&quot;java.lang.&quot;</span> + className, result);<br>        &#125;<br>      &#125;<br>      classes.put(className, result);<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="OgnlCache"><a href="#OgnlCache" class="headerlink" title="OgnlCache"></a>OgnlCache</h4><p>Â Â Â Â æ ¹æ®mybatisçš„è¯´æ³•ï¼Œognlæœ‰æ€§èƒ½é—®é¢˜ï¼Œæ‰€ä»¥åŠ äº†ä¸ªç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OgnlCache</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; expressionCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;String, Object&gt;();<br> <br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">OgnlCache</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Prevent Instantiation of Static Class</span><br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">(String expression, Object root)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Map&lt;Object, OgnlClassResolver&gt; context = Ognl.createDefaultContext(root, <span class="hljs-keyword">new</span> <span class="hljs-title class_">OgnlClassResolver</span>());<br>      <span class="hljs-keyword">return</span> Ognl.getValue(parseExpression(expression), context, root);<br>    &#125; <span class="hljs-keyword">catch</span> (OgnlException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error evaluating expression &#x27;&quot;</span> + expression + <span class="hljs-string">&quot;&#x27;. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">parseExpression</span><span class="hljs-params">(String expression)</span> <span class="hljs-keyword">throws</span> OgnlException &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> expressionCache.get(expression);<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// å¤§è‡´æ„æ€å°±æ˜¯OgnlParser.topLevelExpressionå¾ˆæ…¢ï¼Œæ‰€ä»¥åŠ ä¸ªç¼“å­˜ï¼Œæ”¾åˆ°ConcurrentHashMapé‡Œé¢</span><br>      node = Ognl.parseExpression(expression);<br>      expressionCache.put(expression, node);<br>    &#125;<br>    <span class="hljs-keyword">return</span> node;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ExpressionEvaluator"><a href="#ExpressionEvaluator" class="headerlink" title="ExpressionEvaluator"></a>ExpressionEvaluator</h4><p>Â Â Â Â è¡¨è¾¾å¼æ±‚å€¼å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExpressionEvaluator</span> &#123; <br><br>  <span class="hljs-comment">// è¡¨è¾¾å¼æ±‚å¸ƒå°”å€¼ï¼Œæ¯”å¦‚username == &#x27;cbegin&#x27;</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">evaluateBoolean</span><span class="hljs-params">(String expression, Object parameterObject)</span> &#123;<br><span class="hljs-comment">// éå¸¸ç®€å•ï¼Œå°±æ˜¯è°ƒç”¨ognl</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> OgnlCache.getValue(expression, parameterObject);<br>    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Boolean) &#123;<br>        <span class="hljs-comment">// å¦‚æœæ˜¯Boolean</span><br>        <span class="hljs-keyword">return</span> (Boolean) value;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Number) &#123;<br>        <span class="hljs-comment">// å¦‚æœæ˜¯Numberï¼Œåˆ¤æ–­ä¸ä¸º0</span><br>        <span class="hljs-keyword">return</span> !<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(String.valueOf(value)).equals(BigDecimal.ZERO);<br>    &#125;<br>    <span class="hljs-comment">// 3 å¦åˆ™åˆ¤æ–­ä¸ä¸ºnull</span><br>    <span class="hljs-keyword">return</span> value != <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æè¡¨è¾¾å¼åˆ°ä¸€ä¸ªIterable,æ ¸å¿ƒæ˜¯ognl</span><br>  <span class="hljs-keyword">public</span> Iterable&lt;?&gt; evaluateIterable(String expression, Object parameterObject) &#123;<br><span class="hljs-comment">// åŸç”Ÿçš„ognlå¾ˆå¼ºå¤§ï¼ŒOgnlCache.getValueç›´æ¥å°±å¯ä»¥è¿”å›ä¸€ä¸ªIterableå‹æˆ–æ•°ç»„å‹æˆ–Mapå‹äº†</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> OgnlCache.getValue(expression, parameterObject);<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;The expression &#x27;&quot;</span> + expression + <span class="hljs-string">&quot;&#x27; evaluated to a null value.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Iterable) &#123;<br>      <span class="hljs-keyword">return</span> (Iterable&lt;?&gt;) value;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (value.getClass().isArray()) &#123;<br>    <span class="hljs-comment">// å¦‚æœæ˜¯arrayï¼Œåˆ™æŠŠä»–å˜æˆä¸€ä¸ªList&lt;Object&gt;</span><br>    <span class="hljs-comment">// æ³¨é‡Šä¸‹é¢æåˆ°äº†ï¼Œä¸èƒ½ç”¨Arrays.asList()ï¼Œå› ä¸ºarrayå¯èƒ½æ˜¯åŸºæœ¬å‹ï¼Œè¿™æ ·ä¼šå‡ºClassCastExceptionï¼Œ</span><br>    <span class="hljs-comment">// è§https://code.google.com/p/mybatis/issues/detail?id=209</span><br>        <span class="hljs-comment">// the array may be primitive, so Arrays.asList() may throw</span><br>        <span class="hljs-comment">// a ClassCastException (issue 209).  Do the work manually</span><br>        <span class="hljs-comment">// Curse primitives! :) (JGB)</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> Array.getLength(value);<br>        List&lt;Object&gt; answer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> Array.get(value, i);<br>            answer.add(o);<br>        &#125;<br>        <span class="hljs-keyword">return</span> answer;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Map) &#123;<br>      <span class="hljs-keyword">return</span> ((Map) value).entrySet();<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error evaluating expression &#x27;&quot;</span> + expression + <span class="hljs-string">&quot;&#x27;.  Return value (&quot;</span> + value + <span class="hljs-string">&quot;) was not iterable.&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SqlNode"><a href="#SqlNode" class="headerlink" title="SqlNode"></a>SqlNode</h4><p>Â Â Â Â SQLèŠ‚ç‚¹æŠ½è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SqlNode</span> &#123;<br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><br>#### StaticTextSqlNode<br><br>Â Â Â Â é™æ€æ–‡æœ¬SQLèŠ‚ç‚¹<br><br>```java<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticTextSqlNode</span> implements SqlNode &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> text;<br><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StaticTextSqlNode</span><span class="hljs-params">(<span class="hljs-type">String</span> text)</span> </span>&#123;<br>    <span class="hljs-keyword">this</span>.text = text;<br>  &#125;<br><br>  @<span class="hljs-function">Override</span><br><span class="hljs-function">  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">apply</span><span class="hljs-params">(DynamicContext context)</span> </span>&#123;<br><span class="hljs-comment">// å°†æ–‡æœ¬åŠ å…¥context</span><br>    context.<span class="hljs-built_in">appendSql</span>(text);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="TextSqlNode"><a href="#TextSqlNode" class="headerlink" title="TextSqlNode"></a>TextSqlNode</h4><p>Â Â Â Â æ–‡æœ¬SQLèŠ‚ç‚¹ï¼ˆCDATA|TEXTï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextSqlNode</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlNode</span> &#123; <br><br>  <span class="hljs-keyword">private</span> String text;<br>  <span class="hljs-keyword">private</span> Pattern injectionFilter; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">TextSqlNode</span><span class="hljs-params">(String text)</span> &#123;<br>    <span class="hljs-built_in">this</span>(text, <span class="hljs-literal">null</span>);<br>  &#125;<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">TextSqlNode</span><span class="hljs-params">(String text, Pattern injectionFilter)</span> &#123;<br>    <span class="hljs-built_in">this</span>.text = text;<br>    <span class="hljs-built_in">this</span>.injectionFilter = injectionFilter;<br>  &#125; <br><br>  <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æ˜¯åŠ¨æ€sql</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDynamic</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">DynamicCheckerTokenParser</span> <span class="hljs-variable">checker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicCheckerTokenParser</span>();<br>    <span class="hljs-comment">// å®é™…ä¸Šæ˜¯çœ‹text ä¸­æœ‰æ²¡æœ‰ç±»ä¼¼ $&#123;?&#125;çš„æ•°æ®ï¼Œå¦‚æœæœ‰ï¼Œå°±æ˜¯åŠ¨æ€çš„</span><br>    <span class="hljs-type">GenericTokenParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> createParser(checker);<br>    parser.parse(text);<br>    <span class="hljs-keyword">return</span> checker.isDynamic();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span> &#123;<br>    <span class="hljs-type">GenericTokenParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> createParser(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingTokenParser</span>(context, injectionFilter));<br>    context.appendSql(parser.parse(text));<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> GenericTokenParser <span class="hljs-title function_">createParser</span><span class="hljs-params">(TokenHandler handler)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericTokenParser</span>(<span class="hljs-string">&quot;$&#123;&quot;</span>, <span class="hljs-string">&quot;&#125;&quot;</span>, handler);<br>  &#125; <br><br>  <span class="hljs-comment">// ç»‘å®šè®°å·è§£æå™¨</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BindingTokenParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TokenHandler</span> &#123;<br><br>    <span class="hljs-keyword">private</span> DynamicContext context;<br>    <span class="hljs-keyword">private</span> Pattern injectionFilter;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BindingTokenParser</span><span class="hljs-params">(DynamicContext context, Pattern injectionFilter)</span> &#123;<br>      <span class="hljs-built_in">this</span>.context = context;<br>      <span class="hljs-built_in">this</span>.injectionFilter = injectionFilter;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handleToken</span><span class="hljs-params">(String content)</span> &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">parameter</span> <span class="hljs-operator">=</span> context.getBindings().get(<span class="hljs-string">&quot;_parameter&quot;</span>);<br>      <span class="hljs-keyword">if</span> (parameter == <span class="hljs-literal">null</span>) &#123;<br>        context.getBindings().put(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-literal">null</span>);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (SimpleTypeRegistry.isSimpleType(parameter.getClass())) &#123;<br>        context.getBindings().put(<span class="hljs-string">&quot;value&quot;</span>, parameter);<br>      &#125;<br>      <span class="hljs-comment">// ä»ç¼“å­˜é‡Œå–å¾—å€¼</span><br>      <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> OgnlCache.getValue(content, context.getBindings());<br>      <span class="hljs-type">String</span> <span class="hljs-variable">srtValue</span> <span class="hljs-operator">=</span> (value == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;&quot;</span> : String.valueOf(value)); <span class="hljs-comment">// issue #274 return &quot;&quot; instead of &quot;null&quot;</span><br>      checkInjection(srtValue);<br>      <span class="hljs-keyword">return</span> srtValue;<br>    &#125;<br><br>    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkInjection</span><span class="hljs-params">(String value)</span> &#123;<br>      <span class="hljs-keyword">if</span> (injectionFilter != <span class="hljs-literal">null</span> &amp;&amp; !injectionFilter.matcher(value).matches()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScriptingException</span>(<span class="hljs-string">&quot;Invalid input. Please conform to regex&quot;</span> + injectionFilter.pattern());<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// åŠ¨æ€SQLæ£€æŸ¥å™¨</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicCheckerTokenParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TokenHandler</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> isDynamic;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DynamicCheckerTokenParser</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDynamic</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> isDynamic;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handleToken</span><span class="hljs-params">(String content)</span> &#123;<br>      <span class="hljs-comment">// ç°å¸¸ç®€å•ï¼Œè®¾ç½®isDynamicä¸ºtrueï¼Œå³è°ƒç”¨äº†è¿™ä¸ªç±»å°±å¿…å®šæ˜¯åŠ¨æ€sql</span><br>      <span class="hljs-built_in">this</span>.isDynamic = <span class="hljs-literal">true</span>;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="VarDeclSqlNode"><a href="#VarDeclSqlNode" class="headerlink" title="VarDeclSqlNode"></a>VarDeclSqlNode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VarDeclSqlNode</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlNode</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String expression;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">VarDeclSqlNode</span><span class="hljs-params">(String <span class="hljs-keyword">var</span>, String exp)</span> &#123;<br>    name = <span class="hljs-keyword">var</span>;<br>    expression = exp;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> OgnlCache.getValue(expression, context.getBindings());<br>    context.bind(name, value);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="IfSqlNode"><a href="#IfSqlNode" class="headerlink" title="IfSqlNode"></a>IfSqlNode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IfSqlNode</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlNode</span> &#123;<br>  <span class="hljs-keyword">private</span> ExpressionEvaluator evaluator;<br>  <span class="hljs-keyword">private</span> String test;<br>  <span class="hljs-keyword">private</span> SqlNode contents;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">IfSqlNode</span><span class="hljs-params">(SqlNode contents, String test)</span> &#123;<br>    <span class="hljs-built_in">this</span>.test = test;<br>    <span class="hljs-built_in">this</span>.contents = contents;<br>    <span class="hljs-built_in">this</span>.evaluator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpressionEvaluator</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™applyï¼Œå¹¶è¿”å›true</span><br>    <span class="hljs-keyword">if</span> (evaluator.evaluateBoolean(test, context.getBindings())) &#123;<br>      contents.apply(context);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ChooseSqlNode"><a href="#ChooseSqlNode" class="headerlink" title="ChooseSqlNode"></a>ChooseSqlNode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChooseSqlNode</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlNode</span> &#123;<br>  <span class="hljs-keyword">private</span> SqlNode defaultSqlNode;<br>  <span class="hljs-keyword">private</span> List&lt;SqlNode&gt; ifSqlNodes;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChooseSqlNode</span><span class="hljs-params">(List&lt;SqlNode&gt; ifSqlNodes, SqlNode defaultSqlNode)</span> &#123;<br>    <span class="hljs-built_in">this</span>.ifSqlNodes = ifSqlNodes;<br>    <span class="hljs-built_in">this</span>.defaultSqlNode = defaultSqlNode;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span> &#123;<br>    <span class="hljs-comment">// å¾ªç¯åˆ¤æ–­ifï¼Œåªè¦æœ‰1ä¸ªä¸ºtrueäº†ï¼Œè¿”å›true</span><br>    <span class="hljs-keyword">for</span> (SqlNode sqlNode : ifSqlNodes) &#123;<br>      <span class="hljs-keyword">if</span> (sqlNode.apply(context)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// iféƒ½ä¸ä¸ºtrueï¼Œé‚£å°±çœ‹otherwise</span><br>    <span class="hljs-keyword">if</span> (defaultSqlNode != <span class="hljs-literal">null</span>) &#123;<br>      defaultSqlNode.apply(context);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-comment">// å¦‚æœè¿otherwiseéƒ½æ²¡æœ‰ï¼Œè¿”å›false</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ForEachSqlNode"><a href="#ForEachSqlNode" class="headerlink" title="ForEachSqlNode"></a>ForEachSqlNode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForEachSqlNode</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlNode</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ITEM_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;__frch_&quot;</span>; <br><br>  <span class="hljs-keyword">private</span> ExpressionEvaluator evaluator;<br>  <span class="hljs-keyword">private</span> String collectionExpression;<br>  <span class="hljs-keyword">private</span> SqlNode contents;<br>  <span class="hljs-keyword">private</span> String open;<br>  <span class="hljs-keyword">private</span> String close;<br>  <span class="hljs-keyword">private</span> String separator;<br>  <span class="hljs-keyword">private</span> String item;<br>  <span class="hljs-keyword">private</span> String index;<br>  <span class="hljs-keyword">private</span> Configuration configuration; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ForEachSqlNode</span><span class="hljs-params">(Configuration configuration, SqlNode contents, String collectionExpression, String index, String item, String open, String close, String separator)</span> &#123;<br>    <span class="hljs-built_in">this</span>.evaluator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpressionEvaluator</span>();<br>    <span class="hljs-built_in">this</span>.collectionExpression = collectionExpression;<br>    <span class="hljs-built_in">this</span>.contents = contents;<br>    <span class="hljs-built_in">this</span>.open = open;<br>    <span class="hljs-built_in">this</span>.close = close;<br>    <span class="hljs-built_in">this</span>.separator = separator;<br>    <span class="hljs-built_in">this</span>.index = index;<br>    <span class="hljs-built_in">this</span>.item = item;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span> &#123;<br>    Map&lt;String, Object&gt; bindings = context.getBindings();<br><span class="hljs-comment">// è§£æcollectionExpression-&gt;iterable,æ ¸å¿ƒç”¨çš„ognl</span><br>    <span class="hljs-keyword">final</span> Iterable&lt;?&gt; iterable = evaluator.evaluateIterable(collectionExpression, bindings);<br>    <span class="hljs-keyword">if</span> (!iterable.iterator().hasNext()) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><span class="hljs-comment">// åŠ ä¸Š(</span><br>    applyOpen(context);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (Object o : iterable) &#123;<br>      <span class="hljs-type">DynamicContext</span> <span class="hljs-variable">oldContext</span> <span class="hljs-operator">=</span> context;<br>      <span class="hljs-keyword">if</span> (first) &#123;<br>        context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrefixedContext</span>(context, <span class="hljs-string">&quot;&quot;</span>);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (separator != <span class="hljs-literal">null</span>) &#123;<br>        context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrefixedContext</span>(context, separator);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrefixedContext</span>(context, <span class="hljs-string">&quot;&quot;</span>);<br>      &#125;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">uniqueNumber</span> <span class="hljs-operator">=</span> context.getUniqueNumber();<br>      <span class="hljs-comment">// Issue #709 </span><br>      <span class="hljs-keyword">if</span> (o <span class="hljs-keyword">instanceof</span> Map.Entry) &#123;<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <br>        Map.Entry&lt;Object, Object&gt; mapEntry = (Map.Entry&lt;Object, Object&gt;) o;<br>        applyIndex(context, mapEntry.getKey(), uniqueNumber);<br>        applyItem(context, mapEntry.getValue(), uniqueNumber);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// ç´¢å¼•</span><br>        applyIndex(context, i, uniqueNumber);<br><span class="hljs-comment">// åŠ ä¸Šä¸€ä¸ªå…ƒç´ </span><br>        applyItem(context, o, uniqueNumber);<br>      &#125;<br>      contents.apply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FilteredDynamicContext</span>(configuration, context, index, item, uniqueNumber));<br>      <span class="hljs-keyword">if</span> (first) &#123;<br>        first = !((PrefixedContext) context).isPrefixApplied();<br>      &#125;<br>      context = oldContext;<br>      i++;<br>    &#125;<br><span class="hljs-comment">// åŠ ä¸Š)</span><br>    applyClose(context);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyIndex</span><span class="hljs-params">(DynamicContext context, Object o, <span class="hljs-type">int</span> i)</span> &#123;<br>    <span class="hljs-keyword">if</span> (index != <span class="hljs-literal">null</span>) &#123;<br>      context.bind(index, o);<br>      context.bind(itemizeItem(index, i), o);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyItem</span><span class="hljs-params">(DynamicContext context, Object o, <span class="hljs-type">int</span> i)</span> &#123;<br>    <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span>) &#123;<br>      context.bind(item, o);<br>      context.bind(itemizeItem(item, i), o);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyOpen</span><span class="hljs-params">(DynamicContext context)</span> &#123;<br>    <span class="hljs-keyword">if</span> (open != <span class="hljs-literal">null</span>) &#123;<br>      context.appendSql(open);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyClose</span><span class="hljs-params">(DynamicContext context)</span> &#123;<br>    <span class="hljs-keyword">if</span> (close != <span class="hljs-literal">null</span>) &#123;<br>      context.appendSql(close);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">itemizeItem</span><span class="hljs-params">(String item, <span class="hljs-type">int</span> i)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(ITEM_PREFIX).append(item).append(<span class="hljs-string">&quot;_&quot;</span>).append(i).toString();<br>  &#125; <br><br>  <span class="hljs-comment">// è¢«è¿‡æ»¤çš„åŠ¨æ€ä¸Šä¸‹æ–‡</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilteredDynamicContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DynamicContext</span> &#123;<br>    <span class="hljs-keyword">private</span> DynamicContext delegate;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> index;<br>    <span class="hljs-keyword">private</span> String itemIndex;<br>    <span class="hljs-keyword">private</span> String item;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FilteredDynamicContext</span><span class="hljs-params">(Configuration configuration,DynamicContext delegate, String itemIndex, String item, <span class="hljs-type">int</span> i)</span> &#123;<br>      <span class="hljs-built_in">super</span>(configuration, <span class="hljs-literal">null</span>);<br>      <span class="hljs-built_in">this</span>.delegate = delegate;<br>      <span class="hljs-built_in">this</span>.index = i;<br>      <span class="hljs-built_in">this</span>.itemIndex = itemIndex;<br>      <span class="hljs-built_in">this</span>.item = item;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getBindings</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> delegate.getBindings();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bind</span><span class="hljs-params">(String name, Object value)</span> &#123;<br>      delegate.bind(name, value);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSql</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> delegate.getSql();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appendSql</span><span class="hljs-params">(String sql)</span> &#123;<br>      <span class="hljs-type">GenericTokenParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericTokenParser</span>(<span class="hljs-string">&quot;#&#123;&quot;</span>, <span class="hljs-string">&quot;&#125;&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenHandler</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handleToken</span><span class="hljs-params">(String content)</span> &#123; <br>          <span class="hljs-comment">// åŒ¹é…contentä¸­ç¬¬ä¸€ä¸ªä»¥ç©ºç™½å­—ç¬¦å¼€å¤´ï¼Œå¹¶ä¸”åé¢è·Ÿç€(.|,|:|ç©ºç™½å­—ç¬¦)çš„item</span><br>          <span class="hljs-comment">// å¹¶ä¸”å°†å…¶æ›¿æ¢æˆå¤„ç†åçš„itemï¼ˆåŠ äº†å‰ç¼€å’Œåºå·ï¼‰</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">newContent</span> <span class="hljs-operator">=</span> content.replaceFirst(<span class="hljs-string">&quot;^\\s*&quot;</span> + item + <span class="hljs-string">&quot;(?![^.,:\\s])&quot;</span>, itemizeItem(item, index));<br>          <span class="hljs-keyword">if</span> (itemIndex != <span class="hljs-literal">null</span> &amp;&amp; newContent.equals(content)) &#123;<br>            newContent = content.replaceFirst(<span class="hljs-string">&quot;^\\s*&quot;</span> + itemIndex + <span class="hljs-string">&quot;(?![^.,:\\s])&quot;</span>, itemizeItem(itemIndex, index));<br>          &#125;<br>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-string">&quot;#&#123;&quot;</span>).append(newContent).append(<span class="hljs-string">&quot;&#125;&quot;</span>).toString();<br>        &#125;<br>      &#125;);<br><br>      <span class="hljs-comment">// è¿™é‡Œå§”æ‰˜ç»™ä¸‹é¢çš„ PrefixedContextï¼Œæ‹¼æ¥sqlè¯­å¥æ—¶åŠ ä¸Šå‰ç¼€</span><br>      delegate.appendSql(parser.parse(sql));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUniqueNumber</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> delegate.getUniqueNumber();<br>    &#125;<br><br>  &#125; <br><br>  <span class="hljs-comment">// å‰ç¼€ä¸Šä¸‹æ–‡</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrefixedContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DynamicContext</span> &#123;<br>    <span class="hljs-keyword">private</span> DynamicContext delegate;<br>    <span class="hljs-keyword">private</span> String prefix;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> prefixApplied;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PrefixedContext</span><span class="hljs-params">(DynamicContext delegate, String prefix)</span> &#123;<br>      <span class="hljs-built_in">super</span>(configuration, <span class="hljs-literal">null</span>);<br>      <span class="hljs-built_in">this</span>.delegate = delegate;<br>      <span class="hljs-built_in">this</span>.prefix = prefix;<br>      <span class="hljs-built_in">this</span>.prefixApplied = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isPrefixApplied</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> prefixApplied;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getBindings</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> delegate.getBindings();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bind</span><span class="hljs-params">(String name, Object value)</span> &#123;<br>      delegate.bind(name, value);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appendSql</span><span class="hljs-params">(String sql)</span> &#123;<br>      <span class="hljs-keyword">if</span> (!prefixApplied &amp;&amp; sql != <span class="hljs-literal">null</span> &amp;&amp; sql.trim().length() &gt; <span class="hljs-number">0</span>) &#123;<br>        delegate.appendSql(prefix);<br>        prefixApplied = <span class="hljs-literal">true</span>;<br>      &#125;<br>      delegate.appendSql(sql);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSql</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> delegate.getSql();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUniqueNumber</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> delegate.getUniqueNumber();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="TrimSqlNode"><a href="#TrimSqlNode" class="headerlink" title="TrimSqlNode"></a>TrimSqlNode</h4><p>Â Â Â Â å¯ç”¨äºå¤„ç†sqlè¯­å¥ä¸­ä¸æƒ³è¦çš„å‰ç¼€æˆ–è€…åç¼€ï¼Œå¹¶ä¸”åŠ ä¸Šè‡ªå®šä¹‰çš„å‰ç¼€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrimSqlNode</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlNode</span> &#123; <br><br>  <span class="hljs-keyword">private</span> SqlNode contents;<br>  <span class="hljs-keyword">private</span> String prefix;<br>  <span class="hljs-keyword">private</span> String suffix;<br>  <span class="hljs-keyword">private</span> List&lt;String&gt; prefixesToOverride;<br>  <span class="hljs-keyword">private</span> List&lt;String&gt; suffixesToOverride;<br>  <span class="hljs-keyword">private</span> Configuration configuration; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">TrimSqlNode</span><span class="hljs-params">(Configuration configuration, SqlNode contents, String prefix, String prefixesToOverride, String suffix, String suffixesToOverride)</span> &#123;<br>    <span class="hljs-built_in">this</span>(configuration, contents, prefix, parseOverrides(prefixesToOverride), suffix, parseOverrides(suffixesToOverride));<br>  &#125;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">TrimSqlNode</span><span class="hljs-params">(Configuration configuration, SqlNode contents, String prefix, List&lt;String&gt; prefixesToOverride, String suffix, List&lt;String&gt; suffixesToOverride)</span> &#123;<br>    <span class="hljs-built_in">this</span>.contents = contents;<br>    <span class="hljs-built_in">this</span>.prefix = prefix;<br>    <span class="hljs-built_in">this</span>.prefixesToOverride = prefixesToOverride;<br>    <span class="hljs-built_in">this</span>.suffix = suffix;<br>    <span class="hljs-built_in">this</span>.suffixesToOverride = suffixesToOverride;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>  &#125; <br><br>  <span class="hljs-comment">// å¤„ç†ä»¥|åˆ†éš”çš„string</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">parseOverrides</span><span class="hljs-params">(String overrides)</span> &#123;<br>    <span class="hljs-keyword">if</span> (overrides != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">StringTokenizer</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTokenizer</span>(overrides, <span class="hljs-string">&quot;|&quot;</span>, <span class="hljs-literal">false</span>);<br>      <span class="hljs-keyword">final</span> List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;(parser.countTokens());<br>      <span class="hljs-keyword">while</span> (parser.hasMoreTokens()) &#123;<br>        list.add(parser.nextToken().toUpperCase(Locale.ENGLISH));<br>      &#125;<br>      <span class="hljs-keyword">return</span> list;<br>    &#125;<br>    <span class="hljs-keyword">return</span> Collections.emptyList();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span> &#123;<br>    <span class="hljs-type">FilteredDynamicContext</span> <span class="hljs-variable">filteredDynamicContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilteredDynamicContext</span>(context);<br>    <span class="hljs-comment">// å…ˆè°ƒç”¨sqlnodeçš„applyæ–¹æ³•æ·»åŠ sqlè¯­å¥</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> contents.apply(filteredDynamicContext); <br>    <span class="hljs-comment">// å¤„ç†sqlè¯­å¥ä¸­å‰ç¼€æˆ–åç¼€</span><br>    filteredDynamicContext.applyAll();<br>    <span class="hljs-keyword">return</span> result;<br>  &#125; <br><br>  <span class="hljs-comment">// æ›¿æ¢å‰ç¼€å’Œåç¼€ï¼Œé‡å†™äº† DynamicContext çš„appendSqlå’ŒgetSqlæ–¹æ³•</span><br>  <span class="hljs-comment">// å…ˆappendSqlï¼Œç„¶åè°ƒç”¨applyAllè¿›è¡Œå¤„ç†ï¼Œæœ€åè°ƒç”¨getSql</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilteredDynamicContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DynamicContext</span> &#123;<br>    <span class="hljs-keyword">private</span> DynamicContext delegate;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> prefixApplied;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> suffixApplied;<br>    <span class="hljs-keyword">private</span> StringBuilder sqlBuffer;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FilteredDynamicContext</span><span class="hljs-params">(DynamicContext delegate)</span> &#123;<br>      <span class="hljs-built_in">super</span>(configuration, <span class="hljs-literal">null</span>);<br>      <span class="hljs-built_in">this</span>.delegate = delegate;<br>      <span class="hljs-built_in">this</span>.prefixApplied = <span class="hljs-literal">false</span>;<br>      <span class="hljs-built_in">this</span>.suffixApplied = <span class="hljs-literal">false</span>;<br>      <span class="hljs-built_in">this</span>.sqlBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyAll</span><span class="hljs-params">()</span> &#123;<br>      sqlBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(sqlBuffer.toString().trim());<br>      <span class="hljs-type">String</span> <span class="hljs-variable">trimmedUppercaseSql</span> <span class="hljs-operator">=</span> sqlBuffer.toString().toUpperCase(Locale.ENGLISH);<br>      <span class="hljs-keyword">if</span> (trimmedUppercaseSql.length() &gt; <span class="hljs-number">0</span>) &#123;<br>        applyPrefix(sqlBuffer, trimmedUppercaseSql);<br>        applySuffix(sqlBuffer, trimmedUppercaseSql);<br>      &#125;<br>      delegate.appendSql(sqlBuffer.toString());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getBindings</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> delegate.getBindings();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bind</span><span class="hljs-params">(String name, Object value)</span> &#123;<br>      delegate.bind(name, value);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUniqueNumber</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> delegate.getUniqueNumber();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">appendSql</span><span class="hljs-params">(String sql)</span> &#123;<br>      sqlBuffer.append(sql);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSql</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> delegate.getSql();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyPrefix</span><span class="hljs-params">(StringBuilder sql, String trimmedUppercaseSql)</span> &#123;<br>      <span class="hljs-keyword">if</span> (!prefixApplied) &#123;<br>        prefixApplied = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (prefixesToOverride != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">for</span> (String toRemove : prefixesToOverride) &#123;<br>            <span class="hljs-keyword">if</span> (trimmedUppercaseSql.startsWith(toRemove)) &#123;<br>              sql.delete(<span class="hljs-number">0</span>, toRemove.trim().length());<br>              <span class="hljs-keyword">break</span>;<br>            &#125;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (prefix != <span class="hljs-literal">null</span>) &#123;<br>          sql.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&quot; &quot;</span>);<br>          sql.insert(<span class="hljs-number">0</span>, prefix);<br>        &#125;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applySuffix</span><span class="hljs-params">(StringBuilder sql, String trimmedUppercaseSql)</span> &#123;<br>      <span class="hljs-keyword">if</span> (!suffixApplied) &#123;<br>        suffixApplied = <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">if</span> (suffixesToOverride != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">for</span> (String toRemove : suffixesToOverride) &#123;<br>            <span class="hljs-keyword">if</span> (trimmedUppercaseSql.endsWith(toRemove) || trimmedUppercaseSql.endsWith(toRemove.trim())) &#123;<br>              <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> sql.length() - toRemove.trim().length();<br>              <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> sql.length();<br>              sql.delete(start, end);<br>              <span class="hljs-keyword">break</span>;<br>            &#125;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (suffix != <span class="hljs-literal">null</span>) &#123;<br>          sql.append(<span class="hljs-string">&quot; &quot;</span>);<br>          sql.append(suffix);<br>        &#125;<br>      &#125;<br>    &#125;<br><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SetSqlNode"><a href="#SetSqlNode" class="headerlink" title="SetSqlNode"></a>SetSqlNode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SetSqlNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TrimSqlNode</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;String&gt; suffixList = Arrays.asList(<span class="hljs-string">&quot;,&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SetSqlNode</span><span class="hljs-params">(Configuration configuration,SqlNode contents)</span> &#123; <br>    <span class="hljs-comment">// setè¯­å¥ï¼Œå‰ç¼€ä¸ºsetï¼Œä¸è¦è¯­å¥æœ€åçš„,</span><br>    <span class="hljs-built_in">super</span>(configuration, contents, <span class="hljs-string">&quot;SET&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, suffixList);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="WhereSqlNode"><a href="#WhereSqlNode" class="headerlink" title="WhereSqlNode"></a>WhereSqlNode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WhereSqlNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TrimSqlNode</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;String&gt; prefixList = Arrays.asList(<span class="hljs-string">&quot;AND &quot;</span>,<span class="hljs-string">&quot;OR &quot;</span>,<span class="hljs-string">&quot;AND\n&quot;</span>, <span class="hljs-string">&quot;OR\n&quot;</span>, <span class="hljs-string">&quot;AND\r&quot;</span>, <span class="hljs-string">&quot;OR\r&quot;</span>, <span class="hljs-string">&quot;AND\t&quot;</span>, <span class="hljs-string">&quot;OR\t&quot;</span>);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">WhereSqlNode</span><span class="hljs-params">(Configuration configuration, SqlNode contents)</span> &#123; <br>    <span class="hljs-comment">// whereè¯­å¥ï¼Œå‰ç¼€ä¸ºwhereï¼Œä¸è¦è¯­å¥ä¹‹å‰çš„andã€or</span><br>    <span class="hljs-built_in">super</span>(configuration, contents, <span class="hljs-string">&quot;WHERE&quot;</span>, prefixList, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MixedSqlNode"><a href="#MixedSqlNode" class="headerlink" title="MixedSqlNode"></a>MixedSqlNode</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MixedSqlNode</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlNode</span> &#123;<br>  <span class="hljs-comment">// ç»„åˆæ¨¡å¼ï¼Œæ‹¥æœ‰ä¸€ä¸ªSqlNodeçš„List</span><br>  <span class="hljs-keyword">private</span> List&lt;SqlNode&gt; contents;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MixedSqlNode</span><span class="hljs-params">(List&lt;SqlNode&gt; contents)</span> &#123;<br>    <span class="hljs-built_in">this</span>.contents = contents;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(DynamicContext context)</span> &#123;<br>    <span class="hljs-comment">// ä¾æ¬¡è°ƒç”¨listé‡Œæ¯ä¸ªå…ƒç´ çš„apply</span><br>    <span class="hljs-keyword">for</span> (SqlNode sqlNode : contents) &#123;<br>      sqlNode.apply(context);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SqlSource"><a href="#SqlSource" class="headerlink" title="SqlSource"></a>SqlSource</h4><p>Â Â Â Â SQLæºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SqlSource</span> &#123;<br><br>  BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">(Object parameterObject)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SqlSourceBuilder"><a href="#SqlSourceBuilder" class="headerlink" title="SqlSourceBuilder"></a>SqlSourceBuilder</h4><p>Â Â Â Â SQLæºç æ„å»ºå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSourceBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">parameterProperties</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;javaType,jdbcType,mode,numericScale,resultMap,typeHandler,jdbcTypeName&quot;</span>;<br> <br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SqlSourceBuilder</span><span class="hljs-params">(Configuration configuration)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> SqlSource <span class="hljs-title function_">parse</span><span class="hljs-params">(String originalSql, Class&lt;?&gt; parameterType, Map&lt;String, Object&gt; additionalParameters)</span> &#123;<br>    <span class="hljs-type">ParameterMappingTokenHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMappingTokenHandler</span>(configuration, parameterType, additionalParameters);<br>    <span class="hljs-comment">// æ›¿æ¢#&#123;&#125;ä¸­é—´çš„éƒ¨åˆ†,å¦‚ä½•æ›¿æ¢ï¼Œé€»è¾‘åœ¨ParameterMappingTokenHandler </span><br>    <span class="hljs-comment">// å°±æ˜¯æ›¿æ¢æˆ?,ç„¶åå°†æ›¿æ¢åçš„å€¼å¡åˆ° parameterMappings ä¸­</span><br>    <span class="hljs-type">GenericTokenParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericTokenParser</span>(<span class="hljs-string">&quot;#&#123;&quot;</span>, <span class="hljs-string">&quot;&#125;&quot;</span>, handler);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> parser.parse(originalSql);<br>    <span class="hljs-comment">// è¿”å›é™æ€SQLæºç </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StaticSqlSource</span>(configuration, sql, handler.getParameterMappings());<br>  &#125; <br><br>  <span class="hljs-comment">// å‚æ•°æ˜ å°„è®°å·å¤„ç†å™¨ï¼Œé™æ€å†…éƒ¨ç±»</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterMappingTokenHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TokenHandler</span> &#123; <br><br>    <span class="hljs-keyword">private</span> List&lt;ParameterMapping&gt; parameterMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ParameterMapping&gt;();<br>    <span class="hljs-keyword">private</span> Class&lt;?&gt; parameterType;<br>    <span class="hljs-keyword">private</span> MetaObject metaParameters; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ParameterMappingTokenHandler</span><span class="hljs-params">(Configuration configuration, Class&lt;?&gt; parameterType, Map&lt;String, Object&gt; additionalParameters)</span> &#123;<br>      <span class="hljs-built_in">super</span>(configuration);<br>      <span class="hljs-built_in">this</span>.parameterType = parameterType;<br>      <span class="hljs-built_in">this</span>.metaParameters = configuration.newMetaObject(additionalParameters);<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> List&lt;ParameterMapping&gt; <span class="hljs-title function_">getParameterMappings</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> parameterMappings;<br>    &#125; <br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handleToken</span><span class="hljs-params">(String content)</span> &#123;<br>      <span class="hljs-comment">// å…ˆæ„å»ºå‚æ•°æ˜ å°„</span><br>      parameterMappings.add(buildParameterMapping(content));<br>      <span class="hljs-comment">// å¦‚ä½•æ›¿æ¢å¾ˆç®€å•ï¼Œæ°¸è¿œæ˜¯ä¸€ä¸ªé—®å·ï¼Œä½†æ˜¯å‚æ•°çš„ä¿¡æ¯è¦è®°å½•åœ¨parameterMappingsé‡Œé¢ä¾›åç»­ä½¿ç”¨</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;?&quot;</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// æ„å»ºå‚æ•°æ˜ å°„</span><br>    <span class="hljs-keyword">private</span> ParameterMapping <span class="hljs-title function_">buildParameterMapping</span><span class="hljs-params">(String content)</span> &#123;<br>      <span class="hljs-comment">// #&#123;favouriteSection,jdbcType=VARCHAR&#125;</span><br>      <span class="hljs-comment">// å…ˆè§£æå‚æ•°æ˜ å°„,å°±æ˜¯è½¬åŒ–æˆä¸€ä¸ªhashmap</span><br>      Map&lt;String, String&gt; propertiesMap = parseParameterMapping(content);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> propertiesMap.get(<span class="hljs-string">&quot;property&quot;</span>);<br>      Class&lt;?&gt; propertyType;<br>      <span class="hljs-comment">// è¿™é‡Œåˆ†æ”¯æ¯”è¾ƒå¤šï¼Œéœ€è¦é€ä¸ªç†è§£ </span><br>      <span class="hljs-comment">// å…ˆæ¨æ–­å‚æ•°çš„javaç±»å‹</span><br>      <span class="hljs-keyword">if</span> (metaParameters.hasGetter(property)) &#123; <span class="hljs-comment">// issue #448 get type from additional params</span><br>        propertyType = metaParameters.getGetterType(property);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (typeHandlerRegistry.hasTypeHandler(parameterType)) &#123;<br>        propertyType = parameterType;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (JdbcType.CURSOR.name().equals(propertiesMap.get(<span class="hljs-string">&quot;jdbcType&quot;</span>))) &#123;<br>        propertyType = java.sql.ResultSet.class;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (property != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaClass</span> <span class="hljs-operator">=</span> MetaClass.forClass(parameterType);<br>        <span class="hljs-keyword">if</span> (metaClass.hasGetter(property)) &#123;<br>          propertyType = metaClass.getGetterType(property);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          propertyType = Object.class;<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        propertyType = Object.class;<br>      &#125;<br>      ParameterMapping.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMapping</span>.Builder(configuration, property, propertyType);<br>      Class&lt;?&gt; javaType = propertyType;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">typeHandlerAlias</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : propertiesMap.entrySet()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> entry.getKey();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> entry.getValue(); <br>        <span class="hljs-comment">// ç”¨æˆ·æŒ‡å®šäº†javaç±»å‹ï¼Œè¦†ç›–æ¨æ–­çš„javaç±»å‹</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;javaType&quot;</span>.equals(name)) &#123;<br>          javaType = resolveClass(value);<br>          builder.javaType(javaType);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;jdbcType&quot;</span>.equals(name)) &#123;<br>          builder.jdbcType(resolveJdbcType(value));<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;mode&quot;</span>.equals(name)) &#123;<br>          builder.mode(resolveParameterMode(value));<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;numericScale&quot;</span>.equals(name)) &#123;<br>          builder.numericScale(Integer.valueOf(value));<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;resultMap&quot;</span>.equals(name)) &#123;<br>          builder.resultMapId(value);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;typeHandler&quot;</span>.equals(name)) &#123;<br>          typeHandlerAlias = value;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;jdbcTypeName&quot;</span>.equals(name)) &#123;<br>          builder.jdbcTypeName(value);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;property&quot;</span>.equals(name)) &#123;<br>          <span class="hljs-comment">// Do Nothing</span><br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;expression&quot;</span>.equals(name)) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Expression based parameters are not supported yet&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;An invalid property &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27; was found in mapping #&#123;&quot;</span> + content + <span class="hljs-string">&quot;&#125;.  Valid properties are &quot;</span> + parameterProperties);<br>        &#125;<br>      &#125;<br>      <span class="hljs-comment">// #&#123;age,javaType=int,jdbcType=NUMERIC,typeHandler=MyTypeHandler&#125;</span><br>      <span class="hljs-keyword">if</span> (typeHandlerAlias != <span class="hljs-literal">null</span>) &#123;<br>        builder.typeHandler(resolveTypeHandler(javaType, typeHandlerAlias));<br>      &#125;<br>      <span class="hljs-keyword">return</span> builder.build();<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; <span class="hljs-title function_">parseParameterMapping</span><span class="hljs-params">(String content)</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123; <br>        <span class="hljs-comment">// å°†ç±»ä¼¼ #&#123;property,javaType=int,jdbcType=NUMERIC&#125;çš„è¡¨è¾¾å¼è§£ææˆmap</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterExpression</span>(content);<br>      &#125; <span class="hljs-keyword">catch</span> (BuilderException ex) &#123;<br>        <span class="hljs-keyword">throw</span> ex;<br>      &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Parsing error was found in mapping #&#123;&quot;</span> + content + <span class="hljs-string">&quot;&#125;.  Check syntax #&#123;property|(expression), var1=value1, var2=value2, ...&#125; &quot;</span>, ex);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DynamicSqlSource"><a href="#DynamicSqlSource" class="headerlink" title="DynamicSqlSource"></a>DynamicSqlSource</h4><p>Â Â Â Â åŠ¨æ€SQLæºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicSqlSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSource</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Configuration configuration;<br>  <span class="hljs-keyword">private</span> SqlNode rootSqlNode;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DynamicSqlSource</span><span class="hljs-params">(Configuration configuration, SqlNode rootSqlNode)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.rootSqlNode = rootSqlNode;<br>  &#125;<br><br>  <span class="hljs-comment">// å¾—åˆ°ç»‘å®šçš„SQL</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">(Object parameterObject)</span> &#123;<br>    <span class="hljs-comment">// ç”Ÿæˆä¸€ä¸ªåŠ¨æ€ä¸Šä¸‹æ–‡</span><br>    <span class="hljs-type">DynamicContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicContext</span>(configuration, parameterObject);<br><span class="hljs-comment">// è¿™é‡ŒSqlNode.applyåªæ˜¯å°†$&#123;&#125;è¿™ç§å‚æ•°æ›¿æ¢æ‰ï¼Œå¹¶æ²¡æœ‰æ›¿æ¢#&#123;&#125;è¿™ç§å‚æ•°</span><br>    rootSqlNode.apply(context);<br><span class="hljs-comment">// è°ƒç”¨SqlSourceBuilder</span><br>    <span class="hljs-type">SqlSourceBuilder</span> <span class="hljs-variable">sqlSourceParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSourceBuilder</span>(configuration);<br>    Class&lt;?&gt; parameterType = parameterObject == <span class="hljs-literal">null</span> ? Object.class : parameterObject.getClass();<br><span class="hljs-comment">// SqlSourceBuilder.parse,æ³¨æ„è¿™é‡Œè¿”å›çš„æ˜¯StaticSqlSource,è§£æå®Œäº†å°±æŠŠé‚£äº›å‚æ•°éƒ½æ›¿æ¢æˆ?äº†ï¼Œä¹Ÿå°±æ˜¯æœ€åŸºæœ¬çš„JDBCçš„SQLå†™æ³•</span><br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> sqlSourceParser.parse(context.getSql(), parameterType, context.getBindings());<br><span class="hljs-comment">// çœ‹ä¼¼æ˜¯åˆå»é€’å½’è°ƒç”¨SqlSource.getBoundSqlï¼Œå…¶å®å› ä¸ºæ˜¯StaticSqlSourceï¼Œæ‰€ä»¥æ²¡é—®é¢˜ï¼Œä¸æ˜¯é€’å½’è°ƒç”¨</span><br>    <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> sqlSource.getBoundSql(parameterObject);<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : context.getBindings().entrySet()) &#123;<br>      boundSql.setAdditionalParameter(entry.getKey(), entry.getValue());<br>    &#125;<br>    <span class="hljs-keyword">return</span> boundSql;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="XMLScriptBuilder"><a href="#XMLScriptBuilder" class="headerlink" title="XMLScriptBuilder"></a>XMLScriptBuilder</h4><p>Â Â Â Â XMLè„šæœ¬æ„å»ºå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLScriptBuilder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseBuilder</span> &#123; <br><br>  <span class="hljs-keyword">private</span> XNode context;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> isDynamic;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; parameterType; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLScriptBuilder</span><span class="hljs-params">(Configuration configuration, XNode context)</span> &#123;<br>    <span class="hljs-built_in">this</span>(configuration, context, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XMLScriptBuilder</span><span class="hljs-params">(Configuration configuration, XNode context, Class&lt;?&gt; parameterType)</span> &#123;<br>    <span class="hljs-built_in">super</span>(configuration);<br>    <span class="hljs-built_in">this</span>.context = context;<br>    <span class="hljs-built_in">this</span>.parameterType = parameterType;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> SqlSource <span class="hljs-title function_">parseScriptNode</span><span class="hljs-params">()</span> &#123;<br>    List&lt;SqlNode&gt; contents = parseDynamicTags(context);<br>    <span class="hljs-type">MixedSqlNode</span> <span class="hljs-variable">rootSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MixedSqlNode</span>(contents);<br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">sqlSource</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (isDynamic) &#123;<br>      sqlSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicSqlSource</span>(configuration, rootSqlNode);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      sqlSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawSqlSource</span>(configuration, rootSqlNode, parameterType);<br>    &#125;<br>    <span class="hljs-keyword">return</span> sqlSource;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æXNodeä¸ºSqlNode</span><br>  List&lt;SqlNode&gt; <span class="hljs-title function_">parseDynamicTags</span><span class="hljs-params">(XNode node)</span> &#123;<br>    List&lt;SqlNode&gt; contents = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;SqlNode&gt;();<br>    <span class="hljs-type">NodeList</span> <span class="hljs-variable">children</span> <span class="hljs-operator">=</span> node.getNode().getChildNodes();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; children.getLength(); i++) &#123;<br>      <span class="hljs-type">XNode</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> node.newXNode(children.item(i)); <br>      <span class="hljs-comment">// TEXT_NODE æˆ–è€… CDATA_SECTION_NODE è½¬æ¢æˆ TextSqlNode</span><br>      <span class="hljs-keyword">if</span> (child.getNode().getNodeType() == Node.CDATA_SECTION_NODE || child.getNode().getNodeType() == Node.TEXT_NODE) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> child.getStringBody(<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-type">TextSqlNode</span> <span class="hljs-variable">textSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextSqlNode</span>(data);<br>        <span class="hljs-keyword">if</span> (textSqlNode.isDynamic()) &#123;<br>          contents.add(textSqlNode);<br>          isDynamic = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          contents.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StaticTextSqlNode</span>(data));<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (child.getNode().getNodeType() == Node.ELEMENT_NODE) &#123; <span class="hljs-comment">// issue #628</span><br>        <span class="hljs-comment">// ELEMENT_NODE æ ¹æ®åç§°è½¬æ¢æˆå¯¹åº”çš„SqlNode</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">nodeName</span> <span class="hljs-operator">=</span> child.getNode().getNodeName();<br>        <span class="hljs-type">NodeHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> nodeHandlers(nodeName);<br>        <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Unknown element &lt;&quot;</span> + nodeName + <span class="hljs-string">&quot;&gt; in SQL statement.&quot;</span>);<br>        &#125;<br>        handler.handleNode(child, contents);<br>        isDynamic = <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> contents;<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¹æ®åç§°è·å– SqlNode å¯¹åº”çš„ NodeHandler</span><br>  NodeHandler <span class="hljs-title function_">nodeHandlers</span><span class="hljs-params">(String nodeName)</span> &#123;<br>    Map&lt;String, NodeHandler&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, NodeHandler&gt;();<br>    map.put(<span class="hljs-string">&quot;trim&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrimHandler</span>());<br>    map.put(<span class="hljs-string">&quot;where&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">WhereHandler</span>());<br>    map.put(<span class="hljs-string">&quot;set&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetHandler</span>());<br>    map.put(<span class="hljs-string">&quot;foreach&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForEachHandler</span>());<br>    map.put(<span class="hljs-string">&quot;if&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IfHandler</span>());<br>    map.put(<span class="hljs-string">&quot;choose&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChooseHandler</span>());<br>    map.put(<span class="hljs-string">&quot;when&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IfHandler</span>());<br>    map.put(<span class="hljs-string">&quot;otherwise&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">OtherwiseHandler</span>());<br>    map.put(<span class="hljs-string">&quot;bind&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindHandler</span>());<br>    <span class="hljs-keyword">return</span> map.get(nodeName);<br>  &#125; <br><br>  <span class="hljs-comment">// NodeHandleråŸºæœ¬ä¸Šéƒ½æ˜¯è·å–éœ€è¦çš„å€¼ï¼Œç„¶åç»„è£…æˆå¯¹åº”çš„SqlNodeï¼Œå¡åˆ°targetContentsä¸­</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">NodeHandler</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNode</span><span class="hljs-params">(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents)</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// å¯¹åº”VarDeclSqlNode</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BindHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NodeHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BindHandler</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNode</span><span class="hljs-params">(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents)</span> &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;value&quot;</span>);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">VarDeclSqlNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VarDeclSqlNode</span>(name, expression);<br>      targetContents.add(node);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrimHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NodeHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TrimHandler</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNode</span><span class="hljs-params">(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents)</span> &#123;<br>      <span class="hljs-comment">// å¤„ç† TrimSqlNode çš„å­node</span><br>      List&lt;SqlNode&gt; contents = parseDynamicTags(nodeToHandle); <br>      <span class="hljs-type">MixedSqlNode</span> <span class="hljs-variable">mixedSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MixedSqlNode</span>(contents);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">prefix</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;prefix&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">prefixOverrides</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;prefixOverrides&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">suffix</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;suffix&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">suffixOverrides</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;suffixOverrides&quot;</span>);<br>      <span class="hljs-type">TrimSqlNode</span> <span class="hljs-variable">trim</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrimSqlNode</span>(configuration, mixedSqlNode, prefix, prefixOverrides, suffix, suffixOverrides);<br>      targetContents.add(trim);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WhereHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NodeHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WhereHandler</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNode</span><span class="hljs-params">(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents)</span> &#123;<br>      List&lt;SqlNode&gt; contents = parseDynamicTags(nodeToHandle);<br>      <span class="hljs-type">MixedSqlNode</span> <span class="hljs-variable">mixedSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MixedSqlNode</span>(contents);<br>      <span class="hljs-type">WhereSqlNode</span> <span class="hljs-variable">where</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WhereSqlNode</span>(configuration, mixedSqlNode);<br>      targetContents.add(where);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SetHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NodeHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SetHandler</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNode</span><span class="hljs-params">(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents)</span> &#123;<br>      List&lt;SqlNode&gt; contents = parseDynamicTags(nodeToHandle);<br>      <span class="hljs-type">MixedSqlNode</span> <span class="hljs-variable">mixedSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MixedSqlNode</span>(contents);<br>      <span class="hljs-type">SetSqlNode</span> <span class="hljs-variable">set</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetSqlNode</span>(configuration, mixedSqlNode);<br>      targetContents.add(set);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForEachHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NodeHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ForEachHandler</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNode</span><span class="hljs-params">(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents)</span> &#123;<br>      List&lt;SqlNode&gt; contents = parseDynamicTags(nodeToHandle);<br>      <span class="hljs-type">MixedSqlNode</span> <span class="hljs-variable">mixedSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MixedSqlNode</span>(contents);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">collection</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;collection&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;item&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;index&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">open</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;open&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">close</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;close&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">separator</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;separator&quot;</span>);<br>      <span class="hljs-type">ForEachSqlNode</span> <span class="hljs-variable">forEachSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForEachSqlNode</span>(configuration, mixedSqlNode, collection, index, item, open, close, separator);<br>      targetContents.add(forEachSqlNode);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IfHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NodeHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IfHandler</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNode</span><span class="hljs-params">(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents)</span> &#123;<br>      List&lt;SqlNode&gt; contents = parseDynamicTags(nodeToHandle);<br>      <span class="hljs-type">MixedSqlNode</span> <span class="hljs-variable">mixedSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MixedSqlNode</span>(contents);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> nodeToHandle.getStringAttribute(<span class="hljs-string">&quot;test&quot;</span>);<br>      <span class="hljs-type">IfSqlNode</span> <span class="hljs-variable">ifSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IfSqlNode</span>(mixedSqlNode, test);<br>      targetContents.add(ifSqlNode);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OtherwiseHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NodeHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OtherwiseHandler</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNode</span><span class="hljs-params">(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents)</span> &#123;<br>      List&lt;SqlNode&gt; contents = parseDynamicTags(nodeToHandle);<br>      <span class="hljs-type">MixedSqlNode</span> <span class="hljs-variable">mixedSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MixedSqlNode</span>(contents);<br>      targetContents.add(mixedSqlNode);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChooseHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NodeHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChooseHandler</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleNode</span><span class="hljs-params">(XNode nodeToHandle, List&lt;SqlNode&gt; targetContents)</span> &#123;<br>      List&lt;SqlNode&gt; whenSqlNodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;SqlNode&gt;();<br>      List&lt;SqlNode&gt; otherwiseSqlNodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;SqlNode&gt;();<br>      handleWhenOtherwiseNodes(nodeToHandle, whenSqlNodes, otherwiseSqlNodes);<br>      <span class="hljs-type">SqlNode</span> <span class="hljs-variable">defaultSqlNode</span> <span class="hljs-operator">=</span> getDefaultSqlNode(otherwiseSqlNodes);<br>      <span class="hljs-type">ChooseSqlNode</span> <span class="hljs-variable">chooseSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChooseSqlNode</span>(whenSqlNodes, defaultSqlNode);<br>      targetContents.add(chooseSqlNode);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleWhenOtherwiseNodes</span><span class="hljs-params">(XNode chooseSqlNode, List&lt;SqlNode&gt; ifSqlNodes, List&lt;SqlNode&gt; defaultSqlNodes)</span> &#123;<br>      List&lt;XNode&gt; children = chooseSqlNode.getChildren();<br>      <span class="hljs-keyword">for</span> (XNode child : children) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">nodeName</span> <span class="hljs-operator">=</span> child.getNode().getNodeName();<br>        <span class="hljs-type">NodeHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> nodeHandlers(nodeName);<br>        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> IfHandler) &#123;<br>          handler.handleNode(child, ifSqlNodes);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> OtherwiseHandler) &#123;<br>          handler.handleNode(child, defaultSqlNodes);<br>        &#125;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> SqlNode <span class="hljs-title function_">getDefaultSqlNode</span><span class="hljs-params">(List&lt;SqlNode&gt; defaultSqlNodes)</span> &#123;<br>      <span class="hljs-type">SqlNode</span> <span class="hljs-variable">defaultSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">if</span> (defaultSqlNodes.size() == <span class="hljs-number">1</span>) &#123;<br>        defaultSqlNode = defaultSqlNodes.get(<span class="hljs-number">0</span>);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (defaultSqlNodes.size() &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Too many default (otherwise) elements in choose statement.&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">return</span> defaultSqlNode;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="XMLLanguageDriver"><a href="#XMLLanguageDriver" class="headerlink" title="XMLLanguageDriver"></a>XMLLanguageDriver</h4><p>Â Â Â Â XMLè¯­è¨€é©±åŠ¨ï¼Œä»XMLæ–‡ä»¶æ„å»ºSqlSource</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XMLLanguageDriver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LanguageDriver</span> &#123; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> ParameterHandler <span class="hljs-title function_">createParameterHandler</span><span class="hljs-params">(MappedStatement mappedStatement, Object parameterObject, BoundSql boundSql)</span> &#123;<br>    <span class="hljs-comment">// è¿”å›é»˜è®¤çš„å‚æ•°å¤„ç†å™¨</span><br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultParameterHandler</span>(mappedStatement, parameterObject, boundSql);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSource <span class="hljs-title function_">createSqlSource</span><span class="hljs-params">(Configuration configuration, XNode script, Class&lt;?&gt; parameterType)</span> &#123;<br><span class="hljs-comment">// ç”¨XMLè„šæœ¬æ„å»ºå™¨è§£æ</span><br>    <span class="hljs-type">XMLScriptBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLScriptBuilder</span>(configuration, script, parameterType);<br>    <span class="hljs-keyword">return</span> builder.parseScriptNode();<br>  &#125; <br><br>  <span class="hljs-comment">// æ³¨è§£æ–¹å¼æ„å»ºmapperï¼Œä¸€èˆ¬ä¸ç”¨ï¼Œå¯ä»¥æš‚æ—¶å¿½ç•¥</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSource <span class="hljs-title function_">createSqlSource</span><span class="hljs-params">(Configuration configuration, String script, Class&lt;?&gt; parameterType)</span> &#123;<br>    <span class="hljs-comment">// issue #3 </span><br>    <span class="hljs-comment">// åœ¨æ³¨è§£ä¸­å†™xmlè„šæœ¬ï¼Œç‹ äººä¸€ä¸ª</span><br>    <span class="hljs-keyword">if</span> (script.startsWith(<span class="hljs-string">&quot;&lt;script&gt;&quot;</span>)) &#123;<br>      <span class="hljs-type">XPathParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XPathParser</span>(script, <span class="hljs-literal">false</span>, configuration.getVariables(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLMapperEntityResolver</span>());<br>      <span class="hljs-keyword">return</span> createSqlSource(configuration, parser.evalNode(<span class="hljs-string">&quot;/script&quot;</span>), parameterType);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// issue #127</span><br>      script = PropertyParser.parse(script, configuration.getVariables());<br>      <span class="hljs-type">TextSqlNode</span> <span class="hljs-variable">textSqlNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextSqlNode</span>(script);<br>      <span class="hljs-comment">// ä¸€ç§æ˜¯åŠ¨æ€ï¼Œä¸€ç§æ˜¯åŸå§‹</span><br>      <span class="hljs-keyword">if</span> (textSqlNode.isDynamic()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicSqlSource</span>(configuration, textSqlNode);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawSqlSource</span>(configuration, script, parameterType);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="RawLanguageDriver"><a href="#RawLanguageDriver" class="headerlink" title="RawLanguageDriver"></a>RawLanguageDriver</h4><p>Â Â Â Â  Â ä»3.2.4å¼€å§‹é»˜è®¤çš„XMLè¯­è¨€èƒ½è¯†åˆ«é™æ€è¯­å¥å¹¶ä¸”åˆ›å»º<code>RawSqlSource</code>ï¼Œæ‰€ä»¥é™¤éä½ æƒ³è¦ç¡®è®¤æ²¡æœ‰ä»»ä½•åŠ¨æ€æ ‡ç­¾ï¼Œå¦åˆ™ä¸éœ€è¦ä½¿ç”¨<code>RawLanguageDriver</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RawLanguageDriver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">XMLLanguageDriver</span> &#123; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSource <span class="hljs-title function_">createSqlSource</span><span class="hljs-params">(Configuration configuration, XNode script, Class&lt;?&gt; parameterType)</span> &#123;<br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.createSqlSource(configuration, script, parameterType);<br>    checkIsNotDynamic(source);<br>    <span class="hljs-keyword">return</span> source;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSource <span class="hljs-title function_">createSqlSource</span><span class="hljs-params">(Configuration configuration, String script, Class&lt;?&gt; parameterType)</span> &#123;<br>    <span class="hljs-type">SqlSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.createSqlSource(configuration, script, parameterType);<br>    checkIsNotDynamic(source);<br>    <span class="hljs-keyword">return</span> source;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkIsNotDynamic</span><span class="hljs-params">(SqlSource source)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!RawSqlSource.class.equals(source.getClass())) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Dynamic content is not allowed when using RAW language&quot;</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="RawSqlSource"><a href="#RawSqlSource" class="headerlink" title="RawSqlSource"></a>RawSqlSource</h4><p>Â Â Â Â åŸå§‹SQLæºç ï¼Œæ¯”DynamicSqlSourceå¿«</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RawSqlSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSource</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">RawSqlSource</span><span class="hljs-params">(Configuration configuration, SqlNode rootSqlNode, Class&lt;?&gt; parameterType)</span> &#123;<br>    <span class="hljs-built_in">this</span>(configuration, getSql(configuration, rootSqlNode), parameterType);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">RawSqlSource</span><span class="hljs-params">(Configuration configuration, String sql, Class&lt;?&gt; parameterType)</span> &#123;<br>    <span class="hljs-type">SqlSourceBuilder</span> <span class="hljs-variable">sqlSourceParser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSourceBuilder</span>(configuration);<br>    Class&lt;?&gt; clazz = parameterType == <span class="hljs-literal">null</span> ? Object.class : parameterType;<br>    sqlSource = sqlSourceParser.parse(sql, clazz, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;());<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSql</span><span class="hljs-params">(Configuration configuration, SqlNode rootSqlNode)</span> &#123;<br>    <span class="hljs-type">DynamicContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicContext</span>(configuration, <span class="hljs-literal">null</span>);<br>    rootSqlNode.apply(context);<br>    <span class="hljs-keyword">return</span> context.getSql();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">(Object parameterObject)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSource.getBoundSql(parameterObject);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>12-mapping</title>
    <link href="/2023/07/18/mybatis-source-code/12-mapping/"/>
    <url>/2023/07/18/mybatis-source-code/12-mapping/</url>
    
    <content type="html"><![CDATA[<h4 id="DatabaseIdProvider"><a href="#DatabaseIdProvider" class="headerlink" title="DatabaseIdProvider"></a>DatabaseIdProvider</h4><p>â€‹ åº”è¯¥è¿”å›ä¸€ä¸ªidæ¥æ ‡è¯†è¯¥æ•°æ®åº“çš„ç±»å‹ã€‚è¯¥idå¯ä»¥åœ¨ä»¥åç”¨äºä¸ºæ¯ç§æ•°æ®åº“ç±»å‹æ„å»ºä¸åŒçš„æŸ¥è¯¢ã€‚è¿™ç§æœºåˆ¶æ”¯æŒå¤šä¸ªä¾›åº”å•†æˆ–ç‰ˆæœ¬</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DatabaseIdProvider</span> &#123;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties p)</span>;<br><br>  <span class="hljs-comment">// æ ¹æ®æ•°æ®æºæ¥å¾—åˆ°ä¸€ä¸ªDB id</span><br>  String <span class="hljs-title function_">getDatabaseId</span><span class="hljs-params">(DataSource dataSource)</span> <span class="hljs-keyword">throws</span> SQLException;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="VendorDatabaseIdProvider"><a href="#VendorDatabaseIdProvider" class="headerlink" title="VendorDatabaseIdProvider"></a>VendorDatabaseIdProvider</h4><p>â€‹ å‚å•†æ•°æ®åº“Idæä¾›è€…ã€‚<code>DefaultDatabaseIdProvider</code>ç»§æ‰¿æ­¤ç±»ï¼Œä½†æ˜¯å·²æ ‡è®°ä¸ºåºŸå¼ƒ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VendorDatabaseIdProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseIdProvider</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(BaseExecutor.class);<br><br>  <span class="hljs-keyword">private</span> Properties properties;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties p)</span> &#123;<br>    <span class="hljs-built_in">this</span>.properties = p;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDatabaseId</span><span class="hljs-params">(DataSource dataSource)</span> &#123;<br>    <span class="hljs-keyword">if</span> (dataSource == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;dataSource cannot be null&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// æ ¹æ®dataSourceå¾—åˆ°æ•°æ®åº“åå­—</span><br>      <span class="hljs-keyword">return</span> getDatabaseName(dataSource);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      log.error(<span class="hljs-string">&quot;Could not get a databaseId from dataSource&quot;</span>, e);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getDatabaseName</span><span class="hljs-params">(DataSource dataSource)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// å…ˆå¾—åˆ°productName</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">productName</span> <span class="hljs-operator">=</span> getDatabaseProductName(dataSource);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.properties != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// å¦‚æœè®¾ç½®äº†ç¼©å†™propertiesï¼Œåˆ™ä¸€ä¸ªä¸ªæ¯”è¾ƒè¿”å›åŒ¹é…çš„ç¼©å†™</span><br>      <span class="hljs-keyword">for</span> (Map.Entry&lt;Object, Object&gt; property : properties.entrySet()) &#123;<br>        <span class="hljs-keyword">if</span> (productName.contains((String) property.getKey())) &#123;<br>          <span class="hljs-keyword">return</span> (String) property.getValue();<br>        &#125;<br>      &#125;<br>      <span class="hljs-comment">// no match, return null</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> productName;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getDatabaseProductName</span><span class="hljs-params">(DataSource dataSource)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      con = dataSource.getConnection();<br>      <span class="hljs-comment">// æ ¸å¿ƒå°±æ˜¯DatabaseMetaData.getDatabaseProductName()å¾—åˆ°æ•°æ®åº“äº§å“åå­—</span><br>      <span class="hljs-type">DatabaseMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> con.getMetaData();<br>      <span class="hljs-keyword">return</span> metaData.getDatabaseProductName();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (con != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          con.close();<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>          <span class="hljs-comment">// ignored</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h4><p>â€‹ ç¯å¢ƒã€‚å†³å®šåŠ è½½å“ªç§ç¯å¢ƒï¼ˆå¼€å‘ç¯å¢ƒ&#x2F;ç”Ÿäº§ç¯å¢ƒï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Environment</span> &#123; <br><br>  <span class="hljs-comment">// ç¯å¢ƒid</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String id;<br>  <span class="hljs-comment">// äº‹åŠ¡å·¥å‚</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TransactionFactory transactionFactory;<br>  <span class="hljs-comment">// æ•°æ®æº</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataSource dataSource; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">Environment</span><span class="hljs-params">(String id, TransactionFactory transactionFactory, DataSource dataSource)</span> &#123;<br>    <span class="hljs-keyword">if</span> (id == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Parameter &#x27;id&#x27; must not be null&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (transactionFactory == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Parameter &#x27;transactionFactory&#x27; must not be null&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">this</span>.id = id;<br>    <span class="hljs-keyword">if</span> (dataSource == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Parameter &#x27;dataSource&#x27; must not be null&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">this</span>.transactionFactory = transactionFactory;<br>    <span class="hljs-built_in">this</span>.dataSource = dataSource;<br>  &#125;<br><br>  <span class="hljs-comment">// ä¸€ä¸ªé™æ€å†…éƒ¨ç±»Builder</span><br>  <span class="hljs-comment">// å»ºé€ æ¨¡å¼</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> &#123;<br>      <span class="hljs-keyword">private</span> String id;<br>      <span class="hljs-keyword">private</span> TransactionFactory transactionFactory;<br>      <span class="hljs-keyword">private</span> DataSource dataSource;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(String id)</span> &#123;<br>      <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">transactionFactory</span><span class="hljs-params">(TransactionFactory transactionFactory)</span> &#123;<br>      <span class="hljs-built_in">this</span>.transactionFactory = transactionFactory;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">dataSource</span><span class="hljs-params">(DataSource dataSource)</span> &#123;<br>      <span class="hljs-built_in">this</span>.dataSource = dataSource;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">id</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Environment <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Environment</span>(<span class="hljs-built_in">this</span>.id, <span class="hljs-built_in">this</span>.transactionFactory, <span class="hljs-built_in">this</span>.dataSource);<br>    &#125;<br><br>  &#125;<br><br>  <span class="hljs-comment">// å‰©ä¸‹çš„getæ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="FetchType"><a href="#FetchType" class="headerlink" title="FetchType"></a>FetchType</h4><p>â€‹ åœ¨MyBatisä¸­ï¼Œfetch typeæœ‰ä¸‰ç§ç±»å‹ï¼šDEFAULT, EAGERå’ŒLAZY(<a href="https://stackoverflow.com/questions/2990799/difference-between-fetchtype-lazy-and-eager-in-java-persistence-api)%E3%80%82%E8%BF%99%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%8C%BA%E5%88%AB%E5%9C%A8%E4%BA%8E%E5%AE%83%E4%BB%AC%E6%8E%A7%E5%88%B6MyBatis%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E3%80%82">https://stackoverflow.com/questions/2990799/difference-between-fetchtype-lazy-and-eager-in-java-persistence-api)ã€‚è¿™ä¸‰ç§ç±»å‹çš„åŒºåˆ«åœ¨äºå®ƒä»¬æ§åˆ¶MyBatiså¦‚ä½•è·å–æ•°æ®ã€‚</a></p><ul><li><strong>DEFAULT</strong>ï¼šè¿™æ˜¯é»˜è®¤çš„fetch typeï¼Œå®ƒä¼šæ ¹æ®MyBatisçš„å…¨å±€é…ç½®æ¥å†³å®šæ˜¯ä½¿ç”¨EAGERè¿˜æ˜¯LAZYã€‚</li><li><strong>EAGER</strong>ï¼šè¿™ç§fetch typeä¼šç«‹å³åŠ è½½æ‰€æœ‰ç›¸å…³æ•°æ®ã€‚å½“æ‚¨è·å–ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¸è¯¥å¯¹è±¡ç›¸å…³è”çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šè¢«ç«‹å³åŠ è½½ã€‚</li><li><strong>LAZY</strong>ï¼šè¿™ç§fetch typeä¼šå»¶è¿ŸåŠ è½½ç›¸å…³æ•°æ®ã€‚å½“æ‚¨è·å–ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¸è¯¥å¯¹è±¡ç›¸å…³è”çš„æ•°æ®ä¸ä¼šè¢«ç«‹å³åŠ è½½ï¼Œè€Œæ˜¯åœ¨æ‚¨è®¿é—®è¿™äº›æ•°æ®æ—¶æ‰ä¼šè¢«åŠ è½½ã€‚</li></ul><p>â€‹ ä»¥ä¸Šè§£é‡Šæ¥è‡ªbing chat</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FetchType</span> &#123;<br>  LAZY, EAGER, DEFAULT<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ParameterMode"><a href="#ParameterMode" class="headerlink" title="ParameterMode"></a>ParameterMode</h4><p>â€‹ ParameterModeç”¨æ¥æ§åˆ¶MyBatiså¦‚ä½•å¤„ç†å­˜å‚¨è¿‡ç¨‹çš„å‚æ•°ã€‚</p><ul><li><strong>IN</strong>ï¼šè¡¨ç¤ºè¾“å…¥å‚æ•°ï¼Œç”¨äºä¼ é€’ç»™å­˜å‚¨è¿‡ç¨‹ã€‚</li><li><strong>OUT</strong>ï¼šè¡¨ç¤ºè¾“å‡ºå‚æ•°ï¼Œç”¨äºä»å­˜å‚¨è¿‡ç¨‹è¿”å›å€¼ã€‚</li><li><strong>INOUT</strong>ï¼šè¡¨ç¤ºè¾“å…¥&#x2F;è¾“å‡ºå‚æ•°ï¼Œæ—¢å¯ä»¥ä¼ é€’ç»™å­˜å‚¨è¿‡ç¨‹ï¼Œä¹Ÿå¯ä»¥ä»å­˜å‚¨è¿‡ç¨‹è¿”å›å€¼ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ParameterMode</span> &#123;<br>  IN, OUT, INOUT<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ParameterMapping"><a href="#ParameterMapping" class="headerlink" title="ParameterMapping"></a>ParameterMapping</h4><p>â€‹ å‚æ•°æ˜ å°„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterMapping</span> &#123; <br><br>  <span class="hljs-keyword">private</span> Configuration configuration;<br><br>  <span class="hljs-comment">// ä¾‹å­ï¼š#&#123;property,javaType=int,jdbcType=NUMERIC&#125;</span><br><br>  <span class="hljs-comment">// property</span><br>  <span class="hljs-keyword">private</span> String property;<br>  <span class="hljs-comment">// mode</span><br>  <span class="hljs-keyword">private</span> ParameterMode mode;<br>  <span class="hljs-comment">// javaType=int</span><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; javaType = Object.class;<br>  <span class="hljs-comment">// jdbcType=NUMERIC</span><br>  <span class="hljs-keyword">private</span> JdbcType jdbcType;<br>  <span class="hljs-comment">// numericScale</span><br>  <span class="hljs-keyword">private</span> Integer numericScale;<br>  <span class="hljs-keyword">private</span> TypeHandler&lt;?&gt; typeHandler;<br>  <span class="hljs-keyword">private</span> String resultMapId;<br>  <span class="hljs-comment">// jdbcType=NUMERIC</span><br>  <span class="hljs-keyword">private</span> String jdbcTypeName;<br>  <span class="hljs-keyword">private</span> String expression;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">ParameterMapping</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-comment">// é™æ€å†…éƒ¨ç±»ï¼Œå»ºé€ è€…æ¨¡å¼</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ParameterMapping</span> <span class="hljs-variable">parameterMapping</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMapping</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Configuration configuration, String property, TypeHandler&lt;?&gt; typeHandler)</span> &#123;<br>      parameterMapping.configuration = configuration;<br>      parameterMapping.property = property;<br>      parameterMapping.typeHandler = typeHandler;<br>      parameterMapping.mode = ParameterMode.IN;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Configuration configuration, String property, Class&lt;?&gt; javaType)</span> &#123;<br>      parameterMapping.configuration = configuration;<br>      parameterMapping.property = property;<br>      parameterMapping.javaType = javaType;<br>      parameterMapping.mode = ParameterMode.IN;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">mode</span><span class="hljs-params">(ParameterMode mode)</span> &#123;<br>      parameterMapping.mode = mode;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">javaType</span><span class="hljs-params">(Class&lt;?&gt; javaType)</span> &#123;<br>      parameterMapping.javaType = javaType;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">jdbcType</span><span class="hljs-params">(JdbcType jdbcType)</span> &#123;<br>      parameterMapping.jdbcType = jdbcType;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">numericScale</span><span class="hljs-params">(Integer numericScale)</span> &#123;<br>      parameterMapping.numericScale = numericScale;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">resultMapId</span><span class="hljs-params">(String resultMapId)</span> &#123;<br>      parameterMapping.resultMapId = resultMapId;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">typeHandler</span><span class="hljs-params">(TypeHandler&lt;?&gt; typeHandler)</span> &#123;<br>      parameterMapping.typeHandler = typeHandler;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">jdbcTypeName</span><span class="hljs-params">(String jdbcTypeName)</span> &#123;<br>      parameterMapping.jdbcTypeName = jdbcTypeName;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">expression</span><span class="hljs-params">(String expression)</span> &#123;<br>      parameterMapping.expression = expression;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ParameterMapping <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>      resolveTypeHandler();<br>      validate();<br>      <span class="hljs-keyword">return</span> parameterMapping;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolveTypeHandler</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// å¦‚æœæ²¡æœ‰æŒ‡å®šç‰¹æ®Šçš„typeHandlerï¼Œåˆ™æ ¹æ®javaTypeï¼ŒjdbcTypeæ¥æŸ¥è¡¨ç¡®å®šä¸€ä¸ªé»˜è®¤çš„typeHandler</span><br>      <span class="hljs-keyword">if</span> (parameterMapping.typeHandler == <span class="hljs-literal">null</span> &amp;&amp; parameterMapping.javaType != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> parameterMapping.configuration;<br>        <span class="hljs-type">TypeHandlerRegistry</span> <span class="hljs-variable">typeHandlerRegistry</span> <span class="hljs-operator">=</span> configuration.getTypeHandlerRegistry();<br>        parameterMapping.typeHandler = typeHandlerRegistry.getTypeHandler(parameterMapping.javaType, parameterMapping.jdbcType);<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// æ„é€ å‰åšä¸‹æ ¡éªŒ</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">if</span> (ResultSet.class.equals(parameterMapping.javaType)) &#123;<br>        <span class="hljs-keyword">if</span> (parameterMapping.resultMapId == <span class="hljs-literal">null</span>) &#123; <br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Missing resultmap in property &#x27;&quot;</span>  <br>              + parameterMapping.property + <span class="hljs-string">&quot;&#x27;.  &quot;</span> <br>              + <span class="hljs-string">&quot;Parameters of type java.sql.ResultSet require a resultmap.&quot;</span>);<br>        &#125;            <br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (parameterMapping.typeHandler == <span class="hljs-literal">null</span>) &#123; <br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Type handler was null on parameter mapping for property &#x27;&quot;</span>  <br>              + parameterMapping.property + <span class="hljs-string">&quot;&#x27;.  &quot;</span> <br>              + <span class="hljs-string">&quot;It was either not specified and/or could not be found for the javaType / jdbcType combination specified.&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br><br>  &#125;<br><br>  <span class="hljs-comment">// å‰©ä¸‹çš„getæ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ParameterMap"><a href="#ParameterMap" class="headerlink" title="ParameterMap"></a>ParameterMap</h4><p>â€‹ å‚æ•°æ˜ å°„é›†åˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParameterMap</span> &#123; <br><br>  <span class="hljs-keyword">private</span> String id;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>  <span class="hljs-keyword">private</span> List&lt;ParameterMapping&gt; parameterMappings;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">ParameterMap</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ParameterMap</span> <span class="hljs-variable">parameterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMap</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Configuration configuration, String id, Class&lt;?&gt; type, List&lt;ParameterMapping&gt; parameterMappings)</span> &#123;<br>      parameterMap.id = id;<br>      parameterMap.type = type;<br>      parameterMap.parameterMappings = parameterMappings;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; type() &#123;<br>      <span class="hljs-keyword">return</span> parameterMap.type;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ParameterMap <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">//lock down collections</span><br>      parameterMap.parameterMappings = Collections.unmodifiableList(parameterMap.parameterMappings);<br>      <span class="hljs-keyword">return</span> parameterMap;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// å‰©ä¸‹çš„getæ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultFlag"><a href="#ResultFlag" class="headerlink" title="ResultFlag"></a>ResultFlag</h4><p>â€‹ ç”¨æ¥æ§åˆ¶mybatiså¦‚ä½•å¤„ç†ç»“æœæ˜ å°„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ResultFlag</span> &#123;<br>  ID, CONSTRUCTOR<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultMapping"><a href="#ResultMapping" class="headerlink" title="ResultMapping"></a>ResultMapping</h4><p>â€‹ ç»“æœæ˜ å°„,å±æ€§çš„æ˜ å°„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultMapping</span> &#123; <br><br>  <span class="hljs-keyword">private</span> Configuration configuration; <br>  <span class="hljs-comment">// javaå±æ€§</span><br>  <span class="hljs-keyword">private</span> String property;<br>  <span class="hljs-comment">// åˆ—å</span><br>  <span class="hljs-keyword">private</span> String column; <br>  <span class="hljs-comment">// javaå±æ€§ç±»å‹</span><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; javaType;<br>  <span class="hljs-comment">// åˆ—å¯¹åº”çš„jdbcç±»å‹</span><br>  <span class="hljs-keyword">private</span> JdbcType jdbcType; <br>  <span class="hljs-comment">// javaç±»å‹å’Œjdbcç±»å‹è½¬æ¢çš„ç±»å‹å¤„ç†å™¨</span><br>  <span class="hljs-keyword">private</span> TypeHandler&lt;?&gt; typeHandler;<br>  <span class="hljs-keyword">private</span> String nestedResultMapId;<br>  <span class="hljs-keyword">private</span> String nestedQueryId;<br>  <span class="hljs-keyword">private</span> Set&lt;String&gt; notNullColumns;<br>  <span class="hljs-keyword">private</span> String columnPrefix;<br>  <span class="hljs-keyword">private</span> List&lt;ResultFlag&gt; flags;<br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; composites;<br>  <span class="hljs-keyword">private</span> String resultSet;<br>  <span class="hljs-keyword">private</span> String foreignColumn;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> lazy; <br><br>  ResultMapping() &#123;<br>  &#125; <br><br>  <span class="hljs-comment">// é™æ€å†…éƒ¨ç±»ï¼Œå»ºé€ è€…æ¨¡å¼</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> &#123; <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">resultMapping</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMapping</span>(); <br><br>    <span class="hljs-comment">// ä¼ åˆ—åå’Œç±»å‹å¤„ç†å™¨</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Configuration configuration, String property, String column, TypeHandler&lt;?&gt; typeHandler)</span> &#123;<br>      <span class="hljs-built_in">this</span>(configuration, property);<br>      resultMapping.column = column;<br>      resultMapping.typeHandler = typeHandler;<br>    &#125;<br><br>    <span class="hljs-comment">// ä¼ åˆ—åå’Œå¯¹åº”çš„javaç±»å‹</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Configuration configuration, String property, String column, Class&lt;?&gt; javaType)</span> &#123;<br>      <span class="hljs-built_in">this</span>(configuration, property);<br>      resultMapping.column = column;<br>      resultMapping.javaType = javaType;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Configuration configuration, String property)</span> &#123;<br>      resultMapping.configuration = configuration;<br>      resultMapping.property = property;<br>      resultMapping.flags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultFlag&gt;();<br>      resultMapping.composites = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>      resultMapping.lazy = configuration.isLazyLoadingEnabled();<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">javaType</span><span class="hljs-params">(Class&lt;?&gt; javaType)</span> &#123;<br>      resultMapping.javaType = javaType;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">jdbcType</span><span class="hljs-params">(JdbcType jdbcType)</span> &#123;<br>      resultMapping.jdbcType = jdbcType;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">nestedResultMapId</span><span class="hljs-params">(String nestedResultMapId)</span> &#123;<br>      resultMapping.nestedResultMapId = nestedResultMapId;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">nestedQueryId</span><span class="hljs-params">(String nestedQueryId)</span> &#123;<br>      resultMapping.nestedQueryId = nestedQueryId;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">resultSet</span><span class="hljs-params">(String resultSet)</span> &#123;<br>      resultMapping.resultSet = resultSet;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">foreignColumn</span><span class="hljs-params">(String foreignColumn)</span> &#123;<br>      resultMapping.foreignColumn = foreignColumn;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">notNullColumns</span><span class="hljs-params">(Set&lt;String&gt; notNullColumns)</span> &#123;<br>      resultMapping.notNullColumns = notNullColumns;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">columnPrefix</span><span class="hljs-params">(String columnPrefix)</span> &#123;<br>      resultMapping.columnPrefix = columnPrefix;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">flags</span><span class="hljs-params">(List&lt;ResultFlag&gt; flags)</span> &#123;<br>      resultMapping.flags = flags;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">typeHandler</span><span class="hljs-params">(TypeHandler&lt;?&gt; typeHandler)</span> &#123;<br>      resultMapping.typeHandler = typeHandler;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">composites</span><span class="hljs-params">(List&lt;ResultMapping&gt; composites)</span> &#123;<br>      resultMapping.composites = composites;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">lazy</span><span class="hljs-params">(<span class="hljs-type">boolean</span> lazy)</span> &#123;<br>      resultMapping.lazy = lazy;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">column</span><span class="hljs-params">(String column)</span> &#123;<br>      resultMapping.column = column;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> ResultMapping <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// lock down collections</span><br>      resultMapping.flags = Collections.unmodifiableList(resultMapping.flags);<br>      resultMapping.composites = Collections.unmodifiableList(resultMapping.composites);<br>      resolveTypeHandler();<br>      validate();<br>      <span class="hljs-keyword">return</span> resultMapping;<br>    &#125;  <br><br>    <span class="hljs-comment">// æ¡ä»¶å…è®¸çš„è¯ï¼Œæ‰¾åˆ°å¹¶è®¾ç½®ç±»å‹å¤„ç†å™¨</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolveTypeHandler</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">if</span> (resultMapping.typeHandler == <span class="hljs-literal">null</span> &amp;&amp; resultMapping.javaType != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> resultMapping.configuration;<br>        <span class="hljs-type">TypeHandlerRegistry</span> <span class="hljs-variable">typeHandlerRegistry</span> <span class="hljs-operator">=</span> configuration.getTypeHandlerRegistry();<br>        resultMapping.typeHandler = typeHandlerRegistry.getTypeHandler(resultMapping.javaType, resultMapping.jdbcType);<br>      &#125;<br>    &#125; <br><br>    <span class="hljs-comment">// ä¸€äº›éªŒè¯é€»è¾‘,éªŒè¯result mapæœ‰æ²¡æœ‰å†™é”™</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Issue #697: cannot define both nestedQueryId and nestedResultMapId</span><br>      <span class="hljs-keyword">if</span> (resultMapping.nestedQueryId != <span class="hljs-literal">null</span> &amp;&amp; resultMapping.nestedResultMapId != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Cannot define both nestedQueryId and nestedResultMapId in property &quot;</span> + resultMapping.property);<br>      &#125;<br>      <span class="hljs-comment">// Issue #5: there should be no mappings without typehandler</span><br>      <span class="hljs-keyword">if</span> (resultMapping.nestedQueryId == <span class="hljs-literal">null</span> &amp;&amp; resultMapping.nestedResultMapId == <span class="hljs-literal">null</span> &amp;&amp; resultMapping.typeHandler == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No typehandler found for property &quot;</span> + resultMapping.property);<br>      &#125;<br>      <span class="hljs-comment">// Issue #4 and GH #39: column is optional only in nested resultmaps but not in the rest</span><br>      <span class="hljs-keyword">if</span> (resultMapping.nestedResultMapId == <span class="hljs-literal">null</span> &amp;&amp; resultMapping.column == <span class="hljs-literal">null</span> &amp;&amp; resultMapping.composites.isEmpty()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Mapping is missing column attribute for property &quot;</span> + resultMapping.property);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (resultMapping.getResultSet() != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numColums</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (resultMapping.column != <span class="hljs-literal">null</span>) &#123;<br>          numColums = resultMapping.column.split(<span class="hljs-string">&quot;,&quot;</span>).length;<br>        &#125;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">numForeignColumns</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (resultMapping.foreignColumn != <span class="hljs-literal">null</span>) &#123;<br>          numForeignColumns = resultMapping.foreignColumn.split(<span class="hljs-string">&quot;,&quot;</span>).length;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (numColums != numForeignColumns) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;There should be the same number of columns and foreignColumns in property &quot;</span> + resultMapping.property);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// getã€setæ–¹æ³•ç•¥</span><br><br>  <span class="hljs-meta">@Override</span> <br>  <span class="hljs-comment">// equalsæ–¹æ³•æœ€åæ¯”è¾ƒçš„æ˜¯ javaç±»å±æ€§åç§°</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == o) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span> || getClass() != o.getClass()) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-type">ResultMapping</span> <span class="hljs-variable">that</span> <span class="hljs-operator">=</span> (ResultMapping) o;<br><br>    <span class="hljs-keyword">if</span> (property == <span class="hljs-literal">null</span> || !property.equals(that.property)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (property != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> property.hashCode();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (column != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> column.hashCode();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Discriminator"><a href="#Discriminator" class="headerlink" title="Discriminator"></a>Discriminator</h4><p>é‰´åˆ«å™¨ ã€‚æœ‰æ—¶ä¸€ä¸ªæŸ¥è¯¢ä¹Ÿè®¸è¿”å›å¾ˆå¤šä¸åŒæ•°æ®ç±»å‹çš„ç»“æœé›†ã€‚é‰´åˆ«å™¨çš„è¡¨ç°å¾ˆåƒ Java è¯­è¨€ä¸­çš„ switch è¯­å¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Discriminator</span> &#123;<br><br>  <span class="hljs-keyword">private</span> ResultMapping resultMapping;<br>  <span class="hljs-keyword">private</span> Map&lt;String, String&gt; discriminatorMap;<br><br>  Discriminator() &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Discriminator</span> <span class="hljs-variable">discriminator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Discriminator</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Configuration configuration, ResultMapping resultMapping, Map&lt;String, String&gt; discriminatorMap)</span> &#123;<br>      discriminator.resultMapping = resultMapping;<br>      discriminator.discriminatorMap = discriminatorMap;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Discriminator <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">assert</span> discriminator.resultMapping != <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">assert</span> discriminator.discriminatorMap != <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">assert</span> !discriminator.discriminatorMap.isEmpty();<br>      <span class="hljs-comment">//lock down map</span><br>      discriminator.discriminatorMap = Collections.unmodifiableMap(discriminator.discriminatorMap);<br>      <span class="hljs-keyword">return</span> discriminator;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// getæ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultMap"><a href="#ResultMap" class="headerlink" title="ResultMap"></a>ResultMap</h4><p>ç»“æœæ˜ å°„ï¼Œç±»çš„æ˜ å°„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultMap</span> &#123; <br><br>  <span class="hljs-keyword">private</span> String id;<br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; resultMappings;<br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; idResultMappings;<br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; constructorResultMappings;<br>  <span class="hljs-keyword">private</span> List&lt;ResultMapping&gt; propertyResultMappings;<br>  <span class="hljs-keyword">private</span> Set&lt;String&gt; mappedColumns;<br>  <span class="hljs-keyword">private</span> Discriminator discriminator;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> hasNestedResultMaps;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> hasNestedQueries;<br>  <span class="hljs-keyword">private</span> Boolean autoMapping; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">ResultMap</span><span class="hljs-params">()</span> &#123;<br>  &#125; <br><br>  <span class="hljs-comment">// é™æ€å†…éƒ¨ç±»ï¼Œå»ºé€ è€…æ¨¡å¼</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> &#123; <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ResultMap</span> <span class="hljs-variable">resultMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultMap</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Configuration configuration, String id, Class&lt;?&gt; type, List&lt;ResultMapping&gt; resultMappings)</span> &#123;<br>      <span class="hljs-built_in">this</span>(configuration, id, type, resultMappings, <span class="hljs-literal">null</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Configuration configuration, String id, Class&lt;?&gt; type, List&lt;ResultMapping&gt; resultMappings, Boolean autoMapping)</span> &#123;<br>      resultMap.id = id;<br>      resultMap.type = type;<br>      resultMap.resultMappings = resultMappings;<br>      resultMap.autoMapping = autoMapping;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> Builder <span class="hljs-title function_">discriminator</span><span class="hljs-params">(Discriminator discriminator)</span> &#123;<br>      resultMap.discriminator = discriminator;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; type() &#123;<br>      <span class="hljs-keyword">return</span> resultMap.type;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> ResultMap <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">if</span> (resultMap.id == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;ResultMaps must have an id&quot;</span>);<br>      &#125;<br>      resultMap.mappedColumns = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();<br>      resultMap.idResultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>      resultMap.constructorResultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>      resultMap.propertyResultMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMapping&gt;();<br>      <span class="hljs-keyword">for</span> (ResultMapping resultMapping : resultMap.resultMappings) &#123;<br>        resultMap.hasNestedQueries = resultMap.hasNestedQueries || resultMapping.getNestedQueryId() != <span class="hljs-literal">null</span>;<br>        resultMap.hasNestedResultMaps = resultMap.hasNestedResultMaps || (resultMapping.getNestedResultMapId() != <span class="hljs-literal">null</span> &amp;&amp; resultMapping.getResultSet() == <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> resultMapping.getColumn();<br>        <span class="hljs-keyword">if</span> (column != <span class="hljs-literal">null</span>) &#123;<br>          resultMap.mappedColumns.add(column.toUpperCase(Locale.ENGLISH));<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (resultMapping.isCompositeResult()) &#123;<br>          <span class="hljs-keyword">for</span> (ResultMapping compositeResultMapping : resultMapping.getComposites()) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">compositeColumn</span> <span class="hljs-operator">=</span> compositeResultMapping.getColumn();<br>            <span class="hljs-keyword">if</span> (compositeColumn != <span class="hljs-literal">null</span>) &#123;<br>              resultMap.mappedColumns.add(compositeColumn.toUpperCase(Locale.ENGLISH));<br>            &#125;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;<br>          resultMap.constructorResultMappings.add(resultMapping);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          resultMap.propertyResultMappings.add(resultMapping);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.ID)) &#123;<br>          resultMap.idResultMappings.add(resultMapping);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (resultMap.idResultMappings.isEmpty()) &#123;<br>        resultMap.idResultMappings.addAll(resultMap.resultMappings);<br>      &#125;<br>      <span class="hljs-comment">// lock down collections</span><br>      resultMap.resultMappings = Collections.unmodifiableList(resultMap.resultMappings);<br>      resultMap.idResultMappings = Collections.unmodifiableList(resultMap.idResultMappings);<br>      resultMap.constructorResultMappings = Collections.unmodifiableList(resultMap.constructorResultMappings);<br>      resultMap.propertyResultMappings = Collections.unmodifiableList(resultMap.propertyResultMappings);<br>      resultMap.mappedColumns = Collections.unmodifiableSet(resultMap.mappedColumns);<br>      <span class="hljs-keyword">return</span> resultMap;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// getæ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultSetType"><a href="#ResultSetType" class="headerlink" title="ResultSetType"></a>ResultSetType</h4><p>ç»“æœé›†ç±»å‹ã€‚</p><p><code>FORWARD_ONLY</code>å’Œ<code>SCROLL_SENSITIVE</code>çš„åŒºåˆ«åœ¨äºèƒ½å¦åœ¨ç»“æœé›†ä¸­è‡ªæœ‰ç§»åŠ¨</p><p><code>SCROLL_SENSITIVE</code>å’Œ<code>SCROLL_INSENSITIVE</code>çš„åŒºåˆ«åœ¨äºç»“æœé›†å¯¹åº•å±‚æ•°æ®æºçš„æ›´æ”¹æ˜¯å¦æ•æ„Ÿã€‚å®ƒåŒ…å«æ»¡è¶³æŸ¥è¯¢æ¡ä»¶çš„è¡Œï¼Œæ— è®ºæ˜¯åœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶è¿˜æ˜¯åœ¨æ£€ç´¢è¡Œæ—¶ã€‚è€Œä½¿ç”¨Â <code>TYPE_SCROLL_SENSITIVE</code>Â æ—¶ï¼Œç»“æœé›†ä¼šåæ˜ å¯¹åº•å±‚æ•°æ®æºçš„æ›´æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ResultSetType</span> &#123;<br>  FORWARD_ONLY(ResultSet.TYPE_FORWARD_ONLY),<br>  SCROLL_INSENSITIVE(ResultSet.TYPE_SCROLL_INSENSITIVE),<br>  SCROLL_SENSITIVE(ResultSet.TYPE_SCROLL_SENSITIVE);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> value;<br><br>  ResultSetType(<span class="hljs-type">int</span> value) &#123;<br>    <span class="hljs-built_in">this</span>.value = value;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> value;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SqlCommandType"><a href="#SqlCommandType" class="headerlink" title="SqlCommandType"></a>SqlCommandType</h4><p>sqlå‘½ä»¤çš„ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SqlCommandType</span> &#123;<br>  UNKNOWN, INSERT, UPDATE, DELETE, SELECT;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="StatementType"><a href="#StatementType" class="headerlink" title="StatementType"></a>StatementType</h4><p><code>STATEMENT</code>è¡¨ç¤ºç›´æ¥æ“ä½œSQLï¼Œä¸è¿›è¡Œé¢„ç¼–è¯‘</p><p><code>PREPARED</code>è¡¨ç¤ºé¢„å¤„ç†å‚æ•°å¹¶è¿›è¡Œé¢„ç¼–è¯‘ï¼ˆé»˜è®¤å€¼ï¼‰</p><p><code>CALLABLE</code>è¡¨ç¤ºæ‰§è¡Œå­˜å‚¨è¿‡ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">StatementType</span> &#123;<br>  STATEMENT, PREPARED, CALLABLE<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CacheBuilder"><a href="#CacheBuilder" class="headerlink" title="CacheBuilder"></a>CacheBuilder</h4><p>ç¼“å­˜æ„å»ºå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheBuilder</span> &#123; <br><br>  <span class="hljs-keyword">private</span> String id;<br>  <span class="hljs-keyword">private</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; implementation;<br>  <span class="hljs-keyword">private</span> List&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt;&gt; decorators;<br>  <span class="hljs-keyword">private</span> Integer size;<br>  <span class="hljs-keyword">private</span> Long clearInterval;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> readWrite;<br>  <span class="hljs-keyword">private</span> Properties properties;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> blocking; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheBuilder</span><span class="hljs-params">(String id)</span> &#123;<br>    <span class="hljs-built_in">this</span>.id = id;<br>    <span class="hljs-built_in">this</span>.decorators = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt;&gt;();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> CacheBuilder <span class="hljs-title function_">implementation</span><span class="hljs-params">(Class&lt;? extends Cache&gt; implementation)</span> &#123;<br>    <span class="hljs-built_in">this</span>.implementation = implementation;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> CacheBuilder <span class="hljs-title function_">addDecorator</span><span class="hljs-params">(Class&lt;? extends Cache&gt; decorator)</span> &#123;<br>    <span class="hljs-keyword">if</span> (decorator != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-built_in">this</span>.decorators.add(decorator);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> CacheBuilder <span class="hljs-title function_">size</span><span class="hljs-params">(Integer size)</span> &#123;<br>    <span class="hljs-built_in">this</span>.size = size;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> CacheBuilder <span class="hljs-title function_">clearInterval</span><span class="hljs-params">(Long clearInterval)</span> &#123;<br>    <span class="hljs-built_in">this</span>.clearInterval = clearInterval;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> CacheBuilder <span class="hljs-title function_">readWrite</span><span class="hljs-params">(<span class="hljs-type">boolean</span> readWrite)</span> &#123;<br>    <span class="hljs-built_in">this</span>.readWrite = readWrite;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> CacheBuilder <span class="hljs-title function_">blocking</span><span class="hljs-params">(<span class="hljs-type">boolean</span> blocking)</span> &#123;<br>    <span class="hljs-built_in">this</span>.blocking = blocking;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">public</span> CacheBuilder <span class="hljs-title function_">properties</span><span class="hljs-params">(Properties properties)</span> &#123;<br>    <span class="hljs-built_in">this</span>.properties = properties;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Cache <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>    setDefaultImplementations();<br>    <span class="hljs-comment">// å…ˆnewä¸€ä¸ªbaseçš„cache(PerpetualCache)</span><br>    <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> newBaseCacheInstance(implementation, id);<br>    <span class="hljs-comment">// è®¾é¢å¤–å±æ€§</span><br>    setCacheProperties(cache);<br>    <span class="hljs-comment">// issue #352, do not apply decorators to custom caches</span><br>    <span class="hljs-keyword">if</span> (PerpetualCache.class.equals(cache.getClass())) &#123;<br>      <span class="hljs-keyword">for</span> (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; decorator : decorators) &#123;<br>        <span class="hljs-comment">// è£…é¥°è€…æ¨¡å¼ä¸€ä¸ªä¸ªåŒ…è£…cache</span><br>        cache = newCacheDecoratorInstance(decorator, cache);<br>        <span class="hljs-comment">// åˆè¦æ¥ä¸€éè®¾é¢å¤–å±æ€§</span><br>        setCacheProperties(cache);<br>      &#125;<br>      <span class="hljs-comment">// æœ€åé™„åŠ ä¸Šæ ‡å‡†çš„è£…é¥°è€…</span><br>      cache = setStandardDecorators(cache);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!LoggingCache.class.isAssignableFrom(cache.getClass())) &#123;<br>      <span class="hljs-comment">// ç”¨æˆ·å®ç°çš„ç¼“å­˜ï¼Œä¸”ä¸æ˜¯æ—¥å¿—ï¼Œè¦åŠ æ—¥å¿—</span><br>      cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingCache</span>(cache);<br>    &#125;<br>    <span class="hljs-keyword">return</span> cache;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDefaultImplementations</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// åˆæ˜¯ä¸€é‡ä¿é™©ï¼Œå¦‚æœä¸ºnullåˆ™è®¾é»˜è®¤å€¼,å’ŒXMLMapperBuilder.cacheElementä»¥åŠMapperBuilderAssistant.useNewCacheé€»è¾‘é‡å¤äº†</span><br>    <span class="hljs-keyword">if</span> (implementation == <span class="hljs-literal">null</span>) &#123;<br>      implementation = PerpetualCache.class;<br>      <span class="hljs-keyword">if</span> (decorators.isEmpty()) &#123;<br>        decorators.add(LruCache.class);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> Cache <span class="hljs-title function_">newBaseCacheInstance</span><span class="hljs-params">(Class&lt;? extends Cache&gt; cacheClass, String id)</span> &#123;<br>    Constructor&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; cacheConstructor = getBaseCacheConstructor(cacheClass);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> cacheConstructor.newInstance(id);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Could not instantiate cache implementation (&quot;</span> + cacheClass + <span class="hljs-string">&quot;). Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Constructor&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; getBaseCacheConstructor(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; cacheClass) &#123;<br>    <span class="hljs-keyword">try</span> &#123; <br>      <span class="hljs-comment">// åªæœ‰PerpetualCacheæœ‰å‚æ•°ä¸ºStringçš„æ„é€ å‡½æ•°</span><br>      <span class="hljs-keyword">return</span> cacheClass.getConstructor(String.class);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Invalid base cache implementation (&quot;</span> + cacheClass + <span class="hljs-string">&quot;).  &quot;</span> +<br>          <span class="hljs-string">&quot;Base cache implementations must have a constructor that takes a String id as a parameter.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCacheProperties</span><span class="hljs-params">(Cache cache)</span> &#123;<br>    <span class="hljs-keyword">if</span> (properties != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaCache</span> <span class="hljs-operator">=</span> SystemMetaObject.forObject(cache);<br>      <span class="hljs-comment">// ç”¨åå°„è®¾ç½®é¢å¤–çš„propertyå±æ€§</span><br>      <span class="hljs-keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : properties.entrySet()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> (String) entry.getKey();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) entry.getValue();<br>        <span class="hljs-keyword">if</span> (metaCache.hasSetter(name)) &#123;<br>          Class&lt;?&gt; type = metaCache.getSetterType(name);<br>          <span class="hljs-comment">// ä¸‹é¢å°±æ˜¯å„ç§åŸºæœ¬ç±»å‹çš„åˆ¤æ–­äº†ï¼Œä¼¼ä¹åªæ”¯æŒä¸€äº›åŸºæœ¬ç±»å‹</span><br>          <span class="hljs-keyword">if</span> (String.class == type) &#123;<br>            metaCache.setValue(name, value);<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-type">int</span>.class == type<br>              || Integer.class == type) &#123;<br>            metaCache.setValue(name, Integer.valueOf(value));<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-type">long</span>.class == type<br>              || Long.class == type) &#123;<br>            metaCache.setValue(name, Long.valueOf(value));<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-type">short</span>.class == type<br>              || Short.class == type) &#123;<br>            metaCache.setValue(name, Short.valueOf(value));<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-type">byte</span>.class == type<br>              || Byte.class == type) &#123;<br>            metaCache.setValue(name, Byte.valueOf(value));<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-type">float</span>.class == type<br>              || Float.class == type) &#123;<br>            metaCache.setValue(name, Float.valueOf(value));<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-type">boolean</span>.class == type<br>              || Boolean.class == type) &#123;<br>            metaCache.setValue(name, Boolean.valueOf(value));<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-type">double</span>.class == type<br>              || Double.class == type) &#123;<br>            metaCache.setValue(name, Double.valueOf(value));<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Unsupported property type for cache: &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27; of type &quot;</span> + type);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Cache <span class="hljs-title function_">newCacheDecoratorInstance</span><span class="hljs-params">(Class&lt;? extends Cache&gt; cacheClass, Cache base)</span> &#123;<br>    Constructor&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; cacheConstructor = getCacheDecoratorConstructor(cacheClass);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> cacheConstructor.newInstance(base);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Could not instantiate cache decorator (&quot;</span> + cacheClass + <span class="hljs-string">&quot;). Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> Constructor&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; getCacheDecoratorConstructor(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cache</span>&gt; cacheClass) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> cacheClass.getConstructor(Cache.class);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Invalid cache decorator (&quot;</span> + cacheClass + <span class="hljs-string">&quot;).  &quot;</span> +<br>          <span class="hljs-string">&quot;Cache decorators must have a constructor that takes a Cache instance as a parameter.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æœ€åé™„åŠ ä¸Šæ ‡å‡†çš„è£…é¥°è€…</span><br>  <span class="hljs-keyword">private</span> Cache <span class="hljs-title function_">setStandardDecorators</span><span class="hljs-params">(Cache cache)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaCache</span> <span class="hljs-operator">=</span> SystemMetaObject.forObject(cache);<br>      <span class="hljs-keyword">if</span> (size != <span class="hljs-literal">null</span> &amp;&amp; metaCache.hasSetter(<span class="hljs-string">&quot;size&quot;</span>)) &#123;<br>        metaCache.setValue(<span class="hljs-string">&quot;size&quot;</span>, size);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (clearInterval != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// åˆ·æ–°ç¼“å­˜é—´éš”,æ€ä¹ˆåˆ·æ–°å‘¢ï¼Œç”¨ScheduledCacheæ¥åˆ·ï¼Œè¿˜æ˜¯è£…é¥°è€…æ¨¡å¼ï¼Œæ¼‚äº®ï¼</span><br>        cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledCache</span>(cache);<br>        ((ScheduledCache) cache).setClearInterval(clearInterval);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (readWrite) &#123;<br>        <span class="hljs-comment">// å¦‚æœreadOnly=false,å¯è¯»å†™çš„ç¼“å­˜ ä¼šè¿”å›ç¼“å­˜å¯¹è±¡çš„æ‹·è´(é€šè¿‡åºåˆ—åŒ–) ã€‚è¿™ä¼šæ…¢ä¸€äº›,ä½†æ˜¯å®‰å…¨,å› æ­¤é»˜è®¤æ˜¯ falseã€‚</span><br>        cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializedCache</span>(cache);<br>      &#125;<br>      <span class="hljs-comment">// æ—¥å¿—ç¼“å­˜</span><br>      cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingCache</span>(cache);<br>      <span class="hljs-comment">// åŒæ­¥ç¼“å­˜, 3.2.6ä»¥åè¿™ä¸ªç±»å·²ç»æ²¡ç”¨äº†ï¼Œè€ƒè™‘åˆ°Hazelcast, EhCacheå·²ç»æœ‰é”æœºåˆ¶äº†ï¼Œæ‰€ä»¥è¿™ä¸ªé”å°±ç”»è›‡æ·»è¶³äº†ã€‚</span><br>      cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedCache</span>(cache);<br>      <span class="hljs-keyword">if</span> (blocking) &#123;<br>        cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockingCache</span>(cache);<br>      &#125;<br>      <span class="hljs-keyword">return</span> cache;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Error building standard cache decorators.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BoundSql"><a href="#BoundSql" class="headerlink" title="BoundSql"></a>BoundSql</h4><p>ç»‘å®šçš„SQL,æ˜¯ä»SqlSourceè€Œæ¥ï¼Œå°†åŠ¨æ€å†…å®¹éƒ½å¤„ç†å®Œæˆå¾—åˆ°çš„SQLè¯­å¥å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…æ‹¬?,è¿˜æœ‰ç»‘å®šçš„å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BoundSql</span> &#123; <br><br>  <span class="hljs-keyword">private</span> String sql;<br>  <span class="hljs-keyword">private</span> List&lt;ParameterMapping&gt; parameterMappings;<br>  <span class="hljs-keyword">private</span> Object parameterObject;<br>  <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; additionalParameters;<br>  <span class="hljs-keyword">private</span> MetaObject metaParameters; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BoundSql</span><span class="hljs-params">(Configuration configuration, String sql, List&lt;ParameterMapping&gt; parameterMappings, Object parameterObject)</span> &#123;<br>    <span class="hljs-built_in">this</span>.sql = sql;<br>    <span class="hljs-built_in">this</span>.parameterMappings = parameterMappings;<br>    <span class="hljs-built_in">this</span>.parameterObject = parameterObject;<br>    <span class="hljs-built_in">this</span>.additionalParameters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>    <span class="hljs-built_in">this</span>.metaParameters = configuration.newMetaObject(additionalParameters);<br>  &#125; <br><br>  <span class="hljs-comment">// get æ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MappedStatement"><a href="#MappedStatement" class="headerlink" title="MappedStatement"></a>MappedStatement</h4><p>æ˜ å°„çš„è¯­å¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MappedStatement</span> &#123; <br><br>  <span class="hljs-keyword">private</span> String resource;<br>  <span class="hljs-keyword">private</span> Configuration configuration;<br>  <span class="hljs-keyword">private</span> String id;<br>  <span class="hljs-keyword">private</span> Integer fetchSize;<br>  <span class="hljs-keyword">private</span> Integer timeout;<br>  <span class="hljs-keyword">private</span> StatementType statementType;<br>  <span class="hljs-keyword">private</span> ResultSetType resultSetType;<br>  <span class="hljs-comment">// SQLæºç </span><br>  <span class="hljs-keyword">private</span> SqlSource sqlSource;<br>  <span class="hljs-keyword">private</span> Cache cache;<br>  <span class="hljs-keyword">private</span> ParameterMap parameterMap;<br>  <span class="hljs-keyword">private</span> List&lt;ResultMap&gt; resultMaps;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> flushCacheRequired;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> useCache;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> resultOrdered;<br>  <span class="hljs-keyword">private</span> SqlCommandType sqlCommandType;<br>  <span class="hljs-keyword">private</span> KeyGenerator keyGenerator;<br>  <span class="hljs-keyword">private</span> String[] keyProperties;<br>  <span class="hljs-keyword">private</span> String[] keyColumns;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> hasNestedResultMaps;<br>  <span class="hljs-keyword">private</span> String databaseId;<br>  <span class="hljs-keyword">private</span> Log statementLog;<br>  <span class="hljs-keyword">private</span> LanguageDriver lang;<br>  <span class="hljs-keyword">private</span> String[] resultSets; <br><br>  MappedStatement() &#123;<br>    <span class="hljs-comment">// constructor disabled</span><br>  &#125; <br><br>  <span class="hljs-comment">// é™æ€å†…éƒ¨ç±»ï¼Œå»ºé€ è€…æ¨¡å¼</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">mappedStatement</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MappedStatement</span>(); <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Builder</span><span class="hljs-params">(Configuration configuration, String id, SqlSource sqlSource, SqlCommandType sqlCommandType)</span> &#123;<br>      mappedStatement.configuration = configuration;<br>      mappedStatement.id = id;<br>      mappedStatement.sqlSource = sqlSource; <br>      <span class="hljs-comment">// é»˜è®¤çš„ StatementType ä¸º PREPARED</span><br>      mappedStatement.statementType = StatementType.PREPARED;<br>      mappedStatement.parameterMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParameterMap</span>.Builder(configuration, <span class="hljs-string">&quot;defaultParameterMap&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ParameterMapping&gt;()).build();<br>      mappedStatement.resultMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;ResultMap&gt;();<br>      mappedStatement.timeout = configuration.getDefaultStatementTimeout();<br>      mappedStatement.sqlCommandType = sqlCommandType; <br>      <span class="hljs-comment">// useGeneratedKeysä¸ºtrueå¹¶ä¸”æ˜¯æ’å…¥è¯­å¥ï¼Œæ‰ä¼šé€šè¿‡Jdbc3KeyGeneratorå¼€å¯keyGeneratoråŠŸèƒ½</span><br>      mappedStatement.keyGenerator = configuration.isUseGeneratedKeys() &amp;&amp; SqlCommandType.INSERT.equals(sqlCommandType) ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jdbc3KeyGenerator</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoKeyGenerator</span>();<br>      <span class="hljs-type">String</span> <span class="hljs-variable">logId</span> <span class="hljs-operator">=</span> id;<br>      <span class="hljs-keyword">if</span> (configuration.getLogPrefix() != <span class="hljs-literal">null</span>) &#123;<br>        logId = configuration.getLogPrefix() + id;<br>      &#125;<br>      mappedStatement.statementLog = LogFactory.getLog(logId);<br>      mappedStatement.lang = configuration.getDefaultScriptingLanuageInstance();<br>    &#125; <br><br>    <span class="hljs-comment">// buildæ–¹æ³•ç•¥</span><br><br>    <span class="hljs-keyword">public</span> MappedStatement <span class="hljs-title function_">build</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">assert</span> mappedStatement.configuration != <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">assert</span> mappedStatement.id != <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">assert</span> mappedStatement.sqlSource != <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">assert</span> mappedStatement.lang != <span class="hljs-literal">null</span>;<br>      mappedStatement.resultMaps = Collections.unmodifiableList(mappedStatement.resultMaps);<br>      <span class="hljs-keyword">return</span> mappedStatement;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// get æ–¹æ³•ç•¥</span><br><br>  <span class="hljs-keyword">public</span> BoundSql <span class="hljs-title function_">getBoundSql</span><span class="hljs-params">(Object parameterObject)</span> &#123;<br><span class="hljs-comment">// å…¶å®å°±æ˜¯è°ƒç”¨sqlSource.getBoundSql</span><br>    <span class="hljs-type">BoundSql</span> <span class="hljs-variable">boundSql</span> <span class="hljs-operator">=</span> sqlSource.getBoundSql(parameterObject);<br>    <span class="hljs-comment">// å‰©ä¸‹çš„å¯ä»¥æš‚æ—¶å¿½ç•¥</span><br>    List&lt;ParameterMapping&gt; parameterMappings = boundSql.getParameterMappings(); <br>    <span class="hljs-comment">// å¦‚æœè·å–åˆ°çš„boundSqlçš„å‚æ•°æ˜ å°„ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨æœ¬ç±»çš„parameterMap</span><br>    <span class="hljs-comment">// å’ŒparameterObjectæ„é€ æ–°çš„boundSql</span><br>    <span class="hljs-keyword">if</span> (parameterMappings == <span class="hljs-literal">null</span> || parameterMappings.isEmpty()) &#123;<br>      boundSql = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BoundSql</span>(configuration, boundSql.getSql(), parameterMap.getParameterMappings(), parameterObject);<br>    &#125;<br><br>    <span class="hljs-comment">// check for nested result maps in parameter mappings (issue #30)</span><br>    <span class="hljs-keyword">for</span> (ParameterMapping pm : boundSql.getParameterMappings()) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">rmId</span> <span class="hljs-operator">=</span> pm.getResultMapId();<br>      <span class="hljs-keyword">if</span> (rmId != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">ResultMap</span> <span class="hljs-variable">rm</span> <span class="hljs-operator">=</span> configuration.getResultMap(rmId);<br>        <span class="hljs-keyword">if</span> (rm != <span class="hljs-literal">null</span>) &#123;<br>          hasNestedResultMaps |= rm.hasNestedResultMaps();<br>        &#125;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> boundSql;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>11-jdbc</title>
    <link href="/2023/07/16/mybatis-source-code/11-jdbc/"/>
    <url>/2023/07/16/mybatis-source-code/11-jdbc/</url>
    
    <content type="html"><![CDATA[<h4 id="Null"><a href="#Null" class="headerlink" title="Null"></a>Null</h4><p>Â Â Â Â ä¿å­˜TypeHandlerå’ŒJdbcTypeæ˜ å°„å…³ç³»çš„æšä¸¾ç±»ã€‚åªæœ‰æœ¬æ¨¡å—çš„SqlRunnerå’Œç›¸å…³çš„æµ‹è¯•ç±»ç”¨åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Null</span> &#123;<br>  BOOLEAN(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanTypeHandler</span>(), JdbcType.BOOLEAN),<br><br>  BYTE(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteTypeHandler</span>(), JdbcType.TINYINT),<br>  SHORT(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ShortTypeHandler</span>(), JdbcType.SMALLINT),<br>  INTEGER(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerTypeHandler</span>(), JdbcType.INTEGER),<br>  LONG(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LongTypeHandler</span>(), JdbcType.BIGINT),<br>  FLOAT(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FloatTypeHandler</span>(), JdbcType.FLOAT),<br>  DOUBLE(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleTypeHandler</span>(), JdbcType.DOUBLE),<br>  BIGDECIMAL(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimalTypeHandler</span>(), JdbcType.DECIMAL),<br><br>  STRING(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTypeHandler</span>(), JdbcType.VARCHAR),<br>  CLOB(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClobTypeHandler</span>(), JdbcType.CLOB),<br>  LONGVARCHAR(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClobTypeHandler</span>(), JdbcType.LONGVARCHAR),<br><br>  BYTEARRAY(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayTypeHandler</span>(), JdbcType.LONGVARBINARY),<br>  BLOB(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BlobTypeHandler</span>(), JdbcType.BLOB),<br>  LONGVARBINARY(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BlobTypeHandler</span>(), JdbcType.LONGVARBINARY),<br><br>  OBJECT(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectTypeHandler</span>(), JdbcType.OTHER),<br>  OTHER(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectTypeHandler</span>(), JdbcType.OTHER),<br>  TIMESTAMP(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTypeHandler</span>(), JdbcType.TIMESTAMP),<br>  DATE(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DateOnlyTypeHandler</span>(), JdbcType.DATE),<br>  TIME(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeOnlyTypeHandler</span>(), JdbcType.TIME),<br>  SQLTIMESTAMP(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlTimestampTypeHandler</span>(), JdbcType.TIMESTAMP),<br>  SQLDATE(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlDateTypeHandler</span>(), JdbcType.DATE),<br>  SQLTIME(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlTimeTypeHandler</span>(), JdbcType.TIME);<br><br>  <span class="hljs-keyword">private</span> TypeHandler&lt;?&gt; typeHandler;<br>  <span class="hljs-keyword">private</span> JdbcType jdbcType;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">Null</span><span class="hljs-params">(TypeHandler&lt;?&gt; typeHandler, JdbcType jdbcType)</span> &#123;<br>    <span class="hljs-built_in">this</span>.typeHandler = typeHandler;<br>    <span class="hljs-built_in">this</span>.jdbcType = jdbcType;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> TypeHandler&lt;?&gt; getTypeHandler() &#123;<br>    <span class="hljs-keyword">return</span> typeHandler;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> JdbcType <span class="hljs-title function_">getJdbcType</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> jdbcType;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="AbstractSQL"><a href="#AbstractSQL" class="headerlink" title="AbstractSQL"></a>AbstractSQL</h4><p>Â Â Â Â AbstractSQL, Statement Builderçš„æ ¸å¿ƒ,å‚è§mybatisæ–‡æ¡£Statement Buildersä¸€ç«   </p><p>å»ºé€ è€…æ¨¡å¼ ,å¯ä»¥å‚è€ƒSQLTest</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractSQL</span>&lt;T&gt; &#123; <br><br>  <span class="hljs-comment">// é™æ€å†…éƒ¨ç±»ï¼ŒSQLè¯­å¥</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SQLStatement</span> &#123; <br><br>    <span class="hljs-comment">// 4ç§è¯­å¥ç±»å‹</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">StatementType</span> &#123;<br>      DELETE, INSERT, SELECT, UPDATE<br>    &#125; <br><br>    StatementType statementType;<br><br>    List&lt;String&gt; sets = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; select = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; tables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; join = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; innerJoin = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; outerJoin = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; leftOuterJoin = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; rightOuterJoin = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; where = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; having = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; groupBy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; orderBy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    <span class="hljs-comment">// æ ‡è®°æœ€åä¸€ä¸ªlist</span><br>    List&lt;String&gt; lastList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; columns = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    List&lt;String&gt; values = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;(); <br><br>    <span class="hljs-type">boolean</span> distinct; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SQLStatement</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125; <br><br>    <span class="hljs-comment">// SafeAppendable ç›¸æ¯” Appendable å¤šäº†ä¸ª emptyçš„æ ‡è¯†</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sqlClause</span><span class="hljs-params">(SafeAppendable builder, String keyword, List&lt;String&gt; parts, String open, String close,</span><br><span class="hljs-params">                           String conjunction)</span> &#123;<br>      <span class="hljs-keyword">if</span> (!parts.isEmpty()) &#123;<br>        <span class="hljs-keyword">if</span> (!builder.isEmpty()) &#123;<br>          <span class="hljs-comment">// å¦‚æœå‰é¢æœ‰ä¸œè¥¿ï¼Œå¦èµ·ä¸€è¡Œ</span><br>          builder.append(<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        builder.append(keyword);<br>        builder.append(<span class="hljs-string">&quot; &quot;</span>);<br>        builder.append(open);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;________&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = parts.size(); i &lt; n; i++) &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">part</span> <span class="hljs-operator">=</span> parts.get(i); <br>          <span class="hljs-comment">// å¦‚æœå½“å‰partå’Œä¸Šä¸€ä¸ªpartéƒ½ä¸æ˜¯ and æˆ– orï¼Œæ·»åŠ åˆ†éš”ç¬¦</span><br>          <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; !part.equals(AND) &amp;&amp; !part.equals(OR) &amp;&amp; !last.equals(AND) &amp;&amp; !last.equals(OR)) &#123;<br>          builder.append(conjunction);<br>          &#125;<br>          builder.append(part);<br>          last = part;<br>        &#125;<br>        builder.append(close);<br>      &#125;<br>    &#125; <br><br>    <span class="hljs-comment">// æ‹¼è£…selectè¯­å¥,å¯ä»¥çœ‹åˆ°éƒ½æ˜¯è°ƒç”¨sqlClauseï¼Œå¾ˆå¼º</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">selectSQL</span><span class="hljs-params">(SafeAppendable builder)</span> &#123;<br>      <span class="hljs-keyword">if</span> (distinct) &#123;<br>        sqlClause(builder, <span class="hljs-string">&quot;SELECT DISTINCT&quot;</span>, select, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;, &quot;</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        sqlClause(builder, <span class="hljs-string">&quot;SELECT&quot;</span>, select, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;, &quot;</span>);<br>      &#125;<br><br>      sqlClause(builder, <span class="hljs-string">&quot;FROM&quot;</span>, tables, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;, &quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;JOIN&quot;</span>, join, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;\nJOIN &quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;INNER JOIN&quot;</span>, innerJoin, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;\nINNER JOIN &quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;OUTER JOIN&quot;</span>, outerJoin, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;\nOUTER JOIN &quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;LEFT OUTER JOIN&quot;</span>, leftOuterJoin, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;\nLEFT OUTER JOIN &quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;RIGHT OUTER JOIN&quot;</span>, rightOuterJoin, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;\nRIGHT OUTER JOIN &quot;</span>);<br>      <span class="hljs-comment">// whereæ¡ä»¶é»˜è®¤æ‹¼æ¥ä¸ŠAND</span><br>      sqlClause(builder, <span class="hljs-string">&quot;WHERE&quot;</span>, where, <span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;)&quot;</span>, <span class="hljs-string">&quot; AND &quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;GROUP BY&quot;</span>, groupBy, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;, &quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;HAVING&quot;</span>, having, <span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;)&quot;</span>, <span class="hljs-string">&quot; AND &quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;ORDER BY&quot;</span>, orderBy, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;, &quot;</span>);<br>      <span class="hljs-keyword">return</span> builder.toString();<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">insertSQL</span><span class="hljs-params">(SafeAppendable builder)</span> &#123;<br>      sqlClause(builder, <span class="hljs-string">&quot;INSERT INTO&quot;</span>, tables, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;&quot;</span>, columns, <span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;)&quot;</span>, <span class="hljs-string">&quot;, &quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;VALUES&quot;</span>, values, <span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;)&quot;</span>, <span class="hljs-string">&quot;, &quot;</span>);<br>      <span class="hljs-keyword">return</span> builder.toString();<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">deleteSQL</span><span class="hljs-params">(SafeAppendable builder)</span> &#123;<br>      sqlClause(builder, <span class="hljs-string">&quot;DELETE FROM&quot;</span>, tables, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;WHERE&quot;</span>, where, <span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;)&quot;</span>, <span class="hljs-string">&quot; AND &quot;</span>);<br>      <span class="hljs-keyword">return</span> builder.toString();<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">updateSQL</span><span class="hljs-params">(SafeAppendable builder)</span> &#123;<br>      sqlClause(builder, <span class="hljs-string">&quot;UPDATE&quot;</span>, tables, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;SET&quot;</span>, sets, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;, &quot;</span>);<br>      sqlClause(builder, <span class="hljs-string">&quot;WHERE&quot;</span>, where, <span class="hljs-string">&quot;(&quot;</span>, <span class="hljs-string">&quot;)&quot;</span>, <span class="hljs-string">&quot; AND &quot;</span>);<br>      <span class="hljs-keyword">return</span> builder.toString();<br>    &#125; <br><br>    <span class="hljs-comment">// æ‹¼è£…SQL</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">sql</span><span class="hljs-params">(Appendable a)</span> &#123;<br>      <span class="hljs-type">SafeAppendable</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeAppendable</span>(a);<br>      <span class="hljs-keyword">if</span> (statementType == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br><br>      String answer;<br><br>      <span class="hljs-keyword">switch</span> (statementType) &#123;<br>        <span class="hljs-keyword">case</span> DELETE:<br>          answer = deleteSQL(builder);<br>          <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> INSERT:<br>          answer = insertSQL(builder);<br>          <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> SELECT:<br>          answer = selectSQL(builder);<br>          <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">case</span> UPDATE:<br>          answer = updateSQL(builder);<br>          <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-keyword">default</span>:<br>          answer = <span class="hljs-literal">null</span>;<br>      &#125;<br><br>      <span class="hljs-keyword">return</span> answer;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">AND</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;) \nAND (&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">OR</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;) \nOR (&quot;</span>;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">SQLStatement</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLStatement</span>(); <br><br>  <span class="hljs-comment">// æŠ½è±¡æ¥å£ï¼Œç•™ç»™å­ç±»å®ç°</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">getSelf</span><span class="hljs-params">()</span>; <br><br>  <span class="hljs-comment">// ä¸‹é¢çš„æ–¹æ³•éƒ½æ˜¯æ„é€  SQLStatement</span><br>  <span class="hljs-comment">// æ„é€ updateè¯­å¥</span><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">UPDATE</span><span class="hljs-params">(String table)</span> &#123;<br>    sql().statementType = SQLStatement.StatementType.UPDATE;<br>    sql().tables.add(table);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-comment">// setå…³é”®å­—</span><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">SET</span><span class="hljs-params">(String sets)</span> &#123;<br>    sql().sets.add(sets);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">INSERT_INTO</span><span class="hljs-params">(String tableName)</span> &#123;<br>    sql().statementType = SQLStatement.StatementType.INSERT;<br>    sql().tables.add(tableName);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">VALUES</span><span class="hljs-params">(String columns, String values)</span> &#123;<br>    sql().columns.add(columns);<br>    sql().values.add(values);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">SELECT</span><span class="hljs-params">(String columns)</span> &#123;<br>    sql().statementType = SQLStatement.StatementType.SELECT;<br>    sql().select.add(columns);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">SELECT_DISTINCT</span><span class="hljs-params">(String columns)</span> &#123;<br>    sql().distinct = <span class="hljs-literal">true</span>;<br>    SELECT(columns);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">DELETE_FROM</span><span class="hljs-params">(String table)</span> &#123;<br>    sql().statementType = SQLStatement.StatementType.DELETE;<br>    sql().tables.add(table);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">FROM</span><span class="hljs-params">(String table)</span> &#123;<br>    sql().tables.add(table);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">JOIN</span><span class="hljs-params">(String join)</span> &#123;<br>    sql().join.add(join);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">INNER_JOIN</span><span class="hljs-params">(String join)</span> &#123;<br>    sql().innerJoin.add(join);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">LEFT_OUTER_JOIN</span><span class="hljs-params">(String join)</span> &#123;<br>    sql().leftOuterJoin.add(join);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">RIGHT_OUTER_JOIN</span><span class="hljs-params">(String join)</span> &#123;<br>    sql().rightOuterJoin.add(join);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">OUTER_JOIN</span><span class="hljs-params">(String join)</span> &#123;<br>    sql().outerJoin.add(join);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">WHERE</span><span class="hljs-params">(String conditions)</span> &#123;<br>    sql().where.add(conditions);<br>    <span class="hljs-comment">// æ ‡è®°æœ€åä¸€ä¸ªlistï¼ˆå¯èƒ½æ˜¯æœ€åä¸€ä¸ªï¼‰</span><br>    <span class="hljs-comment">// è¿™ä¸ªlastListä¼¼ä¹æ²¡æœ‰ç”¨åˆ°</span><br>    sql().lastList = sql().where;<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">OR</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">// æœ€åä¸€ä¸ªliståŠ ä¸ŠOR</span><br>    sql().lastList.add(OR);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">AND</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-comment">// æœ€åä¸€ä¸ªliståŠ ä¸ŠAND</span><br>    sql().lastList.add(AND);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">GROUP_BY</span><span class="hljs-params">(String columns)</span> &#123;<br>    sql().groupBy.add(columns);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">HAVING</span><span class="hljs-params">(String conditions)</span> &#123;<br>    sql().having.add(conditions);<br>    <span class="hljs-comment">// æ ‡è®°æœ€åä¸€ä¸ªlist</span><br>    sql().lastList = sql().having;<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">ORDER_BY</span><span class="hljs-params">(String columns)</span> &#123;<br>    sql().orderBy.add(columns);<br>    <span class="hljs-keyword">return</span> getSelf();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> SQLStatement <span class="hljs-title function_">sql</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> sql;<br>  &#125; <br><br>  <span class="hljs-comment">// ä½¿ç”¨æä¾›çš„Appenderæ„é€ sqlè¯­å¥</span><br>  <span class="hljs-keyword">public</span> &lt;A <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Appendable</span>&gt; A <span class="hljs-title function_">usingAppender</span><span class="hljs-params">(A a)</span> &#123;<br>    sql().sql(a);<br>    <span class="hljs-keyword">return</span> a;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// é»˜è®¤ä½¿ç”¨ StringBuilder æ„é€ sqlè¯­å¥å¹¶è¿”å›</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    sql().sql(sb);<br>    <span class="hljs-keyword">return</span> sb.toString();<br>  &#125; <br><br>  <span class="hljs-comment">// å®‰å…¨çš„Appendable</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeAppendable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Appendable a;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">empty</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SafeAppendable</span><span class="hljs-params">(Appendable a)</span> &#123;<br>      <span class="hljs-built_in">super</span>();<br>      <span class="hljs-built_in">this</span>.a = a;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> SafeAppendable <span class="hljs-title function_">append</span><span class="hljs-params">(CharSequence s)</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (empty &amp;&amp; s.length() &gt; <span class="hljs-number">0</span>) &#123;<br>          empty = <span class="hljs-literal">false</span>;<br>        &#125;<br>        a.append(s);<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> empty;<br>    &#125;<br><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SQL</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSQL</span>&lt;SQL&gt; &#123;<br><br>  <span class="hljs-comment">// fluent API </span><br>  <span class="hljs-comment">// æ„Ÿè§‰è¿™æ˜¯ä¸ºäº†æŠ½è±¡è€ŒæŠ½è±¡</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SQL <span class="hljs-title function_">getSelf</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br></code></pre></td></tr></table></figure><h4 id="ScriptRunner"><a href="#ScriptRunner" class="headerlink" title="ScriptRunner"></a>ScriptRunner</h4><p>Â Â Â Â  Â è„šæœ¬è¿è¡Œå™¨,å¯ä»¥è¿è¡ŒSQLè„šæœ¬ï¼Œå¦‚å»ºè¡¨ï¼Œæ’å…¥æ•°æ®ï¼Œä½œä¸ºå•å…ƒæµ‹è¯•çš„å‰æœŸå‡†å¤‡ ã€‚è¿™ä¸ªç±»å…¶å®å¯ä»¥è¢«æ‰€æœ‰é¡¹ç›®çš„å•å…ƒæµ‹è¯•ä½œä¸ºå·¥å…·æ‰€åˆ©ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScriptRunner</span> &#123; <br><br>  <span class="hljs-comment">// æ¢è¡Œåˆ†å‰²ç¬¦ï¼Œé»˜è®¤æ˜¯ &quot;\n&quot;</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LINE_SEPARATOR</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;line.separator&quot;</span>, <span class="hljs-string">&quot;\n&quot;</span>); <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_DELIMITER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;;&quot;</span>;<br><br>  <span class="hljs-keyword">private</span> Connection connection; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> stopOnError;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> autoCommit;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> sendFullScript;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> removeCRs;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">escapeProcessing</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">logWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(System.out);<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">errorLogWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(System.err);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">delimiter</span> <span class="hljs-operator">=</span> DEFAULT_DELIMITER;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">fullLineDelimiter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScriptRunner</span><span class="hljs-params">(Connection connection)</span> &#123;<br>    <span class="hljs-built_in">this</span>.connection = connection;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runScript</span><span class="hljs-params">(Reader reader)</span> &#123;<br>    setAutoCommit();<br><br>    <span class="hljs-keyword">try</span> &#123; <br>      <span class="hljs-comment">// ä¸€æ¬¡æ‰§è¡Œè„šæœ¬é‡Œçš„æ‰€æœ‰sqlè¯­å¥</span><br>      <span class="hljs-keyword">if</span> (sendFullScript) &#123;<br>        executeFullScript(reader);<br>      &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// ä¸€è¡Œä¸€è¡Œæ‰§è¡Œè„šæœ¬é‡Œçš„sqlè¯­å¥</span><br>        executeLineByLine(reader);<br>      &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123; <br>      <span class="hljs-comment">// æ— è®ºæœ‰æ²¡æœ‰æ‰§è¡ŒæˆåŠŸéƒ½å›æ»š</span><br>      rollbackConnection();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// è®¾ç½® connection çš„ autoCommitå±æ€§</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAutoCommit</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (autoCommit != connection.getAutoCommit()) &#123;<br>        connection.setAutoCommit(autoCommit);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeSqlException</span>(<span class="hljs-string">&quot;Could not set AutoCommit to &quot;</span> + autoCommit + <span class="hljs-string">&quot;. Cause: &quot;</span> + t, t);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeFullScript</span><span class="hljs-params">(Reader reader)</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">lineReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(reader);<br>      String line;<br>      <span class="hljs-keyword">while</span> ((line = lineReader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>        script.append(line);<br>        script.append(LINE_SEPARATOR);<br>      &#125;<br>      executeStatement(script.toString());<br>      commitConnection();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Error executing: &quot;</span> + script + <span class="hljs-string">&quot;.  Cause: &quot;</span> + e;<br>      printlnError(message);<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeSqlException</span>(message, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeStatement</span><span class="hljs-params">(String command)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// å°±æ˜¯ç”¨æœ€ç®€å•çš„JDBCæ¥æ‰§è¡Œ</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">hasResults</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.createStatement();<br>    statement.setEscapeProcessing(escapeProcessing);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> command;<br>    <span class="hljs-keyword">if</span> (removeCRs) &#123;<br>      sql = sql.replaceAll(<span class="hljs-string">&quot;\r\n&quot;</span>, <span class="hljs-string">&quot;\n&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (stopOnError) &#123;<br>      hasResults = statement.execute(sql);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        hasResults = statement.execute(sql);<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Error executing: &quot;</span> + command + <span class="hljs-string">&quot;.  Cause: &quot;</span> + e;<br>        printlnError(message);<br>      &#125;<br>    &#125;<br>    printResults(statement, hasResults);<br>    <span class="hljs-keyword">try</span> &#123;<br>      statement.close();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-comment">// Ignore to workaround a bug in some connection pools</span><br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ‰“å°è¯­å¥æ‰§è¡Œç»“æœï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printResults</span><span class="hljs-params">(Statement statement, <span class="hljs-type">boolean</span> hasResults)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (hasResults) &#123;<br>        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> statement.getResultSet();<br>        <span class="hljs-keyword">if</span> (rs != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> rs.getMetaData();<br>          <span class="hljs-type">int</span> <span class="hljs-variable">cols</span> <span class="hljs-operator">=</span> md.getColumnCount(); <br>          <span class="hljs-comment">// å…ˆæ‰“å°ä¸€è¡Œåˆ—å</span><br>          <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; cols; i++) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> md.getColumnLabel(i + <span class="hljs-number">1</span>);<br>            print(name + <span class="hljs-string">&quot;\t&quot;</span>);<br>          &#125;<br>          println(<span class="hljs-string">&quot;&quot;</span>); <br>          <span class="hljs-comment">// å†æ‰“å°æ¯ä¸€è¡Œçš„æ•°æ®</span><br>          <span class="hljs-keyword">while</span> (rs.next()) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; cols; i++) &#123;<br>              <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> rs.getString(i + <span class="hljs-number">1</span>);<br>              print(value + <span class="hljs-string">&quot;\t&quot;</span>);<br>            &#125;<br>            println(<span class="hljs-string">&quot;&quot;</span>);<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      printlnError(<span class="hljs-string">&quot;Error printing results: &quot;</span> + e.getMessage());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æäº¤</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commitConnection</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (!connection.getAutoCommit()) &#123;<br>        connection.commit();<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeSqlException</span>(<span class="hljs-string">&quot;Could not commit transaction. Cause: &quot;</span> + t, t);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeLineByLine</span><span class="hljs-params">(Reader reader)</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">lineReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(reader);<br>      String line;<br>      <span class="hljs-keyword">while</span> ((line = lineReader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>        command = handleLine(command, line);<br>      &#125;<br>      commitConnection();<br>      checkForMissingLineTerminator(command);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Error executing: &quot;</span> + command + <span class="hljs-string">&quot;.  Cause: &quot;</span> + e;<br>      printlnError(message);<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeSqlException</span>(message, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> StringBuilder <span class="hljs-title function_">handleLine</span><span class="hljs-params">(StringBuilder command, String line)</span> <span class="hljs-keyword">throws</span> SQLException, UnsupportedEncodingException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">trimmedLine</span> <span class="hljs-operator">=</span> line.trim();<br>    <span class="hljs-keyword">if</span> (lineIsComment(trimmedLine)) &#123;<br>      <span class="hljs-comment">// å¤„ç†æ³¨é‡Šï¼Œç›´æ¥æ‰“å°</span><br>      println(trimmedLine);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (commandReadyToExecute(trimmedLine)) &#123;<br>      <span class="hljs-comment">// å¦‚æœæœ‰åˆ†å·ï¼Œæ‰§è¡Œ</span><br>      command.append(line.substring(<span class="hljs-number">0</span>, line.lastIndexOf(delimiter)));<br>      command.append(LINE_SEPARATOR);<br>      println(command);<br>      executeStatement(command.toString());<br>      command.setLength(<span class="hljs-number">0</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (trimmedLine.length() &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// æ²¡æœ‰åˆ†å·ï¼Œå…ˆåŠ å…¥ï¼Œç­‰åé¢çš„åˆ†å·</span><br>      command.append(line);<br>      command.append(LINE_SEPARATOR);<br>    &#125;<br>    <span class="hljs-keyword">return</span> command;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">lineIsComment</span><span class="hljs-params">(String trimmedLine)</span> &#123;<br>    <span class="hljs-keyword">return</span> trimmedLine.startsWith(<span class="hljs-string">&quot;//&quot;</span>) || trimmedLine.startsWith(<span class="hljs-string">&quot;--&quot;</span>);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">commandReadyToExecute</span><span class="hljs-params">(String trimmedLine)</span> &#123;<br>    <span class="hljs-comment">// issue #561 remove anything after the delimiter</span><br>    <span class="hljs-keyword">return</span> !fullLineDelimiter &amp;&amp; trimmedLine.contains(delimiter) || fullLineDelimiter &amp;&amp; trimmedLine.equals(delimiter);<br>  &#125; <br><br>  <span class="hljs-comment">// æœ€åä¸€æ¡è¯­å¥æ²¡æœ‰ ; </span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkForMissingLineTerminator</span><span class="hljs-params">(StringBuilder command)</span> &#123;<br>    <span class="hljs-keyword">if</span> (command != <span class="hljs-literal">null</span> &amp;&amp; command.toString().trim().length() &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeSqlException</span>(<span class="hljs-string">&quot;Line missing end-of-line terminator (&quot;</span> + delimiter + <span class="hljs-string">&quot;) =&gt; &quot;</span> + command);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollbackConnection</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (!connection.getAutoCommit()) &#123;<br>        connection.rollback();<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-comment">// ignore</span><br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å‰©ä¸‹çš„getã€setæ–¹æ³•å’Œprintæ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SqlRunner"><a href="#SqlRunner" class="headerlink" title="SqlRunner"></a>SqlRunner</h4><p>Â Â Â Â SQLè¿è¡Œå™¨,å¯ä»¥è¿è¡ŒSQLï¼Œå¦‚selectï¼Œä½œä¸ºå•å…ƒæµ‹è¯•çš„æ­£å¼æµ‹è¯• ã€‚è¿™ä¸ªç±»å…¶å®å¯ä»¥è¢«æ‰€æœ‰é¡¹ç›®çš„å•å…ƒæµ‹è¯•ä½œä¸ºå·¥å…·æ‰€åˆ©ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlRunner</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">NO_GENERATED_KEY</span> <span class="hljs-operator">=</span> Integer.MIN_VALUE + <span class="hljs-number">1001</span>;<br><br>  <span class="hljs-keyword">private</span> Connection connection;<br>  <span class="hljs-keyword">private</span> TypeHandlerRegistry typeHandlerRegistry;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> useGeneratedKeySupport; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SqlRunner</span><span class="hljs-params">(Connection connection)</span> &#123;<br>    <span class="hljs-built_in">this</span>.connection = connection;<br>    <span class="hljs-built_in">this</span>.typeHandlerRegistry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeHandlerRegistry</span>();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String sql, Object... args)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    List&lt;Map&lt;String, Object&gt;&gt; results = selectAll(sql, args);<br>    <span class="hljs-keyword">if</span> (results.size() != <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">&quot;Statement returned &quot;</span> + results.size() + <span class="hljs-string">&quot; results where exactly one (1) was expected.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> results.get(<span class="hljs-number">0</span>);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">selectAll</span><span class="hljs-params">(String sql, Object... args)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);<br>    <span class="hljs-keyword">try</span> &#123;<br>      setParameters(ps, args);<br>      <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> ps.executeQuery();<br>      <span class="hljs-keyword">return</span> getResults(rs);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        ps.close();<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-comment">//ignore</span><br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å–å¾—ç»“æœ</span><br>  <span class="hljs-keyword">private</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">getResults</span><span class="hljs-params">(ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      List&lt;Map&lt;String, Object&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Map&lt;String, Object&gt;&gt;();<br>      List&lt;String&gt; columns = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>      List&lt;TypeHandler&lt;?&gt;&gt; typeHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;TypeHandler&lt;?&gt;&gt;();<br>      <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">rsmd</span> <span class="hljs-operator">=</span> rs.getMetaData();<br>      <span class="hljs-comment">// å…ˆè®¡ç®—è¦å“ªäº›åˆ—ï¼Œä»¥åŠåˆ—çš„ç±»å‹ï¼ˆTypeHandlerï¼‰</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = rsmd.getColumnCount(); i &lt; n; i++) &#123;<br>        columns.add(rsmd.getColumnLabel(i + <span class="hljs-number">1</span>));<br>        <span class="hljs-keyword">try</span> &#123;<br>          Class&lt;?&gt; type = Resources.classForName(rsmd.getColumnClassName(i + <span class="hljs-number">1</span>));<br>          TypeHandler&lt;?&gt; typeHandler = typeHandlerRegistry.getTypeHandler(type); <br>          <span class="hljs-comment">// æ²¡æœ‰ TypeHandler çš„è¯ä½¿ç”¨ ObjectTypeHandler</span><br>          <span class="hljs-keyword">if</span> (typeHandler == <span class="hljs-literal">null</span>) &#123;<br>            typeHandler = typeHandlerRegistry.getTypeHandler(Object.class);<br>          &#125;<br>          typeHandlers.add(typeHandler);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          typeHandlers.add(typeHandlerRegistry.getTypeHandler(Object.class));<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">while</span> (rs.next()) &#123;<br>        Map&lt;String, Object&gt; row = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = columns.size(); i &lt; n; i++) &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> columns.get(i);<br>          TypeHandler&lt;?&gt; handler = typeHandlers.get(i);<br>          <span class="hljs-comment">// å·§å¦™çš„åˆ©ç”¨TypeHandleræ¥å–å¾—ç»“æœ</span><br>          row.put(name.toUpperCase(Locale.ENGLISH), handler.getResult(rs, name));<br>        &#125;<br>        list.add(row);<br>      &#125;<br>      <span class="hljs-keyword">return</span> list;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (rs != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            rs.close();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-comment">// ignore</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ‰§è¡Œinsertè¯­å¥</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String sql, Object... args)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    PreparedStatement ps;<br>    <span class="hljs-keyword">if</span> (useGeneratedKeySupport) &#123; <br>      <span class="hljs-comment">// è¿”å›ç”Ÿæˆçš„id</span><br>      ps = connection.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      ps = connection.prepareStatement(sql);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      setParameters(ps, args);<br>      ps.executeUpdate();<br>      <span class="hljs-keyword">if</span> (useGeneratedKeySupport) &#123;<br>        List&lt;Map&lt;String, Object&gt;&gt; keys = getResults(ps.getGeneratedKeys());<br>        <span class="hljs-keyword">if</span> (keys.size() == <span class="hljs-number">1</span>) &#123;<br>          Map&lt;String, Object&gt; key = keys.get(<span class="hljs-number">0</span>);<br>          Iterator&lt;Object&gt; i = key.values().iterator();<br>          <span class="hljs-keyword">if</span> (i.hasNext()) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">genkey</span> <span class="hljs-operator">=</span> i.next();<br>            <span class="hljs-keyword">if</span> (genkey != <span class="hljs-literal">null</span>) &#123;<br>              <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">return</span> Integer.parseInt(genkey.toString());<br>              &#125; <span class="hljs-keyword">catch</span> (NumberFormatException e) &#123;<br>                <span class="hljs-comment">//ignore, no numeric key suppot</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">return</span> NO_GENERATED_KEY;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        ps.close();<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-comment">//ignore</span><br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// è®¾ç½®å‚æ•°</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameters</span><span class="hljs-params">(PreparedStatement ps, Object... args)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = args.length; i &lt; n; i++) &#123;<br>      <span class="hljs-keyword">if</span> (args[i] == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">&quot;SqlRunner requires an instance of Null to represent typed null values for JDBC compatibility&quot;</span>);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args[i] <span class="hljs-keyword">instanceof</span> Null) &#123;<br>        ((Null) args[i]).getTypeHandler().setParameter(ps, i + <span class="hljs-number">1</span>, <span class="hljs-literal">null</span>, ((Null) args[i]).getJdbcType());<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å·§å¦™çš„åˆ©ç”¨TypeHandleræ¥è®¾ç½®å‚æ•°</span><br>        <span class="hljs-type">TypeHandler</span> <span class="hljs-variable">typeHandler</span> <span class="hljs-operator">=</span> typeHandlerRegistry.getTypeHandler(args[i].getClass());<br>        <span class="hljs-keyword">if</span> (typeHandler == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">&quot;SqlRunner could not find a TypeHandler instance for &quot;</span> + args[i].getClass());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          typeHandler.setParameter(ps, i + <span class="hljs-number">1</span>, args[i], <span class="hljs-literal">null</span>);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ‰§è¡Œupdateè¯­å¥</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String sql, Object... args)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> connection.prepareStatement(sql);<br>    <span class="hljs-keyword">try</span> &#123;<br>      setParameters(ps, args);<br>      <span class="hljs-keyword">return</span> ps.executeUpdate();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        ps.close();<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-comment">//ignore</span><br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// deleteå’Œupdateå¤„ç†ç›¸åŒ</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String sql, Object... args)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> update(sql, args);<br>  &#125; <br><br>  <span class="hljs-comment">// æ‰§è¡Œsqlè¯­å¥</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(String sql)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> connection.createStatement();<br>    <span class="hljs-keyword">try</span> &#123;<br>      stmt.execute(sql);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        stmt.close();<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-comment">//ignore</span><br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// è®¾ç½®æ˜¯å¦å¯ç”¨ è·å–æ’å…¥æ•°æ®è¡Œçš„id</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUseGeneratedKeySupport</span><span class="hljs-params">(<span class="hljs-type">boolean</span> useGeneratedKeySupport)</span> &#123;<br>    <span class="hljs-built_in">this</span>.useGeneratedKeySupport = useGeneratedKeySupport;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å†™åœ¨æœ€å"><a href="#å†™åœ¨æœ€å" class="headerlink" title="å†™åœ¨æœ€å"></a>å†™åœ¨æœ€å</h4><p>Â Â Â Â SelectBuilder å’Œ SqlBuilderåªæ˜¯å¯¹ SQLè¿›è¡Œäº†ç®€å•çš„å°è£…ï¼Œå°±ä¸åšä»£ç åˆ†æäº†</p>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>10-session</title>
    <link href="/2023/07/13/mybatis-source-code/10-session/"/>
    <url>/2023/07/13/mybatis-source-code/10-session/</url>
    
    <content type="html"><![CDATA[<h4 id="AutoMappingBehavior"><a href="#AutoMappingBehavior" class="headerlink" title="AutoMappingBehavior"></a>AutoMappingBehavior</h4><p>â€‹ æŒ‡å®šMyBatisæ˜¯å¦ä»¥åŠå¦‚ä½•å°†åˆ—è‡ªåŠ¨æ˜ å°„åˆ°å­—æ®µ&#x2F;å±æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">AutoMappingBehavior</span> &#123; <br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Disables auto-mapping.</span><br><span class="hljs-comment">   */</span><br>  NONE,<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Will only auto-map results with no nested result mappings defined inside.</span><br><span class="hljs-comment">   * å°†åªè‡ªåŠ¨æ˜ å°„å†…éƒ¨æœªå®šä¹‰åµŒå¥—ç»“æœæ˜ å°„çš„ç»“æœã€‚</span><br><span class="hljs-comment">   */</span><br>  PARTIAL,<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Will auto-map result mappings of any complexity (containing nested or otherwise).</span><br><span class="hljs-comment">   * å°†è‡ªåŠ¨æ˜ å°„ä»»æ„å¤æ‚åº¦çš„ç»“æœæ˜ å°„ï¼ˆåŒ…æ‹¬åµŒå¥—æˆ–å…¶å®ƒï¼‰</span><br><span class="hljs-comment">   */</span><br>  FULL  <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ExecutorType"><a href="#ExecutorType" class="headerlink" title="ExecutorType"></a>ExecutorType</h4><p>â€‹ æ‰§è¡Œå™¨ç±»å‹æšä¸¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ExecutorType</span> &#123; <br><br>    <span class="hljs-comment">// ExecutorType.SIMPLE</span><br>    <span class="hljs-comment">// è¿™ä¸ªæ‰§è¡Œå™¨ç±»å‹ä¸åšç‰¹æ®Šçš„äº‹æƒ…ã€‚å®ƒä¸ºæ¯ä¸ªè¯­å¥çš„æ‰§è¡Œåˆ›å»ºä¸€ä¸ªæ–°çš„é¢„å¤„ç†è¯­å¥ã€‚</span><br>    <span class="hljs-comment">// ExecutorType.REUSE</span><br>    <span class="hljs-comment">// è¿™ä¸ªæ‰§è¡Œå™¨ç±»å‹ä¼šå¤ç”¨é¢„å¤„ç†è¯­å¥ã€‚</span><br>    <span class="hljs-comment">// ExecutorType.BATCH</span><br>    <span class="hljs-comment">// è¿™ä¸ªæ‰§è¡Œå™¨ä¼šæ‰¹é‡æ‰§è¡Œæ‰€æœ‰æ›´æ–°è¯­å¥ï¼Œå¦‚æœSELECTåœ¨å®ƒä»¬ä¸­é—´æ‰§è¡Œè¿˜ä¼šæ ‡å®šå®ƒä»¬æ˜¯å¿…é¡»çš„ï¼Œæ¥ä¿è¯ä¸€ä¸ªç®€å•å¹¶æ˜“äºç†è§£çš„è¡Œä¸ºã€‚</span><br>    SIMPLE, REUSE, BATCH<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="LocalCacheScope"><a href="#LocalCacheScope" class="headerlink" title="LocalCacheScope"></a>LocalCacheScope</h4><p>â€‹ æœ¬åœ°ç¼“å­˜èŒƒå›´æšä¸¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * æœ¬åœ°ç¼“å­˜æœºåˆ¶ï¼ˆLocal Cacheï¼‰é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼ˆcircular referencesï¼‰å’ŒåŠ é€Ÿé‡å¤çš„åµŒå¥—æŸ¥è¯¢ã€‚</span><br><span class="hljs-comment"> * é»˜è®¤å€¼ä¸º SESSIONï¼Œè¿™ç§æƒ…å†µä¸‹ä¼šç¼“å­˜ä¸€ä¸ªä¼šè¯ä¸­æ‰§è¡Œçš„æ‰€æœ‰æŸ¥è¯¢ã€‚</span><br><span class="hljs-comment"> * è‹¥è®¾ç½®å€¼ä¸º STATEMENTï¼Œæœ¬åœ°ä¼šè¯ä»…ç”¨åœ¨è¯­å¥æ‰§è¡Œä¸Šï¼Œå¯¹ç›¸åŒ SqlSession çš„ä¸åŒè°ƒç”¨å°†ä¸ä¼šå…±äº«æ•°æ®ï¼Œç›¸å½“äºæ²¡æœ‰ç¼“å­˜ã€‚</span><br><span class="hljs-comment"> * å¯ä»¥å‚è€ƒä¸‹é¢çš„æ–‡ç« è¿›è¡Œæ·±å…¥äº†è§£</span><br><span class="hljs-comment"> * https://tech.meituan.com/2018/01/19/mybatis-cache.html</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">LocalCacheScope</span> &#123;<br>  SESSION,STATEMENT<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="TransactionIsolationLevel"><a href="#TransactionIsolationLevel" class="headerlink" title="TransactionIsolationLevel"></a>TransactionIsolationLevel</h4><p>â€‹ äº‹åŠ¡éš”ç¦»çº§åˆ«æšä¸¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TransactionIsolationLevel</span> &#123;<br>  <span class="hljs-comment">// åŒ…æ‹¬JDBCæ”¯æŒçš„5ä¸ªçº§åˆ«</span><br>  NONE(Connection.TRANSACTION_NONE),<br>  READ_COMMITTED(Connection.TRANSACTION_READ_COMMITTED),<br>  READ_UNCOMMITTED(Connection.TRANSACTION_READ_UNCOMMITTED),<br>  REPEATABLE_READ(Connection.TRANSACTION_REPEATABLE_READ),<br>  SERIALIZABLE(Connection.TRANSACTION_SERIALIZABLE);<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> level;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">TransactionIsolationLevel</span><span class="hljs-params">(<span class="hljs-type">int</span> level)</span> &#123;<br>    <span class="hljs-built_in">this</span>.level = level;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLevel</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> level;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="RowBounds"><a href="#RowBounds" class="headerlink" title="RowBounds"></a>RowBounds</h4><p>â€‹ åˆ†é¡µç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RowBounds</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">NO_ROW_OFFSET</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">NO_ROW_LIMIT</span> <span class="hljs-operator">=</span> Integer.MAX_VALUE;<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">RowBounds</span> <span class="hljs-variable">DEFAULT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RowBounds</span>();<br><br>  <span class="hljs-comment">// offset,limitå°±ç­‰äºä¸€èˆ¬åˆ†é¡µçš„start,limit,</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> offset;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> limit;<br><br>  <span class="hljs-comment">// é»˜è®¤æ˜¯ä¸€é¡µInteger.MAX_VALUEæ¡</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">RowBounds</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.offset = NO_ROW_OFFSET;<br>    <span class="hljs-built_in">this</span>.limit = NO_ROW_LIMIT;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">RowBounds</span><span class="hljs-params">(<span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span> &#123;<br>    <span class="hljs-built_in">this</span>.offset = offset;<br>    <span class="hljs-built_in">this</span>.limit = limit;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOffset</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> offset;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getLimit</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> limit;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SqlSession"><a href="#SqlSession" class="headerlink" title="SqlSession"></a>SqlSession</h4><p>â€‹ ä½¿ç”¨MyBatisçš„ä¸»è¦Javaæ¥å£ã€‚é€šè¿‡è¿™ä¸ªæ¥å£ä½ èƒ½æ‰§è¡Œsqlå‘½ä»¤ï¼Œè·å–æ˜ å°„å™¨ä»¥åŠç®¡ç†äº‹åŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SqlSession</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Closeable</span> &#123; <br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieve a single row mapped from the statement key</span><br><span class="hljs-comment">   * æ ¹æ®æŒ‡å®šçš„statementè·å–ä¸€æ¡è®°å½•çš„å°è£…å¯¹è±¡</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;T&gt; the returned object type å°è£…ä¹‹åçš„å¯¹è±¡ç±»å‹</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Mapped object å°è£…ä¹‹åçš„å¯¹è±¡</span><br><span class="hljs-comment">   */</span><br>  &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieve a single row mapped from the statement key and parameter.</span><br><span class="hljs-comment">   * æ ¹æ®æŒ‡å®šçš„statementè·å–ä¸€æ¡è®°å½•çš„å°è£…å¯¹è±¡ï¼Œåªä¸è¿‡è¿™ä¸ªæ–¹æ³•å…è®¸æˆ‘ä»¬ç»™sqlä¼ é€’ä¸€äº›å‚æ•°</span><br><span class="hljs-comment">   * ä¸€èˆ¬åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œè¿™ä¸ªå‚æ•°ä¼ é€’çš„æ˜¯pojoï¼Œæˆ–è€…Mapæˆ–è€…ImmutableMap</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;T&gt; the returned object type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter A parameter object to pass to the statement.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Mapped object</span><br><span class="hljs-comment">   */</span><br>  &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement, Object parameter)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieve a list of mapped objects from the statement key and parameter.</span><br><span class="hljs-comment">   * æ ¹æ®æŒ‡å®šçš„statementè·å–å¤šæ¡è®°å½•</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;E&gt; the returned list element type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> List of mapped object</span><br><span class="hljs-comment">   */</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieve a list of mapped objects from the statement key and parameter.</span><br><span class="hljs-comment">   * è·å–å¤šæ¡è®°å½•ï¼Œè¿™ä¸ªæ–¹æ³•å…è®¸æˆ‘ä»¬ä¼ é€’ä¸€äº›å‚æ•°</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;E&gt; the returned list element type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter A parameter object to pass to the statement.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> List of mapped object</span><br><span class="hljs-comment">   */</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement, Object parameter)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieve a list of mapped objects from the statement key and parameter,</span><br><span class="hljs-comment">   * within the specified row bounds.</span><br><span class="hljs-comment">   * è·å–å¤šæ¡è®°å½•ï¼Œè¿™ä¸ªæ–¹æ³•å®¹è®¸æˆ‘ä»¬å¯ä»¥ä¼ é€’ä¸€äº›å‚æ•°ï¼Œä¸è¿‡è¿™ä¸ªæ–¹æ³•å®¹è®¸æˆ‘ä»¬è¿›è¡Œ</span><br><span class="hljs-comment">   * åˆ†é¡µæŸ¥è¯¢ã€‚</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * éœ€è¦æ³¨æ„çš„æ˜¯é»˜è®¤æƒ…å†µä¸‹ï¼ŒMybatisä¸ºäº†æ‰©å±•æ€§ï¼Œä»…ä»…æ”¯æŒå†…å­˜åˆ†é¡µã€‚ä¹Ÿå°±æ˜¯ä¼šå…ˆæŠŠ</span><br><span class="hljs-comment">   * æ‰€æœ‰çš„æ•°æ®æŸ¥è¯¢å‡ºæ¥ï¼Œç„¶ååœ¨å†…å­˜ä¸­è¿›è¡Œåˆ†é¡µã€‚å› æ­¤åœ¨å®é™…çš„æƒ…å†µä¸­ï¼Œéœ€è¦æ³¨æ„</span><br><span class="hljs-comment">   * è¿™ä¸€ç‚¹ã€‚</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * ä¸€èˆ¬æƒ…å†µä¸‹å…¬å¸éƒ½ä¼šç¼–å†™è‡ªå·±çš„Mybatis ç‰©ç†åˆ†é¡µæ’ä»¶</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;E&gt; the returned list element type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter A parameter object to pass to the statement.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> rowBounds  Bounds to limit object retrieval</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> List of mapped object</span><br><span class="hljs-comment">   */</span><br>  &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * The selectMap is a special case in that it is designed to convert a list</span><br><span class="hljs-comment">   * of results into a Map based on one of the properties in the resulting</span><br><span class="hljs-comment">   * objects.</span><br><span class="hljs-comment">   * Eg. Return a of Map[Integer,Author] for selectMap(&quot;selectAuthors&quot;,&quot;id&quot;)</span><br><span class="hljs-comment">   * å°†æŸ¥è¯¢åˆ°çš„ç»“æœåˆ—è¡¨è½¬æ¢ä¸ºMapç±»å‹ã€‚</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;K&gt; the returned Map keys type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;V&gt; the returned Map values type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> mapKey The property to use as key for each value in the list. </span><br><span class="hljs-comment">   * mapKeyï¼šå¯¹äºç»“æœé›†ä¸­çš„æ¯ä¸ªå€¼ï¼Œå…¶åœ¨è¿”å›çš„Mapä¸­çš„keyç”±å€¼ä¸­çš„mapKeyå±æ€§æ ‡è¯†</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Map containing key pair data.</span><br><span class="hljs-comment">   */</span><br>  &lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-title function_">selectMap</span><span class="hljs-params">(String statement, String mapKey)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * The selectMap is a special case in that it is designed to convert a list</span><br><span class="hljs-comment">   * of results into a Map based on one of the properties in the resulting</span><br><span class="hljs-comment">   * objects.</span><br><span class="hljs-comment">   * å°†æŸ¥è¯¢åˆ°çš„ç»“æœåˆ—è¡¨è½¬æ¢ä¸ºMapç±»å‹ã€‚è¿™ä¸ªæ–¹æ³•å®¹è®¸æˆ‘ä»¬ä¼ å…¥éœ€è¦çš„å‚æ•°</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;K&gt; the returned Map keys type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;V&gt; the returned Map values type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter A parameter object to pass to the statement.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> mapKey The property to use as key for each value in the list.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Map containing key pair data.</span><br><span class="hljs-comment">   */</span><br>  &lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-title function_">selectMap</span><span class="hljs-params">(String statement, Object parameter, String mapKey)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * The selectMap is a special case in that it is designed to convert a list</span><br><span class="hljs-comment">   * of results into a Map based on one of the properties in the resulting</span><br><span class="hljs-comment">   * objects.</span><br><span class="hljs-comment">   * è·å–å¤šæ¡è®°å½•,åŠ ä¸Šåˆ†é¡µ,å¹¶å­˜å…¥Map</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;K&gt; the returned Map keys type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;V&gt; the returned Map values type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter A parameter object to pass to the statement.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> mapKey The property to use as key for each value in the list.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> rowBounds  Bounds to limit object retrieval</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Map containing key pair data.</span><br><span class="hljs-comment">   */</span><br>  &lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-title function_">selectMap</span><span class="hljs-params">(String statement, Object parameter, String mapKey, RowBounds rowBounds)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieve a single row mapped from the statement key and parameter</span><br><span class="hljs-comment">   * using a &#123;<span class="hljs-doctag">@code</span> ResultHandler&#125;.</span><br><span class="hljs-comment">   *</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter A parameter object to pass to the statement.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> handler ResultHandler that will handle each retrieved row</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Mapped object</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">(String statement, Object parameter, ResultHandler handler)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieve a single row mapped from the statement</span><br><span class="hljs-comment">   * using a &#123;<span class="hljs-doctag">@code</span> ResultHandler&#125;.</span><br><span class="hljs-comment">   * è·å–ä¸€æ¡è®°å½•,å¹¶è½¬äº¤ç»™ResultHandlerå¤„ç†ã€‚è¿™ä¸ªæ–¹æ³•å…è®¸æˆ‘ä»¬è‡ªå·±å®šä¹‰å¯¹</span><br><span class="hljs-comment">   * æŸ¥è¯¢åˆ°çš„è¡Œçš„å¤„ç†æ–¹å¼ã€‚ä¸è¿‡ä¸€èˆ¬ç”¨çš„å¹¶ä¸æ˜¯å¾ˆå¤š</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> handler ResultHandler that will handle each retrieved row</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Mapped object</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">(String statement, ResultHandler handler)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieve a single row mapped from the statement key and parameter</span><br><span class="hljs-comment">   * using a &#123;<span class="hljs-doctag">@code</span> ResultHandler&#125; and &#123;<span class="hljs-doctag">@code</span> RowBounds&#125;</span><br><span class="hljs-comment">   * è·å–ä¸€æ¡è®°å½•,åŠ ä¸Šåˆ†é¡µ,å¹¶è½¬äº¤ç»™ResultHandlerå¤„ç†</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to use.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> rowBounds RowBound instance to limit the query results</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> handler ResultHandler that will handle each retrieved row</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Mapped object</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds, ResultHandler handler)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Execute an insert statement.</span><br><span class="hljs-comment">   * æ’å…¥è®°å½•ã€‚ä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªè¯­å¥åœ¨å®é™…é¡¹ç›®ä¸­ç”¨çš„å¹¶ä¸æ˜¯å¤ªå¤šï¼Œè€Œä¸”æ›´å¤šä½¿ç”¨å¸¦å‚æ•°çš„insertå‡½æ•°</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to execute.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> int The number of rows affected by the insert.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String statement)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Execute an insert statement with the given parameter object. Any generated</span><br><span class="hljs-comment">   * autoincrement values or selectKey entries will modify the given parameter</span><br><span class="hljs-comment">   * object properties. Only the number of rows affected will be returned.</span><br><span class="hljs-comment">   * æ’å…¥è®°å½•ï¼Œå®¹è®¸ä¼ å…¥å‚æ•°ã€‚</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to execute.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter A parameter object to pass to the statement.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> int The number of rows affected by the insert. æ³¨æ„è¿”å›çš„æ˜¯å—å½±å“çš„è¡Œæ•°</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String statement, Object parameter)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Execute an update statement. The number of rows affected will be returned.</span><br><span class="hljs-comment">   * æ›´æ–°è®°å½•ã€‚è¿”å›çš„æ˜¯å—å½±å“çš„è¡Œæ•°</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to execute.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> int The number of rows affected by the update.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String statement)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Execute an update statement. The number of rows affected will be returned.</span><br><span class="hljs-comment">   * æ›´æ–°è®°å½•</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to execute.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter A parameter object to pass to the statement.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> int The number of rows affected by the update. è¿”å›çš„æ˜¯å—å½±å“çš„è¡Œæ•°</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String statement, Object parameter)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Execute a delete statement. The number of rows affected will be returned.</span><br><span class="hljs-comment">   * åˆ é™¤è®°å½•</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to execute.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> int The number of rows affected by the delete. è¿”å›çš„æ˜¯å—å½±å“çš„è¡Œæ•°</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String statement)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Execute a delete statement. The number of rows affected will be returned.</span><br><span class="hljs-comment">   * åˆ é™¤è®°å½•</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> statement Unique identifier matching the statement to execute.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> parameter A parameter object to pass to the statement.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> int The number of rows affected by the delete. è¿”å›çš„æ˜¯å—å½±å“çš„è¡Œæ•°</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String statement, Object parameter)</span>;<br><br>  <span class="hljs-comment">// ä»¥ä¸‹æ˜¯äº‹åŠ¡æ§åˆ¶æ–¹æ³•,commit,rollback</span><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Flushes batch statements and commits database connection.</span><br><span class="hljs-comment">   * Note that database connection will not be committed if no updates/deletes/inserts were called.</span><br><span class="hljs-comment">   * To force the commit call &#123;<span class="hljs-doctag">@link</span> SqlSession#commit(boolean)&#125;</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Flushes batch statements and commits database connection.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> force forces connection commit</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> force)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Discards pending batch statements and rolls database connection back.</span><br><span class="hljs-comment">   * Note that database connection will not be rolled back if no updates/deletes/inserts were called.</span><br><span class="hljs-comment">   * To force the rollback call &#123;<span class="hljs-doctag">@link</span> SqlSession#rollback(boolean)&#125;</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Discards pending batch statements and rolls database connection back.</span><br><span class="hljs-comment">   * Note that database connection will not be rolled back if no updates/deletes/inserts were called.</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> force forces connection rollback</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(<span class="hljs-type">boolean</span> force)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Flushes batch statements.</span><br><span class="hljs-comment">   * åˆ·æ–°æ‰¹å¤„ç†è¯­å¥,è¿”å›æ‰¹å¤„ç†ç»“æœ</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> BatchResult list of updated records</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@since</span> 3.0.6</span><br><span class="hljs-comment">   */</span><br>  List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Closes the session</span><br><span class="hljs-comment">   * å…³é—­Session</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Clears local session cache</span><br><span class="hljs-comment">   * æ¸…ç†Sessionç¼“å­˜</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearCache</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieves current configuration</span><br><span class="hljs-comment">   * å¾—åˆ°é…ç½®</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Configuration</span><br><span class="hljs-comment">   */</span><br>  Configuration <span class="hljs-title function_">getConfiguration</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieves a mapper.</span><br><span class="hljs-comment">   * å¾—åˆ°æ˜ å°„å™¨</span><br><span class="hljs-comment">   * è¿™ä¸ªå·§å¦™çš„ä½¿ç”¨äº†æ³›å‹ï¼Œä½¿å¾—ç±»å‹å®‰å…¨</span><br><span class="hljs-comment">   * åˆ°äº†MyBatis 3ï¼Œè¿˜å¯ä»¥ç”¨æ³¨è§£,è¿™æ ·xmléƒ½ä¸ç”¨å†™äº†</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> &lt;T&gt; the mapper type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> type Mapper interface class</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> a mapper bound to this SqlSession</span><br><span class="hljs-comment">   */</span><br>  &lt;T&gt; T <span class="hljs-title function_">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Retrieves inner database connection</span><br><span class="hljs-comment">   * å¾—åˆ°æ•°æ®åº“è¿æ¥</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> Connection</span><br><span class="hljs-comment">   */</span><br>  Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DefaultSqlSession"><a href="#DefaultSqlSession" class="headerlink" title="DefaultSqlSession"></a>DefaultSqlSession</h4><p>â€‹ é»˜è®¤çš„SqlSessionå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSqlSession</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSession</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Configuration configuration;<br><br>  <span class="hljs-comment">// æ‰§è¡Œå™¨ï¼Œå‡ ä¹æ‰€æœ‰æ–¹æ³•éƒ½å§”æ‰˜å…¶æ‰§è¡Œ</span><br>  <span class="hljs-keyword">private</span> Executor executor;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * æ˜¯å¦è‡ªåŠ¨æäº¤</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> autoCommit;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> dirty;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultSqlSession</span><span class="hljs-params">(Configuration configuration, Executor executor, <span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>    <span class="hljs-built_in">this</span>.executor = executor;<br>    <span class="hljs-built_in">this</span>.dirty = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">this</span>.autoCommit = autoCommit;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultSqlSession</span><span class="hljs-params">(Configuration configuration, Executor executor)</span> &#123;<br>    <span class="hljs-built_in">this</span>(configuration, executor, <span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.&lt;T&gt;selectOne(statement, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// æ ¸å¿ƒselectOne</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-comment">// Popular vote was to return null on 0 results and throw exception on too many.</span><br>    <span class="hljs-comment">// è½¬è€Œå»è°ƒç”¨selectList,å¾ˆç®€å•çš„ï¼Œå¦‚æœå¾—åˆ°0æ¡åˆ™è¿”å›nullï¼Œå¾—åˆ°1æ¡åˆ™è¿”å›1æ¡ï¼Œå¾—åˆ°å¤šæ¡æŠ¥TooManyResultsExceptioné”™</span><br>    <span class="hljs-comment">// ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯å½“æ²¡æœ‰æŸ¥è¯¢åˆ°ç»“æœçš„æ—¶å€™å°±ä¼šè¿”å›nullã€‚å› æ­¤ä¸€èˆ¬å»ºè®®åœ¨mapperä¸­ç¼–å†™resultTypeçš„æ—¶å€™ä½¿ç”¨åŒ…è£…ç±»å‹</span><br>    <span class="hljs-comment">// è€Œä¸æ˜¯åŸºæœ¬ç±»å‹ï¼Œæ¯”å¦‚æ¨èä½¿ç”¨Integerè€Œä¸æ˜¯intã€‚è¿™æ ·å°±å¯ä»¥é¿å…NPE</span><br>    List&lt;T&gt; list = <span class="hljs-built_in">this</span>.&lt;T&gt;selectList(statement, parameter);<br>    <span class="hljs-keyword">if</span> (list.size() == <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">return</span> list.get(<span class="hljs-number">0</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (list.size() &gt; <span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TooManyResultsException</span>(<span class="hljs-string">&quot;Expected one result (or null) to be returned by selectOne(), but found: &quot;</span> + list.size());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-title function_">selectMap</span><span class="hljs-params">(String statement, String mapKey)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.selectMap(statement, <span class="hljs-literal">null</span>, mapKey, RowBounds.DEFAULT);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-title function_">selectMap</span><span class="hljs-params">(String statement, Object parameter, String mapKey)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.selectMap(statement, parameter, mapKey, RowBounds.DEFAULT);<br>  &#125;<br><br>  <span class="hljs-comment">// æ ¸å¿ƒselectMap</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-title function_">selectMap</span><span class="hljs-params">(String statement, Object parameter, String mapKey, RowBounds rowBounds)</span> &#123;<br>    <span class="hljs-comment">// è½¬è€Œå»è°ƒç”¨selectList</span><br>    <span class="hljs-keyword">final</span> List&lt;?&gt; list = selectList(statement, parameter, rowBounds);<br>    <span class="hljs-keyword">final</span> DefaultMapResultHandler&lt;K, V&gt; mapResultHandler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMapResultHandler</span>&lt;K, V&gt;(mapKey,<br>        configuration.getObjectFactory(), configuration.getObjectWrapperFactory());<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">DefaultResultContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultResultContext</span>();<br>    <span class="hljs-keyword">for</span> (Object o : list) &#123;<br>      <span class="hljs-comment">// å¾ªç¯ç”¨DefaultMapResultHandlerå¤„ç†æ¯æ¡è®°å½•</span><br>      context.nextResultObject(o);<br>      mapResultHandler.handleResult(context);<br>    &#125;<br>    <span class="hljs-comment">// æ³¨æ„è¿™ä¸ªDefaultMapResultHandleré‡Œé¢å­˜äº†æ‰€æœ‰å·²å¤„ç†çš„è®°å½•ï¼Œæœ€åå†è¿”å›ä¸€ä¸ªMap</span><br>    <span class="hljs-keyword">return</span> mapResultHandler.getMappedResults();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.selectList(statement, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.selectList(statement, parameter, RowBounds.DEFAULT);<br>  &#125;<br><br>  <span class="hljs-comment">// æ ¸å¿ƒselectList</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// æ ¹æ®statement æ‰¾åˆ°å¯¹åº”çš„MappedStatementï¼ˆè¿™é‡Œstatementå·²ç»å¤„ç†è¿‡äº†ï¼Œæ‰€ä»¥ç‚¹è¿›å»çœ‹åˆ°çš„æ˜¯ä»mapä¸­å–ï¼‰</span><br>      <span class="hljs-comment">// åœ¨ MapperAnnotationBuilder å’Œ XMLStatementBuilder ä¸­å‡è°ƒç”¨äº† MapperBuilderAssistant çš„ </span><br>      <span class="hljs-comment">// addMappedStatement æ–¹æ³•</span><br>      <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(statement);<br>      <span class="hljs-comment">// è½¬è€Œç”¨æ‰§è¡Œå™¨æ¥æŸ¥è¯¢ç»“æœ,æ³¨æ„è¿™é‡Œä¼ å…¥çš„ResultHandleræ˜¯null</span><br>      <span class="hljs-keyword">return</span> executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error querying database.  Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">(String statement, Object parameter, ResultHandler handler)</span> &#123;<br>    select(statement, parameter, RowBounds.DEFAULT, handler);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">(String statement, ResultHandler handler)</span> &#123;<br>    select(statement, <span class="hljs-literal">null</span>, RowBounds.DEFAULT, handler);<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¸å¿ƒselect,å¸¦æœ‰ResultHandlerï¼Œå’ŒselectListä»£ç å·®ä¸å¤šçš„ï¼ŒåŒºåˆ«å°±ä¸€ä¸ªResultHandler</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds, ResultHandler handler)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(statement);<br>      executor.query(ms, wrapCollection(parameter), rowBounds, handler);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error querying database.  Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String statement)</span> &#123;<br>    <span class="hljs-keyword">return</span> insert(statement, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-comment">// insertä¹Ÿæ˜¯è°ƒç”¨update</span><br>    <span class="hljs-keyword">return</span> update(statement, parameter);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String statement)</span> &#123;<br>    <span class="hljs-keyword">return</span> update(statement, <span class="hljs-literal">null</span>);<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¸å¿ƒupdate</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// æ¯æ¬¡è¦æ›´æ–°ä¹‹å‰ï¼Œdirtyæ ‡å¿—è®¾ä¸ºtrue</span><br>      dirty = <span class="hljs-literal">true</span>;<br>      <span class="hljs-type">MappedStatement</span> <span class="hljs-variable">ms</span> <span class="hljs-operator">=</span> configuration.getMappedStatement(statement);<br>      <span class="hljs-comment">// è½¬è€Œç”¨æ‰§è¡Œå™¨æ¥updateç»“æœ</span><br>      <span class="hljs-keyword">return</span> executor.update(ms, wrapCollection(parameter));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error updating database.  Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String statement)</span> &#123;<br>    <span class="hljs-comment">// deleteä¹Ÿæ˜¯è°ƒç”¨update</span><br>    <span class="hljs-keyword">return</span> update(statement, <span class="hljs-literal">null</span>);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">return</span> update(statement, parameter);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span> &#123;<br>    commit(<span class="hljs-literal">false</span>);<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¸å¿ƒcommit</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> force)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// è½¬è€Œç”¨æ‰§è¡Œå™¨æ¥commit</span><br>      executor.commit(isCommitOrRollbackRequired(force));<br>      <span class="hljs-comment">// æ¯æ¬¡commitä¹‹åï¼Œdirtyæ ‡å¿—è®¾ä¸ºfalse</span><br>      dirty = <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error committing transaction.  Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦å¼ºåˆ¶commitæˆ–rollback</span><br>  <span class="hljs-comment">// force æŒ‡çš„æ˜¯éœ€è¦å¼ºåˆ¶commitæˆ–rollback</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCommitOrRollbackRequired</span><span class="hljs-params">(<span class="hljs-type">boolean</span> force)</span> &#123;<br>    <span class="hljs-keyword">return</span> (!autoCommit &amp;&amp; dirty) || force;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span> &#123;<br>    rollback(<span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// æ ¸å¿ƒrollback</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(<span class="hljs-type">boolean</span> force)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// è½¬è€Œç”¨æ‰§è¡Œå™¨æ¥rollback</span><br>      executor.rollback(isCommitOrRollbackRequired(force));<br>      <span class="hljs-comment">// æ¯æ¬¡rollbackä¹‹åï¼Œdirtyæ ‡å¿—è®¾ä¸ºfalse</span><br>      dirty = <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error rolling back transaction.  Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¸å¿ƒflushStatements</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// è½¬è€Œç”¨æ‰§è¡Œå™¨æ¥flushStatements</span><br>      <span class="hljs-keyword">return</span> executor.flushStatements();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error flushing statements.  Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¸å¿ƒclose</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// è½¬è€Œç”¨æ‰§è¡Œå™¨æ¥close</span><br>      executor.close(isCommitOrRollbackRequired(<span class="hljs-literal">false</span>));<br>      <span class="hljs-comment">// æ¯æ¬¡closeä¹‹åï¼Œdirtyæ ‡å¿—è®¾ä¸ºfalse</span><br>      dirty = <span class="hljs-literal">false</span>;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Configuration <span class="hljs-title function_">getConfiguration</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> configuration;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>    <span class="hljs-comment">// æœ€åä¼šå»è°ƒç”¨MapperRegistry.getMapper</span><br>    <span class="hljs-keyword">return</span> configuration.&lt;T&gt;getMapper(type, <span class="hljs-built_in">this</span>);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> executor.getTransaction().getConnection();<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error getting a new connection.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¸å¿ƒclearCache</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearCache</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// è½¬è€Œç”¨æ‰§è¡Œå™¨æ¥clearLocalCache</span><br>    executor.clearLocalCache();<br>  &#125; <br><br>  <span class="hljs-comment">// æŠŠå‚æ•°åŒ…è£…æˆCollection</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">wrapCollection</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object object)</span> &#123;<br>    <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> Collection) &#123;<br>      <span class="hljs-comment">// å‚æ•°è‹¥æ˜¯Collectionå‹ï¼Œåšcollectionæ ‡è®°</span><br>      StrictMap&lt;Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;Object&gt;();<br>      map.put(<span class="hljs-string">&quot;collection&quot;</span>, object);<br>      <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> List) &#123;<br>        <span class="hljs-comment">// å‚æ•°è‹¥æ˜¯Listå‹ï¼Œåšlistæ ‡è®°</span><br>        map.put(<span class="hljs-string">&quot;list&quot;</span>, object);<br>      &#125;<br>      <span class="hljs-keyword">return</span> map;      <br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object != <span class="hljs-literal">null</span> &amp;&amp; object.getClass().isArray()) &#123;<br>      <span class="hljs-comment">// å‚æ•°è‹¥æ˜¯æ•°ç»„å‹ï¼Œï¼Œåšarrayæ ‡è®°</span><br>      StrictMap&lt;Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StrictMap</span>&lt;Object&gt;();<br>      map.put(<span class="hljs-string">&quot;array&quot;</span>, object);<br>      <span class="hljs-keyword">return</span> map;<br>    &#125;<br>    <span class="hljs-comment">// å‚æ•°è‹¥ä¸æ˜¯é›†åˆå‹ï¼Œç›´æ¥è¿”å›åŸæ¥å€¼</span><br>    <span class="hljs-keyword">return</span> object;<br>  &#125; <br><br>  <span class="hljs-comment">// ä¸¥æ ¼çš„Mapï¼Œå¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„keyï¼Œç›´æ¥æŠ›BindingExceptionä¾‹å¤–ï¼Œè€Œä¸æ˜¯è¿”å›null</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StrictMap</span>&lt;V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HashMap</span>&lt;String, V&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">5741767162221585340L</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">super</span>.containsKey(key)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BindingException</span>(<span class="hljs-string">&quot;Parameter &#x27;&quot;</span> + key + <span class="hljs-string">&quot;&#x27; not found. Available parameters are &quot;</span> + <span class="hljs-built_in">this</span>.keySet());<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.get(key);<br>    &#125;<br><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SqlSessionFactory"><a href="#SqlSessionFactory" class="headerlink" title="SqlSessionFactory"></a>SqlSessionFactory</h4><p>æ„å»ºSqlSessionçš„å·¥å‚.å·¥å‚æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SqlSessionFactory</span> &#123;<br><br>  <span class="hljs-comment">// 8ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥åˆ›å»ºSqlSessionå®ä¾‹</span><br>  SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">// è‡ªåŠ¨æäº¤</span><br>  SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(<span class="hljs-type">boolean</span> autoCommit)</span>;<br>  <span class="hljs-comment">// è¿æ¥</span><br>  SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(Connection connection)</span>;<br>  <span class="hljs-comment">// äº‹åŠ¡éš”ç¦»çº§åˆ«</span><br>  SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(TransactionIsolationLevel level)</span>;<br><br>  <span class="hljs-comment">// æ‰§è¡Œå™¨çš„ç±»å‹</span><br>  SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType)</span>;<br>  SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType, <span class="hljs-type">boolean</span> autoCommit)</span>;<br>  SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level)</span>;<br>  SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType, Connection connection)</span>;<br><br>  Configuration <span class="hljs-title function_">getConfiguration</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DefaultSqlSessionFactory"><a href="#DefaultSqlSessionFactory" class="headerlink" title="DefaultSqlSessionFactory"></a>DefaultSqlSessionFactory</h4><p>é»˜è®¤çš„SqlSessionFactory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSqlSessionFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSessionFactory</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Configuration configuration;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefaultSqlSessionFactory</span><span class="hljs-params">(Configuration configuration)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = configuration;<br>  &#125; <br><br>  <span class="hljs-comment">// æœ€ç»ˆéƒ½ä¼šè°ƒç”¨2ç§æ–¹æ³•ï¼šopenSessionFromDataSource,openSessionFromConnection</span><br>  <span class="hljs-comment">// è¿™ä¸¤ä¸ªæ–¹æ³•é€šè¿‡äº‹åŠ¡å·¥å‚äº§ç”Ÿäº‹åŠ¡çš„æ–¹å¼ä¸åŒ</span><br>  <span class="hljs-comment">// ä»¥ä¸‹6ä¸ªæ–¹æ³•éƒ½ä¼šè°ƒç”¨openSessionFromDataSource</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> openSessionFromDataSource(configuration.getDefaultExecutorType(), <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(<span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>    <span class="hljs-keyword">return</span> openSessionFromDataSource(configuration.getDefaultExecutorType(), <span class="hljs-literal">null</span>, autoCommit);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType)</span> &#123;<br>    <span class="hljs-keyword">return</span> openSessionFromDataSource(execType, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(TransactionIsolationLevel level)</span> &#123;<br>    <span class="hljs-keyword">return</span> openSessionFromDataSource(configuration.getDefaultExecutorType(), level, <span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level)</span> &#123;<br>    <span class="hljs-keyword">return</span> openSessionFromDataSource(execType, level, <span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType, <span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>    <span class="hljs-keyword">return</span> openSessionFromDataSource(execType, <span class="hljs-literal">null</span>, autoCommit);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> SqlSession <span class="hljs-title function_">openSessionFromDataSource</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level, <span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>    <span class="hljs-type">Transaction</span> <span class="hljs-variable">tx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> configuration.getEnvironment();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">transactionFactory</span> <span class="hljs-operator">=</span> getTransactionFactoryFromEnvironment(environment);<br>      <span class="hljs-comment">// é€šè¿‡äº‹åŠ¡å·¥å‚æ¥äº§ç”Ÿä¸€ä¸ªäº‹åŠ¡</span><br>      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);<br>      <span class="hljs-comment">// ç”Ÿæˆä¸€ä¸ªæ‰§è¡Œå™¨(äº‹åŠ¡åŒ…å«åœ¨æ‰§è¡Œå™¨é‡Œ)</span><br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> configuration.newExecutor(tx, execType);<br>      <span class="hljs-comment">// ç„¶åäº§ç”Ÿä¸€ä¸ªDefaultSqlSession</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-comment">// å¦‚æœæ‰“å¼€äº‹åŠ¡å‡ºé”™ï¼Œåˆ™å…³é—­å®ƒ</span><br>      closeTransaction(tx); <span class="hljs-comment">// may have fetched a connection so lets call close()</span><br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error opening session.  Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// æœ€åæ¸…ç©ºé”™è¯¯ä¸Šä¸‹æ–‡</span><br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> TransactionFactory <span class="hljs-title function_">getTransactionFactoryFromEnvironment</span><span class="hljs-params">(Environment environment)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰é…ç½®äº‹åŠ¡å·¥å‚ï¼Œåˆ™è¿”å›æ‰˜ç®¡äº‹åŠ¡å·¥å‚</span><br>    <span class="hljs-keyword">if</span> (environment == <span class="hljs-literal">null</span> || environment.getTransactionFactory() == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ManagedTransactionFactory</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> environment.getTransactionFactory();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeTransaction</span><span class="hljs-params">(Transaction tx)</span> &#123;<br>    <span class="hljs-keyword">if</span> (tx != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        tx.close();<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException ignore) &#123;<br>        <span class="hljs-comment">// Intentionally ignore. Prefer previous error.</span><br>      &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹2ä¸ªæ–¹æ³•éƒ½ä¼šè°ƒç”¨openSessionFromConnection</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(Connection connection)</span> &#123;<br>    <span class="hljs-keyword">return</span> openSessionFromConnection(configuration.getDefaultExecutorType(), connection);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType, Connection connection)</span> &#123;<br>    <span class="hljs-keyword">return</span> openSessionFromConnection(execType, connection);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> SqlSession <span class="hljs-title function_">openSessionFromConnection</span><span class="hljs-params">(ExecutorType execType, Connection connection)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">boolean</span> autoCommit;<br>      <span class="hljs-keyword">try</span> &#123;<br>        autoCommit = connection.getAutoCommit();<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-comment">// Failover to true, as most poor drivers</span><br>        <span class="hljs-comment">// or databases won&#x27;t support transactions</span><br>        autoCommit = <span class="hljs-literal">true</span>;<br>      &#125;      <br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> configuration.getEnvironment();<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">transactionFactory</span> <span class="hljs-operator">=</span> getTransactionFactoryFromEnvironment(environment);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Transaction</span> <span class="hljs-variable">tx</span> <span class="hljs-operator">=</span> transactionFactory.newTransaction(connection);<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> configuration.newExecutor(tx, execType);<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error opening session.  Cause: &quot;</span> + e, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SqlSessionFactoryBuilder"><a href="#SqlSessionFactoryBuilder" class="headerlink" title="SqlSessionFactoryBuilder"></a>SqlSessionFactoryBuilder</h4><p>æ„å»ºSqlSessionFactoryçš„å·¥å‚ï¼Œå·¥å‚æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span> &#123; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹3ä¸ªæ–¹æ³•éƒ½æ˜¯è°ƒç”¨ä¸‹é¢ç¬¬4ç§æ–¹æ³•</span><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Reader reader)</span> &#123;<br>    <span class="hljs-keyword">return</span> build(reader, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Reader reader, String environment)</span> &#123;<br>    <span class="hljs-keyword">return</span> build(reader, environment, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Reader reader, Properties properties)</span> &#123;<br>    <span class="hljs-keyword">return</span> build(reader, <span class="hljs-literal">null</span>, properties);<br>  &#125; <br><br>  <span class="hljs-comment">// ç¬¬4ç§æ–¹æ³•æ˜¯æœ€å¸¸ç”¨çš„ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªå‚ç…§äº†XMLæ–‡æ¡£æˆ–æ›´ç‰¹å®šçš„SqlMapConfig.xmlæ–‡ä»¶çš„Readerå®ä¾‹ã€‚</span><br>  <span class="hljs-comment">// å¯é€‰çš„å‚æ•°æ˜¯environmentå’Œpropertiesã€‚</span><br>  <span class="hljs-comment">// Environmentå†³å®šåŠ è½½å“ªç§ç¯å¢ƒ(å¼€å‘ç¯å¢ƒ/ç”Ÿäº§ç¯å¢ƒ)ï¼ŒåŒ…æ‹¬æ•°æ®æºå’Œäº‹åŠ¡ç®¡ç†å™¨ã€‚</span><br>  <span class="hljs-comment">// å¦‚æœä½¿ç”¨propertiesï¼Œé‚£ä¹ˆå°±ä¼šåŠ è½½é‚£äº›propertiesï¼ˆå±æ€§é…ç½®æ–‡ä»¶ï¼‰ï¼Œ</span><br>  <span class="hljs-comment">// å±æ€§å¯ä»¥ç”¨$&#123;propName&#125;è¯­æ³•å½¢å¼å¤šæ¬¡ç”¨åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚å’ŒSpringå¾ˆåƒ</span><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Reader reader, String environment, Properties properties)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å§”æ‰˜XMLConfigBuilderæ¥è§£æxmlæ–‡ä»¶ï¼Œå¹¶æ„å»º</span><br>      <span class="hljs-type">XMLConfigBuilder</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLConfigBuilder</span>(reader, environment, properties);<br>      <span class="hljs-keyword">return</span> build(parser.parse());<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-comment">//è¿™é‡Œæ˜¯æ•è·å¼‚å¸¸ï¼ŒåŒ…è£…æˆè‡ªå·±çš„å¼‚å¸¸å¹¶æŠ›å‡ºçš„idiomï¼Ÿï¼Œæœ€åè¿˜è¦reset ErrorContext</span><br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error building SqlSession.&quot;</span>, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>      <span class="hljs-keyword">try</span> &#123;<br>        reader.close();<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-comment">// Intentionally ignore. Prefer previous error.</span><br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹3ä¸ªæ–¹æ³•éƒ½æ˜¯è°ƒç”¨ä¸‹é¢ç¬¬8ç§æ–¹æ³•</span><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream)</span> &#123;<br>    <span class="hljs-keyword">return</span> build(inputStream, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream, String environment)</span> &#123;<br>    <span class="hljs-keyword">return</span> build(inputStream, environment, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream, Properties properties)</span> &#123;<br>    <span class="hljs-keyword">return</span> build(inputStream, <span class="hljs-literal">null</span>, properties);<br>  &#125; <br><br>  <span class="hljs-comment">// ç¬¬8ç§æ–¹æ³•å’Œç¬¬4ç§æ–¹æ³•å·®ä¸å¤šï¼ŒReaderæ¢æˆäº†InputStream</span><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(InputStream inputStream, String environment, Properties properties)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">XMLConfigBuilder</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLConfigBuilder</span>(inputStream, environment, properties);<br>      <span class="hljs-keyword">return</span> build(parser.parse());<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(<span class="hljs-string">&quot;Error building SqlSession.&quot;</span>, e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      ErrorContext.instance().reset();<br>      <span class="hljs-keyword">try</span> &#123;<br>        inputStream.close();<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-comment">// Intentionally ignore. Prefer previous error.</span><br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æœ€åä¸€ä¸ªbuildæ–¹æ³•ä½¿ç”¨äº†ä¸€ä¸ªConfigurationä½œä¸ºå‚æ•°,å¹¶è¿”å›DefaultSqlSessionFactory</span><br>  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Configuration config)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSessionFactory</span>(config);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SqlSessionManager"><a href="#SqlSessionManager" class="headerlink" title="SqlSessionManager"></a>SqlSessionManager</h4><p>è¿™ä¸ªç±»ä¼¼ä¹æ˜¯ç”¨æ¥åšæµ‹è¯•çš„ï¼Œå®ƒå°è£…äº†SqlSessionFactoryå’ŒSqlSessionçš„æ–¹æ³•ï¼Œå¹¶ä¸”å¯¹SqlSessionè¿›è¡Œäº†ä»£ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSessionManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSessionFactory</span>, SqlSession &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSessionFactory sqlSessionFactory;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSession sqlSessionProxy;<br><br>  <span class="hljs-keyword">private</span> ThreadLocal&lt;SqlSession&gt; localSqlSession = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;SqlSession&gt;();<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">SqlSessionManager</span><span class="hljs-params">(SqlSessionFactory sqlSessionFactory)</span> &#123;<br>    <span class="hljs-built_in">this</span>.sqlSessionFactory = sqlSessionFactory;<br>    <span class="hljs-built_in">this</span>.sqlSessionProxy = (SqlSession) Proxy.newProxyInstance(<br>        SqlSessionFactory.class.getClassLoader(),<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;SqlSession.class&#125;,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionInterceptor</span>());<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSessionManager <span class="hljs-title function_">newInstance</span><span class="hljs-params">(Reader reader)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionManager</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(reader, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSessionManager <span class="hljs-title function_">newInstance</span><span class="hljs-params">(Reader reader, String environment)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionManager</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(reader, environment, <span class="hljs-literal">null</span>));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSessionManager <span class="hljs-title function_">newInstance</span><span class="hljs-params">(Reader reader, Properties properties)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionManager</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(reader, <span class="hljs-literal">null</span>, properties));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSessionManager <span class="hljs-title function_">newInstance</span><span class="hljs-params">(InputStream inputStream)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionManager</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(inputStream, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSessionManager <span class="hljs-title function_">newInstance</span><span class="hljs-params">(InputStream inputStream, String environment)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionManager</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(inputStream, environment, <span class="hljs-literal">null</span>));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSessionManager <span class="hljs-title function_">newInstance</span><span class="hljs-params">(InputStream inputStream, Properties properties)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionManager</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span>().build(inputStream, <span class="hljs-literal">null</span>, properties));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSessionManager <span class="hljs-title function_">newInstance</span><span class="hljs-params">(SqlSessionFactory sqlSessionFactory)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionManager</span>(sqlSessionFactory);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startManagedSession</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.localSqlSession.set(openSession());<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startManagedSession</span><span class="hljs-params">(<span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>    <span class="hljs-built_in">this</span>.localSqlSession.set(openSession(autoCommit));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startManagedSession</span><span class="hljs-params">(Connection connection)</span> &#123;<br>    <span class="hljs-built_in">this</span>.localSqlSession.set(openSession(connection));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startManagedSession</span><span class="hljs-params">(TransactionIsolationLevel level)</span> &#123;<br>    <span class="hljs-built_in">this</span>.localSqlSession.set(openSession(level));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startManagedSession</span><span class="hljs-params">(ExecutorType execType)</span> &#123;<br>    <span class="hljs-built_in">this</span>.localSqlSession.set(openSession(execType));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startManagedSession</span><span class="hljs-params">(ExecutorType execType, <span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>    <span class="hljs-built_in">this</span>.localSqlSession.set(openSession(execType, autoCommit));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startManagedSession</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level)</span> &#123;<br>    <span class="hljs-built_in">this</span>.localSqlSession.set(openSession(execType, level));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startManagedSession</span><span class="hljs-params">(ExecutorType execType, Connection connection)</span> &#123;<br>    <span class="hljs-built_in">this</span>.localSqlSession.set(openSession(execType, connection));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isManagedSessionStarted</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.localSqlSession.get() != <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionFactory.openSession();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(<span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionFactory.openSession(autoCommit);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(Connection connection)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionFactory.openSession(connection);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(TransactionIsolationLevel level)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionFactory.openSession(level);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionFactory.openSession(execType);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType, <span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionFactory.openSession(execType, autoCommit);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType, TransactionIsolationLevel level)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionFactory.openSession(execType, level);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> SqlSession <span class="hljs-title function_">openSession</span><span class="hljs-params">(ExecutorType execType, Connection connection)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionFactory.openSession(execType, connection);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Configuration <span class="hljs-title function_">getConfiguration</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionFactory.getConfiguration();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.&lt;T&gt; selectOne(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.&lt;T&gt; selectOne(statement, parameter);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-title function_">selectMap</span><span class="hljs-params">(String statement, String mapKey)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.&lt;K, V&gt; selectMap(statement, mapKey);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-title function_">selectMap</span><span class="hljs-params">(String statement, Object parameter, String mapKey)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.&lt;K, V&gt; selectMap(statement, parameter, mapKey);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-title function_">selectMap</span><span class="hljs-params">(String statement, Object parameter, String mapKey, RowBounds rowBounds)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.&lt;K, V&gt; selectMap(statement, parameter, mapKey, rowBounds);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.&lt;E&gt; selectList(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.&lt;E&gt; selectList(statement, parameter);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">selectList</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.&lt;E&gt; selectList(statement, parameter, rowBounds);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">(String statement, ResultHandler handler)</span> &#123;<br>    sqlSessionProxy.select(statement, handler);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">(String statement, Object parameter, ResultHandler handler)</span> &#123;<br>    sqlSessionProxy.select(statement, parameter, handler);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">select</span><span class="hljs-params">(String statement, Object parameter, RowBounds rowBounds, ResultHandler handler)</span> &#123;<br>    sqlSessionProxy.select(statement, parameter, rowBounds, handler);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String statement)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.insert(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.insert(statement, parameter);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String statement)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.update(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">update</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.update(statement, parameter);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String statement)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.delete(statement);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(String statement, Object parameter)</span> &#123;<br>    <span class="hljs-keyword">return</span> sqlSessionProxy.delete(statement, parameter);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getMapper</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>    <span class="hljs-keyword">return</span> getConfiguration().getMapper(type, <span class="hljs-built_in">this</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> localSqlSession.get();<br>    <span class="hljs-keyword">if</span> (sqlSession == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionException</span>(<span class="hljs-string">&quot;Error:  Cannot get connection.  No managed session is started.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> sqlSession.getConnection();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearCache</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> localSqlSession.get();<br>    <span class="hljs-keyword">if</span> (sqlSession == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionException</span>(<span class="hljs-string">&quot;Error:  Cannot clear the cache.  No managed session is started.&quot;</span>);<br>    &#125;<br>    sqlSession.clearCache();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> localSqlSession.get();<br>    <span class="hljs-keyword">if</span> (sqlSession == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionException</span>(<span class="hljs-string">&quot;Error:  Cannot commit.  No managed session is started.&quot;</span>);<br>    &#125;<br>    sqlSession.commit();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> force)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> localSqlSession.get();<br>    <span class="hljs-keyword">if</span> (sqlSession == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionException</span>(<span class="hljs-string">&quot;Error:  Cannot commit.  No managed session is started.&quot;</span>);<br>    &#125;<br>    sqlSession.commit(force);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> localSqlSession.get();<br>    <span class="hljs-keyword">if</span> (sqlSession == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionException</span>(<span class="hljs-string">&quot;Error:  Cannot rollback.  No managed session is started.&quot;</span>);<br>    &#125;<br>    sqlSession.rollback();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">(<span class="hljs-type">boolean</span> force)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> localSqlSession.get();<br>    <span class="hljs-keyword">if</span> (sqlSession == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionException</span>(<span class="hljs-string">&quot;Error:  Cannot rollback.  No managed session is started.&quot;</span>);<br>    &#125;<br>    sqlSession.rollback(force);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;BatchResult&gt; <span class="hljs-title function_">flushStatements</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> localSqlSession.get();<br>    <span class="hljs-keyword">if</span> (sqlSession == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionException</span>(<span class="hljs-string">&quot;Error:  Cannot rollback.  No managed session is started.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> sqlSession.flushStatements();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> localSqlSession.get();<br>    <span class="hljs-keyword">if</span> (sqlSession == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionException</span>(<span class="hljs-string">&quot;Error:  Cannot close.  No managed session is started.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      sqlSession.close();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      localSqlSession.set(<span class="hljs-literal">null</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// ä»£ç†æ¨¡å¼</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSessionInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SqlSessionInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// Prevent Synthetic Access</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>      <span class="hljs-keyword">final</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> SqlSessionManager.<span class="hljs-built_in">this</span>.localSqlSession.get();<br>      <span class="hljs-keyword">if</span> (sqlSession != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// å¦‚æœå½“å‰çº¿ç¨‹å·²ç»æœ‰SqlSessionäº†ï¼Œåˆ™ç›´æ¥è°ƒç”¨</span><br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">return</span> method.invoke(sqlSession, args);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>          <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰SqlSessionï¼Œå…ˆæ‰“å¼€sessionï¼Œå†è°ƒç”¨,æœ€åæäº¤</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">autoSqlSession</span> <span class="hljs-operator">=</span> openSession();<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(autoSqlSession, args);<br>          autoSqlSession.commit();<br>          <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>          autoSqlSession.rollback();<br>          <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>          autoSqlSession.close();<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å†™åœ¨æœ€å"><a href="#å†™åœ¨æœ€å" class="headerlink" title="å†™åœ¨æœ€å"></a>å†™åœ¨æœ€å</h4><p><code>ResultContext</code>å’Œ<code>ResultHandler</code>åœ¨è¿™ä¸ªæ¨¡å—åªå®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œäºæ˜¯æˆ‘æ‰“ç®—åŒå®ƒä»¬çš„å®ç°ä¸€èµ·è®²ï¼›è€Œ<code>Configuration</code>åˆ™æ˜¯æŠŠmybatisèƒ½æ”¾çš„ä¸œè¥¿éƒ½æ”¾è¿›å»äº†ï¼Œç•™åœ¨åé¢è®²å§</p>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>9-transaction</title>
    <link href="/2023/07/12/mybatis-source-code/9-transaction/"/>
    <url>/2023/07/12/mybatis-source-code/9-transaction/</url>
    
    <content type="html"><![CDATA[<h4 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h4><p>â€‹ TransactionåŒ…è£…äº†ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼Œå¤„ç†è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬:åˆ›å»ºã€å‡†å¤‡ã€æäº¤&#x2F;å›æ»šå’Œå…³é—­ã€‚åœ¨Mybatisä¸­æœ‰ä¸¤ç§äº‹ç‰©ç±»å‹ï¼ˆä¹Ÿå°±æ˜¯ type&#x3D;â€[JDBC|MANAGED]â€ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Transaction</span> &#123; <br><br>  <span class="hljs-comment">// è·å–æ•°æ®åº“è¿æ¥</span><br>  Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// æäº¤å†…éƒ¨çš„æ•°æ®åº“è¿æ¥</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// å›æ»šå†…éƒ¨çš„æ•°æ®åº“è¿æ¥</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// å…³é—­å†…éƒ¨çš„æ•°æ®åº“è¿æ¥</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="TransactionFactory"><a href="#TransactionFactory" class="headerlink" title="TransactionFactory"></a>TransactionFactory</h4><p>â€‹ äº‹åŠ¡å·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TransactionFactory</span> &#123; <br><br>  <span class="hljs-comment">// è®¾ç½®äº‹åŠ¡å·¥å‚çš„è‡ªå®šä¹‰å±æ€§</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties props)</span>; <br><br>  <span class="hljs-comment">// æ ¹æ®Connectionåˆ›å»ºTransaction</span><br>  Transaction <span class="hljs-title function_">newTransaction</span><span class="hljs-params">(Connection conn)</span>;<br><br>  <span class="hljs-comment">// æ ¹æ®æ•°æ®æºå’Œäº‹åŠ¡éš”ç¦»çº§åˆ«åˆ›å»ºTransaction</span><br>  Transaction <span class="hljs-title function_">newTransaction</span><span class="hljs-params">(DataSource dataSource, TransactionIsolationLevel level, <span class="hljs-type">boolean</span> autoCommit)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="JdbcTransaction"><a href="#JdbcTransaction" class="headerlink" title="JdbcTransaction"></a>JdbcTransaction</h4><p>â€‹ JdbcTransactionç›´æ¥ä½¿ç”¨JDBCæäº¤å’Œå›æ»šåŠŸèƒ½ã€‚å®ƒä¾èµ–ä»æ•°æ®æºæ£€ç´¢çš„è¿æ¥æ¥ç®¡ç†äº‹åŠ¡çš„èŒƒå›´ã€‚</p><p>â€‹ å®ƒä¼šå»¶è¿Ÿè¿æ¥è·å–çŸ¥é“<code>getConnection()</code>æ–¹æ³•è¢«è°ƒç”¨ã€‚å½“autocommitæ‰“å¼€çš„æ—¶å€™å¿½ç•¥commitæˆ–rollbackè¯·æ±‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcTransaction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transaction</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(JdbcTransaction.class);<br><br>  <span class="hljs-keyword">protected</span> Connection connection;<br>  <span class="hljs-keyword">protected</span> DataSource dataSource;<br>  <span class="hljs-keyword">protected</span> TransactionIsolationLevel level;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> autoCommmit;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JdbcTransaction</span><span class="hljs-params">(DataSource ds, TransactionIsolationLevel desiredLevel, <span class="hljs-type">boolean</span> desiredAutoCommit)</span> &#123;<br>    dataSource = ds;<br>    level = desiredLevel;<br>    autoCommmit = desiredAutoCommit;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JdbcTransaction</span><span class="hljs-params">(Connection connection)</span> &#123;<br>    <span class="hljs-built_in">this</span>.connection = connection;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// å»¶è¿Ÿè·å–æ•°æ®åº“è¿æ¥</span><br>  <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (connection == <span class="hljs-literal">null</span>) &#123;<br>      openConnection();<br>    &#125;<br>    <span class="hljs-keyword">return</span> connection;<br>  &#125;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">openConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>      log.debug(<span class="hljs-string">&quot;Opening JDBC Connection&quot;</span>);<br>    &#125;<br>    connection = dataSource.getConnection();<br>    <span class="hljs-keyword">if</span> (level != <span class="hljs-literal">null</span>) &#123;<br>      connection.setTransactionIsolation(level.getLevel());<br>    &#125;<br>    <span class="hljs-comment">// è®¾ç½® AutoCommit</span><br>    setDesiredAutoCommit(autoCommmit);<br>  &#125;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDesiredAutoCommit</span><span class="hljs-params">(<span class="hljs-type">boolean</span> desiredAutoCommit)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å’ŒåŸæ¥çš„æ¯”ä¸€ä¸‹ï¼Œå†è®¾ç½®autocommitï¼Œåº”è¯¥æ˜¯è€ƒè™‘å¤šåˆ°äº† connection.setAutoCommit() å¸¦æ¥çš„é¢å¤–æ€§èƒ½å¼€é”€</span><br>      <span class="hljs-keyword">if</span> (connection.getAutoCommit() != desiredAutoCommit) &#123;<br>        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>          log.debug(<span class="hljs-string">&quot;Setting autocommit to &quot;</span> + desiredAutoCommit + <span class="hljs-string">&quot; on JDBC Connection [&quot;</span> + connection + <span class="hljs-string">&quot;]&quot;</span>);<br>        &#125;<br>        connection.setAutoCommit(desiredAutoCommit);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-comment">// Only a very poorly implemented driver would fail here,</span><br>      <span class="hljs-comment">// and there&#x27;s not much we can do about that.</span><br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionException</span>(<span class="hljs-string">&quot;Error configuring AutoCommit.  &quot;</span><br>          + <span class="hljs-string">&quot;Your driver may not support getAutoCommit() or setAutoCommit(). &quot;</span><br>          + <span class="hljs-string">&quot;Requested setting: &quot;</span> + desiredAutoCommit + <span class="hljs-string">&quot;.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// commit å’Œ rollback å‡åœ¨ autoCommmit = falseæ‰çœŸæ­£æ‰§è¡Œ</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (connection != <span class="hljs-literal">null</span> &amp;&amp; !connection.getAutoCommit()) &#123;<br>      <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>        log.debug(<span class="hljs-string">&quot;Committing JDBC Connection [&quot;</span> + connection + <span class="hljs-string">&quot;]&quot;</span>);<br>      &#125;<br>      connection.commit();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (connection != <span class="hljs-literal">null</span> &amp;&amp; !connection.getAutoCommit()) &#123;<br>      <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>        log.debug(<span class="hljs-string">&quot;Rolling back JDBC Connection [&quot;</span> + connection + <span class="hljs-string">&quot;]&quot;</span>);<br>      &#125;<br>      connection.rollback();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// å…³é—­æ•°æ®åº“è¿æ¥</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (connection != <span class="hljs-literal">null</span>) &#123;<br>      resetAutoCommit();<br>      <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>        log.debug(<span class="hljs-string">&quot;Closing JDBC Connection [&quot;</span> + connection + <span class="hljs-string">&quot;]&quot;</span>);<br>      &#125;<br>      connection.close();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resetAutoCommit</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (!connection.getAutoCommit()) &#123;<br>        <span class="hljs-comment">// MyBatis does not call commit/rollback on a connection if just selects were performed.</span><br>        <span class="hljs-comment">// Some databases start transactions with select statements</span><br>        <span class="hljs-comment">// and they mandate a commit/rollback before closing the connection.</span><br>        <span class="hljs-comment">// A workaround is setting the autocommit to true before closing the connection.</span><br>        <span class="hljs-comment">// Sybase throws an exception here.</span><br>        <span class="hljs-comment">// å¦‚æœåªæ‰§è¡ŒæŸ¥è¯¢ï¼ŒMyBatisä¸ä¼šåœ¨è¿æ¥ä¸Šè°ƒç”¨æäº¤/å›æ»šã€‚</span><br>        <span class="hljs-comment">// ç„¶è€Œä¸€äº›æ•°æ®åº“ä½¿ç”¨selectè¯­å¥å¯åŠ¨äº‹åŠ¡ï¼Œå¹¶åœ¨å…³é—­è¿æ¥ä¹‹å‰å¼ºåˆ¶æ‰§è¡Œæäº¤/å›æ»šã€‚</span><br>        <span class="hljs-comment">// ä¸€ç§è§£å†³æ–¹æ³•æ˜¯åœ¨å…³é—­è¿æ¥ä¹‹å‰å°†è‡ªåŠ¨æäº¤è®¾ç½®ä¸ºtrueã€‚</span><br>        <span class="hljs-comment">// Sybaseåœ¨è¿™é‡ŒæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚</span><br>        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>          log.debug(<span class="hljs-string">&quot;Resetting autocommit to true on JDBC Connection [&quot;</span> + connection + <span class="hljs-string">&quot;]&quot;</span>);<br>        &#125;<br>        connection.setAutoCommit(<span class="hljs-literal">true</span>);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      log.debug(<span class="hljs-string">&quot;Error resetting autocommit to true &quot;</span><br>          + <span class="hljs-string">&quot;before closing the connection.  Cause: &quot;</span> + e);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="JdbcTransactionFactory"><a href="#JdbcTransactionFactory" class="headerlink" title="JdbcTransactionFactory"></a>JdbcTransactionFactory</h4><p>â€‹ JdbcTransactionå·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcTransactionFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TransactionFactory</span> &#123; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties props)</span> &#123;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Transaction <span class="hljs-title function_">newTransaction</span><span class="hljs-params">(Connection conn)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTransaction</span>(conn);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Transaction <span class="hljs-title function_">newTransaction</span><span class="hljs-params">(DataSource ds, TransactionIsolationLevel level, <span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTransaction</span>(ds, level, autoCommit);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ManagedTransaction"><a href="#ManagedTransaction" class="headerlink" title="ManagedTransaction"></a>ManagedTransaction</h4><p>â€‹ ManagedTransactionè®©å®¹å™¨ç®¡ç†äº‹åŠ¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸã€‚å’ŒJdbcTransactionä¸€æ ·ï¼Œå»¶è¿Ÿè·å–æ•°æ®åº“è¿æ¥ç›´åˆ°getConnection()æ–¹æ³•è¢«è°ƒç”¨</p><p>â€‹ é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼šå…³é—­è¿æ¥ï¼Œä½†å¯ä»¥å°† closeConnection å±æ€§è®¾ç½®ä¸º falseä¸å…³é—­è¿æ¥ã€‚</p><p>â€‹ å¦‚æœä½¿ç”¨mybatis-springçš„è¯ï¼Œä¸éœ€è¦é…ç½®transactionManager ,å› ä¸ºmybatis-springè¦†ç›–äº†mybatisé‡Œçš„é€»è¾‘ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ManagedTransaction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Transaction</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(ManagedTransaction.class);<br><br>  <span class="hljs-keyword">private</span> DataSource dataSource;<br>  <span class="hljs-keyword">private</span> TransactionIsolationLevel level;<br>  <span class="hljs-keyword">private</span> Connection connection;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> closeConnection;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ManagedTransaction</span><span class="hljs-params">(Connection connection, <span class="hljs-type">boolean</span> closeConnection)</span> &#123;<br>    <span class="hljs-built_in">this</span>.connection = connection;<br>    <span class="hljs-built_in">this</span>.closeConnection = closeConnection;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ManagedTransaction</span><span class="hljs-params">(DataSource ds, TransactionIsolationLevel level, <span class="hljs-type">boolean</span> closeConnection)</span> &#123;<br>    <span class="hljs-built_in">this</span>.dataSource = ds;<br>    <span class="hljs-built_in">this</span>.level = level;<br>    <span class="hljs-built_in">this</span>.closeConnection = closeConnection;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.connection == <span class="hljs-literal">null</span>) &#123;<br>      openConnection();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.connection;<br>  &#125;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">openConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>      log.debug(<span class="hljs-string">&quot;Opening JDBC Connection&quot;</span>);<br>    &#125;<br>    <span class="hljs-built_in">this</span>.connection = <span class="hljs-built_in">this</span>.dataSource.getConnection();<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.level != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-built_in">this</span>.connection.setTransactionIsolation(<span class="hljs-built_in">this</span>.level.getLevel());<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ‰˜ç®¡äº‹åŠ¡commitå’Œrollbackéƒ½æ˜¯ä¸åšäº‹çš„ï¼Œäº¤ç»™å®¹å™¨ç®¡ç†</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// Does nothing</span><br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// Does nothing</span><br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// å¦‚æœpropertiesæ–‡ä»¶é…ç½®äº†closeConnection=false,åˆ™ä¸å…³é—­è¿æ¥</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.closeConnection &amp;&amp; <span class="hljs-built_in">this</span>.connection != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>        log.debug(<span class="hljs-string">&quot;Closing JDBC Connection [&quot;</span> + <span class="hljs-built_in">this</span>.connection + <span class="hljs-string">&quot;]&quot;</span>);<br>      &#125;<br>      <span class="hljs-built_in">this</span>.connection.close();<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ManagedTransactionFactory"><a href="#ManagedTransactionFactory" class="headerlink" title="ManagedTransactionFactory"></a>ManagedTransactionFactory</h4><p>â€‹ æ‰˜ç®¡äº‹åŠ¡å·¥å‚,é»˜è®¤æƒ…å†µä¸‹å®ƒä¼šå…³é—­è¿æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ManagedTransactionFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TransactionFactory</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">closeConnection</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties props)</span> &#123;<br>    <span class="hljs-comment">// è®¾ç½®closeConnectionå±æ€§</span><br>    <span class="hljs-keyword">if</span> (props != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">closeConnectionProperty</span> <span class="hljs-operator">=</span> props.getProperty(<span class="hljs-string">&quot;closeConnection&quot;</span>);<br>      <span class="hljs-keyword">if</span> (closeConnectionProperty != <span class="hljs-literal">null</span>) &#123;<br>        closeConnection = Boolean.valueOf(closeConnectionProperty);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Transaction <span class="hljs-title function_">newTransaction</span><span class="hljs-params">(Connection conn)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ManagedTransaction</span>(conn, closeConnection);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Transaction <span class="hljs-title function_">newTransaction</span><span class="hljs-params">(DataSource ds, TransactionIsolationLevel level, <span class="hljs-type">boolean</span> autoCommit)</span> &#123;<br>    <span class="hljs-comment">// Silently ignores autocommit and isolation level, as managed transactions are entirely</span><br>    <span class="hljs-comment">// controlled by an external manager.  It&#x27;s silently ignored so that</span><br>    <span class="hljs-comment">// code remains portable between managed and unmanaged configurations.</span><br>    <span class="hljs-comment">// é™é»˜å¿½ç•¥è‡ªåŠ¨æäº¤å’Œéš”ç¦»çº§åˆ«ï¼Œå› ä¸ºæ‰˜ç®¡äº‹åŠ¡å®Œå…¨ç”±å¤–éƒ¨ç®¡ç†å™¨æ§åˆ¶ã€‚</span><br>    <span class="hljs-comment">// å®ƒä¼šè¢«å¿½ç•¥ï¼Œè¿™æ ·ä»£ç å°±å¯ä»¥åœ¨æ‰˜ç®¡å’Œéæ‰˜ç®¡é…ç½®ä¹‹é—´ç§»æ¤ã€‚</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ManagedTransaction</span>(ds, level, closeConnection);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>8-datasource</title>
    <link href="/2023/07/11/mybatis-source-code/8-datasource/"/>
    <url>/2023/07/11/mybatis-source-code/8-datasource/</url>
    
    <content type="html"><![CDATA[<h4 id="DataSourceFactory"><a href="#DataSourceFactory" class="headerlink" title="DataSourceFactory"></a>DataSourceFactory</h4><p>â€‹ æ•°æ®æºå·¥å‚ï¼Œæœ‰ä¸‰ç§å†…ç½®çš„æ•°æ®æºç±»å‹ UNPOOLED POOLED JNDI</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DataSourceFactory</span> &#123;<br><br>  <span class="hljs-comment">// è®¾ç½®æ•°æ®æºå±æ€§,è¢«XMLConfigBuilderæ‰€è°ƒç”¨</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties props)</span>;<br><br>  <span class="hljs-comment">// ç”Ÿäº§æ•°æ®æº,ç›´æ¥å¾—åˆ°javax.sql.DataSource</span><br>  DataSource <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="JndiDataSourceFactory"><a href="#JndiDataSourceFactory" class="headerlink" title="JndiDataSourceFactory"></a>JndiDataSourceFactory</h4><p>â€‹ JNDIæ•°æ®æºå·¥å‚ã€‚è¿™ä¸ªæ•°æ®æºçš„å®ç°æ˜¯ä¸ºäº†é…åˆå¦‚Springæˆ–åº”ç”¨æœåŠ¡å™¨è¿™ç±»çš„å®¹å™¨ä½¿ç”¨, å®¹å™¨å¯ä»¥é›†ä¸­æˆ–åœ¨å¤–éƒ¨é…ç½®æ•°æ®æº,ç„¶åæ”¾ç½®ä¸€ä¸ªJNDIä¸Šä¸‹æ–‡çš„å¼•ç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JndiDataSourceFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DataSourceFactory</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">INITIAL_CONTEXT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;initial_context&quot;</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DATA_SOURCE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;data_source&quot;</span>;<br><br>  <span class="hljs-comment">// å’Œå…¶ä»–æ•°æ®æºé…ç½®ç›¸ä¼¼, å®ƒä¹Ÿå¯ä»¥é€šè¿‡åä¸º â€œenv.â€ çš„å‰ç¼€ç›´æ¥å‘åˆå§‹ä¸Šä¸‹æ–‡å‘é€å±æ€§ã€‚ æ¯”å¦‚:</span><br>  <span class="hljs-comment">// env.encoding=UTF8</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ENV_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;env.&quot;</span>;<br><br>  <span class="hljs-keyword">private</span> DataSource dataSource;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Properties <span class="hljs-title function_">getEnvProperties</span><span class="hljs-params">(Properties allProps)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX</span> <span class="hljs-operator">=</span> ENV_PREFIX;<br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">contextProperties</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-comment">// ä» allProps ä¸­æŠ½å‡ºå‰ç¼€ä¸º env. çš„å±æ€§ç»„æˆä¸€ä¸ªæ–°çš„ Properties</span><br>    <span class="hljs-keyword">for</span> (Entry&lt;Object, Object&gt; entry : allProps.entrySet()) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (String) entry.getKey();<br>      <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) entry.getValue();<br>      <span class="hljs-keyword">if</span> (key.startsWith(PREFIX)) &#123;<br>        <span class="hljs-keyword">if</span> (contextProperties == <span class="hljs-literal">null</span>) &#123;<br>          contextProperties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        &#125;<br>        contextProperties.put(key.substring(PREFIX.length()), value);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> contextProperties;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">InitialContext</span> <span class="hljs-variable">initCtx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-type">Properties</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> getEnvProperties(properties);<br>      <span class="hljs-keyword">if</span> (env == <span class="hljs-literal">null</span>) &#123;<br>        initCtx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        initCtx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>(env);<br>      &#125;<br><br>      <span class="hljs-keyword">if</span> (properties.containsKey(INITIAL_CONTEXT)<br>          &amp;&amp; properties.containsKey(DATA_SOURCE)) &#123;<br>        <span class="hljs-type">Context</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> (Context) initCtx.lookup(properties.getProperty(INITIAL_CONTEXT));<br>        dataSource = (DataSource) ctx.lookup(properties.getProperty(DATA_SOURCE));<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (properties.containsKey(DATA_SOURCE)) &#123;<br>        dataSource = (DataSource) initCtx.lookup(properties.getProperty(DATA_SOURCE));<br>      &#125;<br><br>    &#125; <span class="hljs-keyword">catch</span> (NamingException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceException</span>(<span class="hljs-string">&quot;There was an error configuring JndiDataSourceTransactionPool. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> dataSource;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="UnpooledDataSourceFactory"><a href="#UnpooledDataSourceFactory" class="headerlink" title="UnpooledDataSourceFactory"></a>UnpooledDataSourceFactory</h4><p>â€‹ éæ± åŒ–çš„æ•°æ®æºå·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnpooledDataSourceFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DataSourceFactory</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DRIVER_PROPERTY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;driver.&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DRIVER_PROPERTY_PREFIX_LENGTH</span> <span class="hljs-operator">=</span> DRIVER_PROPERTY_PREFIX.length();<br><br>  <span class="hljs-keyword">protected</span> DataSource dataSource;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnpooledDataSourceFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.dataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnpooledDataSource</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span> &#123;<br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">driverProperties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>    <span class="hljs-comment">// ç”¨åˆ°äº†ä¹‹å‰çš„MetaObject</span><br>    <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaDataSource</span> <span class="hljs-operator">=</span> SystemMetaObject.forObject(dataSource);<br>    <span class="hljs-keyword">for</span> (Object key : properties.keySet()) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> (String) key;<br>      <span class="hljs-comment">// ä½œä¸ºå¯é€‰é¡¹,ä½ å¯ä»¥ä¼ é€’æ•°æ®åº“é©±åŠ¨çš„å±æ€§ã€‚è¦è¿™æ ·åš,å±æ€§çš„å‰ç¼€æ˜¯ä»¥â€œdriver.â€å¼€ å¤´çš„,ä¾‹å¦‚</span><br>      <span class="hljs-comment">// driver.encoding=UTF8</span><br>      <span class="hljs-keyword">if</span> (propertyName.startsWith(DRIVER_PROPERTY_PREFIX)) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> properties.getProperty(propertyName);<br>        driverProperties.setProperty(propertyName.substring(DRIVER_PROPERTY_PREFIX_LENGTH), value);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (metaDataSource.hasSetter(propertyName)) &#123;<br>        <span class="hljs-comment">// å¦‚æœUnpooledDataSourceæœ‰ç›¸åº”çš„setterå‡½æ•°ï¼Œåˆ™è®¾ç½®å®ƒ</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) properties.get(propertyName);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">convertedValue</span> <span class="hljs-operator">=</span> convertValue(metaDataSource, propertyName, value);<br>        metaDataSource.setValue(propertyName, convertedValue);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceException</span>(<span class="hljs-string">&quot;Unknown DataSource property: &quot;</span> + propertyName);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (driverProperties.size() &gt; <span class="hljs-number">0</span>) &#123;<br>      metaDataSource.setValue(<span class="hljs-string">&quot;driverProperties&quot;</span>, driverProperties);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ ¹æ®setterçš„ç±»å‹,å°†é…ç½®æ–‡ä»¶ä¸­çš„å€¼å¼ºè½¬æˆç›¸åº”çš„ç±»å‹</span><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">convertValue</span><span class="hljs-params">(MetaObject metaDataSource, String propertyName, String value)</span> &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">convertedValue</span> <span class="hljs-operator">=</span> value;<br>    Class&lt;?&gt; targetType = metaDataSource.getSetterType(propertyName);<br>    <span class="hljs-comment">// è¿™é‡Œåº”è¯¥æ˜¯åªè€ƒè™‘è½¬æ¢è¿™å‡ ç§ç±»å‹</span><br>    <span class="hljs-keyword">if</span> (targetType == Integer.class || targetType == <span class="hljs-type">int</span>.class) &#123;<br>      convertedValue = Integer.valueOf(value);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (targetType == Long.class || targetType == <span class="hljs-type">long</span>.class) &#123;<br>      convertedValue = Long.valueOf(value);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (targetType == Boolean.class || targetType == <span class="hljs-type">boolean</span>.class) &#123;<br>      convertedValue = Boolean.valueOf(value);<br>    &#125;<br>    <span class="hljs-keyword">return</span> convertedValue;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">getDataSource</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> dataSource;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="UnpooledDataSource"><a href="#UnpooledDataSource" class="headerlink" title="UnpooledDataSource"></a>UnpooledDataSource</h4><p>â€‹ éæ± åŒ–çš„æ•°æ®æº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnpooledDataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DataSource</span> &#123; <br><br>  <span class="hljs-keyword">private</span> ClassLoader driverClassLoader;<br><br>  <span class="hljs-comment">// ä½œä¸ºå¯é€‰é¡¹,ä½ å¯ä»¥ä¼ é€’æ•°æ®åº“é©±åŠ¨çš„å±æ€§ã€‚è¦è¿™æ ·åš,å±æ€§çš„å‰ç¼€æ˜¯ä»¥â€œdriver.â€å¼€ å¤´çš„,ä¾‹å¦‚</span><br>  <span class="hljs-comment">// driver.encoding=UTF8</span><br>  <span class="hljs-keyword">private</span> Properties driverProperties;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, Driver&gt; registeredDrivers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;String, Driver&gt;();<br><br>  <span class="hljs-keyword">private</span> String driver;<br>  <span class="hljs-keyword">private</span> String url;<br>  <span class="hljs-keyword">private</span> String username;<br>  <span class="hljs-keyword">private</span> String password;<br><br>  <span class="hljs-keyword">private</span> Boolean autoCommit;<br>  <span class="hljs-comment">// é»˜è®¤çš„äº‹ç‰©éš”ç¦»çº§åˆ«</span><br>  <span class="hljs-keyword">private</span> Integer defaultTransactionIsolationLevel;<br><br>  <span class="hljs-keyword">static</span> &#123;<br>    <span class="hljs-comment">// è¯»å–å½“å‰è°ƒç”¨è€…å¯ä»¥è®¿é—®çš„æ‰€æœ‰å½“å‰å·²ç»åŠ è½½çš„JDBCé©±åŠ¨ç¨‹åºçš„æšä¸¾ï¼Œæ”¾å…¥ registeredDrivers ä¸­</span><br>    Enumeration&lt;Driver&gt; drivers = DriverManager.getDrivers();<br>    <span class="hljs-keyword">while</span> (drivers.hasMoreElements()) &#123;<br>      <span class="hljs-type">Driver</span> <span class="hljs-variable">driver</span> <span class="hljs-operator">=</span> drivers.nextElement();<br>      registeredDrivers.put(driver.getClass().getName(), driver);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnpooledDataSource</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnpooledDataSource</span><span class="hljs-params">(String driver, String url, String username, String password)</span> &#123;<br>    <span class="hljs-built_in">this</span>.driver = driver;<br>    <span class="hljs-built_in">this</span>.url = url;<br>    <span class="hljs-built_in">this</span>.username = username;<br>    <span class="hljs-built_in">this</span>.password = password;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnpooledDataSource</span><span class="hljs-params">(String driver, String url, Properties driverProperties)</span> &#123;<br>    <span class="hljs-built_in">this</span>.driver = driver;<br>    <span class="hljs-built_in">this</span>.url = url;<br>    <span class="hljs-built_in">this</span>.driverProperties = driverProperties;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnpooledDataSource</span><span class="hljs-params">(ClassLoader driverClassLoader, String driver, String url, String username, String password)</span> &#123;<br>    <span class="hljs-built_in">this</span>.driverClassLoader = driverClassLoader;<br>    <span class="hljs-built_in">this</span>.driver = driver;<br>    <span class="hljs-built_in">this</span>.url = url;<br>    <span class="hljs-built_in">this</span>.username = username;<br>    <span class="hljs-built_in">this</span>.password = password;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnpooledDataSource</span><span class="hljs-params">(ClassLoader driverClassLoader, String driver, String url, Properties driverProperties)</span> &#123;<br>    <span class="hljs-built_in">this</span>.driverClassLoader = driverClassLoader;<br>    <span class="hljs-built_in">this</span>.driver = driver;<br>    <span class="hljs-built_in">this</span>.url = url;<br>    <span class="hljs-built_in">this</span>.driverProperties = driverProperties;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> doGetConnection(username, password);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String username, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> doGetConnection(username, password);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> Connection <span class="hljs-title function_">doGetConnection</span><span class="hljs-params">(String username, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>    <span class="hljs-keyword">if</span> (driverProperties != <span class="hljs-literal">null</span>) &#123;<br>      props.putAll(driverProperties);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (username != <span class="hljs-literal">null</span>) &#123;<br>      props.setProperty(<span class="hljs-string">&quot;user&quot;</span>, username);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (password != <span class="hljs-literal">null</span>) &#123;<br>      props.setProperty(<span class="hljs-string">&quot;password&quot;</span>, password);<br>    &#125;<br>    <span class="hljs-keyword">return</span> doGetConnection(props);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> Connection <span class="hljs-title function_">doGetConnection</span><span class="hljs-params">(Properties properties)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    initializeDriver();<br>    <span class="hljs-comment">// å±æ€§çš„å‰ç¼€æ˜¯ä»¥â€œdriver.â€å¼€å¤´çš„,å®ƒæ˜¯é€šè¿‡DriverManager.getConnection(url,driverProperties)æ–¹æ³•ä¼ é€’ç»™æ•°æ®åº“é©±åŠ¨</span><br>    <span class="hljs-comment">// åœ¨ DriverManager.getConnection æ–¹æ³•é‡Œéå† registeredDrivers ï¼Œå°è¯•ç”¨æ¯ä¸ªé©±åŠ¨è·å–è¿æ¥ï¼Œç›´åˆ°è·å–åˆ°æ•°æ®åº“è¿æ¥</span><br>    <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, properties);<br>    configureConnection(connection);<br>    <span class="hljs-keyword">return</span> connection;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeDriver</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// è¿™é‡Œä¾¿æ˜¯å¤§å®¶ç†Ÿæ‚‰çš„åˆå­¦JDBCæ—¶çš„é‚£å‡ å¥è¯äº† Class.forName newInstance()</span><br>    <span class="hljs-keyword">if</span> (!registeredDrivers.containsKey(driver)) &#123;<br>      Class&lt;?&gt; driverType;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (driverClassLoader != <span class="hljs-literal">null</span>) &#123;<br>          driverType = Class.forName(driver, <span class="hljs-literal">true</span>, driverClassLoader);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          driverType = Resources.classForName(driver);<br>        &#125;<br>        <span class="hljs-comment">// DriverManager requires the driver to be loaded via the system ClassLoader.</span><br>        <span class="hljs-comment">// http://www.kfu.com/~nsayer/Java/dyn-jdbc.html</span><br>        <span class="hljs-type">Driver</span> <span class="hljs-variable">driverInstance</span> <span class="hljs-operator">=</span> (Driver)driverType.newInstance();<br>        DriverManager.registerDriver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DriverProxy</span>(driverInstance));<br>        registeredDrivers.put(driver, driverInstance);<br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">&quot;Error setting driver on UnpooledDataSource. Cause: &quot;</span> + e);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// é…ç½® AutoCommit å’Œ TransactionIsolation</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureConnection</span><span class="hljs-params">(Connection conn)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (autoCommit != <span class="hljs-literal">null</span> &amp;&amp; autoCommit != conn.getAutoCommit()) &#123;<br>      conn.setAutoCommit(autoCommit);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (defaultTransactionIsolationLevel != <span class="hljs-literal">null</span>) &#123;<br>      conn.setTransactionIsolation(defaultTransactionIsolationLevel);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * é©±åŠ¨ä»£ç†</span><br><span class="hljs-comment">   * åªæš´éœ²äº†Driveræ¥å£ä¸­å®šä¹‰çš„æ–¹æ³•</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DriverProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Driver</span> &#123;<br>    <span class="hljs-keyword">private</span> Driver driver;<br><br>    DriverProxy(Driver d) &#123;<br>      <span class="hljs-built_in">this</span>.driver = d;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acceptsURL</span><span class="hljs-params">(String u)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.driver.acceptsURL(u);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">connect</span><span class="hljs-params">(String u, Properties p)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.driver.connect(u, p);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMajorVersion</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.driver.getMajorVersion();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMinorVersion</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.driver.getMinorVersion();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> DriverPropertyInfo[] getPropertyInfo(String u, Properties p) <span class="hljs-keyword">throws</span> SQLException &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.driver.getPropertyInfo(u, p);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">jdbcCompliant</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.driver.jdbcCompliant();<br>    &#125;<br><br>    <span class="hljs-comment">// @Override only valid jdk7+</span><br>    <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">return</span> Logger.getLogger(Logger.GLOBAL_LOGGER_NAME);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">unwrap</span><span class="hljs-params">(Class&lt;T&gt; iface)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(getClass().getName() + <span class="hljs-string">&quot; is not a wrapper.&quot;</span>);<br>  &#125;  <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWrapperFor</span><span class="hljs-params">(Class&lt;?&gt; iface)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// @Override only valid jdk7+</span><br>  <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// requires JDK version 1.6</span><br>    <span class="hljs-keyword">return</span> Logger.getLogger(Logger.GLOBAL_LOGGER_NAME);<br>  &#125;<br><br>  <span class="hljs-comment">// å‰©ä¸‹setã€getæ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PooledDataSourceFactory"><a href="#PooledDataSourceFactory" class="headerlink" title="PooledDataSourceFactory"></a>PooledDataSourceFactory</h4><p>â€‹ æ± åŒ–çš„æ•°æ®æºå·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PooledDataSourceFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnpooledDataSourceFactory</span> &#123;<br><br>  <span class="hljs-comment">// å’ŒUnpooledDataSourceFactoryä¸€æ ·ï¼Œåªæ˜¯æ•°æ®æºæ¢æˆäº†PooledDataSource</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PooledDataSourceFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.dataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PooledDataSource</span>();<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PoolState"><a href="#PoolState" class="headerlink" title="PoolState"></a>PoolState</h4><p>â€‹ æ± çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PoolState</span> &#123; <br><br>  <span class="hljs-keyword">protected</span> PooledDataSource dataSource;<br><br>  <span class="hljs-comment">// ç©ºé—²çš„è¿æ¥</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> List&lt;PooledConnection&gt; idleConnections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;PooledConnection&gt;();<br>  <span class="hljs-comment">// æ´»åŠ¨çš„è¿æ¥</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> List&lt;PooledConnection&gt; activeConnections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;PooledConnection&gt;();<br><br>  <span class="hljs-comment">//----------ä»¥ä¸‹æ˜¯ä¸€äº›ç»Ÿè®¡ä¿¡æ¯----------</span><br>  <span class="hljs-comment">// è¯·æ±‚æ¬¡æ•°</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> <span class="hljs-variable">requestCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// æ€»è¯·æ±‚æ—¶é—´</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> <span class="hljs-variable">accumulatedRequestTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> <span class="hljs-variable">accumulatedCheckoutTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> <span class="hljs-variable">claimedOverdueConnectionCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> <span class="hljs-variable">accumulatedCheckoutTimeOfOverdueConnections</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// æ€»ç­‰å¾…æ—¶é—´</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> <span class="hljs-variable">accumulatedWaitTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// è¦ç­‰å¾…çš„æ¬¡æ•°</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> <span class="hljs-variable">hadToWaitCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// åçš„è¿æ¥æ¬¡æ•°</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> <span class="hljs-variable">badConnectionCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PoolState</span><span class="hljs-params">(PooledDataSource dataSource)</span> &#123;<br>    <span class="hljs-built_in">this</span>.dataSource = dataSource;<br>  &#125;<br><br>  <span class="hljs-comment">// ä¸‹é¢å…¨æ˜¯ä¸€äº›getæ–¹æ³•ï¼Œå¹¶ä¸”éƒ½åŠ äº†é”ï¼Œè¿™äº›æ–¹æ³•åªæœ‰åœ¨æµ‹è¯•çš„æ—¶å€™ä½¿ç”¨è¿‡</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getRequestCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> requestCount;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getAverageRequestTime</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> requestCount == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : accumulatedRequestTime / requestCount;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getAverageWaitTime</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> hadToWaitCount == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : accumulatedWaitTime / hadToWaitCount;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getHadToWaitCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> hadToWaitCount;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getBadConnectionCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> badConnectionCount;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getClaimedOverdueConnectionCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> claimedOverdueConnectionCount;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getAverageOverdueCheckoutTime</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> claimedOverdueConnectionCount == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : accumulatedCheckoutTimeOfOverdueConnections / claimedOverdueConnectionCount;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getAverageCheckoutTime</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> requestCount == <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : accumulatedCheckoutTime / requestCount;<br>  &#125;<br><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getIdleConnectionCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> idleConnections.size();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getActiveConnectionCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> activeConnections.size();<br>  &#125;<br><br>  <span class="hljs-comment">// æ‰“å°ç»Ÿè®¡ä¿¡æ¯ï¼Œå¯ä»¥ä¾›æ€§èƒ½ä¼˜åŒ–ç”¨</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    builder.append(<span class="hljs-string">&quot;\n===CONFINGURATION==============================================&quot;</span>);<br>    builder.append(<span class="hljs-string">&quot;\n jdbcDriver                     &quot;</span>).append(dataSource.getDriver());<br>    builder.append(<span class="hljs-string">&quot;\n jdbcUrl                        &quot;</span>).append(dataSource.getUrl());<br>    builder.append(<span class="hljs-string">&quot;\n jdbcUsername                   &quot;</span>).append(dataSource.getUsername());<br>    builder.append(<span class="hljs-string">&quot;\n jdbcPassword                   &quot;</span>).append((dataSource.getPassword() == <span class="hljs-literal">null</span> ? <span class="hljs-string">&quot;NULL&quot;</span> : <span class="hljs-string">&quot;************&quot;</span>));<br>    builder.append(<span class="hljs-string">&quot;\n poolMaxActiveConnections       &quot;</span>).append(dataSource.poolMaximumActiveConnections);<br>    builder.append(<span class="hljs-string">&quot;\n poolMaxIdleConnections         &quot;</span>).append(dataSource.poolMaximumIdleConnections);<br>    builder.append(<span class="hljs-string">&quot;\n poolMaxCheckoutTime            &quot;</span>).append(dataSource.poolMaximumCheckoutTime);<br>    builder.append(<span class="hljs-string">&quot;\n poolTimeToWait                 &quot;</span>).append(dataSource.poolTimeToWait);<br>    builder.append(<span class="hljs-string">&quot;\n poolPingEnabled                &quot;</span>).append(dataSource.poolPingEnabled);<br>    builder.append(<span class="hljs-string">&quot;\n poolPingQuery                  &quot;</span>).append(dataSource.poolPingQuery);<br>    builder.append(<span class="hljs-string">&quot;\n poolPingConnectionsNotUsedFor  &quot;</span>).append(dataSource.poolPingConnectionsNotUsedFor);<br>    builder.append(<span class="hljs-string">&quot;\n ---STATUS-----------------------------------------------------&quot;</span>);<br>    builder.append(<span class="hljs-string">&quot;\n activeConnections              &quot;</span>).append(getActiveConnectionCount());<br>    builder.append(<span class="hljs-string">&quot;\n idleConnections                &quot;</span>).append(getIdleConnectionCount());<br>    builder.append(<span class="hljs-string">&quot;\n requestCount                   &quot;</span>).append(getRequestCount());<br>    builder.append(<span class="hljs-string">&quot;\n averageRequestTime             &quot;</span>).append(getAverageRequestTime());<br>    builder.append(<span class="hljs-string">&quot;\n averageCheckoutTime            &quot;</span>).append(getAverageCheckoutTime());<br>    builder.append(<span class="hljs-string">&quot;\n claimedOverdue                 &quot;</span>).append(getClaimedOverdueConnectionCount());<br>    builder.append(<span class="hljs-string">&quot;\n averageOverdueCheckoutTime     &quot;</span>).append(getAverageOverdueCheckoutTime());<br>    builder.append(<span class="hljs-string">&quot;\n hadToWait                      &quot;</span>).append(getHadToWaitCount());<br>    builder.append(<span class="hljs-string">&quot;\n averageWaitTime                &quot;</span>).append(getAverageWaitTime());<br>    builder.append(<span class="hljs-string">&quot;\n badConnectionCount             &quot;</span>).append(getBadConnectionCount());<br>    builder.append(<span class="hljs-string">&quot;\n===============================================================&quot;</span>);<br>    <span class="hljs-keyword">return</span> builder.toString();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PooledDataSource"><a href="#PooledDataSource" class="headerlink" title="PooledDataSource"></a>PooledDataSource</h4><p>â€‹ æœ‰è¿æ¥æ± çš„æ•°æ®æºï¼Œè¿™æ˜¯mybatisè‡ªå·±å®ç°çš„è¿æ¥æ± ã€‚å…¶ä»–è¿˜æœ‰è¯¸å¦‚C3P0çš„<code>com.mchange.v2.c3p0.ComboPooledDataSource</code>,DBCPç­‰</p><p>è¿˜æœ‰ä¸€äº›äººå–œæ¬¢è‡ªå·±ç”¨<code>apache commons pool</code>å†™ä¸€ä¸ªè¿æ¥æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PooledDataSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DataSource</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(PooledDataSource.class);<br><br>  <span class="hljs-comment">// æœ‰ä¸€ä¸ªæ± çŠ¶æ€</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">PoolState</span> <span class="hljs-variable">state</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PoolState</span>(<span class="hljs-built_in">this</span>);<br><br>  <span class="hljs-comment">// é‡Œé¢æœ‰ä¸€ä¸ªUnpooledDataSource</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UnpooledDataSource dataSource;<br><br>  <span class="hljs-comment">// OPTIONAL CONFIGURATION FIELDS</span><br>  <span class="hljs-comment">// æœ€å¤§æ´»è·ƒè¿æ¥æ•°</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">poolMaximumActiveConnections</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br>  <span class="hljs-comment">// æœ€å¤§ç©ºé—²è¿æ¥æ•°</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">poolMaximumIdleConnections</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br><br>  <span class="hljs-comment">// åœ¨è¢«å¼ºåˆ¶è¿”å›ä¹‹å‰,æ± ä¸­è¿æ¥è¢«æ£€æŸ¥çš„æ—¶é—´</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">poolMaximumCheckoutTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">20000</span>;<br><br>  <span class="hljs-comment">// æ²¡æœ‰è·å–åˆ°æ•°æ®åº“è¿æ¥æ—¶çš„æœ€å¤§ç­‰å¾…æ—¶é—´</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">poolTimeToWait</span> <span class="hljs-operator">=</span> <span class="hljs-number">20000</span>;<br><br>  <span class="hljs-comment">// å‘é€åˆ°æ•°æ®åº“çš„ä¾¦æµ‹æŸ¥è¯¢,ç”¨æ¥éªŒè¯è¿æ¥æ˜¯å¦æ­£å¸¸å·¥ä½œ,å¹¶ä¸”å‡†å¤‡æ¥å—è¯·æ±‚ã€‚é»˜è®¤æ˜¯â€œNO PING QUERY SETâ€ ,</span><br>  <span class="hljs-comment">// è®¸å¤šæ•°æ®åº“é©±åŠ¨è¿æ¥ä¼šå¤±è´¥</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">String</span> <span class="hljs-variable">poolPingQuery</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;NO PING QUERY SET&quot;</span>;<br><br>  <span class="hljs-comment">// å¼€å¯æˆ–ç¦ç”¨ä¾¦æµ‹æŸ¥è¯¢</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">poolPingEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>  <span class="hljs-comment">// ç”¨æ¥é…ç½® poolPingQuery å¤šé•¿æ—¶é—´è¢«ç”¨ä¸€æ¬¡</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">poolPingConnectionsNotUsedFor</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// æ ‡è¯†è¿æ¥çš„hashç </span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> expectedConnectionTypeCode;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PooledDataSource</span><span class="hljs-params">()</span> &#123;<br>    dataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnpooledDataSource</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PooledDataSource</span><span class="hljs-params">(String driver, String url, String username, String password)</span> &#123;<br>    dataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnpooledDataSource</span>(driver, url, username, password);<br>    expectedConnectionTypeCode = assembleConnectionTypeCode(dataSource.getUrl(), dataSource.getUsername(), dataSource.getPassword());<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PooledDataSource</span><span class="hljs-params">(String driver, String url, Properties driverProperties)</span> &#123;<br>    dataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnpooledDataSource</span>(driver, url, driverProperties);<br>    expectedConnectionTypeCode = assembleConnectionTypeCode(dataSource.getUrl(), dataSource.getUsername(), dataSource.getPassword());<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PooledDataSource</span><span class="hljs-params">(ClassLoader driverClassLoader, String driver, String url, String username, String password)</span> &#123;<br>    dataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnpooledDataSource</span>(driverClassLoader, driver, url, username, password);<br>    expectedConnectionTypeCode = assembleConnectionTypeCode(dataSource.getUrl(), dataSource.getUsername(), dataSource.getPassword());<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PooledDataSource</span><span class="hljs-params">(ClassLoader driverClassLoader, String driver, String url, Properties driverProperties)</span> &#123;<br>    dataSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnpooledDataSource</span>(driverClassLoader, driver, url, driverProperties);<br>    expectedConnectionTypeCode = assembleConnectionTypeCode(dataSource.getUrl(), dataSource.getUsername(), dataSource.getPassword());<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// è¦†ç›–äº†DataSource.getConnectionæ–¹æ³•ï¼Œæ¯æ¬¡éƒ½æ˜¯popä¸€ä¸ªConnectionï¼Œå³ä»æ± ä¸­å–å‡ºä¸€ä¸ªæ¥</span><br>    <span class="hljs-keyword">return</span> popConnection(dataSource.getUsername(), dataSource.getPassword()).getProxyConnection();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String username, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> popConnection(username, password).getProxyConnection();<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> PooledConnection <span class="hljs-title function_">popConnection</span><span class="hljs-params">(String username, String password)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">countedWait</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">PooledConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">localBadConnectionCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// æœ€å¤–é¢æ˜¯whileæ­»å¾ªç¯ï¼Œå¦‚æœä¸€ç›´æ‹¿ä¸åˆ°connectionï¼Œåˆ™ä¸æ–­å°è¯•</span><br>    <span class="hljs-keyword">while</span> (conn == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">synchronized</span> (state) &#123;<br>        <span class="hljs-keyword">if</span> (!state.idleConnections.isEmpty()) &#123;<br>          <span class="hljs-comment">// å¦‚æœæœ‰ç©ºé—²çš„è¿æ¥çš„è¯</span><br>          <span class="hljs-comment">// Pool has available connection</span><br>          <span class="hljs-comment">// åˆ é™¤ç©ºé—²åˆ—è¡¨é‡Œç¬¬ä¸€ä¸ªï¼Œè¿”å›</span><br>          conn = state.idleConnections.remove(<span class="hljs-number">0</span>);<br>          <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>            log.debug(<span class="hljs-string">&quot;Checked out connection &quot;</span> + conn.getRealHashCode() + <span class="hljs-string">&quot; from pool.&quot;</span>);<br>          &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// å¦‚æœæ²¡æœ‰å¯ç”¨ï¼ˆç©ºé—²ï¼‰çš„è¿æ¥</span><br>          <span class="hljs-comment">// Pool does not have available connection</span><br>          <span class="hljs-keyword">if</span> (state.activeConnections.size() &lt; poolMaximumActiveConnections) &#123;<br>              <span class="hljs-comment">// å¦‚æœactiveConnectionsæ²¡æœ‰è¾¾åˆ°é™åˆ¶,é‚£å°±newä¸€ä¸ªPooledConnection</span><br>            <span class="hljs-comment">// Can create new connection</span><br>            conn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PooledConnection</span>(dataSource.getConnection(), <span class="hljs-built_in">this</span>);<br>            <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>              log.debug(<span class="hljs-string">&quot;Created connection &quot;</span> + conn.getRealHashCode() + <span class="hljs-string">&quot;.&quot;</span>);<br>            &#125;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-comment">// å¦‚æœactiveConnectionså·²ç»å¾ˆå¤šäº†ï¼Œé‚£ä¸èƒ½å†newäº†</span><br>            <span class="hljs-comment">// Cannot create new connection</span><br>              <span class="hljs-comment">// å–å¾—activeConnectionsåˆ—è¡¨çš„ç¬¬ä¸€ä¸ªï¼ˆæœ€è€çš„ï¼‰</span><br>            <span class="hljs-type">PooledConnection</span> <span class="hljs-variable">oldestActiveConnection</span> <span class="hljs-operator">=</span> state.activeConnections.get(<span class="hljs-number">0</span>);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">longestCheckoutTime</span> <span class="hljs-operator">=</span> oldestActiveConnection.getCheckoutTime();<br>            <span class="hljs-keyword">if</span> (longestCheckoutTime &gt; poolMaximumCheckoutTime) &#123;<br>                <span class="hljs-comment">// å¦‚æœcheckoutæ—¶é—´è¿‡é•¿ï¼Œåˆ™è¿™ä¸ªconnectionæ ‡è®°ä¸ºoverdueï¼ˆè¿‡æœŸï¼‰</span><br>              <span class="hljs-comment">// Can claim overdue connection</span><br>              state.claimedOverdueConnectionCount++;<br>              state.accumulatedCheckoutTimeOfOverdueConnections += longestCheckoutTime;<br>              state.accumulatedCheckoutTime += longestCheckoutTime;<br>              state.activeConnections.remove(oldestActiveConnection);<br>              <span class="hljs-comment">// è¿æ¥å…³é—­ä¹‹å‰çœ‹æ˜¯å¦éœ€è¦å›æ»š</span><br>              <span class="hljs-keyword">if</span> (!oldestActiveConnection.getRealConnection().getAutoCommit()) &#123;<br>                oldestActiveConnection.getRealConnection().rollback();<br>              &#125;<br>              <span class="hljs-comment">// åˆ æ‰æœ€è€çš„è¿æ¥ï¼Œç„¶åå†newä¸€ä¸ªæ–°è¿æ¥</span><br>              conn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PooledConnection</span>(oldestActiveConnection.getRealConnection(), <span class="hljs-built_in">this</span>);<br>              <span class="hljs-comment">// è¿æ¥å¤±æ•ˆ</span><br>              oldestActiveConnection.invalidate();<br>              <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>                log.debug(<span class="hljs-string">&quot;Claimed overdue connection &quot;</span> + conn.getRealHashCode() + <span class="hljs-string">&quot;.&quot;</span>);<br>              &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// å¦‚æœcheckoutæ—¶é—´ä¸å¤Ÿé•¿ï¼Œç­‰å¾…å§</span><br>              <span class="hljs-comment">// Must wait</span><br>              <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (!countedWait) &#123;<br>                    <span class="hljs-comment">// ç»Ÿè®¡ä¿¡æ¯ï¼šç­‰å¾…æ¬¡æ•°+1</span><br>                  state.hadToWaitCount++;<br>                  countedWait = <span class="hljs-literal">true</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>                  log.debug(<span class="hljs-string">&quot;Waiting as long as &quot;</span> + poolTimeToWait + <span class="hljs-string">&quot; milliseconds for connection.&quot;</span>);<br>                &#125;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">wt</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>                <span class="hljs-comment">// ç¡ä¸€ä¼šå„¿å§</span><br>                state.wait(poolTimeToWait);<br>                state.accumulatedWaitTime += System.currentTimeMillis() - wt;<br>              &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                <span class="hljs-keyword">break</span>;<br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// å¦‚æœå·²ç»æ‹¿åˆ°connectionï¼Œåˆ™è¿”å›</span><br>          <span class="hljs-keyword">if</span> (conn.isValid()) &#123;<br>            <span class="hljs-keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;<br>              conn.getRealConnection().rollback();<br>            &#125;<br>            conn.setConnectionTypeCode(assembleConnectionTypeCode(dataSource.getUrl(), username, password));<br>            <span class="hljs-comment">// è®°å½•checkoutæ—¶é—´</span><br>            conn.setCheckoutTimestamp(System.currentTimeMillis());<br>            conn.setLastUsedTimestamp(System.currentTimeMillis());<br>            state.activeConnections.add(conn);<br>            state.requestCount++;<br>            state.accumulatedRequestTime += System.currentTimeMillis() - t;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>              log.debug(<span class="hljs-string">&quot;A bad connection (&quot;</span> + conn.getRealHashCode() + <span class="hljs-string">&quot;) was returned from the pool, getting another connection.&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">// å¦‚æœæ²¡æ‹¿åˆ°ï¼Œç»Ÿè®¡ä¿¡æ¯ï¼šåè¿æ¥+1</span><br>            state.badConnectionCount++;<br>            localBadConnectionCount++;<br>            conn = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">if</span> (localBadConnectionCount &gt; (poolMaximumIdleConnections + <span class="hljs-number">3</span>)) &#123;<br>                <span class="hljs-comment">// å¦‚æœå¥½å‡ æ¬¡éƒ½æ‹¿ä¸åˆ°ï¼Œå°±æ”¾å¼ƒäº†ï¼ŒæŠ›å‡ºå¼‚å¸¸</span><br>              <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>                log.debug(<span class="hljs-string">&quot;PooledDataSource: Could not get a good connection to the database.&quot;</span>);<br>              &#125;<br>              <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">&quot;PooledDataSource: Could not get a good connection to the database.&quot;</span>);<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;      <br>    &#125;<br><br>    <span class="hljs-comment">// æ²¡æœ‰æ‹¿åˆ°è¿æ¥ï¼ŒæŠ›å¼‚å¸¸å‡ºå»</span><br>    <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>        log.debug(<span class="hljs-string">&quot;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">&quot;PooledDataSource: Unknown severe error condition.  The connection pool returned a null connection.&quot;</span>);<br>    &#125;<br><br>        <span class="hljs-keyword">return</span> conn;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDriver</span><span class="hljs-params">(String driver)</span> &#123;<br>    dataSource.setDriver(driver);<br>    forceCloseAll();<br>  &#125;<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * Closes all active and idle connections in the pool</span><br><span class="hljs-comment">   * å…³é—­è¿æ¥æ± å†…æ‰€æœ‰æ´»è·ƒè¿æ¥å’Œç©ºé—²è¿æ¥</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">forceCloseAll</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (state) &#123;<br>      expectedConnectionTypeCode = assembleConnectionTypeCode(dataSource.getUrl(), dataSource.getUsername(), dataSource.getPassword());<br>      <span class="hljs-comment">// å…³é—­æ‰€æœ‰çš„activeConnectionså’ŒidleConnections</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> state.activeConnections.size(); i &gt; <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-type">PooledConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> state.activeConnections.remove(i - <span class="hljs-number">1</span>);<br>          conn.invalidate();<br><br>          <span class="hljs-type">Connection</span> <span class="hljs-variable">realConn</span> <span class="hljs-operator">=</span> conn.getRealConnection();<br>          <span class="hljs-keyword">if</span> (!realConn.getAutoCommit()) &#123;<br>            realConn.rollback();<br>          &#125;<br>          realConn.close();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-comment">// ignore</span><br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> state.idleConnections.size(); i &gt; <span class="hljs-number">0</span>; i--) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-type">PooledConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> state.idleConnections.remove(i - <span class="hljs-number">1</span>);<br>          conn.invalidate();<br><br>          <span class="hljs-type">Connection</span> <span class="hljs-variable">realConn</span> <span class="hljs-operator">=</span> conn.getRealConnection();<br>          <span class="hljs-keyword">if</span> (!realConn.getAutoCommit()) &#123;<br>            realConn.rollback();<br>          &#125;<br>          realConn.close();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-comment">// ignore</span><br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>      log.debug(<span class="hljs-string">&quot;PooledDataSource forcefully closed/removed all connections.&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æŸä¸ªçº¿ç¨‹ç”¨å®Œæ•°æ®åº“è¿æ¥ï¼Œå°†å…¶å½’è¿˜åˆ°æ•°æ®åº“è¿æ¥æ± </span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pushConnection</span><span class="hljs-params">(PooledConnection conn)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br><br>    <span class="hljs-keyword">synchronized</span> (state) &#123;<br>      <span class="hljs-comment">// å…ˆä»activeConnectionsä¸­åˆ é™¤æ­¤connection</span><br>      state.activeConnections.remove(conn);<br>      <span class="hljs-keyword">if</span> (conn.isValid()) &#123;<br>        <span class="hljs-keyword">if</span> (state.idleConnections.size() &lt; poolMaximumIdleConnections &amp;&amp; conn.getConnectionTypeCode() == expectedConnectionTypeCode) &#123;<br>            <span class="hljs-comment">// å¦‚æœç©ºé—²çš„è¿æ¥æ²¡æœ‰è¾¾åˆ°é™åˆ¶</span><br>          state.accumulatedCheckoutTime += conn.getCheckoutTime();<br>          <span class="hljs-keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;<br>            conn.getRealConnection().rollback();<br>          &#125;<br>          <span class="hljs-comment">// newä¸€ä¸ªæ–°çš„Connectionï¼ŒåŠ å…¥åˆ°idleåˆ—è¡¨</span><br>          <span class="hljs-type">PooledConnection</span> <span class="hljs-variable">newConn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PooledConnection</span>(conn.getRealConnection(), <span class="hljs-built_in">this</span>);<br>          state.idleConnections.add(newConn);<br>          newConn.setCreatedTimestamp(conn.getCreatedTimestamp());<br>          newConn.setLastUsedTimestamp(conn.getLastUsedTimestamp());<br>          conn.invalidate();<br>          <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>            log.debug(<span class="hljs-string">&quot;Returned connection &quot;</span> + newConn.getRealHashCode() + <span class="hljs-string">&quot; to pool.&quot;</span>);<br>          &#125;<br>          <span class="hljs-comment">// é€šçŸ¥å…¶ä»–çº¿ç¨‹å¯ä»¥æ¥æŠ¢connectionäº†</span><br>          state.notifyAll();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// å¦åˆ™ï¼Œå³ç©ºé—²çš„è¿æ¥å·²ç»è¾¾åˆ°é™åˆ¶</span><br>          state.accumulatedCheckoutTime += conn.getCheckoutTime();<br>          <span class="hljs-keyword">if</span> (!conn.getRealConnection().getAutoCommit()) &#123;<br>            conn.getRealConnection().rollback();<br>          &#125;<br>          <span class="hljs-comment">// é‚£å°±å°†connectionå…³é—­å°±å¯ä»¥äº†</span><br>          conn.getRealConnection().close();<br>          <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>            log.debug(<span class="hljs-string">&quot;Closed connection &quot;</span> + conn.getRealHashCode() + <span class="hljs-string">&quot;.&quot;</span>);<br>          &#125;<br>          conn.invalidate();<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// è¿æ¥å·²ç»å¤±æ•ˆ</span><br>        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>          log.debug(<span class="hljs-string">&quot;A bad connection (&quot;</span> + conn.getRealHashCode() + <span class="hljs-string">&quot;) attempted to return to the pool, discarding connection.&quot;</span>);<br>        &#125;<br>        state.badConnectionCount++;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦ä»å¯ç”¨</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">pingConnection</span><span class="hljs-params">(PooledConnection conn)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å…ˆçœ‹è¿æ¥æ˜¯å¦å…³é—­</span><br>      result = !conn.getRealConnection().isClosed();<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>        log.debug(<span class="hljs-string">&quot;Connection &quot;</span> + conn.getRealHashCode() + <span class="hljs-string">&quot; is BAD: &quot;</span> + e.getMessage());<br>      &#125;<br>      result = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (result) &#123;<br>      <span class="hljs-comment">// æ˜¯å¦å¼€å¯å‘é€æ•°æ®è¿æ¥æ£€æŸ¥</span><br>      <span class="hljs-keyword">if</span> (poolPingEnabled) &#123;<br>        <span class="hljs-keyword">if</span> (poolPingConnectionsNotUsedFor &gt;= <span class="hljs-number">0</span> &amp;&amp; conn.getTimeElapsedSinceLastUse() &gt; poolPingConnectionsNotUsedFor) &#123;<br>          <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>              log.debug(<span class="hljs-string">&quot;Testing connection &quot;</span> + conn.getRealHashCode() + <span class="hljs-string">&quot; ...&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">// å°±æ˜¯æ‰§è¡Œä¸€ä¸‹ &quot;NO PING QUERY SET&quot; è¯­å¥</span><br>            <span class="hljs-type">Connection</span> <span class="hljs-variable">realConn</span> <span class="hljs-operator">=</span> conn.getRealConnection();<br>            <span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> realConn.createStatement();<br>            <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> statement.executeQuery(poolPingQuery);<br>            rs.close();<br>            statement.close();<br>            <span class="hljs-keyword">if</span> (!realConn.getAutoCommit()) &#123;<br>              realConn.rollback();<br>            &#125;<br>            result = <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>              log.debug(<span class="hljs-string">&quot;Connection &quot;</span> + conn.getRealHashCode() + <span class="hljs-string">&quot; is GOOD!&quot;</span>);<br>            &#125;<br>          &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// æ‰§è¡Œè¯­å¥å¤±è´¥åï¼Œå…³é—­è¿æ¥</span><br>            log.warn(<span class="hljs-string">&quot;Execution of ping query &#x27;&quot;</span> + poolPingQuery + <span class="hljs-string">&quot;&#x27; failed: &quot;</span> + e.getMessage());<br>            <span class="hljs-keyword">try</span> &#123;<br>              conn.getRealConnection().close();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e2) &#123;<br>              <span class="hljs-comment">//ignore</span><br>            &#125;<br>            result = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>              log.debug(<span class="hljs-string">&quot;Connection &quot;</span> + conn.getRealHashCode() + <span class="hljs-string">&quot; is BAD: &quot;</span> + e.getMessage());<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;<br><br>  <span class="hljs-comment">// è§£ææ± åŒ–çš„è¿æ¥ï¼ˆPooledConnectionï¼‰è·å–çœŸæ­£çš„è¿æ¥ï¼ˆConnectionï¼‰</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">unwrapConnection</span><span class="hljs-params">(Connection conn)</span> &#123;<br>    <span class="hljs-keyword">if</span> (Proxy.isProxyClass(conn.getClass())) &#123;<br>      <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> Proxy.getInvocationHandler(conn);<br>      <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> PooledConnection) &#123;<br>        <span class="hljs-keyword">return</span> ((PooledConnection) handler).getRealConnection();<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> conn;<br>  &#125;<br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    forceCloseAll();<br>    <span class="hljs-built_in">super</span>.finalize();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">unwrap</span><span class="hljs-params">(Class&lt;T&gt; iface)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(getClass().getName() + <span class="hljs-string">&quot; is not a wrapper.&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWrapperFor</span><span class="hljs-params">(Class&lt;?&gt; iface)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Logger <span class="hljs-title function_">getParentLogger</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Logger.getLogger(Logger.GLOBAL_LOGGER_NAME); <span class="hljs-comment">// requires JDK version 1.6</span><br>  &#125;<br><br>  <span class="hljs-comment">// å…¶ä»–çš„setã€getæ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PooledConnection"><a href="#PooledConnection" class="headerlink" title="PooledConnection"></a>PooledConnection</h4><p>â€‹ æ± åŒ–çš„è¿æ¥ï¼Œå¯¹java.sql.Connectionè¿›è¡Œä»£ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PooledConnection</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLOSE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;close&quot;</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Class&lt;?&gt;[] IFACES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[] &#123; Connection.class &#125;;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">hashCode</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">private</span> PooledDataSource dataSource;<br>  <span class="hljs-comment">// çœŸæ­£çš„è¿æ¥</span><br>  <span class="hljs-keyword">private</span> Connection realConnection;<br>  <span class="hljs-comment">// ä»£ç†çš„è¿æ¥</span><br>  <span class="hljs-keyword">private</span> Connection proxyConnection;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> checkoutTimestamp;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> createdTimestamp;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> lastUsedTimestamp;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> connectionTypeCode;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> valid;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PooledConnection</span><span class="hljs-params">(Connection connection, PooledDataSource dataSource)</span> &#123;<br>    <span class="hljs-built_in">this</span>.hashCode = connection.hashCode();<br>    <span class="hljs-built_in">this</span>.realConnection = connection;<br>    <span class="hljs-built_in">this</span>.dataSource = dataSource;<br>    <span class="hljs-built_in">this</span>.createdTimestamp = System.currentTimeMillis();<br>    <span class="hljs-built_in">this</span>.lastUsedTimestamp = System.currentTimeMillis();<br>    <span class="hljs-built_in">this</span>.valid = <span class="hljs-literal">true</span>;<br>    <span class="hljs-built_in">this</span>.proxyConnection = (Connection) Proxy.newProxyInstance(Connection.class.getClassLoader(), IFACES, <span class="hljs-built_in">this</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// ä½¿è¿æ¥å¤±æ•ˆ</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">()</span> &#123;<br>    valid = <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// æŸ¥çœ‹è¿æ¥æ˜¯å¦å¤±æ•ˆ</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> valid &amp;&amp; realConnection != <span class="hljs-literal">null</span> &amp;&amp; dataSource.pingConnection(<span class="hljs-built_in">this</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getTimeElapsedSinceLastUse</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> System.currentTimeMillis() - lastUsedTimestamp;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> System.currentTimeMillis() - createdTimestamp;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object obj)</span> &#123;<br>    <span class="hljs-comment">// å®é™…ä¸Šæ˜¯æ¯”è¾ƒ Connection çš„hashCode</span><br>    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> PooledConnection) &#123;<br>      <span class="hljs-keyword">return</span> realConnection.hashCode() == (((PooledConnection) obj).realConnection.hashCode());<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> Connection) &#123;<br>      <span class="hljs-keyword">return</span> hashCode == obj.hashCode();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> method.getName();<br>    <span class="hljs-comment">// å¦‚æœè°ƒç”¨closeçš„è¯ï¼Œå¿½ç•¥å®ƒï¼Œåè€Œå°†è¿™ä¸ªconnectionå½’è¿˜ç»™è¿æ¥æ± </span><br>    <span class="hljs-keyword">if</span> (CLOSE.hashCode() == methodName.hashCode() &amp;&amp; CLOSE.equals(methodName)) &#123;<br>      dataSource.pushConnection(<span class="hljs-built_in">this</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// é Object ç±»çš„æ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (!Object.class.equals(method.getDeclaringClass())) &#123;<br>          <span class="hljs-comment">// issue #579 toString() should never fail</span><br>          <span class="hljs-comment">// throw an SQLException instead of a Runtime</span><br>          <span class="hljs-comment">// é™¤äº†toString()æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•è°ƒç”¨ä¹‹å‰è¦æ£€æŸ¥connectionæ˜¯å¦è¿˜æ˜¯åˆæ³•çš„,ä¸åˆæ³•è¦æŠ›å‡ºSQLException</span><br>          checkConnection();<br>        &#125;<br>        <span class="hljs-comment">// å…¶ä»–çš„æ–¹æ³•ï¼Œåˆ™äº¤ç»™çœŸæ­£çš„connectionå»è°ƒç”¨</span><br>        <span class="hljs-keyword">return</span> method.invoke(realConnection, args);<br>      &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">if</span> (!valid) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">&quot;Error accessing PooledConnection. Connection is invalid.&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// å…¶ä»–setã€getæ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>7-reflection</title>
    <link href="/2023/07/10/mybatis-source-code/7-reflection/"/>
    <url>/2023/07/10/mybatis-source-code/7-reflection/</url>
    
    <content type="html"><![CDATA[<h4 id="ObjectFactory"><a href="#ObjectFactory" class="headerlink" title="ObjectFactory"></a>ObjectFactory</h4><p>â€‹ å¯¹è±¡å·¥å‚ï¼Œæ‰€æœ‰éœ€è¦çš„new Objectséƒ½ç”±å…¶åˆ›å»º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ObjectFactory</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Sets configuration properties.</span><br><span class="hljs-comment">   * è®¾ç½®å±æ€§</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> properties configuration properties</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Creates a new object with default constructor. </span><br><span class="hljs-comment">   * ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°åˆ›å»ºæ–°å¯¹è±¡</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> type Object type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  &lt;T&gt; T <span class="hljs-title function_">create</span><span class="hljs-params">(Class&lt;T&gt; type)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Creates a new object with the specified constructor and params.</span><br><span class="hljs-comment">   * ä½¿ç”¨æŒ‡å®šçš„æ„é€ å‡½æ•°å’Œæ„é€ å‡½æ•°å‚æ•°åˆ›å»ºå¯¹è±¡</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> type Object type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> constructorArgTypes Constructor argument types</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> constructorArgs Constructor argument values</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">   */</span><br>  &lt;T&gt; T <span class="hljs-title function_">create</span><span class="hljs-params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span>;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Returns true if this object can have a set of other objects.</span><br><span class="hljs-comment">   * It&#x27;s main purpose is to support non-java.util.Collection objects like Scala collections.</span><br><span class="hljs-comment">   * è¿”å›è¿™ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯é›†åˆï¼Œä¸ºäº†æ”¯æŒé java.util.Collection å¯¹è±¡ï¼Œæ¯”å¦‚Scala collections</span><br><span class="hljs-comment">   * </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@since</span> 3.1.0</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> type Object type</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> whether it is a collection or not</span><br><span class="hljs-comment">   */</span><br>  &lt;T&gt; <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCollection</span><span class="hljs-params">(Class&lt;T&gt; type)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DefaultObjectFactory"><a href="#DefaultObjectFactory" class="headerlink" title="DefaultObjectFactory"></a>DefaultObjectFactory</h4><p>â€‹ é»˜è®¤çš„å¯¹è±¡å·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultObjectFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectFactory</span>, Serializable &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">8855120656740914948L</span>;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">create</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>    <span class="hljs-keyword">return</span> create(type, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">create</span><span class="hljs-params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-comment">// æ ¹æ®æ¥å£åˆ›å»ºå…·ä½“çš„ç±»</span><br>    <span class="hljs-comment">// 1.è§£ææ¥å£ï¼ˆä¸ºæ¥å£æŒ‡å®šå®ç°ç±»ï¼‰</span><br>    Class&lt;?&gt; classToCreate = resolveInterface(type);<br>    <span class="hljs-comment">// we know types are assignable</span><br>    <span class="hljs-comment">// 2.å®ä¾‹åŒ–ç±»</span><br>    <span class="hljs-keyword">return</span> (T) instantiateClass(classToCreate, constructorArgTypes, constructorArgs);<br>  &#125; <br><br>  <span class="hljs-comment">// 1.è§£ææ¥å£,å°†interfaceè½¬ä¸ºå®é™…class</span><br>  <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveInterface(Class&lt;?&gt; type) &#123;<br>    Class&lt;?&gt; classToCreate;<br>    <span class="hljs-keyword">if</span> (type == List.class || type == Collection.class || type == Iterable.class) &#123;<br>      <span class="hljs-comment">// List|Collection|Iterable--&gt;ArrayList</span><br>      classToCreate = ArrayList.class;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == Map.class) &#123;<br>      <span class="hljs-comment">// Map-&gt;HashMap</span><br>      classToCreate = HashMap.class;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == SortedSet.class) &#123; <span class="hljs-comment">// issue #510 Collections Support</span><br>      <span class="hljs-comment">// SortedSet-&gt;TreeSet</span><br>      classToCreate = TreeSet.class;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == Set.class) &#123;<br>      <span class="hljs-comment">// Set-&gt;HashSet</span><br>      classToCreate = HashSet.class;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// é™¤æ­¤ä»¥å¤–ï¼Œå°±ç”¨åŸæ¥çš„ç±»å‹</span><br>      classToCreate = type;<br>    &#125;<br>    <span class="hljs-keyword">return</span> classToCreate;<br>  &#125;  <br><br>  <span class="hljs-comment">// 2.å®ä¾‹åŒ–ç±»</span><br>  <span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">instantiateClass</span><span class="hljs-params">(Class&lt;T&gt; type, List&lt;Class&lt;?&gt;&gt; constructorArgTypes, List&lt;Object&gt; constructorArgs)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Constructor&lt;T&gt; constructor;<br>      <span class="hljs-comment">// å¦‚æœæ²¡æœ‰ä¼ å…¥constructorï¼Œè°ƒç”¨ç©ºæ„é€ å‡½æ•°ï¼Œæ ¸å¿ƒæ˜¯è°ƒç”¨Constructor.newInstance</span><br>      <span class="hljs-keyword">if</span> (constructorArgTypes == <span class="hljs-literal">null</span> || constructorArgs == <span class="hljs-literal">null</span>) &#123;<br>        constructor = type.getDeclaredConstructor();<br>        <span class="hljs-keyword">if</span> (!constructor.isAccessible()) &#123;<br>          constructor.setAccessible(<span class="hljs-literal">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> constructor.newInstance();<br>      &#125;<br>      <span class="hljs-comment">// å¦‚æœä¼ å…¥constructorï¼Œè°ƒç”¨ä¼ å…¥çš„æ„é€ å‡½æ•°ï¼Œæ ¸å¿ƒæ˜¯è°ƒç”¨Constructor.newInstance</span><br>      constructor = type.getDeclaredConstructor(constructorArgTypes.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[constructorArgTypes.size()]));<br>      <span class="hljs-keyword">if</span> (!constructor.isAccessible()) &#123;<br>        constructor.setAccessible(<span class="hljs-literal">true</span>);<br>      &#125;<br>      <span class="hljs-keyword">return</span> constructor.newInstance(constructorArgs.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[constructorArgs.size()]));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-comment">//å¦‚æœå‡ºé”™ï¼ŒåŒ…è£…ä¸€ä¸‹ï¼Œé‡æ–°æŠ›å‡ºè‡ªå·±çš„å¼‚å¸¸</span><br>      <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">argTypes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>      <span class="hljs-keyword">if</span> (constructorArgTypes != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (Class&lt;?&gt; argType : constructorArgTypes) &#123;<br>          argTypes.append(argType.getSimpleName());<br>          argTypes.append(<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>      &#125;<br>      <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">argValues</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>      <span class="hljs-keyword">if</span> (constructorArgs != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (Object argValue : constructorArgs) &#123;<br>          argValues.append(String.valueOf(argValue));<br>          argValues.append(<span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;Error instantiating &quot;</span> + type + <span class="hljs-string">&quot; with invalid types (&quot;</span> + argTypes + <span class="hljs-string">&quot;) or values (&quot;</span> + argValues + <span class="hljs-string">&quot;). Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// é»˜è®¤æ²¡æœ‰å±æ€§å¯ä»¥è®¾ç½®</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProperties</span><span class="hljs-params">(Properties properties)</span> &#123;<br>    <span class="hljs-comment">// no props for default</span><br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCollection</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>    <span class="hljs-comment">// æ˜¯å¦æ˜¯Collectionçš„å­ç±»ï¼ˆé»˜è®¤çš„å®ç°ä¼¼ä¹æ²¡æœ‰è€ƒè™‘é java.util.Collection çš„ é›†åˆï¼‰</span><br>    <span class="hljs-keyword">return</span> Collection.class.isAssignableFrom(type);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Invoker"><a href="#Invoker" class="headerlink" title="Invoker"></a>Invoker</h4><p>â€‹ ä¸ºè®¾ç½®å±æ€§ã€è·å–å±æ€§ã€è°ƒç”¨æ–¹æ³•è·å–æŠ½è±¡æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Invoker</span> &#123; <br><br>  <span class="hljs-comment">// è°ƒç”¨</span><br>  Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object target, Object[] args)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, InvocationTargetException;<br><br>  <span class="hljs-comment">// å–å¾—ç±»å‹</span><br>  Class&lt;?&gt; getType();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="GetFieldInvoker"><a href="#GetFieldInvoker" class="headerlink" title="GetFieldInvoker"></a>GetFieldInvoker</h4><p>â€‹ å°è£…field çš„ get æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GetFieldInvoker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Invoker</span> &#123;<br>  <span class="hljs-keyword">private</span> Field field;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">GetFieldInvoker</span><span class="hljs-params">(Field field)</span> &#123;<br>    <span class="hljs-built_in">this</span>.field = field;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object target, Object[] args)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, InvocationTargetException &#123;<br>    <span class="hljs-keyword">return</span> field.get(target);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getType() &#123;<br>    <span class="hljs-keyword">return</span> field.getType();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SetFieldInvoker"><a href="#SetFieldInvoker" class="headerlink" title="SetFieldInvoker"></a>SetFieldInvoker</h4><p>â€‹ å°è£…fieldçš„ set æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SetFieldInvoker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Invoker</span> &#123;<br>  <span class="hljs-keyword">private</span> Field field;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SetFieldInvoker</span><span class="hljs-params">(Field field)</span> &#123;<br>    <span class="hljs-built_in">this</span>.field = field;<br>  &#125;<br><br>  <span class="hljs-comment">// å°±æ˜¯è°ƒç”¨Field.set</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object target, Object[] args)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, InvocationTargetException &#123;<br>    field.set(target, args[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getType() &#123;<br>    <span class="hljs-keyword">return</span> field.getType();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MethodInvoker"><a href="#MethodInvoker" class="headerlink" title="MethodInvoker"></a>MethodInvoker</h4><p>â€‹ å°è£…methodçš„ invoke æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodInvoker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Invoker</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br>  <span class="hljs-keyword">private</span> Method method;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MethodInvoker</span><span class="hljs-params">(Method method)</span> &#123;<br>    <span class="hljs-built_in">this</span>.method = method;<br><br>    <span class="hljs-comment">// å¦‚æœåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œè¿”å›å‚æ•°ç±»å‹ï¼Œå¦åˆ™è¿”å›returnçš„ç±»å‹</span><br>    <span class="hljs-keyword">if</span> (method.getParameterTypes().length == <span class="hljs-number">1</span>) &#123;<br>      type = method.getParameterTypes()[<span class="hljs-number">0</span>];<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      type = method.getReturnType();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object target, Object[] args)</span> <span class="hljs-keyword">throws</span> IllegalAccessException, InvocationTargetException &#123;<br>    <span class="hljs-keyword">return</span> method.invoke(target, args);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getType() &#123;<br>    <span class="hljs-keyword">return</span> type;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PropertyCopier"><a href="#PropertyCopier" class="headerlink" title="PropertyCopier"></a>PropertyCopier</h4><p>â€‹ å±æ€§å¤åˆ¶å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PropertyCopier</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">PropertyCopier</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Prevent Instantiation of Static Class</span><br>  &#125;<br><br>  <span class="hljs-comment">// å¤åˆ¶å±æ€§,ç±»ä¼¼åŠŸèƒ½çš„è¿˜æœ‰åˆ«çš„ç±»ï¼Œ</span><br>  <span class="hljs-comment">// å¦‚apache commons beanutil çš„BeanUtils.copyProperties</span><br>  <span class="hljs-comment">// Spring çš„BeanUtils.copyProperties</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">copyBeanProperties</span><span class="hljs-params">(Class&lt;?&gt; type, Object sourceBean, Object destinationBean)</span> &#123;<br>    Class&lt;?&gt; parent = type;<br>    <span class="hljs-keyword">while</span> (parent != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// å¾ªç¯å°†çˆ¶ç±»çš„å±æ€§éƒ½å¤åˆ¶è¿‡æ¥</span><br>      <span class="hljs-keyword">final</span> Field[] fields = parent.getDeclaredFields();<br>      <span class="hljs-keyword">for</span>(Field field : fields) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          field.setAccessible(<span class="hljs-literal">true</span>);<br>          field.set(destinationBean, field.get(sourceBean));<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-comment">// Nothing useful to do, will only fail on final fields, which will be ignored.</span><br>        &#125;<br>      &#125;<br>      parent = parent.getSuperclass();<br>    &#125;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PropertyNamer"><a href="#PropertyNamer" class="headerlink" title="PropertyNamer"></a>PropertyNamer</h4><p>â€‹ å±æ€§å‘½åå™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PropertyNamer</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">PropertyNamer</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Prevent Instantiation of Static Class</span><br>  &#125;<br><br>  <span class="hljs-comment">// æ–¹æ³•è½¬ä¸ºå±æ€§</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">methodToProperty</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-comment">// å»æ‰get|set|is</span><br>    <span class="hljs-keyword">if</span> (name.startsWith(<span class="hljs-string">&quot;is&quot;</span>)) &#123;<br>      name = name.substring(<span class="hljs-number">2</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (name.startsWith(<span class="hljs-string">&quot;get&quot;</span>) || name.startsWith(<span class="hljs-string">&quot;set&quot;</span>)) &#123;<br>      name = name.substring(<span class="hljs-number">3</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;Error parsing property name &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27;.  Didn&#x27;t start with &#x27;is&#x27;, &#x27;get&#x27; or &#x27;set&#x27;.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// å¦‚æœåªæœ‰1ä¸ªå­—æ¯--&gt;è½¬ä¸ºå°å†™</span><br>    <span class="hljs-comment">// å¦‚æœå¤§äº1ä¸ªå­—æ¯ï¼Œç¬¬äºŒä¸ªå­—æ¯éå¤§å†™--&gt;å°†ç¬¬ä¸€ä¸ªå­—æ¯è½¬ä¸ºå°å†™</span><br>    <span class="hljs-comment">// String uRL --&gt;String getuRL()</span><br>    <span class="hljs-keyword">if</span> (name.length() == <span class="hljs-number">1</span> || (name.length() &gt; <span class="hljs-number">1</span> &amp;&amp; !Character.isUpperCase(name.charAt(<span class="hljs-number">1</span>)))) &#123;<br>      name = name.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>).toLowerCase(Locale.ENGLISH) + name.substring(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> name;<br>  &#125;<br><br>  <span class="hljs-comment">// æ˜¯å¦æ˜¯å±æ€§</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProperty</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-comment">// å¿…é¡»ä»¥get|set|iså¼€å¤´</span><br>    <span class="hljs-keyword">return</span> name.startsWith(<span class="hljs-string">&quot;get&quot;</span>) || name.startsWith(<span class="hljs-string">&quot;set&quot;</span>) || name.startsWith(<span class="hljs-string">&quot;is&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// æ˜¯å¦æ˜¯getter</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isGetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> name.startsWith(<span class="hljs-string">&quot;get&quot;</span>) || name.startsWith(<span class="hljs-string">&quot;is&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// æ˜¯å¦æ˜¯setter</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> name.startsWith(<span class="hljs-string">&quot;set&quot;</span>);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PropertyTokenizer"><a href="#PropertyTokenizer" class="headerlink" title="PropertyTokenizer"></a>PropertyTokenizer</h4><p>â€‹ ç”¨äºå±æ€§è§£æï¼Œå¦‚ <code>person[0].birthdate.year</code> å°†ä¾æ¬¡è§£æä¸ºperson[0]ã€birthdateã€year</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PropertyTokenizer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Iterable</span>&lt;PropertyTokenizer&gt;, Iterator&lt;PropertyTokenizer&gt; &#123;<br><br>  <span class="hljs-comment">// ä¾‹å­ï¼š person[0].birthdate.year</span><br>  <span class="hljs-keyword">private</span> String name; <span class="hljs-comment">//person</span><br>  <span class="hljs-keyword">private</span> String indexedName; <span class="hljs-comment">//person[0]</span><br>  <span class="hljs-keyword">private</span> String index; <span class="hljs-comment">//0</span><br>  <span class="hljs-keyword">private</span> String children; <span class="hljs-comment">//birthdate.year </span><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PropertyTokenizer</span><span class="hljs-params">(String fullname)</span> &#123;<br>    <span class="hljs-comment">// person[0].birthdate.year</span><br>    <span class="hljs-comment">// æ‰¾.</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">delim</span> <span class="hljs-operator">=</span> fullname.indexOf(<span class="hljs-string">&#x27;.&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (delim &gt; -<span class="hljs-number">1</span>) &#123;<br>      name = fullname.substring(<span class="hljs-number">0</span>, delim);<br>      children = fullname.substring(delim + <span class="hljs-number">1</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// æ‰¾ä¸åˆ°.çš„è¯ï¼Œå–å…¨éƒ¨éƒ¨åˆ†</span><br>      name = fullname;<br>      children = <span class="hljs-literal">null</span>;<br>    &#125;<br>    indexedName = name;<br>    <span class="hljs-comment">// æŠŠä¸­æ‹¬å·é‡Œçš„æ•°å­—ç»™è§£æå‡ºæ¥</span><br>    delim = name.indexOf(<span class="hljs-string">&#x27;[&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (delim &gt; -<span class="hljs-number">1</span>) &#123;<br>      index = name.substring(delim + <span class="hljs-number">1</span>, name.length() - <span class="hljs-number">1</span>);<br>      name = name.substring(<span class="hljs-number">0</span>, delim);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> name;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIndex</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> index;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIndexedName</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> indexedName;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getChildren</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> children;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// ä½¿ç”¨çš„æ—¶å€™ hasNext() å’Œ next() é…åˆä½¿ç”¨ï¼Œ</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasNext</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> children != <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// å–å¾—ä¸‹ä¸€ä¸ª,é€šè¿‡childrenæ¥newä¸€ä¸ªæ–°çš„PropertyTokenizerå®ä¾‹</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> PropertyTokenizer <span class="hljs-title function_">next</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(children);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">&quot;Remove is not supported, as it has no meaning in the context of properties.&quot;</span>);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Iterator&lt;PropertyTokenizer&gt; <span class="hljs-title function_">iterator</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Reflector"><a href="#Reflector" class="headerlink" title="Reflector"></a>Reflector</h4><p>â€‹ åå°„å™¨ï¼Œè§£æç±»çš„setã€getæ–¹æ³•ä»¥åŠå¯¹åº”çš„å±æ€§å’Œè¿”å›ç±»å‹ï¼Œè€Œä¸”åŠ äº†ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Reflector</span> &#123; <br>    <span class="hljs-comment">// é»˜è®¤æ”¯æŒ ç±»-&gt;Reflector ç¼“å­˜</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">classCacheEnabled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] EMPTY_STRING_ARRAY = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>];<br>  <span class="hljs-comment">// è¿™é‡Œç”¨ConcurrentHashMapï¼Œå¤šçº¿ç¨‹æ”¯æŒï¼Œä½œä¸ºä¸€ä¸ªç¼“å­˜</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Reflector&gt; REFLECTOR_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;Class&lt;?&gt;, Reflector&gt;();<br><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; type;<br><br>  <span class="hljs-comment">// getterçš„å±æ€§åˆ—è¡¨</span><br>  <span class="hljs-keyword">private</span> String[] readablePropertyNames = EMPTY_STRING_ARRAY;<br>  <span class="hljs-comment">// setterçš„å±æ€§åˆ—è¡¨</span><br>  <span class="hljs-keyword">private</span> String[] writeablePropertyNames = EMPTY_STRING_ARRAY;<br>  <span class="hljs-comment">// setterçš„æ–¹æ³•åˆ—è¡¨</span><br>  <span class="hljs-keyword">private</span> Map&lt;String, Invoker&gt; setMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Invoker&gt;();<br>  <span class="hljs-comment">// getterçš„æ–¹æ³•åˆ—è¡¨</span><br>  <span class="hljs-keyword">private</span> Map&lt;String, Invoker&gt; getMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Invoker&gt;();<br>  <span class="hljs-comment">// setterçš„ç±»å‹åˆ—è¡¨</span><br>  <span class="hljs-keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; setTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Class&lt;?&gt;&gt;();<br>  <span class="hljs-comment">// getterçš„ç±»å‹åˆ—è¡¨</span><br>  <span class="hljs-keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; getTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Class&lt;?&gt;&gt;();<br>  <span class="hljs-comment">// æ„é€ å‡½æ•°</span><br>  <span class="hljs-keyword">private</span> Constructor&lt;?&gt; defaultConstructor;  <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">Reflector</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> &#123;<br>    type = clazz;<br>    <span class="hljs-comment">// åŠ å…¥æ„é€ å‡½æ•°</span><br>    addDefaultConstructor(clazz);<br>    <span class="hljs-comment">// åŠ å…¥getter</span><br>    addGetMethods(clazz);<br>    <span class="hljs-comment">// åŠ å…¥setter</span><br>    addSetMethods(clazz);<br>    <span class="hljs-comment">// åŠ å…¥å­—æ®µ</span><br>    addFields(clazz);<br>    readablePropertyNames = getMethods.keySet().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[getMethods.keySet().size()]);<br>    writeablePropertyNames = setMethods.keySet().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[setMethods.keySet().size()]);<br>    <span class="hljs-keyword">for</span> (String propName : readablePropertyNames) &#123;<br>      <span class="hljs-comment">// è¿™é‡Œä¸ºäº†èƒ½æ‰¾åˆ°æŸä¸€ä¸ªå±æ€§ï¼Œå°±æŠŠä»–å˜æˆå¤§å†™ä½œä¸ºmapçš„keyã€‚ã€‚ã€‚</span><br>      caseInsensitivePropertyMap.put(propName.toUpperCase(Locale.ENGLISH), propName);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (String propName : writeablePropertyNames) &#123;<br>      caseInsensitivePropertyMap.put(propName.toUpperCase(Locale.ENGLISH), propName);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// </span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">canAccessPrivateMethods</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å¦‚æœå½“å‰åº”ç”¨ç¨‹åºåˆ›å»ºäº†SecurityManagerï¼Œåˆ™è¿”å›ï¼Œå¦åˆ™è¿”å›null</span><br>      <span class="hljs-type">SecurityManager</span> <span class="hljs-variable">securityManager</span> <span class="hljs-operator">=</span> System.getSecurityManager();<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != securityManager) &#123;<br>        <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦æœ‰åä¸º suppressAccessChecks çš„ ReflectPermission</span><br>        <span class="hljs-comment">// suppressAccessChecksï¼šèƒ½å¤ŸæŠ‘åˆ¶å¯¹ç±»ä¸­å­—æ®µå’Œæ–¹æ³•çš„æ ‡å‡†Javaè¯­è¨€è®¿é—®æ£€æŸ¥ï¼›</span><br>        <span class="hljs-comment">// ä¸ä»…å…è®¸è®¿é—®å…¬å…±æˆå‘˜ï¼Œè€Œä¸”è¿˜å…è®¸è®¿é—®é»˜è®¤ï¼ˆåŒ…ï¼‰è®¿é—®ã€å—ä¿æŠ¤å’Œç§æœ‰æˆå‘˜ã€‚</span><br>        securityManager.checkPermission(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectPermission</span>(<span class="hljs-string">&quot;suppressAccessChecks&quot;</span>));<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// æ·»åŠ å¯è®¿é—®çš„æ— å‚æ„é€ å‡½æ•°</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addDefaultConstructor</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> &#123;<br>    Constructor&lt;?&gt;[] consts = clazz.getDeclaredConstructors();<br>    <span class="hljs-keyword">for</span> (Constructor&lt;?&gt; constructor : consts) &#123;<br>      <span class="hljs-keyword">if</span> (constructor.getParameterTypes().length == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (canAccessPrivateMethods()) &#123;<br>          <span class="hljs-keyword">try</span> &#123;<br>            constructor.setAccessible(<span class="hljs-literal">true</span>);<br>          &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// Ignored. This is only a final precaution, nothing we can do.</span><br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (constructor.isAccessible()) &#123;<br>          <span class="hljs-built_in">this</span>.defaultConstructor = constructor;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addGetMethods</span><span class="hljs-params">(Class&lt;?&gt; cls)</span> &#123;<br>    Map&lt;String, List&lt;Method&gt;&gt; conflictingGetters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, List&lt;Method&gt;&gt;();<br>    <span class="hljs-comment">// è¿™é‡Œgetterå’Œsetteréƒ½è°ƒç”¨äº†getClassMethodsï¼Œæœ‰ç‚¹æµªè´¹æ•ˆç‡äº†ã€‚</span><br>    <span class="hljs-comment">// ä¸å¦¨æŠŠaddGetMethods,addSetMethodsåˆå¹¶æˆä¸€ä¸ªæ–¹æ³•å«addMethods</span><br>    Method[] methods = getClassMethods(cls);<br>    <span class="hljs-keyword">for</span> (Method method : methods) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> method.getName();<br>      <span class="hljs-keyword">if</span> (name.startsWith(<span class="hljs-string">&quot;get&quot;</span>) &amp;&amp; name.length() &gt; <span class="hljs-number">3</span>) &#123;<br>        <span class="hljs-keyword">if</span> (method.getParameterTypes().length == <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-comment">// è¿™é‡Œæ–¹æ³•è½¬å±æ€§æ—¶å¯èƒ½ä¼šå°†å±æ€§çš„ç¬¬ä¸€ä¸ªå­—æ¯è½¬ä¸ºå°å†™ï¼Œ</span><br>          <span class="hljs-comment">// å› æ­¤ä¸è§„èŒƒçš„å±æ€§å‘½åä¼šé€ æˆå°†ä¸¤ä¸ªä¸ç›¸å…³çš„å±æ€§åœ¨ä¸€èµ·åˆ¤æ–­å†²çªï¼Œ</span><br>          <span class="hljs-comment">// è¿›è€Œåœ¨ resolveGetterConflicts ä¸­æŠ›å‡º ReflectionException</span><br>          name = PropertyNamer.methodToProperty(name);<br>          addMethodConflict(conflictingGetters, name, method);<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (name.startsWith(<span class="hljs-string">&quot;is&quot;</span>) &amp;&amp; name.length() &gt; <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-keyword">if</span> (method.getParameterTypes().length == <span class="hljs-number">0</span>) &#123;<br>          name = PropertyNamer.methodToProperty(name);<br>          addMethodConflict(conflictingGetters, name, method);<br>        &#125;<br>      &#125;<br>    &#125;<br>    resolveGetterConflicts(conflictingGetters);<br>  &#125;<br><br>  <span class="hljs-comment">// è·å–ç±»çš„æ‰€æœ‰æ–¹æ³•ã€å…¶å®ç°çš„æ¥å£çš„æ‰€æœ‰æ–¹æ³•ã€ä»¥åŠæ‰€æœ‰çˆ¶ç±»çš„ç›¸åº”æ–¹æ³•</span><br>  <span class="hljs-keyword">private</span> Method[]  getClassMethods(Class&lt;?&gt; cls) &#123;<br>    Map&lt;String, Method&gt; uniqueMethods = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Method&gt;();<br>    Class&lt;?&gt; currentClass = cls;<br>    <span class="hljs-keyword">while</span> (currentClass != <span class="hljs-literal">null</span>) &#123;<br>      addUniqueMethods(uniqueMethods, currentClass.getDeclaredMethods());<br><br>      <span class="hljs-comment">// we also need to look for interface methods - </span><br>      <span class="hljs-comment">// because the class may be abstract</span><br>      Class&lt;?&gt;[] interfaces = currentClass.getInterfaces();<br>      <span class="hljs-keyword">for</span> (Class&lt;?&gt; anInterface : interfaces) &#123;<br>        addUniqueMethods(uniqueMethods, anInterface.getMethods());<br>      &#125;<br><br>      currentClass = currentClass.getSuperclass();<br>    &#125;<br><br>    Collection&lt;Method&gt; methods = uniqueMethods.values();<br><br>    <span class="hljs-keyword">return</span> methods.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Method</span>[methods.size()]);<br>  &#125;<br><br>  <span class="hljs-comment">// æ·»åŠ æ–¹æ³•æ—¶é€šè¿‡ç­¾ååŒºåˆ«æ¯ä¸ªæ–¹æ³•ï¼Œå·²ç»æ·»åŠ äº†ç›¸åŒç­¾åçš„æ–¹æ³•å°±ä¸æ·»åŠ äº†</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUniqueMethods</span><span class="hljs-params">(Map&lt;String, Method&gt; uniqueMethods, Method[] methods)</span> &#123;<br>    <span class="hljs-keyword">for</span> (Method currentMethod : methods) &#123;<br>      <span class="hljs-keyword">if</span> (!currentMethod.isBridge()) &#123;<br>        <span class="hljs-comment">// è·å¾—æ–¹æ³•ç­¾å</span><br>        <span class="hljs-comment">// æ ¼å¼ä¸ºï¼šè¿”å›å€¼ç±»å‹#æ–¹æ³•å:å‚æ•°1ç±»å‹,å‚æ•°2ç±»å‹...</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> getSignature(currentMethod);<br>        <span class="hljs-comment">// check to see if the method is already known</span><br>        <span class="hljs-comment">// if it is known, then an extended class must have</span><br>        <span class="hljs-comment">// overridden a method</span><br>        <span class="hljs-keyword">if</span> (!uniqueMethods.containsKey(signature)) &#123;<br>          <span class="hljs-keyword">if</span> (canAccessPrivateMethods()) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>              currentMethod.setAccessible(<span class="hljs-literal">true</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>              <span class="hljs-comment">// Ignored. This is only a final precaution, nothing we can do.</span><br>            &#125;<br>          &#125;<br><br>          uniqueMethods.put(signature, currentMethod);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getSignature</span><span class="hljs-params">(Method method)</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    Class&lt;?&gt; returnType = method.getReturnType();<br>    <span class="hljs-keyword">if</span> (returnType != <span class="hljs-literal">null</span>) &#123;<br>      sb.append(returnType.getName()).append(<span class="hljs-string">&#x27;#&#x27;</span>);<br>    &#125;<br>    sb.append(method.getName());<br>    Class&lt;?&gt;[] parameters = method.getParameterTypes();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; parameters.length; i++) &#123;<br>      <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) &#123;<br>        sb.append(<span class="hljs-string">&#x27;:&#x27;</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        sb.append(<span class="hljs-string">&#x27;,&#x27;</span>);<br>      &#125;<br>      sb.append(parameters[i].getName());<br>    &#125;<br>    <span class="hljs-keyword">return</span> sb.toString();<br>  &#125;<br><br>  <span class="hljs-comment">// å°†æ‰€æœ‰å±æ€§-æ–¹æ³•é›†åˆæ”¾è¿›ä¸€ä¸ªmapä¸­ï¼Œç”¨äºåç»­å†²çªå¤„ç†</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addMethodConflict</span><span class="hljs-params">(Map&lt;String, List&lt;Method&gt;&gt; conflictingMethods, String name, Method method)</span> &#123;<br>    List&lt;Method&gt; list = conflictingMethods.get(name);<br>    <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span>) &#123;<br>      list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Method&gt;();<br>      conflictingMethods.put(name, list);<br>    &#125;<br>    list.add(method);<br>  &#125;<br><br>  <span class="hljs-comment">// å¤„ç†å†²çªï¼ˆä¸€ä¸ªå±æ€§å¯¹åº”å¤šä¸ªsetæ–¹æ³•ï¼Œåªå–ä¸€ä¸ªï¼‰</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolveGetterConflicts</span><span class="hljs-params">(Map&lt;String, List&lt;Method&gt;&gt; conflictingGetters)</span> &#123;<br>    <span class="hljs-keyword">for</span> (String propName : conflictingGetters.keySet()) &#123;<br>      List&lt;Method&gt; getters = conflictingGetters.get(propName);<br>      Iterator&lt;Method&gt; iterator = getters.iterator();<br>      <span class="hljs-type">Method</span> <span class="hljs-variable">firstMethod</span> <span class="hljs-operator">=</span> iterator.next();<br>      <span class="hljs-keyword">if</span> (getters.size() == <span class="hljs-number">1</span>) &#123;<br>        addGetMethod(propName, firstMethod);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">getter</span> <span class="hljs-operator">=</span> firstMethod;<br>        Class&lt;?&gt; getterType = firstMethod.getReturnType();<br>        <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>          <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> iterator.next();<br>          Class&lt;?&gt; methodType = method.getReturnType();<br>          <span class="hljs-comment">// 1 2 3 1 ï¼ˆ3 2 1 3ï¼‰----å‡è®¾æ•°å­—å¤§çš„æ˜¯æ•°å­—å°çš„çš„çˆ¶ç±»æˆ–çˆ¶æ¥å£</span><br>          <span class="hljs-keyword">if</span> (methodType.equals(getterType)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;Illegal overloaded getter method with ambiguous type for property &quot;</span> <br>                + propName + <span class="hljs-string">&quot; in class &quot;</span> + firstMethod.getDeclaringClass()<br>                + <span class="hljs-string">&quot;.  This breaks the JavaBeans &quot;</span> + <span class="hljs-string">&quot;specification and can cause unpredicatble results.&quot;</span>);<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (methodType.isAssignableFrom(getterType)) &#123;<br>            <span class="hljs-comment">// ä¸¤ä¸ªgetæ–¹æ³•çš„è¿”å›å€¼ç±»å‹å¦‚æœæœ‰çˆ¶å­å…³ç³»ï¼Œå–å­©å­</span><br>            <span class="hljs-comment">// å³å–çš„ç±»å‹èƒ½èµ‹å€¼ç»™å¦ä¸€ä¸ªç±»å‹</span><br>            <span class="hljs-comment">// OK getter type is descendant</span><br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (getterType.isAssignableFrom(methodType)) &#123;<br>            getter = method;<br>            getterType = methodType;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;Illegal overloaded getter method with ambiguous type for property &quot;</span> <br>                + propName + <span class="hljs-string">&quot; in class &quot;</span> + firstMethod.getDeclaringClass()<br>                + <span class="hljs-string">&quot;.  This breaks the JavaBeans &quot;</span> + <span class="hljs-string">&quot;specification and can cause unpredicatble results.&quot;</span>);<br>          &#125;<br>        &#125;<br>        addGetMethod(propName, getter);<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ·»åŠ getæ–¹æ³•å’Œç±»å‹æ˜ å°„</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addGetMethod</span><span class="hljs-params">(String name, Method method)</span> &#123;<br>    <span class="hljs-keyword">if</span> (isValidPropertyName(name)) &#123;<br>      getMethods.put(name, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodInvoker</span>(method));<br>      getTypes.put(name, method.getReturnType());<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ·»åŠ setæ–¹æ³•</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSetMethods</span><span class="hljs-params">(Class&lt;?&gt; cls)</span> &#123;<br>    Map&lt;String, List&lt;Method&gt;&gt; conflictingSetters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, List&lt;Method&gt;&gt;();<br>    Method[] methods = getClassMethods(cls);<br>    <span class="hljs-keyword">for</span> (Method method : methods) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> method.getName();<br>      <span class="hljs-keyword">if</span> (name.startsWith(<span class="hljs-string">&quot;set&quot;</span>) &amp;&amp; name.length() &gt; <span class="hljs-number">3</span>) &#123;<br>        <span class="hljs-keyword">if</span> (method.getParameterTypes().length == <span class="hljs-number">1</span>) &#123;<br>          name = PropertyNamer.methodToProperty(name);<br>          addMethodConflict(conflictingSetters, name, method);<br>        &#125;<br>      &#125;<br>    &#125;<br>    resolveSetterConflicts(conflictingSetters);<br>  &#125; <br><br>  <span class="hljs-comment">// SET æ–¹æ³• å‚æ•°ç±»å‹éœ€å’ŒGET æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ä¸€æ ·</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">resolveSetterConflicts</span><span class="hljs-params">(Map&lt;String, List&lt;Method&gt;&gt; conflictingSetters)</span> &#123;<br>    <span class="hljs-keyword">for</span> (String propName : conflictingSetters.keySet()) &#123;<br>      List&lt;Method&gt; setters = conflictingSetters.get(propName);<br>      <span class="hljs-type">Method</span> <span class="hljs-variable">firstMethod</span> <span class="hljs-operator">=</span> setters.get(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> (setters.size() == <span class="hljs-number">1</span>) &#123;<br>        addSetMethod(propName, firstMethod);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        Class&lt;?&gt; expectedType = getTypes.get(propName); <br>        <span class="hljs-comment">// setæ–¹æ³•å¿…é¡»è¦å¯¹åº”çš„getæ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (expectedType == <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;Illegal overloaded setter method with ambiguous type for property &quot;</span><br>              + propName + <span class="hljs-string">&quot; in class &quot;</span> + firstMethod.getDeclaringClass() + <span class="hljs-string">&quot;.  This breaks the JavaBeans &quot;</span> +<br>              <span class="hljs-string">&quot;specification and can cause unpredicatble results.&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          Iterator&lt;Method&gt; methods = setters.iterator();<br>          <span class="hljs-type">Method</span> <span class="hljs-variable">setter</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>; <br>          <span class="hljs-comment">// æ‰¾åˆ°å‚æ•°ç±»å‹å’Œgetæ–¹æ³•è¿”å›å€¼ç›¸åŒçš„getæ–¹æ³•å°±è¿”å›</span><br>          <span class="hljs-keyword">while</span> (methods.hasNext()) &#123;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> methods.next();<br>            <span class="hljs-keyword">if</span> (method.getParameterTypes().length == <span class="hljs-number">1</span><br>                &amp;&amp; expectedType.equals(method.getParameterTypes()[<span class="hljs-number">0</span>])) &#123;<br>              setter = method;<br>              <span class="hljs-keyword">break</span>;<br>            &#125;<br>          &#125;<br>          <span class="hljs-keyword">if</span> (setter == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;Illegal overloaded setter method with ambiguous type for property &quot;</span><br>                + propName + <span class="hljs-string">&quot; in class &quot;</span> + firstMethod.getDeclaringClass() + <span class="hljs-string">&quot;.  This breaks the JavaBeans &quot;</span> +<br>                <span class="hljs-string">&quot;specification and can cause unpredicatble results.&quot;</span>);<br>          &#125;<br>          addSetMethod(propName, setter);<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSetMethod</span><span class="hljs-params">(String name, Method method)</span> &#123;<br>    <span class="hljs-keyword">if</span> (isValidPropertyName(name)) &#123;<br>      setMethods.put(name, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodInvoker</span>(method));<br>      setTypes.put(name, method.getParameterTypes()[<span class="hljs-number">0</span>]);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ç»™publicå˜é‡å’Œæœ‰è®¿é—®æƒé™çš„privateå˜é‡ï¼Œæ·»åŠ setå’Œgetæ–¹æ³•ï¼ˆé€šè¿‡åå°„ï¼‰</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addFields</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> &#123;<br>    Field[] fields = clazz.getDeclaredFields();<br>    <span class="hljs-keyword">for</span> (Field field : fields) &#123;<br>      <span class="hljs-keyword">if</span> (canAccessPrivateMethods()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          field.setAccessible(<span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-comment">// Ignored. This is only a final precaution, nothing we can do.</span><br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (field.isAccessible()) &#123;<br>        <span class="hljs-keyword">if</span> (!setMethods.containsKey(field.getName())) &#123;<br>          <span class="hljs-comment">// issue #379 - removed the check for final because JDK 1.5 allows</span><br>          <span class="hljs-comment">// modification of final fields through reflection (JSR-133). (JGB)</span><br>          <span class="hljs-comment">// pr #16 - final static can only be set by the classloader</span><br>          <span class="hljs-type">int</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> field.getModifiers();<br>          <span class="hljs-keyword">if</span> (!(Modifier.isFinal(modifiers) &amp;&amp; Modifier.isStatic(modifiers))) &#123;<br>            addSetField(field);<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!getMethods.containsKey(field.getName())) &#123;<br>          addGetField(field);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (clazz.getSuperclass() != <span class="hljs-literal">null</span>) &#123;<br>      addFields(clazz.getSuperclass());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSetField</span><span class="hljs-params">(Field field)</span> &#123;<br>    <span class="hljs-keyword">if</span> (isValidPropertyName(field.getName())) &#123;<br>      setMethods.put(field.getName(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">SetFieldInvoker</span>(field));<br>      setTypes.put(field.getName(), field.getType());<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addGetField</span><span class="hljs-params">(Field field)</span> &#123;<br>    <span class="hljs-keyword">if</span> (isValidPropertyName(field.getName())) &#123;<br>      getMethods.put(field.getName(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetFieldInvoker</span>(field));<br>      getTypes.put(field.getName(), field.getType());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidPropertyName</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> !(name.startsWith(<span class="hljs-string">&quot;$&quot;</span>) || <span class="hljs-string">&quot;serialVersionUID&quot;</span>.equals(name) || <span class="hljs-string">&quot;class&quot;</span>.equals(name));<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getType() &#123;<br>    <span class="hljs-keyword">return</span> type;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Constructor&lt;?&gt; getDefaultConstructor() &#123;<br>    <span class="hljs-keyword">if</span> (defaultConstructor != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> defaultConstructor;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;There is no default constructor for &quot;</span> + type);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasDefaultConstructor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> defaultConstructor != <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// è¿™é‡Œå’Œä¸‹é¢çš„æ–¹æ³•ç”¨åˆ°çš„ propertyName åº”è¯¥é€šè¿‡ findPropertyName()æ–¹æ³• å¾—åˆ°</span><br>  <span class="hljs-keyword">public</span> Invoker <span class="hljs-title function_">getSetInvoker</span><span class="hljs-params">(String propertyName)</span> &#123;<br>    <span class="hljs-type">Invoker</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> setMethods.get(propertyName);<br>    <span class="hljs-keyword">if</span> (method == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;There is no setter for property named &#x27;&quot;</span> + propertyName + <span class="hljs-string">&quot;&#x27; in &#x27;&quot;</span> + type + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> method;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Invoker <span class="hljs-title function_">getGetInvoker</span><span class="hljs-params">(String propertyName)</span> &#123;<br>    <span class="hljs-type">Invoker</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> getMethods.get(propertyName);<br>    <span class="hljs-keyword">if</span> (method == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;There is no getter for property named &#x27;&quot;</span> + propertyName + <span class="hljs-string">&quot;&#x27; in &#x27;&quot;</span> + type + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> method;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getSetterType(String propertyName) &#123;<br>    Class&lt;?&gt; clazz = setTypes.get(propertyName);<br>    <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;There is no setter for property named &#x27;&quot;</span> + propertyName + <span class="hljs-string">&quot;&#x27; in &#x27;&quot;</span> + type + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> clazz;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getGetterType(String propertyName) &#123;<br>    Class&lt;?&gt; clazz = getTypes.get(propertyName);<br>    <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;There is no getter for property named &#x27;&quot;</span> + propertyName + <span class="hljs-string">&quot;&#x27; in &#x27;&quot;</span> + type + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> clazz;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String[] getGetablePropertyNames() &#123;<br>    <span class="hljs-keyword">return</span> readablePropertyNames;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String[] getSetablePropertyNames() &#123;<br>    <span class="hljs-keyword">return</span> writeablePropertyNames;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasSetter</span><span class="hljs-params">(String propertyName)</span> &#123;<br>    <span class="hljs-keyword">return</span> setMethods.keySet().contains(propertyName);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasGetter</span><span class="hljs-params">(String propertyName)</span> &#123;<br>    <span class="hljs-keyword">return</span> getMethods.keySet().contains(propertyName);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findPropertyName</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> caseInsensitivePropertyMap.get(name.toUpperCase(Locale.ENGLISH));<br>  &#125; <br><br>  <span class="hljs-comment">// è·å–clazzçš„åå°„å™¨ï¼Œæœ‰ç¼“å­˜</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Reflector <span class="hljs-title function_">forClass</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> &#123;<br>    <span class="hljs-keyword">if</span> (classCacheEnabled) &#123;<br>      <span class="hljs-comment">// synchronized (clazz) removed see issue #461</span><br>      <span class="hljs-comment">// å¯¹äºæ¯ä¸ªç±»æ¥è¯´ï¼Œæˆ‘ä»¬å‡è®¾å®ƒæ˜¯ä¸ä¼šå˜çš„ï¼Œè¿™æ ·å¯ä»¥è€ƒè™‘å°†è¿™ä¸ªç±»çš„ä¿¡æ¯(æ„é€ å‡½æ•°ï¼Œgetter,setter,å­—æ®µ)åŠ å…¥ç¼“å­˜ï¼Œä»¥æé«˜é€Ÿåº¦</span><br>      <span class="hljs-type">Reflector</span> <span class="hljs-variable">cached</span> <span class="hljs-operator">=</span> REFLECTOR_MAP.get(clazz);<br>      <span class="hljs-keyword">if</span> (cached == <span class="hljs-literal">null</span>) &#123;<br>        cached = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reflector</span>(clazz);<br>        REFLECTOR_MAP.put(clazz, cached);<br>      &#125;<br>      <span class="hljs-keyword">return</span> cached;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reflector</span>(clazz);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setClassCacheEnabled</span><span class="hljs-params">(<span class="hljs-type">boolean</span> classCacheEnabled)</span> &#123;<br>    Reflector.classCacheEnabled = classCacheEnabled;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isClassCacheEnabled</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> classCacheEnabled;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MetaClass"><a href="#MetaClass" class="headerlink" title="MetaClass"></a>MetaClass</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetaClass</span> &#123; <br><br>  <span class="hljs-comment">// æœ‰ä¸€ä¸ªåå°„å™¨</span><br>  <span class="hljs-comment">// å¯ä»¥çœ‹åˆ°æ–¹æ³•åŸºæœ¬éƒ½æ˜¯å†æ¬¡å§”æ´¾ç»™è¿™ä¸ªReflector</span><br>  <span class="hljs-keyword">private</span> Reflector reflector; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">MetaClass</span><span class="hljs-params">(Class&lt;?&gt; type)</span> &#123;<br>    <span class="hljs-built_in">this</span>.reflector = Reflector.forClass(type);<br>  &#125; <br><br>  <span class="hljs-comment">// å§”æ‰˜ç»™ Reflector.forClass å¾—åˆ° Reflector åå†å°è£…æˆ MetaClass </span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MetaClass <span class="hljs-title function_">forClass</span><span class="hljs-params">(Class&lt;?&gt; type)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MetaClass</span>(type);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isClassCacheEnabled</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> Reflector.isClassCacheEnabled();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setClassCacheEnabled</span><span class="hljs-params">(<span class="hljs-type">boolean</span> classCacheEnabled)</span> &#123;<br>    Reflector.setClassCacheEnabled(classCacheEnabled);<br>  &#125; <br><br>  <span class="hljs-comment">// è¿™é‡Œå¾—åˆ°æ­£ç¡®çš„ç»“æœä¾èµ– addFields()æ–¹æ³•ä¸­é€šè¿‡åå°„ä¸ºprivateå˜é‡æ·»åŠ getå’Œsetæ–¹æ³•</span><br>  <span class="hljs-comment">// å¦‚privateå˜é‡Fogå’ŒgetFogæ–¹æ³•åœ¨addGetMethodsæ—¶æ·»åŠ çš„æ˜¯fog-getFogçš„æ˜ å°„</span><br>  <span class="hljs-keyword">public</span> MetaClass <span class="hljs-title function_">metaClassForProperty</span><span class="hljs-params">(String name)</span> &#123; <br>    Class&lt;?&gt; propType = reflector.getGetterType(name);<br>    <span class="hljs-keyword">return</span> MetaClass.forClass(propType);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findProperty</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> buildProperty(name, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>());<br>    <span class="hljs-keyword">return</span> prop.length() &gt; <span class="hljs-number">0</span> ? prop.toString() : <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findProperty</span><span class="hljs-params">(String name, <span class="hljs-type">boolean</span> useCamelCaseMapping)</span> &#123;<br>    <span class="hljs-keyword">if</span> (useCamelCaseMapping) &#123;<br>      name = name.replace(<span class="hljs-string">&quot;_&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> findProperty(name);<br>  &#125; <br><br>  <span class="hljs-comment">// å¯¹äºå¤šçº§å±æ€§å¦‚ person.age é˜Ÿå…¶æ¯çº§å±æ€§è°ƒç”¨ reflector.findPropertyName</span><br>  <span class="hljs-comment">// ç„¶åå°†å…¶æ‹¼æ¥èµ·æ¥</span><br>  <span class="hljs-keyword">private</span> StringBuilder <span class="hljs-title function_">buildProperty</span><span class="hljs-params">(String name, StringBuilder builder)</span> &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> reflector.findPropertyName(prop.getName());<br>      <span class="hljs-keyword">if</span> (propertyName != <span class="hljs-literal">null</span>) &#123;<br>        builder.append(propertyName);<br>        builder.append(<span class="hljs-string">&quot;.&quot;</span>);<br>        <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaProp</span> <span class="hljs-operator">=</span> metaClassForProperty(propertyName);<br>        metaProp.buildProperty(prop.getChildren(), builder);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">propertyName</span> <span class="hljs-operator">=</span> reflector.findPropertyName(name);<br>      <span class="hljs-keyword">if</span> (propertyName != <span class="hljs-literal">null</span>) &#123;<br>        builder.append(propertyName);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> builder;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String[] getGetterNames() &#123;<br>    <span class="hljs-keyword">return</span> reflector.getGetablePropertyNames();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String[] getSetterNames() &#123;<br>    <span class="hljs-keyword">return</span> reflector.getSetablePropertyNames();<br>  &#125; <br><br>  <span class="hljs-comment">// è·å–setå‚æ•°çš„ç±»å‹</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getSetterType(String name) &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaProp</span> <span class="hljs-operator">=</span> metaClassForProperty(prop.getName()); <br>      <span class="hljs-comment">// è¿™é‡Œæ˜¯é€’å½’è°ƒç”¨</span><br>      <span class="hljs-keyword">return</span> metaProp.getSetterType(prop.getChildren());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> reflector.getSetterType(prop.getName());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getGetterType(String name) &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaProp</span> <span class="hljs-operator">=</span> metaClassForProperty(prop);<br>      <span class="hljs-keyword">return</span> metaProp.getGetterType(prop.getChildren());<br>    &#125;<br>    <span class="hljs-comment">// issue #506. Resolve the type inside a Collection Object</span><br>    <span class="hljs-keyword">return</span> getGetterType(prop);<br>  &#125;<br><br>  <span class="hljs-comment">// æ ¹æ®PropertyTokenizeræ„é€ MetaClass</span><br>  <span class="hljs-keyword">private</span> MetaClass <span class="hljs-title function_">metaClassForProperty</span><span class="hljs-params">(PropertyTokenizer prop)</span> &#123;<br>    Class&lt;?&gt; propType = getGetterType(prop);<br>    <span class="hljs-keyword">return</span> MetaClass.forClass(propType);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; getGetterType(PropertyTokenizer prop) &#123;<br>    Class&lt;?&gt; type = reflector.getGetterType(prop.getName());<br>    <span class="hljs-keyword">if</span> (prop.getIndex() != <span class="hljs-literal">null</span> &amp;&amp; Collection.class.isAssignableFrom(type)) &#123;<br>      <span class="hljs-type">Type</span> <span class="hljs-variable">returnType</span> <span class="hljs-operator">=</span> getGenericGetterType(prop.getName());<br>      <span class="hljs-keyword">if</span> (returnType <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>        Type[] actualTypeArguments = ((ParameterizedType) returnType).getActualTypeArguments();<br>        <span class="hljs-keyword">if</span> (actualTypeArguments != <span class="hljs-literal">null</span> &amp;&amp; actualTypeArguments.length == <span class="hljs-number">1</span>) &#123;<br>          returnType = actualTypeArguments[<span class="hljs-number">0</span>];<br>          <span class="hljs-keyword">if</span> (returnType <span class="hljs-keyword">instanceof</span> Class) &#123;<br>            type = (Class&lt;?&gt;) returnType;<br>          &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (returnType <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>            type = (Class&lt;?&gt;) ((ParameterizedType) returnType).getRawType();<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> type;<br>  &#125; <br><br>  <span class="hljs-comment">// è·å–getæ–¹æ³•è¿”å›å€¼çš„ Type ç±»å‹</span><br>  <span class="hljs-keyword">private</span> Type <span class="hljs-title function_">getGenericGetterType</span><span class="hljs-params">(String propertyName)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">Invoker</span> <span class="hljs-variable">invoker</span> <span class="hljs-operator">=</span> reflector.getGetInvoker(propertyName);<br>      <span class="hljs-keyword">if</span> (invoker <span class="hljs-keyword">instanceof</span> MethodInvoker) &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">_method</span> <span class="hljs-operator">=</span> MethodInvoker.class.getDeclaredField(<span class="hljs-string">&quot;method&quot;</span>);<br>        _method.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> (Method) _method.get(invoker);<br>        <span class="hljs-keyword">return</span> method.getGenericReturnType();<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (invoker <span class="hljs-keyword">instanceof</span> GetFieldInvoker) &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">_field</span> <span class="hljs-operator">=</span> GetFieldInvoker.class.getDeclaredField(<span class="hljs-string">&quot;field&quot;</span>);<br>        _field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> (Field) _field.get(invoker);<br>        <span class="hljs-keyword">return</span> field.getGenericType();<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasSetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-keyword">if</span> (reflector.hasSetter(prop.getName())) &#123;<br>        <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaProp</span> <span class="hljs-operator">=</span> metaClassForProperty(prop.getName());<br>        <span class="hljs-keyword">return</span> metaProp.hasSetter(prop.getChildren());<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> reflector.hasSetter(prop.getName());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasGetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-keyword">if</span> (reflector.hasGetter(prop.getName())) &#123;<br>        <span class="hljs-type">MetaClass</span> <span class="hljs-variable">metaProp</span> <span class="hljs-operator">=</span> metaClassForProperty(prop);<br>        <span class="hljs-keyword">return</span> metaProp.hasGetter(prop.getChildren());<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> reflector.hasGetter(prop.getName());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Invoker <span class="hljs-title function_">getGetInvoker</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> reflector.getGetInvoker(name);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Invoker <span class="hljs-title function_">getSetInvoker</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> reflector.getSetInvoker(name);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasDefaultConstructor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> reflector.hasDefaultConstructor();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MetaObject"><a href="#MetaObject" class="headerlink" title="MetaObject"></a>MetaObject</h4><p>å…ƒå¯¹è±¡ï¼Œå°è£…getå’Œsetæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetaObject</span> &#123; <br>  <span class="hljs-comment">// æœ‰ä¸€ä¸ªå°è£…çš„å¯¹è±¡æœ¬èº«ï¼Œå¯¹è±¡åŒ…è£…å™¨ï¼Œå¯¹è±¡å·¥å‚ï¼Œå¯¹è±¡åŒ…è£…å™¨å·¥å‚</span><br>  <span class="hljs-keyword">private</span> Object originalObject;<br>  <span class="hljs-keyword">private</span> ObjectWrapper objectWrapper;<br>  <span class="hljs-keyword">private</span> ObjectFactory objectFactory;<br>  <span class="hljs-keyword">private</span> ObjectWrapperFactory objectWrapperFactory; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">MetaObject</span><span class="hljs-params">(Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory)</span> &#123;<br>    <span class="hljs-built_in">this</span>.originalObject = object;<br>    <span class="hljs-built_in">this</span>.objectFactory = objectFactory;<br>    <span class="hljs-built_in">this</span>.objectWrapperFactory = objectWrapperFactory;<br><br>    <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> ObjectWrapper) &#123;<br>      <span class="hljs-comment">// å¦‚æœå¯¹è±¡æœ¬èº«å·²ç»æ˜¯ObjectWrapperå‹ï¼Œåˆ™ç›´æ¥èµ‹ç»™objectWrapper</span><br>      <span class="hljs-built_in">this</span>.objectWrapper = (ObjectWrapper) object;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (objectWrapperFactory.hasWrapperFor(object)) &#123;<br>      <span class="hljs-comment">// å¦‚æœæœ‰åŒ…è£…å™¨,è°ƒç”¨ObjectWrapperFactory.getWrapperFor</span><br>      <span class="hljs-built_in">this</span>.objectWrapper = objectWrapperFactory.getWrapperFor(<span class="hljs-built_in">this</span>, object);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> Map) &#123;<br>      <span class="hljs-comment">// å¦‚æœæ˜¯Mapå‹ï¼Œè¿”å›MapWrapper</span><br>      <span class="hljs-built_in">this</span>.objectWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapWrapper</span>(<span class="hljs-built_in">this</span>, (Map) object);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (object <span class="hljs-keyword">instanceof</span> Collection) &#123;<br>      <span class="hljs-comment">// å¦‚æœæ˜¯Collectionå‹ï¼Œè¿”å›CollectionWrapper</span><br>      <span class="hljs-built_in">this</span>.objectWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CollectionWrapper</span>(<span class="hljs-built_in">this</span>, (Collection) object);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// é™¤æ­¤ä»¥å¤–ï¼Œè¿”å›BeanWrapper</span><br>      <span class="hljs-built_in">this</span>.objectWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanWrapper</span>(<span class="hljs-built_in">this</span>, object);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MetaObject <span class="hljs-title function_">forObject</span><span class="hljs-params">(Object object, ObjectFactory objectFactory, ObjectWrapperFactory objectWrapperFactory)</span> &#123;<br>    <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// å¤„ç†ä¸€ä¸‹null,å°†nullåŒ…è£…èµ·æ¥</span><br>      <span class="hljs-keyword">return</span> SystemMetaObject.NULL_META_OBJECT;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MetaObject</span>(object, objectFactory, objectWrapperFactory);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ObjectFactory <span class="hljs-title function_">getObjectFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> objectFactory;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ObjectWrapperFactory <span class="hljs-title function_">getObjectWrapperFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> objectWrapperFactory;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getOriginalObject</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> originalObject;<br>  &#125; <br><br>  <span class="hljs-comment">//--------ä»¥ä¸‹æ–¹æ³•éƒ½æ˜¯å§”æ´¾ç»™ObjectWrapper------</span><br>  <span class="hljs-comment">// æŸ¥æ‰¾å±æ€§</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findProperty</span><span class="hljs-params">(String propName, <span class="hljs-type">boolean</span> useCamelCaseMapping)</span> &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper.findProperty(propName, useCamelCaseMapping);<br>  &#125; <br><br>  <span class="hljs-comment">// å–å¾—getterçš„åå­—åˆ—è¡¨</span><br>  <span class="hljs-keyword">public</span> String[] getGetterNames() &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper.getGetterNames();<br>  &#125;<br><br>  <span class="hljs-comment">// å–å¾—setterçš„åå­—åˆ—è¡¨</span><br>  <span class="hljs-keyword">public</span> String[] getSetterNames() &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper.getSetterNames();<br>  &#125; <br><br>  <span class="hljs-comment">// å–å¾—setterçš„ç±»å‹åˆ—è¡¨</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getSetterType(String name) &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper.getSetterType(name);<br>  &#125;<br><br>  <span class="hljs-comment">// å–å¾—getterçš„ç±»å‹åˆ—è¡¨</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getGetterType(String name) &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper.getGetterType(name);<br>  &#125; <br><br>  <span class="hljs-comment">// æ˜¯å¦æœ‰æŒ‡å®šçš„setter</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasSetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper.hasSetter(name);<br>  &#125;<br><br>  <span class="hljs-comment">// æ˜¯å¦æœ‰æŒ‡å®šçš„getter</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasGetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper.hasGetter(name);<br>  &#125; <br><br>  <span class="hljs-comment">// æ˜¯å¦æœ‰æŒ‡å®šçš„setter</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasSetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper.hasSetter(name);<br>  &#125;<br><br>  <span class="hljs-comment">// æ˜¯å¦æœ‰æŒ‡å®šçš„getter</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasGetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper.hasGetter(name);<br>  &#125; <br><br>  <span class="hljs-comment">// å–å¾—å€¼</span><br>  <span class="hljs-comment">// å¦‚person[0].birthdate.year</span><br>  <span class="hljs-comment">// å…·ä½“æµ‹è¯•ç”¨ä¾‹å¯ä»¥çœ‹MetaObjectTest</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaValue</span> <span class="hljs-operator">=</span> metaObjectForProperty(prop.getIndexedName());<br>      <span class="hljs-keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;<br>        <span class="hljs-comment">// å¦‚æœä¸Šå±‚å°±æ˜¯nulläº†ï¼Œé‚£å°±ç»“æŸï¼Œè¿”å›null</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¦åˆ™ç»§ç»­çœ‹ä¸‹ä¸€å±‚ï¼Œé€’å½’è°ƒç”¨getValue</span><br>       <span class="hljs-keyword">return</span> metaValue.getValue(prop.getChildren());<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> objectWrapper.get(prop);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ä¸ºæŸä¸ªå±æ€§ç”Ÿæˆå…ƒå¯¹è±¡</span><br>  <span class="hljs-keyword">public</span> MetaObject <span class="hljs-title function_">metaObjectForProperty</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-comment">// è¿™é‡Œçš„getValueæ˜¯é€’å½’è°ƒç”¨ï¼Œä½†æ˜¯ç”±äºç”±nameåŒ…è£…æˆçš„PropertyTokenizer</span><br>    <span class="hljs-comment">// æ²¡æœ‰childrenï¼Œæ‰€ä»¥ä¼šè°ƒç”¨ objectWrapper.get(prop); è·å–å¯¹åº”çš„å±æ€§</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getValue(name);<br>    <span class="hljs-keyword">return</span> MetaObject.forObject(value, objectFactory, objectWrapperFactory);<br>  &#125; <br><br>  <span class="hljs-comment">// è®¾ç½®å€¼</span><br>  <span class="hljs-comment">// å¦‚person[0].birthdate.year</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setValue</span><span class="hljs-params">(String name, Object value)</span> &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaValue</span> <span class="hljs-operator">=</span> metaObjectForProperty(prop.getIndexedName());<br>      <span class="hljs-keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123; <br>        <span class="hljs-comment">// è¿™é‡Œçš„ prop.getChildren() != null åˆ¤æ–­ä¼¼ä¹ä¸éœ€è¦</span><br>        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span> &amp;&amp; prop.getChildren() != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-comment">// don&#x27;t instantiate child path if value is null</span><br>          <span class="hljs-comment">// å¦‚æœä¸Šå±‚å°±æ˜¯nulläº†ï¼Œè¿˜å¾—çœ‹æœ‰æ²¡æœ‰å„¿å­ï¼Œæ²¡æœ‰é‚£å°±ç»“æŸ</span><br>          <span class="hljs-keyword">return</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// å¦åˆ™è¿˜å¾—newä¸€ä¸ªï¼Œå§”æ´¾ç»™ObjectWrapper.instantiatePropertyValue</span><br>          metaValue = objectWrapper.instantiatePropertyValue(name, prop, objectFactory);<br>        &#125;<br>      &#125;<br>      <span class="hljs-comment">// é€’å½’è°ƒç”¨setValue</span><br>      metaValue.setValue(prop.getChildren(), value);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// åˆ°äº†æœ€åä¸€å±‚äº†ï¼Œæ‰€ä»¥å§”æ´¾ç»™ObjectWrapper.set</span><br>      objectWrapper.set(prop, value);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> ObjectWrapper <span class="hljs-title function_">getObjectWrapper</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper;<br>  &#125; <br><br>  <span class="hljs-comment">// æ˜¯å¦æ˜¯é›†åˆ</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCollection</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> objectWrapper.isCollection();<br>  &#125; <br><br>  <span class="hljs-comment">// æ·»åŠ å±æ€§</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Object element)</span> &#123;<br>    objectWrapper.add(element);<br>  &#125;<br><br>  <span class="hljs-comment">// æ·»åŠ å±æ€§</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAll</span><span class="hljs-params">(List&lt;E&gt; list)</span> &#123;<br>    objectWrapper.addAll(list);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SystemMetaObject"><a href="#SystemMetaObject" class="headerlink" title="SystemMetaObject"></a>SystemMetaObject</h4><p>ä¸€äº›ç³»ç»Ÿçº§åˆ«çš„å…ƒå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemMetaObject</span> &#123; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectFactory</span> <span class="hljs-variable">DEFAULT_OBJECT_FACTORY</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultObjectFactory</span>();<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectWrapperFactory</span> <span class="hljs-variable">DEFAULT_OBJECT_WRAPPER_FACTORY</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultObjectWrapperFactory</span>();<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MetaObject</span> <span class="hljs-variable">NULL_META_OBJECT</span> <span class="hljs-operator">=</span> MetaObject.forObject(NullObject.class, DEFAULT_OBJECT_FACTORY, DEFAULT_OBJECT_WRAPPER_FACTORY); <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">SystemMetaObject</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Prevent Instantiation of Static Class</span><br>  &#125; <br><br>  <span class="hljs-comment">// ç©ºå¯¹è±¡</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NullObject</span> &#123;<br>  &#125; <br><br>  <span class="hljs-comment">// ä½¿ç”¨é»˜è®¤çš„å¯¹è±¡å·¥å‚å’Œå¯¹è±¡åŒ…è£…å™¨å·¥å‚å®ä¾‹åŒ–å…ƒå¯¹è±¡</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> MetaObject <span class="hljs-title function_">forObject</span><span class="hljs-params">(Object object)</span> &#123;<br>    <span class="hljs-keyword">return</span> MetaObject.forObject(object, DEFAULT_OBJECT_FACTORY, DEFAULT_OBJECT_WRAPPER_FACTORY);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ObjectWrapper"><a href="#ObjectWrapper" class="headerlink" title="ObjectWrapper"></a>ObjectWrapper</h4><p>å¯¹è±¡åŒ…è£…å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ObjectWrapper</span> &#123; <br><br>  <span class="hljs-comment">// è·å–å±æ€§å¯¹åº”çš„å€¼</span><br>  Object <span class="hljs-title function_">get</span><span class="hljs-params">(PropertyTokenizer prop)</span>;<br><br>  <span class="hljs-comment">// è®¾ç½®å±æ€§å¯¹åº”çš„å€¼</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(PropertyTokenizer prop, Object value)</span>; <br><br>  <span class="hljs-comment">// æŸ¥æ‰¾å±æ€§</span><br>  String <span class="hljs-title function_">findProperty</span><span class="hljs-params">(String name, <span class="hljs-type">boolean</span> useCamelCaseMapping)</span>; <br><br>  <span class="hljs-comment">// å–å¾—getterçš„åå­—åˆ—è¡¨</span><br>  String[] getGetterNames();<br><br>  <span class="hljs-comment">// å–å¾—setterçš„åå­—åˆ—è¡¨</span><br>  String[] getSetterNames();<br><br>  <span class="hljs-comment">// å–å¾—setterçš„ç±»å‹</span><br>  Class&lt;?&gt; getSetterType(String name);<br><br>  <span class="hljs-comment">// å–å¾—getterçš„ç±»å‹</span><br>  Class&lt;?&gt; getGetterType(String name); <br><br>  <span class="hljs-comment">// æ˜¯å¦æœ‰æŒ‡å®šçš„setter</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasSetter</span><span class="hljs-params">(String name)</span>;<br><br>  <span class="hljs-comment">// æ˜¯å¦æœ‰æŒ‡å®šçš„getter</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasGetter</span><span class="hljs-params">(String name)</span>; <br><br>  <span class="hljs-comment">// å®ä¾‹åŒ–å±æ€§</span><br>  MetaObject <span class="hljs-title function_">instantiatePropertyValue</span><span class="hljs-params">(String name, PropertyTokenizer prop, ObjectFactory objectFactory)</span>; <br><br>  <span class="hljs-comment">// æ˜¯å¦æ˜¯é›†åˆ</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCollection</span><span class="hljs-params">()</span>;<br>  <br>  <span class="hljs-comment">// æ·»åŠ å±æ€§</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Object element)</span>;<br>  <br>  <span class="hljs-comment">// æ·»åŠ å±æ€§</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAll</span><span class="hljs-params">(List&lt;E&gt; element)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BaseWrapper"><a href="#BaseWrapper" class="headerlink" title="BaseWrapper"></a>BaseWrapper</h4><p>å¯¹è±¡åŒ…è£…å™¨çš„åŸºç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseWrapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectWrapper</span> &#123; <br><br>  <span class="hljs-comment">// æä¾›äº†ä¸€äº›utilæ–¹æ³•</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object[] NO_ARGUMENTS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">protected</span> MetaObject metaObject; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">BaseWrapper</span><span class="hljs-params">(MetaObject metaObject)</span> &#123;<br>    <span class="hljs-built_in">this</span>.metaObject = metaObject;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æé›†åˆ</span><br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">resolveCollection</span><span class="hljs-params">(PropertyTokenizer prop, Object object)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;&quot;</span>.equals(prop.getName())) &#123;<br>      <span class="hljs-keyword">return</span> object;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> metaObject.getValue(prop.getName());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å–é›†åˆçš„å€¼</span><br>  <span class="hljs-comment">// ä¸­æ‹¬å·æœ‰2ä¸ªæ„æ€ï¼Œä¸€ä¸ªæ˜¯Mapï¼Œä¸€ä¸ªæ˜¯Listæˆ–æ•°ç»„</span><br>  <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getCollectionValue</span><span class="hljs-params">(PropertyTokenizer prop, Object collection)</span> &#123;<br>    <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> Map) &#123;<br>      <span class="hljs-comment">// map[&#x27;name&#x27;]</span><br>      <span class="hljs-keyword">return</span> ((Map) collection).get(prop.getIndex());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> Integer.parseInt(prop.getIndex());<br>      <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> List) &#123;<br>        <span class="hljs-comment">// list[0]</span><br>        <span class="hljs-keyword">return</span> ((List) collection).get(i);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> Object[]) &#123;<br>        <span class="hljs-keyword">return</span> ((Object[]) collection)[i];<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">char</span>[]) &#123;<br>        <span class="hljs-keyword">return</span> ((<span class="hljs-type">char</span>[]) collection)[i];<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">boolean</span>[]) &#123;<br>        <span class="hljs-keyword">return</span> ((<span class="hljs-type">boolean</span>[]) collection)[i];<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">byte</span>[]) &#123;<br>        <span class="hljs-keyword">return</span> ((<span class="hljs-type">byte</span>[]) collection)[i];<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">double</span>[]) &#123;<br>        <span class="hljs-keyword">return</span> ((<span class="hljs-type">double</span>[]) collection)[i];<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">float</span>[]) &#123;<br>        <span class="hljs-keyword">return</span> ((<span class="hljs-type">float</span>[]) collection)[i];<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">int</span>[]) &#123;<br>        <span class="hljs-keyword">return</span> ((<span class="hljs-type">int</span>[]) collection)[i];<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">long</span>[]) &#123;<br>        <span class="hljs-keyword">return</span> ((<span class="hljs-type">long</span>[]) collection)[i];<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">short</span>[]) &#123;<br>        <span class="hljs-keyword">return</span> ((<span class="hljs-type">short</span>[]) collection)[i];<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;The &#x27;&quot;</span> + prop.getName() + <span class="hljs-string">&quot;&#x27; property of &quot;</span> + collection + <span class="hljs-string">&quot; is not a List or Array.&quot;</span>);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// è®¾é›†åˆçš„å€¼</span><br>  <span class="hljs-comment">// ä¸­æ‹¬å·æœ‰2ä¸ªæ„æ€ï¼Œä¸€ä¸ªæ˜¯Mapï¼Œä¸€ä¸ªæ˜¯Listæˆ–æ•°ç»„</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCollectionValue</span><span class="hljs-params">(PropertyTokenizer prop, Object collection, Object value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> Map) &#123;<br>      ((Map) collection).put(prop.getIndex(), value);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> Integer.parseInt(prop.getIndex());<br>      <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> List) &#123;<br>        ((List) collection).set(i, value);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> Object[]) &#123;<br>        ((Object[]) collection)[i] = value;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">char</span>[]) &#123;<br>        ((<span class="hljs-type">char</span>[]) collection)[i] = (Character) value;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">boolean</span>[]) &#123;<br>        ((<span class="hljs-type">boolean</span>[]) collection)[i] = (Boolean) value;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">byte</span>[]) &#123;<br>        ((<span class="hljs-type">byte</span>[]) collection)[i] = (Byte) value;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">double</span>[]) &#123;<br>        ((<span class="hljs-type">double</span>[]) collection)[i] = (Double) value;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">float</span>[]) &#123;<br>        ((<span class="hljs-type">float</span>[]) collection)[i] = (Float) value;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">int</span>[]) &#123;<br>        ((<span class="hljs-type">int</span>[]) collection)[i] = (Integer) value;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">long</span>[]) &#123;<br>        ((<span class="hljs-type">long</span>[]) collection)[i] = (Long) value;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (collection <span class="hljs-keyword">instanceof</span> <span class="hljs-type">short</span>[]) &#123;<br>        ((<span class="hljs-type">short</span>[]) collection)[i] = (Short) value;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;The &#x27;&quot;</span> + prop.getName() + <span class="hljs-string">&quot;&#x27; property of &quot;</span> + collection + <span class="hljs-string">&quot; is not a List or Array.&quot;</span>);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BeanWrapper"><a href="#BeanWrapper" class="headerlink" title="BeanWrapper"></a>BeanWrapper</h4><p>BeanåŒ…è£…å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseWrapper</span> &#123; <br><br>  <span class="hljs-comment">// åŸæ¥çš„å¯¹è±¡</span><br>  <span class="hljs-keyword">private</span> Object object;<br>  <span class="hljs-comment">// å…ƒç±»</span><br>  <span class="hljs-keyword">private</span> MetaClass metaClass; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BeanWrapper</span><span class="hljs-params">(MetaObject metaObject, Object object)</span> &#123;<br>    <span class="hljs-built_in">super</span>(metaObject);<br>    <span class="hljs-built_in">this</span>.object = object;<br>    <span class="hljs-built_in">this</span>.metaClass = MetaClass.forClass(object.getClass());<br>  &#125; <br><br>  <span class="hljs-comment">// åœ¨è¿™é‡Œåšæœ€ç»ˆçš„å–å€¼æ“ä½œ</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(PropertyTokenizer prop)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæœ‰index(æœ‰ä¸­æ‹¬å·),è¯´æ˜æ˜¯é›†åˆï¼Œé‚£å°±è¦è§£æé›†åˆ,è°ƒç”¨çš„æ˜¯BaseWrapper.resolveCollection å’Œ getCollectionValue</span><br>    <span class="hljs-keyword">if</span> (prop.getIndex() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">collection</span> <span class="hljs-operator">=</span> resolveCollection(prop, object);<br>      <span class="hljs-keyword">return</span> getCollectionValue(prop, collection);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å¦åˆ™ï¼ŒgetBeanProperty</span><br>      <span class="hljs-keyword">return</span> getBeanProperty(prop, object);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">getBeanProperty</span><span class="hljs-params">(PropertyTokenizer prop, Object object)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å¾—åˆ°getteræ–¹æ³•ï¼Œç„¶åè°ƒç”¨</span><br>      <span class="hljs-type">Invoker</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> metaClass.getGetInvoker(prop.getName());<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> method.invoke(object, NO_ARGUMENTS);<br>      &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (RuntimeException e) &#123;<br>      <span class="hljs-keyword">throw</span> e;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;Could not get property &#x27;&quot;</span> + prop.getName() + <span class="hljs-string">&quot;&#x27; from &quot;</span> + object.getClass() + <span class="hljs-string">&quot;.  Cause: &quot;</span> + t.toString(), t);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(PropertyTokenizer prop, Object value)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæœ‰index,è¯´æ˜æ˜¯é›†åˆï¼Œé‚£å°±è¦è§£æé›†åˆ,è°ƒç”¨çš„æ˜¯BaseWrapper.resolveCollection å’Œ setCollectionValue</span><br>    <span class="hljs-keyword">if</span> (prop.getIndex() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">collection</span> <span class="hljs-operator">=</span> resolveCollection(prop, object);<br>      setCollectionValue(prop, collection, value);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å¦åˆ™ï¼ŒsetBeanProperty</span><br>      setBeanProperty(prop, object, value);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBeanProperty</span><span class="hljs-params">(PropertyTokenizer prop, Object object, Object value)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å¾—åˆ°setteræ–¹æ³•ï¼Œç„¶åè°ƒç”¨</span><br>      <span class="hljs-type">Invoker</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> metaClass.getSetInvoker(prop.getName());<br>      Object[] params = &#123;value&#125;;<br>      <span class="hljs-keyword">try</span> &#123;<br>        method.invoke(object, params);<br>      &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;Could not set property &#x27;&quot;</span> + prop.getName() + <span class="hljs-string">&quot;&#x27; of &#x27;&quot;</span> + object.getClass() + <span class="hljs-string">&quot;&#x27; with value &#x27;&quot;</span> + value + <span class="hljs-string">&quot;&#x27; Cause: &quot;</span> + t.toString(), t);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findProperty</span><span class="hljs-params">(String name, <span class="hljs-type">boolean</span> useCamelCaseMapping)</span> &#123;<br>    <span class="hljs-keyword">return</span> metaClass.findProperty(name, useCamelCaseMapping);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String[] getGetterNames() &#123;<br>    <span class="hljs-keyword">return</span> metaClass.getGetterNames();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String[] getSetterNames() &#123;<br>    <span class="hljs-keyword">return</span> metaClass.getSetterNames();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getSetterType(String name) &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaValue</span> <span class="hljs-operator">=</span> metaObject.metaObjectForProperty(prop.getIndexedName());<br>      <span class="hljs-keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;<br>        <span class="hljs-keyword">return</span> metaClass.getSetterType(name);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> metaValue.getSetterType(prop.getChildren());<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> metaClass.getSetterType(name);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getGetterType(String name) &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaValue</span> <span class="hljs-operator">=</span> metaObject.metaObjectForProperty(prop.getIndexedName());<br>      <span class="hljs-keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;<br>        <span class="hljs-keyword">return</span> metaClass.getGetterType(name);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> metaValue.getGetterType(prop.getChildren());<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> metaClass.getGetterType(name);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// è¿™ä¸ªç»•æ¥ç»•å»çš„......</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasSetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-keyword">if</span> (metaClass.hasSetter(prop.getIndexedName())) &#123;<br>        <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaValue</span> <span class="hljs-operator">=</span> metaObject.metaObjectForProperty(prop.getIndexedName());<br>        <span class="hljs-keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;<br>          <span class="hljs-keyword">return</span> metaClass.hasSetter(name);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> metaValue.hasSetter(prop.getChildren());<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> metaClass.hasSetter(name);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasGetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-keyword">if</span> (metaClass.hasGetter(prop.getIndexedName())) &#123;<br>        <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaValue</span> <span class="hljs-operator">=</span> metaObject.metaObjectForProperty(prop.getIndexedName());<br>        <span class="hljs-keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;<br>          <span class="hljs-keyword">return</span> metaClass.hasGetter(name);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> metaValue.hasGetter(prop.getChildren());<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> metaClass.hasGetter(name);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> MetaObject <span class="hljs-title function_">instantiatePropertyValue</span><span class="hljs-params">(String name, PropertyTokenizer prop, ObjectFactory objectFactory)</span> &#123;<br>    MetaObject metaValue;<br>    Class&lt;?&gt; type = getSetterType(prop.getName());<br>    <span class="hljs-keyword">try</span> &#123; <br>      <span class="hljs-comment">// å®ä¾‹åŒ–å±æ€§</span><br>      <span class="hljs-type">Object</span> <span class="hljs-variable">newObject</span> <span class="hljs-operator">=</span> objectFactory.create(type);<br>      metaValue = MetaObject.forObject(newObject, metaObject.getObjectFactory(), metaObject.getObjectWrapperFactory());<br>      <span class="hljs-comment">// å±æ€§å¡«å……</span><br>      set(prop, newObject);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;Cannot set value of property &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27; because &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27; is null and cannot be instantiated on instance of &quot;</span> + type.getName() + <span class="hljs-string">&quot;. Cause:&quot;</span> + e.toString(), e);<br>    &#125;<br>    <span class="hljs-keyword">return</span> metaValue;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCollection</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Object element)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAll</span><span class="hljs-params">(List&lt;E&gt; list)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CollectionWrapper"><a href="#CollectionWrapper" class="headerlink" title="CollectionWrapper"></a>CollectionWrapper</h4><p>CollectionåŒ…è£…å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CollectionWrapper</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectWrapper</span> &#123; <br><br>  <span class="hljs-comment">// åŸæ¥çš„å¯¹è±¡</span><br>  <span class="hljs-keyword">private</span> Collection&lt;Object&gt; object; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CollectionWrapper</span><span class="hljs-params">(MetaObject metaObject, Collection&lt;Object&gt; object)</span> &#123;<br>    <span class="hljs-built_in">this</span>.object = object;<br>  &#125; <br><br>  <span class="hljs-comment">// get,setéƒ½æ˜¯ä¸å…è®¸çš„,åªèƒ½æ·»åŠ å…ƒç´ </span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(PropertyTokenizer prop)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(PropertyTokenizer prop, Object value)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findProperty</span><span class="hljs-params">(String name, <span class="hljs-type">boolean</span> useCamelCaseMapping)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String[] getGetterNames() &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getSetterType(String name) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getGetterType(String name) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasSetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasGetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> MetaObject <span class="hljs-title function_">instantiatePropertyValue</span><span class="hljs-params">(String name, PropertyTokenizer prop, ObjectFactory objectFactory)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCollection</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Object element)</span> &#123;<br>    object.add(element);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAll</span><span class="hljs-params">(List&lt;E&gt; element)</span> &#123;<br>    object.addAll(element);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MapWrapper"><a href="#MapWrapper" class="headerlink" title="MapWrapper"></a>MapWrapper</h4><p>MapåŒ…è£…å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseWrapper</span> &#123;<br> <br>  <span class="hljs-comment">// åŸæ¥çš„å¯¹è±¡</span><br>  <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; map;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapWrapper</span><span class="hljs-params">(MetaObject metaObject, Map&lt;String, Object&gt; map)</span> &#123;<br>    <span class="hljs-built_in">super</span>(metaObject);<br>    <span class="hljs-built_in">this</span>.map = map;<br>  &#125; <br><br>  <span class="hljs-comment">// get,setæ˜¯å…è®¸çš„</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(PropertyTokenizer prop)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæœ‰index,è¯´æ˜æ˜¯é›†åˆï¼Œé‚£å°±è¦åˆ†è§£é›†åˆ,è°ƒç”¨çš„æ˜¯BaseWrapper.resolveCollection å’Œ getCollectionVal            ue</span><br>    <span class="hljs-comment">// mapçš„å…ƒç´ å½“ä½œé›†åˆå¤„ç†</span><br>    <span class="hljs-keyword">if</span> (prop.getIndex() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">collection</span> <span class="hljs-operator">=</span> resolveCollection(prop, map);<br>      <span class="hljs-keyword">return</span> getCollectionValue(prop, collection);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> map.get(prop.getName());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(PropertyTokenizer prop, Object value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (prop.getIndex() != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">collection</span> <span class="hljs-operator">=</span> resolveCollection(prop, map);<br>      setCollectionValue(prop, collection, value);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      map.put(prop.getName(), value);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findProperty</span><span class="hljs-params">(String name, <span class="hljs-type">boolean</span> useCamelCaseMapping)</span> &#123;<br>    <span class="hljs-keyword">return</span> name;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String[] getGetterNames() &#123;<br>    <span class="hljs-keyword">return</span> map.keySet().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[map.keySet().size()]);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String[] getSetterNames() &#123;<br>    <span class="hljs-keyword">return</span> map.keySet().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[map.keySet().size()]);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getSetterType(String name) &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaValue</span> <span class="hljs-operator">=</span> metaObject.metaObjectForProperty(prop.getIndexedName());<br>      <span class="hljs-keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;<br>        <span class="hljs-keyword">return</span> Object.class;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> metaValue.getSetterType(prop.getChildren());<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (map.get(name) != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> map.get(name).getClass();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> Object.class;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; getGetterType(String name) &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123;<br>      <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaValue</span> <span class="hljs-operator">=</span> metaObject.metaObjectForProperty(prop.getIndexedName());<br>      <span class="hljs-keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;<br>        <span class="hljs-keyword">return</span> Object.class;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> metaValue.getGetterType(prop.getChildren());<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (map.get(name) != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> map.get(name).getClass();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> Object.class;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// mapä¸€ç›´å…è®¸setæ“ä½œ</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasSetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasGetter</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-type">PropertyTokenizer</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PropertyTokenizer</span>(name);<br>    <span class="hljs-keyword">if</span> (prop.hasNext()) &#123; <br>      <span class="hljs-comment">// çœŸçš„ä¼šæœ‰äººä»¥ key[index] ä½œä¸ºmapçš„keyå—...</span><br>      <span class="hljs-keyword">if</span> (map.containsKey(prop.getIndexedName())) &#123;<br>        <span class="hljs-type">MetaObject</span> <span class="hljs-variable">metaValue</span> <span class="hljs-operator">=</span> metaObject.metaObjectForProperty(prop.getIndexedName());<br>        <span class="hljs-keyword">if</span> (metaValue == SystemMetaObject.NULL_META_OBJECT) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> metaValue.hasGetter(prop.getChildren());<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> map.containsKey(prop.getName());<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> MetaObject <span class="hljs-title function_">instantiatePropertyValue</span><span class="hljs-params">(String name, PropertyTokenizer prop, ObjectFactory objectFactory)</span> &#123;<br>    HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>    set(prop, map);<br>    <span class="hljs-keyword">return</span> MetaObject.forObject(map, metaObject.getObjectFactory(), metaObject.getObjectWrapperFactory());<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCollection</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Object element)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAll</span><span class="hljs-params">(List&lt;E&gt; element)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ObjectWrapperFactory"><a href="#ObjectWrapperFactory" class="headerlink" title="ObjectWrapperFactory"></a>ObjectWrapperFactory</h4><p>å¯¹è±¡åŒ…è£…å™¨å·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ObjectWrapperFactory</span> &#123; <br>    <br>  <span class="hljs-comment">// æœ‰æ²¡æœ‰åŒ…è£…å™¨</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasWrapperFor</span><span class="hljs-params">(Object object)</span>;<br>  <br>  <span class="hljs-comment">// å¾—åˆ°åŒ…è£…å™¨</span><br>  ObjectWrapper <span class="hljs-title function_">getWrapperFor</span><span class="hljs-params">(MetaObject metaObject, Object object)</span>;<br>  <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DefaultObjectWrapperFactory"><a href="#DefaultObjectWrapperFactory" class="headerlink" title="DefaultObjectWrapperFactory"></a>DefaultObjectWrapperFactory</h4><p>é»˜è®¤çš„å¯¹è±¡åŒ…è£…å™¨å·¥å‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultObjectWrapperFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectWrapperFactory</span> &#123;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// é»˜è®¤æ²¡æœ‰åŒ…è£…å™¨</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasWrapperFor</span><span class="hljs-params">(Object object)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// é»˜è®¤æŠ›å¼‚å¸¸</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> ObjectWrapper <span class="hljs-title function_">getWrapperFor</span><span class="hljs-params">(MetaObject metaObject, Object object)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflectionException</span>(<span class="hljs-string">&quot;The DefaultObjectWrapperFactory should never be called to provide an ObjectWrapper.&quot;</span>);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ExceptionUtil"><a href="#ExceptionUtil" class="headerlink" title="ExceptionUtil"></a>ExceptionUtil</h4><p>å¯¹å¼‚å¸¸è¿›è¡Œè§£åŒ…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionUtil</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">ExceptionUtil</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Prevent Instantiation</span><br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Throwable <span class="hljs-title function_">unwrapThrowable</span><span class="hljs-params">(Throwable wrapped)</span> &#123;<br>    <span class="hljs-type">Throwable</span> <span class="hljs-variable">unwrapped</span> <span class="hljs-operator">=</span> wrapped;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>      <span class="hljs-comment">// å¤„ç†2ç§å¼‚å¸¸ï¼ŒInvocationTargetExceptionå’ŒUndeclaredThrowableExceptionï¼Œå°†å®ƒä»¬è§£åŒ…,ä»è€Œå¾—åˆ°çœŸæ­£çš„å¼‚å¸¸</span><br>      <span class="hljs-keyword">if</span> (unwrapped <span class="hljs-keyword">instanceof</span> InvocationTargetException) &#123;<br>        unwrapped = ((InvocationTargetException) unwrapped).getTargetException();<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unwrapped <span class="hljs-keyword">instanceof</span> UndeclaredThrowableException) &#123;<br>        unwrapped = ((UndeclaredThrowableException) unwrapped).getUndeclaredThrowable();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> unwrapped;<br>      &#125;<br>    &#125;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6-io</title>
    <link href="/2023/07/06/mybatis-source-code/6-io/"/>
    <url>/2023/07/06/mybatis-source-code/6-io/</url>
    
    <content type="html"><![CDATA[<h4 id="JBoss6VFS"><a href="#JBoss6VFS" class="headerlink" title="JBoss6VFS"></a>JBoss6VFS</h4><p>â€‹ ä¸€ä¸ªä½¿ç”¨JBoss6æä¾›çš„VFS APIçš„VFSå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JBoss6VFS</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">VFS</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(ResolverUtil.class);<br><br>  <span class="hljs-comment">// ä¸€ä¸ªæ¨¡ä»¿JBoss VirtualFileç±»çš„å¾®å°å­é›†çš„ç±»</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualFile</span> &#123;<br>    <span class="hljs-keyword">static</span> Class&lt;?&gt; VirtualFile;<br>    <span class="hljs-keyword">static</span> Method getPathNameRelativeTo, getChildrenRecursively;<br><br>    Object virtualFile;<br><br>    VirtualFile(Object virtualFile) &#123;<br>      <span class="hljs-built_in">this</span>.virtualFile = virtualFile;<br>    &#125;<br><br>    String <span class="hljs-title function_">getPathNameRelativeTo</span><span class="hljs-params">(VirtualFile parent)</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> invoke(getPathNameRelativeTo, virtualFile, parent.virtualFile);<br>      &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-comment">// This exception is not thrown by the called method</span><br>        log.error(<span class="hljs-string">&quot;This should not be possible. VirtualFile.getPathNameRelativeTo() threw IOException.&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>    &#125;<br><br>    List&lt;VirtualFile&gt; <span class="hljs-title function_">getChildren</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>      List&lt;?&gt; objects = invoke(getChildrenRecursively, virtualFile);<br>      List&lt;VirtualFile&gt; children = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;VirtualFile&gt;(objects.size());<br>      <span class="hljs-keyword">for</span> (Object object : objects) &#123;<br>        children.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualFile</span>(object));<br>      &#125;<br>      <span class="hljs-keyword">return</span> children;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// ä¸€ä¸ªæ¨¡ä»¿JBoss VFSç±»çš„å¾®å°å­é›†çš„ç±»</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VFS</span> &#123;<br>    <span class="hljs-keyword">static</span> Class&lt;?&gt; VFS;<br>    <span class="hljs-keyword">static</span> Method getChild;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">VFS</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">// Prevent Instantiation</span><br>    &#125;<br><br>    <span class="hljs-keyword">static</span> VirtualFile <span class="hljs-title function_">getChild</span><span class="hljs-params">(URL url)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> invoke(getChild, VFS, url);<br>      <span class="hljs-keyword">return</span> o == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : <span class="hljs-keyword">new</span> <span class="hljs-title class_">VirtualFile</span>(o);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ‰§è¡Œæ–¹æ³•å¹¶æŠ›å‡ºå¼‚å¸¸</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">invoke</span><span class="hljs-params">(Method method, Object object, Object... parameters)</span><br>      <span class="hljs-keyword">throws</span> IOException, RuntimeException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> (T) method.invoke(object, parameters);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>      <span class="hljs-keyword">if</span> (e.getTargetException() <span class="hljs-keyword">instanceof</span> IOException) &#123;<br>        <span class="hljs-keyword">throw</span> (IOException) e.getTargetException();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>      &#125;<br>    &#125;<br>    &#125;    <br><br>  <span class="hljs-comment">// è¡¨ç¤ºè¿™ä¸ªVFSåœ¨å½“å‰ç¯å¢ƒä¸‹æ˜¯å¦å¯ç”¨</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Boolean valid;<br><br>  <span class="hljs-comment">// æ‰¾åˆ°è®¿é—®JBoss 6 VFSæ‰€éœ€çš„æ‰€æœ‰ç±»å’Œæ–¹æ³•</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (valid == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// Assume valid. It will get flipped later if something goes wrong.</span><br>      valid = Boolean.TRUE;<br><br>      <span class="hljs-comment">// Look up and verify required classes</span><br>      VFS.VFS = checkNotNull(getClass(<span class="hljs-string">&quot;org.jboss.vfs.VFS&quot;</span>));<br>      VirtualFile.VirtualFile = checkNotNull(getClass(<span class="hljs-string">&quot;org.jboss.vfs.VirtualFile&quot;</span>));<br><br>      <span class="hljs-comment">// Look up and verify required methods</span><br>      VFS.getChild = checkNotNull(getMethod(VFS.VFS, <span class="hljs-string">&quot;getChild&quot;</span>, URL.class));<br>      VirtualFile.getChildrenRecursively = checkNotNull(getMethod(VirtualFile.VirtualFile,<br>          <span class="hljs-string">&quot;getChildrenRecursively&quot;</span>));<br>      VirtualFile.getPathNameRelativeTo = checkNotNull(getMethod(VirtualFile.VirtualFile,<br>          <span class="hljs-string">&quot;getPathNameRelativeTo&quot;</span>, VirtualFile.VirtualFile));<br><br>      <span class="hljs-comment">// Verify that the API has not changed</span><br>      checkReturnType(VFS.getChild, VirtualFile.VirtualFile);<br>      checkReturnType(VirtualFile.getChildrenRecursively, List.class);<br>      checkReturnType(VirtualFile.getPathNameRelativeTo, String.class);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// é€šè¿‡å½“å‰çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ ¹æ®ç±»åè·å–ç±»</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getClass(String className) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> Thread.currentThread().getContextClassLoader().loadClass(className);<br><span class="hljs-comment">//      return ReflectUtil.findClass(className);</span><br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>      log.debug(<span class="hljs-string">&quot;Class not found: &quot;</span> + className);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// å¦‚æœå¯¹è±¡ä¸ºnullï¼Œè¡¨ç¤ºJBoss 6 VFS APIåœ¨å½“å‰ç¯å¢ƒä¸‹ä¸å¯ç”¨</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">checkNotNull</span><span class="hljs-params">(T object)</span> &#123;<br>    <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">null</span>) &#123;<br>      setInvalid();<br>    &#125;<br>    <span class="hljs-keyword">return</span> object;<br>  &#125;  <br><br>  <span class="hljs-comment">// æ ¹æ®æ–¹æ³•åå’Œå‚æ•°è·å–ç±»çš„æŸä¸ªæ–¹æ³•</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Method <span class="hljs-title function_">getMethod</span><span class="hljs-params">(Class&lt;?&gt; clazz, String methodName, Class&lt;?&gt;... parameterTypes)</span> &#123;<br>    <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> clazz.getMethod(methodName, parameterTypes);<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>      log.error(<span class="hljs-string">&quot;Security exception looking for method &quot;</span> + clazz.getName() + <span class="hljs-string">&quot;.&quot;</span> + methodName + <span class="hljs-string">&quot;.  Cause: &quot;</span> + e);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>      log.error(<span class="hljs-string">&quot;Method not found &quot;</span> + clazz.getName() + <span class="hljs-string">&quot;.&quot;</span> + methodName + <span class="hljs-string">&quot;.&quot;</span> + methodName + <span class="hljs-string">&quot;.  Cause: &quot;</span> + e);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-comment">// æ£€æŸ¥æ–¹æ³•çš„è¿”å›å€¼æ˜¯å¦å’Œé¢„æœŸçš„ç›¸åŒï¼Œä»¥æ­¤æ¥æ£€æŸ¥æ–¹æ³•æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œ</span><br>  <span class="hljs-comment">// å¦‚æœæ–¹æ³•å‘ç”Ÿäº†å˜åŒ–ï¼Œè®¾ç½®JBoss 6 VFS APIåœ¨å½“å‰ç¯å¢ƒä¸‹ä¸å¯ç”¨</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkReturnType</span><span class="hljs-params">(Method method, Class&lt;?&gt; expected)</span> &#123;<br>    <span class="hljs-keyword">if</span> (method != <span class="hljs-literal">null</span> &amp;&amp; !expected.isAssignableFrom(method.getReturnType())) &#123;<br>      log.error(<span class="hljs-string">&quot;Method &quot;</span> + method.getClass().getName() + <span class="hljs-string">&quot;.&quot;</span> + method.getName()<br>          + <span class="hljs-string">&quot;(..) should return &quot;</span> + expected.getName() + <span class="hljs-string">&quot; but returns &quot;</span><br>          + method.getReturnType().getName() + <span class="hljs-string">&quot; instead.&quot;</span>);<br>      setInvalid();<br>    &#125;<br>  &#125;  <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setInvalid</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (JBoss6VFS.valid == Boolean.TRUE) &#123;<br>      log.debug(<span class="hljs-string">&quot;JBoss 6 VFS API is not available in this environment.&quot;</span>);<br>      JBoss6VFS.valid = Boolean.FALSE;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">static</span> &#123;<br>    initialize();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// é€’å½’åˆ—å‡ºæ‰€æœ‰èµ„æºçš„å®Œæ•´èµ„æºè·¯å¾„ï¼Œè¿™äº›èµ„æºæ˜¯ç”±URLæ ‡è¯†çš„èµ„æºçš„å­èµ„æºã€‚</span><br>  <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(URL url, String path)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    VirtualFile directory;<br>    directory = VFS.getChild(url);<br>    <span class="hljs-keyword">if</span> (directory == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> Collections.emptyList();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!path.endsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>      path += <span class="hljs-string">&quot;/&quot;</span>;<br>    &#125;<br><br>    List&lt;VirtualFile&gt; children = directory.getChildren();<br>    List&lt;String&gt; names = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;(children.size());<br>    <span class="hljs-keyword">for</span> (VirtualFile vf : children) &#123;<br>      names.add(path + vf.getPathNameRelativeTo(directory));<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> names;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DefaultVFS"><a href="#DefaultVFS" class="headerlink" title="DefaultVFS"></a>DefaultVFS</h4><p>é»˜è®¤çš„VFSå®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultVFS</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">VFS</span> &#123; <br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(ResolverUtil.class);<br> <br>  <span class="hljs-comment">/** The magic header that indicates a JAR (ZIP) file. */</span><br>  <span class="hljs-comment">// è¡¨ç¤ºjarç±»å‹æ–‡ä»¶çš„é­”æ•°å¤´</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] JAR_MAGIC = &#123; <span class="hljs-string">&#x27;P&#x27;</span>, <span class="hljs-string">&#x27;K&#x27;</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span> &#125;;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// è¯•å›¾è§£æ„ç»™å®šçš„URLï¼Œä»¥æ‰¾åˆ°ä¸€ä¸ªåŒ…å«è¯¥URLæ‰€å¼•ç”¨çš„èµ„æºçš„JARæ–‡ä»¶ã€‚</span><br>  <span class="hljs-comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œå‡è®¾è¯¥URLå¼•ç”¨äº†ä¸€ä¸ªJARæ¡ç›®ï¼Œ</span><br>  <span class="hljs-comment">// è¯¥æ–¹æ³•å°†è¿”å›ä¸€ä¸ªå¼•ç”¨ä¸€ä¸ªJARæ–‡ä»¶çš„URLï¼Œè¿™ä¸ªJARæ–‡ä»¶åŒ…å«æ­¤æ¡ç›®ã€‚</span><br>  <span class="hljs-comment">// å¦‚æœä¸èƒ½æ‰¾åˆ°JARï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±ä¼šè¿”å›nullã€‚</span><br>  <span class="hljs-keyword">protected</span> URL <span class="hljs-title function_">findJarForResource</span><span class="hljs-params">(URL url)</span> <span class="hljs-keyword">throws</span> MalformedURLException &#123;<br>    log.debug(<span class="hljs-string">&quot;Find JAR URL: &quot;</span> + url);<br><br>    <span class="hljs-comment">// If the file part of the URL is itself a URL, then that URL probably points to the JAR</span><br>    <span class="hljs-comment">// å¦‚æœURLçš„æ–‡ä»¶éƒ¨åˆ†æœ¬èº«æ˜¯ä¸€ä¸ªURLï¼Œé‚£ä¹ˆå…¶å¯èƒ½æŒ‡å‘jar</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">for</span> (;;) &#123;<br>        url = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url.getFile());<br>        log.debug(<span class="hljs-string">&quot;Inner URL: &quot;</span> + url);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (MalformedURLException e) &#123;<br>      <span class="hljs-comment">// This will happen at some point and serves as a break in the loop</span><br>    &#125;<br><br>    <span class="hljs-comment">// Look for the .jar extension and chop off everything after that</span><br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">jarUrl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(url.toExternalForm());<br>    <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> jarUrl.lastIndexOf(<span class="hljs-string">&quot;.jar&quot;</span>);<br>    <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) &#123;<br>      jarUrl.setLength(index + <span class="hljs-number">4</span>);<br>      log.debug(<span class="hljs-string">&quot;Extracted JAR URL: &quot;</span> + jarUrl);<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>      log.debug(<span class="hljs-string">&quot;Not a JAR: &quot;</span> + jarUrl);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// Try to open and test it</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-type">URL</span> <span class="hljs-variable">testUrl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(jarUrl.toString());<br>      <span class="hljs-keyword">if</span> (isJar(testUrl)) &#123;<br>        <span class="hljs-keyword">return</span> testUrl;<br>      &#125;<br>      <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// WebLogic fix: check if the URL&#x27;s file exists in the filesystem.</span><br>        log.debug(<span class="hljs-string">&quot;Not a JAR: &quot;</span> + jarUrl);<br>        jarUrl.replace(<span class="hljs-number">0</span>, jarUrl.length(), testUrl.getFile());<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(jarUrl.toString());<br><br>        <span class="hljs-comment">// File name might be URL-encoded</span><br>        <span class="hljs-keyword">if</span> (!file.exists()) &#123;<br>          <span class="hljs-keyword">try</span> &#123;<br>            file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(URLEncoder.encode(jarUrl.toString(), <span class="hljs-string">&quot;UTF-8&quot;</span>));<br>          &#125; <span class="hljs-keyword">catch</span> (UnsupportedEncodingException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Unsupported encoding?  UTF-8?  That&#x27;s unpossible.&quot;</span>);<br>          &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (file.exists()) &#123;<br>          log.debug(<span class="hljs-string">&quot;Trying real file: &quot;</span> + file.getAbsolutePath());<br>          testUrl = file.toURI().toURL();<br>          <span class="hljs-keyword">if</span> (isJar(testUrl)) &#123;<br>            <span class="hljs-keyword">return</span> testUrl;<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (MalformedURLException e) &#123;<br>      log.warn(<span class="hljs-string">&quot;Invalid JAR URL: &quot;</span> + jarUrl);<br>    &#125;<br><br>    log.debug(<span class="hljs-string">&quot;Not a JAR: &quot;</span> + jarUrl);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// åˆ¤æ–­ç»™å®šURLæ‰€ä»£è¡¨çš„èµ„æºæ˜¯å¦æ˜¯ä¸€ä¸ªjaræ–‡ä»¶</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isJar</span><span class="hljs-params">(URL url)</span> &#123;<br>    <span class="hljs-keyword">return</span> isJar(url, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[JAR_MAGIC.length]);<br>  &#125; <br><br>  <span class="hljs-comment">// å…·ä½“æ˜¯é€šè¿‡é­”æ•°è¿›è¡Œçš„åˆ¤æ–­</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isJar</span><span class="hljs-params">(URL url, <span class="hljs-type">byte</span>[] buffer)</span> &#123;<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      is = url.openStream();<br>      is.read(buffer, <span class="hljs-number">0</span>, JAR_MAGIC.length);<br>      <span class="hljs-comment">// åªæœ‰é­”æ•°åŒ¹é…ï¼Œæ‰è®¤ä¸ºæ˜¯jar</span><br>      <span class="hljs-keyword">if</span> (Arrays.equals(buffer, JAR_MAGIC)) &#123;<br>        log.debug(<span class="hljs-string">&quot;Found JAR: &quot;</span> + url);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-comment">// Failure to read the stream means this is not a JAR</span><br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (is != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          is.close();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-comment">// Ignore</span><br>        &#125;<br>      &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(URL url, String path)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      List&lt;String&gt; resources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br><br>      <span class="hljs-comment">// First, try to find the URL of a JAR file containing the requested resource. If a JAR</span><br>      <span class="hljs-comment">// file is found, then we&#x27;ll list child resources by reading the JAR.</span><br>      <span class="hljs-type">URL</span> <span class="hljs-variable">jarUrl</span> <span class="hljs-operator">=</span> findJarForResource(url);<br>      <span class="hljs-keyword">if</span> (jarUrl != <span class="hljs-literal">null</span>) &#123;<br>        is = jarUrl.openStream();<br>        log.debug(<span class="hljs-string">&quot;Listing &quot;</span> + url);<br>        <span class="hljs-comment">// ç”¨JDKè‡ªå¸¦çš„JarInputStreamæ¥è¯»å–jaråŒ…</span><br>        resources = listResources(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JarInputStream</span>(is), path);<br>      &#125;<br>      <span class="hljs-keyword">else</span> &#123;<br>        List&lt;String&gt; children = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">if</span> (isJar(url)) &#123;<br>            <span class="hljs-comment">// Some versions of JBoss VFS might give a JAR stream even if the resource</span><br>            <span class="hljs-comment">// referenced by the URL isn&#x27;t actually a JAR</span><br>            is = url.openStream();<br>            <span class="hljs-type">JarInputStream</span> <span class="hljs-variable">jarInput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JarInputStream</span>(is);<br>            log.debug(<span class="hljs-string">&quot;Listing &quot;</span> + url);<br>            <span class="hljs-keyword">for</span> (JarEntry entry; (entry = jarInput.getNextJarEntry()) != <span class="hljs-literal">null</span>;) &#123;<br>              log.debug(<span class="hljs-string">&quot;Jar entry: &quot;</span> + entry.getName());<br>              children.add(entry.getName());<br>            &#125;<br>            jarInput.close();<br>          &#125;<br>          <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * Some servlet containers allow reading from directory resources like a</span><br><span class="hljs-comment">             * text file, listing the child resources one per line. However, there is no</span><br><span class="hljs-comment">             * way to differentiate between directory and file resources just by reading</span><br><span class="hljs-comment">             * them. To work around that, as each line is read, try to look it up via</span><br><span class="hljs-comment">             * the class loader as a child of the current resource. If any line fails</span><br><span class="hljs-comment">             * then we assume the current resource is not a directory.</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-comment">// ä¸€äº›servletå®¹å™¨å…è®¸åƒæ–‡æœ¬æ–‡ä»¶ä¸€æ ·ä»ç›®å½•èµ„æºä¸­è¯»å–ï¼Œæ¯è¡Œåˆ—å‡ºä¸€ä¸ªå­èµ„æºã€‚</span><br>            <span class="hljs-comment">// ç„¶è€Œï¼Œä»…ä»…é€šè¿‡è¯»å–ç›®å½•èµ„æºå’Œæ–‡ä»¶èµ„æºæ˜¯æ²¡æœ‰åŠæ³•åŒºåˆ†çš„ã€‚</span><br>            <span class="hljs-comment">// ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨è¯»å–æ¯ä¸€è¡Œæ—¶ï¼Œ</span><br>            <span class="hljs-comment">// å°è¯•é€šè¿‡ç±»åŠ è½½å™¨å°†å…¶ä½œä¸ºå½“å‰èµ„æºçš„ä¸€ä¸ªå­èµ„æºæ¥æŸ¥æ‰¾ã€‚</span><br>            <span class="hljs-comment">// å¦‚æœä»»ä½•ä¸€è¡Œå¤±è´¥ é‚£ä¹ˆæˆ‘ä»¬å°±å‡è®¾å½“å‰èµ„æºä¸æ˜¯ä¸€ä¸ªç›®å½•ã€‚</span><br>            is = url.openStream();<br>            <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(is));<br>            List&lt;String&gt; lines = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>            <span class="hljs-keyword">for</span> (String line; (line = reader.readLine()) != <span class="hljs-literal">null</span>;) &#123;<br>              log.debug(<span class="hljs-string">&quot;Reader entry: &quot;</span> + line);<br>              lines.add(line);<br>              <span class="hljs-keyword">if</span> (getResources(path + <span class="hljs-string">&quot;/&quot;</span> + line).isEmpty()) &#123;<br>                lines.clear();<br>                <span class="hljs-keyword">break</span>;<br>              &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (!lines.isEmpty()) &#123;<br>              log.debug(<span class="hljs-string">&quot;Listing &quot;</span> + url);<br>              children.addAll(lines);<br>            &#125;<br>          &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (FileNotFoundException e) &#123;<br>          <span class="hljs-comment">/*</span><br><span class="hljs-comment">           * For file URLs the openStream() call might fail, depending on the servlet</span><br><span class="hljs-comment">           * container, because directories can&#x27;t be opened for reading. If that happens,</span><br><span class="hljs-comment">           * then list the directory directly instead.</span><br><span class="hljs-comment">           */</span><br>          <span class="hljs-comment">// æœ‰çš„servletå®¹å™¨ openStream()æ–¹æ³•å¯èƒ½ä¼šæŠ¥é”™ï¼Œå› ä¸ºç›®å½•ä¸èƒ½è¢«æ‰“å¼€ç”¨äºread</span><br>          <span class="hljs-comment">// å› æ­¤å¦‚æœå‡ºç°ç›¸åº”çš„æŠ¥é”™ï¼Œç›´æ¥é€’å½’è°ƒç”¨listéå†ç›®å½•</span><br>          <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;file&quot;</span>.equals(url.getProtocol())) &#123;<br>            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(url.getFile());<br>            log.debug(<span class="hljs-string">&quot;Listing directory &quot;</span> + file.getAbsolutePath());<br>            <span class="hljs-keyword">if</span> (file.isDirectory()) &#123;<br>              log.debug(<span class="hljs-string">&quot;Listing &quot;</span> + url);<br>              children = Arrays.asList(file.list());<br>            &#125;<br>          &#125;<br>          <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// No idea where the exception came from so rethrow it</span><br>            <span class="hljs-keyword">throw</span> e;<br>          &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// The URL prefix to use when recursively listing child resources</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">prefix</span> <span class="hljs-operator">=</span> url.toExternalForm();<br>        <span class="hljs-keyword">if</span> (!prefix.endsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>          prefix = prefix + <span class="hljs-string">&quot;/&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Iterate over immediate children, adding files and recursing into directories</span><br>        <span class="hljs-comment">// å¯¹å­ç›®å½•è¿›è¡Œé€’å½’è°ƒç”¨</span><br>        <span class="hljs-keyword">for</span> (String child : children) &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">resourcePath</span> <span class="hljs-operator">=</span> path + <span class="hljs-string">&quot;/&quot;</span> + child;<br>          resources.add(resourcePath);<br>          <span class="hljs-type">URL</span> <span class="hljs-variable">childUrl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(prefix + child);<br>          resources.addAll(list(childUrl, resourcePath));<br>        &#125;<br>      &#125;<br><br>      <span class="hljs-keyword">return</span> resources;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (is != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          is.close();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          <span class="hljs-comment">// Ignore</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">protected</span> List&lt;String&gt; <span class="hljs-title function_">listResources</span><span class="hljs-params">(JarInputStream jar, String path)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// Include the leading and trailing slash when matching names</span><br>    <span class="hljs-keyword">if</span> (!path.startsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>      path = <span class="hljs-string">&quot;/&quot;</span> + path;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!path.endsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>      path = path + <span class="hljs-string">&quot;/&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// Iterate over the entries and collect those that begin with the requested path</span><br>    List&lt;String&gt; resources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    <span class="hljs-keyword">for</span> (JarEntry entry; (entry = jar.getNextJarEntry()) != <span class="hljs-literal">null</span>;) &#123;<br>      <span class="hljs-keyword">if</span> (!entry.isDirectory()) &#123;<br>        <span class="hljs-comment">// Add leading slash if it&#x27;s missing</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> entry.getName();<br>        <span class="hljs-keyword">if</span> (!name.startsWith(<span class="hljs-string">&quot;/&quot;</span>)) &#123;<br>          name = <span class="hljs-string">&quot;/&quot;</span> + name;<br>        &#125;<br><br>        <span class="hljs-comment">// Check file name</span><br>        <span class="hljs-keyword">if</span> (name.startsWith(path)) &#123;<br>          log.debug(<span class="hljs-string">&quot;Found resource: &quot;</span> + name);<br>          <span class="hljs-comment">// Trim leading slash</span><br>          resources.add(name.substring(<span class="hljs-number">1</span>));<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> resources;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="VFS"><a href="#VFS" class="headerlink" title="VFS"></a>VFS</h4><p>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œç”¨æ¥è¯»å–åº”ç”¨æœåŠ¡å™¨é‡Œçš„èµ„æº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VFS</span> &#123; <br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LogFactory.getLog(ResolverUtil.class);<br>  <span class="hljs-comment">/** The built-in implementations. */</span><br>  <span class="hljs-comment">// é»˜è®¤æä¾›2ä¸ªå®ç° JBoss6VFS,DefaultVFS</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Class&lt;?&gt;[] IMPLEMENTATIONS = &#123; JBoss6VFS.class, DefaultVFS.class &#125;;<br><br>  <span class="hljs-comment">/** The list to which implementations are added by &#123;<span class="hljs-doctag">@link</span> #addImplClass(Class)&#125;. */</span><br>  <span class="hljs-comment">// è¿™é‡Œæ˜¯æä¾›ä¸€ä¸ªç”¨æˆ·æ‰©å±•ç‚¹ï¼Œå¯ä»¥è®©ç”¨æˆ·è‡ªå®šä¹‰VFSå®ç°</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">VFS</span>&gt;&gt; USER_IMPLEMENTATIONS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">VFS</span>&gt;&gt;();<br><br>  <span class="hljs-comment">/** Singleton instance. */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> VFS instance; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> VFS <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (instance != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> instance;<br>    &#125;<br><br>    <span class="hljs-comment">// Try the user implementations first, then the built-ins</span><br>    List&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">VFS</span>&gt;&gt; impls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">VFS</span>&gt;&gt;();<br>    impls.addAll(USER_IMPLEMENTATIONS);<br>    impls.addAll(Arrays.asList((Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">VFS</span>&gt;[]) IMPLEMENTATIONS));<br><br>    <span class="hljs-comment">// Try each implementation class until a valid one is found</span><br>    <span class="hljs-comment">// éå†æŸ¥æ‰¾å®ç°ç±»ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„</span><br>    <span class="hljs-type">VFS</span> <span class="hljs-variable">vfs</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; vfs == <span class="hljs-literal">null</span> || !vfs.isValid(); i++) &#123;<br>      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">VFS</span>&gt; impl = impls.get(i);<br>      <span class="hljs-keyword">try</span> &#123;<br>        vfs = impl.newInstance();<br>        <span class="hljs-keyword">if</span> (vfs == <span class="hljs-literal">null</span> || !vfs.isValid()) &#123;<br>          log.debug(<span class="hljs-string">&quot;VFS implementation &quot;</span> + impl.getName() +<br>              <span class="hljs-string">&quot; is not valid in this environment.&quot;</span>);<br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (InstantiationException e) &#123;<br>        log.error(<span class="hljs-string">&quot;Failed to instantiate &quot;</span> + impl, e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>        log.error(<span class="hljs-string">&quot;Failed to instantiate &quot;</span> + impl, e);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>    &#125;<br><br>    log.debug(<span class="hljs-string">&quot;Using VFS adapter &quot;</span> + vfs.getClass().getName());<br>    VFS.instance = vfs;<br>    <span class="hljs-keyword">return</span> VFS.instance;<br>  &#125; <br><br>  <span class="hljs-comment">// æ·»åŠ è‡ªå®šä¹‰VFSå®ç°ç±»</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addImplClass</span><span class="hljs-params">(Class&lt;? extends VFS&gt; clazz)</span> &#123;<br>    <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>      USER_IMPLEMENTATIONS.add(clazz);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// é€šè¿‡ç±»åè·å–ç±»</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; getClass(String className) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> Thread.currentThread().getContextClassLoader().loadClass(className);<br><span class="hljs-comment">//      return ReflectUtil.findClass(className);</span><br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>      log.debug(<span class="hljs-string">&quot;Class not found: &quot;</span> + className);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¹æ®æ–¹æ³•åå’Œå‚æ•°è·å–ç±»çš„æ–¹æ³•</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Method <span class="hljs-title function_">getMethod</span><span class="hljs-params">(Class&lt;?&gt; clazz, String methodName, Class&lt;?&gt;... parameterTypes)</span> &#123;<br>    <span class="hljs-keyword">if</span> (clazz == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> clazz.getMethod(methodName, parameterTypes);<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>      log.error(<span class="hljs-string">&quot;Security exception looking for method &quot;</span> + clazz.getName() + <span class="hljs-string">&quot;.&quot;</span> + methodName + <span class="hljs-string">&quot;.  Cause: &quot;</span> + e);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>      log.error(<span class="hljs-string">&quot;Method not found &quot;</span> + clazz.getName() + <span class="hljs-string">&quot;.&quot;</span> + methodName + <span class="hljs-string">&quot;.&quot;</span> + methodName + <span class="hljs-string">&quot;.  Cause: &quot;</span> + e);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ‰§è¡Œæ–¹æ³•</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">invoke</span><span class="hljs-params">(Method method, Object object, Object... parameters)</span><br>      <span class="hljs-keyword">throws</span> IOException, RuntimeException &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> (T) method.invoke(object, parameters);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>      <span class="hljs-keyword">if</span> (e.getTargetException() <span class="hljs-keyword">instanceof</span> IOException) &#123;<br>        <span class="hljs-keyword">throw</span> (IOException) e.getTargetException();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨è·å–èµ„æº</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> List&lt;URL&gt; <span class="hljs-title function_">getResources</span><span class="hljs-params">(String path)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">return</span> Collections.list(Thread.currentThread().getContextClassLoader().getResources(path));<br>  &#125; <br><br>  <span class="hljs-comment">// ç”¨äºåˆ¤æ–­VFSå®ç°ç±»æ˜¯å¦å¯ç”¨</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">()</span>; <br><br>  <span class="hljs-comment">// é€’å½’åœ°åˆ—å‡ºæ‰€æœ‰èµ„æºçš„å®Œæ•´èµ„æºè·¯å¾„ï¼Œè¿™äº›èµ„æºæ˜¯ç”±ä¸€ä¸ªURLç¡®å®šçš„èµ„æºçš„å­ä»£ã€‚</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> List&lt;String&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(URL url, String forPath)</span> <span class="hljs-keyword">throws</span> IOException;<br><br>  <span class="hljs-comment">// é€’å½’åœ°åˆ—å‡ºæ‰€æœ‰èµ„æºçš„å®Œæ•´èµ„æºè·¯å¾„ï¼Œè¿™äº›èµ„æºæ˜¯åœ¨æŒ‡å®šè·¯å¾„æ‰¾åˆ°çš„æ‰€æœ‰èµ„æºçš„å­èµ„æºã€‚</span><br>  <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(String path)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    List&lt;String&gt; names = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>    <span class="hljs-keyword">for</span> (URL url : getResources(path)) &#123;<br>      names.addAll(list(url, path));<br>    &#125;<br>    <span class="hljs-keyword">return</span> names;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ClassLoaderWrapper"><a href="#ClassLoaderWrapper" class="headerlink" title="ClassLoaderWrapper"></a>ClassLoaderWrapper</h4><p>å°è£…äº†å‡ ä¸ªç±»åŠ è½½å™¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoaderWrapper</span> &#123; <br>  <span class="hljs-comment">// defaultClassLoaderåœ¨ Resources ç±»ä¸­éœ€è¦æ‰‹åŠ¨è®¾ç½®</span><br>  ClassLoader defaultClassLoader;<br>  ClassLoader systemClassLoader;<br><br>  ClassLoaderWrapper() &#123;<br>    <span class="hljs-keyword">try</span> &#123; <br>      <span class="hljs-comment">// åˆå§‹åŒ–ç³»ç»Ÿç±»åŠ è½½å™¨</span><br>      systemClassLoader = ClassLoader.getSystemClassLoader();<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException ignored) &#123;<br>      <span class="hljs-comment">// AccessControlException on Google App Engine   </span><br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ä¸‹é¢è·å–URLå‹çš„resourceã€è·å–InputStreamçš„resourceä»¥åŠæ ¹æ®åç§°è·å–ç±»</span><br>  <span class="hljs-comment">// éƒ½æ˜¯å§”æ‰˜ç»™é»˜è®¤çš„ç±»åŠ è½½å™¨å®ç°çš„ï¼Œå¦‚æœæä¾›äº†ç±»åŠ è½½å™¨ï¼Œåˆ™å…ˆç”¨æä¾›çš„ç±»åŠ è½½å™¨å°è¯•</span><br>  <span class="hljs-keyword">public</span> URL <span class="hljs-title function_">getResourceAsURL</span><span class="hljs-params">(String resource)</span> &#123;<br>    <span class="hljs-keyword">return</span> getResourceAsURL(resource, getClassLoaders(<span class="hljs-literal">null</span>));<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> URL <span class="hljs-title function_">getResourceAsURL</span><span class="hljs-params">(String resource, ClassLoader classLoader)</span> &#123;<br>    <span class="hljs-keyword">return</span> getResourceAsURL(resource, getClassLoaders(classLoader));<br>  &#125; <br><br>  URL <span class="hljs-title function_">getResourceAsURL</span><span class="hljs-params">(String resource, ClassLoader[] classLoader)</span> &#123;<br>    URL url;<br>    <span class="hljs-keyword">for</span> (ClassLoader cl : classLoader) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != cl) &#123;<br>        <span class="hljs-comment">// look for the resource as passed in...</span><br>        url = cl.getResource(resource);<br>        <span class="hljs-comment">// ...but some class loaders want this leading &quot;/&quot;, so we&#x27;ll add it</span><br>        <span class="hljs-comment">// and try again if we didn&#x27;t find the resource</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == url) &#123;<br>          url = cl.getResource(<span class="hljs-string">&quot;/&quot;</span> + resource);<br>        &#125;<br>        <span class="hljs-comment">// &quot;It&#x27;s always in the last place I look for it!&quot;</span><br>        <span class="hljs-comment">// ... because only an idiot would keep looking for it after finding it, so stop looking already.</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != url) &#123;<br>          <span class="hljs-keyword">return</span> url;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// didn&#x27;t find it anywhere.</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> InputStream <span class="hljs-title function_">getResourceAsStream</span><span class="hljs-params">(String resource)</span> &#123;<br>    <span class="hljs-keyword">return</span> getResourceAsStream(resource, getClassLoaders(<span class="hljs-literal">null</span>));<br>  &#125;    <br><br>  <span class="hljs-keyword">public</span> InputStream <span class="hljs-title function_">getResourceAsStream</span><span class="hljs-params">(String resource, ClassLoader classLoader)</span> &#123;<br>    <span class="hljs-keyword">return</span> getResourceAsStream(resource, getClassLoaders(classLoader));<br>  &#125; <br><br>  InputStream <span class="hljs-title function_">getResourceAsStream</span><span class="hljs-params">(String resource, ClassLoader[] classLoader)</span> &#123;<br>    <span class="hljs-keyword">for</span> (ClassLoader cl : classLoader) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != cl) &#123;<br>        <span class="hljs-comment">// try to find the resource as passed</span><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">returnValue</span> <span class="hljs-operator">=</span> cl.getResourceAsStream(resource);<br>        <span class="hljs-comment">// now, some class loaders want this leading &quot;/&quot;, so we&#x27;ll add it and try again if we didn&#x27;t find the resource</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == returnValue) &#123;<br>          returnValue = cl.getResourceAsStream(<span class="hljs-string">&quot;/&quot;</span> + resource);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != returnValue) &#123;<br>          <span class="hljs-keyword">return</span> returnValue;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; classForName(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">return</span> classForName(name, getClassLoaders(<span class="hljs-literal">null</span>));<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Class&lt;?&gt; classForName(String name, ClassLoader classLoader) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">return</span> classForName(name, getClassLoaders(classLoader));<br>  &#125; <br><br>  Class&lt;?&gt; classForName(String name, ClassLoader[] classLoader) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">for</span> (ClassLoader cl : classLoader) &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != cl) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          Class&lt;?&gt; c = Class.forName(name, <span class="hljs-literal">true</span>, cl);<br>          <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != c) &#123;<br>            <span class="hljs-keyword">return</span> c;<br>          &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>          <span class="hljs-comment">// we&#x27;ll ignore this until all classloaders fail to locate the class</span><br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(<span class="hljs-string">&quot;Cannot find class: &quot;</span> + name);<br>  &#125; <br><br>  ClassLoader[] getClassLoaders(ClassLoader classLoader) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoader</span>[]&#123;<br>        classLoader,<br>        defaultClassLoader,<br>        Thread.currentThread().getContextClassLoader(),<br>        getClass().getClassLoader(),<br>        systemClassLoader&#125;;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h4><p>é€šè¿‡ç±»åŠ è½½å™¨è·å–resourceçš„è¾…åŠ©ç±» Â </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Resources</span> &#123;<br>    <br>  <span class="hljs-comment">// å¤§å¤šæ•°æ–¹æ³•éƒ½æ˜¯å§”æ‰˜ç»™ClassLoaderWrapperï¼Œå†å»åšçœŸæ­£çš„äº‹</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ClassLoaderWrapper</span> <span class="hljs-variable">classLoaderWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassLoaderWrapper</span>();<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * Charset to use when calling getResourceAsReader.</span><br><span class="hljs-comment">   * null means use the system default.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Charset charset; <br><br>  Resources() &#123;<br>  &#125; <br><br>  <span class="hljs-comment">// è¿”å›é»˜è®¤çš„classloaderï¼ˆå¯èƒ½ä¸ºnullï¼‰ï¼Œæ²¡æœ‰æ‰‹åŠ¨è®¾ç½®å°±ä¸ºnull</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ClassLoader <span class="hljs-title function_">getDefaultClassLoader</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> classLoaderWrapper.defaultClassLoader;<br>  &#125; <br><br>  <span class="hljs-comment">// è®¾ç½®é»˜è®¤çš„classloader</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDefaultClassLoader</span><span class="hljs-params">(ClassLoader defaultClassLoader)</span> &#123;<br>    classLoaderWrapper.defaultClassLoader = defaultClassLoader;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title function_">getResourceURL</span><span class="hljs-params">(String resource)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>      <span class="hljs-comment">// issue #625</span><br>      <span class="hljs-keyword">return</span> getResourceURL(<span class="hljs-literal">null</span>, resource);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> URL <span class="hljs-title function_">getResourceURL</span><span class="hljs-params">(ClassLoader loader, String resource)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> classLoaderWrapper.getResourceAsURL(resource, loader);<br>    <span class="hljs-keyword">if</span> (url == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Could not find resource &quot;</span> + resource);<br>    &#125;<br>    <span class="hljs-keyword">return</span> url;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title function_">getResourceAsStream</span><span class="hljs-params">(String resource)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">return</span> getResourceAsStream(<span class="hljs-literal">null</span>, resource);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title function_">getResourceAsStream</span><span class="hljs-params">(ClassLoader loader, String resource)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> classLoaderWrapper.getResourceAsStream(resource, loader);<br>    <span class="hljs-keyword">if</span> (in == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Could not find resource &quot;</span> + resource);<br>    &#125;<br>    <span class="hljs-keyword">return</span> in;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æresourceï¼Œè¿”å›Properties</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Properties <span class="hljs-title function_">getResourceAsProperties</span><span class="hljs-params">(String resource)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> getResourceAsStream(resource);<br>    props.load(in);<br>    in.close();<br>    <span class="hljs-keyword">return</span> props;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Properties <span class="hljs-title function_">getResourceAsProperties</span><span class="hljs-params">(ClassLoader loader, String resource)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> getResourceAsStream(loader, resource);<br>    props.load(in);<br>    in.close();<br>    <span class="hljs-keyword">return</span> props;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£æresourceï¼Œè¿”å›Reader</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Reader <span class="hljs-title function_">getResourceAsReader</span><span class="hljs-params">(String resource)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    Reader reader;<br>    <span class="hljs-keyword">if</span> (charset == <span class="hljs-literal">null</span>) &#123;<br>      reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(getResourceAsStream(resource));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(getResourceAsStream(resource), charset);<br>    &#125;<br>    <span class="hljs-keyword">return</span> reader;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Reader <span class="hljs-title function_">getResourceAsReader</span><span class="hljs-params">(ClassLoader loader, String resource)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    Reader reader;<br>    <span class="hljs-keyword">if</span> (charset == <span class="hljs-literal">null</span>) &#123;<br>      reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(getResourceAsStream(loader, resource));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(getResourceAsStream(loader, resource), charset);<br>    &#125;<br>    <span class="hljs-keyword">return</span> reader;<br>  &#125; <br><br>  <span class="hljs-comment">// Returns a resource on the classpath as a File object</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> File <span class="hljs-title function_">getResourceAsFile</span><span class="hljs-params">(String resource)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(getResourceURL(resource).getFile());<br>  &#125; <br><br>  <span class="hljs-comment">// Returns a resource on the classpath as a File object</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> File <span class="hljs-title function_">getResourceAsFile</span><span class="hljs-params">(ClassLoader loader, String resource)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(getResourceURL(loader, resource).getFile());<br>  &#125; <br><br>  <span class="hljs-comment">// Gets a URL as an input stream</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InputStream <span class="hljs-title function_">getUrlAsStream</span><span class="hljs-params">(String urlString)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(urlString);<br>    <span class="hljs-type">URLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> url.openConnection();<br>    <span class="hljs-keyword">return</span> conn.getInputStream();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Reader <span class="hljs-title function_">getUrlAsReader</span><span class="hljs-params">(String urlString)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    Reader reader;<br>    <span class="hljs-keyword">if</span> (charset == <span class="hljs-literal">null</span>) &#123;<br>      reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(getUrlAsStream(urlString));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(getUrlAsStream(urlString), charset);<br>    &#125;<br>    <span class="hljs-keyword">return</span> reader;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Properties <span class="hljs-title function_">getUrlAsProperties</span><span class="hljs-params">(String urlString)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>    <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> getUrlAsStream(urlString);<br>    props.load(in);<br>    in.close();<br>    <span class="hljs-keyword">return</span> props;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; classForName(String className) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">return</span> classLoaderWrapper.classForName(className);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Charset <span class="hljs-title function_">getCharset</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> charset;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCharset</span><span class="hljs-params">(Charset charset)</span> &#123;<br>    Resources.charset = charset;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ExternalResources"><a href="#ExternalResources" class="headerlink" title="ExternalResources"></a>ExternalResources</h4><p>æ­¤ç±»ä¸­çš„æ–¹æ³•æœªåœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ï¼Œå› æ­¤ä¸åšåˆ†æ</p>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>5-type</title>
    <link href="/2023/06/25/mybatis-source-code/5-type/"/>
    <url>/2023/06/25/mybatis-source-code/5-type/</url>
    
    <content type="html"><![CDATA[<h4 id="Alias"><a href="#Alias" class="headerlink" title="Alias"></a>Alias</h4><p>Â Â Â Â æ­¤æ³¨è§£ç”¨äºæ³¨å†Œç±»å‹åˆ«å</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 2ç§æ–¹å¼å¯ä»¥æ³¨å†Œåˆ«å</span><br><span class="hljs-comment"> *     1)xmlæ–¹å¼</span><br><span class="hljs-comment"> * &lt;typeAlias alias=&quot;Author&quot; type=&quot;domain.blog.Author&quot;/&gt;</span><br><span class="hljs-comment"> *     2)annotationæ–¹å¼</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Alias</span>(&quot;author&quot;)</span><br><span class="hljs-comment"> * public class Author &#123;</span><br><span class="hljs-comment"> *   ...</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Alias &#123;<br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="JdbcType"><a href="#JdbcType" class="headerlink" title="JdbcType"></a>JdbcType</h4><p>Â Â Â Â JDBCç±»å‹æšä¸¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">JdbcType</span> &#123;<br>  <span class="hljs-comment">// å°±æ˜¯åŒ…è£…äº†ä¸€ä¸‹java.sql.Types</span><br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * This is added to enable basic support for the</span><br><span class="hljs-comment">   * ARRAY data type - but a custom type handler is still required</span><br><span class="hljs-comment">   */</span><br>  ARRAY(Types.ARRAY),<br>  BIT(Types.BIT),<br>  TINYINT(Types.TINYINT),<br>  SMALLINT(Types.SMALLINT),<br>  INTEGER(Types.INTEGER),<br>  BIGINT(Types.BIGINT),<br>  FLOAT(Types.FLOAT),<br>  REAL(Types.REAL),<br>  DOUBLE(Types.DOUBLE),<br>  NUMERIC(Types.NUMERIC),<br>  DECIMAL(Types.DECIMAL),<br>  CHAR(Types.CHAR),<br>  VARCHAR(Types.VARCHAR),<br>  LONGVARCHAR(Types.LONGVARCHAR),<br>  DATE(Types.DATE),<br>  TIME(Types.TIME),<br>  TIMESTAMP(Types.TIMESTAMP),<br>  BINARY(Types.BINARY),<br>  VARBINARY(Types.VARBINARY),<br>  LONGVARBINARY(Types.LONGVARBINARY),<br>  NULL(Types.NULL),<br>  OTHER(Types.OTHER),<br>  BLOB(Types.BLOB),<br>  CLOB(Types.CLOB),<br>  BOOLEAN(Types.BOOLEAN),<br>  CURSOR(-<span class="hljs-number">10</span>), <span class="hljs-comment">// Oracle</span><br>  UNDEFINED(Integer.MIN_VALUE + <span class="hljs-number">1000</span>),<br>  <span class="hljs-comment">// å¤ªå‘¨åˆ°äº†ï¼Œè¿˜è€ƒè™‘jdk5å…¼å®¹æ€§ï¼Œjdk6çš„å¸¸é‡éƒ½ä¸æ˜¯ç›´æ¥å¼•ç”¨</span><br>  NVARCHAR(Types.NVARCHAR), <span class="hljs-comment">// JDK6</span><br>  NCHAR(Types.NCHAR), <span class="hljs-comment">// JDK6</span><br>  NCLOB(Types.NCLOB), <span class="hljs-comment">// JDK6</span><br>  STRUCT(Types.STRUCT);<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> TYPE_CODE;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Integer,JdbcType&gt; codeLookup = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Integer,JdbcType&gt;();<br><br>  <span class="hljs-comment">// ç¼“å­˜ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½</span><br>  <span class="hljs-comment">// å¯ä»¥å‚è€ƒ https://mp.weixin.qq.com/s/CLr5bcxsG7C8v6qSsagEbw è¿›è¡Œæ‰©å±•</span><br>  <span class="hljs-keyword">static</span> &#123;<br>    <span class="hljs-keyword">for</span> (JdbcType type : JdbcType.values()) &#123;<br>      codeLookup.put(type.TYPE_CODE, type);<br>    &#125;<br>  &#125;<br><br>  JdbcType(<span class="hljs-type">int</span> code) &#123;<br>    <span class="hljs-built_in">this</span>.TYPE_CODE = code;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JdbcType <span class="hljs-title function_">forCode</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span>  &#123;<br>    <span class="hljs-keyword">return</span> codeLookup.get(code);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MappedTypes"><a href="#MappedTypes" class="headerlink" title="MappedTypes"></a>MappedTypes</h4><p>Â Â Â Â çœ‹ä»£ç æ˜¯æ ‡è®°è‡ªå®šä¹‰çš„ç±»å‹å¤„ç†å™¨å¯¹åº”çš„Javaç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MappedTypes &#123; <br>  <span class="hljs-keyword">public</span> Class&lt;?&gt;[] value();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MappedJdbcTypes"><a href="#MappedJdbcTypes" class="headerlink" title="MappedJdbcTypes"></a>MappedJdbcTypes</h4><p> Â Â Â Â ç”¨äºæ ‡è®°ç±»å‹å¤„ç†å™¨å¯ä»¥å¤„ç† Javaç±»å‹å’Œå“ªäº›Jdbcç±»å‹ çš„äº’ç›¸è½¬æ¢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MappedJdbcTypes &#123;<br>  <span class="hljs-keyword">public</span> JdbcType[] value(); <br>  <span class="hljs-comment">// æ˜¯å¦å°†ç±»å‹å¤„ç†å™¨æ³¨å†Œä¸ºèƒ½å¤„ç† Javaç±»å‹å’ŒJdbc Nullç±»å‹çš„äº’ç›¸è½¬æ¢</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">includeNullJdbcType</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="TypeAliasRegistry"><a href="#TypeAliasRegistry" class="headerlink" title="TypeAliasRegistry"></a>TypeAliasRegistry</h4><p>Â Â Â Â ç±»å‹åˆ«åæ³¨å†Œæœº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeAliasRegistry</span> &#123; <br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Class&lt;?&gt;&gt; TYPE_ALIASES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Class&lt;?&gt;&gt;();<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">TypeAliasRegistry</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// æ„é€ å‡½æ•°é‡Œæ³¨å†Œç³»ç»Ÿå†…ç½®çš„ç±»å‹åˆ«å</span><br>    registerAlias(<span class="hljs-string">&quot;string&quot;</span>, String.class);<br><br>    <span class="hljs-comment">// åŸºæœ¬åŒ…è£…ç±»å‹</span><br>    registerAlias(<span class="hljs-string">&quot;byte&quot;</span>, Byte.class);<br>    registerAlias(<span class="hljs-string">&quot;long&quot;</span>, Long.class);<br>    registerAlias(<span class="hljs-string">&quot;short&quot;</span>, Short.class);<br>    registerAlias(<span class="hljs-string">&quot;int&quot;</span>, Integer.class);<br>    registerAlias(<span class="hljs-string">&quot;integer&quot;</span>, Integer.class);<br>    registerAlias(<span class="hljs-string">&quot;double&quot;</span>, Double.class);<br>    registerAlias(<span class="hljs-string">&quot;float&quot;</span>, Float.class);<br>    registerAlias(<span class="hljs-string">&quot;boolean&quot;</span>, Boolean.class);<br><br>    <span class="hljs-comment">// åŸºæœ¬æ•°ç»„åŒ…è£…ç±»å‹</span><br>    registerAlias(<span class="hljs-string">&quot;byte[]&quot;</span>, Byte[].class);<br>    registerAlias(<span class="hljs-string">&quot;long[]&quot;</span>, Long[].class);<br>    registerAlias(<span class="hljs-string">&quot;short[]&quot;</span>, Short[].class);<br>    registerAlias(<span class="hljs-string">&quot;int[]&quot;</span>, Integer[].class);<br>    registerAlias(<span class="hljs-string">&quot;integer[]&quot;</span>, Integer[].class);<br>    registerAlias(<span class="hljs-string">&quot;double[]&quot;</span>, Double[].class);<br>    registerAlias(<span class="hljs-string">&quot;float[]&quot;</span>, Float[].class);<br>    registerAlias(<span class="hljs-string">&quot;boolean[]&quot;</span>, Boolean[].class);<br><br>    <span class="hljs-comment">// åŠ ä¸ªä¸‹åˆ’çº¿ï¼Œå°±å˜æˆäº†åŸºæœ¬ç±»å‹</span><br>    registerAlias(<span class="hljs-string">&quot;_byte&quot;</span>, <span class="hljs-type">byte</span>.class);<br>    registerAlias(<span class="hljs-string">&quot;_long&quot;</span>, <span class="hljs-type">long</span>.class);<br>    registerAlias(<span class="hljs-string">&quot;_short&quot;</span>, <span class="hljs-type">short</span>.class);<br>    registerAlias(<span class="hljs-string">&quot;_int&quot;</span>, <span class="hljs-type">int</span>.class);<br>    registerAlias(<span class="hljs-string">&quot;_integer&quot;</span>, <span class="hljs-type">int</span>.class);<br>    registerAlias(<span class="hljs-string">&quot;_double&quot;</span>, <span class="hljs-type">double</span>.class);<br>    registerAlias(<span class="hljs-string">&quot;_float&quot;</span>, <span class="hljs-type">float</span>.class);<br>    registerAlias(<span class="hljs-string">&quot;_boolean&quot;</span>, <span class="hljs-type">boolean</span>.class);<br><br>    <span class="hljs-comment">// åŠ ä¸ªä¸‹åˆ’çº¿ï¼Œå°±å˜æˆäº†åŸºæœ¬æ•°ç»„ç±»å‹</span><br>    registerAlias(<span class="hljs-string">&quot;_byte[]&quot;</span>, <span class="hljs-type">byte</span>[].class);<br>    registerAlias(<span class="hljs-string">&quot;_long[]&quot;</span>, <span class="hljs-type">long</span>[].class);<br>    registerAlias(<span class="hljs-string">&quot;_short[]&quot;</span>, <span class="hljs-type">short</span>[].class);<br>    registerAlias(<span class="hljs-string">&quot;_int[]&quot;</span>, <span class="hljs-type">int</span>[].class);<br>    registerAlias(<span class="hljs-string">&quot;_integer[]&quot;</span>, <span class="hljs-type">int</span>[].class);<br>    registerAlias(<span class="hljs-string">&quot;_double[]&quot;</span>, <span class="hljs-type">double</span>[].class);<br>    registerAlias(<span class="hljs-string">&quot;_float[]&quot;</span>, <span class="hljs-type">float</span>[].class);<br>    registerAlias(<span class="hljs-string">&quot;_boolean[]&quot;</span>, <span class="hljs-type">boolean</span>[].class);<br><br>    <span class="hljs-comment">// æ—¥æœŸæ•°å­—å‹</span><br>    registerAlias(<span class="hljs-string">&quot;date&quot;</span>, Date.class);<br>    registerAlias(<span class="hljs-string">&quot;decimal&quot;</span>, BigDecimal.class);<br>    registerAlias(<span class="hljs-string">&quot;bigdecimal&quot;</span>, BigDecimal.class);<br>    registerAlias(<span class="hljs-string">&quot;biginteger&quot;</span>, BigInteger.class);<br>    registerAlias(<span class="hljs-string">&quot;object&quot;</span>, Object.class);<br><br>    registerAlias(<span class="hljs-string">&quot;date[]&quot;</span>, Date[].class);<br>    registerAlias(<span class="hljs-string">&quot;decimal[]&quot;</span>, BigDecimal[].class);<br>    registerAlias(<span class="hljs-string">&quot;bigdecimal[]&quot;</span>, BigDecimal[].class);<br>    registerAlias(<span class="hljs-string">&quot;biginteger[]&quot;</span>, BigInteger[].class);<br>    registerAlias(<span class="hljs-string">&quot;object[]&quot;</span>, Object[].class);<br><br>    <span class="hljs-comment">// é›†åˆå‹</span><br>    registerAlias(<span class="hljs-string">&quot;map&quot;</span>, Map.class);<br>    registerAlias(<span class="hljs-string">&quot;hashmap&quot;</span>, HashMap.class);<br>    registerAlias(<span class="hljs-string">&quot;list&quot;</span>, List.class);<br>    registerAlias(<span class="hljs-string">&quot;arraylist&quot;</span>, ArrayList.class);<br>    registerAlias(<span class="hljs-string">&quot;collection&quot;</span>, Collection.class);<br>    registerAlias(<span class="hljs-string">&quot;iterator&quot;</span>, Iterator.class);<br><br>    <span class="hljs-comment">// è¿˜æœ‰ä¸ªResultSetå‹</span><br>    registerAlias(<span class="hljs-string">&quot;ResultSet&quot;</span>, ResultSet.class);<br>  &#125;<br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-comment">// throws class cast exception as well if types cannot be assigned</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; Class&lt;T&gt; <span class="hljs-title function_">resolveAlias</span><span class="hljs-params">(String string)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (string == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>      <span class="hljs-comment">// issue #748 (è¿™é‡Œçš„issueåœ¨ google codeä¸Šï¼Œå·²ç»æ— äº†)</span><br>      <span class="hljs-comment">// å…ˆè½¬æˆå°å†™å†è§£æ</span><br>      <span class="hljs-comment">// æ¯”å¦‚å¦‚æœæœ¬åœ°è¯­è¨€æ˜¯Turkishï¼Œé‚£iè½¬æˆå¤§å†™å°±ä¸æ˜¯Iäº†ï¼Œè€Œæ˜¯å¦å¤–ä¸€ä¸ªå­—ç¬¦ï¼ˆÄ°ï¼‰ã€‚è¿™æ ·åœŸè€³å…¶çš„æœºå™¨å°±ç”¨ä¸äº†mybatisäº†ï¼è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„bugï¼Œä½†æ˜¯åŸºæœ¬ä¸Šæ¯ä¸ªäººéƒ½ä¼šçŠ¯......</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> string.toLowerCase(Locale.ENGLISH);<br>      Class&lt;T&gt; value;<br>      <span class="hljs-comment">// åŸç†å°±å¾ˆç®€å•äº†ï¼Œä»HashMapé‡Œæ‰¾å¯¹åº”çš„é”®å€¼ï¼Œæ‰¾åˆ°åˆ™è¿”å›ç±»å‹åˆ«åå¯¹åº”çš„Class</span><br>      <span class="hljs-keyword">if</span> (TYPE_ALIASES.containsKey(key)) &#123;<br>        value = (Class&lt;T&gt;) TYPE_ALIASES.get(key);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// æ‰¾ä¸åˆ°ï¼Œå†è¯•ç€å°†Stringç›´æ¥è½¬æˆClassã€</span><br>        <span class="hljs-comment">// è¿™æ ·æ€ªä¸å¾—æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨java.lang.Integerçš„æ–¹å¼å®šä¹‰</span><br>        value = (Class&lt;T&gt;) Resources.classForName(string);<br>      &#125;<br>      <span class="hljs-keyword">return</span> value;<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;Could not resolve type alias &#x27;&quot;</span> + string + <span class="hljs-string">&quot;&#x27;.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ³¨å†ŒåŒ…ä¸‹æ‰€æœ‰ç±»ï¼Œå¹¶ä¸ºå…¶å–ä¸€ä¸ªåˆ«å</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerAliases</span><span class="hljs-params">(String packageName)</span>&#123;<br>    registerAliases(packageName, Object.class);<br>  &#125; <br><br>  <span class="hljs-comment">// æ‰«æå¹¶æ³¨å†ŒåŒ…ä¸‹æ‰€æœ‰ç»§æ‰¿äºsuperTypeçš„ç±»å‹åˆ«å</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerAliases</span><span class="hljs-params">(String packageName, Class&lt;?&gt; superType)</span>&#123;<br>    ResolverUtil&lt;Class&lt;?&gt;&gt; resolverUtil = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResolverUtil</span>&lt;Class&lt;?&gt;&gt;();<br>    resolverUtil.find(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ResolverUtil</span>.IsA(superType), packageName);<br>    Set&lt;Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Class</span>&lt;?&gt;&gt;&gt; typeSet = resolverUtil.getClasses();<br>    <span class="hljs-keyword">for</span>(Class&lt;?&gt; type : typeSet)&#123;<br>      <span class="hljs-comment">// Ignore inner classes and interfaces (including package-info.java)</span><br>      <span class="hljs-comment">// Skip also inner classes. See issue #6</span><br>      <span class="hljs-keyword">if</span> (!type.isAnonymousClass() &amp;&amp; !type.isInterface() &amp;&amp; !type.isMemberClass()) &#123;<br>        registerAlias(type);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// æ³¨å†Œç±»å‹åˆ«å</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerAlias</span><span class="hljs-params">(Class&lt;?&gt; type)</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœæ²¡æœ‰ç±»å‹åˆ«åï¼Œç”¨Class.getSimpleNameæ¥æ³¨å†Œ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">alias</span> <span class="hljs-operator">=</span> type.getSimpleName();<br>    <span class="hljs-comment">// æˆ–è€…é€šè¿‡Aliasæ³¨è§£æ¥æ³¨å†Œ(Class.getAnnotation)</span><br>    <span class="hljs-type">Alias</span> <span class="hljs-variable">aliasAnnotation</span> <span class="hljs-operator">=</span> type.getAnnotation(Alias.class);<br>    <span class="hljs-keyword">if</span> (aliasAnnotation != <span class="hljs-literal">null</span>) &#123;<br>      alias = aliasAnnotation.value();<br>    &#125; <br>    registerAlias(alias, type);<br>  &#125; <br><br>  <span class="hljs-comment">// æ³¨å†Œç±»å‹åˆ«å</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerAlias</span><span class="hljs-params">(String alias, Class&lt;?&gt; value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (alias == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;The parameter alias cannot be null&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// issue #748</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> alias.toLowerCase(Locale.ENGLISH);<br>    <span class="hljs-comment">// å¦‚æœå·²ç»å­˜åœ¨keyäº†ï¼Œä¸”valueå’Œä¹‹å‰ä¸ä¸€è‡´ï¼ŒæŠ¥é”™</span><br>    <span class="hljs-keyword">if</span> (TYPE_ALIASES.containsKey(key) &amp;&amp; TYPE_ALIASES.get(key) != <span class="hljs-literal">null</span> &amp;&amp; !TYPE_ALIASES.get(key).equals(value)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;The alias &#x27;&quot;</span> + alias + <span class="hljs-string">&quot;&#x27; is already mapped to the value &#x27;&quot;</span> + TYPE_ALIASES.get(key).getName() + <span class="hljs-string">&quot;&#x27;.&quot;</span>);<br>    &#125;<br>    TYPE_ALIASES.put(key, value);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerAlias</span><span class="hljs-params">(String alias, String value)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      registerAlias(alias, Resources.classForName(value));<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;Error registering type alias &quot;</span>+alias+<span class="hljs-string">&quot; for &quot;</span>+value+<span class="hljs-string">&quot;. Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// è·å–æ‰€æœ‰ç±»å‹åˆ«åä¿¡æ¯</span><br>  <span class="hljs-keyword">public</span> Map&lt;String, Class&lt;?&gt;&gt; getTypeAliases() &#123;<br>    <span class="hljs-keyword">return</span> Collections.unmodifiableMap(TYPE_ALIASES);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="TypeHandler"><a href="#TypeHandler" class="headerlink" title="TypeHandler"></a>TypeHandler</h4><p>Â Â Â Â ç±»å‹å¤„ç†å™¨æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TypeHandler</span>&lt;T&gt; &#123;<br><br>  <span class="hljs-comment">// è®¾ç½®å‚æ•°</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// å–å¾—ç»“æœ,ä¾›æ™®é€šselectç”¨</span><br>  T <span class="hljs-title function_">getResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// å–å¾—ç»“æœ,ä¾›æ™®é€šselectç”¨</span><br>  T <span class="hljs-title function_">getResult</span><span class="hljs-params">(ResultSet rs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// å–å¾—ç»“æœ,ä¾›SPç”¨</span><br>  T <span class="hljs-title function_">getResult</span><span class="hljs-params">(CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="TypeReference"><a href="#TypeReference" class="headerlink" title="TypeReference"></a>TypeReference</h4><p>Â Â Â Â  Â 3.1æ–°åŠ çš„ç±»å‹å¼•ç”¨,ä¸ºäº†å¼•ç”¨ä¸€ä¸ªæ³›å‹ç±»å‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeReference</span>&lt;T&gt; &#123; <br>  <span class="hljs-comment">// å¼•ç”¨çš„åŸç”Ÿç±»å‹</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Type rawType; <br><br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">TypeReference</span><span class="hljs-params">()</span> &#123;<br>    rawType = getSuperclassTypeParameter(getClass());<br>  &#125;<br><br>  Type <span class="hljs-title function_">getSuperclassTypeParameter</span><span class="hljs-params">(Class&lt;?&gt; clazz)</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * class.getGenericSuperclass()</span><br><span class="hljs-comment">     * è¿”å›è¡¨ç¤ºæ­¤ç±»æ‰€è¡¨ç¤ºçš„å®ä½“(ç±»ã€æ¥å£ã€åŸºå…ƒç±»å‹æˆ–void)çš„ç›´æ¥çˆ¶ç±»çš„ç±»å‹ã€‚</span><br><span class="hljs-comment">     * å¦‚æœçˆ¶ç±»æ˜¯å‚æ•°åŒ–ç±»å‹ï¼ˆæ³›å‹ï¼‰ï¼Œåˆ™è¿”å›çš„ç±»å‹å¯¹è±¡å¿…é¡»å‡†ç¡®åæ˜ æºä»£ç ä¸­ä½¿ç”¨çš„å®é™…ç±»å‹å‚æ•°ã€‚</span><br><span class="hljs-comment">     * å¦‚æœä»¥å‰æ²¡æœ‰åˆ›å»ºè¿‡è¡¨ç¤ºçˆ¶ç±»çš„å‚æ•°åŒ–ç±»å‹ï¼Œåˆ™ä¼šåˆ›å»ºå®ƒ</span><br><span class="hljs-comment">     * æœ‰å…³å‚æ•°åŒ–ç±»å‹åˆ›å»ºè¿‡ç¨‹çš„è¯­ä¹‰ï¼Œè¯·å‚è§ParameterizedTypeçš„å£°æ˜ã€‚</span><br><span class="hljs-comment">     * å¦‚æœè¯¥ç±»è¡¨ç¤ºå¯¹è±¡ç±»ã€æ¥å£ã€åŸºæœ¬ç±»å‹æˆ–voidï¼Œåˆ™è¿”å›nullã€‚</span><br><span class="hljs-comment">     * å¦‚æœè¿™ä¸ªå¯¹è±¡ä»£è¡¨ä¸€ä¸ªæ•°ç»„ç±»ï¼Œåˆ™è¿”å›ä»£è¡¨è¯¥å¯¹è±¡ç±»çš„ç±»å¯¹è±¡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">Type</span> <span class="hljs-variable">genericSuperclass</span> <span class="hljs-operator">=</span> clazz.getGenericSuperclass();<br>    <span class="hljs-comment">// ä¸æ˜¯å‚æ•°åŒ–ç±»å‹ï¼Œçœ‹å…¶çˆ¶ç±»æ˜¯å¦æ˜¯å‚æ•°åŒ–ç±»å‹</span><br>    <span class="hljs-keyword">if</span> (genericSuperclass <span class="hljs-keyword">instanceof</span> Class) &#123;<br>      <span class="hljs-comment">// try to climb up the hierarchy until meet something useful</span><br>      <span class="hljs-comment">// ä¸€ç›´æ‰¾åˆ° TypeReference.class</span><br>      <span class="hljs-keyword">if</span> (TypeReference.class != genericSuperclass) &#123;<br>        <span class="hljs-keyword">return</span> getSuperclassTypeParameter(clazz.getSuperclass());<br>      &#125;<br>      <span class="hljs-comment">// å…¶æ‰€æœ‰çˆ¶ç±»éƒ½ä¸æ˜¯å‚æ•°åŒ–ç±»å‹ï¼ŒæŠ¥é”™</span><br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;&#x27;&quot;</span> + getClass() + <span class="hljs-string">&quot;&#x27; extends TypeReference but misses the type parameter. &quot;</span><br>        + <span class="hljs-string">&quot;Remove the extension or add a type parameter to it.&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// è·å–æ³›å‹ç±»å‹</span><br>    <span class="hljs-type">Type</span> <span class="hljs-variable">rawType</span> <span class="hljs-operator">=</span> ((ParameterizedType) genericSuperclass).getActualTypeArguments()[<span class="hljs-number">0</span>];<br>    <span class="hljs-comment">// TODO remove this when Reflector is fixed to return Types</span><br>    <span class="hljs-keyword">if</span> (rawType <span class="hljs-keyword">instanceof</span> ParameterizedType) &#123;<br>      rawType = ((ParameterizedType) rawType).getRawType();<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> rawType;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Type <span class="hljs-title function_">getRawType</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> rawType;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> rawType.toString();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BaseTypeHandler"><a href="#BaseTypeHandler" class="headerlink" title="BaseTypeHandler"></a>BaseTypeHandler</h4><p>Â Â Â Â ç±»å‹å¤„ç†å™¨çš„åŸºç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeReference</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TypeHandler</span>&lt;T&gt; &#123;<br>  <span class="hljs-keyword">protected</span> Configuration configuration;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setConfiguration</span><span class="hljs-params">(Configuration c)</span> &#123;<br>    <span class="hljs-built_in">this</span>.configuration = c;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-comment">// ç‰¹æ®Šæƒ…å†µï¼Œè®¾ç½®NULL</span><br>    <span class="hljs-keyword">if</span> (parameter == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (jdbcType == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// å¦‚æœæ²¡è®¾ç½®jdbcTypeï¼ŒæŠ¥é”™å•¦</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;JDBC requires that the JdbcType must be specified for all nullable parameters.&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// è®¾æˆNULL</span><br>        ps.setNull(i, jdbcType.TYPE_CODE);<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;Error setting null for parameter #&quot;</span> + i + <span class="hljs-string">&quot; with JdbcType &quot;</span> + jdbcType + <span class="hljs-string">&quot; . &quot;</span> +<br>                <span class="hljs-string">&quot;Try setting a different JdbcType for this parameter or a different jdbcTypeForNull configuration property. &quot;</span> +<br>                <span class="hljs-string">&quot;Cause: &quot;</span> + e, e);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// éNULLæƒ…å†µï¼Œæ€ä¹ˆè®¾è¿˜å¾—äº¤ç»™ä¸åŒçš„å­ç±»å®Œæˆ, setNonNullParameteræ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•</span><br>      setNonNullParameter(ps, i, parameter, jdbcType);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// æ ¹æ®åˆ—åè·å–ç»“æœ</span><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getNullableResult(rs, columnName);<br>    <span class="hljs-comment">// é€šè¿‡ResultSet.wasNullåˆ¤æ–­æ˜¯å¦ä¸ºNULL</span><br>    <span class="hljs-keyword">if</span> (rs.wasNull()) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-comment">// æ ¹æ®åˆ—ä¸‹æ ‡è·å–ç»“æœ</span><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getResult</span><span class="hljs-params">(ResultSet rs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getNullableResult(rs, columnIndex);<br>    <span class="hljs-keyword">if</span> (rs.wasNull()) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getResult</span><span class="hljs-params">(CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getNullableResult(cs, columnIndex);<br>    <span class="hljs-comment">// é€šè¿‡CallableStatement.wasNullåˆ¤æ–­æ˜¯å¦ä¸ºNULL</span><br>    <span class="hljs-keyword">if</span> (cs.wasNull()) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// éNULLæƒ…å†µï¼Œæ€ä¹ˆè®¾å‚æ•°è¿˜å¾—äº¤ç»™ä¸åŒçš„å­ç±»å®Œæˆ</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, T parameter, JdbcType jdbcType)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-comment">// ä»¥ä¸‹3ä¸ªæ–¹æ³•æ˜¯å–å¾—å¯èƒ½ä¸ºnullçš„ç»“æœï¼Œå…·ä½“äº¤ç»™å­ç±»å®Œæˆ</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> T <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span> <span class="hljs-keyword">throws</span> SQLException;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="UnknownTypeHandler"><a href="#UnknownTypeHandler" class="headerlink" title="UnknownTypeHandler"></a>UnknownTypeHandler</h4><p>Â Â Â Â åœ¨prepareéå¤åˆç±»å‹çš„keyæ—¶ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°å‚æ•°å¯¹åº”çš„TypeHandlerï¼Œåˆ™ä½¿ç”¨UnknownTypeHandlerï¼ˆMybatisä¸­æœ‰äº›æ‰¾ä¸åˆ° TypeHandlerçš„æƒ…å†µæ²¡æœ‰ä½¿ç”¨UnknownTypeHandlerï¼Œä½†æ˜¯å’ŒUnknownTypeHandlerçš„å¤„ç†æ–¹æ³•ä¸€æ ·â€”-ä½¿ç”¨ObjectTypeHandlerï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnknownTypeHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTypeHandler</span>&lt;Object&gt; &#123; <br><br>  <span class="hljs-comment">// Object ç±»å‹ å¤„ç†å™¨</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectTypeHandler</span> <span class="hljs-variable">OBJECT_TYPE_HANDLER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectTypeHandler</span>();<br><br>  <span class="hljs-comment">// TypeHandler æ³¨å†Œå™¨</span><br>  <span class="hljs-keyword">private</span> TypeHandlerRegistry typeHandlerRegistry;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnknownTypeHandler</span><span class="hljs-params">(TypeHandlerRegistry typeHandlerRegistry)</span> &#123;<br>    <span class="hljs-built_in">this</span>.typeHandlerRegistry = typeHandlerRegistry;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNonNullParameter</span><span class="hljs-params">(PreparedStatement ps, <span class="hljs-type">int</span> i, Object parameter, JdbcType jdbcType)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123; <br>    <span class="hljs-comment">// æ ¹æ®å‚æ•°å¯¹è±¡å’Œå…¶ JdbcType ï¼Œè·å–å¯¹åº”çš„TypeHandler</span><br>    <span class="hljs-type">TypeHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> resolveTypeHandler(parameter, jdbcType);<br>    handler.setParameter(ps, i, parameter, jdbcType);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> TypeHandler&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Object</span>&gt; resolveTypeHandler(Object parameter, JdbcType jdbcType) &#123;<br>    TypeHandler&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Object</span>&gt; handler; <br>    <span class="hljs-comment">// null å§”æ‰˜ç»™ OBJECT_TYPE_HANDLER å¤„ç†</span><br>    <span class="hljs-keyword">if</span> (parameter == <span class="hljs-literal">null</span>) &#123;<br>      handler = OBJECT_TYPE_HANDLER;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      handler = typeHandlerRegistry.getTypeHandler(parameter.getClass(), jdbcType);<br>      <span class="hljs-comment">// check if handler is null (issue #270)</span><br>      <span class="hljs-comment">// æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„ TypeHandlerï¼Œå§”æ‰˜ç»™OBJECT_TYPE_HANDLER å¤„ç†</span><br>      <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span> || handler <span class="hljs-keyword">instanceof</span> UnknownTypeHandler) &#123;<br>        handler = OBJECT_TYPE_HANDLER;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> handler;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(ResultSet rs, String columnName)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    TypeHandler&lt;?&gt; handler = resolveTypeHandler(rs, columnName);<br>    <span class="hljs-keyword">return</span> handler.getResult(rs, columnName);<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¹æ®ResultSet å’Œ åˆ—å æŸ¥æ‰¾ TypeHandler</span><br>  <span class="hljs-keyword">private</span> TypeHandler&lt;?&gt; resolveTypeHandler(ResultSet rs, String column) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Map&lt;String,Integer&gt; columnIndexLookup;<br>      columnIndexLookup = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String,Integer&gt;();<br>      <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">rsmd</span> <span class="hljs-operator">=</span> rs.getMetaData();<br>      <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> rsmd.getColumnCount();<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>; i &lt;= count; i++) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> rsmd.getColumnName(i);<br>        columnIndexLookup.put(name,i);<br>      &#125;<br>      <span class="hljs-type">Integer</span> <span class="hljs-variable">columnIndex</span> <span class="hljs-operator">=</span> columnIndexLookup.get(column);<br>      TypeHandler&lt;?&gt; handler = <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">if</span> (columnIndex != <span class="hljs-literal">null</span>) &#123;<br>        handler = resolveTypeHandler(rsmd, columnIndex);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span> || handler <span class="hljs-keyword">instanceof</span> UnknownTypeHandler) &#123;<br>        handler = OBJECT_TYPE_HANDLER;<br>      &#125;<br>      <span class="hljs-keyword">return</span> handler;<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;Error determining JDBC type for column &quot;</span> + column + <span class="hljs-string">&quot;.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> TypeHandler&lt;?&gt; resolveTypeHandler(ResultSetMetaData rsmd, Integer columnIndex) <span class="hljs-keyword">throws</span> SQLException &#123;<br>    TypeHandler&lt;?&gt; handler = <span class="hljs-literal">null</span>;<br>    <span class="hljs-type">JdbcType</span> <span class="hljs-variable">jdbcType</span> <span class="hljs-operator">=</span> safeGetJdbcTypeForColumn(rsmd, columnIndex);<br>    Class&lt;?&gt; javaType = safeGetClassForColumn(rsmd, columnIndex);<br>    <span class="hljs-comment">// æ ¹æ®javaType å’Œ jdbcTypeè·å– TypeHandler</span><br>    <span class="hljs-keyword">if</span> (javaType != <span class="hljs-literal">null</span> &amp;&amp; jdbcType != <span class="hljs-literal">null</span>) &#123;<br>      handler = typeHandlerRegistry.getTypeHandler(javaType, jdbcType);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (javaType != <span class="hljs-literal">null</span>) &#123;<br>      handler = typeHandlerRegistry.getTypeHandler(javaType);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (jdbcType != <span class="hljs-literal">null</span>) &#123;<br>      handler = typeHandlerRegistry.getTypeHandler(jdbcType);<br>    &#125;<br>    <span class="hljs-keyword">return</span> handler;<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¹æ®åˆ—ç´¢å¼•è¿”å›åˆ—çš„ JdbcType</span><br>  <span class="hljs-keyword">private</span> JdbcType <span class="hljs-title function_">safeGetJdbcTypeForColumn</span><span class="hljs-params">(ResultSetMetaData rsmd, Integer columnIndex)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> JdbcType.forCode(rsmd.getColumnType(columnIndex));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ ¹æ®åˆ—çš„ç´¢å¼•è¿”å›åˆ—å¯¹åº”Class</span><br>  <span class="hljs-keyword">private</span> Class&lt;?&gt; safeGetClassForColumn(ResultSetMetaData rsmd, Integer columnIndex) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> Resources.classForName(rsmd.getColumnClassName(columnIndex));<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getNullableResult</span><span class="hljs-params">(CallableStatement cs, <span class="hljs-type">int</span> columnIndex)</span><br>      <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-keyword">return</span> cs.getObject(columnIndex);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="å…¶ä»–TypeHandler-ç•¥"><a href="#å…¶ä»–TypeHandler-ç•¥" class="headerlink" title="å…¶ä»–TypeHandler ç•¥"></a>å…¶ä»–TypeHandler ç•¥</h4><h4 id="TypeHandlerRegistry"><a href="#TypeHandlerRegistry" class="headerlink" title="TypeHandlerRegistry"></a>TypeHandlerRegistry</h4><p>Â Â Â Â ç±»å‹å¤„ç†å™¨æ³¨å†Œæœº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeHandlerRegistry</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; JDBC_TYPE_HANDLER_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnumMap</span>&lt;JdbcType, TypeHandler&lt;?&gt;&gt;(JdbcType.class);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt; TYPE_HANDLER_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Type, Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt;&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TypeHandler&lt;Object&gt; UNKNOWN_TYPE_HANDLER = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnknownTypeHandler</span>(<span class="hljs-built_in">this</span>);<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt; ALL_TYPE_HANDLERS_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Class&lt;?&gt;, TypeHandler&lt;?&gt;&gt;(); <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">TypeHandlerRegistry</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// æ„é€ å‡½æ•°é‡Œæ³¨å†Œç³»ç»Ÿå†…ç½®çš„ç±»å‹å¤„ç†å™¨</span><br>    <span class="hljs-comment">// ä»¥ä¸‹æ˜¯ä¸ºå¤šä¸ªç±»å‹æ³¨å†Œåˆ°åŒä¸€ä¸ªhandler</span><br>    register(Boolean.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanTypeHandler</span>());<br>    register(<span class="hljs-type">boolean</span>.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanTypeHandler</span>());<br>    register(JdbcType.BOOLEAN, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanTypeHandler</span>());<br>    register(JdbcType.BIT, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BooleanTypeHandler</span>());<br><br>    register(Byte.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteTypeHandler</span>());<br>    register(<span class="hljs-type">byte</span>.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteTypeHandler</span>());<br>    register(JdbcType.TINYINT, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteTypeHandler</span>());<br><br>    register(Short.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShortTypeHandler</span>());<br>    register(<span class="hljs-type">short</span>.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShortTypeHandler</span>());<br>    register(JdbcType.SMALLINT, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShortTypeHandler</span>());<br><br>    register(Integer.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerTypeHandler</span>());<br>    register(<span class="hljs-type">int</span>.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerTypeHandler</span>());<br>    register(JdbcType.INTEGER, <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntegerTypeHandler</span>());<br><br>    register(Long.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongTypeHandler</span>());<br>    register(<span class="hljs-type">long</span>.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongTypeHandler</span>());<br><br>    register(Float.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FloatTypeHandler</span>());<br>    register(<span class="hljs-type">float</span>.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FloatTypeHandler</span>());<br>    register(JdbcType.FLOAT, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FloatTypeHandler</span>());<br><br>    register(Double.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleTypeHandler</span>());<br>    register(<span class="hljs-type">double</span>.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleTypeHandler</span>());<br>    register(JdbcType.DOUBLE, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleTypeHandler</span>());<br><br>    <span class="hljs-comment">// ä»¥ä¸‹æ˜¯ä¸ºåŒä¸€ä¸ªç±»å‹çš„å¤šç§å˜ç§æ³¨å†Œåˆ°å¤šä¸ªä¸åŒçš„handler</span><br>    register(String.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTypeHandler</span>());<br>    register(String.class, JdbcType.CHAR, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTypeHandler</span>());<br>    register(String.class, JdbcType.CLOB, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClobTypeHandler</span>());<br>    register(String.class, JdbcType.VARCHAR, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTypeHandler</span>());<br>    register(String.class, JdbcType.LONGVARCHAR, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClobTypeHandler</span>());<br>    register(String.class, JdbcType.NVARCHAR, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NStringTypeHandler</span>());<br>    register(String.class, JdbcType.NCHAR, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NStringTypeHandler</span>());<br>    register(String.class, JdbcType.NCLOB, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NClobTypeHandler</span>());<br>    register(JdbcType.CHAR, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTypeHandler</span>());<br>    register(JdbcType.VARCHAR, <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTypeHandler</span>());<br>    register(JdbcType.CLOB, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClobTypeHandler</span>());<br>    register(JdbcType.LONGVARCHAR, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClobTypeHandler</span>());<br>    register(JdbcType.NVARCHAR, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NStringTypeHandler</span>());<br>    register(JdbcType.NCHAR, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NStringTypeHandler</span>());<br>    register(JdbcType.NCLOB, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NClobTypeHandler</span>());<br><br>    register(Object.class, JdbcType.ARRAY, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayTypeHandler</span>());<br>    register(JdbcType.ARRAY, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayTypeHandler</span>());<br><br>    register(BigInteger.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigIntegerTypeHandler</span>());<br>    register(JdbcType.BIGINT, <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongTypeHandler</span>());<br><br>    register(BigDecimal.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimalTypeHandler</span>());<br>    register(JdbcType.REAL, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimalTypeHandler</span>());<br>    register(JdbcType.DECIMAL, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimalTypeHandler</span>());<br>    register(JdbcType.NUMERIC, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimalTypeHandler</span>());<br><br>    register(Byte[].class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteObjectArrayTypeHandler</span>());<br>    register(Byte[].class, JdbcType.BLOB, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlobByteObjectArrayTypeHandler</span>());<br>    register(Byte[].class, JdbcType.LONGVARBINARY, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlobByteObjectArrayTypeHandler</span>());<br>    register(<span class="hljs-type">byte</span>[].class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayTypeHandler</span>());<br>    register(<span class="hljs-type">byte</span>[].class, JdbcType.BLOB, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlobTypeHandler</span>());<br>    register(<span class="hljs-type">byte</span>[].class, JdbcType.LONGVARBINARY, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlobTypeHandler</span>());<br>    register(JdbcType.LONGVARBINARY, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlobTypeHandler</span>());<br>    register(JdbcType.BLOB, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlobTypeHandler</span>());<br><br>    register(Object.class, UNKNOWN_TYPE_HANDLER);<br>    register(Object.class, JdbcType.OTHER, UNKNOWN_TYPE_HANDLER);<br>    register(JdbcType.OTHER, UNKNOWN_TYPE_HANDLER);<br><br>    register(Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTypeHandler</span>());<br>    register(Date.class, JdbcType.DATE, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateOnlyTypeHandler</span>());<br>    register(Date.class, JdbcType.TIME, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeOnlyTypeHandler</span>());<br>    register(JdbcType.TIMESTAMP, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTypeHandler</span>());<br>    register(JdbcType.DATE, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateOnlyTypeHandler</span>());<br>    register(JdbcType.TIME, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeOnlyTypeHandler</span>());<br><br>    register(java.sql.Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlDateTypeHandler</span>());<br>    register(java.sql.Time.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlTimeTypeHandler</span>());<br>    register(java.sql.Timestamp.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlTimestampTypeHandler</span>());<br><br>    <span class="hljs-comment">// issue #273</span><br>    register(Character.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CharacterTypeHandler</span>());<br>    register(<span class="hljs-type">char</span>.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CharacterTypeHandler</span>());<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> TypeHandler&lt;?&gt; getMappingTypeHandler(Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TypeHandler</span>&lt;?&gt;&gt; handlerType) &#123;<br>    <span class="hljs-keyword">return</span> ALL_TYPE_HANDLERS_MAP.get(handlerType);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasTypeHandler</span><span class="hljs-params">(Class&lt;?&gt; javaType)</span> &#123;<br>    <span class="hljs-keyword">return</span> hasTypeHandler(javaType, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasTypeHandler</span><span class="hljs-params">(TypeReference&lt;?&gt; javaTypeReference)</span> &#123;<br>    <span class="hljs-keyword">return</span> hasTypeHandler(javaTypeReference, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasTypeHandler</span><span class="hljs-params">(Class&lt;?&gt; javaType, JdbcType jdbcType)</span> &#123;<br>    <span class="hljs-keyword">return</span> javaType != <span class="hljs-literal">null</span> &amp;&amp; getTypeHandler((Type) javaType, jdbcType) != <span class="hljs-literal">null</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasTypeHandler</span><span class="hljs-params">(TypeReference&lt;?&gt; javaTypeReference, JdbcType jdbcType)</span> &#123;<br>    <span class="hljs-keyword">return</span> javaTypeReference != <span class="hljs-literal">null</span> &amp;&amp; getTypeHandler(javaTypeReference, jdbcType) != <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> &lt;T&gt; TypeHandler&lt;T&gt; <span class="hljs-title function_">getTypeHandler</span><span class="hljs-params">(Class&lt;T&gt; type)</span> &#123;<br>    <span class="hljs-keyword">return</span> getTypeHandler((Type) type, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> &lt;T&gt; TypeHandler&lt;T&gt; <span class="hljs-title function_">getTypeHandler</span><span class="hljs-params">(TypeReference&lt;T&gt; javaTypeReference)</span> &#123;<br>    <span class="hljs-keyword">return</span> getTypeHandler(javaTypeReference, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> TypeHandler&lt;?&gt; getTypeHandler(JdbcType jdbcType) &#123;<br>    <span class="hljs-keyword">return</span> JDBC_TYPE_HANDLER_MAP.get(jdbcType);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> &lt;T&gt; TypeHandler&lt;T&gt; <span class="hljs-title function_">getTypeHandler</span><span class="hljs-params">(Class&lt;T&gt; type, JdbcType jdbcType)</span> &#123;<br>    <span class="hljs-keyword">return</span> getTypeHandler((Type) type, jdbcType);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> &lt;T&gt; TypeHandler&lt;T&gt; <span class="hljs-title function_">getTypeHandler</span><span class="hljs-params">(TypeReference&lt;T&gt; javaTypeReference, JdbcType jdbcType)</span> &#123;<br>    <span class="hljs-keyword">return</span> getTypeHandler(javaTypeReference.getRawType(), jdbcType);<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¹æ®javaç±»å‹å’Œjdbcç±»å‹è·å– TypeHandler</span><br>  <span class="hljs-keyword">private</span> &lt;T&gt; TypeHandler&lt;T&gt; <span class="hljs-title function_">getTypeHandler</span><span class="hljs-params">(Type type, JdbcType jdbcType)</span> &#123;<br>    Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; jdbcHandlerMap = TYPE_HANDLER_MAP.get(type);<br>    TypeHandler&lt;?&gt; handler = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (jdbcHandlerMap != <span class="hljs-literal">null</span>) &#123;<br>      handler = jdbcHandlerMap.get(jdbcType);<br>      <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) &#123;<br>        handler = jdbcHandlerMap.get(<span class="hljs-literal">null</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// type ä¸º æšä¸¾ç±»å‹</span><br>    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span> &amp;&amp; type != <span class="hljs-literal">null</span> &amp;&amp; type <span class="hljs-keyword">instanceof</span> Class &amp;&amp; Enum.class.isAssignableFrom((Class&lt;?&gt;) type)) &#123;<br>      handler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnumTypeHandler</span>((Class&lt;?&gt;) type);<br>    &#125;<br>    <span class="hljs-comment">// type drives generics here</span><br>    <span class="hljs-keyword">return</span> (TypeHandler&lt;T&gt;) handler;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> TypeHandler&lt;Object&gt; <span class="hljs-title function_">getUnknownTypeHandler</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> UNKNOWN_TYPE_HANDLER;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(JdbcType jdbcType, TypeHandler&lt;?&gt; handler)</span> &#123;<br>    JDBC_TYPE_HANDLER_MAP.put(jdbcType, handler);<br>  &#125; <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// REGISTER INSTANCE</span><br>  <span class="hljs-comment">//</span><br><br>  <span class="hljs-comment">// Only handler</span><br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(TypeHandler&lt;T&gt; typeHandler)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">mappedTypeFound</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">MappedTypes</span> <span class="hljs-variable">mappedTypes</span> <span class="hljs-operator">=</span> typeHandler.getClass().getAnnotation(MappedTypes.class);<br>    <span class="hljs-keyword">if</span> (mappedTypes != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (Class&lt;?&gt; handledType : mappedTypes.value()) &#123;<br>        register(handledType, typeHandler);<br>        mappedTypeFound = <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-comment">// @since 3.1.0 - try to auto-discover the mapped type </span><br>    <span class="hljs-comment">// æ³¨å†Œç³»ç»Ÿå†…ç½®çš„å®ç°äº† TypeReference çš„ TypeHandler</span><br>    <span class="hljs-keyword">if</span> (!mappedTypeFound &amp;&amp; typeHandler <span class="hljs-keyword">instanceof</span> TypeReference) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        TypeReference&lt;T&gt; typeReference = (TypeReference&lt;T&gt;) typeHandler;<br>        register(typeReference.getRawType(), typeHandler);<br>        mappedTypeFound = <span class="hljs-literal">true</span>;<br>      &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        <span class="hljs-comment">// maybe users define the TypeReference with a different type and are not assignable, so just ignore it</span><br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!mappedTypeFound) &#123;<br>      register((Class&lt;T&gt;) <span class="hljs-literal">null</span>, typeHandler);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// java type + handler</span><br><br>  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Class&lt;T&gt; javaType, TypeHandler&lt;? extends T&gt; typeHandler)</span> &#123;<br>    register((Type) javaType, typeHandler);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Type javaType, TypeHandler&lt;? extends T&gt; typeHandler)</span> &#123;<br>    <span class="hljs-comment">// MappedJdbcTypesçš„æ³¨è§£çš„ç”¨æ³•å¯å‚è€ƒæµ‹è¯•ç±»StringTrimmingTypeHandler</span><br>    <span class="hljs-comment">// å¦å¤–åœ¨æ–‡æ¡£ä¸­ä¹Ÿæåˆ°ï¼Œè¿™æ˜¯æ‰©å±•è‡ªå®šä¹‰çš„typeHandleræ‰€éœ€è¦çš„</span><br>    <span class="hljs-comment">// (ä½ å¯ä»¥é‡å†™ç±»å‹å¤„ç†å™¨æˆ–åˆ›å»ºä½ è‡ªå·±çš„ç±»å‹å¤„ç†å™¨æ¥å¤„ç†ä¸æ”¯æŒçš„æˆ–éæ ‡å‡†çš„ç±»å‹)</span><br>    <span class="hljs-type">MappedJdbcTypes</span> <span class="hljs-variable">mappedJdbcTypes</span> <span class="hljs-operator">=</span> typeHandler.getClass().getAnnotation(MappedJdbcTypes.class);<br>    <span class="hljs-keyword">if</span> (mappedJdbcTypes != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (JdbcType handledJdbcType : mappedJdbcTypes.value()) &#123;<br>        register(javaType, handledJdbcType, typeHandler);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (mappedJdbcTypes.includeNullJdbcType()) &#123;<br>        register(javaType, <span class="hljs-literal">null</span>, typeHandler);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      register(javaType, <span class="hljs-literal">null</span>, typeHandler);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(TypeReference&lt;T&gt; javaTypeReference, TypeHandler&lt;? extends T&gt; handler)</span> &#123;<br>    register(javaTypeReference.getRawType(), handler);<br>  &#125; <br><br>  <span class="hljs-comment">// java type + jdbc type + handler</span><br><br>  <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Class&lt;T&gt; type, JdbcType jdbcType, TypeHandler&lt;? extends T&gt; handler)</span> &#123;<br>    register((Type) type, jdbcType, handler);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Type javaType, JdbcType jdbcType, TypeHandler&lt;?&gt; handler)</span> &#123;<br>    <span class="hljs-keyword">if</span> (javaType != <span class="hljs-literal">null</span>) &#123;<br>      Map&lt;JdbcType, TypeHandler&lt;?&gt;&gt; map = TYPE_HANDLER_MAP.get(javaType);<br>      <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">null</span>) &#123;<br>        map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;JdbcType, TypeHandler&lt;?&gt;&gt;();<br>        TYPE_HANDLER_MAP.put(javaType, map);<br>      &#125;<br>      map.put(jdbcType, handler);<br>    &#125; <br>    <span class="hljs-comment">// TypeHandler å…¨é›† </span><br>    ALL_TYPE_HANDLERS_MAP.put(handler.getClass(), handler); <br>  &#125; <br><br>  <span class="hljs-comment">//</span><br>  <span class="hljs-comment">// REGISTER CLASS</span><br>  <span class="hljs-comment">//</span><br><br>  <span class="hljs-comment">// Only handler type</span><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Class&lt;?&gt; typeHandlerClass)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">mappedTypeFound</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-type">MappedTypes</span> <span class="hljs-variable">mappedTypes</span> <span class="hljs-operator">=</span> typeHandlerClass.getAnnotation(MappedTypes.class);<br>    <span class="hljs-keyword">if</span> (mappedTypes != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (Class&lt;?&gt; javaTypeClass : mappedTypes.value()) &#123;<br>        register(javaTypeClass, typeHandlerClass);<br>        mappedTypeFound = <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!mappedTypeFound) &#123;<br>      register(getInstance(<span class="hljs-literal">null</span>, typeHandlerClass));<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// java type + handler type</span><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Class&lt;?&gt; javaTypeClass, Class&lt;?&gt; typeHandlerClass)</span> &#123;<br>    register(javaTypeClass, getInstance(javaTypeClass, typeHandlerClass));<br>  &#125; <br><br>  <span class="hljs-comment">// java type + jdbc type + handler type</span><br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(Class&lt;?&gt; javaTypeClass, JdbcType jdbcType, Class&lt;?&gt; typeHandlerClass)</span> &#123;<br>    register(javaTypeClass, jdbcType, getInstance(javaTypeClass, typeHandlerClass));<br>  &#125; <br><br>  <span class="hljs-comment">// Construct a handler (used also from Builders)</span><br><br>  <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>  <span class="hljs-keyword">public</span> &lt;T&gt; TypeHandler&lt;T&gt; <span class="hljs-title function_">getInstance</span><span class="hljs-params">(Class&lt;?&gt; javaTypeClass, Class&lt;?&gt; typeHandlerClass)</span> &#123;<br>    <span class="hljs-keyword">if</span> (javaTypeClass != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// å†…ç½®çš„ TypeHandler ä¸­åªæœ‰ EnumTypeHandler å’Œ EnumOrdinalTypeHandler</span><br>        <span class="hljs-comment">// æœ‰è¿™ä¸ªæ„é€ å‡½æ•°</span><br>        Constructor&lt;?&gt; c = typeHandlerClass.getConstructor(Class.class);<br>        <span class="hljs-keyword">return</span> (TypeHandler&lt;T&gt;) c.newInstance(javaTypeClass);<br>      &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException ignored) &#123;<br>        <span class="hljs-comment">// ignored</span><br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;Failed invoking constructor for handler &quot;</span> + typeHandlerClass, e);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Constructor&lt;?&gt; c = typeHandlerClass.getConstructor();<br>      <span class="hljs-keyword">return</span> (TypeHandler&lt;T&gt;) c.newInstance();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeException</span>(<span class="hljs-string">&quot;Unable to find a usable constructor for &quot;</span> + typeHandlerClass, e);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Â Â Â Â è¿˜æœ‰ä¸€ä¸ª<code>SimpleTypeRegistry</code>ç»™å¿˜äº†ï¼Œè¯»è€…å¯ä»¥è‡ªå·±å»çœ‹çœ‹ä»£ç ï¼ŒåŠŸèƒ½æ˜¯åˆ¤æ–­classæ˜¯å¦ä¸ºknown common type</p>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringBootè‡ªåŠ¨é…ç½®æµ…æ</title>
    <link href="/2023/06/11/Spring/SpringBoot/SpringBoot%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%B5%85%E6%9E%90/"/>
    <url>/2023/06/11/Spring/SpringBoot/SpringBoot%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%B5%85%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â ä¹‹å‰æˆ‘ä¸€ç›´ä»¥ä¸ºSpringBootçš„è‡ªåŠ¨é…ç½®ç”± <code>@EnableAutoConfiguration</code>å¼€å¯çš„ï¼Œåœ¨çœ‹å®Œæºç åï¼Œå‘ç°æ˜¯æˆ‘å¤©çœŸäº†ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥æ ¹æ®SpringBootå’ŒSpringçš„æºç æ¥ä¸€æ¢ç©¶ç«Ÿï¼ˆä¸ºäº†è¡Œæ–‡æ–¹ä¾¿ï¼Œä¸‹é¢æˆ‘ä¼šæŒ‰ç…§SpringBootå¯åŠ¨çš„æµç¨‹æ¥è¿›è¡Œè®²è§£ï¼Œå…¶å®æˆ‘åœ¨ç ”ç©¶çš„æ—¶å€™æ˜¯é€†æ¨çš„ï¼‰</p><h3 id="SpringBootApplication"><a href="#SpringBootApplication" class="headerlink" title="@SpringBootApplication"></a>@SpringBootApplication</h3><p>é¦–å…ˆçœ‹çœ‹SpringBootåº”ç”¨ç¨‹åºçš„æ ‡å¿—æ€§æ³¨è§£ <code>@SpringBootApplication</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-meta">@SpringBootConfiguration</span><br><span class="hljs-meta">@EnableAutoConfiguration</span><br><span class="hljs-meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="hljs-meta">        @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SpringBootApplication &#123; <br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>é™¤å¼€ä¸€äº›å¸¸ç”¨çš„æ³¨è§£å¤–ï¼Œå‘ç°è¿™ä¸ªæ³¨è§£åˆç”± <code>@SpringBootConfiguration ã€@EnableAutoConfigurationã€@ComponentScan</code> ä¸‰ä¸ªæ³¨è§£ä¿®é¥°</p><p>ç‚¹å¼€<code>@SpringBootConfiguration</code>ï¼Œå‘ç°å…¶ç”± <code>@Configuration</code>æ³¨è§£ä¿®é¥°ï¼Œè¿™è¡¨ç¤ºSpringBootåº”ç”¨ç¨‹åºçš„å…¥å£ç±»æ˜¯ä¸€ä¸ªé…ç½®ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(&#123;ElementType.TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Indexed</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SpringBootConfiguration &#123;<br>    <span class="hljs-meta">@AliasFor(</span><br><span class="hljs-meta">        annotation = Configuration.class</span><br><span class="hljs-meta">    )</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">proxyBeanMethods</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åå°±æ˜¯ä»¤äººæœŸå¾…çš„  <code>@EnableAutoConfiguration</code>ï¼Œçœ‹åˆ°äº†<code> @Import</code> å’Œ<br><code>@AutoConfigurationPackage</code>ï¼ˆè¿™ä¸ªæ³¨è§£é‡Œé¢ä¹Ÿæ˜¯ä¸€ä¸ª <code>@Import</code>ï¼‰ï¼Œ<code>@Import</code>æ³¨è§£çš„ä½œç”¨åç»­å†è¯´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-meta">@AutoConfigurationPackage</span><br><span class="hljs-meta">@Import(AutoConfigurationImportSelector.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableAutoConfiguration &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Environment property that can be used to override when auto-configuration is</span><br><span class="hljs-comment">     * enabled.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">ENABLED_OVERRIDE_PROPERTY</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;spring.boot.enableautoconfiguration&quot;</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Exclude specific auto-configuration classes such that they will never be applied.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the classes to exclude</span><br><span class="hljs-comment">     */</span><br>    Class&lt;?&gt;[] exclude() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Exclude specific auto-configuration class names such that they will never be</span><br><span class="hljs-comment">     * applied.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the class names to exclude</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@since</span> 1.3.0</span><br><span class="hljs-comment">     */</span><br>    String[] excludeName() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>&#125; <br><br><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-meta">@Import(AutoConfigurationPackages.Registrar.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> AutoConfigurationPackage &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Base packages that should be registered with &#123;<span class="hljs-doctag">@link</span> AutoConfigurationPackages&#125;.</span><br><span class="hljs-comment">     * &lt;p&gt;</span><br><span class="hljs-comment">     * Use &#123;<span class="hljs-doctag">@link</span> #basePackageClasses&#125; for a type-safe alternative to String-based package</span><br><span class="hljs-comment">     * names.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the back package names</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@since</span> 2.3.0</span><br><span class="hljs-comment">     */</span><br>    String[] basePackages() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Type-safe alternative to &#123;<span class="hljs-doctag">@link</span> #basePackages&#125; for specifying the packages to be</span><br><span class="hljs-comment">     * registered with &#123;<span class="hljs-doctag">@link</span> AutoConfigurationPackages&#125;.</span><br><span class="hljs-comment">     * &lt;p&gt;</span><br><span class="hljs-comment">     * Consider creating a special no-op marker class or interface in each package that</span><br><span class="hljs-comment">     * serves no purpose other than being referenced by this attribute.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the base package classes</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@since</span> 2.3.0</span><br><span class="hljs-comment">     */</span><br>    Class&lt;?&gt;[] basePackageClasses() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€å <code>@ComponentScan</code> åœ¨è¿™é‡Œåªæä¾›äº†ä¸¤ä¸ª excludeFilterï¼Œè¿™ä¸ªåœ¨ä¹‹ååŒ…æ‰«æçš„æ—¶å€™ä¼šç”¨æ¥æ’é™¤ç›¸åº”çš„ Configuration ç±»</p><h3 id="SpringApplication-run"><a href="#SpringApplication-run" class="headerlink" title="SpringApplication.run"></a>SpringApplication.run</h3><p>Â Â Â Â ä¸‹é¢æˆ‘ä»¬è·Ÿç€ <code>SpringApplication.run(Application.class, args);</code>çš„æ‰§è¡Œæµç¨‹å¤§è‡´çœ‹ä¸€ä¸‹SpringBootå®¹å™¨å¯åŠ¨çš„è¿‡ç¨‹ä¸­åšäº†å“ªäº›ä¸è‡ªåŠ¨é…ç½®ç›¸å…³çš„æ“ä½œ</p><p>ä¸€ç›´ç‚¹ï¼Œåˆ°è¾¾ <code>public ConfigurableApplicationContext run(String... args)</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">StopWatch</span> <span class="hljs-variable">stopWatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StopWatch</span>();<br>        ...<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ApplicationArguments</span> <span class="hljs-variable">applicationArguments</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultApplicationArguments</span>(args);<br>            <span class="hljs-type">ConfigurableEnvironment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.prepareEnvironment(listeners, bootstrapContext, applicationArguments);<br>            <span class="hljs-built_in">this</span>.configureIgnoreBeanInfo(environment);<br>            <span class="hljs-type">Banner</span> <span class="hljs-variable">printedBanner</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.printBanner(environment); <br>            <span class="hljs-comment">// åˆ›å»ºä¸Šä¸‹æ–‡</span><br>            context = <span class="hljs-built_in">this</span>.createApplicationContext();<br>            context.setApplicationStartup(<span class="hljs-built_in">this</span>.applicationStartup);<br>            <span class="hljs-built_in">this</span>.prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);<br>            <span class="hljs-comment">// refreshContextå…¶å®å°±æ˜¯è°ƒç”¨çš„ AbstractApplicationContextçš„refresh</span><br>            <span class="hljs-built_in">this</span>.refreshContext(context);<br>            <span class="hljs-built_in">this</span>.afterRefresh(context, applicationArguments);<br>            stopWatch.stop();<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logStartupInfo) &#123;<br>                (<span class="hljs-keyword">new</span> <span class="hljs-title class_">StartupInfoLogger</span>(<span class="hljs-built_in">this</span>.mainApplicationClass)).logStarted(<span class="hljs-built_in">this</span>.getApplicationLog(), stopWatch);<br>            &#125;<br><br>            listeners.started(context);<br>            <span class="hljs-built_in">this</span>.callRunners(context, applicationArguments);<br>        &#125; <span class="hljs-keyword">catch</span> (Throwable var10) &#123;<br>            <span class="hljs-built_in">this</span>.handleRunFailure(context, var10, listeners);<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(var10);<br>        &#125;<br><br>        ...<br></code></pre></td></tr></table></figure><h4 id="this-createApplicationContext"><a href="#this-createApplicationContext" class="headerlink" title="this.createApplicationContext"></a>this.createApplicationContext</h4><p>æ ¹æ®ä»£ç å¯ä»¥çœ‹åˆ°åˆ›å»ºä¸Šä¸‹æ–‡æ˜¯å§”æ‰˜ç»™ <code>applicationContextFactory </code>æ¥å®Œæˆçš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> ConfigurableApplicationContext <span class="hljs-title function_">createApplicationContext</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.applicationContextFactory.create(<span class="hljs-built_in">this</span>.webApplicationType);<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œè¿™ä¸ª <code>applicationContextFactory</code>åœ¨åˆå§‹åŒ–æ—¶ èµ‹å€¼ä¸º <code>ApplicationContextFactory.DEFAULT</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ApplicationContextFactory</span> <span class="hljs-variable">DEFAULT</span> <span class="hljs-operator">=</span> (webApplicationType) -&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">switch</span> (webApplicationType) &#123;<br>            <span class="hljs-keyword">case</span> SERVLET:<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigServletWebServerApplicationContext</span>();<br>            <span class="hljs-keyword">case</span> REACTIVE:<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigReactiveWebServerApplicationContext</span>();<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>();<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception var2) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;Unable create a default ApplicationContext instance, you may need a custom ApplicationContextFactory&quot;</span>, var2);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>è€Œæ ¹æ® <code>ApplicationContextFactory.DEFAULT</code> çš„ä»£ç å¯ä»¥çœ‹åˆ°æ˜¯æ ¹æ® <code>webApplicationType </code>æ¥åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡</p><p>å…·ä½“çš„ç»†èŠ‚ä¸è°ˆï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦ç›´åˆ°è¿™ä¸‰ä¸ªåº”ç”¨ä¸Šä¸‹æ–‡çš„åˆå§‹åŒ–æ–¹æ³•ä¸­éƒ½æœ‰è¿™ä¸€è¡Œ</p><p><code>this.reader = new AnnotatedBeanDefinitionReader(this);</code></p><p>ç‚¹è¿›å»çœ‹çœ‹ï¼Œå‘ç°åœ¨ <code>AnnotatedBeanDefinitionReader</code>åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨äº† <code>AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry);</code></p><p>çœ‹æ–¹æ³•åçŒœæµ‹è¿™ä¸ªæ–¹æ³•åº”è¯¥æ˜¯æ³¨å†Œäº†ä¸€äº›é…ç½®å¤„ç†å™¨</p><p>å†ç‚¹è¿›å»çœ‹çœ‹ï¼Œä¸€ç›´åˆ° <code> public static Set&lt;BeanDefinitionHolder&gt; registerAnnotationConfigProcessors(BeanDefinitionRegistry registry, @Nullable Object source)</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title function_">registerAnnotationConfigProcessors</span><span class="hljs-params">(BeanDefinitionRegistry registry, <span class="hljs-meta">@Nullable</span> Object source)</span> &#123;<br>        ...<br><br>        Set&lt;BeanDefinitionHolder&gt; beanDefs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>(<span class="hljs-number">8</span>);<br>        RootBeanDefinition def;<br>        <span class="hljs-keyword">if</span> (!registry.containsBeanDefinition(<span class="hljs-string">&quot;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&quot;</span>)) &#123; <br>            <span class="hljs-comment">// è¿™é‡Œçš„ ConfigurationClassPostProcessor æ˜¯å’±ä»¬ä»Šå¤©çš„ä¸»è§’</span><br>            def = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(ConfigurationClassPostProcessor.class);<br>            def.setSource(source);<br>            <span class="hljs-comment">// å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯æŠŠ ConfigurationClassPostProcessor æ³¨å†Œåˆ°äº†IOCå®¹å™¨ä¸­</span><br>            <span class="hljs-comment">// ä¹Ÿå°±æ˜¯å®¹å™¨åˆšåˆ›å»ºæ—¶å°±å¾€IOCå®¹å™¨ä¸­å¡äº†å¥½å‡ ä¸ª BeanFactoryPostProcessor</span><br>            beanDefs.add(registerPostProcessor(registry, def, <span class="hljs-string">&quot;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&quot;</span>));<br>        &#125;<br><br>        ...<br><br>        <span class="hljs-keyword">return</span> beanDefs;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="this-prepareContext"><a href="#this-prepareContext" class="headerlink" title="this.prepareContext"></a>this.prepareContext</h4><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹  <code>this.prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</code></p><p>æœ¬æ–‡æˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>this.load(context, sources.toArray(new Object[0]));</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">(ApplicationContext context, Object[] sources)</span> &#123;<br>    <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>        logger.debug(<span class="hljs-string">&quot;Loading source &quot;</span> + StringUtils.arrayToCommaDelimitedString(sources));<br>    &#125;<br><br>    <span class="hljs-type">BeanDefinitionLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.createBeanDefinitionLoader(<span class="hljs-built_in">this</span>.getBeanDefinitionRegistry(context), sources);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.beanNameGenerator != <span class="hljs-literal">null</span>) &#123;<br>        loader.setBeanNameGenerator(<span class="hljs-built_in">this</span>.beanNameGenerator);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.resourceLoader != <span class="hljs-literal">null</span>) &#123;<br>        loader.setResourceLoader(<span class="hljs-built_in">this</span>.resourceLoader);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.environment != <span class="hljs-literal">null</span>) &#123;<br>        loader.setEnvironment(<span class="hljs-built_in">this</span>.environment);<br>    &#125;<br><br>    loader.load();<br>&#125;<br></code></pre></td></tr></table></figure><p>å‘ç°è¿™ä¸ªæ–¹æ³•é‡Œå…ˆæ˜¯å®šä¹‰äº†ä¸€ä¸ª <code>BeanDefinitionLoader</code> ï¼Œç„¶åé€šè¿‡ <code>BeanDefinitionLoader.load()</code>è¿›è¡Œload</p><p>ç„¶åå†ç‚¹ç‚¹ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">(Object source)</span> &#123;<br>    Assert.notNull(source, <span class="hljs-string">&quot;Source must not be null&quot;</span>);<br>    <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> Class) &#123;<br>        <span class="hljs-built_in">this</span>.load((Class)source);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> Resource) &#123;<br>        <span class="hljs-built_in">this</span>.load((Resource)source);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> Package) &#123;<br>        <span class="hljs-built_in">this</span>.load((Package)source);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> CharSequence) &#123;<br>        <span class="hljs-built_in">this</span>.load((CharSequence)source);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Invalid source type &quot;</span> + source.getClass());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ ¹æ® sourceçš„ç±»å‹é€‰æ‹©äº†ä¸åŒçš„æ–¹æ³•</p><p>è®©æˆ‘ä»¬å›åˆ° <code>SpringApplication.run(Application.class, args);</code>åœ¨æ„é€ æ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹ä¸­çœ‹åˆ°äº†è¿™æ ·ä¸€ä¸ªæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ConfigurableApplicationContext <span class="hljs-title function_">run</span><span class="hljs-params">(Class&lt;?&gt;[] primarySources, String[] args)</span> &#123;<br>    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(primarySources)).run(args);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°è¿™æ˜¯å°† <code>Application.class</code>ä½œä¸ºå‚æ•°ä¼ ç»™äº† <code>SpringApplication</code></p><p>è€Œåœ¨ <code>SpringApplication</code>çš„æ„é€ æ–¹æ³•ä¸­æœ‰è¿™ä¹ˆä¸€è¡Œä»£ç  <code>this.primarySources = new LinkedHashSet(Arrays.asList(primarySources));</code></p><p>æˆ‘ä»¬å†å›æ¥ï¼Œçœ‹çœ‹ä¼ ç»™ <code>this.load(context, sources.toArray(new Object[0]));</code>çš„sourcesæœ‰å“ªäº›å…ƒç´ </p><p>æ ¹æ®ä¸Šä¸‹æ–‡çŸ¥é“  <code>Set&lt;Object&gt; sources = this.getAllSources();</code></p><p>ç‚¹è¿›å»çœ‹çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Set&lt;Object&gt; <span class="hljs-title function_">getAllSources</span><span class="hljs-params">()</span> &#123;<br>    Set&lt;Object&gt; allSources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>();<br>    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(<span class="hljs-built_in">this</span>.primarySources)) &#123;<br>        allSources.addAll(<span class="hljs-built_in">this</span>.primarySources);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(<span class="hljs-built_in">this</span>.sources)) &#123;<br>        allSources.addAll(<span class="hljs-built_in">this</span>.sources);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> Collections.unmodifiableSet(allSources);<br>&#125;<br></code></pre></td></tr></table></figure><p>å‘ç° <code>primarySources </code>åœ¨sourcesä¸­ï¼Œæ‰€ä»¥çŸ¥é“ Application.class ä¹Ÿè¢«loadäº†</p><p>ç‚¹è¿› <code>load(Class&lt;?&gt; source)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">load</span><span class="hljs-params">(Class&lt;?&gt; source)</span> &#123; <br>    <span class="hljs-comment">// è¿™ä¸ªæ¡ä»¶ä¸€çœ‹å°±ä¸æ»¡è¶³</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isGroovyPresent() &amp;&amp; GroovyBeanDefinitionSource.class.isAssignableFrom(source)) &#123;<br>        <span class="hljs-type">GroovyBeanDefinitionSource</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> (GroovyBeanDefinitionSource)BeanUtils.instantiateClass(source, GroovyBeanDefinitionSource.class);<br>        ((GroovyBeanDefinitionReader)<span class="hljs-built_in">this</span>.groovyReader).beans(loader.getBeans());<br>    &#125;<br><br>    <span class="hljs-comment">// è¿™ä¸ªæ¡ä»¶æˆç«‹</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.isEligible(source)) &#123;<br>        <span class="hljs-comment">// åœ¨è¿™é‡Œå°† SpringBootåº”ç”¨ç¨‹åºçš„å…¥å£ç±»æ³¨å†Œåˆ°äº† IOC å®¹å™¨ä¸­</span><br>        <span class="hljs-comment">// æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±æ·±å…¥äº†è§£æˆ–è€…debugä¸€ä¸‹çœ‹çœ‹æ˜¯ä¸æ˜¯è¿™æ ·</span><br>        <span class="hljs-built_in">this</span>.annotatedReader.register(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;source&#125;);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“äº†åº”ç”¨ç¨‹åºä¸Šä¸‹æ–‡åœ¨åˆ›å»ºçš„æ—¶å€™å°±å‘IOCå®¹å™¨ä¸­æ³¨å†Œäº†å‡ ä¸ª <code>BeanFactoryPostProcessor</code>ï¼Œå…¶ä¸­åŒ…æ‹¬æˆ‘ä»¬ä»Šå¤©çš„ä¸»è§’ <code>ConfigurationClassPostProcessor</code>ï¼Œå¹¶ä¸”åœ¨<code>this.prepareContext</code>å°†SpringBootåº”ç”¨ç¨‹åºçš„å…¥å£ç±»ä¹Ÿæ³¨å†Œè¿›äº†IOCå®¹å™¨ä¸­</p><h4 id="this-refreshContext"><a href="#this-refreshContext" class="headerlink" title="this.refreshContext"></a>this.refreshContext</h4><p>Â Â Â Â ä¸‹é¢å°±è¿›å…¥åˆ°äº† AbstractApplicationContext ä¸­çš„refresh æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;<br><span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;<br><span class="hljs-type">StartupStep</span> <span class="hljs-variable">contextRefresh</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.context.refresh&quot;</span>);<br><br><span class="hljs-comment">// Prepare this context for refreshing.</span><br><span class="hljs-comment">// å‡†å¤‡åˆ·æ–°çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ</span><br>prepareRefresh();<br><br><span class="hljs-comment">// Tell the subclass to refresh the internal bean factory.</span><br><span class="hljs-comment">// åˆå§‹åŒ–BeanFactoryï¼Œå¹¶è¿›è¡ŒXMLæ–‡ä»¶è¯»å–</span><br><span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> obtainFreshBeanFactory();<br><br><span class="hljs-comment">// Prepare the bean factory for use in this context.</span><br><span class="hljs-comment">// å¯¹BeanFactoryè¿›è¡Œå„ç§åŠŸèƒ½ä¼˜åŒ–</span><br>prepareBeanFactory(beanFactory);<br><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-comment">// Allows post-processing of the bean factory in context subclasses.</span><br><span class="hljs-comment">// å­ç±»è¦†ç›–æ–¹æ³•åšé¢å¤–çš„å¤„ç†</span><br>postProcessBeanFactory(beanFactory);<br><br><span class="hljs-type">StartupStep</span> <span class="hljs-variable">beanPostProcess</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.context.beans.post-process&quot;</span>);<br><span class="hljs-comment">// Invoke factory processors registered as beans in the context.</span><br><span class="hljs-comment">// æ¿€æ´»å„ç§BeanFactoryå¤„ç†å™¨</span><br>            invokeBeanFactoryPostProcessors(beanFactory);<br><br><span class="hljs-comment">// Register bean processors that intercept bean creation.</span><br><span class="hljs-comment">// æ³¨å†Œæ‹¦æˆªBeanåˆ›å»ºçš„Beanå¤„ç†å™¨ï¼Œè¿™é‡Œåªæ˜¯æ³¨å†Œï¼ŒçœŸæ­£çš„è°ƒç”¨æ˜¯åœ¨getBeançš„æ—¶å€™</span><br>registerBeanPostProcessors(beanFactory);<br>beanPostProcess.end();<br><br><span class="hljs-comment">// Initialize message source for this context.</span><br><span class="hljs-comment">// ä¸ºä¸Šä¸‹æ–‡åˆå§‹åŒ–Messageæºï¼Œå³ä¸åŒè¯­è¨€çš„æ¶ˆæ¯ä½“ï¼Œå›½é™…åŒ–å¤„ç†</span><br>initMessageSource();<br><br><span class="hljs-comment">// Initialize event multicaster for this context.</span><br><span class="hljs-comment">// åˆå§‹åŒ–åº”ç”¨æ¶ˆæ¯å¹¿æ’­å™¨ï¼Œå¹¶æ”¾å…¥&quot;applicationEventMulticaster&quot; bean ä¸­</span><br>initApplicationEventMulticaster();<br><br><span class="hljs-comment">// Initialize other special beans in specific context subclasses.</span><br><span class="hljs-comment">// ç•™ç»™å­ç±»æ¥åˆå§‹åŒ–å…¶ä»–çš„bean</span><br>onRefresh();<br><br><span class="hljs-comment">// Check for listener beans and register them.</span><br><span class="hljs-comment">// åœ¨æ‰€æœ‰æ³¨å†Œçš„beanä¸­æŸ¥æ‰¾Listener beanï¼Œæ³¨å†Œåˆ°æ¶ˆæ¯å¹¿æ’­å™¨ä¸­</span><br>registerListeners();<br><br><span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br><span class="hljs-comment">// åˆå§‹åŒ–å‰©ä¸‹çš„å•å®ä¾‹ï¼ˆéæƒ°æ€§çš„ï¼‰</span><br>finishBeanFactoryInitialization(beanFactory);<br><br><span class="hljs-comment">// Last step: publish corresponding event.</span><br><span class="hljs-comment">// å®Œæˆåˆ·æ–°è¿‡ç¨‹ï¼Œé€šçŸ¥ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨lifecycleProcessoråˆ·æ–°è¿‡ç¨‹ï¼ŒåŒæ—¶å‘å‡º</span><br><span class="hljs-comment">// ContextRefreshEventé€šçŸ¥åˆ«äºº</span><br>finishRefresh();<br>&#125;<br><br><span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br><span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;<br>logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - &quot;</span> +<br><span class="hljs-string">&quot;cancelling refresh attempt: &quot;</span> + ex);<br>&#125;<br><br><span class="hljs-comment">// Destroy already created singletons to avoid dangling resources.</span><br>destroyBeans();<br><br><span class="hljs-comment">// Reset &#x27;active&#x27; flag.</span><br>cancelRefresh(ex);<br><br><span class="hljs-comment">// Propagate exception to caller.</span><br><span class="hljs-keyword">throw</span> ex;<br>&#125;<br><br><span class="hljs-keyword">finally</span> &#123;<br><span class="hljs-comment">// Reset common introspection caches in Spring&#x27;s core, since we</span><br><span class="hljs-comment">// might not ever need metadata for singleton beans anymore...</span><br>resetCommonCaches();<br>contextRefresh.end();<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› ä¸ºä»Šå¤©çš„ä¸»è§’æ˜¯ ä¸€ä¸ª BeanFactoryPostProcessorï¼Œæ‰€ä»¥æˆ‘ä»¬åªå…³æ³¨ <code>invokeBeanFactoryPostProcessors(beanFactory);</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;<br>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());<br><br><span class="hljs-comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span><br><span class="hljs-comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span><br><span class="hljs-keyword">if</span> (!NativeDetector.inNativeImage() &amp;&amp; beanFactory.getTempClassLoader() == <span class="hljs-literal">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;<br>beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));<br>beanFactory.setTempClassLoader(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç‚¹è¿›å»å‘ç°å¯¹ <code>BeanFactoryPostProcessor </code>ç›¸å…³æ–¹æ³•çš„è°ƒç”¨å§”æ‰˜ç»™äº† <code>PostProcessorRegistrationDelegate</code></p><blockquote><p>æ³¨æ„ï¼Œæ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™ <code>getBeanFactoryPostProcessors()</code>é»˜è®¤æƒ…å†µä¸‹è¿”å›çš„é›†åˆå…ƒç´ ä¸ªæ•°ä¸º0ï¼Œé™¤éåœ¨è¿™ä¹‹å‰æ‰‹åŠ¨è°ƒç”¨äº† <code>addBeanFactoryPostProcessor(BeanFactoryPostProcessor postProcessor)</code>æ–¹æ³•</p></blockquote><p>åœ¨ <code>PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors())</code>ä¸­ä¸»è¦çœ‹ä¸‹é¢ä¸€è¡Œä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] postProcessorNames =<br>beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><p>é¡¾åæ€ä¹‰ï¼Œè¿™è¡Œä»£ç ä»IOCå®¹å™¨ä¸­è·å–æ‰€æœ‰å®ç°äº† <code>BeanDefinitionRegistryPostProcessor </code>æ¥å£çš„beançš„åç§°ï¼Œä¸å·§çš„æ˜¯ <code>ConfigurationClassPostProcessor</code>å®ç°äº†è¿™ä¸ªæ¥å£ï¼ˆæ–¹æ³•ä¸­è¿˜å¯¹å®ç°äº†<code>BeanDefinitionRegistryPostProcessor </code>æ¥å£çš„ç±»è¿›è¡Œäº†æ’åºï¼‰</p><blockquote><p>æ³¨æ„ï¼š</p><p><code>BeanDefinitionRegistryPostProcessor </code>å®ç°äº† <code>BeanFactoryPostProcessor</code>æ¥å£</p></blockquote><p>ç„¶åæ˜¯ <code>invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry, beanFactory.getApplicationStartup());</code>  å’Œ <code>invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeBeanDefinitionRegistryPostProcessors</span><span class="hljs-params">(</span><br><span class="hljs-params">Collection&lt;? extends BeanDefinitionRegistryPostProcessor&gt; postProcessors, BeanDefinitionRegistry registry, ApplicationStartup applicationStartup)</span> &#123;<br><br><span class="hljs-keyword">for</span> (BeanDefinitionRegistryPostProcessor postProcessor : postProcessors) &#123;<br><span class="hljs-type">StartupStep</span> <span class="hljs-variable">postProcessBeanDefRegistry</span> <span class="hljs-operator">=</span> applicationStartup.start(<span class="hljs-string">&quot;spring.context.beandef-registry.post-process&quot;</span>)<br>.tag(<span class="hljs-string">&quot;postProcessor&quot;</span>, postProcessor::toString);<br>postProcessor.postProcessBeanDefinitionRegistry(registry);<br>postProcessBeanDefRegistry.end();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹æ¯ä¸ª <code>BeanDefinitionRegistryPostProcessor</code>ï¼Œè°ƒç”¨å…¶ <code>postProcessBeanDefinitionRegistry </code>æ–¹æ³•å’Œ <code>postProcessBeanFactory </code> æ–¹æ³•</p><p>ç”±äºå’±ä»¬çš„ <code>ConfigurationClassPostProcessor </code>ä¹Ÿåœ¨å…¶ä¸­ï¼Œä¸‹é¢å°±å»çœ‹å®ƒå…·ä½“åšäº†ä»€ä¹ˆ</p><h4 id="ConfigurationClassPostProcessor-postProcessBeanDefinitionRegistry"><a href="#ConfigurationClassPostProcessor-postProcessBeanDefinitionRegistry" class="headerlink" title="ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry"></a>ConfigurationClassPostProcessor.postProcessBeanDefinitionRegistry</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Derive further bean definitions from the configuration classes in the registry. </span><br><span class="hljs-comment"> * ä»registryä¸­çš„é…ç½®ç±»æ´¾ç”Ÿæ›´å¤šçš„beanå®šä¹‰ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br><span class="hljs-type">int</span> <span class="hljs-variable">registryId</span> <span class="hljs-operator">=</span> System.identityHashCode(registry);<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.registriesPostProcessed.contains(registryId)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br><span class="hljs-string">&quot;postProcessBeanDefinitionRegistry already called on this post-processor against &quot;</span> + registry);<br>&#125;<br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.factoriesPostProcessed.contains(registryId)) &#123;<br><span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<br><span class="hljs-string">&quot;postProcessBeanFactory already called on this post-processor against &quot;</span> + registry);<br>&#125;<br><span class="hljs-built_in">this</span>.registriesPostProcessed.add(registryId);<br><br>processConfigBeanDefinitions(registry);<br>&#125;<br></code></pre></td></tr></table></figure><p>ç‚¹è¿› <code>processConfigBeanDefinitions(registry)</code> æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processConfigBeanDefinitions</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> &#123;<br>List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(); <br>    <span class="hljs-comment">// è·å–å®¹å™¨ä¸­æ‰€æœ‰çš„beanåç§°ï¼Œæ³¨æ„åˆ°è¿™é‡Œå¯ä»¥è·å–åˆ°SpringBootåº”ç”¨ç¨‹åº</span><br>    <span class="hljs-comment">// çš„å…¥å£ç±»å¯¹åº”çš„beançš„åç§°</span><br>String[] candidateNames = registry.getBeanDefinitionNames();<br><br><span class="hljs-keyword">for</span> (String beanName : candidateNames) &#123;<br><span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">beanDef</span> <span class="hljs-operator">=</span> registry.getBeanDefinition(beanName); <br>        <span class="hljs-comment">// åˆ¤æ–­beanæ˜¯å¦è¢«å¤„ç†è¿‡</span><br><span class="hljs-keyword">if</span> (beanDef.getAttribute(ConfigurationClassUtils.CONFIGURATION_CLASS_ATTRIBUTE) != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>logger.debug(<span class="hljs-string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> + beanDef);<br>&#125;<br>&#125; <br>        <span class="hljs-comment">// è¿™é‡Œåˆ¤æ–­beanæ˜¯å¦æ»¡è¶³æ¡ä»¶</span><br>        <span class="hljs-comment">// å…·ä½“çš„æ¡ä»¶æ˜¯ç±»è¢« @Configuration ä¿®é¥°</span><br>        <span class="hljs-comment">// ç„¶åä¸‹é¢ä¸¤é¡¹æ¡ä»¶æ»¡è¶³ä¸€é¡¹å³å¯</span><br>        <span class="hljs-comment">// 1. @Configuration æ³¨è§£çš„ proxyBeanMethods å±æ€§ä¸ºtrue</span><br>        <span class="hljs-comment">// 2. ç±»åŒæ—¶è¢« @Component æˆ–è€… @ComponentScan æˆ–è€… @Import æˆ–è€…</span><br>        <span class="hljs-comment">// @ImportResource æ³¨è§£ä¿®é¥° æˆ–è€…ç±»æœ‰æ–¹æ³•è¢«@Beanæ³¨è§£ä¿®é¥°</span><br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="hljs-built_in">this</span>.metadataReaderFactory)) &#123;<br>configCandidates.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(beanDef, beanName));<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Return immediately if no @Configuration classes were found</span><br><span class="hljs-keyword">if</span> (configCandidates.isEmpty()) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-comment">// Sort by previously determined @Order value, if applicable</span><br>configCandidates.sort((bd1, bd2) -&gt; &#123;<br><span class="hljs-type">int</span> <span class="hljs-variable">i1</span> <span class="hljs-operator">=</span> ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());<br><span class="hljs-type">int</span> <span class="hljs-variable">i2</span> <span class="hljs-operator">=</span> ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());<br><span class="hljs-keyword">return</span> Integer.compare(i1, i2);<br>&#125;);<br><br><span class="hljs-comment">// Detect any custom bean name generation strategy supplied through the enclosing application context</span><br><span class="hljs-type">SingletonBeanRegistry</span> <span class="hljs-variable">sbr</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">if</span> (registry <span class="hljs-keyword">instanceof</span> SingletonBeanRegistry) &#123;<br>sbr = (SingletonBeanRegistry) registry;<br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.localBeanNameGeneratorSet) &#123;<br><span class="hljs-type">BeanNameGenerator</span> <span class="hljs-variable">generator</span> <span class="hljs-operator">=</span> (BeanNameGenerator) sbr.getSingleton(<br>AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR);<br><span class="hljs-keyword">if</span> (generator != <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-built_in">this</span>.componentScanBeanNameGenerator = generator;<br><span class="hljs-built_in">this</span>.importBeanNameGenerator = generator;<br>&#125;<br>&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.environment == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-built_in">this</span>.environment = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEnvironment</span>();<br>&#125;<br><br><span class="hljs-comment">// Parse each @Configuration class</span><br><span class="hljs-type">ConfigurationClassParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassParser</span>(<br><span class="hljs-built_in">this</span>.metadataReaderFactory, <span class="hljs-built_in">this</span>.problemReporter, <span class="hljs-built_in">this</span>.environment,<br><span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.componentScanBeanNameGenerator, registry);<br><br>Set&lt;BeanDefinitionHolder&gt; candidates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(configCandidates);<br>Set&lt;ConfigurationClass&gt; alreadyParsed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(configCandidates.size());<br><span class="hljs-keyword">do</span> &#123;<br><span class="hljs-type">StartupStep</span> <span class="hljs-variable">processConfig</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.applicationStartup.start(<span class="hljs-string">&quot;spring.context.config-classes.parse&quot;</span>);<br><span class="hljs-comment">// å§”æ‰˜ ConfigurationClassParser å¤„ç†å€™é€‰çš„ é…ç½®ç±»</span><br>        parser.parse(candidates);<br>parser.validate();<br><br>Set&lt;ConfigurationClass&gt; configClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(parser.getConfigurationClasses());<br>configClasses.removeAll(alreadyParsed);<br><br><span class="hljs-comment">// Read the model and create bean definitions based on its content</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.reader == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-built_in">this</span>.reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassBeanDefinitionReader</span>(<br>registry, <span class="hljs-built_in">this</span>.sourceExtractor, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.environment,<br><span class="hljs-built_in">this</span>.importBeanNameGenerator, parser.getImportRegistry());<br>&#125;<br><span class="hljs-built_in">this</span>.reader.loadBeanDefinitions(configClasses);<br>alreadyParsed.addAll(configClasses);<br>processConfig.tag(<span class="hljs-string">&quot;classCount&quot;</span>, () -&gt; String.valueOf(configClasses.size())).end();<br><br>candidates.clear();<br><span class="hljs-keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) &#123;<br>String[] newCandidateNames = registry.getBeanDefinitionNames();<br>Set&lt;String&gt; oldCandidateNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(Arrays.asList(candidateNames));<br>Set&lt;String&gt; alreadyParsedClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br><span class="hljs-keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) &#123;<br>alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());<br>&#125;<br><span class="hljs-keyword">for</span> (String candidateName : newCandidateNames) &#123;<br><span class="hljs-keyword">if</span> (!oldCandidateNames.contains(candidateName)) &#123;<br><span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> registry.getBeanDefinition(candidateName);<br><span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="hljs-built_in">this</span>.metadataReaderFactory) &amp;&amp;<br>!alreadyParsedClasses.contains(bd.getBeanClassName())) &#123;<br>candidates.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionHolder</span>(bd, candidateName));<br>&#125;<br>&#125;<br>&#125;<br>candidateNames = newCandidateNames;<br>&#125;<br>&#125;<br><span class="hljs-keyword">while</span> (!candidates.isEmpty());<br><br><span class="hljs-comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span><br><span class="hljs-keyword">if</span> (sbr != <span class="hljs-literal">null</span> &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) &#123;<br>sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.metadataReaderFactory <span class="hljs-keyword">instanceof</span> CachingMetadataReaderFactory cachingMetadataReaderFactory) &#123;<br><span class="hljs-comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span><br><span class="hljs-comment">// for a shared cache since it&#x27;ll be cleared by the ApplicationContext.</span><br>cachingMetadataReaderFactory.clearCache();<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ConfigurationClassParser-parse"><a href="#ConfigurationClassParser-parse" class="headerlink" title="ConfigurationClassParser.parse"></a>ConfigurationClassParser.parse</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parse</span><span class="hljs-params">(Set&lt;BeanDefinitionHolder&gt; configCandidates)</span> &#123;<br><span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : configCandidates) &#123;<br><span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> holder.getBeanDefinition();<br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">if</span> (bd <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition) &#123;<br>parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());<br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bd <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition &amp;&amp; ((AbstractBeanDefinition) bd).hasBeanClass()) &#123;<br>parse(((AbstractBeanDefinition) bd).getBeanClass(), holder.getBeanName());<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br>parse(bd.getBeanClassName(), holder.getBeanName());<br>&#125;<br>&#125;<br>...<br>&#125;<br><br><span class="hljs-built_in">this</span>.deferredImportSelectorHandler.process();<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ ¹æ® BeanDefinitionçš„ç±»å‹è¿›è¡Œäº†ä¸åŒçš„å¤„ç†ï¼ˆparseï¼‰</p><p>å…¶ä¸­<code>this.deferredImportSelectorHandler.process();</code>è¿™è¡Œä»£ç å¯¹åº”<code>DeferredImportSelector</code>çš„å¤„ç†</p><p>ä¸Šé¢çš„ä¸‰ä¸ªparseæ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒç”¨<code>protected void processConfigurationClass(ConfigurationClass configClass, Predicate&lt;String&gt; filter) throws IOException</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processConfigurationClass</span><span class="hljs-params">(ConfigurationClass configClass, Predicate&lt;String&gt; filter)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>   <span class="hljs-comment">// æ˜¯å¦åº”è¯¥è·³è¿‡å¤„ç†é…ç½®ç±»ï¼ˆæ ¹æ®ç±»ä¸Šçš„ @Conditionalæ³¨è§£ï¼‰</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) &#123;<br><span class="hljs-keyword">return</span>;<br>&#125;<br>       <span class="hljs-comment">// çœ‹è¿™ä¸ªç±»æ˜¯å¦å·²ç»è¢«æ”¾å…¥å¾…å¤„ç†é›†åˆ</span><br><span class="hljs-type">ConfigurationClass</span> <span class="hljs-variable">existingClass</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.configurationClasses.get(configClass);<br><span class="hljs-keyword">if</span> (existingClass != <span class="hljs-literal">null</span>) &#123; <br>        <span class="hljs-comment">// configClassæ˜¯é€šè¿‡ @Import æ³¨å†Œçš„æˆ–è€…æ˜¯ ç”±äºåµŒå¥—åœ¨å¦ä¸€ä¸ªé…ç½®ç±»ä¸­è€Œè‡ªåŠ¨æ³¨å†Œ</span><br><span class="hljs-keyword">if</span> (configClass.isImported()) &#123;<br><span class="hljs-keyword">if</span> (existingClass.isImported()) &#123; <br>                <span class="hljs-comment">// åˆå¹¶åŒä¸€ä¸ªç±»çš„å¯¼å…¥å¯¹è±¡é›†åˆ</span><br>existingClass.mergeImportedBy(configClass);<br>&#125;<br><span class="hljs-comment">// Otherwise ignore new imported config class; existing non-imported class overrides it.</span><br><span class="hljs-keyword">return</span>;<br>&#125;<br><span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">// Explicit bean definition found, probably replacing an import.</span><br><span class="hljs-comment">// Let&#x27;s remove the old one and go with the new one. </span><br>            <span class="hljs-comment">// æ‰¾åˆ°äº†æ˜¾å¼beanå®šä¹‰ï¼Œå°†ä¹‹å‰å¯èƒ½å­˜åœ¨çš„å¯¼å…¥çš„beanå®šä¹‰åˆ é™¤</span><br><span class="hljs-built_in">this</span>.configurationClasses.remove(configClass);<br><span class="hljs-built_in">this</span>.knownSuperclasses.values().removeIf(configClass::equals);<br>&#125;<br>&#125;<br><br><span class="hljs-comment">// Recursively process the configuration class and its superclass hierarchy.</span><br>    <span class="hljs-comment">// é€’å½’å¤„ç†é…ç½®ç±»åŠå…¶çˆ¶ç±»</span><br><span class="hljs-type">SourceClass</span> <span class="hljs-variable">sourceClass</span> <span class="hljs-operator">=</span> asSourceClass(configClass, filter);<br><span class="hljs-keyword">do</span> &#123;<br>sourceClass = doProcessConfigurationClass(configClass, sourceClass, filter);<br>&#125;<br><span class="hljs-keyword">while</span> (sourceClass != <span class="hljs-literal">null</span>);<br><br>    <span class="hljs-comment">// æœ€åå°†ç±»æ”¾å…¥å¾…å¤„ç†é›†åˆä¸­ï¼Œè¿™ä¸ªé›†åˆæ˜¯ LinkedHashMapï¼Œæ ¹æ®æ’å…¥å…ƒç´ çš„é¡ºåº</span><br>    <span class="hljs-comment">// æ˜¯æœ‰åºçš„</span><br><span class="hljs-built_in">this</span>.configurationClasses.put(configClass, configClass);<br>&#125;<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹ <code>doProcessConfigurationClass </code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ConfigurationClassParser.SourceClass <span class="hljs-title function_">doProcessConfigurationClass</span><span class="hljs-params">(</span><br><span class="hljs-params">        ConfigurationClass configClass, ConfigurationClassParser.SourceClass sourceClass, Predicate&lt;String&gt; filter)</span><br>        <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-comment">// å¤„ç†åµŒå…¥çš„ç±»ï¼Œä¹Ÿæ˜¯é€šè¿‡</span><br>    <span class="hljs-comment">// ConfigurationClassUtils.isConfigurationCandidate åˆ¤æ–­åµŒå…¥ç±»</span><br>    <span class="hljs-comment">// æ˜¯å¦æ˜¯é…ç½®ç±»å€™é€‰ï¼Œç„¶åé€’å½’è¿›è¡Œå¤„ç†</span><br>    <span class="hljs-keyword">if</span> (configClass.getMetadata().isAnnotated(Component.class.getName())) &#123;<br>        <span class="hljs-comment">// Recursively process any member (nested) classes first</span><br>        processMemberClasses(configClass, sourceClass, filter);<br>    &#125;<br><br>    <span class="hljs-comment">// Process any @PropertySource annotations</span><br>    <span class="hljs-keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(<br>            sourceClass.getMtadata(), PropertySources.class,<br>            org.springframework.context.annotation.PropertySource.class)) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.environment <span class="hljs-keyword">instanceof</span> ConfigurableEnvironment) &#123;<br>            processPropertySource(propertySource);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            logger.info(<span class="hljs-string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +<br>                    <span class="hljs-string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Process any @ComponentScan annotations</span><br>    <span class="hljs-comment">// é…ç½®ç±»ä¸Šæœ‰ @ComponentScan æ³¨è§£ï¼ˆæ”¯æŒåŒæ—¶ä½¿ç”¨å¤šä¸ª@ComponentScanæ³¨è§£ï¼‰</span><br>    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(<br>            sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);<br>    <span class="hljs-keyword">if</span> (!componentScans.isEmpty() &amp;&amp;<br>            !<span class="hljs-built_in">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationCondition.ConfigurationPhase.REGISTER_BEAN)) &#123;<br>        <span class="hljs-keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;<br>            <span class="hljs-comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately </span><br>            <span class="hljs-comment">// é€šè¿‡ @ComponentScan æ³¨è§£çš„å±æ€§è¿›è¡ŒåŒ…æ‰«æï¼Œå¹¶æŠŠæ‰«æåˆ°çš„beanæ³¨å†Œåˆ°IOCå®¹å™¨ä¸­</span><br>            <span class="hljs-comment">// å¦‚æœ basePackages å’Œ basePackageClasseséƒ½ä¸ºç©ºï¼Œåˆ™æ‰«æ sourceClass æ‰€åœ¨çš„åŒ…</span><br>            <span class="hljs-comment">// æ‰«ææ—¶ä¼šæ ¹æ® excludeFilters å’Œ includeFilters è¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„ç±»</span><br>            <span class="hljs-comment">// å…¶ä¸­ includeFilters æœ‰é»˜è®¤çš„è¿‡æ»¤å™¨ AnnotationTypeFilter(Component.class)ç­‰ç­‰</span><br>            Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =<br>                    <span class="hljs-built_in">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());<br>            <span class="hljs-comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span><br>            <span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;<br>                <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">bdCand</span> <span class="hljs-operator">=</span> holder.getBeanDefinition().getOriginatingBeanDefinition();<br>                <span class="hljs-keyword">if</span> (bdCand == <span class="hljs-literal">null</span>) &#123;<br>                    bdCand = holder.getBeanDefinition();<br>                &#125;<br>                <span class="hljs-comment">// å¤„ç†å€™é€‰é…ç½®ç±»</span><br>                <span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="hljs-built_in">this</span>.metadataReaderFactory)) &#123;<br>                    parse(bdCand.getBeanClassName(), holder.getBeanName());<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Process any @Import annotations</span><br>    processImports(configClass, sourceClass, getImports(sourceClass), filter, <span class="hljs-literal">true</span>);<br><br>    <span class="hljs-comment">// Process any @ImportResource annotations</span><br>    <span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">importResource</span> <span class="hljs-operator">=</span><br>            AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);<br>    <span class="hljs-keyword">if</span> (importResource != <span class="hljs-literal">null</span>) &#123;<br>        String[] resources = importResource.getStringArray(<span class="hljs-string">&quot;locations&quot;</span>);<br>        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BeanDefinitionReader</span>&gt; readerClass = importResource.getClass(<span class="hljs-string">&quot;reader&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String resource : resources) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">resolvedResource</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.environment.resolveRequiredPlaceholders(resource);<br>            configClass.addImportedResource(resolvedResource, readerClass);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// Process individual @Bean methods</span><br>    Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);<br>    <span class="hljs-keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;<br>        configClass.addBeanMethod(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanMethod</span>(methodMetadata, configClass));<br>    &#125;<br><br>    <span class="hljs-comment">// Process default methods on interfaces</span><br>    <span class="hljs-comment">// å¤„ç†ç±»ç»§æ‰¿çš„æ¥å£ä¸­çš„è¢« @Beanæ³¨è§£ä¿®é¥°çš„æ–¹æ³• ï¼Ÿ</span><br>    processInterfaces(configClass, sourceClass);<br><br>    <span class="hljs-comment">// Process superclass, if any</span><br>    <span class="hljs-keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">superclass</span> <span class="hljs-operator">=</span> sourceClass.getMetadata().getSuperClassName();<br>        <span class="hljs-keyword">if</span> (superclass != <span class="hljs-literal">null</span> &amp;&amp; !superclass.startsWith(<span class="hljs-string">&quot;java&quot;</span>) &amp;&amp;<br>                !<span class="hljs-built_in">this</span>.knownSuperclasses.containsKey(superclass)) &#123;<br>            <span class="hljs-built_in">this</span>.knownSuperclasses.put(superclass, configClass);<br>            <span class="hljs-comment">// Superclass found, return its annotation metadata and recurse</span><br>            <span class="hljs-keyword">return</span> sourceClass.getSuperClass();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// No superclass -&gt; processing is complete</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;);<br></code></pre></td></tr></table></figure><p>åœ¨çœ‹å¤„ç†<code>@import</code> æ³¨è§£çš„æ–¹æ³•å‰å…ˆçœ‹ä¸€ä¸‹ <code>getImports(SourceClass sourceClass)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Set&lt;ConfigurationClassParser.SourceClass&gt; getImports(ConfigurationClassParser.SourceClass sourceClass) <span class="hljs-keyword">throws</span> IOException &#123;<br>    Set&lt;ConfigurationClassParser.SourceClass&gt; imports = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br>    Set&lt;ConfigurationClassParser.SourceClass&gt; visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();<br>    collectImports(sourceClass, imports, visited);<br>    <span class="hljs-keyword">return</span> imports;<br>&#125; <br><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">collectImports</span><span class="hljs-params">(ConfigurationClassParser.SourceClass sourceClass, Set&lt;ConfigurationClassParser.SourceClass&gt; imports, Set&lt;ConfigurationClassParser.SourceClass&gt; visited)</span><br>        <span class="hljs-keyword">throws</span> IOException &#123;<br><br>    <span class="hljs-keyword">if</span> (visited.add(sourceClass)) &#123;<br>        <span class="hljs-keyword">for</span> (ConfigurationClassParser.SourceClass annotation : sourceClass.getAnnotations()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">annName</span> <span class="hljs-operator">=</span> annotation.getMetadata().getClassName();<br>            <span class="hljs-keyword">if</span> (!annName.equals(Import.class.getName())) &#123;<br>                collectImports(annotation, imports, visited);<br>            &#125;<br>        &#125;<br>        imports.addAll(sourceClass.getAnnotationAttributes(Import.class.getName(), <span class="hljs-string">&quot;value&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°Springæ˜¯é€’å½’åœ°è·å–é…ç½®ç±»ä¸Šæ‰€æœ‰ <code>@Import</code> æ³¨è§£ä¸Šçš„ valueå€¼ä½œä¸º importCandidates ä¼ ç»™ <code>processImports</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processImports</span><span class="hljs-params">(ConfigurationClass configClass, ConfigurationClassParser.SourceClass currentSourceClass,</span><br><span class="hljs-params">                            Collection&lt;ConfigurationClassParser.SourceClass&gt; importCandidates, Predicate&lt;String&gt; exclusionFilter,</span><br><span class="hljs-params">                            <span class="hljs-type">boolean</span> checkForCircularImports)</span>     &#123;<br>    <span class="hljs-comment">// é…ç½®ç±»ä¸Šæ²¡æœ‰ @Import æ³¨è§£æˆ–è€… @Import æ³¨è§£ä¸Šçš„valueä¸ºç©º</span><br>    <span class="hljs-keyword">if</span> (importCandidates.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// æ£€æŸ¥å¾ªç¯ Import</span><br>    <span class="hljs-keyword">if</span> (checkForCircularImports &amp;&amp; isChainedImportOnStack(configClass)) &#123;<br>        <span class="hljs-built_in">this</span>.problemReporter.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassParser</span>.CircularImportProblem(configClass, <span class="hljs-built_in">this</span>.importStack));<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">this</span>.importStack.push(configClass);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (ConfigurationClassParser.SourceClass candidate : importCandidates) &#123;<br>                <span class="hljs-comment">// import çš„æ˜¯ ImportSelector çš„å®ç°ç±»</span><br>                <span class="hljs-keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;<br>                    <span class="hljs-comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span><br>                    Class&lt;?&gt; candidateClass = candidate.loadClass();<br>                    <span class="hljs-type">ImportSelector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> ParserStrategyUtils.instantiateClass(candidateClass, ImportSelector.class,<br>                            <span class="hljs-built_in">this</span>.environment, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.registry);<br>                    Predicate&lt;String&gt; selectorFilter = selector.getExclusionFilter();<br>                    <span class="hljs-comment">// å¤„ç†è¿‡æ»¤å™¨</span><br>                    <span class="hljs-keyword">if</span> (selectorFilter != <span class="hljs-literal">null</span>) &#123;<br>                        exclusionFilter = exclusionFilter.or(selectorFilter);<br>                    &#125;<br>                    <span class="hljs-comment">// å¦‚æœæ˜¯DeferredImportSelectorï¼Œåˆ™å…ˆå­˜èµ·æ¥</span><br>                    <span class="hljs-comment">// æœ€ååœ¨ parse(Set&lt;BeanDefinitionHolder&gt; configCandidates) æ–¹æ³•ä¸­</span><br>                    <span class="hljs-comment">// è°ƒç”¨ this.deferredImportSelectorHandler.process</span><br>                    <span class="hljs-comment">// ç»Ÿä¸€å¤„ç†ï¼Œå®ç°äº†äº†å»¶è¿ŸåŠ è½½çš„æ•ˆæœ</span><br>                    <span class="hljs-keyword">if</span> (selector <span class="hljs-keyword">instanceof</span> DeferredImportSelector) &#123;<br>                        <span class="hljs-built_in">this</span>.deferredImportSelectorHandler.handle(configClass, (DeferredImportSelector) selector);<br>                    &#125;<br>                    <span class="hljs-keyword">else</span> &#123;<br>                        String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());<br>                        Collection&lt;ConfigurationClassParser.SourceClass&gt; importSourceClasses = asSourceClasses(importClassNames, exclusionFilter);<br>                        <span class="hljs-comment">// é€’å½’å¤„ç†é…ç½®ç±»</span><br>                        processImports(configClass, currentSourceClass, importSourceClasses, exclusionFilter, <span class="hljs-literal">false</span>);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;<br>                    <span class="hljs-comment">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span><br>                    <span class="hljs-comment">// delegate to it to register additional bean definitions</span><br>                    Class&lt;?&gt; candidateClass = candidate.loadClass();<br>                    <span class="hljs-type">ImportBeanDefinitionRegistrar</span> <span class="hljs-variable">registrar</span> <span class="hljs-operator">=</span><br>                            ParserStrategyUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class,<br>                                    <span class="hljs-built_in">this</span>.environment, <span class="hljs-built_in">this</span>.resourceLoader, <span class="hljs-built_in">this</span>.registry);<br>                    <span class="hljs-comment">// å¦‚æœæ˜¯å¯¼å…¥ ImportBeanDefinitionRegistrar ç±»å‹çš„ç±»</span><br>                    <span class="hljs-comment">// å…ˆæ·»åŠ åˆ° this.importBeanDefinitionRegistrars é›†åˆä¸­</span><br>                    <span class="hljs-comment">// æœ€ååœ¨ ConfigurationClassBeanDefinitionReaderä¸­å¤„ç†</span><br>                    configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata());<br>                &#125;<br>                <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// Candidate class not an ImportSelector or ImportBeanDefinitionRegistrar -&gt;</span><br>                    <span class="hljs-comment">// process it as an @Configuration class</span><br>                    <span class="hljs-comment">// ä½œä¸ºé…ç½®ç±»å¤„ç†ï¼Œé€’å½’è°ƒç”¨</span><br>                    <span class="hljs-built_in">this</span>.importStack.registerImport(<br>                            currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());<br>                    processConfigurationClass(candidate.asConfigClass(configClass), exclusionFilter);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br>            <span class="hljs-keyword">throw</span> ex;<br>        &#125;<br>        <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<br>                    <span class="hljs-string">&quot;Failed to process import candidates for configuration class [&quot;</span> +<br>                            configClass.getMetadata().getClassName() + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>        &#125;<br>        <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-built_in">this</span>.importStack.pop();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ConfigurationClassBeanDefinitionReader-loadBeanDefinitions"><a href="#ConfigurationClassBeanDefinitionReader-loadBeanDefinitions" class="headerlink" title="ConfigurationClassBeanDefinitionReader.loadBeanDefinitions"></a>ConfigurationClassBeanDefinitionReader.loadBeanDefinitions</h4><p>Â Â Â Â å§”æ‰˜ç»™ConfigurationClassParserè§£æå®Œé…ç½®ç±»åï¼Œè°ƒç”¨<code>this.reader.loadBeanDefinitions(configClasses);</code>å°†é…ç½®ç±»æ³¨å†Œåˆ°IOCå®¹å™¨ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(Set&lt;ConfigurationClass&gt; configurationModel)</span> &#123;<br>    ConfigurationClassBeanDefinitionReader.<span class="hljs-type">TrackedConditionEvaluator</span> <span class="hljs-variable">trackedConditionEvaluator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassBeanDefinitionReader</span>.TrackedConditionEvaluator();<br>    <span class="hljs-keyword">for</span> (ConfigurationClass configClass : configurationModel) &#123;<br>        loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadBeanDefinitionsForConfigurationClass</span><span class="hljs-params">(</span><br><span class="hljs-params">        ConfigurationClass configClass, ConfigurationClassBeanDefinitionReader.TrackedConditionEvaluator trackedConditionEvaluator)</span> &#123;<br><br>    <span class="hljs-keyword">if</span> (trackedConditionEvaluator.shouldSkip(configClass)) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> configClass.getBeanName();<br>        <span class="hljs-keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="hljs-built_in">this</span>.registry.containsBeanDefinition(beanName)) &#123;<br>            <span class="hljs-built_in">this</span>.registry.removeBeanDefinition(beanName);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.importRegistry.removeImportingClass(configClass.getMetadata().getClassName());<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (configClass.isImported()) &#123;<br>        registerBeanDefinitionForImportedConfigurationClass(configClass);<br>    &#125;<br>    <span class="hljs-keyword">for</span> (BeanMethod beanMethod : configClass.getBeanMethods()) &#123;<br>        loadBeanDefinitionsForBeanMethod(beanMethod);<br>    &#125;<br><br>    loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());<br>    loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜¯æ ¹æ® é…ç½®ç±»æ’å…¥çš„é¡ºåºä¾æ¬¡è¿›è¡Œbeanå®šä¹‰çš„åŠ è½½</p><p>è€Œå¯¹å•ä¸ªé…ç½®ç±»ï¼Œå¦‚æœè¯¥é…ç½®ç±»æ˜¯ç”±å…¶ä»–é…ç½®ç±»å¯¼å…¥çš„ï¼Œä¼šé¢å¤–å°†å…¶æ³¨å†ŒIOCå®¹å™¨ä¸­ã€ç„¶åæ˜¯æ³¨å†Œå…¶è¢«<code>@Bean</code>æ³¨è§£ä¿®é¥°çš„æ–¹æ³•è¿”å›çš„beanã€ç„¶åæ³¨å†Œé…ç½®ç±»ä¸Š<code>@ImportResource</code>å¯¼å…¥çš„beanã€æœ€åæ³¨å†Œé…ç½®ç±»å¯¼å…¥çš„ å®ç°äº†<code>ImportBeanDefinitionRegistrar</code>æ¥å£çš„ç±»ä¸­è¦æ³¨å†Œçš„bean</p><p>è‡³æ­¤SpringåŠ è½½é…ç½®ç±»çš„æµç¨‹åŸºæœ¬ä¸Šå°±èµ°å®Œäº†</p><h3 id="DeferredImportSelector-çš„åŠ è½½æµç¨‹"><a href="#DeferredImportSelector-çš„åŠ è½½æµç¨‹" class="headerlink" title="DeferredImportSelector çš„åŠ è½½æµç¨‹"></a>DeferredImportSelector çš„åŠ è½½æµç¨‹</h3><p>Â Â Â Â <code>ConfigurationClassParser</code>åœ¨è§£æé…ç½®ç±»æ—¶å¯¹ <code>@Import</code>æ³¨è§£çš„å¤„ç†æ¶‰åŠåˆ° <code>DeferredImportSelector</code></p><p>åœ¨å¤„ç† <code>ImportSelector </code>çš„å®ç°ç±»æ—¶ï¼Œå¦‚æœå…¶è¿˜æ˜¯ <code>DeferredImportSelector</code>çš„å®ç°ç±»ï¼Œä¼šè°ƒç”¨ <code>this.deferredImportSelectorHandler.handle(configClass, (DeferredImportSelector) selector);</code>è¿›è¡Œå¤„ç†</p><p>ä¸‹é¢æˆ‘ä»¬ç‚¹è¿›å»çœ‹çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(ConfigurationClass configClass, DeferredImportSelector importSelector)</span> &#123;<br>    ConfigurationClassParser.<span class="hljs-type">DeferredImportSelectorHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassParser</span>.DeferredImportSelectorHolder(configClass, importSelector);<br>    <span class="hljs-comment">// æ­£åœ¨æ‰§è¡Œ this.deferredImportSelectorHandler.process</span><br>    <span class="hljs-comment">// å¯¹æ–°åŠ å…¥çš„ DeferredImportSelector å•ç‹¬è¿›è¡Œå¤„ç†</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.deferredImportSelectors == <span class="hljs-literal">null</span>) &#123;<br>        ConfigurationClassParser.<span class="hljs-type">DeferredImportSelectorGroupingHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassParser</span>.DeferredImportSelectorGroupingHandler();<br>        handler.register(holder);<br>        handler.processGroupImports();<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// ç®€å•åœ°å°†å°è£…å¥½çš„ DeferredImportSelectorHolder åŠ å…¥åˆ°</span><br>        <span class="hljs-comment">// this.deferredImportSelector Listä¸­</span><br>        <span class="hljs-built_in">this</span>.deferredImportSelectors.add(holder);<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><p>æœ€ååœ¨ <code>public void parse(Set&lt;BeanDefinitionHolder&gt; configCandidates)</code>çš„æœ€åæ‰§è¡Œ  <code>this.deferredImportSelectorHandler.process();</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">()</span> &#123;<br>    List&lt;ConfigurationClassParser.DeferredImportSelectorHolder&gt; deferredImports = <span class="hljs-built_in">this</span>.deferredImportSelectors;<br>    <span class="hljs-comment">// è¿™é‡Œå¯¹åº”ä¸Šé¢çš„ this.deferredImportSelectors == null çš„æƒ…å†µ</span><br>    <span class="hljs-built_in">this</span>.deferredImportSelectors = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (deferredImports != <span class="hljs-literal">null</span>) &#123;<br>            ConfigurationClassParser.<span class="hljs-type">DeferredImportSelectorGroupingHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassParser</span>.DeferredImportSelectorGroupingHandler();<br>            deferredImports.sort(DEFERRED_IMPORT_COMPARATOR);<br>            <span class="hljs-comment">// é€ä¸ªå°† DeferredImportSelectorHolder æ³¨å†Œåˆ° </span><br>            <span class="hljs-comment">// DeferredImportSelectorGroupingHandler ä¸­</span><br>            deferredImports.forEach(handler::register);<br>            <span class="hljs-comment">// å¤„ç†</span><br>            handler.processGroupImports();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-built_in">this</span>.deferredImportSelectors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    &#125;<br>&#125; <br><br><br><span class="hljs-comment">// private final Map&lt;Object, DeferredImportSelectorGrouping&gt; groupings = new LinkedHashMap&lt;&gt;();</span><br><span class="hljs-comment">// private final Map&lt;AnnotationMetadata, ConfigurationClass&gt; configurationClasses = new HashMap&lt;&gt;();</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(ConfigurationClassParser.DeferredImportSelectorHolder deferredImport)</span> &#123;<br>    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DeferredImportSelector</span>.Group&gt; group = deferredImport.getImportSelector().getImportGroup();<br>    <span class="hljs-comment">// çœ‹ DeferredImportSelectorHolder ä¸­å­˜å‚¨çš„ DeferredImportSelector </span><br>    <span class="hljs-comment">// æ˜¯å¦æœ‰ DeferredImportSelector.Group å­ç±»ï¼Œæ²¡æœ‰çš„è¯ä»¥ </span><br>    <span class="hljs-comment">// DeferredImportSelectorHolder ä¸ºkey</span><br>    <span class="hljs-comment">// å…¶ä¸­ createGroup æ–¹æ³•ä¹Ÿåˆ¤æ–­ groupæ˜¯å¦ä¸ºç©º</span><br>    <span class="hljs-comment">// å¦‚æœä¸ºç©ºï¼Œåˆ™ä»¥é»˜è®¤çš„ DefaultDeferredImportSelectorGroupä½œä¸ºgroup</span><br>    ConfigurationClassParser.<span class="hljs-type">DeferredImportSelectorGrouping</span> <span class="hljs-variable">grouping</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.groupings.computeIfAbsent(<br>            (group != <span class="hljs-literal">null</span> ? group : deferredImport),<br>            key -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConfigurationClassParser</span>.DeferredImportSelectorGrouping(createGroup(group)));<br>    grouping.add(deferredImport);<br>    <span class="hljs-comment">// å°† DeferredImportSelector æ¥å£çš„å®ç°ç±»æ”¾å…¥ LinkedHashMapä¸­åç»­å¤„ç†</span><br>    <span class="hljs-comment">// import å¯¼å…¥çš„é…ç½®ç±»ä¼šåœ¨</span><br>    <span class="hljs-comment">// ConfigurationClassBeanDefinitionReader.registerBeanDefinitionForImportedConfigurationClass</span><br>    <span class="hljs-comment">// æ–¹æ³•ä¸­æ³¨å†Œè¿›IOCå®¹å™¨</span><br>    <span class="hljs-built_in">this</span>.configurationClasses.put(deferredImport.getConfigurationClass().getMetadata(),<br>            deferredImport.getConfigurationClass());<br>&#125; <br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processGroupImports</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (ConfigurationClassParser.DeferredImportSelectorGrouping grouping : <span class="hljs-built_in">this</span>.groupings.values()) &#123;<br>        Predicate&lt;String&gt; exclusionFilter = grouping.getCandidateFilter();<br>        grouping.getImports().forEach(entry -&gt; &#123;<br>            <span class="hljs-comment">// æ ¹æ®entry çš„ AnnotationMetadata è·å–å°†entryå¯¼å…¥çš„é…ç½®ç±»</span><br>            <span class="hljs-type">ConfigurationClass</span> <span class="hljs-variable">configurationClass</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.configurationClasses.get(entry.getMetadata());<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// ä»¥å¤„ç†@Importæ³¨è§£çš„æ–¹å¼å¤„ç† </span><br>                <span class="hljs-comment">// DeferredImportSelector å¯¼å…¥çš„ç±»</span><br>                processImports(configurationClass, asSourceClass(configurationClass, exclusionFilter),<br>                        Collections.singleton(asSourceClass(entry.getImportClassName(), exclusionFilter)),<br>                        exclusionFilter, <span class="hljs-literal">false</span>);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) &#123;<br>                <span class="hljs-keyword">throw</span> ex;<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<br>                        <span class="hljs-string">&quot;Failed to process import candidates for configuration class [&quot;</span> +<br>                                configurationClass.getMetadata().getClassName() + <span class="hljs-string">&quot;]&quot;</span>, ex);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125; <br><br><span class="hljs-comment">// å¯ä»¥çœ‹åˆ° DeferredImportSelectorGroupingçš„ getImports æ–¹æ³•</span><br><span class="hljs-comment">// è°ƒç”¨äº† DeferredImportSelector.Group çš„ process å’Œ selectImports æ–¹æ³•</span><br><span class="hljs-keyword">public</span> Iterable&lt;DeferredImportSelector.Group.Entry&gt; getImports() &#123;<br>    <span class="hljs-keyword">for</span> (ConfigurationClassParser.DeferredImportSelectorHolder deferredImport : <span class="hljs-built_in">this</span>.deferredImports) &#123;<br>        <span class="hljs-built_in">this</span>.group.process(deferredImport.getConfigurationClass().getMetadata(),<br>                deferredImport.getImportSelector());<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.group.selectImports();<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å†å›è¿‡å¤´çœ‹çœ‹ <code>@EnableAutoConfiguration</code>ä¸­ import çš„ <code>AutoConfigurationImportSelector</code>ï¼Œå…¶å®ç°äº† <code>DeferredImportSelector</code>æ¥å£ï¼Œå¹¶ä¸” <code>getImportGroup()</code>æ–¹æ³•è¿”å›å…¶å­ç±»  <code>AutoConfigurationGroup</code></p><p>æ‰€ä»¥æˆ‘ä»¬ä¸»è¦çœ‹ <code>AutoConfigurationGroup </code>çš„ <code>process </code>å’Œ <code>selectImports </code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">process</span><span class="hljs-params">(AnnotationMetadata annotationMetadata, DeferredImportSelector deferredImportSelector)</span> &#123;<br>    Assert.state(deferredImportSelector <span class="hljs-keyword">instanceof</span> AutoConfigurationImportSelector,<br>            () -&gt; String.format(<span class="hljs-string">&quot;Only %s implementations are supported, got %s&quot;</span>,<br>                    AutoConfigurationImportSelector.class.getSimpleName(),<br>                    deferredImportSelector.getClass().getName()));<br>    <span class="hljs-comment">// æ ¹æ® annotationMetadata æ„å»º AutoConfigurationEntry</span><br>    AutoConfigurationImportSelector.<span class="hljs-type">AutoConfigurationEntry</span> <span class="hljs-variable">autoConfigurationEntry</span> <span class="hljs-operator">=</span> ((AutoConfigurationImportSelector) deferredImportSelector)<br>            .getAutoConfigurationEntry(annotationMetadata);<br>    <span class="hljs-built_in">this</span>.autoConfigurationEntries.add(autoConfigurationEntry);<br>    <span class="hljs-keyword">for</span> (String importClassName : autoConfigurationEntry.getConfigurations()) &#123;<br>        <span class="hljs-comment">// å»ºç«‹ annotationMetadata å’Œæ ¹æ®å…¶å¯¼å…¥çš„ç±»çš„åç§° importClassName çš„æ˜ å°„</span><br>        <span class="hljs-built_in">this</span>.entries.putIfAbsent(importClassName, annotationMetadata);<br>    &#125;<br>&#125; <br><br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Iterable&lt;DeferredImportSelector.Group.Entry&gt; selectImports() &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.autoConfigurationEntries.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Collections.emptyList();<br>    &#125;<br>    Set&lt;String&gt; allExclusions = <span class="hljs-built_in">this</span>.autoConfigurationEntries.stream()<br>            .map(AutoConfigurationImportSelector.AutoConfigurationEntry::getExclusions).flatMap(Collection::stream).collect(Collectors.toSet());<br>    Set&lt;String&gt; processedConfigurations = <span class="hljs-built_in">this</span>.autoConfigurationEntries.stream()<br>            .map(AutoConfigurationImportSelector.AutoConfigurationEntry::getConfigurations).flatMap(Collection::stream)<br>            .collect(Collectors.toCollection(LinkedHashSet::<span class="hljs-keyword">new</span>));<br>    processedConfigurations.removeAll(allExclusions);<br><br>    <span class="hljs-comment">// æœ€åè¿”å›æ’å¥½åºçš„ DeferredImportSelector.Group.Entry</span><br>    <span class="hljs-keyword">return</span> sortAutoConfigurations(processedConfigurations, getAutoConfigurationMetadata()).stream()<br>            .map((importClassName) -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeferredImportSelector</span>.Group.Entry(<span class="hljs-built_in">this</span>.entries.get(importClassName), importClassName))<br>            .collect(Collectors.toList());<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åçœ‹ä¸€ä¸‹ <code>AutoConfigurationImportSelector</code>çš„ <code>getAutoConfigurationEntry</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> AutoConfigurationImportSelector.AutoConfigurationEntry <span class="hljs-title function_">getAutoConfigurationEntry</span><span class="hljs-params">(AnnotationMetadata annotationMetadata)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!isEnabled(annotationMetadata)) &#123;<br>        <span class="hljs-keyword">return</span> EMPTY_ENTRY;<br>    &#125; <br>    <span class="hljs-comment">// è·å–æ³¨è§£ä¸Šçš„å±æ€§</span><br>    <span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> getAttributes(annotationMetadata);<br>    <span class="hljs-comment">// æ ¹æ®æ³¨è§£çš„å±æ€§è·å–è¦å¯¼å…¥çš„å€™é€‰ç±»</span><br>    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);<br>    configurations = removeDuplicates(configurations);<br>    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);<br>    checkExcludedClasses(configurations, exclusions);<br>    configurations.removeAll(exclusions);<br>    configurations = getConfigurationClassFilter().filter(configurations);<br>    fireAutoConfigurationImportEvents(configurations, exclusions);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutoConfigurationImportSelector</span>.AutoConfigurationEntry(configurations, exclusions);<br>&#125; <br><br><br><span class="hljs-keyword">protected</span> List&lt;String&gt; <span class="hljs-title function_">getCandidateConfigurations</span><span class="hljs-params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> &#123;<br>    <span class="hljs-comment">// è·å–å€™é€‰ç±»åçš„æ–¹æ³•å§”æ‰˜ç»™ SpringFactoriesLoader.loadFactoryNames å®ç°</span><br>    List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(),<br>            getBeanClassLoader());<br>    Assert.notEmpty(configurations, <span class="hljs-string">&quot;No auto configuration classes found in META-INF/spring.factories. If you &quot;</span><br>            + <span class="hljs-string">&quot;are using a custom packaging, make sure that file is correct.&quot;</span>);<br>    <span class="hljs-keyword">return</span> configurations;<br>&#125; <br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">loadFactoryNames</span><span class="hljs-params">(Class&lt;?&gt; factoryType, <span class="hljs-meta">@Nullable</span> ClassLoader classLoader)</span> &#123;<br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoaderToUse</span> <span class="hljs-operator">=</span> classLoader;<br>    <span class="hljs-keyword">if</span> (classLoader == <span class="hljs-literal">null</span>) &#123;<br>        classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();<br>    &#125; <br><br>    <span class="hljs-comment">// è¿™é‡Œçš„ factoryTypeName å°±æ˜¯ @EnableAutoConfiguration æ³¨è§£çš„ç±»å</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">factoryTypeName</span> <span class="hljs-operator">=</span> factoryType.getName(); <br>    <span class="hljs-comment">// æ‰¾ä¸åˆ°å°±è¿”å›ç©ºé›†åˆ</span><br>    <span class="hljs-keyword">return</span> (List)loadSpringFactories(classLoaderToUse).getOrDefault(factoryTypeName, Collections.emptyList());<br>&#125; <br><br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; <span class="hljs-title function_">loadSpringFactories</span><span class="hljs-params">(ClassLoader classLoader)</span> &#123;<br>    Map&lt;String, List&lt;String&gt;&gt; result = (Map)cache.get(classLoader);<br>    <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Map&lt;String, List&lt;String&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><br>        <span class="hljs-keyword">try</span> &#123; <br>            <span class="hljs-comment">// è§£æ META-INF/spring.factories æ–‡ä»¶</span><br>            Enumeration&lt;URL&gt; urls = classLoader.getResources(<span class="hljs-string">&quot;META-INF/spring.factories&quot;</span>);<br><br>            <span class="hljs-keyword">while</span>(urls.hasMoreElements()) &#123;<br>                <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> (URL)urls.nextElement();<br>                <span class="hljs-type">UrlResource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlResource</span>(url);<br>                <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> PropertiesLoaderUtils.loadProperties(resource);<br>                <span class="hljs-type">Iterator</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> properties.entrySet().iterator();<br><br>                <span class="hljs-keyword">while</span>(var6.hasNext()) &#123;<br>                    Map.Entry&lt;?, ?&gt; entry = (Map.Entry)var6.next(); <br>                    <span class="hljs-comment">// è·å–æ–‡ä»¶ä¸­ä¸€è¡Œæ ¼å¼ä¸º factoryTypeName = className,className...</span><br>                    <span class="hljs-comment">// çš„è¡Œçš„ factoryTypeName </span><br>                    <span class="hljs-type">String</span> <span class="hljs-variable">factoryTypeName</span> <span class="hljs-operator">=</span> ((String)entry.getKey()).trim();<br>                    String[] factoryImplementationNames = StringUtils.commaDelimitedListToStringArray((String)entry.getValue());<br>                    String[] var10 = factoryImplementationNames;<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> factoryImplementationNames.length;<br>                    <span class="hljs-comment">// è·å–factoryTypeName å¯¹åº”çš„æ‰€æœ‰className</span><br>                    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var12</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var12 &lt; var11; ++var12) &#123;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">factoryImplementationName</span> <span class="hljs-operator">=</span> var10[var12];<br>                        ((List)result.computeIfAbsent(factoryTypeName, (key) -&gt; &#123;<br>                            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>                        &#125;)).add(factoryImplementationName.trim());<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// æ¯ä¸ª factoryTypeName å¯¹åº”çš„ classNameså»é‡</span><br>            result.replaceAll((factoryType, implementations) -&gt; &#123;<br>                <span class="hljs-keyword">return</span> (List)implementations.stream().distinct().collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList));<br>            &#125;);<br>            cache.put(classLoader, result);<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var14) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Unable to load factories from location [META-INF/spring.factories]&quot;</span>, var14);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="AutoConfigurationPackage"><a href="#AutoConfigurationPackage" class="headerlink" title="@AutoConfigurationPackage"></a>@AutoConfigurationPackage</h4><p>Â Â Â Â <code>@EnableAutoConfiguration</code> æ³¨è§£è¿˜è¢« <code>@AutoConfigurationPackage</code>Â ä¿®é¥°</p><p>è€Œç‚¹è¿›å»å‘ç°äº† <code>@Import(AutoConfigurationPackages.Registrar.class)</code></p><p>å…¶ä¸­ <code>AutoConfigurationPackages.Registrar</code> å®ç°äº† <code>ImportBeanDefinitionRegistrar</code>æ¥å£</p><p>è€Œè¿™ä¸ªç±»çš„ <code>registerBeanDefinitions</code>æ–¹æ³•æ˜¯åœ¨åŠ è½½é…ç½®ç±»çš„beanå®šä¹‰æ—¶åœ¨ <code>loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());</code>ä¸­è¢«è°ƒç”¨çš„</p><p>å…¶å® <code>AutoConfigurationPackages.Registrar</code>åªæ˜¯å¾€å®¹å™¨ä¸­æ³¨å†Œäº†ä¸€ä¸ªåä¸º <code>AutoConfigurationPackages.class.getName()</code>çš„beanï¼Œè¿™ä¸ªbeanä¸­æœ‰ä¸€ä¸ªSet å‹çš„basePackageså±æ€§ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œå»çœ‹ä¸€ä¸‹æºç </p><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><p>Â Â Â Â åœ¨<code>@SpringBootApplication</code>æ³¨è§£ä¸­çš„<code>@ComponentScan</code>æœ‰excludeFilterså±æ€§ï¼Œå®ƒå®šä¹‰äº†ä¸¤ä¸ªexcludeFilterï¼Œä¸€ä¸ªæ˜¯<code>TypeExcludeFilter</code>ï¼Œçœ‹äº†ä¸€ä¸‹è¿™ä¸ªè¿‡æ»¤å™¨çš„å®ç°ç±»å…¨åœ¨teståŒ…é‡Œé¢ï¼ŒçŒœæµ‹åº”è¯¥å’ŒSpringBootTestç›¸å…³ï¼›è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯<code>AutoConfigurationExcludeFilter</code>ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨æ˜¯åŒ¹é…è¢«<code>@Configuration</code>æ³¨è§£ä¿®é¥°å¹¶ä¸”æ˜¯åœ¨ <code>META-INF/spring.factories</code> æ–‡ä»¶ä¸­ä»¥ <code>EnableAutoConfiguration</code>çš„ç±»åä¸ºå¼€å¤´çš„ç±»ï¼Œä¹Ÿå°±æ˜¯åœ¨æ‰«æåŒ…çš„æ—¶å€™ï¼Œç”±<code>@EnableAutoConfiguration</code>ä¸­ <code>AutoConfigurationImportSelector</code>å¯¼å…¥çš„ç±»å…ˆä¸è¦å¤„ç†ï¼Œç­‰åˆ°æœ€åç”±<code>deferredImportSelectorHandler</code>å¤„ç†</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>Â Â Â Â ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘è®¤ä¸ºä»¥<code>ConfigurationClassPostProcessor</code>å’Œ<code>ConfigurationClassParser</code>ä¸ºæ ¸å¿ƒçš„é…ç½®ç±»å¤„ç†ç±»</p><p>ä»¥åŠ</p><ol><li><p>åœ¨åˆ›å»ºä¸Šä¸‹æ–‡æ—¶æ³¨å†Œé…ç½®ç±»å¤„ç†å™¨</p></li><li><p>å‡†å¤‡ä¸Šä¸‹æ–‡æ—¶å°†SpringBootå…¥å£ç±»æ³¨å†Œè¿›IOCå®¹å™¨ä¸­</p></li><li><p>ä»¥åŠåœ¨refreshä¸Šä¸‹æ–‡æ—¶è°ƒç”¨é…ç½®ç±»å¤„ç†å™¨è¿›è¡ŒåŒ…æ‰«æå¹¶æ ¹æ®ä¸åŒçš„æƒ…å†µå¤„ç†é…ç½®ç±»</p></li></ol><p>æµç¨‹ç§°ä½œSpringBootçš„è‡ªåŠ¨é…ç½®æ›´ä¸ºæ°å½“ä¸€äº›ã€‚</p><p> <code>@EnableAutoConfiguration</code>æ³¨è§£çš„ä½œç”¨ä¸æ˜¯å¼€å¯è‡ªåŠ¨é…ç½®ï¼Œè€Œæ˜¯æä¾›äº†ä¸€ç§åœ¨é…ç½®æ–‡ä»¶<code>META-INF/spring.factories</code>ä¸­å»¶è¿Ÿæ³¨å†Œbeançš„æ–¹æ¡ˆä»¥åŠå¾€IOCå®¹å™¨ä¸­å¡äº†ä¸€ä¸ªåä¸º <code>AutoConfigurationPackages.class.getName()</code>çš„beanï¼Œè€Œè¿™ä¸ªbeanåœ¨é…ç½®ç±»å¤„ç†ç±»ä¸­ä¹Ÿæ²¡æœ‰è¢«ä½¿ç”¨è¿‡ï¼ˆæˆ‘æ²¡æœ‰çœ‹åˆ°ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ³è¯·æŒ‡æ­£ï¼‰</p><h4 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h4><ul><li><p><a href="https://zhuanlan.zhihu.com/p/147025312">Springå…¨è§£ç³»åˆ— - @Importæ³¨è§£ - çŸ¥ä¹ (zhihu.com)</a></p></li><li><p><a href="https://www.cnblogs.com/ZhuChangwu/p/11681101.html">æ·±å…¥ç†è§£ Spring BeanFactoryPostProcessorçš„å›è°ƒ - èµæˆ‘ç™½æ—¥æ¢¦ - åšå®¢å›­ (cnblogs.com)</a></p></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>4-parsing</title>
    <link href="/2023/06/09/mybatis-source-code/4-parsing/"/>
    <url>/2023/06/09/mybatis-source-code/4-parsing/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â è¿™ä¸ªæ¨¡å—æä¾›äº†é€šç”¨çš„å­—ç¬¦ä¸²è§£æï¼ˆæ›¿æ¢ï¼‰æ¥å£ï¼Œå¹¶å°è£…äº† <code>org.w3c.dom.Node</code> å’Œ  <code>javax.xml.xpath.XPath</code>ç­‰</p><h4 id="TokenHandler"><a href="#TokenHandler" class="headerlink" title="TokenHandler"></a>TokenHandler</h4><p>Â Â Â Â TokenHandler æ˜¯ æä¾›äº†å¯¹åŒ¹é…åˆ°çš„å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†çš„æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TokenHandler</span> &#123;<br>  <span class="hljs-comment">// å¤„ç†content</span><br>  String <span class="hljs-title function_">handleToken</span><span class="hljs-params">(String content)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="GenericTokenParser"><a href="#GenericTokenParser" class="headerlink" title="GenericTokenParser"></a>GenericTokenParser</h4><p>Â Â Â Â é€šç”¨è®°å·è§£æå™¨ï¼Œç”¨äºå¤„ç†#{}å’Œ${}å‚æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericTokenParser</span> &#123;<br>  <span class="hljs-comment">// å¼€å§‹æ ‡è®°å’Œç»“æŸæ ‡è®°</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String openToken;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String closeToken; <br><br>  <span class="hljs-comment">// è®°å·å¤„ç†å™¨</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TokenHandler handler; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">GenericTokenParser</span><span class="hljs-params">(String openToken, String closeToken, TokenHandler handler)</span> &#123;<br>    <span class="hljs-built_in">this</span>.openToken = openToken;<br>    <span class="hljs-built_in">this</span>.closeToken = closeToken;<br>    <span class="hljs-built_in">this</span>.handler = handler;<br>  &#125; <br><br>  <span class="hljs-comment">// è¿™é‡Œæ˜¯è‡ªå·±å®ç°äº†ä¸€ä¸ªç®€å•çš„æ­£åˆ™åŒ¹é…</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">parse</span><span class="hljs-params">(String text)</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-keyword">if</span> (text != <span class="hljs-literal">null</span> &amp;&amp; text.length() &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-type">char</span>[] src = text.toCharArray();<br>      <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> text.indexOf(openToken, offset);<br>      <span class="hljs-comment">// #&#123;favouriteSection,jdbcType=VARCHAR&#125;</span><br>      <span class="hljs-comment">// è¿™é‡Œæ˜¯å¾ªç¯è§£æå‚æ•°ï¼Œå‚è€ƒGenericTokenParserTest,</span><br>      <span class="hljs-comment">// æ¯”å¦‚å¯ä»¥è§£æ$&#123;first_name&#125; $&#123;initial&#125; $&#123;last_name&#125; reporting.</span><br>      <span class="hljs-comment">// è¿™æ ·çš„å­—ç¬¦ä¸²,é‡Œé¢æœ‰3ä¸ª $&#123;&#125;</span><br>      <span class="hljs-keyword">while</span> (start &gt; -<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-comment">// åˆ¤æ–­ä¸€ä¸‹ $&#123;(openToken) å‰é¢æ˜¯å¦æ˜¯åæ–œæ ï¼Œè¿™ä¸ªé€»è¾‘åœ¨è€ç‰ˆçš„mybatisä¸­ï¼ˆå¦‚3.1.0ï¼‰</span><br>        <span class="hljs-comment">// æ˜¯æ²¡æœ‰çš„</span><br>        <span class="hljs-comment">// è¿™é‡Œç›¸å½“äºè½¬ä¹‰ï¼ŒopenTokenå½“æˆä¸€èˆ¬å­—ç¬¦å¤„ç†</span><br>        <span class="hljs-keyword">if</span> (start &gt; <span class="hljs-number">0</span> &amp;&amp; src[start - <span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;\\&#x27;</span>) &#123;<br>          <span class="hljs-comment">// the variable is escaped. remove the backslash.</span><br>        <span class="hljs-comment">// æ–°ç‰ˆå·²ç»æ²¡æœ‰è°ƒç”¨substringäº†ï¼Œæ”¹ä¸ºè°ƒç”¨å¦‚ä¸‹çš„offsetæ–¹å¼ï¼Œæé«˜äº†æ•ˆç‡</span><br>          <span class="hljs-comment">// issue #760</span><br>          builder.append(src, offset, start - offset - <span class="hljs-number">1</span>).append(openToken);<br>          offset = start + openToken.length();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> text.indexOf(closeToken, start);<br>          <span class="hljs-comment">// openTokenæ²¡æœ‰å¯¹åº”çš„closeTokenï¼Œä¹Ÿå½“æˆæ™®é€šå­—ç¬¦å¤„ç†</span><br>          <span class="hljs-keyword">if</span> (end == -<span class="hljs-number">1</span>) &#123;<br>            builder.append(src, offset, src.length - offset);<br>            offset = src.length;<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            builder.append(src, offset, start - offset);<br>            offset = start + openToken.length();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(src, offset, end - offset);<br>            <span class="hljs-comment">// å¾—åˆ°ä¸€å¯¹å¤§æ‹¬å·é‡Œçš„å­—ç¬¦ä¸²åï¼Œè°ƒç”¨handler.handleToken,æ¯”å¦‚æ›¿æ¢å˜é‡è¿™ç§åŠŸèƒ½</span><br>            builder.append(handler.handleToken(content));<br>            offset = end + closeToken.length();<br>          &#125;<br>        &#125;<br>        <span class="hljs-comment">// è·å–ä¸‹ä¸€ä¸ªopenTokençš„ä¸‹æ ‡</span><br>        start = text.indexOf(openToken, offset);<br>      &#125;<br>      <span class="hljs-comment">// å¤„ç†å‰©ä¸‹çš„å­—ç¬¦</span><br>      <span class="hljs-keyword">if</span> (offset &lt; src.length) &#123;<br>        builder.append(src, offset, src.length - offset);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> builder.toString();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PropertyParser"><a href="#PropertyParser" class="headerlink" title="PropertyParser"></a>PropertyParser</h4><p>Â Â Â Â Â å®ç°äº†ä¸€ä¸ªæ ¹æ®Propertiesä¸­çš„keyå’Œvalueæ›¿æ¢Â ${}$ ${}$åŒ…è£¹çš„å†…å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PropertyParser</span> &#123; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">PropertyParser</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Prevent Instantiation</span><br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">parse</span><span class="hljs-params">(String string, Properties variables)</span> &#123;<br>    <span class="hljs-type">VariableTokenHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VariableTokenHandler</span>(variables);<br>    <span class="hljs-type">GenericTokenParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericTokenParser</span>(<span class="hljs-string">&quot;$&#123;&quot;</span>, <span class="hljs-string">&quot;&#125;&quot;</span>, handler);<br>    <span class="hljs-keyword">return</span> parser.parse(string);<br>  &#125; <br><br>  <span class="hljs-comment">// ç”¨ç›¸åº”çš„valueæ›¿æ¢key</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VariableTokenHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TokenHandler</span> &#123;<br>    <span class="hljs-keyword">private</span> Properties variables;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">VariableTokenHandler</span><span class="hljs-params">(Properties variables)</span> &#123;<br>      <span class="hljs-built_in">this</span>.variables = variables;<br>    &#125; <br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handleToken</span><span class="hljs-params">(String content)</span> &#123;<br>      <span class="hljs-keyword">if</span> (variables != <span class="hljs-literal">null</span> &amp;&amp; variables.containsKey(content)) &#123;<br>        <span class="hljs-keyword">return</span> variables.getProperty(content);<br>      &#125;<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;$&#123;&quot;</span> + content + <span class="hljs-string">&quot;&#125;&quot;</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="XPathParser"><a href="#XPathParser" class="headerlink" title="XPathParser"></a>XPathParser</h4><p>Â Â Â Â  Â XPathè§£æå™¨ï¼Œç”¨çš„éƒ½æ˜¯JDKçš„ç±»åŒ…,å°è£…äº†ä¸€ä¸‹ï¼Œä½¿å¾—ä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XPathParser</span> &#123; <br>  <span class="hljs-keyword">private</span> Document document;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> validation;<br>  <span class="hljs-keyword">private</span> EntityResolver entityResolver;<br>  <span class="hljs-keyword">private</span> Properties variables;<br>  <span class="hljs-keyword">private</span> XPath xpath; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commonConstructor</span><span class="hljs-params">(<span class="hljs-type">boolean</span> validation, Properties variables, EntityResolver entityResolver)</span> &#123;<br>    <span class="hljs-built_in">this</span>.validation = validation;<br>    <span class="hljs-built_in">this</span>.entityResolver = entityResolver;<br>    <span class="hljs-built_in">this</span>.variables = variables;<br><span class="hljs-comment">// å…±é€šæ„é€ å‡½æ•°ï¼Œé™¤äº†æŠŠå‚æ•°éƒ½è®¾ç½®åˆ°å®ä¾‹å˜é‡é‡Œé¢å»ä»¥å¤–ï¼Œè¿˜åˆå§‹åŒ–äº†XPath</span><br>    <span class="hljs-type">XPathFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> XPathFactory.newInstance();<br>    <span class="hljs-built_in">this</span>.xpath = factory.newXPath();<br>  &#125; <br><br>  <span class="hljs-comment">// ä¸€äº›æ„é€ å‡½æ•°,å…¨éƒ¨è°ƒç”¨commonConstructorä»¥åŠcreateDocument</span><br>  <span class="hljs-comment">// 1~4,é»˜è®¤ä¸éœ€è¦éªŒè¯</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(String xml)</span> &#123;<br>    commonConstructor(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(xml)));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(Reader reader)</span> &#123;<br>    commonConstructor(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(reader));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(InputStream inputStream)</span> &#123;<br>    commonConstructor(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(inputStream));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(Document document)</span> &#123;<br>    commonConstructor(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = document;<br>  &#125; <br><br>  <span class="hljs-comment">// 5~8,ä¼ å…¥æ˜¯å¦éœ€è¦éªŒè¯å‚æ•°</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(String xml, <span class="hljs-type">boolean</span> validation)</span> &#123;<br>    commonConstructor(validation, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(xml)));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(Reader reader, <span class="hljs-type">boolean</span> validation)</span> &#123;<br>    commonConstructor(validation, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(reader));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(InputStream inputStream, <span class="hljs-type">boolean</span> validation)</span> &#123;<br>    commonConstructor(validation, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(inputStream));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(Document document, <span class="hljs-type">boolean</span> validation)</span> &#123;<br>    commonConstructor(validation, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = document;<br>  &#125; <br><br>  <span class="hljs-comment">// 9~12,ä¼ å…¥æ˜¯å¦éœ€è¦éªŒè¯å‚æ•°,Properties</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(String xml, <span class="hljs-type">boolean</span> validation, Properties variables)</span> &#123;<br>    commonConstructor(validation, variables, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(xml)));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(Reader reader, <span class="hljs-type">boolean</span> validation, Properties variables)</span> &#123;<br>    commonConstructor(validation, variables, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(reader));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(InputStream inputStream, <span class="hljs-type">boolean</span> validation, Properties variables)</span> &#123;<br>    commonConstructor(validation, variables, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(inputStream));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(Document document, <span class="hljs-type">boolean</span> validation, Properties variables)</span> &#123;<br>    commonConstructor(validation, variables, <span class="hljs-literal">null</span>);<br>    <span class="hljs-built_in">this</span>.document = document;<br>  &#125; <br><br>  <span class="hljs-comment">// 13~16,ä¼ å…¥æ˜¯å¦éœ€è¦éªŒè¯å‚æ•°,Properties,EntityResolver</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(String xml, <span class="hljs-type">boolean</span> validation, Properties variables, EntityResolver entityResolver)</span> &#123;<br>    commonConstructor(validation, variables, entityResolver);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(xml)));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(Reader reader, <span class="hljs-type">boolean</span> validation, Properties variables, EntityResolver entityResolver)</span> &#123;<br>    commonConstructor(validation, variables, entityResolver);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(reader));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(InputStream inputStream, <span class="hljs-type">boolean</span> validation, Properties variables, EntityResolver entityResolver)</span> &#123;<br>    commonConstructor(validation, variables, entityResolver);<br>    <span class="hljs-built_in">this</span>.document = createDocument(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(inputStream));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XPathParser</span><span class="hljs-params">(Document document, <span class="hljs-type">boolean</span> validation, Properties variables, EntityResolver entityResolver)</span> &#123;<br>    commonConstructor(validation, variables, entityResolver);<br>    <span class="hljs-built_in">this</span>.document = document;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setVariables</span><span class="hljs-params">(Properties variables)</span> &#123;<br>    <span class="hljs-built_in">this</span>.variables = variables;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">evalString</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalString(document, expression);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">evalString</span><span class="hljs-params">(Object root, String expression)</span> &#123;<br><span class="hljs-comment">// 1.å…ˆç”¨xpathè§£æ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (String) evaluate(expression, root, XPathConstants.STRING);<br><span class="hljs-comment">// 2.å†è°ƒç”¨PropertyParserå»è§£æ,ä¹Ÿå°±æ˜¯æ›¿æ¢ $&#123;&#125; è¿™ç§æ ¼å¼çš„å­—ç¬¦ä¸²</span><br>    result = PropertyParser.parse(result, variables);<br>    <span class="hljs-keyword">return</span> result;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">evalBoolean</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalBoolean(document, expression);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">evalBoolean</span><span class="hljs-params">(Object root, String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> (Boolean) evaluate(expression, root, XPathConstants.BOOLEAN);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Short <span class="hljs-title function_">evalShort</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalShort(document, expression);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Short <span class="hljs-title function_">evalShort</span><span class="hljs-params">(Object root, String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> Short.valueOf(evalString(root, expression));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">evalInteger</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalInteger(document, expression);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">evalInteger</span><span class="hljs-params">(Object root, String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> Integer.valueOf(evalString(root, expression));<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">evalLong</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalLong(document, expression);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">evalLong</span><span class="hljs-params">(Object root, String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> Long.valueOf(evalString(root, expression));<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Float <span class="hljs-title function_">evalFloat</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalFloat(document, expression);<br>  &#125;<br><br>  <span class="hljs-comment">// ??è¿™é‡Œæœ‰ç‚¹ç–‘é—®ï¼Œä¸ºä½•Floatç”¨evalString,Doubleç”¨evaluate XPathConstants.NUMBER</span><br>  <span class="hljs-keyword">public</span> Float <span class="hljs-title function_">evalFloat</span><span class="hljs-params">(Object root, String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> Float.valueOf(evalString(root, expression));<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">evalDouble</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalDouble(document, expression);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">evalDouble</span><span class="hljs-params">(Object root, String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> (Double) evaluate(expression, root, XPathConstants.NUMBER);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> List&lt;XNode&gt; <span class="hljs-title function_">evalNodes</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalNodes(document, expression);<br>  &#125; <br><br>  <span class="hljs-comment">// è¿”å›èŠ‚ç‚¹List</span><br>  <span class="hljs-keyword">public</span> List&lt;XNode&gt; <span class="hljs-title function_">evalNodes</span><span class="hljs-params">(Object root, String expression)</span> &#123;<br>    List&lt;XNode&gt; xnodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;XNode&gt;();<br>    <span class="hljs-type">NodeList</span> <span class="hljs-variable">nodes</span> <span class="hljs-operator">=</span> (NodeList) evaluate(expression, root, XPathConstants.NODESET);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; nodes.getLength(); i++) &#123;<br>      xnodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XNode</span>(<span class="hljs-built_in">this</span>, nodes.item(i), variables));<br>    &#125;<br>    <span class="hljs-keyword">return</span> xnodes;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> XNode <span class="hljs-title function_">evalNode</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> evalNode(document, expression);<br>  &#125; <br><br>  <span class="hljs-comment">// è¿”å›èŠ‚ç‚¹</span><br>  <span class="hljs-keyword">public</span> XNode <span class="hljs-title function_">evalNode</span><span class="hljs-params">(Object root, String expression)</span> &#123;<br>    <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> (Node) evaluate(expression, root, XPathConstants.NODE);<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XNode</span>(<span class="hljs-built_in">this</span>, node, variables);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">evaluate</span><span class="hljs-params">(String expression, Object root, QName returnType)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// æœ€ç»ˆåˆæµåˆ°è¿™å„¿ï¼Œç›´æ¥è°ƒç”¨XPath.evaluate</span><br>      <span class="hljs-keyword">return</span> xpath.evaluate(expression, root, returnType);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error evaluating XPath.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Document <span class="hljs-title function_">createDocument</span><span class="hljs-params">(InputSource inputSource)</span> &#123;<br>    <span class="hljs-comment">// important: this must only be called AFTER common constructor</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// è¿™ä¸ªæ˜¯DOMè§£ææ–¹å¼</span><br>      <span class="hljs-type">DocumentBuilderFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> DocumentBuilderFactory.newInstance();<br>      factory.setValidating(validation);<br><br>      <span class="hljs-comment">// åç§°ç©ºé—´</span><br>      factory.setNamespaceAware(<span class="hljs-literal">false</span>);<br>      <span class="hljs-comment">// å¿½ç•¥æ³¨é‡Š</span><br>      factory.setIgnoringComments(<span class="hljs-literal">true</span>);<br>      <span class="hljs-comment">// å¿½ç•¥ç©ºç™½</span><br>      factory.setIgnoringElementContentWhitespace(<span class="hljs-literal">false</span>);<br>      <span class="hljs-comment">// æŠŠ CDATA èŠ‚ç‚¹è½¬æ¢ä¸º Text èŠ‚ç‚¹</span><br>      factory.setCoalescing(<span class="hljs-literal">false</span>);<br>      <span class="hljs-comment">// æ‰©å±•å®ä½“å¼•ç”¨</span><br>      factory.setExpandEntityReferences(<span class="hljs-literal">true</span>);<br><br>      <span class="hljs-type">DocumentBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> factory.newDocumentBuilder();<br>      <span class="hljs-comment">// éœ€è¦æ³¨æ„çš„å°±æ˜¯å®šä¹‰äº†EntityResolver(XMLMapperEntityResolver)ï¼Œè¿™æ ·ä¸ç”¨è”ç½‘å»è·å–DTDï¼Œ</span><br>      <span class="hljs-comment">// å°†DTDæ”¾åœ¨org\apache\ibatis\builder\xml\mybatis-3-config.dtd,æ¥è¾¾åˆ°éªŒè¯xmlåˆæ³•æ€§çš„ç›®çš„</span><br>      builder.setEntityResolver(entityResolver);<br>      builder.setErrorHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorHandler</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(SAXParseException exception)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>          <span class="hljs-keyword">throw</span> exception;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fatalError</span><span class="hljs-params">(SAXParseException exception)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>          <span class="hljs-keyword">throw</span> exception;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warning</span><span class="hljs-params">(SAXParseException exception)</span> <span class="hljs-keyword">throws</span> SAXException &#123;<br>        &#125;<br>      &#125;);<br>      <span class="hljs-keyword">return</span> builder.parse(inputSource);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderException</span>(<span class="hljs-string">&quot;Error creating document instance.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="XNode"><a href="#XNode" class="headerlink" title="XNode"></a>XNode</h4><p>Â Â Â Â å¯¹<code>org.w3c.dom.Node</code>çš„åŒ…è£…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XNode</span> &#123; <br>  <span class="hljs-comment">// org.w3c.dom.Node</span><br>  <span class="hljs-keyword">private</span> Node node; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹éƒ½æ˜¯é¢„å…ˆæŠŠä¿¡æ¯éƒ½è§£æå¥½ï¼Œæ”¾åˆ°mapç­‰æ•°æ®ç»“æ„ä¸­ï¼ˆå†…å­˜ä¸­ï¼‰</span><br>  <span class="hljs-keyword">private</span> String name;<br>  <span class="hljs-keyword">private</span> String body;<br>  <span class="hljs-keyword">private</span> Properties attributes;<br>  <span class="hljs-keyword">private</span> Properties variables;<br>  <span class="hljs-comment">// XPathParseræ–¹ä¾¿xpathè§£æ</span><br>  <span class="hljs-keyword">private</span> XPathParser xpathParser; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">XNode</span><span class="hljs-params">(XPathParser xpathParser, Node node, Properties variables)</span> &#123;<br>    <span class="hljs-built_in">this</span>.xpathParser = xpathParser;<br>    <span class="hljs-built_in">this</span>.node = node;<br>    <span class="hljs-built_in">this</span>.name = node.getNodeName();<br>    <span class="hljs-built_in">this</span>.variables = variables;<br>    <span class="hljs-built_in">this</span>.attributes = parseAttributes(node);<br>    <span class="hljs-built_in">this</span>.body = parseBody(node);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> XNode <span class="hljs-title function_">newXNode</span><span class="hljs-params">(Node node)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XNode</span>(xpathParser, node, variables);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> XNode <span class="hljs-title function_">getParent</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// è°ƒç”¨Node.getParentNode,å¦‚æœå–åˆ°ï¼ŒåŒ…è£…ä¸€ä¸‹ï¼Œè¿”å›XNode</span><br>    <span class="hljs-type">Node</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> node.getParentNode();<br>    <span class="hljs-keyword">if</span> (parent == <span class="hljs-literal">null</span> || !(parent <span class="hljs-keyword">instanceof</span> Element)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XNode</span>(xpathParser, parent, variables);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å–å¾—å®Œå…¨çš„path (a/b/c)</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPath</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// å¾ªç¯ä¾æ¬¡å–å¾—èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œç„¶åå€’åºæ‰“å°,ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªå †æ ˆå®ç°</span><br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-type">Node</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> node;<br>    <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span> &amp;&amp; current <span class="hljs-keyword">instanceof</span> Element) &#123;<br>      <span class="hljs-keyword">if</span> (current != node) &#123;<br>        builder.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;/&quot;</span>);<br>      &#125;<br>      builder.insert(<span class="hljs-number">0</span>, current.getNodeName());<br>      current = current.getParentNode();<br>    &#125;<br>    <span class="hljs-keyword">return</span> builder.toString();<br>  &#125; <br><br>  <span class="hljs-comment">// å–å¾—æ ‡ç¤ºç¬¦   (&quot;resultMap[authorResult]&quot;)</span><br>  <span class="hljs-comment">// XMLMapperBuilder.resultMapElementè°ƒç”¨</span><br>  <span class="hljs-comment">//&lt;resultMap id=&quot;authorResult&quot; type=&quot;Author&quot;&gt;</span><br>  <span class="hljs-comment">//  &lt;id property=&quot;id&quot; column=&quot;author_id&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;result property=&quot;username&quot; column=&quot;author_username&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;result property=&quot;password&quot; column=&quot;author_password&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;result property=&quot;email&quot; column=&quot;author_email&quot;/&gt;</span><br>  <span class="hljs-comment">//  &lt;result property=&quot;bio&quot; column=&quot;author_bio&quot;/&gt;</span><br>  <span class="hljs-comment">//&lt;/resultMap&gt;</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getValueBasedIdentifier</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    <span class="hljs-type">XNode</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>;<br>    <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">if</span> (current != <span class="hljs-built_in">this</span>) &#123;<br>        builder.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;_&quot;</span>);<br>      &#125;<br>      <span class="hljs-comment">// å…ˆæ‹¿idï¼Œæ‹¿ä¸åˆ°å†æ‹¿value,å†æ‹¿ä¸åˆ°æ‹¿property</span><br>      <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> current.getStringAttribute(<span class="hljs-string">&quot;id&quot;</span>,<br>          current.getStringAttribute(<span class="hljs-string">&quot;value&quot;</span>,<br>              current.getStringAttribute(<span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-literal">null</span>)));<br>      <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>        value = value.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;_&#x27;</span>);<br>        builder.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;]&quot;</span>);<br>        builder.insert(<span class="hljs-number">0</span>,<br>            value);<br>        builder.insert(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;[&quot;</span>);<br>      &#125;<br>      builder.insert(<span class="hljs-number">0</span>, current.getName());<br>      current = current.getParent();<br>    &#125;<br>    <span class="hljs-keyword">return</span> builder.toString();<br>  &#125; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹æ–¹æ³•éƒ½æ˜¯å§”æ‰˜ç»™XPathParserå®ç°</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">evalString</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> xpathParser.evalString(node, expression);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">evalBoolean</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> xpathParser.evalBoolean(node, expression);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">evalDouble</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> xpathParser.evalDouble(node, expression);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> List&lt;XNode&gt; <span class="hljs-title function_">evalNodes</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> xpathParser.evalNodes(node, expression);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> XNode <span class="hljs-title function_">evalNode</span><span class="hljs-params">(String expression)</span> &#123;<br>    <span class="hljs-keyword">return</span> xpathParser.evalNode(node, expression);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Node <span class="hljs-title function_">getNode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> node;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> name;<br>  &#125; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹æ˜¯ä¸€äº›getBodyçš„æ–¹æ³•</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStringBody</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> getStringBody(<span class="hljs-literal">null</span>);<br>  &#125; <br><br>  <span class="hljs-comment">// bodyä¸ºç©ºè¿”å›defï¼Œä¸‹é¢ç±»ä¼¼</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStringBody</span><span class="hljs-params">(String def)</span> &#123;<br>    <span class="hljs-keyword">if</span> (body == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> body;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">getBooleanBody</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> getBooleanBody(<span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">getBooleanBody</span><span class="hljs-params">(Boolean def)</span> &#123;<br>    <span class="hljs-keyword">if</span> (body == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Boolean.valueOf(body);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getIntBody</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> getIntBody(<span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getIntBody</span><span class="hljs-params">(Integer def)</span> &#123;<br>    <span class="hljs-keyword">if</span> (body == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Integer.parseInt(body);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getLongBody</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> getLongBody(<span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getLongBody</span><span class="hljs-params">(Long def)</span> &#123;<br>    <span class="hljs-keyword">if</span> (body == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Long.parseLong(body);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getDoubleBody</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> getDoubleBody(<span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getDoubleBody</span><span class="hljs-params">(Double def)</span> &#123;<br>    <span class="hljs-keyword">if</span> (body == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Double.parseDouble(body);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Float <span class="hljs-title function_">getFloatBody</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> getFloatBody(<span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Float <span class="hljs-title function_">getFloatBody</span><span class="hljs-params">(Float def)</span> &#123;<br>    <span class="hljs-keyword">if</span> (body == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Float.parseFloat(body);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹æ˜¯ä¸€äº›getAttributeçš„æ–¹æ³•</span><br>  <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;T&gt;&gt; T <span class="hljs-title function_">getEnumAttribute</span><span class="hljs-params">(Class&lt;T&gt; enumType, String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> getEnumAttribute(enumType, name, <span class="hljs-literal">null</span>);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;T&gt;&gt; T <span class="hljs-title function_">getEnumAttribute</span><span class="hljs-params">(Class&lt;T&gt; enumType, String name, T def)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> getStringAttribute(name);<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Enum.valueOf(enumType, value);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStringAttribute</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> getStringAttribute(name, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStringAttribute</span><span class="hljs-params">(String name, String def)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> attributes.getProperty(name);<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> value;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">getBooleanAttribute</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> getBooleanAttribute(name, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">getBooleanAttribute</span><span class="hljs-params">(String name, Boolean def)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> attributes.getProperty(name);<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Boolean.valueOf(value);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getIntAttribute</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> getIntAttribute(name, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getIntAttribute</span><span class="hljs-params">(String name, Integer def)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> attributes.getProperty(name);<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Integer.parseInt(value);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getLongAttribute</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> getLongAttribute(name, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getLongAttribute</span><span class="hljs-params">(String name, Long def)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> attributes.getProperty(name);<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Long.parseLong(value);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getDoubleAttribute</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> getDoubleAttribute(name, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getDoubleAttribute</span><span class="hljs-params">(String name, Double def)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> attributes.getProperty(name);<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Double.parseDouble(value);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> Float <span class="hljs-title function_">getFloatAttribute</span><span class="hljs-params">(String name)</span> &#123;<br>    <span class="hljs-keyword">return</span> getFloatAttribute(name, <span class="hljs-literal">null</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> Float <span class="hljs-title function_">getFloatAttribute</span><span class="hljs-params">(String name, Float def)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> attributes.getProperty(name);<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">return</span> def;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> Float.parseFloat(value);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å¾—åˆ°å­©å­ï¼ŒåŸç†æ˜¯è°ƒç”¨Node.getChildNodes</span><br>  <span class="hljs-keyword">public</span> List&lt;XNode&gt; <span class="hljs-title function_">getChildren</span><span class="hljs-params">()</span> &#123;<br>    List&lt;XNode&gt; children = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;XNode&gt;();<br>    <span class="hljs-type">NodeList</span> <span class="hljs-variable">nodeList</span> <span class="hljs-operator">=</span> node.getChildNodes();<br>    <span class="hljs-keyword">if</span> (nodeList != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, n = nodeList.getLength(); i &lt; n; i++) &#123;<br>        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> nodeList.item(i);<br>        <span class="hljs-keyword">if</span> (node.getNodeType() == Node.ELEMENT_NODE) &#123;<br>          children.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">XNode</span>(xpathParser, node, variables));<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> children;<br>  &#125; <br><br>  <span class="hljs-comment">// å¾—åˆ°å­©å­ï¼Œè¿”å›Propertiesï¼Œä»å­èŠ‚ç‚¹ä¸­æå–nameå’Œvalueä½œä¸ºå±æ€§</span><br>  <span class="hljs-keyword">public</span> Properties <span class="hljs-title function_">getChildrenAsProperties</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>    <span class="hljs-keyword">for</span> (XNode child : getChildren()) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;name&quot;</span>);<br>      <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> child.getStringAttribute(<span class="hljs-string">&quot;value&quot;</span>);<br>      <span class="hljs-keyword">if</span> (name != <span class="hljs-literal">null</span> &amp;&amp; value != <span class="hljs-literal">null</span>) &#123;<br>        properties.setProperty(name, value);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> properties;<br>  &#125; <br><br>  <span class="hljs-comment">// æ‰“å°ä¿¡æ¯ï¼Œä¸ºäº†è°ƒè¯•ç”¨</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    builder.append(<span class="hljs-string">&quot;&lt;&quot;</span>);<br>    builder.append(name);<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : attributes.entrySet()) &#123;<br>      builder.append(<span class="hljs-string">&quot; &quot;</span>);<br>      builder.append(entry.getKey());<br>      builder.append(<span class="hljs-string">&quot;=\&quot;&quot;</span>);<br>      builder.append(entry.getValue());<br>      builder.append(<span class="hljs-string">&quot;\&quot;&quot;</span>);<br>    &#125;<br>    List&lt;XNode&gt; children = getChildren();<br>    <span class="hljs-keyword">if</span> (!children.isEmpty()) &#123;<br>      builder.append(<span class="hljs-string">&quot;&gt;\n&quot;</span>);<br>      <span class="hljs-keyword">for</span> (XNode node : children) &#123;<br>        <span class="hljs-comment">//é€’å½’å–å¾—å­©å­çš„toString</span><br>        builder.append(node.toString());<br>      &#125;<br>      builder.append(<span class="hljs-string">&quot;&lt;/&quot;</span>);<br>      builder.append(name);<br>      builder.append(<span class="hljs-string">&quot;&gt;&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (body != <span class="hljs-literal">null</span>) &#123;<br>      builder.append(<span class="hljs-string">&quot;&gt;&quot;</span>);<br>      builder.append(body);<br>      builder.append(<span class="hljs-string">&quot;&lt;/&quot;</span>);<br>      builder.append(name);<br>      builder.append(<span class="hljs-string">&quot;&gt;&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      builder.append(<span class="hljs-string">&quot;/&gt;&quot;</span>);<br>    &#125;<br>    builder.append(<span class="hljs-string">&quot;\n&quot;</span>);<br>    <span class="hljs-keyword">return</span> builder.toString();<br>  &#125; <br><br>  <span class="hljs-comment">// ä»¥ä¸‹2ä¸ªæ–¹æ³•åœ¨æ„é€ æ—¶å°±è§£æ</span><br>  <span class="hljs-keyword">private</span> Properties <span class="hljs-title function_">parseAttributes</span><span class="hljs-params">(Node n)</span> &#123;<br>    <span class="hljs-type">Properties</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>    <span class="hljs-type">NamedNodeMap</span> <span class="hljs-variable">attributeNodes</span> <span class="hljs-operator">=</span> n.getAttributes();<br>    <span class="hljs-keyword">if</span> (attributeNodes != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; attributeNodes.getLength(); i++) &#123;<br>        <span class="hljs-type">Node</span> <span class="hljs-variable">attribute</span> <span class="hljs-operator">=</span> attributeNodes.item(i);<br>        <span class="hljs-comment">// è§£æå±æ€§èŠ‚ç‚¹valueä¸­çš„ $&#123;content&#125; å†…å®¹</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> PropertyParser.parse(attribute.getNodeValue(), variables);<br>        attributes.put(attribute.getNodeName(), value);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> attributes;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">parseBody</span><span class="hljs-params">(Node node)</span> &#123;<br>    <span class="hljs-comment">// å–ä¸åˆ°bodyï¼Œå¾ªç¯å–å­©å­çš„bodyï¼Œåªè¦å–åˆ°ç¬¬ä¸€ä¸ªï¼Œç«‹å³è¿”å›</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> getBodyData(node);<br>    <span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-type">NodeList</span> <span class="hljs-variable">children</span> <span class="hljs-operator">=</span> node.getChildNodes();<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; children.getLength(); i++) &#123;<br>        <span class="hljs-type">Node</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> children.item(i);<br>        data = getBodyData(child);<br>        <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">break</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> data;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getBodyData</span><span class="hljs-params">(Node child)</span> &#123;<br>    <span class="hljs-keyword">if</span> (child.getNodeType() == Node.CDATA_SECTION_NODE<br>        || child.getNodeType() == Node.TEXT_NODE) &#123;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> ((CharacterData) child).getData();<br>      data = PropertyParser.parse(data, variables);<br>      <span class="hljs-keyword">return</span> data;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ReentrantReadWriteLockæºç è§£æ</title>
    <link href="/2023/06/03/java-source-code/ReentrantReadWriteLock%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/03/java-source-code/ReentrantReadWriteLock%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h4 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h4><p>Â Â Â Â è¿™ç¯‡åšå®¢æˆ‘ä»¬æ¥é˜…è¯» ReentrantReadWriteLock çš„æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantReadWriteLock</span><br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ReadWriteLock</span>, java.io.Serializable &#123; <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">6992448646407690164L</span>;<br>   <br>     <span class="hljs-comment">/** Inner class providing readlock */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;<br>    <span class="hljs-comment">/** Inner class providing writelock */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;<br><br>    <span class="hljs-comment">/** Performs all synchronization mechanics */</span><br>    <span class="hljs-keyword">final</span> Sync sync; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Creates a new code ReentrantReadWriteLock with</span><br><span class="hljs-comment">     * default (nonfair) ordering properties.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReentrantReadWriteLock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// é»˜è®¤æ˜¯éå…¬å¹³çš„</span><br>        <span class="hljs-built_in">this</span>(<span class="hljs-literal">false</span>);<br>    &#125; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Creates a new ReentrantReadWriteLock with</span><br><span class="hljs-comment">     * the given fairness policy.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fair &#123;<span class="hljs-doctag">@code</span> true&#125; if this lock should use a fair ordering policy</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReentrantReadWriteLock</span><span class="hljs-params">(<span class="hljs-type">boolean</span> fair)</span> &#123;<br>        sync = fair ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">FairSync</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>();<br>        readerLock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReadLock</span>(<span class="hljs-built_in">this</span>);<br>        writerLock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WriteLock</span>(<span class="hljs-built_in">this</span>);<br>    &#125; <br><br>    <span class="hljs-comment">// å®ç° ReadWriteLock æ¥å£çš„æ–¹æ³• ï¼Œæä¾›æ¥å£è·å–è¯»é”çš„å†™é”</span><br>    <span class="hljs-keyword">public</span> ReentrantReadWriteLock.WriteLock <span class="hljs-title function_">writeLock</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> writerLock; &#125;<br>    <span class="hljs-keyword">public</span> ReentrantReadWriteLock.ReadLock  <span class="hljs-title function_">readLock</span><span class="hljs-params">()</span>  &#123; <span class="hljs-keyword">return</span> readerLock; &#125;<br><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> &#123; <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">6317671515068378041L</span>;<br>                <br>        <span class="hljs-comment">// å¯¹è¯»å–å’Œå†™å…¥è®¡æ•°è¿›è¡ŒæŠ½å–çš„å¸¸é‡å’Œå‡½æ•°</span><br>        <span class="hljs-comment">// é”å®šstateåœ¨é€»è¾‘ä¸Šåˆ†ä¸ºä¸¤ä¸ªæ— ç¬¦å·short:</span><br>        <span class="hljs-comment">// stateä½16ä½è¡¨ç¤ºç‹¬å ï¼ˆå†™ï¼‰é”æŒæœ‰è®¡æ•°</span><br>        <span class="hljs-comment">// stateé«˜16ä½æ ‡è¯†å…±äº«ï¼ˆè¯»ï¼‰é”æŒæœ‰è®¡æ•°</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_SHIFT</span>   <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;<br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_UNIT</span>    <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT);<br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_COUNT</span>      <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXCLUSIVE_MASK</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="hljs-number">1</span>; <br><br>        <span class="hljs-comment">/** Returns the number of shared holds represented in count. */</span><br>        <span class="hljs-comment">// cå³ç§»16ä½ï¼Œè·å–é«˜16ä½</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sharedCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>    &#123; <span class="hljs-keyword">return</span> c &gt;&gt;&gt; SHARED_SHIFT; &#125;<br><br>        <span class="hljs-comment">/** Returns the number of exclusive holds represented in count. */</span><br>        <span class="hljs-comment">// è·å–cçš„ä½16ä½</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">exclusiveCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span> &#123; <span class="hljs-keyword">return</span> c &amp; EXCLUSIVE_MASK; &#125; <br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * A counter for per-thread read hold counts.</span><br><span class="hljs-comment">         * Maintained as a ThreadLocal; cached in cachedHoldCounter.</span><br><span class="hljs-comment">         * æ¯ä¸ªçº¿ç¨‹å…±äº«é”è®¡æ•°</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HoldCounter</span> &#123;<br>            <span class="hljs-type">int</span> count;          <span class="hljs-comment">// initially 0</span><br>            <span class="hljs-comment">// Use id, not reference, to avoid garbage retention </span><br>            <span class="hljs-comment">// ä¸æŒæœ‰çº¿ç¨‹å¼•ç”¨ï¼Œä¾¿äºåƒåœ¾å›æ”¶</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">tid</span> <span class="hljs-operator">=</span> LockSupport.getThreadId(Thread.currentThread());<br>        &#125; <br><br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalHoldCounter</span><br>            <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThreadLocal</span>&lt;HoldCounter&gt; &#123;<br>            <span class="hljs-keyword">public</span> HoldCounter <span class="hljs-title function_">initialValue</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HoldCounter</span>();<br>            &#125;<br>        &#125; <br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * The number of reentrant read locks held by current thread.</span><br><span class="hljs-comment">         * Initialized only in constructor and readObject.</span><br><span class="hljs-comment">         * Removed whenever a thread&#x27;s read hold count drops to 0. </span><br><span class="hljs-comment">         * å½“å‰çº¿ç¨‹æŒæœ‰çš„å¯é‡å…¥è¯»é”çš„æ•°é‡ã€‚</span><br><span class="hljs-comment">         * ä»…åœ¨æ„é€ å‡½æ•°å’ŒreadObjectä¸­åˆå§‹åŒ–ã€‚æ¯å½“çº¿ç¨‹çš„è¯»ä¿æŒè®¡æ•°ä¸‹é™åˆ°0æ—¶ç§»é™¤ã€‚</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> ThreadLocalHoldCounter readHolds; <br><br>        <span class="hljs-comment">// æˆåŠŸè·å–readLockçš„æœ€åä¸€ä¸ªçº¿ç¨‹çš„ä¿æŒè®¡æ•°ã€‚</span><br>        <span class="hljs-comment">// åœ¨ä¸‹ä¸€ä¸ªè¦é‡Šæ”¾çš„çº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªè·å–çš„çº¿ç¨‹çš„å¸¸è§æƒ…å†µä¸‹ï¼Œ</span><br>        <span class="hljs-comment">// å¯ä»¥èŠ‚çœThreadLocalæŸ¥æ‰¾</span><br>        <span class="hljs-comment">// è¿™æ˜¯évolatileçš„ï¼Œå› ä¸ºå®ƒåªæ˜¯ç”¨ä½œä¸€ç§å¯å‘å¼æ­¥éª¤ï¼Œå¯¹äºè¦ç¼“å­˜çš„çº¿ç¨‹å¾ˆå¥½</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> HoldCounter cachedHoldCounter;<br><br>        <span class="hljs-comment">// firstReaderæ˜¯ç¬¬ä¸€ä¸ªè·å¾—è¯»é”çš„çº¿ç¨‹</span><br>        <span class="hljs-comment">// æ›´å‡†ç¡®åœ°è¯´ï¼ŒfirstReaderæ˜¯ä¸Šä¸€æ¬¡å°†å…±äº«è®¡æ•°ä»0æ›´æ”¹ä¸º1çš„æƒŸä¸€çº¿ç¨‹ï¼Œ</span><br>        <span class="hljs-comment">// å¹¶ä¸”ä»é‚£æ—¶èµ·å°±æ²¡æœ‰é‡Šæ”¾è¿‡è¯»é”ï¼›å¦‚æœæ²¡æœ‰è¿™æ ·çš„çº¿ç¨‹ï¼Œåˆ™ä¸ºnullã€‚</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Thread firstReader;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-type">int</span> firstReaderHoldCount;<br><br>        Sync() &#123;<br>            readHolds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalHoldCounter</span>(); <br>            <span class="hljs-comment">// state æ˜¯ volatile å˜é‡ï¼Œä¿è¯readHoldsçš„å¯è§æ€§</span><br>            setState(getState()); <span class="hljs-comment">// ensures visibility of readHolds</span><br>        &#125; <br><br>        <span class="hljs-comment">// è·å–å’Œé‡Šæ”¾å¯¹å…¬å¹³é”å’Œéå…¬å¹³é”ä½¿ç”¨ç›¸åŒçš„ä»£ç ï¼Œ</span><br>        <span class="hljs-comment">// ä½†æ˜¯åœ¨é˜Ÿåˆ—éç©ºæ—¶ï¼Œå®ƒä»¬ æ˜¯å¦/å¦‚ä½• å…è®¸å…¥é˜Ÿæ–¹é¢æœ‰æ‰€ä¸åŒã€‚</span><br><br><br>        <span class="hljs-comment">// å¦‚æœå½“å‰çº¿ç¨‹åœ¨å°è¯•è·å–è¯»é”æˆ–è€…åœ¨å…¶ä»–æœ‰èµ„æ ¼è·å–è¯»é”çš„æƒ…å†µä¸‹</span><br>        <span class="hljs-comment">// ç”±äºè¶…è¶Šå…¶ä»–ç­‰å¾…çº¿ç¨‹è€Œåº”è¯¥è¢«é˜»å¡ï¼Œåˆ™è¿”å›true</span><br>        <span class="hljs-keyword">abstract</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">readerShouldBlock</span><span class="hljs-params">()</span>;<br><br>        <span class="hljs-comment">// å’Œä¸Šé¢æ–¹æ³•ç›¸ä¼¼</span><br>        <span class="hljs-keyword">abstract</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">writerShouldBlock</span><span class="hljs-params">()</span>; <br><br>        <span class="hljs-comment">// æ³¨æ„tryReleaseå’ŒtryAcquireå¯ä»¥è¢«æ¡ä»¶è°ƒç”¨ã€‚</span><br>        <span class="hljs-comment">// å› æ­¤ï¼Œå®ƒä»¬çš„å‚æ•°å¯èƒ½åŒ…å«è¯»å–å’Œå†™å…¥æŒæœ‰é‡ï¼Œ</span><br>        <span class="hljs-comment">// è¿™äº›æŒæœ‰é‡éƒ½æ˜¯åœ¨æ¡ä»¶ç­‰å¾…æœŸé—´é‡Šæ”¾çš„ï¼Œå¹¶åœ¨tryAcquireä¸­é‡æ–°å»ºç«‹ã€‚</span><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> &#123;<br>            <span class="hljs-keyword">if</span> (!isHeldExclusively())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> getState() - releases;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">free</span> <span class="hljs-operator">=</span> exclusiveCount(nextc) == <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">if</span> (free)<br>                setExclusiveOwnerThread(<span class="hljs-literal">null</span>);<br>            setState(nextc);<br>            <span class="hljs-keyword">return</span> free;<br>        &#125; <br><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123; <br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> exclusiveCount(c);<br>            <span class="hljs-keyword">if</span> (c != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// (Note: if c != 0 and w == 0 then shared count != 0) </span><br>                <span class="hljs-comment">// è¯»æŒæœ‰é0ï¼ˆæ­£åœ¨è¯»çš„æ—¶å€™å…¶ä»–çº¿ç¨‹ä¸èƒ½è·å–é”æ¥å†™ï¼Ÿï¼‰ </span><br>                <span class="hljs-comment">// æˆ–è€… é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰</span><br>                <span class="hljs-keyword">if</span> (w == <span class="hljs-number">0</span> || current != getExclusiveOwnerThread())<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                <span class="hljs-comment">// å½“å‰çº¿ç¨‹æŒæœ‰é”ï¼Œä½†æ˜¯é”é‡å…¥è¶…è¿‡ä¸Šé™</span><br>                <span class="hljs-keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Maximum lock count exceeded&quot;</span>);<br>                <span class="hljs-comment">// Reentrant acquire</span><br>                setState(c + acquires);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125; <br>            <span class="hljs-comment">// éå…¬å¹³è·å–å†™é”åº”è¯¥è¢«é˜»å¡ æˆ–è€… è·å–å†™é”å¤±è´¥</span><br>            <span class="hljs-keyword">if</span> (writerShouldBlock() ||<br>                !compareAndSetState(c, c + acquires))<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            setExclusiveOwnerThread(current);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <br><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> unused)</span> &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread(); <br>            <span class="hljs-comment">// é‡Šæ”¾è¯»é”çš„çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span><br>            <span class="hljs-keyword">if</span> (firstReader == current) &#123;<br>                <span class="hljs-comment">// assert firstReaderHoldCount &gt; 0;</span><br>                <span class="hljs-keyword">if</span> (firstReaderHoldCount == <span class="hljs-number">1</span>)<br>                    firstReader = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">else</span><br>                    firstReaderHoldCount--;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// å…¶ä»–çº¿ç¨‹æ¥è·å–è¯»é”</span><br>                <span class="hljs-type">HoldCounter</span> <span class="hljs-variable">rh</span> <span class="hljs-operator">=</span> cachedHoldCounter;<br>                <span class="hljs-comment">// åˆ¤æ–­ç¼“å­˜çš„ HoldCounter æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹çš„ HoldCounter </span><br>                <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span> ||<br>                    rh.tid != LockSupport.getThreadId(current))<br>                    rh = readHolds.get();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> rh.count;<br>                <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-comment">// çº¿ç¨‹å–æ¶ˆæŒæœ‰è¯»é”</span><br>                    readHolds.remove();<br>                    <span class="hljs-keyword">if</span> (count &lt;= <span class="hljs-number">0</span>)<br>                        <span class="hljs-keyword">throw</span> unmatchedUnlockException();<br>                &#125;<br>                --rh.count;<br>            &#125;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();<br>                <span class="hljs-comment">// è¯»é”æŒæœ‰é‡å‡1</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> c - SHARED_UNIT;<br>                <span class="hljs-keyword">if</span> (compareAndSetState(c, nextc))<br>                    <span class="hljs-comment">// é‡Šæ”¾è¯»é”å¯¹è¯»å–è€…æ²¡æœ‰å½±å“ï¼Œ</span><br>                    <span class="hljs-comment">// ä½†æ˜¯å¦‚æœè¯»é”å’Œå†™é”ç°åœ¨éƒ½æ˜¯å¯è·å–çš„ï¼Œ</span><br>                    <span class="hljs-comment">// å®ƒå¯èƒ½ä½¿å¾—ç­‰å¾…çš„å†™å…¥è€…ç«äº‰å†™é”ã€‚</span><br>                    <span class="hljs-keyword">return</span> nextc == <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125; <br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> IllegalMonitorStateException <span class="hljs-title function_">unmatchedUnlockException</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>(<br>                <span class="hljs-string">&quot;attempt to unlock read lock, not locked by current thread&quot;</span>);<br>        &#125; <br><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> unused)</span> &#123; <br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState(); <br>            <span class="hljs-comment">// å†™é”è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œè·å–è¯»é”å¤±è´¥</span><br>            <span class="hljs-keyword">if</span> (exclusiveCount(c) != <span class="hljs-number">0</span> &amp;&amp;<br>                getExclusiveOwnerThread() != current)<br>                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> sharedCount(c);<br>            <span class="hljs-keyword">if</span> (!readerShouldBlock() &amp;&amp;<br>                r &lt; MAX_COUNT &amp;&amp;<br>                compareAndSetState(c, c + SHARED_UNIT)) &#123; <br>                <span class="hljs-comment">// è¯»æŒæœ‰è®¡æ•°ä¸º0å³è¿˜æ²¡æœ‰çº¿ç¨‹æŒæœ‰è¯»é”</span><br>                <span class="hljs-keyword">if</span> (r == <span class="hljs-number">0</span>) &#123;<br>                    firstReader = current;<br>                    firstReaderHoldCount = <span class="hljs-number">1</span>;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (firstReader == current) &#123;<br>                    firstReaderHoldCount++;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-type">HoldCounter</span> <span class="hljs-variable">rh</span> <span class="hljs-operator">=</span> cachedHoldCounter;<br>                    <span class="hljs-comment">// å¦‚æœç¼“å­˜çš„ HoldCounter ä¸æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰çš„ HoldCounter </span><br>                    <span class="hljs-comment">// ä» readHolds å– å¹¶è®¾ç½® ç¼“å­˜çš„HoldCounterï¼ˆcachedHoldCounterï¼‰</span><br>                    <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span> ||<br>                        rh.tid != LockSupport.getThreadId(current))<br>                        cachedHoldCounter = rh = readHolds.get();<br>                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rh.count == <span class="hljs-number">0</span>) <span class="hljs-comment">// cachedHoldCounteræ˜¯å½“å‰çº¿ç¨‹æŒæœ‰çš„HoldCounter</span><br>                        readHolds.set(rh);<br>                    rh.count++;<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> fullTryAcquireShared(current);<br>        &#125; <br><br>        <span class="hljs-comment">// è·å–è¯»é”çš„å®Œæ•´ç‰ˆæœ¬ï¼Œå¤„ç†CASæœªå‘½ä¸­å’Œå†æ¬¡è¯»å–çš„æƒ…å†µï¼Œ</span><br>        <span class="hljs-comment">// è€ŒtryAcquireSharedä¸­æ²¡æœ‰å¤„ç†ã€‚</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fullTryAcquireShared</span><span class="hljs-params">(Thread current)</span> &#123;<br>            <span class="hljs-type">HoldCounter</span> <span class="hljs-variable">rh</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();<br>                <span class="hljs-comment">// è¿™é‡Œçš„æ£€æŸ¥æ˜¯è€ƒè™‘åˆ°å¹¶å‘æƒ…å†µä¸‹å…¶ä»–çº¿ç¨‹æŒæœ‰äº†å†™é”</span><br>                <span class="hljs-keyword">if</span> (exclusiveCount(c) != <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">if</span> (getExclusiveOwnerThread() != current)<br>                        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>                    <span class="hljs-comment">// else we hold the exclusive lock; blocking here</span><br>                    <span class="hljs-comment">// would cause deadlock.</span><br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (readerShouldBlock()) &#123;<br>                    <span class="hljs-comment">// Make sure we&#x27;re not acquiring read lock reentrantly </span><br>                    <span class="hljs-comment">// ç¡®ä¿æˆ‘ä»¬ä¸æ˜¯åœ¨å†æ¬¡è·å–è¯»é” </span><br>                    <span class="hljs-comment">// å³è®©å…¶ä»–çº¿ç¨‹å…ˆè·å–è¯»é”</span><br>                    <span class="hljs-keyword">if</span> (firstReader == current) &#123;<br>                        <span class="hljs-comment">// assert firstReaderHoldCount &gt; 0;</span><br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span>) &#123;<br>                            rh = cachedHoldCounter;<br>                            <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span> ||<br>                                rh.tid != LockSupport.getThreadId(current)) &#123;<br>                                rh = readHolds.get();<br>                                <span class="hljs-keyword">if</span> (rh.count == <span class="hljs-number">0</span>)<br>                                    readHolds.remove();<br>                            &#125;<br>                        &#125; <br>                        <span class="hljs-comment">// å¦‚æœçº¿ç¨‹æ˜¯ç¬¬ä¸€æ¬¡è·å–è¯»é”ï¼Œç›´æ¥è¿”å›</span><br>                        <span class="hljs-keyword">if</span> (rh.count == <span class="hljs-number">0</span>)<br>                            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (sharedCount(c) == MAX_COUNT)<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Maximum lock count exceeded&quot;</span>);<br>                <span class="hljs-keyword">if</span> (compareAndSetState(c, c + SHARED_UNIT)) &#123;<br>                    <span class="hljs-keyword">if</span> (sharedCount(c) == <span class="hljs-number">0</span>) &#123;<br>                        firstReader = current;<br>                        firstReaderHoldCount = <span class="hljs-number">1</span>;<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (firstReader == current) &#123;<br>                        firstReaderHoldCount++;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span>)<br>                            rh = cachedHoldCounter;<br>                        <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span> ||<br>                            rh.tid != LockSupport.getThreadId(current))<br>                            rh = readHolds.get();<br>                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rh.count == <span class="hljs-number">0</span>)<br>                            readHolds.set(rh);<br>                        rh.count++;<br>                        cachedHoldCounter = rh; <span class="hljs-comment">// cache for release</span><br>                    &#125;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>                &#125;<br>            &#125;<br>        &#125; <br><br>        <span class="hljs-comment">// å¯¹å†™æ“ä½œæ‰§è¡ŒtryLockï¼Œåœ¨ä¸¤ç§æ¨¡å¼ä¸‹éƒ½å…è®¸ã€‚</span><br>        <span class="hljs-comment">// è¿™å®é™…ä¸Šä¸tryAcquireç›¸åŒï¼Œåªæ˜¯ç¼ºå°‘å¯¹writerShouldBlockçš„è°ƒç”¨ã€‚</span><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryWriteLock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();<br>            <span class="hljs-keyword">if</span> (c != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> exclusiveCount(c);<br>                <span class="hljs-keyword">if</span> (w == <span class="hljs-number">0</span> || current != getExclusiveOwnerThread())<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">if</span> (w == MAX_COUNT)<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Maximum lock count exceeded&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!compareAndSetState(c, c + <span class="hljs-number">1</span>))<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            setExclusiveOwnerThread(current);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <br><br>        <span class="hljs-comment">// å’ŒtryWriteLockç±»ä¼¼</span><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReadLock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();<br>                <span class="hljs-keyword">if</span> (exclusiveCount(c) != <span class="hljs-number">0</span> &amp;&amp;<br>                    getExclusiveOwnerThread() != current)<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> sharedCount(c);<br>                <span class="hljs-keyword">if</span> (r == MAX_COUNT)<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Maximum lock count exceeded&quot;</span>);<br>                <span class="hljs-keyword">if</span> (compareAndSetState(c, c + SHARED_UNIT)) &#123;<br>                    <span class="hljs-keyword">if</span> (r == <span class="hljs-number">0</span>) &#123;<br>                        firstReader = current;<br>                        firstReaderHoldCount = <span class="hljs-number">1</span>;<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (firstReader == current) &#123;<br>                        firstReaderHoldCount++;<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        <span class="hljs-type">HoldCounter</span> <span class="hljs-variable">rh</span> <span class="hljs-operator">=</span> cachedHoldCounter;<br>                        <span class="hljs-keyword">if</span> (rh == <span class="hljs-literal">null</span> ||<br>                            rh.tid != LockSupport.getThreadId(current))<br>                            cachedHoldCounter = rh = readHolds.get();<br>                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rh.count == <span class="hljs-number">0</span>)<br>                            readHolds.set(rh);<br>                        rh.count++;<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125;<br>        &#125; <br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// While we must in general read state before owner,</span><br>            <span class="hljs-comment">// we don&#x27;t need to do so to check if current thread is owner</span><br>            <span class="hljs-keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();<br>        &#125; <br><br>        <span class="hljs-comment">// ä¸‹é¢æ˜¯ä¸å¤–éƒ¨ç±»ç›¸å…³çš„æ–¹æ³•</span><br><br>        <span class="hljs-keyword">final</span> ConditionObject <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionObject</span>();<br>        &#125; <br><br>        <span class="hljs-keyword">final</span> Thread <span class="hljs-title function_">getOwner</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// Must read state before owner to ensure memory consistency</span><br>            <span class="hljs-keyword">return</span> ((exclusiveCount(getState()) == <span class="hljs-number">0</span>) ?<br>                    <span class="hljs-literal">null</span> :<br>                    getExclusiveOwnerThread());<br>        &#125; <br><br>        <span class="hljs-comment">// è·å–è¯»é”æ•°é‡</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getReadLockCount</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> sharedCount(getState());<br>        &#125; <br><br>        <span class="hljs-comment">// æ˜¯å¦æœ‰çº¿ç¨‹æŒæœ‰å†™é”</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWriteLocked</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> exclusiveCount(getState()) != <span class="hljs-number">0</span>;<br>        &#125; <br><br>        <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹çš„å†™é”æŒæœ‰é‡</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getWriteHoldCount</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> isHeldExclusively() ? exclusiveCount(getState()) : <span class="hljs-number">0</span>;<br>        &#125; <br><br>        <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹çš„è¯»é”æŒæœ‰é‡</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getReadHoldCount</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span> (getReadLockCount() == <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>            <span class="hljs-keyword">if</span> (firstReader == current)<br>                <span class="hljs-keyword">return</span> firstReaderHoldCount;<br><br>            <span class="hljs-type">HoldCounter</span> <span class="hljs-variable">rh</span> <span class="hljs-operator">=</span> cachedHoldCounter;<br>            <span class="hljs-keyword">if</span> (rh != <span class="hljs-literal">null</span> &amp;&amp; rh.tid == LockSupport.getThreadId(current))<br>                <span class="hljs-keyword">return</span> rh.count;<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> readHolds.get().count;<br>            <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) readHolds.remove();<br>            <span class="hljs-keyword">return</span> count;<br>        &#125; <br><br>        <span class="hljs-comment">// ä»æµä¸­é‡æ–°æ„é€ å®ä¾‹(å³ååºåˆ—åŒ–)ã€‚</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>            <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>            s.defaultReadObject();<br>            readHolds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalHoldCounter</span>();<br>            setState(<span class="hljs-number">0</span>); <span class="hljs-comment">// reset to unlocked state</span><br>        &#125;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> getState(); &#125;<br>    &#125; <br><br>    <span class="hljs-comment">// åŒæ­¥å™¨çš„éå…¬å¹³ç‰ˆæœ¬</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">8159625535654395037L</span>;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">writerShouldBlock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// ç«äº‰å†™é”æ€»æ˜¯èƒ½æ’é˜Ÿ</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// writers can always barge</span><br>        &#125;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">readerShouldBlock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">/* As a heuristic to avoid indefinite writer starvation,</span><br><span class="hljs-comment">             * block if the thread that momentarily appears to be head</span><br><span class="hljs-comment">             * of queue, if one exists, is a waiting writer.  This is</span><br><span class="hljs-comment">             * only a probabilistic effect since a new reader will not</span><br><span class="hljs-comment">             * block if there is a waiting writer behind other enabled</span><br><span class="hljs-comment">             * readers that have not yet drained from the queue.</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-comment">// å¦‚æœCLHç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ExclusiveNodeï¼ˆå³ä¸€ä¸ªå†™å…¥è€…ï¼‰</span><br>            <span class="hljs-comment">// åˆ™é˜»å¡ï¼Œé¿å…å†™çº¿ç¨‹åŒ®ä¹ï¼ˆæ•ˆæœä¸å¤§ï¼‰</span><br>            <span class="hljs-keyword">return</span> apparentlyFirstQueuedIsExclusive();<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">// åŒæ­¥å™¨çš„å…¬å¹³ç‰ˆæœ¬</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2274990926593161451L</span>;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">writerShouldBlock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> hasQueuedPredecessors();<br>        &#125;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">readerShouldBlock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> hasQueuedPredecessors();<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReadLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span>, java.io.Serializable &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">5992448646407690164L</span>;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync; <br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-title function_">ReadLock</span><span class="hljs-params">(ReentrantReadWriteLock lock)</span> &#123;<br>            sync = lock.sync;<br>        &#125; <br><br>        <span class="hljs-comment">// è·å–è¯»é”</span><br>        <span class="hljs-comment">// å¦‚æœå†™é”æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåˆ™è·å–è¯»é”å¹¶ç«‹å³è¿”å›ã€‚</span><br>        <span class="hljs-comment">// å¦‚æœå†™é”è¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹å‡ºäºçº¿ç¨‹è°ƒåº¦çš„ç›®çš„è¢«ç¦ç”¨ï¼Œ</span><br>        <span class="hljs-comment">// å¹¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°è·å¾—è¯»é”ã€‚</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> &#123;<br>            sync.acquireShared(<span class="hljs-number">1</span>);<br>        &#125; <br><br>        <span class="hljs-comment">// åœ¨è¿™ä¸ªå®ç°ä¸­ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ˜¾å¼çš„ä¸­æ–­ç‚¹ï¼Œ</span><br>        <span class="hljs-comment">// æ‰€ä»¥ä¼˜å…ˆå“åº”ä¸­æ–­ï¼Œè€Œä¸æ˜¯æ­£å¸¸çš„æˆ–å¯é‡å…¥çš„é”è·å–ã€‚</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);<br>        &#125; <br><br>        <span class="hljs-comment">// ä»…å½“è°ƒç”¨æ—¶å¦ä¸€ä¸ªçº¿ç¨‹æ²¡æœ‰æŒæœ‰å†™é”æ—¶ï¼Œæ‰è·å–è¯»é”</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> sync.tryReadLock();<br>        &#125; <br><br>        <span class="hljs-comment">// å¸¦è¶…æ—¶çš„lock</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span><br>                <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            <span class="hljs-keyword">return</span> sync.tryAcquireSharedNanos(<span class="hljs-number">1</span>, unit.toNanos(timeout));<br>        &#125; <br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>            sync.releaseShared(<span class="hljs-number">1</span>);<br>        &#125; <br><br>        <span class="hljs-comment">// æŠ›å‡ºUnsupportedOperationExceptionï¼Œå› ä¸ºè¯»é”ä¸æ”¯æŒæ¡ä»¶ã€‚</span><br>        <span class="hljs-keyword">public</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>        &#125; <br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> sync.getReadLockCount();<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.toString() +<br>                <span class="hljs-string">&quot;[Read locks = &quot;</span> + r + <span class="hljs-string">&quot;]&quot;</span>;<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WriteLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span>, java.io.Serializable &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">4992448646407690164L</span>;<br>       <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;<br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-title function_">WriteLock</span><span class="hljs-params">(ReentrantReadWriteLock lock)</span> &#123;<br>            sync = lock.sync;<br>        &#125; <br><br>        <span class="hljs-comment">// è·å–å†™é”</span><br>        <span class="hljs-comment">// å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹æ—¢æ²¡æœ‰æŒæœ‰è¯»é”ä¹Ÿæ²¡æœ‰æŒæœ‰å†™é”ï¼Œåˆ™è·å–å†™é”ï¼Œå¹¶ç«‹å³è¿”å›ï¼Œ</span><br>        <span class="hljs-comment">// å°†å†™é”æŒæœ‰è®¡æ•°è®¾ç½®ä¸º1ã€‚</span><br>        <span class="hljs-comment">// å¦‚æœå½“å‰çº¿ç¨‹å·²ç»æŒæœ‰å†™é”ï¼Œåˆ™æŒæœ‰è®¡æ•°é€’å¢1ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•ç«‹å³è¿”å›ã€‚</span><br>        <span class="hljs-comment">// å¦‚æœè¯¥é”è¢«å¦ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹å‡ºäºçº¿ç¨‹è°ƒåº¦çš„ç›®çš„è€Œè¢«ç¦ç”¨ï¼Œ</span><br>        <span class="hljs-comment">// å¹¶å¤„äºä¼‘çœ çŠ¶æ€ï¼Œç›´åˆ°è·å¾—å†™é”ï¼Œæ­¤æ—¶å†™é”æŒæœ‰è®¡æ•°è¢«è®¾ç½®ä¸º1ã€‚</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> &#123;<br>            sync.acquire(<span class="hljs-number">1</span>);<br>        &#125; <br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            sync.acquireInterruptibly(<span class="hljs-number">1</span>);<br>        &#125; <br><br>        <span class="hljs-comment">// åªæœ‰è¯»é”å’Œå†™é”åœ¨è°ƒç”¨æ—¶æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰æ—¶ï¼Œæ‰è·å–å†™é”ã€‚</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> sync.tryWriteLock();<br>        &#125; <br><br>        <span class="hljs-comment">// å¸¦è¶…æ—¶çš„ lock </span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span><br>                <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            <span class="hljs-keyword">return</span> sync.tryAcquireNanos(<span class="hljs-number">1</span>, unit.toNanos(timeout));<br>        &#125; <br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>            sync.release(<span class="hljs-number">1</span>);<br>        &#125; <br><br>        <span class="hljs-keyword">public</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> sync.newCondition();<br>        &#125; <br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> sync.getOwner();<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.toString() + ((o == <span class="hljs-literal">null</span>) ?<br>                                       <span class="hljs-string">&quot;[Unlocked]&quot;</span> :<br>                                       <span class="hljs-string">&quot;[Locked by thread &quot;</span> + o.getName() + <span class="hljs-string">&quot;]&quot;</span>);<br>        &#125; <br><br>        <span class="hljs-comment">// åˆ¤æ–­å†™é”æ˜¯å¦ç”±å½“å‰çº¿ç¨‹æŒæœ‰</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldByCurrentThread</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> sync.isHeldExclusively();<br>        &#125; <br>    <br>        <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹çš„å†™é”æŒæœ‰é‡</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getHoldCount</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> sync.getWriteHoldCount();<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">// æ˜¯å¦å…¬å¹³</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFair</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync <span class="hljs-keyword">instanceof</span> FairSync;<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–å½“å‰æŒæœ‰å†™é”çš„çº¿ç¨‹ï¼ˆæ²¡æœ‰åˆ™è¿”å›nullï¼‰</span><br>    <span class="hljs-keyword">protected</span> Thread <span class="hljs-title function_">getOwner</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.getOwner();<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–è¯»é”æ•°é‡</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getReadLockCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.getReadLockCount();<br>    &#125; <br><br>    <span class="hljs-comment">// è¿”å›æ˜¯å¦æœ‰çº¿ç¨‹æŒæœ‰å†™é”</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWriteLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.isWriteLocked();<br>    &#125; <br><br>    <span class="hljs-comment">// å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰å†™é”</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isWriteLockedByCurrentThread</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.isHeldExclusively();<br>    &#125;<br><br>    <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹çš„å†™é”æŒæœ‰é‡</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getWriteHoldCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.getWriteHoldCount();<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹çš„è¯»é”æŒæœ‰é‡</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getReadHoldCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.getReadHoldCount();<br>    &#125;<br><br>    <span class="hljs-comment">// å…¶ä»–æ–¹æ³•æ˜¯ä¸€äº›æä¾›å¯è§‚æµ‹æ€§çš„æ–¹æ³•ï¼Œç•¥è¿‡</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>Â Â Â Â ReentrantReadWriteLock é€šè¿‡æä¾›è¯»é”å’Œå†™é”ï¼Œè§„å®šè¯»æ“ä½œå’Œå†™æ“ä½œåˆ†åˆ«æ˜¯å…±äº«å’Œç‹¬å çš„ï¼Œé™ä½äº†é”çš„ç²’åº¦ï¼Œå¢åŠ äº†å¹¶å‘åº¦</p>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JUC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CountDownLatchæºç è§£æ</title>
    <link href="/2023/06/03/java-source-code/CountDownLatch%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/03/java-source-code/CountDownLatch%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h4 id="CountDownLatchæºç è§£æ"><a href="#CountDownLatchæºç è§£æ" class="headerlink" title="CountDownLatchæºç è§£æ"></a>CountDownLatchæºç è§£æ</h4><p>Â Â Â Â è¿™ç¯‡åšå®¢æˆ‘ä»¬æ¥é˜…è¯»  CountDownLatch çš„æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CountDownLatch</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Synchronization control For CountDownLatch.</span><br><span class="hljs-comment">     * Uses AQS state to represent count.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> &#123; <br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">4982264981922014374L</span>;<br>        <br>        <span class="hljs-comment">// åˆå§‹åŒ–</span><br>        Sync(<span class="hljs-type">int</span> count) &#123;<br>            setState(count);<br>        &#125;<br><br>        <span class="hljs-comment">// count å’Œ stateçš„å€¼å¯¹åº”</span><br>        <span class="hljs-type">int</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> getState();<br>        &#125; <br><br>        <span class="hljs-comment">// åªæœ‰å½“stateä¸º0ï¼ˆå³countä¸º0æ—¶ï¼‰ï¼Œacquireæ‰æˆåŠŸ</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123;<br>            <span class="hljs-keyword">return</span> (getState() == <span class="hljs-number">0</span>) ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>;<br>        &#125; <br><br>        <span class="hljs-comment">// å°†count å‡å» releases</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> &#123;<br>            <span class="hljs-comment">// Decrement count; signal when transition to zero</span><br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();<br>                <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> c - <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">if</span> (compareAndSetState(c, nextc))<br>                    <span class="hljs-keyword">return</span> nextc == <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync; <br><br>    <span class="hljs-comment">// åˆå§‹åŒ–</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CountDownLatch</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> &#123;<br>        <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;count &lt; 0&quot;</span>);<br>        <span class="hljs-built_in">this</span>.sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>(count);<br>    &#125; <br><br>    <span class="hljs-comment">// é™¤éçº¿ç¨‹è¢«ä¸­æ–­ï¼Œå¦åˆ™ä½¿å½“å‰çº¿ç¨‹ä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°é—©é”å€’è®¡æ—¶åˆ°é›¶ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);<br>    &#125; <br><br>    <span class="hljs-comment">// å¸¦è¶…æ—¶æ—¶é—´çš„await</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">await</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span><br>        <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">return</span> sync.tryAcquireSharedNanos(<span class="hljs-number">1</span>, unit.toNanos(timeout));<br>    &#125;<br><br>    <span class="hljs-comment">// count å‡1</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">countDown</span><span class="hljs-params">()</span> &#123;<br>        sync.releaseShared(<span class="hljs-number">1</span>);<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–å½“å‰countå€¼</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.getCount();<br>    &#125; <br><br>    <span class="hljs-comment">// toString</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.toString() + <span class="hljs-string">&quot;[Count = &quot;</span> + sync.getCount() + <span class="hljs-string">&quot;]&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>Â Â Â Â CountDownLatch åœ¨åˆå§‹åŒ–å æ‰€æœ‰è°ƒç”¨å…¶awaitçš„çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°countä¸º0ï¼Œä¹‹åæ‰€æœ‰é˜»å¡çš„çº¿ç¨‹ä¼šæŒ‰é¡ºåºå…¨éƒ¨è¢«å”¤é†’ï¼ˆä¸€ç§åŒæ­¥è¾…åŠ©æ‰‹æ®µï¼Œå…è®¸ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹ä¸­æ­£åœ¨æ‰§è¡Œçš„ä¸€ç»„æ“ä½œå®Œæˆã€‚ï¼‰</p><p>Â Â Â Â æ›´å¤šä¿¡æ¯å’Œä¾‹å­å¯å‚ç…§ä»£ç å‰çš„æ³¨é‡Š</p>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JUC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Semaphoreæºç è§£æ</title>
    <link href="/2023/06/03/java-source-code/Semaphore%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/03/java-source-code/Semaphore%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h4 id="Semaphoreæºç è§£æ"><a href="#Semaphoreæºç è§£æ" class="headerlink" title="Semaphoreæºç è§£æ"></a>Semaphoreæºç è§£æ</h4><p>Â Â Â Â è¿™ç¯‡åšå®¢æˆ‘ä»¬æ¥é˜…è¯» Â Semaphoreçš„æºç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Semaphore</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable &#123; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">3222578661600680210L</span>;<br>   <br>    <span class="hljs-comment">/** All mechanics via AbstractQueuedSynchronizer subclass */</span><br>    <span class="hljs-comment">// é€šè¿‡AQSçš„å­ç±»å®ç°æ‰€æœ‰æœºåˆ¶</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Synchronization implementation for semaphore.  Uses AQS state</span><br><span class="hljs-comment">     * to represent permits. Subclassed into fair and nonfair</span><br><span class="hljs-comment">     * versions.</span><br><span class="hljs-comment">     * semaphore çš„åŒæ­¥å™¨å®ç°ï¼Œä½¿ç”¨AQS stateæ¥è¡¨ç¤º permitsï¼ˆè®¸å¯ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1192457210091910933L</span>;<br>   <br>        <span class="hljs-comment">// åˆå§‹åŒ–è®¸å¯æ•°é‡</span><br>        Sync(<span class="hljs-type">int</span> permits) &#123;<br>            setState(permits);<br>        &#125;  <br><br>        <span class="hljs-comment">// è®¸å¯æ•°é‡å’Œstateå€¼å¯¹åº”</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getPermits</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> getState();<br>        &#125; <br><br>        <span class="hljs-comment">// tryAcquireShared éå…¬å¹³å®ç°</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nonfairTryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;<br>                <span class="hljs-comment">// æ²¡æœ‰è®¸å¯ï¼ˆå‘å®Œäº†ï¼‰ æˆ– ä¸€ç›´é‡è¯•ç›´åˆ°è·å–è®¸å¯</span><br>                <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> ||<br>                    compareAndSetState(available, remaining))<br>                    <span class="hljs-keyword">return</span> remaining;<br>            &#125;<br>        &#125;  <br><br>        <span class="hljs-comment">// é‡Šæ”¾ï¼ˆå½’è¿˜ï¼‰è®¸å¯</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> &#123;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current + releases;<br>                <span class="hljs-keyword">if</span> (next &lt; current) <span class="hljs-comment">// overflow</span><br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Maximum permit count exceeded&quot;</span>);<br>                <span class="hljs-keyword">if</span> (compareAndSetState(current, next))<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125; <br><br>        <span class="hljs-comment">// å‡å°‘æ€»çš„è®¸å¯æ•°é‡</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reducePermits</span><span class="hljs-params">(<span class="hljs-type">int</span> reductions)</span> &#123;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> current - reductions;<br>                <span class="hljs-keyword">if</span> (next &gt; current) <span class="hljs-comment">// underflow</span><br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Permit count underflow&quot;</span>);<br>                <span class="hljs-keyword">if</span> (compareAndSetState(current, next))<br>                    <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125; <br><br>        <span class="hljs-comment">// å°†è®¸å¯æ•°é‡ç½®ä¸º0</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">drainPermits</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> getState();<br>                <span class="hljs-keyword">if</span> (current == <span class="hljs-number">0</span> || compareAndSetState(current, <span class="hljs-number">0</span>))<br>                    <span class="hljs-keyword">return</span> current;<br>            &#125;<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * NonFair version</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> &#123; <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">2694183684443567898L</span>;<br><br>        NonfairSync(<span class="hljs-type">int</span> permits) &#123;<br>            <span class="hljs-built_in">super</span>(permits);<br>        &#125;  <br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123;<br>            <span class="hljs-keyword">return</span> nonfairTryAcquireShared(acquires);<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Fair version</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> &#123;<br>    <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">2014338818796000944L</span>;<br>       <br>        FairSync(<span class="hljs-type">int</span> permits) &#123;<br>            <span class="hljs-built_in">super</span>(permits);<br>        &#125;<br><br>        <span class="hljs-comment">// å…¬å¹³ç‰ˆ tryAcquireShared ä¹Ÿæ˜¯å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ’é˜Ÿ</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-keyword">if</span> (hasQueuedPredecessors())<br>                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> getState();<br>                <span class="hljs-type">int</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> available - acquires;<br>                <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span> ||<br>                    compareAndSetState(available, remaining))<br>                    <span class="hljs-keyword">return</span> remaining;<br>            &#125;<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">// ç”¨ç»™å®šçš„è®¸å¯æ•°åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> permits)</span> &#123;<br>        <span class="hljs-comment">// é»˜è®¤éå…¬å¹³</span><br>        sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>(permits);<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Semaphore</span><span class="hljs-params">(<span class="hljs-type">int</span> permits, <span class="hljs-type">boolean</span> fair)</span> &#123;<br>        sync = fair ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">FairSync</span>(permits) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>(permits);<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–è®¸å¯ï¼ˆå¯æ‰“æ–­ï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        sync.acquireSharedInterruptibly(<span class="hljs-number">1</span>);<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–è®¸å¯ï¼ˆä¸å¯æ‰“æ–­ï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireUninterruptibly</span><span class="hljs-params">()</span> &#123;<br>        sync.acquireShared(<span class="hljs-number">1</span>);<br>    &#125; <br><br>    <span class="hljs-comment">// å°è¯•è·å–è®¸å¯ï¼ˆGï¼Œæœ‰æŒ‚ï¼Œæ€ä¹ˆç©ï¼‰ï¼Œç›´åˆ°æ‹¿åˆ°è®¸å¯æˆ–è€…æ²¡æœ‰è®¸å¯</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.nonfairTryAcquireShared(<span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// å°è¯•è·å–è®¸å¯ï¼Œå¸¦è¶…æ—¶æ—¶é—´</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span><br>        <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">return</span> sync.tryAcquireSharedNanos(<span class="hljs-number">1</span>, unit.toNanos(timeout));<br>    &#125; <br><br>    <span class="hljs-comment">// å½“å‰çº¿ç¨‹é‡Šæ”¾æŒæœ‰çš„è®¸å¯</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">()</span> &#123;<br>        sync.releaseShared(<span class="hljs-number">1</span>);<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯ï¼ˆå¯æ¶ï¼Œä¸€ä¸ªäººå å¤šä¸ªåé¢ï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> permits)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">if</span> (permits &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>        sync.acquireSharedInterruptibly(permits);<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯ï¼ˆä¸å¯æ‰“æ–­ï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireUninterruptibly</span><span class="hljs-params">(<span class="hljs-type">int</span> permits)</span> &#123;<br>        <span class="hljs-keyword">if</span> (permits &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>        sync.acquireShared(permits);<br>    &#125; <br><br>    <span class="hljs-comment">// å°è¯•è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯ï¼ˆGï¼Œæœ‰æŒ‚ï¼Œè¿˜ç‰¹ä¹ˆä¸€ä¸ªäººå å¤šä¸ªåé¢ï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> permits)</span> &#123;<br>        <span class="hljs-keyword">if</span> (permits &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>        <span class="hljs-keyword">return</span> sync.nonfairTryAcquireShared(permits) &gt;= <span class="hljs-number">0</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// å°è¯•è·å–æŒ‡å®šæ•°é‡çš„è®¸å¯ï¼Œå¸¦è¶…æ—¶æ—¶é—´</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> permits, <span class="hljs-type">long</span> timeout, TimeUnit unit)</span><br>        <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">if</span> (permits &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>        <span class="hljs-keyword">return</span> sync.tryAcquireSharedNanos(permits, unit.toNanos(timeout));<br>    &#125; <br><br>    <span class="hljs-comment">// é‡Šæ”¾æŒ‡å®šæ•°é‡çš„è®¸å¯</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">release</span><span class="hljs-params">(<span class="hljs-type">int</span> permits)</span> &#123;<br>        <span class="hljs-keyword">if</span> (permits &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>        sync.releaseShared(permits);<br>    &#125; <br><br>    <span class="hljs-comment">// è¿”å›æ˜¯å¦è¿˜è¦è®¸å¯å¯ä»¥å‘æ”¾</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">availablePermits</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.getPermits();<br>    &#125; <br><br>    <span class="hljs-comment">// å°†è®¸å¯ç½®ä¸º0</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">drainPermits</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.drainPermits();<br>    &#125; <br><br>    <span class="hljs-comment">// å‡å°‘æŒ‡å®šæ•°é‡çš„è®¸å¯</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reducePermits</span><span class="hljs-params">(<span class="hljs-type">int</span> reduction)</span> &#123;<br>        <span class="hljs-keyword">if</span> (reduction &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>        sync.reducePermits(reduction);<br>    &#125; <br><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦å…¬å¹³</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFair</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync <span class="hljs-keyword">instanceof</span> FairSync;<br>    &#125; <br><br>    <span class="hljs-comment">// è¿˜å‰©ä¸‹çš„æ–¹æ³•æ˜¯ä¸€äº›é‡å¤çš„æ–¹æ³•ï¼Œè¿™é‡Œç•¥è¿‡</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>Â Â Â Â Semaphore ç»´æŠ¤äº†æŒ‡å®šæ•°é‡çš„è®¸å¯ï¼Œå¯ä»¥å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰é”ï¼Œå…¶ä»–çº¿ç¨‹åˆ™ä¼šè¢«é˜»å¡ï¼›è¿˜å®ç°äº†å…¬å¹³å’Œéå…¬å¹³ä¸¤ä¸ªç‰ˆæœ¬ï¼ˆå®ç°åŸç†å’Œ <code>ReentrantLock </code>ä¸€æ ·ï¼‰</p>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JUC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ReentrantLockæºç è§£æ</title>
    <link href="/2023/06/03/java-source-code/ReentrantLock%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/06/03/java-source-code/ReentrantLock%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h4 id="ReentrantLockæºç è§£æ"><a href="#ReentrantLockæºç è§£æ" class="headerlink" title="ReentrantLockæºç è§£æ"></a>ReentrantLockæºç è§£æ</h4><p>Â Â Â Â å‰é¢æˆ‘ä»¬åˆ†æäº†AQSçš„æºç ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹é€ä¸ªåˆ†æAQSçš„æ´¾ç”Ÿç±»çš„æºç ï¼Œäº†è§£å…¶æœºåˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span>, java.io.Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">7373984872572414699L</span>;<br><br>    <span class="hljs-comment">/** Synchronizer providing all implementation mechanics */</span><br>    <span class="hljs-comment">// å°†æ‰€æœ‰æ–¹æ³•å§”æ‰˜ç»™åŒæ­¥å™¨å®ç°</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Base of synchronization control for this lock. Subclassed</span><br><span class="hljs-comment">     * into fair and nonfair versions below. Uses AQS state to</span><br><span class="hljs-comment">     * represent the number of holds on the lock.</span><br><span class="hljs-comment">     * æ­¤é”çš„åŒæ­¥æ§åˆ¶çš„åŸºç±»ã€‚å­ç±»åˆ†ä¸ºå…¬å¹³å’Œéå…¬å¹³ç‰ˆæœ¬ã€‚ä½¿ç”¨AQSçŠ¶æ€æ¥è¡¨ç¤ºæŒæœ‰é”çš„æ¬¡æ•°ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">5179523762034025860L</span>;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Performs non-fair tryLock.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();<br>            <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// çŠ¶æ€ä¸º0è¡¨ç¤ºé”æœªè¢«ä»»ä½•çº¿ç¨‹æŒæœ‰</span><br>                <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;<br>                    setExclusiveOwnerThread(current);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (getExclusiveOwnerThread() == current) &#123;<br>                <span class="hljs-comment">// é”é‡å…¥</span><br>                <span class="hljs-comment">// å¯é‡å…¥çš„æœ€å¤§æ¬¡æ•°ä¸º Integer.MAX_VALUE</span><br>                <span class="hljs-keyword">if</span> (++c &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">// overflow</span><br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Maximum lock count exceeded&quot;</span>);<br>                setState(c);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Checks for reentrancy and acquires if lock immediately</span><br><span class="hljs-comment">         * available under fair vs nonfair rules. Locking methods</span><br><span class="hljs-comment">         * perform initialTryLock check before relaying to</span><br><span class="hljs-comment">         * corresponding AQS acquire methods. </span><br><span class="hljs-comment">         * æ£€æŸ¥å¯é‡å…¥æ€§ã€‚å¹¶ä¸”æ ¹æ®å…¬å¹³ä¸éå…¬å¹³è§„åˆ™åˆ¤æ–­é”ç«‹å³å¯ç”¨çš„è¯ï¼Œacquire</span><br><span class="hljs-comment">         * é”æ–¹æ³•åœ¨ä¸­ç»§åˆ°ç›¸åº”çš„AQS acquireæ–¹æ³•ä¹‹å‰æ‰§è¡Œ initialTryLock æ£€æŸ¥</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">abstract</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">initialTryLock</span><span class="hljs-params">()</span>; <br><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span> (!initialTryLock())<br>                acquire(<span class="hljs-number">1</span>);<br>        &#125; <br><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            <span class="hljs-keyword">if</span> (Thread.interrupted())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>            <span class="hljs-keyword">if</span> (!initialTryLock())<br>                acquireInterruptibly(<span class="hljs-number">1</span>);<br>        &#125; <br><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLockNanos</span><span class="hljs-params">(<span class="hljs-type">long</span> nanos)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            <span class="hljs-keyword">if</span> (Thread.interrupted())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>            <span class="hljs-keyword">return</span> initialTryLock() || tryAcquireNanos(<span class="hljs-number">1</span>, nanos);<br>        &#125; <br><br>        <span class="hljs-meta">@ReservedStackAccess</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> &#123; <br>            <span class="hljs-comment">// å½“å‰çŠ¶æ€å‡å»releases</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState() - releases;<br>            <span class="hljs-keyword">if</span> (getExclusiveOwnerThread() != Thread.currentThread())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">free</span> <span class="hljs-operator">=</span> (c == <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span> (free)<br>                setExclusiveOwnerThread(<span class="hljs-literal">null</span>);<br>            setState(c);<br>            <span class="hljs-keyword">return</span> free;<br>        &#125; <br><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// While we must in general read state before owner,</span><br>            <span class="hljs-comment">// we don&#x27;t need to do so to check if current thread is owner</span><br>            <span class="hljs-keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();<br>        &#125; <br><br>        <span class="hljs-keyword">final</span> ConditionObject <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionObject</span>();<br>        &#125; <br><br>        <span class="hljs-comment">// è·å–é”çš„æŒæœ‰è€…</span><br>        <span class="hljs-keyword">final</span> Thread <span class="hljs-title function_">getOwner</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> getState() == <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : getExclusiveOwnerThread();<br>        &#125; <br><br>        <span class="hljs-comment">// è·å–é”çš„æŒæœ‰æ¬¡æ•°ï¼ˆå³çŠ¶æ€stateï¼‰</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getHoldCount</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> isHeldExclusively() ? getState() : <span class="hljs-number">0</span>;<br>        &#125; <br><br>        <span class="hljs-comment">// é”æ˜¯å¦å¯ç”¨</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLocked</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> getState() != <span class="hljs-number">0</span>;<br>        &#125; <br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Reconstitutes the instance from a stream (that is, deserializes it).</span><br><span class="hljs-comment">         * ä»æµä¸­é‡æ–°æ„é€ å®ä¾‹ï¼ˆååºåˆ—åŒ–ï¼‰</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>            <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>            s.defaultReadObject();<br>            setState(<span class="hljs-number">0</span>); <span class="hljs-comment">// reset to unlocked state</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Sync object for non-fair locks</span><br><span class="hljs-comment">     * éå…¬å¹³é”çš„åŒæ­¥å™¨å¯¹è±¡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> &#123; <br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">7316153563782823691L</span>;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">initialTryLock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123; <span class="hljs-comment">// first attempt is unguarded</span><br>                <span class="hljs-comment">// ç¬¬ä¸€æ¬¡å°è¯•æ²¡æœ‰ä»”ç»†è€ƒè™‘ï¼ˆæ²¡æœ‰å…ˆæ£€æŸ¥stateï¼Œéšç¼˜ï¼‰</span><br>                setExclusiveOwnerThread(current);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (getExclusiveOwnerThread() == current) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState() + <span class="hljs-number">1</span>;<br>                <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">// overflow</span><br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Maximum lock count exceeded&quot;</span>);<br>                setState(c);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Acquire for non-reentrant cases after initialTryLock prescreen </span><br><span class="hljs-comment">         * initialTryLock é¢„ç­›é€‰å acquireï¼ˆé’ˆå¯¹ä¸å¯é‡å…¥çš„æƒ…å†µï¼‰</span><br><span class="hljs-comment">         * ä¸“é—¨åŠ ä¸€ä¸ªæ–¹æ³• initialTryLock å°±æ˜¯ä¸ºäº†å°†å¤„ç†å¯é‡å…¥çš„ä»£ç æ‹å‡ºæ¥</span><br><span class="hljs-comment">         * emmm</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123;<br>            <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span> &amp;&amp; compareAndSetState(<span class="hljs-number">0</span>, acquires)) &#123;<br>                setExclusiveOwnerThread(Thread.currentThread());<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Sync object for fair locks</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> &#123;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">3000897897090466540L</span>;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Acquires only if reentrant or queue is empty.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">initialTryLock</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();<br>            <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// å…¬å¹³é”ä¸»è¦ä¾èµ– hasQueuedThreads()æ–¹æ³•</span><br>                <span class="hljs-comment">// å³å½“å‰æ˜¯å¦æœ‰çº¿ç¨‹åœ¨CLHé˜Ÿåˆ—ä¸­ç­‰å¾…æŒæœ‰é”</span><br>                <span class="hljs-comment">// æ²¡æœ‰ç­‰å¾…çº¿ç¨‹æ‰èƒ½å»ç«äº‰é”</span><br>                <span class="hljs-keyword">if</span> (!hasQueuedThreads() &amp;&amp; compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;<br>                    setExclusiveOwnerThread(current);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (getExclusiveOwnerThread() == current) &#123;<br>                <span class="hljs-comment">// å½“å‰çº¿ç¨‹å·²ç»æŒæœ‰é”äº†ï¼ˆå¯é‡å…¥ï¼‰ï¼Œç¬¬äºŒæ¬¡æ¥å°±å¯ä»¥æ’é˜Ÿäº†</span><br>                <span class="hljs-keyword">if</span> (++c &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">// overflow</span><br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Maximum lock count exceeded&quot;</span>);<br>                setState(c);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Acquires only if thread is first waiter or empty</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123; <br>            <span class="hljs-comment">// ä¸å¯é‡å…¥çš„æƒ…å†µä¸‹ï¼Œåªæœ‰å½“å‰çº¿ç¨‹æ˜¯CLHé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹æˆ–è€…</span><br>            <span class="hljs-comment">// é˜Ÿåˆ—ä¸ºç©ºï¼Œæ‰èƒ½å»ç«äº‰é”</span><br>            <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span> &amp;&amp; !hasQueuedPredecessors() &amp;&amp;<br>                compareAndSetState(<span class="hljs-number">0</span>, acquires)) &#123;<br>                setExclusiveOwnerThread(Thread.currentThread());<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Creates an instance of &#123;<span class="hljs-doctag">@code</span> ReentrantLock&#125;.</span><br><span class="hljs-comment">     * This is equivalent to using &#123;<span class="hljs-doctag">@code</span> ReentrantLock(false)&#125;.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReentrantLock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// é»˜è®¤æ˜¯éå…¬å¹³ç‰ˆæœ¬</span><br>        sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>();<br>    &#125; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Creates an instance of &#123;<span class="hljs-doctag">@code</span> ReentrantLock&#125; with the</span><br><span class="hljs-comment">     * given fairness policy.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fair &#123;<span class="hljs-doctag">@code</span> true&#125; if this lock should use a fair ordering policy</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReentrantLock</span><span class="hljs-params">(<span class="hljs-type">boolean</span> fair)</span> &#123;<br>        sync = fair ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">FairSync</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>();<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–é”ï¼ˆä¸å¯æ‰“æ–­ï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> &#123;<br>        sync.lock();<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–é”ï¼ˆå¯æ‰“æ–­ï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        sync.lockInterruptibly();<br>    &#125; <br><br>    <span class="hljs-comment">// å°è¯•è·å–é”ï¼ˆåªå°è¯•ä¸€æ¬¡ï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.tryLock();<br>    &#125; <br><br>    <span class="hljs-comment">// å°è¯•è·å–é”ï¼ˆå¸¦è¶…æ—¶æ—¶é—´ï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span><br>            <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">return</span> sync.tryLockNanos(unit.toNanos(timeout));<br>    &#125; <br><br>    <span class="hljs-comment">// è§£é”ï¼ˆå°†stateçŠ¶æ€é‡å‡1ï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>        sync.release(<span class="hljs-number">1</span>);<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.newCondition();<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–å½“å‰çº¿ç¨‹æŒæœ‰é”çš„æ¬¡æ•°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getHoldCount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.getHoldCount();<br>    &#125; <br><br>    <span class="hljs-comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰é”</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldByCurrentThread</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.isHeldExclusively();<br>    &#125; <br><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æœ‰çº¿ç¨‹å·²ç»æŒæœ‰é”</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.isLocked();<br>    &#125; <br><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æ˜¯å…¬å¹³é”</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFair</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync <span class="hljs-keyword">instanceof</span> FairSync;<br>    &#125; <br><br>    <span class="hljs-comment">// è·å–é”çš„æŒæœ‰è€…</span><br>    <span class="hljs-keyword">protected</span> Thread <span class="hljs-title function_">getOwner</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.getOwner();<br>    &#125; <br><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…æŒæœ‰é”ï¼ˆåªèƒ½ä½œä¸ºå‚è€ƒï¼ŒåŸå› å‚ç…§AQSä¸­ä»£ç æ³¨é‡Šï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasQueuedThreads</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.hasQueuedThreads();<br>    &#125; <br><br>    <span class="hljs-comment">// åˆ¤æ–­æŸä¸ªçº¿ç¨‹æ˜¯å¦æ­£åœ¨ç­‰å¾…æŒæœ‰è¿™ä¸ªé”ï¼ˆåªèƒ½ä½œä¸ºå‚è€ƒï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasQueuedThread</span><span class="hljs-params">(Thread thread)</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.isQueued(thread);<br>    &#125;<br><br>    <span class="hljs-comment">// è¿”å›ç­‰å¾…é”çš„çº¿ç¨‹æ•°é‡ï¼ˆåªèƒ½ä½œä¸ºå‚è€ƒï¼‰</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getQueueLength</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.getQueueLength();<br>    &#125; <br><br>    <span class="hljs-comment">// è¿”å›æ‰€æœ‰æ­£åœ¨ç­‰å¾…è·å–æ­¤é”çš„çº¿ç¨‹ï¼ˆåªèƒ½ä½œä¸ºå‚è€ƒï¼‰</span><br>    <span class="hljs-keyword">protected</span> Collection&lt;Thread&gt; <span class="hljs-title function_">getQueuedThreads</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.getQueuedThreads();<br>    &#125; <br><br>    <span class="hljs-comment">// åˆ¤æ–­æ˜¯å¦æœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾… condition</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasWaiters</span><span class="hljs-params">(Condition condition)</span> &#123;<br>        <span class="hljs-keyword">if</span> (condition == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        <span class="hljs-keyword">if</span> (!(condition <span class="hljs-keyword">instanceof</span> AbstractQueuedSynchronizer.ConditionObject))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;not owner&quot;</span>);<br>        <span class="hljs-keyword">return</span> sync.hasWaiters((AbstractQueuedSynchronizer.ConditionObject)condition);<br>    &#125; <br><br>    <span class="hljs-comment">// è¿”å›condition ç­‰å¾…é˜Ÿåˆ—çš„é•¿åº¦</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getWaitQueueLength</span><span class="hljs-params">(Condition condition)</span> &#123;<br>        <span class="hljs-keyword">if</span> (condition == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        <span class="hljs-keyword">if</span> (!(condition <span class="hljs-keyword">instanceof</span> AbstractQueuedSynchronizer.ConditionObject))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;not owner&quot;</span>);<br>        <span class="hljs-keyword">return</span> sync.getWaitQueueLength((AbstractQueuedSynchronizer.ConditionObject)condition);<br>    &#125; <br><br>    <span class="hljs-comment">// è¿”å›condition ä¸­æ­£åœ¨ç­‰å¾…çš„æ‰€æœ‰çº¿ç¨‹</span><br>    <span class="hljs-keyword">protected</span> Collection&lt;Thread&gt; <span class="hljs-title function_">getWaitingThreads</span><span class="hljs-params">(Condition condition)</span> &#123;<br>        <span class="hljs-keyword">if</span> (condition == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        <span class="hljs-keyword">if</span> (!(condition <span class="hljs-keyword">instanceof</span> AbstractQueuedSynchronizer.ConditionObject))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;not owner&quot;</span>);<br>        <span class="hljs-keyword">return</span> sync.getWaitingThreads((AbstractQueuedSynchronizer.ConditionObject)condition);<br>    &#125; <br><br>    <span class="hljs-comment">// é‡å†™toStringæ–¹æ³•ï¼Œæ‰“å°æ­¤é”æ˜¯å¦è¢«çº¿ç¨‹æŒæœ‰ï¼Œè‹¥æ­¤é”å·²ç»è¢«æŸçº¿ç¨‹æŒæœ‰</span><br>    <span class="hljs-comment">// æ‰“å°æŒæœ‰é”çš„çº¿ç¨‹åç§°</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> sync.getOwner();<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.toString() + ((o == <span class="hljs-literal">null</span>) ?<br>                                   <span class="hljs-string">&quot;[Unlocked]&quot;</span> :<br>                                   <span class="hljs-string">&quot;[Locked by thread &quot;</span> + o.getName() + <span class="hljs-string">&quot;]&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>Â Â Â Â ReentrantLock åœ¨ AQS çš„åŸºç¡€ä¸Šå®ç°äº†å¯é‡å…¥æœºåˆ¶ï¼Œå¹¶æä¾›äº†å…¬å¹³ä¸éå…¬å¹³ä¸¤ä¸ªç‰ˆæœ¬</p><p>Â Â Â Â å…¶ä¸­å¯é‡å…¥æ˜¯é€šè¿‡é‡å…¥çš„çº¿ç¨‹ï¼Œå¯¹stateåŠ 1å®ç°çš„ï¼Œç›¸åº”çš„ï¼Œçº¿ç¨‹é‡å…¥å¤šå°‘æ¬¡ï¼Œå°±è¦å¤šunlockå¤šå°‘æ¬¡</p><p>Â Â Â Â è€Œå…¬å¹³ä¸éå…¬å¹³é”çš„å®ç°å¹¶æ²¡æœ‰ä¿®æ”¹AQSçš„acquireé€»è¾‘ï¼Œè€Œæ˜¯åœ¨è·å–é”å‰åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å·²ç»åœ¨CLHç­‰å¾…é˜Ÿåˆ—ä¸­å¹¶ä¸”æ˜¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</p>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JUC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AQSæºç è§£æ.md</title>
    <link href="/2023/05/30/java-source-code/AQS%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2023/05/30/java-source-code/AQS%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h3 id="AQSæºç è§£æ"><a href="#AQSæºç è§£æ" class="headerlink" title="AQSæºç è§£æ"></a>AQSæºç è§£æ</h3><p>Â Â Â Â æœ¬æ–‡åŸºäºJDK19çš„æºç </p><p>Â Â Â Â ä¸‹é¢æ˜¯æºç é‡Œé¢æ³¨é‡Šçš„ç¿»è¯‘ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒï¼ˆä»£ç å¤´çš„æ³¨é‡Šå®åœ¨ç¿»è¯‘ä¸è¿‡æ¥äº†ï¼‰</p><blockquote><p>ç­‰å¾…é˜Ÿåˆ—æ˜¯â€œCLHâ€(Craigã€Landinå’ŒHagersten)é”é˜Ÿåˆ—çš„å˜ä½“ã€‚<br>CLHé”é€šå¸¸ç”¨äºæ—‹è½¬é”ã€‚ç›¸åï¼Œæˆ‘ä»¬é€šè¿‡åŒ…å«æ˜¾å¼(â€œprevâ€å’Œâ€œnextâ€)é“¾æ¥å’Œä¸€ä¸ªâ€œstatusâ€å­—æ®µæ¥ä½¿ç”¨å®ƒä»¬é˜»å¡åŒæ­¥å™¨ï¼Œè¯¥å­—æ®µå…è®¸èŠ‚ç‚¹åœ¨é‡Šæ”¾é”æ—¶é€šçŸ¥åç»§è€…ï¼Œå¹¶å¤„ç†ç”±äºä¸­æ–­å’Œè¶…æ—¶è€Œå¯¼è‡´çš„å–æ¶ˆã€‚<br>çŠ¶æ€å­—æ®µåŒ…æ‹¬è·Ÿè¸ªçº¿ç¨‹æ˜¯å¦éœ€è¦å”¤é†’(ä½¿ç”¨LockSupport.unpark)çš„ä½ã€‚<br>å°½ç®¡å¢åŠ äº†è¿™äº›ï¼Œæˆ‘ä»¬ä»ç„¶ä¿ç•™äº†å¤§éƒ¨åˆ†CLHè‡ªå·±çš„å±æ€§ã€‚</p><p>è¦æ’é˜Ÿè¿›å…¥CLHé”çš„è¯ï¼Œæ‚¨éœ€è¦ä½¿ç”¨åŸå­æ“ä½œå°†æ–°èŠ‚ç‚¹æ‹¼æ¥æˆæ–°çš„é˜Ÿå°¾ï¼ˆtailï¼‰ï¼Œ</p><p>è¦å‡ºé˜Ÿçš„è¯ï¼Œæ‚¨éœ€è¦è®¾ç½®é˜Ÿå¤´ï¼ˆheadï¼‰å­—æ®µï¼Œè¿™æ ·ä¸‹ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ç­‰å¾…ç€å°±ä¼šå˜æˆç¬¬ä¸€ä¸ª</p><p>+â€”â€”â€“+  prev +â€”â€”â€”+         +â€”â€”â€“+  </p><p>| head | &lt;â€”-  | first | &lt;â€”-   | tail |  </p><p>+â€”â€”â€“+       Â Â Â Â +â€”â€”â€”+         +â€”â€”â€“+</p><p>æ’å…¥åˆ°CLHé˜Ÿåˆ—åªéœ€è¦åœ¨â€œtailâ€ä¸Šæ‰§è¡Œä¸€ä¸ªåŸå­æ“ä½œï¼Œæ‰€ä»¥ä»éæ’é˜Ÿåˆ°æ’é˜Ÿæœ‰ä¸€ä¸ªç®€å•çš„åˆ†ç•Œç‚¹ã€‚å‰ç½®èŠ‚ç‚¹çš„â€œnexiâ€é“¾æ¥ç”±æˆåŠŸCASåçš„æ’é˜Ÿçº¿ç¨‹è®¾ç½®ã€‚å°½ç®¡æ˜¯éåŸå­çš„ï¼Œè¿™ä¹Ÿè¶³ä»¥ä¿è¯ä»»ä½•é˜»å¡çš„çº¿ç¨‹ä¼šåœ¨ç¬¦åˆæ¡ä»¶æ—¶ç”±å‰é©±èŠ‚ç‚¹å”¤é†’ã€‚å”¤é†’éƒ¨åˆ†åŸºäºç±»ä¼¼Dekkerçš„æ–¹æ¡ˆï¼Œåœ¨è¯¥æ–¹æ¡ˆä¸­è¦ç­‰å¾…çš„çº¿ç¨‹æŒ‡æ˜ç­‰å¾…çŠ¶æ€ï¼ˆWAITIING statusï¼‰ï¼Œç„¶åé‡è¯•è·å–ï¼Œç„¶ååœ¨é˜»å¡ä¹‹å‰é‡æ–°æ£€æŸ¥çŠ¶æ€ã€‚signalleråœ¨unparkæ—¶ä¼šè‡ªåŠ¨æ¸…é™¤WAITINGçŠ¶æ€</p><p>acquireæ—¶å‡ºé˜ŸåŒ…å«åˆ†ç¦»ï¼ˆæ¸…ç©ºï¼‰ä¸€ä¸ªèŠ‚ç‚¹çš„â€œprevâ€èŠ‚ç‚¹ç„¶åæ›´æ–°â€œheadâ€ã€‚å…¶ä»–çº¿ç¨‹é€šè¿‡æ£€æŸ¥â€œprevâ€è€Œä¸æ˜¯â€œheadâ€æ¥åˆ¤æ–­èŠ‚ç‚¹æ­£åœ¨æˆ–è€…å·²ç»å‡ºé˜Ÿã€‚å¦‚æœæœ‰å¿…è¦çš„è¯ï¼Œæˆ‘ä»¬é€šè¿‡æ—‹è½¬ç­‰å¾…æ¥å¼ºåˆ¶å–æ¶ˆç„¶åè®¾ç½®é¡ºåºã€‚å› æ­¤ï¼Œé”ç®—æ³•æœ¬èº«å¹¶ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„â€œæ— é”â€,å› ä¸ºè·å–çº¿ç¨‹å¯èƒ½éœ€è¦ç­‰å¾…å‰ä¸€æ¬¡è·å–æ‰èƒ½å–å¾—è¿›å±•ã€‚å½“ä½¿ç”¨æ’ä»–é”æ—¶ï¼Œæ— è®ºå¦‚ä½•éƒ½éœ€è¦è¿™æ ·çš„progessã€‚ç„¶è€Œï¼Œå…±äº«æ¨¡å¼å¯èƒ½ï¼ˆç½•è§åœ°ï¼‰éœ€è¦åœ¨è®¾ç½®headå­—æ®µä¹‹å‰è¿›è¡Œæ—‹è½¬ç­‰å¾…ï¼Œä»¥ç¡®ä¿æ­£ç¡®ä¼ æ’­ã€‚ï¼ˆä¸å†å²æœ‰å…³åœ°æ³¨é‡Šï¼šä¸è¯¥ç±»ä¹‹å‰çš„ç‰ˆæœ¬ç›¸æ¯”ï¼Œè¿™ç»™åˆ°äº†ç®€åŒ–å’Œæ•ˆç‡çš„æå‡ï¼‰</p><p>èŠ‚ç‚¹çš„å‰é©±èƒ½åœ¨ç­‰å¾…æ—¶å› ä¸ºå–æ¶ˆç­‰å¾…è€Œæ”¹å˜ï¼Œç›´åˆ°è¯¥èŠ‚ç‚¹ç§°ä¸ºé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ—¶èŠ‚ç‚¹å°±ä¸èƒ½æ”¹å˜äº†ã€‚acquire methodé€šè¿‡åœ¨ç­‰å¾…å‰é‡æ–°æ£€æŸ¥â€œprevâ€æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚prevå’Œnextå­—æ®µåªèƒ½ç”±æ–¹æ³• cleanQueue ä¸­å·²å–æ¶ˆçš„èŠ‚ç‚¹é€šè¿‡CASè¿›è¡Œä¿®æ”¹ã€‚unspliceç­–ç•¥è®©äººæƒ³èµ·Michael-Scotté˜Ÿåˆ—ï¼Œå…¶åœ¨æˆåŠŸå¯¹prevå­—æ®µæˆåŠŸè¿›è¡ŒCASæ“ä½œåï¼Œå…¶ä»–çº¿ç¨‹å¸®ç»„ä¿®å¤nextå­—æ®µã€‚å› ä¸ºå–æ¶ˆç»å¸¸æˆæ‰¹å‘ç”Ÿï¼Œè¿™ä½¿å¾—å…³äºå¿…è¦å”¤é†’çš„å†³ç­–æ›´åŠ å¤æ‚ï¼Œæ¯æ¬¡è°ƒç”¨cleanQueueæ–¹æ³•éƒ½ä¼šéå†é˜Ÿåˆ—ç›´åˆ°å½»åº•æ¸…é™¤é˜Ÿåˆ—ã€‚é¦–å…ˆè¢«é‡æ–°é“¾æ¥çš„èŠ‚ç‚¹ä¼šè¢«æ— æ¡ä»¶unparkï¼ˆæœ‰æ—¶ä¸æ˜¯å¿…è¦çš„ï¼Œä½†æ˜¯é‚£äº›æƒ…å†µä¸å€¼å¾—é¿å…ï¼‰</p><p>å¦‚æœçº¿ç¨‹æ˜¯é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ª(æœ€å‰é¢çš„),æœ‰æ—¶æ˜¯åœ¨å‰é¢ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½ä¼šå°è¯•acquireã€‚æˆä¸ºç¬¬ä¸€ä¸ªå¹¶ä¸ä¿è¯æˆåŠŸï¼Œå®ƒåªæ˜¯èµ‹äºˆäº†äº‰å–æˆåŠŸçš„æƒåŠ›ã€‚æˆ‘ä»¬é€šè¿‡å…è®¸ä¼ å…¥çº¿ç¨‹åœ¨å…¥é˜Ÿè¿‡ç¨‹ä¸­â€œé—¯å…¥â€å¹¶è·å–åŒæ­¥å™¨æ¥å¹³è¡¡ååé‡ã€å¼€é”€å’Œå…¬å¹³æ€§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè¢«å”¤é†’çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹å¯èƒ½éœ€è¦é‡æ–°ç­‰å¾…ã€‚ä¸ºäº†æŠµæ¶ˆå¯èƒ½é‡å¤çš„ä¸å¹¸çš„é‡æ–°ç­‰å¾…ï¼Œæˆ‘ä»¬æŒ‡æ•°çº§åœ°å¢åŠ é‡è¯•æ¬¡æ•°(é«˜è¾¾256æ¬¡),ä»¥åœ¨æ¯æ¬¡çº¿ç¨‹è¢«è§£é™¤é”å®šæ—¶è·å–ã€‚é™¤äº†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒAQSé”æ‰&#x3D;ä¸ä¼šæ—‹è½¬ï¼›ç›¸åï¼Œä»–ä»¬å°è¯•å»acquireä¸ç™»è®°æ­¥éª¤äº¤é”™è¿›è¡Œï¼ˆéœ€è¦è‡ªæ—‹é”çš„ç”¨æˆ·å¯ä»¥ä½¿ç”¨tryAcquireï¼‰</p><p>ä¸ºäº†æé«˜åƒåœ¾å¯å›æ”¶æ€§ï¼Œè¿˜ä¸åœ¨åˆ—è¡¨ä¸Šçš„èŠ‚ç‚¹çš„å­—æ®µä¸ºnullï¼ˆåˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸é€‚ç”¨å°±æ‰”æ‰å®ƒï¼Œè¿™ç§æƒ…å†µå¹¶ä¸ç½•è§ï¼‰ã€‚è„±ç¦»listçš„èŠ‚ç‚¹å­—æ®µä¼šå°½å¿«æ¸…ç©ºã€‚è¿™çªå‡ºäº†ä»å¤–éƒ¨ç¡®å®šç¬¬ä¸€ä¸ªç­‰å¾…çº¿ç¨‹çš„æŒ‘æˆ˜ï¼ˆå°±åƒåœ¨æ–¹æ³• getFirstQueuedThread ä¸­ä¸€æ ·ï¼‰ã€‚å½“å­—æ®µæ˜¾ç¤ºä¸ºnullæ—¶ï¼Œæœ‰æ—¶éœ€è¦ä»åŸå­æ›´æ–°çš„â€œtailâ€å‘åéå†çš„å›é€€ï¼ˆè¿™åœ¨å”¤é†’è¿‡ç¨‹ï¼ˆsignallingï¼‰ä¸­æ˜¯ä¸éœ€è¦çš„ï¼‰</p><p>CLHé˜Ÿåˆ—éœ€è¦ä¸€ä¸ªä¼ªå¤´èŠ‚ç‚¹æ¥å¼€å§‹ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸ä¼šåœ¨æ„å»ºçš„æ—¶å€™åˆ›å»ºå®ƒä»¬ï¼Œå› ä¸ºå¦‚æœæ²¡æœ‰contentionï¼Œè¿™å°†æ˜¯ç™½è´¹åŠ›æ°”ã€‚ç›¸åï¼Œåœ¨ç¬¬ä¸€æ¬¡contentionçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰æ„å»ºèŠ‚ç‚¹å¹¶è®¾ç½®å¤´æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆã€‚</p><p>å…±äº«æ¨¡å¼æ“ä½œä¸åŒäºç‹¬å æ¨¡å¼æ“ä½œï¼Œå› ä¸ºå¦‚æœå®ƒä¹Ÿæ˜¯å…±äº«çš„ï¼Œåˆ™è·å–æ“ä½œä¼šå‘ä¸‹ä¸€ä¸ªç­‰å¾…è€…å‘å‡ºå°è¯•è·å–çš„ä¿¡å·ã€‚tryAcquireShared APIå…è®¸ç”¨æˆ·æŒ‡å‡ºä¼ æ’­çš„ç¨‹åº¦ï¼Œä½†åœ¨å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­ï¼Œå¿½ç•¥è¿™ä¸€ç‚¹æ›´æœ‰æ•ˆï¼Œå…è®¸åç»§è€…åœ¨ä»»ä½•æƒ…å†µä¸‹å°è¯•è·å–ã€‚</p><p>åœ¨Conditionsä¸­ç­‰å¾…çš„çº¿ç¨‹ä½¿ç”¨å¸¦æœ‰é™„åŠ é“¾æ¥çš„èŠ‚ç‚¹æ¥ç»´æŠ¤conditionçš„(FIFO)åˆ—è¡¨ã€‚Conditionsåªéœ€è¦é“¾æ¥ç®€å•(éå¹¶å‘)é“¾å¼é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ï¼Œå› ä¸ºå®ƒä»¬åªåœ¨ç‹¬å æ—¶è¢«è®¿é—®ã€‚åœ¨awaitæ—¶ï¼Œä¸€ä¸ªèŠ‚ç‚¹è¢«æ’å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—ä¸­ã€‚ä¸€æ—¦æ”¶åˆ°ä¿¡å·ï¼Œè¯¥èŠ‚ç‚¹å°±åœ¨ä¸»é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚ä¸€ä¸ªç‰¹æ®Šçš„çŠ¶æ€å­—æ®µå€¼è¢«ç”¨æ¥è·Ÿè¸ªå’Œè‡ªåŠ¨è§¦å‘è¿™ç§æƒ…å†µã€‚</p><p>å¯¹å­—æ®µheadã€tailå’Œstateçš„è®¿é—®ä½¿ç”¨å®Œå…¨volatileæ¨¡å¼ä»¥åŠCASã€‚èŠ‚ç‚¹å­—æ®µstatusã€prevå’Œnextä¹Ÿè¿™æ ·åšï¼Œè€Œçº¿ç¨‹å¯èƒ½æ˜¯å¯å‘ä¿¡å·çš„ï¼Œä½†é™¤æ­¤ä¹‹å¤–æœ‰æ—¶ä½¿ç”¨è¾ƒå¼±çš„æ¨¡å¼ã€‚å¯¹å­—æ®µâ€œwaiterâ€(è¦è¢«å”¤é†’çš„çº¿ç¨‹)çš„è®¿é—®æ€»æ˜¯å¤¹åœ¨å…¶ä»–åŸå­è®¿é—®ä¹‹é—´ï¼Œå› æ­¤åœ¨æ™®é€šæ¨¡å¼ä¸‹ä½¿ç”¨ã€‚æˆ‘ä»¬ä½¿ç”¨jdk.internalä¸å®‰å…¨ç‰ˆæœ¬çš„åŸå­è®¿é—®æ–¹æ³•è€Œä¸æ˜¯VarHandlesæ¥é¿å…æ½œåœ¨çš„è™šæ‹Ÿæœºå¼•å¯¼é—®é¢˜ã€‚</p><p>ä»¥ä¸Šå¤§éƒ¨åˆ†æ˜¯ç”±ä¸»è¦çš„å†…éƒ¨æ–¹æ³•acquireæ‰§è¡Œçš„ï¼Œæ‰€æœ‰æš´éœ²çš„acquireæ–¹æ³•éƒ½ä¼šä»¥æŸç§æ–¹å¼è°ƒç”¨å®ƒï¼ˆå½“å¤§é‡ä½¿ç”¨æ—¶ï¼Œç¼–è¯‘å™¨é€šå¸¸å¾ˆå®¹æ˜“ä¸“é—¨ä¸ºè°ƒç”¨ç‚¹ä¼˜åŒ–ã€‚ï¼‰åœ¨é˜»å¡å‰å’Œ&#x2F;æˆ–é˜»å¡åçš„è·å–å’Œç­‰å¾…ä¸­ï¼Œæœ‰å‡ ä¸ªå…³äºä½•æ—¶ä»¥åŠå¦‚ä½•æ£€æŸ¥ä¸­æ–­çš„éšæ„çš„å†³å®šã€‚åœ¨å®ç°çš„æ›´æ–°ä¸­ï¼Œå†³ç­–æ›´åŠ ä¸éšæ„å› ä¸ºä¸€äº›ç”¨æˆ·ä¼¼ä¹ä»¥ä¸€ç§racyçš„æ–¹å¼ä¾èµ–äºåŸå§‹è¡Œä¸ºï¼Œä¸€èˆ¬æ¥è¯´ï¼Œè¿™å¾ˆå°‘æ˜¯é”™è¯¯çš„ï¼Œä½†æ˜¯å¾ˆéš¾è¯æ˜æ”¹å˜æ˜¯åˆç†çš„ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span><br>    <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractOwnableSynchronizer</span><br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">7373984972572414691L</span>;<br><br>    <span class="hljs-comment">// Creates a new AbstractQueuedSynchronizer instance with initial synchronization state of zero.</span><br>    <span class="hljs-comment">// åˆ›å»ºä¸€ä¸ªåˆå§‹åŒæ­¥çŠ¶æ€ä¸º0çš„ AbstractQueuedSynchronizer å®ä¾‹</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">AbstractQueuedSynchronizer</span><span class="hljs-params">()</span> &#123; &#125;<br><br>    <span class="hljs-comment">// Node status bits, also used as argument and return values</span><br>    <span class="hljs-comment">// èŠ‚ç‚¹çŠ¶æ€ä½ï¼Œä¹Ÿç”¨æ¥ä½œä¸ºargumentå’Œè¿”å›å€¼</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">WAITING</span>   <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;          <span class="hljs-comment">// must be 1</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CANCELLED</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x80000000</span>; <span class="hljs-comment">// must be negative</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COND</span>      <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;          <span class="hljs-comment">// in a condition wait</span><br><br>    <span class="hljs-comment">// Unsafe</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Unsafe</span> <span class="hljs-variable">U</span> <span class="hljs-operator">=</span> Unsafe.getUnsafe();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">STATE</span><br>        <span class="hljs-operator">=</span> U.objectFieldOffset(AbstractQueuedSynchronizer.class, <span class="hljs-string">&quot;state&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">HEAD</span><br>        <span class="hljs-operator">=</span> U.objectFieldOffset(AbstractQueuedSynchronizer.class, <span class="hljs-string">&quot;head&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TAIL</span><br>        <span class="hljs-operator">=</span> U.objectFieldOffset(AbstractQueuedSynchronizer.class, <span class="hljs-string">&quot;tail&quot;</span>);<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        Class&lt;?&gt; ensureLoaded = LockSupport.class;<br>    &#125; <br><br>    <span class="hljs-comment">// CLH èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> &#123;<br>        <span class="hljs-comment">// initially attached via casTail</span><br>        <span class="hljs-keyword">volatile</span> Node prev;  <br>        <span class="hljs-comment">// visiblyï¼ˆæ˜æ˜¾åœ°ï¼‰ nonnull when signallable</span><br>        <span class="hljs-keyword">volatile</span> Node next;  <br>        <span class="hljs-comment">// visibly nonnull when enqueued     </span><br>        Thread waiter;   <br>        <span class="hljs-comment">// written by owner, atomic bit ops by others         </span><br>        <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> status;   <br><br>        <span class="hljs-comment">// è·å–ç±»ä¸­å±æ€§çš„åç§»é‡ï¼Œç”¨äºåç»­casæ“ä½œ</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">STATUS</span><br>            <span class="hljs-operator">=</span> U.objectFieldOffset(Node.class, <span class="hljs-string">&quot;status&quot;</span>);<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">NEXT</span><br>            <span class="hljs-operator">=</span> U.objectFieldOffset(Node.class, <span class="hljs-string">&quot;next&quot;</span>);<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">PREV</span><br>            <span class="hljs-operator">=</span> U.objectFieldOffset(Node.class, <span class="hljs-string">&quot;prev&quot;</span>);   <br><br>        <span class="hljs-comment">// methods for atomic operations</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">casPrev</span><span class="hljs-params">(Node c, Node v)</span> &#123;  <span class="hljs-comment">// for cleanQueue</span><br>            <span class="hljs-keyword">return</span> U.weakCompareAndSetReference(<span class="hljs-built_in">this</span>, PREV, c, v);<br>        &#125;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">casNext</span><span class="hljs-params">(Node c, Node v)</span> &#123;  <span class="hljs-comment">// for cleanQueue</span><br>            <span class="hljs-keyword">return</span> U.weakCompareAndSetReference(<span class="hljs-built_in">this</span>, NEXT, c, v);<br>        &#125;<br>        <span class="hljs-comment">// å°†çŠ¶æ€ç½®ä¸º0ï¼Œå¹¶è¿”å›æ“ä½œä¹‹å‰çš„å€¼</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAndUnsetStatus</span><span class="hljs-params">(<span class="hljs-type">int</span> v)</span> &#123;     <span class="hljs-comment">// for signalling</span><br>            <span class="hljs-comment">// ç”¨å½“å‰å€¼å’Œæ©ç ä¹‹é—´æŒ‰ä½ANDçš„ç»“æœè‡ªåŠ¨æ›¿æ¢</span><br>            <span class="hljs-comment">// ç»™å®šå¯¹è±¡ä¸­å­—æ®µæˆ–æ•°ç»„å…ƒç´ çš„å½“å‰å€¼ï¼Œè¿”å›ä¹‹å‰çš„å€¼</span><br>            <span class="hljs-keyword">return</span> U.getAndBitwiseAndInt(<span class="hljs-built_in">this</span>, STATUS, ~v);<br>        &#125;<br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrevRelaxed</span><span class="hljs-params">(Node p)</span> &#123;      <span class="hljs-comment">// for off-queue assignment</span><br>            <span class="hljs-comment">// å°†å¼•ç”¨å€¼å­˜å‚¨åˆ°å¯¹åº”çš„javaå˜é‡ä¸­</span><br>            U.putReference(<span class="hljs-built_in">this</span>, PREV, p);<br>        &#125;<br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatusRelaxed</span><span class="hljs-params">(<span class="hljs-type">int</span> s)</span> &#123;     <span class="hljs-comment">// for off-queue assignment</span><br>            U.putInt(<span class="hljs-built_in">this</span>, STATUS, s);<br>        &#125;<br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearStatus</span><span class="hljs-params">()</span> &#123;               <span class="hljs-comment">// for reducing unneeded signals</span><br>            <span class="hljs-comment">// putIntVolatile(Object, long, int)çš„ä¸é€æ˜ç‰ˆæœ¬</span><br>            U.putIntOpaque(<span class="hljs-built_in">this</span>, STATUS, <span class="hljs-number">0</span>);<br>        &#125;<br><br>    &#125; <br><br>    <span class="hljs-comment">// Concrete classes tagged by type</span><br>    <span class="hljs-comment">// æŒ‰ç±»å‹æ ‡è®°çš„å…·ä½“ç±»</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExclusiveNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span> &#123; &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span> &#123; &#125; <br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span><br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ForkJoinPool</span>.ManagedBlocker &#123; <br>        <span class="hljs-comment">// link to next waiting node</span><br>        ConditionNode nextWaiter;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Allows Conditions to be used in ForkJoinPools without</span><br><span class="hljs-comment">         * risking fixed pool exhaustion. This is usable only for</span><br><span class="hljs-comment">         * untimed Condition waits, not timed versions.</span><br><span class="hljs-comment">         * å…è®¸åœ¨ForkJoinPoolsä¸­ä½¿ç”¨æ¡ä»¶ï¼Œè€Œä¸ä¼šæœ‰å›ºå®šæ± è€—å°½çš„é£é™©ã€‚</span><br><span class="hljs-comment">         * è¿™ä»…é€‚ç”¨äºæ— è®¡æ—¶æ¡ä»¶ç­‰å¾…ï¼Œä¸é€‚ç”¨äºè®¡æ—¶ç‰ˆæœ¬ã€‚</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isReleasable</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> status &lt;= <span class="hljs-number">1</span> || Thread.currentThread().isInterrupted();<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">block</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">while</span> (!isReleasable()) LockSupport.park();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Head of the wait queue, lazily initialized. æ‡’æƒ°åˆå§‹åŒ–</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node head;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Tail of the wait queue. After initialization, modified only via casTail. </span><br><span class="hljs-comment">     * åˆå§‹åŒ–è¿‡åï¼Œä»…é€šè¿‡casTailä¿®æ”¹</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Node tail;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * The synchronization state. åŒæ­¥çŠ¶æ€</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> state; <br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getState</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> state;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setState</span><span class="hljs-params">(<span class="hljs-type">int</span> newState)</span> &#123;<br>        state = newState;<br>    &#125;<br><br>    <span class="hljs-comment">// è®¾ç½®çŠ¶æ€casæ“ä½œ</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">compareAndSetState</span><span class="hljs-params">(<span class="hljs-type">int</span> expect, <span class="hljs-type">int</span> update)</span> &#123;<br>        <span class="hljs-keyword">return</span> U.compareAndSetInt(<span class="hljs-built_in">this</span>, STATE, expect, update);<br>    &#125;  <br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">casTail</span><span class="hljs-params">(Node c, Node v)</span> &#123;<br>        <span class="hljs-keyword">return</span> U.compareAndSetReference(<span class="hljs-built_in">this</span>, TAIL, c, v);<br>    &#125;<br><br>    <span class="hljs-comment">/** tries once to CAS a new dummy node for head </span><br><span class="hljs-comment">     *  å°†headè®¾ç½®ä¸ºä¸€ä¸ªæ–°çš„dummyèŠ‚ç‚¹ï¼Œä½¿ç”¨casæ“ä½œï¼Œåªå°è¯•ä¸€æ¬¡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tryInitializeHead</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExclusiveNode</span>();<br>        <span class="hljs-keyword">if</span> (U.compareAndSetReference(<span class="hljs-built_in">this</span>, HEAD, <span class="hljs-literal">null</span>, h))<br>            tail = h;<br>    &#125; <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Enqueues the node unless null. (Currently used only for</span><br><span class="hljs-comment">     * ConditionNodes; other cases are interleaved with acquires.) </span><br><span class="hljs-comment">     * å½“å‰ä»…ç”¨äºConditionNodesï¼›å…¶ä»–æƒ…å†µä¸acquireäº¤é”™è¿›è¡Œã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">enqueue</span><span class="hljs-params">(Node node)</span> &#123;<br>        <span class="hljs-keyword">if</span> (node != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (;;) &#123;<br>                <span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail;<br>                <span class="hljs-comment">// avoid unnecessary fenceï¼ˆé¿å…ä¸å¿…è¦çš„å›´æ ï¼Ÿï¼‰</span><br>                <span class="hljs-comment">// è¿™é‡Œæ²¡æœ‰ä½¿ç”¨volatileå˜é‡å¯¹åº”çš„æ–¹æ³•</span><br>                node.setPrevRelaxed(t);        <br>                <span class="hljs-keyword">if</span> (t == <span class="hljs-literal">null</span>)                 <span class="hljs-comment">// initialize</span><br>                    tryInitializeHead();<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (casTail(t, node)) &#123;<br>                    t.next = node;<br>                    <span class="hljs-keyword">if</span> (t.status &lt; <span class="hljs-number">0</span>)          <span class="hljs-comment">// wake up to clean link</span><br>                        LockSupport.unpark(node.waiter);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">/** Returns true if node is found in traversal from tail </span><br><span class="hljs-comment">     *  èŠ‚ç‚¹å·²åœ¨é˜Ÿåˆ—ä¸­ï¼ˆä»åå‘å‰æ‰¾ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnqueued</span><span class="hljs-params">(Node node)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail; t != <span class="hljs-literal">null</span>; t = t.prev)<br>            <span class="hljs-keyword">if</span> (t == node)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// å”¤é†’ç»™å®šèŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹(å¦‚æœå­˜åœ¨),å¹¶å–æ¶ˆå…¶ç­‰å¾…çŠ¶æ€ä»¥é¿å…parkç«äº‰ã€‚</span><br>    <span class="hljs-comment">// å½“ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è¢«å–æ¶ˆæ—¶ï¼Œè¿™å¯èƒ½æ— æ³•å”¤é†’ç¬¦åˆæ¡ä»¶çš„çº¿ç¨‹ï¼Œ</span><br>    <span class="hljs-comment">// ä½†cancelAcquireç¡®ä¿äº†ï¼ˆçº¿ç¨‹ï¼Ÿï¼‰å­˜æ´»ã€‚</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">signalNext</span><span class="hljs-params">(Node h)</span> &#123;<br>        Node s;<br>        <span class="hljs-keyword">if</span> (h != <span class="hljs-literal">null</span> &amp;&amp; (s = h.next) != <span class="hljs-literal">null</span> &amp;&amp; s.status != <span class="hljs-number">0</span>) &#123;<br>            s.getAndUnsetStatus(WAITING);<br>            LockSupport.unpark(s.waiter);<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">/** Wakes up the given node if in shared mode ï¼ˆå…±äº«æ¨¡å¼ï¼‰*/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">signalNextIfShared</span><span class="hljs-params">(Node h)</span> &#123;<br>        Node s;<br>        <span class="hljs-keyword">if</span> (h != <span class="hljs-literal">null</span> &amp;&amp; (s = h.next) != <span class="hljs-literal">null</span> &amp;&amp;<br>            (s <span class="hljs-keyword">instanceof</span> SharedNode) &amp;&amp; s.status != <span class="hljs-number">0</span>) &#123;<br>            s.getAndUnsetStatus(WAITING);<br>            LockSupport.unpark(s.waiter);<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">// Main acquire method, invoked by all exported acquire methods.</span><br>    <span class="hljs-comment">// ä¸»è¦çš„acquireæ–¹æ³•ï¼Œè¢«æ‰€æœ‰æš´éœ²çš„acquireæ–¹æ³•è°ƒç”¨</span><br>    <span class="hljs-comment">// è¿”å›å€¼ï¼špositive if acquired, 0 if timed out, negative if interrupted</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(Node node, <span class="hljs-type">int</span> arg, <span class="hljs-type">boolean</span> shared,</span><br><span class="hljs-params">                      <span class="hljs-type">boolean</span> interruptible, <span class="hljs-type">boolean</span> timed, <span class="hljs-type">long</span> time)</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>        <span class="hljs-comment">// unpark ç¬¬ä¸€ä¸ªçº¿ç¨‹åç¬¬ä¸€ä¸ªçº¿ç¨‹çš„é‡è¯•æ¬¡æ•°</span><br>        <span class="hljs-type">byte</span> <span class="hljs-variable">spins</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, postSpins = <span class="hljs-number">0</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>, first = <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">// nodeå…¥é˜Ÿæ—¶çš„å‰é©±èŠ‚ç‚¹</span><br>        <span class="hljs-type">Node</span> <span class="hljs-variable">pred</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-comment">// æ£€æŸ¥èŠ‚ç‚¹nodeç°åœ¨æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œç¡®ä¿headç¨³å®šï¼Œå¦åˆ™ä¿è¯æœ‰æ•ˆçš„å‰é©±</span><br>        <span class="hljs-comment">// å¦‚æœèŠ‚ç‚¹æ˜¯ç¬¬ä¸€ä¸ªæˆ–å°šæœªå…¥é˜Ÿï¼Œå°è¯•acquire</span><br>        <span class="hljs-comment">// å¦åˆ™å¦‚æœèŠ‚ç‚¹è¿˜æ²¡æœ‰åˆ›å»ºï¼Œåˆ›å»ºå®ƒ</span><br>        <span class="hljs-comment">// å¦åˆ™å¦‚æœèŠ‚ç‚¹è¿˜æ²¡æœ‰å…¥é˜Ÿï¼Œå°è¯•å…¥é˜Ÿä¸€æ¬¡</span><br>        <span class="hljs-comment">// å¦åˆ™å¦‚æœèŠ‚ç‚¹è¢«parkå”¤é†’ï¼Œé‡è¯•ï¼ˆä¸€ç›´åˆ° postSpins æ¬¡ï¼‰</span><br>        <span class="hljs-comment">// å¦åˆ™å¦‚æœWAITINGçŠ¶æ€è¿˜æ²¡æœ‰è¢«è®¾ç½®ï¼Œè®¾ç½®å¹¶é‡è¯•</span><br>        <span class="hljs-comment">// å¦åˆ™ï¼Œparkå¹¶ä¸”æ¸…é™¤WAITINGçŠ¶æ€ï¼Œå¹¶ä¸”æ£€æŸ¥å–æ¶ˆ</span><br>        <span class="hljs-comment">// ç¿»è¯‘çš„æ³¨é‡Šï¼Œå¯ä»¥å‚è€ƒ</span><br>        <span class="hljs-keyword">for</span> (;;) &#123;<br>            <span class="hljs-comment">// firstè¡¨ç¤ºnodeçš„å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºheadï¼Œå³nodeæ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span><br>            <span class="hljs-keyword">if</span> (!first &amp;&amp; (pred = (node == <span class="hljs-literal">null</span>) ? <span class="hljs-literal">null</span> : node.prev) != <span class="hljs-literal">null</span> &amp;&amp;<br>                !(first = (head == pred))) &#123;<br>                <span class="hljs-keyword">if</span> (pred.status &lt; <span class="hljs-number">0</span>) &#123;<br>                    cleanQueue();           <span class="hljs-comment">// predecessor cancelled</span><br>                    <span class="hljs-keyword">continue</span>;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pred.prev == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">// é˜Ÿåˆ—æ–­äº†ï¼ˆpredä¸æ˜¯headï¼Œä½†æ˜¯å…¶å‰é©±ä¸ºnullï¼‰ï¼Œç¡®ä¿é˜Ÿåˆ—è¿ç»­</span><br>                    <span class="hljs-comment">// ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Ÿ</span><br>                    Thread.onSpinWait();    <span class="hljs-comment">// ensure serialization</span><br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>            &#125; <br>            <span class="hljs-comment">// nodeæ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…nodeè¿˜æ²¡æœ‰å…¥é˜Ÿï¼ˆéå…¬å¹³ç«äº‰ï¼‰</span><br>            <span class="hljs-comment">// æœ‰ç«äº‰çš„èµ„æ ¼</span><br>            <span class="hljs-keyword">if</span> (first || pred == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">boolean</span> acquired;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (shared)<br>                        acquired = (tryAcquireShared(arg) &gt;= <span class="hljs-number">0</span>);<br>                    <span class="hljs-keyword">else</span><br>                        acquired = tryAcquire(arg);<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable ex) &#123; <br>                    <span class="hljs-comment">// å‡ºç°å¼‚å¸¸ã€å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„acquireå°è¯•</span><br>                    cancelAcquire(node, interrupted, <span class="hljs-literal">false</span>);<br>                    <span class="hljs-keyword">throw</span> ex;<br>                &#125;   <br>                <span class="hljs-keyword">if</span> (acquired) &#123;<br>                    <span class="hljs-keyword">if</span> (first) &#123;<br>                        <span class="hljs-comment">// ç«äº‰æˆåŠŸåå°†nodeï¼ˆç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰è®¾ä¸ºhead</span><br>                        node.prev = <span class="hljs-literal">null</span>;<br>                        head = node;<br>                        <span class="hljs-comment">// å°†ä¹‹å‰çš„headå±æ€§ç½®ç©ºï¼Œæ–¹ä¾¿GC</span><br>                        pred.next = <span class="hljs-literal">null</span>;<br>                        node.waiter = <span class="hljs-literal">null</span>;<br>                        <span class="hljs-keyword">if</span> (shared) &#123;<br>                            <span class="hljs-comment">// å¦‚æœä¸‹ä¸ªèŠ‚ç‚¹ï¼ˆç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰æ˜¯SharedNodeï¼Œå°†å…¶å”¤é†’</span><br>                            <span class="hljs-comment">// é…åˆèƒ½é‡å¤æˆåŠŸçš„ tryAcquireShared èƒ½å®ç°ä¸€æ¬¡</span><br>                            <span class="hljs-comment">// å‡ºé˜Ÿå¤šä¸ªèŠ‚ç‚¹çš„æ•ˆæœ</span><br>                            signalNextIfShared(node);<br>                        &#125;  <br>                        <span class="hljs-keyword">if</span> (interrupted)<br>                            current.interrupt(); <span class="hljs-comment">// æ¸…ç©ºçº¿ç¨‹çš„æ‰“æ–­çŠ¶æ€</span><br>                    &#125;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>                &#125;             <br>            &#125; <br>            <span class="hljs-comment">// allocate; retry before enqueue</span><br>            <span class="hljs-comment">// æ–°å»ºnodeï¼Œåœ¨å…¥é˜Ÿæ—¶å†æ¬¡å°è¯•ï¼Œè¿™é‡Œå¯¹åº”ä¸Šæ®µä»£ç pred == nullæ¡ä»¶</span><br>            <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;                 <br>                <span class="hljs-keyword">if</span> (shared)<br>                    node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedNode</span>();<br>                <span class="hljs-keyword">else</span><br>                    node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExclusiveNode</span>();<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pred == <span class="hljs-literal">null</span>) &#123;  <br>                <span class="hljs-comment">// try to enqueue</span><br>                <span class="hljs-comment">// æ–°å»ºçš„nodeç«äº‰å¤±è´¥ï¼Œå…¥é˜Ÿ</span><br>                node.waiter = current;<br>                <span class="hljs-type">Node</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> tail;<br>                node.setPrevRelaxed(t);         <span class="hljs-comment">// avoid unnecessary fence</span><br>                <span class="hljs-keyword">if</span> (t == <span class="hljs-literal">null</span>)<br>                    tryInitializeHead();<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!casTail(t, node))<br>                    node.setPrevRelaxed(<span class="hljs-literal">null</span>);  <span class="hljs-comment">// back out</span><br>                <span class="hljs-keyword">else</span><br>                    t.next = node;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (first &amp;&amp; spins != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// reduce unfairness on rewaits</span><br>                <span class="hljs-comment">// é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ç¬¬äºŒæ¬¡å¼€å§‹ç«äº‰çš„æ—¶å€™æœ‰è‡ªæ—‹æ¬¡æ•°</span><br>                --spins;              <br>                Thread.onSpinWait();<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.status == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// enable signal and recheck</span><br>                <span class="hljs-comment">// è‡ªæ—‹ç«äº‰å¤±è´¥åé‡æ–°ç­‰å¾…</span><br>                node.status = WAITING;          <br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">long</span> nanos;<br>                <span class="hljs-comment">// è‡ªæ—‹æ¬¡æ•°</span><br>                spins = postSpins = (<span class="hljs-type">byte</span>)((postSpins &lt;&lt; <span class="hljs-number">1</span>) | <span class="hljs-number">1</span>);<br>                <span class="hljs-keyword">if</span> (!timed)<br>                    LockSupport.park(<span class="hljs-built_in">this</span>);<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((nanos = time - System.nanoTime()) &gt; <span class="hljs-number">0L</span>)<br>                    LockSupport.parkNanos(<span class="hljs-built_in">this</span>, nanos);<br>                <span class="hljs-keyword">else</span><br>                    <span class="hljs-keyword">break</span>;<br>                node.clearStatus();<br>                <span class="hljs-comment">/// å¯æ‰“æ–­å¹¶å·²ç»æ‰“æ–­ï¼Œæ”¾å¼ƒacquire</span><br>                <span class="hljs-keyword">if</span> ((interrupted |= Thread.interrupted()) &amp;&amp; interruptible)<br>                    <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> cancelAcquire(node, interrupted, interruptible);<br>    &#125; <br><br>    <span class="hljs-comment">// å¯èƒ½ä»å°¾éƒ¨å¼€å§‹é‡å¤éå†</span><br>    <span class="hljs-comment">// å°†å·²å–æ¶ˆçš„èŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­å‰”é™¤ï¼Œç›´åˆ°æ‰¾ä¸åˆ°å·²å–æ¶ˆèŠ‚ç‚¹</span><br>    <span class="hljs-comment">// unparkå¯èƒ½å·²è¢«é‡æ–°é“¾æ¥ä¸ºä¸‹ä¸€ä¸ªåˆæ ¼çš„acquirerçš„èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (;;) &#123;                               <span class="hljs-comment">// restart point </span><br>            <span class="hljs-comment">// qä¸ºè¦æ£€æŸ¥çš„nodeï¼Œpä¸ºqçš„å‰é©±èŠ‚ç‚¹ï¼Œsä¸ºqçš„åç»§èŠ‚ç‚¹</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">q</span> <span class="hljs-operator">=</span> tail, s = <span class="hljs-literal">null</span>, p, n;;) &#123; <span class="hljs-comment">// (p, q, s) triples</span><br>                <span class="hljs-keyword">if</span> (q == <span class="hljs-literal">null</span> || (p = q.prev) == <span class="hljs-literal">null</span>)<br>                    <span class="hljs-keyword">return</span>;                      <span class="hljs-comment">// end of list</span><br>                <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span> ? tail != q : (s.prev != q || s.status &lt; <span class="hljs-number">0</span>))<br>                    <span class="hljs-keyword">break</span>;                       <span class="hljs-comment">// inconsistent</span><br>                <span class="hljs-keyword">if</span> (q.status &lt; <span class="hljs-number">0</span>) &#123;              <span class="hljs-comment">// cancelled</span><br>                    <span class="hljs-keyword">if</span> ((s == <span class="hljs-literal">null</span> ? casTail(q, p) : s.casPrev(q, p)) &amp;&amp;<br>                        q.prev == p) &#123;<br>                        p.casNext(q, s);         <span class="hljs-comment">// OK if fails</span><br>                        <span class="hljs-keyword">if</span> (p.prev == <span class="hljs-literal">null</span>)<br>                            signalNext(p);<br>                    &#125;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-comment">// ä¸‹é¢çš„ä»£ç åº”è¯¥æ˜¯è€ƒè™‘åˆ°äº†å¹¶å‘ï¼Œå¯¹åº”ä¸Šé¢çš„</span><br>                <span class="hljs-comment">// p.casNext(q, s); è¿˜æœªå¼€å§‹</span><br>                <span class="hljs-keyword">if</span> ((n = p.next) != q) &#123;         <span class="hljs-comment">// help finish</span><br>                    <span class="hljs-keyword">if</span> (n != <span class="hljs-literal">null</span> &amp;&amp; q.prev == p) &#123;<br>                        p.casNext(n, q);<br>                        <span class="hljs-keyword">if</span> (p.prev == <span class="hljs-literal">null</span>)<br>                            signalNext(p);<br>                    &#125;<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                s = q;<br>                q = q.prev;<br>            &#125;<br>        &#125;<br>    &#125; <br><br>    <span class="hljs-comment">// interruptedï¼šå¦‚æœçº¿ç¨‹ä¸­æ–­ï¼Œåˆ™ä¸ºtrue</span><br>    <span class="hljs-comment">// interruptibleï¼šæ˜¯å¦åº”è¯¥æŠ¥å‘Šä¸­æ–­å’Œå¤ä½</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cancelAcquire</span><span class="hljs-params">(Node node, <span class="hljs-type">boolean</span> interrupted,</span><br><span class="hljs-params">                              <span class="hljs-type">boolean</span> interruptible)</span> &#123;<br>        <span class="hljs-keyword">if</span> (node != <span class="hljs-literal">null</span>) &#123;<br>            node.waiter = <span class="hljs-literal">null</span>;<br>            node.status = CANCELLED;<br>            <span class="hljs-keyword">if</span> (node.prev != <span class="hljs-literal">null</span>)<br>                cleanQueue();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (interrupted) &#123;<br>            <span class="hljs-keyword">if</span> (interruptible)<br>                <span class="hljs-keyword">return</span> CANCELLED;<br>            <span class="hljs-keyword">else</span><br>                Thread.currentThread().interrupt();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// è¯•å›¾ä»¥ç‹¬å æ¨¡å¼è·å–ã€‚æ­¤æ–¹æ³•åº”è¯¥æŸ¥è¯¢å¯¹è±¡çš„çŠ¶æ€æ˜¯å¦å…è®¸ä»¥ç‹¬å æ¨¡å¼è·å–å®ƒï¼Œå¦‚æœå…è®¸ï¼Œå°±è·å–å®ƒã€‚</span><br>    <span class="hljs-comment">// è¯¥æ–¹æ³•æ€»æ˜¯ç”±æ‰§è¡Œacquireçš„çº¿ç¨‹è°ƒç”¨ã€‚</span><br>    <span class="hljs-comment">// å¦‚æœè¿™ä¸ªæ–¹æ³•æŠ¥é”™ï¼Œå¦‚æœçº¿ç¨‹è¿˜æ²¡æœ‰æ’é˜Ÿï¼Œé‚£ä¹ˆacquireæ–¹æ³•å¯ä»¥å°†çº¿ç¨‹æ’é˜Ÿ</span><br>    <span class="hljs-comment">// ç›´åˆ°å®ƒè¢«æŸä¸ªå…¶ä»–çº¿ç¨‹çš„é‡Šæ”¾å”¤é†’</span><br>    <span class="hljs-comment">// è¿™å¯ç”¨äºå®ç°æ–¹æ³•Lock.tryLock()ã€‚</span><br>    <span class="hljs-comment">// argï¼šè·å–å‚æ•°ã€‚è¯¥å€¼å§‹ç»ˆæ˜¯ä¼ é€’ç»™acquireæ–¹æ³•çš„å€¼ï¼Œ</span><br>    <span class="hljs-comment">// æˆ–è€…æ˜¯åœ¨è¿›å…¥æ¡ä»¶ç­‰å¾…æ—¶ä¿å­˜çš„å€¼ã€‚è¯¥å€¼ä¸éœ€è¦è§£é‡Šï¼Œå¯ä»¥è¡¨ç¤ºæ‚¨å–œæ¬¢çš„ä»»ä½•å†…å®¹ã€‚</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>    &#125; <br><br>    <span class="hljs-comment">// å°è¯•è®¾ç½®çŠ¶æ€ä»¥åæ˜ ç‹¬å æ¨¡å¼ä¸‹çš„é‡Šæ”¾ã€‚</span><br>    <span class="hljs-comment">// è¯¥æ–¹æ³•æ€»æ˜¯ç”±æ‰§è¡Œé‡Šæ”¾çš„çº¿ç¨‹è°ƒç”¨</span><br>    <span class="hljs-comment">// è¿”å›å€¼ï¼šå¦‚æœæ­¤å¯¹è±¡ç°åœ¨å¤„äºå®Œå…¨é‡Šæ”¾çŠ¶æ€ï¼Œåˆ™ä¸ºtrueï¼Œä»¥ä¾¿ä»»ä½•ç­‰å¾…çš„çº¿ç¨‹éƒ½å¯ä»¥å°è¯•è·å–ï¼›å¦åˆ™ä¸ºfalseã€‚</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>    &#125; <br><br>    <span class="hljs-comment">// å°è¯•åœ¨å…±äº«æ¨¡å¼ä¸‹è·å–ã€‚æ­¤æ–¹æ³•åº”è¯¥æŸ¥è¯¢å¯¹è±¡çš„çŠ¶æ€æ˜¯å¦å…è®¸åœ¨å…±äº«æ¨¡å¼ä¸‹è·å–å®ƒï¼Œå¦‚æœå…è®¸ï¼Œå°±è·å–å®ƒã€‚</span><br>    <span class="hljs-comment">// è¯¥æ–¹æ³•æ€»æ˜¯ç”±æ‰§è¡Œacquireçš„çº¿ç¨‹è°ƒç”¨ã€‚</span><br>    <span class="hljs-comment">// å¦‚æœè¿™ä¸ªæ–¹æ³•æŠ¥å‘Šå¤±è´¥ï¼Œå¦‚æœçº¿ç¨‹è¿˜æ²¡æœ‰æ’é˜Ÿï¼Œé‚£ä¹ˆacquireæ–¹æ³•å¯ä»¥å°†çº¿ç¨‹æ’é˜Ÿï¼Œ</span><br>    <span class="hljs-comment">// ç›´åˆ°å®ƒè¢«æŸä¸ªå…¶ä»–çº¿ç¨‹çš„é‡Šæ”¾å”¤é†’ã€‚</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>    &#125; <br><br>    <span class="hljs-comment">// è¿”å›å€¼ï¼šå¦‚æœå…±äº«æ¨¡å¼çš„è¿™ä¸€é‡Šæ”¾å¯ä»¥å…è®¸ç­‰å¾…çš„è·å–(å…±äº«æˆ–ç‹¬å )æˆåŠŸï¼Œåˆ™ä¸ºtrueå¦åˆ™ä¸ºfalse</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>    &#125; <br><br>    <span class="hljs-comment">// å¦‚æœåŒæ­¥æ˜¯ç›¸å¯¹äºå½“å‰(è°ƒç”¨)çº¿ç¨‹ç‹¬å ä¿æŒçš„ï¼Œåˆ™è¿”å›trueã€‚</span><br>    <span class="hljs-comment">// æ¯æ¬¡è°ƒç”¨AbstractQueuedSynchronizeræ—¶éƒ½ä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚æ¡ä»¶å¯¹è±¡æ–¹æ³•ã€‚</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();<br>    &#125; <br><br>    <span class="hljs-comment">// åœ¨ç‹¬å æ¨¡å¼ä¸‹acquireï¼Œå¿½ç•¥ä¸­æ–­ã€‚</span><br>    <span class="hljs-comment">// é€šè¿‡è‡³å°‘è°ƒç”¨ä¸€æ¬¡tryAcquireæ¥å®ç°ï¼ŒæˆåŠŸæ—¶è¿”å›ã€‚</span><br>    <span class="hljs-comment">// å¦åˆ™çº¿ç¨‹è¢«æ’é˜Ÿï¼Œå¯èƒ½é‡å¤é˜»å¡å’Œè§£é™¤é˜»å¡ï¼Œè°ƒç”¨tryAcquireç›´åˆ°æˆåŠŸã€‚</span><br>    <span class="hljs-comment">// æ­¤æ–¹æ³•å¯ç”¨äºå®ç°æ–¹æ³•Lock.lockã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!tryAcquire(arg))<br>            acquire(<span class="hljs-literal">null</span>, arg, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);<br>    &#125; <br><br>    <span class="hljs-comment">// åœ¨ç‹¬å æ¨¡å¼ä¸‹acquireï¼Œå¦‚æœè¢«ä¸­æ–­åˆ™ä¸­æ­¢ã€‚</span><br>    <span class="hljs-comment">// é¦–å…ˆæ£€æŸ¥ä¸­æ–­çŠ¶æ€ï¼Œç„¶åè‡³å°‘è°ƒç”¨ä¸€æ¬¡tryAcquireï¼ŒæˆåŠŸåè¿”å›ã€‚</span><br>    <span class="hljs-comment">// å¦åˆ™çº¿ç¨‹è¢«æ’é˜Ÿï¼Œå¯èƒ½é‡å¤é˜»å¡å’Œè§£é™¤é˜»å¡ï¼Œè°ƒç”¨tryAcquireç›´åˆ°æˆåŠŸæˆ–çº¿ç¨‹è¢«ä¸­æ–­ã€‚</span><br>    <span class="hljs-comment">// æ­¤æ–¹æ³•å¯ç”¨äºå®ç°æ–¹æ³• Lock.lockInterruptiblyã€‚ </span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireInterruptibly</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span><br>        <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">if</span> (Thread.interrupted() ||<br>            (!tryAcquire(arg) &amp;&amp; acquire(<span class="hljs-literal">null</span>, arg, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>) &lt; <span class="hljs-number">0</span>))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>    &#125; <br><br>    <span class="hljs-comment">// å°è¯•ä»¥ç‹¬å æ¨¡å¼acquireï¼Œå¦‚æœè¢«ä¸­æ–­åˆ™ä¸­æ­¢ï¼Œå¦‚æœè¶…æ—¶åˆ™å¤±è´¥ã€‚</span><br>    <span class="hljs-comment">// é¦–å…ˆæ£€æŸ¥ä¸­æ–­çŠ¶æ€ï¼Œç„¶åè‡³å°‘è°ƒç”¨ä¸€æ¬¡tryAcquireï¼ŒæˆåŠŸåè¿”å›ã€‚</span><br>    <span class="hljs-comment">// å¦åˆ™ï¼Œçº¿ç¨‹è¢«æ’é˜Ÿï¼Œå¯èƒ½é‡å¤é˜»å¡å’Œè§£é™¤é˜»å¡ï¼Œè°ƒç”¨tryAcquireï¼Œç›´åˆ°æˆåŠŸæˆ–çº¿ç¨‹è¢«ä¸­æ–­æˆ–è¶…æ—¶ã€‚</span><br>    <span class="hljs-comment">// æ­¤æ–¹æ³•å¯ç”¨äºå®ç°æ–¹æ³•Lock.tryLock(longï¼ŒTimeUnit)ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquireNanos</span><span class="hljs-params">(<span class="hljs-type">int</span> arg, <span class="hljs-type">long</span> nanosTimeout)</span><br>        <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">if</span> (!Thread.interrupted()) &#123;<br>            <span class="hljs-keyword">if</span> (tryAcquire(arg))<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">if</span> (nanosTimeout &lt;= <span class="hljs-number">0L</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">stat</span> <span class="hljs-operator">=</span> acquire(<span class="hljs-literal">null</span>, arg, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>,<br>                               System.nanoTime() + nanosTimeout);<br>            <span class="hljs-keyword">if</span> (stat &gt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">if</span> (stat == <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>    &#125; <br><br>    <span class="hljs-comment">// ä»¥ç‹¬å æ¨¡å¼é‡Šæ”¾ã€‚</span><br>    <span class="hljs-comment">// å¦‚æœtryReleaseè¿”å›trueï¼Œåˆ™é€šè¿‡è§£é™¤ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹çš„é˜»å¡æ¥å®ç°ã€‚</span><br>    <span class="hljs-comment">// æ­¤æ–¹æ³•å¯ç”¨äºå®ç°æ–¹æ³•Lock.unlockã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">release</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>        <span class="hljs-keyword">if</span> (tryRelease(arg)) &#123;<br>            signalNext(head);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// åœ¨share modeæ—¶acquire</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>        <span class="hljs-keyword">if</span> (tryAcquireShared(arg) &lt; <span class="hljs-number">0</span>)<br>            acquire(<span class="hljs-literal">null</span>, arg, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);<br>    &#125; <br><br>    <span class="hljs-comment">// åœ¨share modeæ—¶ acquireInterruptibly</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireSharedInterruptibly</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span><br>        <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">if</span> (Thread.interrupted() ||<br>            (tryAcquireShared(arg) &lt; <span class="hljs-number">0</span> &amp;&amp;<br>             acquire(<span class="hljs-literal">null</span>, arg, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>) &lt; <span class="hljs-number">0</span>))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>    &#125; <br><br>    <span class="hljs-comment">// åœ¨share modeæ—¶ tryAcquireNanos</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquireSharedNanos</span><span class="hljs-params">(<span class="hljs-type">int</span> arg, <span class="hljs-type">long</span> nanosTimeout)</span><br>            <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">if</span> (!Thread.interrupted()) &#123;<br>            <span class="hljs-keyword">if</span> (tryAcquireShared(arg) &gt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">if</span> (nanosTimeout &lt;= <span class="hljs-number">0L</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">stat</span> <span class="hljs-operator">=</span> acquire(<span class="hljs-literal">null</span>, arg, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>,<br>                               System.nanoTime() + nanosTimeout);<br>            <span class="hljs-keyword">if</span> (stat &gt; <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-keyword">if</span> (stat == <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>    &#125; <br><br>    <span class="hljs-comment">// åœ¨share modeæ—¶ release</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">releaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>        <span class="hljs-keyword">if</span> (tryReleaseShared(arg)) &#123;<br>            signalNext(head);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// é˜Ÿåˆ—æ£€æŸ¥æ–¹æ³•</span><br><br>    <span class="hljs-comment">// æŸ¥è¯¢æ˜¯å¦æœ‰ä»»ä½•çº¿ç¨‹æ­£åœ¨ç­‰å¾…è·å–ã€‚</span><br>    <span class="hljs-comment">// è¯·æ³¨æ„ï¼Œç”±äºä¸­æ–­å’Œè¶…æ—¶å¯¼è‡´çš„å–æ¶ˆå¯èƒ½éšæ—¶å‘ç”Ÿï¼Œæ‰€ä»¥è¿”å›trueå¹¶ä¸ä¿è¯ä»»ä½•å…¶ä»–çº¿ç¨‹acquireæˆåŠŸã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasQueuedThreads</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> tail, h = head; p != h &amp;&amp; p != <span class="hljs-literal">null</span>; p = p.prev)<br>            <span class="hljs-keyword">if</span> (p.status &gt;= <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// æŸ¥è¯¢æ˜¯å¦æœ‰ä»»ä½•çº¿ç¨‹æ›¾ç»ç«äº‰è·å–æ­¤åŒæ­¥å™¨ï¼›</span><br>    <span class="hljs-comment">// ä¹Ÿå°±æ˜¯è¯´ï¼Œæ˜¯å¦æœ‰ä¸€ä¸ªacquireæ–¹æ³•æ›¾ç»è¢«é˜»å¡ã€‚</span><br>    <span class="hljs-comment">// åœ¨è¿™ä¸ªå®ç°ä¸­ï¼Œè¿™ä¸ªæ“ä½œåœ¨å¸¸æ•°æ—¶é—´å†…è¿”å›ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasContended</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> head != <span class="hljs-literal">null</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// è¿”å›é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª(ç­‰å¾…æ—¶é—´æœ€é•¿çš„)çº¿ç¨‹ï¼Œå¦‚æœå½“å‰æ²¡æœ‰çº¿ç¨‹æ’é˜Ÿï¼Œåˆ™è¿”å›nullã€‚</span><br>    <span class="hljs-comment">// åœ¨è¯¥å®ç°ä¸­ï¼Œè¯¥æ“ä½œé€šå¸¸åœ¨æ’å®šæ—¶é—´å†…è¿”å›ï¼Œä½†æ˜¯å¦‚æœå…¶ä»–çº¿ç¨‹åŒæ—¶ä¿®æ”¹é˜Ÿåˆ—ï¼Œåˆ™å¯èƒ½åœ¨ç«äº‰æ—¶é‡å¤ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Thread <span class="hljs-title function_">getFirstQueuedThread</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>, w; Node h, s;<br>        <span class="hljs-keyword">if</span> ((h = head) != <span class="hljs-literal">null</span> &amp;&amp; ((s = h.next) == <span class="hljs-literal">null</span> ||<br>                                   (first = s.waiter) == <span class="hljs-literal">null</span> ||<br>                                   s.prev == <span class="hljs-literal">null</span>)) &#123;<br>            <span class="hljs-comment">// traverse from tail on stale reads </span><br>            <span class="hljs-comment">// qå­˜å‚¨pçš„å‰é©±èŠ‚ç‚¹</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> tail, q; p != <span class="hljs-literal">null</span> &amp;&amp; (q = p.prev) != <span class="hljs-literal">null</span>; p = q)<br>                <span class="hljs-keyword">if</span> ((w = p.waiter) != <span class="hljs-literal">null</span>)<br>                    first = w;<br>        &#125;<br>        <span class="hljs-keyword">return</span> first;<br>    &#125; <br><br>    <span class="hljs-comment">// å¦‚æœç»™å®šçº¿ç¨‹å½“å‰æ­£åœ¨æ’é˜Ÿï¼Œåˆ™è¿”å›trueã€‚</span><br>    <span class="hljs-comment">// è¯¥å®ç°éå†é˜Ÿåˆ—ä»¥ç¡®å®šç»™å®šçº¿ç¨‹çš„å­˜åœ¨ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isQueued</span><span class="hljs-params">(Thread thread)</span> &#123;<br>        <span class="hljs-keyword">if</span> (thread == <span class="hljs-literal">null</span>)<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> tail; p != <span class="hljs-literal">null</span>; p = p.prev)<br>            <span class="hljs-keyword">if</span> (p.waiter == thread)<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// å¦‚æœæ˜é¢ä¸Šçš„ç¬¬ä¸€ä¸ªæ’é˜Ÿçº¿ç¨‹(å¦‚æœå­˜åœ¨)æ­£åœ¨ä»¥ç‹¬å æ¨¡å¼ç­‰å¾…ï¼Œåˆ™è¿”å›trueã€‚</span><br>    <span class="hljs-comment">// å¦‚æœæ­¤æ–¹æ³•è¿”å›trueï¼Œå¹¶ä¸”å½“å‰çº¿ç¨‹æ­£åœ¨å°è¯•ä»¥å…±äº«æ¨¡å¼è·å–(å³ï¼Œæ­¤æ–¹æ³•æ˜¯ä»tryAcquireSharedè°ƒç”¨çš„)ï¼Œ</span><br>    <span class="hljs-comment">// åˆ™å¯ä»¥ä¿è¯å½“å‰çº¿ç¨‹ä¸æ˜¯ç¬¬ä¸€ä¸ªæ’é˜Ÿçš„çº¿ç¨‹ã€‚åœ¨ReentrantReadWriteLockä¸­ä»…ç”¨ä½œå¯å‘å¼æ–¹æ³•ã€‚</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apparentlyFirstQueuedIsExclusive</span><span class="hljs-params">()</span> &#123;<br>        Node h, s;<br>        <span class="hljs-keyword">return</span> (h = head) != <span class="hljs-literal">null</span> &amp;&amp; (s = h.next)  != <span class="hljs-literal">null</span> &amp;&amp;<br>            !(s <span class="hljs-keyword">instanceof</span> SharedNode) &amp;&amp; s.waiter != <span class="hljs-literal">null</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// æŸ¥è¯¢æ˜¯å¦æœ‰ä»»ä½•çº¿ç¨‹ç­‰å¾…è·å–çš„æ—¶é—´æ¯”å½“å‰çº¿ç¨‹é•¿ã€‚</span><br>    <span class="hljs-comment">// æ­¤æ–¹æ³•çš„è°ƒç”¨ç­‰æ•ˆäº(ä½†å¯èƒ½æ›´æœ‰æ•ˆ):</span><br>    <span class="hljs-comment">// getFirstQueuedThread() != Thread.currentThread() &amp;&amp; hasQueuedThreads()</span><br>    <span class="hljs-comment">// è¯·æ³¨æ„ï¼Œç”±äºä¸­æ–­å’Œè¶…æ—¶å¯¼è‡´çš„å–æ¶ˆå¯èƒ½ä¼šåœ¨ä»»ä½•æ—¶å€™å‘ç”Ÿï¼Œ</span><br>    <span class="hljs-comment">// æ‰€ä»¥çœŸæ­£çš„è¿”å›å¹¶ä¸ä¿è¯å…¶ä»–çº¿ç¨‹ä¼šåœ¨å½“å‰çº¿ç¨‹ä¹‹å‰è·å–ã€‚</span><br>    <span class="hljs-comment">// åŒæ ·ï¼Œç”±äºé˜Ÿåˆ—ä¸ºç©ºï¼Œåœ¨æ­¤æ–¹æ³•è¿”å›falseåï¼Œå¦ä¸€ä¸ªèµ¢å¾—ç«äº‰çš„çº¿ç¨‹ä¹Ÿå¯èƒ½æ’é˜Ÿã€‚</span><br>    <span class="hljs-comment">// è¯¥æ–¹æ³•è¢«è®¾è®¡ä¸ºç”±å…¬å¹³åŒæ­¥å™¨ä½¿ç”¨ä»¥é¿å…å†²çªã€‚</span><br>    <span class="hljs-comment">// è¿™æ ·ä¸€ä¸ªåŒæ­¥å™¨çš„tryAcquireæ–¹æ³•åº”è¯¥è¿”å›falseï¼Œ</span><br>    <span class="hljs-comment">// å®ƒçš„tryAcquireSharedæ–¹æ³•åº”è¯¥è¿”å›è´Ÿå€¼ï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•è¿”å›trueçš„è¯(é™¤éè¿™æ˜¯ä¸€ä¸ªå¯é‡å…¥çš„Acquire)ã€‚</span><br>    <span class="hljs-comment">// ä¾‹å¦‚ï¼Œå…¬å¹³ã€å¯é‡å…¥ã€ç‹¬å æ¨¡å¼åŒæ­¥å™¨çš„tryAcquireæ–¹æ³•å¯èƒ½å¦‚ä¸‹æ‰€ç¤º</span><br>    <span class="hljs-comment">// protected boolean tryAcquire(int arg) &#123;</span><br>    <span class="hljs-comment">//   if (isHeldExclusively()) &#123;</span><br>    <span class="hljs-comment">//     // A reentrant acquire; increment hold count</span><br>    <span class="hljs-comment">//     return true;</span><br>    <span class="hljs-comment">//   &#125; else if (hasQueuedPredecessors()) &#123;</span><br>    <span class="hljs-comment">//     return false;</span><br>    <span class="hljs-comment">//   &#125; else &#123;</span><br>    <span class="hljs-comment">//     // try to acquire normally</span><br>    <span class="hljs-comment">//   &#125;</span><br>    <span class="hljs-comment">// &#125;</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasQueuedPredecessors</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>; Node h, s;<br>        <span class="hljs-keyword">if</span> ((h = head) != <span class="hljs-literal">null</span> &amp;&amp; ((s = h.next) == <span class="hljs-literal">null</span> ||<br>                                   (first = s.waiter) == <span class="hljs-literal">null</span> ||<br>                                   s.prev == <span class="hljs-literal">null</span>)) <br>            <span class="hljs-comment">// è¿™é‡Œçš„åˆ¤æ–­åœ¨ getFirstQueuedThread å·²ç»æœ‰äº†ï¼Œæˆ‘è§‰å¾—å¯ä»¥å»æ‰</span><br>            first = getFirstQueuedThread(); <span class="hljs-comment">// retry via getFirstQueuedThread</span><br>        <span class="hljs-keyword">return</span> first != <span class="hljs-literal">null</span> &amp;&amp; first != Thread.currentThread();<br>    &#125; <br><br>    <span class="hljs-comment">// æ£€æµ‹å’Œç›‘æ§æ–¹æ³•</span><br><br>    <span class="hljs-comment">// è¿”å›ç­‰å¾…è·å–çš„çº¿ç¨‹æ•°çš„ä¼°è®¡å€¼ã€‚</span><br>    <span class="hljs-comment">// è¯¥å€¼åªæ˜¯ä¸€ä¸ªä¼°è®¡å€¼ï¼Œå› ä¸ºåœ¨æ­¤æ–¹æ³•éå†å†…éƒ¨æ•°æ®ç»“æ„æ—¶ï¼Œçº¿ç¨‹çš„æ•°é‡å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ã€‚</span><br>    <span class="hljs-comment">// æ­¤æ–¹æ³•è®¾è®¡ç”¨äºç›‘è§†ç³»ç»ŸçŠ¶æ€ï¼Œè€Œä¸æ˜¯ç”¨äºåŒæ­¥æ§åˆ¶ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getQueueLength</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> tail; p != <span class="hljs-literal">null</span>; p = p.prev) &#123;<br>            <span class="hljs-keyword">if</span> (p.waiter != <span class="hljs-literal">null</span>)<br>                ++n;<br>        &#125;<br>        <span class="hljs-keyword">return</span> n;<br>    &#125; <br><br>    <span class="hljs-comment">// è¿”å›åŒ…å«å¯èƒ½æ­£åœ¨ç­‰å¾…è·å–çš„çº¿ç¨‹çš„é›†åˆã€‚</span><br>    <span class="hljs-comment">// å› ä¸ºå®é™…çš„çº¿ç¨‹é›†åœ¨æ„é€ è¿™ä¸ªç»“æœæ—¶å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ï¼Œ</span><br>    <span class="hljs-comment">// æ‰€ä»¥è¿”å›çš„é›†åˆåªæ˜¯ä¸€ä¸ªæœ€ä½³ä¼°è®¡ã€‚</span><br>    <span class="hljs-comment">// è¿”å›é›†åˆçš„å…ƒç´ æ²¡æœ‰ç‰¹å®šçš„é¡ºåºã€‚</span><br>    <span class="hljs-comment">// è¯¥æ–¹æ³•æ—¨åœ¨ä¿ƒè¿›å­ç±»çš„æ„å»ºï¼Œä»è€Œæä¾›æ›´å¹¿æ³›çš„ç›‘æ§åŠŸèƒ½ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Collection&lt;Thread&gt; <span class="hljs-title function_">getQueuedThreads</span><span class="hljs-params">()</span> &#123;<br>        ArrayList&lt;Thread&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> tail; p != <span class="hljs-literal">null</span>; p = p.prev) &#123;<br>            <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> p.waiter;<br>            <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>)<br>                list.add(t);<br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>    &#125; <br><br>    <span class="hljs-comment">// è¿”å›åŒ…å«å¯èƒ½æ­£åœ¨ç­‰å¾…ä»¥ç‹¬å æ¨¡å¼acquireçš„çº¿ç¨‹çš„é›†åˆã€‚</span><br>    <span class="hljs-comment">// è¿™ä¸getQueuedThreadså…·æœ‰ç›¸åŒçš„å±æ€§ï¼Œ</span><br>    <span class="hljs-comment">// åªæ˜¯å®ƒåªè¿”å›é‚£äº›ç”±äºç‹¬å è·å–è€Œç­‰å¾…çš„çº¿ç¨‹ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Collection&lt;Thread&gt; <span class="hljs-title function_">getExclusiveQueuedThreads</span><span class="hljs-params">()</span> &#123;<br>        ArrayList&lt;Thread&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> tail; p != <span class="hljs-literal">null</span>; p = p.prev) &#123;<br>            <span class="hljs-keyword">if</span> (!(p <span class="hljs-keyword">instanceof</span> SharedNode)) &#123;<br>                <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> p.waiter;<br>                <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>)<br>                    list.add(t);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>    &#125; <br><br>    <span class="hljs-comment">// è¿”å›åŒ…å«å¯èƒ½æ­£åœ¨ç­‰å¾…ä»¥å…±äº«æ¨¡å¼acquireçš„çº¿ç¨‹çš„é›†åˆã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Collection&lt;Thread&gt; <span class="hljs-title function_">getSharedQueuedThreads</span><span class="hljs-params">()</span> &#123;<br>        ArrayList&lt;Thread&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> tail; p != <span class="hljs-literal">null</span>; p = p.prev) &#123;<br>            <span class="hljs-keyword">if</span> (p <span class="hljs-keyword">instanceof</span> SharedNode) &#123;<br>                <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> p.waiter;<br>                <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>)<br>                    list.add(t);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>    &#125; <br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.toString()<br>            + <span class="hljs-string">&quot;[State = &quot;</span> + getState() + <span class="hljs-string">&quot;, &quot;</span><br>            + (hasQueuedThreads() ? <span class="hljs-string">&quot;non&quot;</span> : <span class="hljs-string">&quot;&quot;</span>) + <span class="hljs-string">&quot;empty queue]&quot;</span>;<br>    &#125; <br><br>    <span class="hljs-comment">// conditionsçš„æ£€æµ‹æ–¹æ³•</span><br><br>    <span class="hljs-comment">// æŸ¥è¯¢ç»™å®šçš„ConditionObjectæ˜¯å¦ä½¿ç”¨æ­¤åŒæ­¥å™¨ä½œä¸ºå…¶é”ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">owns</span><span class="hljs-params">(ConditionObject condition)</span> &#123;<br>        <span class="hljs-keyword">return</span> condition.isOwnedBy(<span class="hljs-built_in">this</span>);<br>    &#125; <br><br>    <span class="hljs-comment">// æŸ¥è¯¢æ˜¯å¦æœ‰ä»»ä½•çº¿ç¨‹æ­£åœ¨ç­‰å¾…ä¸æ­¤åŒæ­¥å™¨å…³è”çš„ç»™å®šæ¡ä»¶ã€‚</span><br>    <span class="hljs-comment">// è¯·æ³¨æ„ï¼Œå› ä¸ºè¶…æ—¶å’Œä¸­æ–­å¯èƒ½éšæ—¶å‘ç”Ÿï¼Œæ‰€ä»¥çœŸæ­£çš„è¿”å›å¹¶ä¸ä¿è¯å°†æ¥çš„ä¿¡å·ä¼šå”¤é†’ä»»ä½•çº¿ç¨‹ã€‚</span><br>    <span class="hljs-comment">// è¿™æ–¹æ³•ä¸»è¦ç”¨äºç›‘æ§ç³»ç»ŸçŠ¶æ€ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasWaiters</span><span class="hljs-params">(ConditionObject condition)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!owns(condition))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Not owner&quot;</span>);<br>        <span class="hljs-keyword">return</span> condition.hasWaiters();<br>    &#125;  <br><br>    <span class="hljs-comment">// è¿”å›åœ¨ä¸æ­¤åŒæ­¥å™¨ç›¸å…³çš„ç»™å®šæ¡ä»¶ä¸‹ç­‰å¾…çš„çº¿ç¨‹æ•°çš„ä¼°è®¡å€¼ã€‚</span><br>    <span class="hljs-comment">// è¯·æ³¨æ„ï¼Œå› ä¸ºè¶…æ—¶å’Œä¸­æ–­å¯èƒ½éšæ—¶å‘ç”Ÿï¼Œæ‰€ä»¥ä¼°è®¡å€¼åªæ˜¯å®é™…ç­‰å¾…è€…æ•°é‡çš„ä¸Šé™ã€‚</span><br>    <span class="hljs-comment">// æ­¤æ–¹æ³•è¢«è®¾è®¡ç”¨äºç›‘è§†ç³»ç»ŸçŠ¶æ€ï¼Œè€Œä¸æ˜¯ç”¨äºåŒæ­¥æ§åˆ¶ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getWaitQueueLength</span><span class="hljs-params">(ConditionObject condition)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!owns(condition))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Not owner&quot;</span>);<br>        <span class="hljs-keyword">return</span> condition.getWaitQueueLength();<br>    &#125;<br><br>    <span class="hljs-comment">// è¿”å›ä¸€ä¸ªé›†åˆï¼Œè¯¥é›†åˆåŒ…å«å¯èƒ½æ­£åœ¨ç­‰å¾…ä¸æ­¤åŒæ­¥å™¨å…³è”çš„ç»™å®šæ¡ä»¶çš„é‚£äº›çº¿ç¨‹ã€‚</span><br>    <span class="hljs-comment">// å› ä¸ºå®é™…çš„çº¿ç¨‹é›†åœ¨æ„é€ è¿™ä¸ªç»“æœæ—¶å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ï¼Œ</span><br>    <span class="hljs-comment">// æ‰€ä»¥è¿”å›çš„é›†åˆåªæ˜¯ä¸€ä¸ªæœ€ä½³ä¼°è®¡ã€‚è¿”å›é›†åˆçš„å…ƒç´ æ²¡æœ‰ç‰¹å®šçš„é¡ºåºã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Collection&lt;Thread&gt; <span class="hljs-title function_">getWaitingThreads</span><span class="hljs-params">(ConditionObject condition)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!owns(condition))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Not owner&quot;</span>);<br>        <span class="hljs-keyword">return</span> condition.getWaitingThreads();<br>    &#125; <br><br>    <span class="hljs-comment">// AbstractQueuedSynchronizerçš„æ¡ä»¶å®ç°ï¼Œä½œä¸ºé”å®ç°çš„åŸºç¡€ã€‚</span><br>    <span class="hljs-comment">// è¿™ä¸ªç±»çš„æ–¹æ³•æ–‡æ¡£æè¿°çš„æ˜¯æœºåˆ¶ï¼Œè€Œä¸æ˜¯ä»é”å’Œæ¡ä»¶ç”¨æˆ·çš„è§’åº¦æ¥çœ‹çš„è¡Œä¸ºè§„èŒƒã€‚</span><br>    <span class="hljs-comment">// è¯¥ç±»çš„å¯¼å‡ºç‰ˆæœ¬é€šå¸¸éœ€è¦é™„å¸¦æè¿°ä¾èµ–äºç›¸å…³AbstractQueuedSynchronizerçš„æ¡ä»¶è¯­ä¹‰çš„æ–‡æ¡£ã€‚</span><br>    <span class="hljs-comment">// è¯¥ç±»æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œä½†æ‰€æœ‰å­—æ®µéƒ½æ˜¯transient çš„ï¼Œå› æ­¤ååºåˆ—åŒ–çš„conditionæ²¡æœ‰ç­‰å¾…è€…ã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Condition</span>, java.io.Serializable &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1173984872572414699L</span>;<br>         <span class="hljs-comment">/** First node of condition queue. */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> ConditionNode firstWaiter;<br>        <span class="hljs-comment">/** Last node of condition queue. */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> ConditionNode lastWaiter; <br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Creates a new &#123;<span class="hljs-doctag">@code</span> ConditionObject&#125; instance.</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConditionObject</span><span class="hljs-params">()</span> &#123; &#125; <br><br>        <span class="hljs-comment">// Signalling methods </span><br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * Removes and transfers one or all waiters to sync queue. </span><br><span class="hljs-comment">         * ç§»é™¤ä¸€ä¸ªæˆ–æ‰€æœ‰ç­‰å¾…è€…å¹¶å°†å…¶è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSignal</span><span class="hljs-params">(ConditionNode first, <span class="hljs-type">boolean</span> all)</span> &#123;<br>            <span class="hljs-keyword">while</span> (first != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> first.nextWaiter;<br>                <span class="hljs-keyword">if</span> ((firstWaiter = next) == <span class="hljs-literal">null</span>)<br>                    lastWaiter = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">if</span> ((first.getAndUnsetStatus(COND) &amp; COND) != <span class="hljs-number">0</span>) &#123;<br>                    enqueue(first);<br>                    <span class="hljs-keyword">if</span> (!all)<br>                        <span class="hljs-keyword">break</span>;<br>                &#125;<br>                first = next;<br>            &#125;<br>        &#125; <br><br>        <span class="hljs-comment">// å°†ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹(å¦‚æœå­˜åœ¨)ä»è¯¥æ¡ä»¶çš„ç­‰å¾…é˜Ÿåˆ—ç§»è‡³æ‹¥æœ‰é”çš„ç­‰å¾…é˜Ÿåˆ—</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">signal</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> firstWaiter;<br>            <span class="hljs-keyword">if</span> (!isHeldExclusively())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();<br>            <span class="hljs-keyword">if</span> (first != <span class="hljs-literal">null</span>)<br>                doSignal(first, <span class="hljs-literal">false</span>);<br>        &#125; <br><br>        <span class="hljs-comment">// å°†æ‰€æœ‰çº¿ç¨‹ä»è¯¥æ¡ä»¶çš„ç­‰å¾…é˜Ÿåˆ—ç§»è‡³æ‰€å±é”çš„ç­‰å¾…é˜Ÿåˆ—ã€‚</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">signalAll</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> firstWaiter;<br>            <span class="hljs-keyword">if</span> (!isHeldExclusively())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();<br>            <span class="hljs-keyword">if</span> (first != <span class="hljs-literal">null</span>)<br>                doSignal(first, <span class="hljs-literal">true</span>);<br>        &#125; <br><br>        <span class="hljs-comment">// ç­‰å¾… æ–¹æ³•</span><br><br>        <span class="hljs-comment">// æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹åˆ°æ¡ä»¶åˆ—è¡¨å¹¶é‡Šæ”¾é”</span><br>        <span class="hljs-comment">// æŒæœ‰é”æ‰èƒ½awaitï¼ˆåœ¨ç­‰å¾…ä¹‹åé‡æ–°acquire savedStateï¼‰</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">enableWait</span><span class="hljs-params">(ConditionNode node)</span> &#123;<br>            <span class="hljs-keyword">if</span> (isHeldExclusively()) &#123;<br>                node.waiter = Thread.currentThread();<br>                node.setStatusRelaxed(COND | WAITING);<br>                <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> lastWaiter;<br>                <span class="hljs-keyword">if</span> (last == <span class="hljs-literal">null</span>)<br>                    firstWaiter = node;<br>                <span class="hljs-keyword">else</span><br>                    last.nextWaiter = node;<br>                lastWaiter = node;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">savedState</span> <span class="hljs-operator">=</span> getState();<br>                <span class="hljs-keyword">if</span> (release(savedState))<br>                    <span class="hljs-keyword">return</span> savedState;<br>            &#125;<br>            node.status = CANCELLED; <span class="hljs-comment">// lock not held or inconsistent</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();<br>        &#125; <br><br>        <span class="hljs-comment">// å¦‚æœæœ€åˆæ”¾åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ç°åœ¨å‡†å¤‡å¥½é‡æ–°è·å–åŒæ­¥é˜Ÿåˆ—ï¼Œåˆ™è¿”å›trueã€‚</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">canReacquire</span><span class="hljs-params">(ConditionNode node)</span> &#123;<br>            <span class="hljs-comment">// check links, not status to avoid enqueue race</span><br>            Node p; <span class="hljs-comment">// traverse unless known to be bidirectionally linked</span><br>            <span class="hljs-keyword">return</span> node != <span class="hljs-literal">null</span> &amp;&amp; (p = node.prev) != <span class="hljs-literal">null</span> &amp;&amp;<br>                (p.next == node || isEnqueued(node));<br>        &#125; <br><br>        <span class="hljs-comment">// ä»æ¡ä»¶é˜Ÿåˆ—ä¸­å–æ¶ˆç»™å®šèŠ‚ç‚¹å’Œå…¶ä»–éç­‰å¾…èŠ‚ç‚¹çš„é“¾æ¥ï¼Œé™¤éå·²ç»å–æ¶ˆé“¾æ¥ã€‚</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlinkCancelledWaiters</span><span class="hljs-params">(ConditionNode node)</span> &#123;<br>            <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span> || node.nextWaiter != <span class="hljs-literal">null</span> || node == lastWaiter) &#123;<br>                <span class="hljs-comment">// trail ä¿å­˜wçš„å‰é©±</span><br>                <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> firstWaiter, trail = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">while</span> (w != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> w.nextWaiter;<br>                    <span class="hljs-keyword">if</span> ((w.status &amp; COND) == <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-comment">// å°†wä»é˜Ÿåˆ—ä¸­æ¸…é™¤</span><br>                        w.nextWaiter = <span class="hljs-literal">null</span>;<br>                        <span class="hljs-keyword">if</span> (trail == <span class="hljs-literal">null</span>)<br>                            firstWaiter = next;<br>                        <span class="hljs-keyword">else</span><br>                            trail.nextWaiter = next;<br>                        <span class="hljs-comment">// wæœªé˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªèŠ‚ç‚¹</span><br>                        <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">null</span>)<br>                            lastWaiter = trail;<br>                    &#125; <span class="hljs-keyword">else</span><br>                        trail = w;<br>                    w = next;<br>                &#125;<br>            &#125;<br>        &#125; <br><br>        <span class="hljs-comment">// å®ç°éæ‰“æ–­æ¡ä»¶ç­‰å¾…</span><br>        <span class="hljs-comment">// 1.ä¿å­˜getStateè¿”å›çš„é”å®šçŠ¶æ€ã€‚</span><br>        <span class="hljs-comment">// 2.ä»¥ä¿å­˜çš„çŠ¶æ€ä½œä¸ºå‚æ•°è°ƒç”¨releaseï¼Œå¦‚æœå¤±è´¥åˆ™æŠ›å‡º IllegalMonitorStateException</span><br>        <span class="hljs-comment">// 3.é˜»å¡ï¼Œç›´åˆ°è¢«å”¤é†’</span><br>        <span class="hljs-comment">// 4.é€šè¿‡è°ƒç”¨acquireçš„ä¸“ç”¨ç‰ˆæœ¬é‡æ–°è·å–ï¼Œå¹¶å°†ä¿å­˜çš„çŠ¶æ€ä½œä¸ºå‚æ•°ã€‚</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">awaitUninterruptibly</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionNode</span>();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">savedState</span> <span class="hljs-operator">=</span> enableWait(node);<br>            LockSupport.setCurrentBlocker(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// for back-compatibility</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>, rejected = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">while</span> (!canReacquire(node)) &#123;<br>                <span class="hljs-keyword">if</span> (Thread.interrupted())<br>                    interrupted = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((node.status &amp; COND) != <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-keyword">if</span> (rejected)<br>                            node.block();<br>                        <span class="hljs-keyword">else</span><br>                            ForkJoinPool.managedBlock(node);<br>                    &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException ex) &#123;<br>                        rejected = <span class="hljs-literal">true</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException ie) &#123;<br>                        interrupted = <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span><br>                    Thread.onSpinWait();    <span class="hljs-comment">// awoke while enqueuing</span><br>            &#125;<br>            LockSupport.setCurrentBlocker(<span class="hljs-literal">null</span>);<br>            node.clearStatus();<br>            acquire(node, savedState, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);<br>            <span class="hljs-keyword">if</span> (interrupted)<br>                Thread.currentThread().interrupt();<br>        &#125; <br><br>        <span class="hljs-comment">// å®ç°å¯ä¸­æ–­æ¡ä»¶ç­‰å¾…ã€‚</span><br>        <span class="hljs-comment">// 1.å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼ŒæŠ›å‡ºInterruptedExceptionã€‚</span><br>        <span class="hljs-comment">// 2.ä¿å­˜getStateè¿”å›çš„é”å®šçŠ¶æ€ã€‚</span><br>        <span class="hljs-comment">// 3.ä»¥ä¿å­˜çš„çŠ¶æ€ä½œä¸ºå‚æ•°è°ƒç”¨releaseï¼Œå¦‚æœå¤±è´¥åˆ™æŠ›å‡ºIllegalMonitorStateExceptionã€‚</span><br>        <span class="hljs-comment">// 4.é˜»å¡ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–è¢«ä¸­æ–­ã€‚</span><br>        <span class="hljs-comment">// 5.é€šè¿‡è°ƒç”¨acquireçš„ä¸“ç”¨ç‰ˆæœ¬é‡æ–°è·å–ï¼Œå¹¶å°†ä¿å­˜çš„çŠ¶æ€ä½œä¸ºå‚æ•°ã€‚</span><br>        <span class="hljs-comment">// 6.å¦‚æœåœ¨æ­¥éª¤4ä¸­è¢«é˜»å¡è€Œä¸­æ–­ï¼ŒæŠ›å‡ºInterruptedException</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">await</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            <span class="hljs-keyword">if</span> (Thread.interrupted())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>            <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionNode</span>();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">savedState</span> <span class="hljs-operator">=</span> enableWait(node);<br>            LockSupport.setCurrentBlocker(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// for back-compatibility</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>, cancelled = <span class="hljs-literal">false</span>, rejected = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">while</span> (!canReacquire(node)) &#123;<br>                <span class="hljs-keyword">if</span> (interrupted |= Thread.interrupted()) &#123;<br>                    <span class="hljs-keyword">if</span> (cancelled = (node.getAndUnsetStatus(COND) &amp; COND) != <span class="hljs-number">0</span>)<br>                        <span class="hljs-keyword">break</span>;              <span class="hljs-comment">// else interrupted after signal</span><br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((node.status &amp; COND) != <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-keyword">if</span> (rejected)<br>                            node.block();<br>                        <span class="hljs-keyword">else</span><br>                            ForkJoinPool.managedBlock(node);<br>                    &#125; <span class="hljs-keyword">catch</span> (RejectedExecutionException ex) &#123;<br>                        rejected = <span class="hljs-literal">true</span>;<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException ie) &#123;<br>                        interrupted = <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span><br>                    Thread.onSpinWait();    <span class="hljs-comment">// awoke while enqueuing</span><br>            &#125;<br>            LockSupport.setCurrentBlocker(<span class="hljs-literal">null</span>);<br>            node.clearStatus();<br>            acquire(node, savedState, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);<br>            <span class="hljs-keyword">if</span> (interrupted) &#123;<br>                <span class="hljs-keyword">if</span> (cancelled) &#123;<br>                    unlinkCancelledWaiters(node);<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>                &#125;<br>                Thread.currentThread().interrupt();<br>            &#125;<br>        &#125; <br><br>        <span class="hljs-comment">// å¸¦è¶…æ—¶çš„await</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-title function_">awaitNanos</span><span class="hljs-params">(<span class="hljs-type">long</span> nanosTimeout)</span><br>                <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            <span class="hljs-keyword">if</span> (Thread.interrupted())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>            <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionNode</span>();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">savedState</span> <span class="hljs-operator">=</span> enableWait(node);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">nanos</span> <span class="hljs-operator">=</span> (nanosTimeout &lt; <span class="hljs-number">0L</span>) ? <span class="hljs-number">0L</span> : nanosTimeout;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">deadline</span> <span class="hljs-operator">=</span> System.nanoTime() + nanos;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">cancelled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>, interrupted = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">while</span> (!canReacquire(node)) &#123;<br>                <span class="hljs-keyword">if</span> ((interrupted |= Thread.interrupted()) ||<br>                    (nanos = deadline - System.nanoTime()) &lt;= <span class="hljs-number">0L</span>) &#123;<br>                    <span class="hljs-keyword">if</span> (cancelled = (node.getAndUnsetStatus(COND) &amp; COND) != <span class="hljs-number">0</span>)<br>                        <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">else</span><br>                    LockSupport.parkNanos(<span class="hljs-built_in">this</span>, nanos);<br>            &#125;<br>            node.clearStatus();<br>            acquire(node, savedState, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);<br>            <span class="hljs-keyword">if</span> (cancelled) &#123;<br>                unlinkCancelledWaiters(node);<br>                <span class="hljs-keyword">if</span> (interrupted)<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interrupted)<br>                Thread.currentThread().interrupt();<br>            <span class="hljs-type">long</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> deadline - System.nanoTime(); <span class="hljs-comment">// avoid overflow</span><br>            <span class="hljs-keyword">return</span> (remaining &lt;= nanosTimeout) ? remaining : Long.MIN_VALUE;<br>        &#125; <br><br>        <span class="hljs-comment">// ç»å¯¹å®šæ—¶çš„æ¡ä»¶ç­‰å¾…</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">awaitUntil</span><span class="hljs-params">(Date deadline)</span><br>                <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">abstime</span> <span class="hljs-operator">=</span> deadline.getTime();<br>            <span class="hljs-keyword">if</span> (Thread.interrupted())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>            <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionNode</span>();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">savedState</span> <span class="hljs-operator">=</span> enableWait(node);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">cancelled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>, interrupted = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">while</span> (!canReacquire(node)) &#123;<br>                <span class="hljs-keyword">if</span> ((interrupted |= Thread.interrupted()) ||<br>                    System.currentTimeMillis() &gt;= abstime) &#123;<br>                    <span class="hljs-keyword">if</span> (cancelled = (node.getAndUnsetStatus(COND) &amp; COND) != <span class="hljs-number">0</span>)<br>                        <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">else</span><br>                    LockSupport.parkUntil(<span class="hljs-built_in">this</span>, abstime);<br>            &#125;<br>            node.clearStatus();<br>            acquire(node, savedState, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);<br>            <span class="hljs-keyword">if</span> (cancelled) &#123;<br>                unlinkCancelledWaiters(node);<br>                <span class="hljs-keyword">if</span> (interrupted)<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interrupted)<br>                Thread.currentThread().interrupt();<br>            <span class="hljs-keyword">return</span> !cancelled;<br>        &#125; <br><br>        <span class="hljs-comment">// è‡ªå®šä¹‰æ—¶é—´æ ¼å¼çš„await</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">await</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span><br>                <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">nanosTimeout</span> <span class="hljs-operator">=</span> unit.toNanos(time);<br>            <span class="hljs-keyword">if</span> (Thread.interrupted())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>            <span class="hljs-type">ConditionNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionNode</span>();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">savedState</span> <span class="hljs-operator">=</span> enableWait(node);<br>            <span class="hljs-type">long</span> <span class="hljs-variable">nanos</span> <span class="hljs-operator">=</span> (nanosTimeout &lt; <span class="hljs-number">0L</span>) ? <span class="hljs-number">0L</span> : nanosTimeout;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">deadline</span> <span class="hljs-operator">=</span> System.nanoTime() + nanos;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">cancelled</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>, interrupted = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">while</span> (!canReacquire(node)) &#123;<br>                <span class="hljs-keyword">if</span> ((interrupted |= Thread.interrupted()) ||<br>                    (nanos = deadline - System.nanoTime()) &lt;= <span class="hljs-number">0L</span>) &#123;<br>                    <span class="hljs-keyword">if</span> (cancelled = (node.getAndUnsetStatus(COND) &amp; COND) != <span class="hljs-number">0</span>)<br>                        <span class="hljs-keyword">break</span>;<br>                &#125; <span class="hljs-keyword">else</span><br>                    LockSupport.parkNanos(<span class="hljs-built_in">this</span>, nanos);<br>            &#125;<br>            node.clearStatus();<br>            acquire(node, savedState, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">0L</span>);<br>            <span class="hljs-keyword">if</span> (cancelled) &#123;<br>                unlinkCancelledWaiters(node);<br>                <span class="hljs-keyword">if</span> (interrupted)<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interrupted)<br>                Thread.currentThread().interrupt();<br>            <span class="hljs-keyword">return</span> !cancelled;<br>        &#125; <br><br>        <span class="hljs-comment">// å¯è§‚å¯Ÿæ€§æ”¯æŒ</span><br><br>        <span class="hljs-comment">// å¦‚æœæ­¤æ¡ä»¶æ˜¯ç”±ç»™å®šçš„åŒæ­¥å¯¹è±¡åˆ›å»ºçš„ï¼Œåˆ™è¿”å›trueã€‚</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOwnedBy</span><span class="hljs-params">(AbstractQueuedSynchronizer sync)</span> &#123;<br>            <span class="hljs-keyword">return</span> sync == AbstractQueuedSynchronizer.<span class="hljs-built_in">this</span>;<br>        &#125; <br><br>        <span class="hljs-comment">// æŸ¥è¯¢æ˜¯å¦æœ‰ä»»ä½•çº¿ç¨‹æ­£åœ¨ç­‰å¾…è¯¥æ¡ä»¶</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasWaiters</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span> (!isHeldExclusively())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">ConditionNode</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> firstWaiter; w != <span class="hljs-literal">null</span>; w = w.nextWaiter) &#123;<br>                <span class="hljs-keyword">if</span> ((w.status &amp; COND) != <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <br><br>        <span class="hljs-comment">// è¿”å›åœ¨è¿™ä¸ªconditionä¸‹ç­‰å¾…çš„çº¿ç¨‹æ•°çš„ä¼°è®¡å€¼</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getWaitQueueLength</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span> (!isHeldExclusively())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">ConditionNode</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> firstWaiter; w != <span class="hljs-literal">null</span>; w = w.nextWaiter) &#123;<br>                <span class="hljs-keyword">if</span> ((w.status &amp; COND) != <span class="hljs-number">0</span>)<br>                    ++n;<br>            &#125;<br>            <span class="hljs-keyword">return</span> n;<br>        &#125; <br><br>        <span class="hljs-comment">// è¿”å›ä¸€ä¸ªé›†åˆï¼Œå…¶ä¸­åŒ…å«å¯èƒ½æ­£åœ¨ç­‰å¾…æ­¤æ¡ä»¶çš„é‚£äº›çº¿ç¨‹ã€‚</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Collection&lt;Thread&gt; <span class="hljs-title function_">getWaitingThreads</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">if</span> (!isHeldExclusively())<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();<br>            ArrayList&lt;Thread&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">ConditionNode</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> firstWaiter; w != <span class="hljs-literal">null</span>; w = w.nextWaiter) &#123;<br>                <span class="hljs-keyword">if</span> ((w.status &amp; COND) != <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> w.waiter;<br>                    <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>)<br>                        list.add(t);<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> list;<br>        &#125;<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><code>acquire(Node node, int arg, boolean shared, boolean interruptible, boolean timed, long time)</code>ï¼šnodeå¯¹åº”çš„çº¿ç¨‹è·å–é”ï¼Œå³æ’ä»–åœ°ä¿®æ”¹AbstractQueuedSynchronizer çš„çŠ¶æ€ï¼ˆstateï¼‰ã€‚åªæœ‰CLHé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…è¿˜æœªå…¥é˜Ÿçš„èŠ‚ç‚¹æœ‰ç«äº‰é”çš„èµ„æ ¼ï¼Œå¦åˆ™åœ¨é˜Ÿåˆ—ä¸­é˜»å¡</p><p><code>tryAcquire(int arg) å’Œ tryRelease(int arg)</code> æœ¬è´¨ä¸Šéƒ½æ˜¯ä¿®æ”¹AbstractQueuedSynchronizer çš„çŠ¶æ€</p><p><code>acquire(int arg)</code>ï¼šåœ¨ä¸Šé¢çš„acquireä¹‹å‰å…ˆ tryAcquire ä¸€æ¬¡</p><p><code>release(int arg)</code>ï¼štryRelease æˆåŠŸåå”¤é†’é˜Ÿåˆ—ä¸­é˜»å¡çš„èŠ‚ç‚¹</p><p><code>await()</code>ï¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹è°ƒç”¨signalæˆ–signalAllåå¯¹åº”çš„èŠ‚ç‚¹è¿›å…¥CLHé˜Ÿåˆ—ï¼Œæœ€åæ‰§è¡Œacquireé€»è¾‘è·å–é”ï¼ˆè¿˜è¦å’Œå…¶ä»–èŠ‚ç‚¹ç«äº‰ï¼Œå“­ï¼‰ã€‚</p><blockquote><p>æ³¨æ„ï¼š</p><ol><li><p>awaitæ—¶ä¼šå…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰é”ï¼Œemmmï¼Œè¿™å¾ˆç¬¦åˆé€»è¾‘</p></li><li><p>å…¶ä»–awaitæ–¹æ³•é€»è¾‘ç±»ä¼¼</p></li></ol></blockquote><p><code>signal() å’Œ signalAll()</code>ï¼šå°†ç¬¬ä¸€ä¸ªï¼ˆæ‰€æœ‰ï¼‰ç¬¦åˆæ¡ä»¶çš„ConditionNodeæ’å…¥åˆ°CLHé˜Ÿåˆ—å°¾éƒ¨</p><p>æ ¹æ®ä¸Šé¢çš„åˆ†æçŸ¥ç»§æ‰¿äº†AbstractQueuedSynchronizerçš„ç±»é€šè¿‡ä¸åŒçš„ä¿®æ”¹stateçš„ç­–ç•¥æ¥è¾¾åˆ°ä¸åŒçš„æ•ˆæœ</p>]]></content>
    
    
    <categories>
      
      <category>æºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JUC</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>3-cache.md</title>
    <link href="/2023/05/20/mybatis-source-code/3-cache/"/>
    <url>/2023/05/20/mybatis-source-code/3-cache/</url>
    
    <content type="html"><![CDATA[<p>Â Â Â Â è¿™ä¸ªæ¨¡å—ä¸»è¦è‡ªå®šä¹‰äº†ç¼“å­˜æ¥å£å’Œæä¾›äº†æ¡†æ¶è‡ªå¸¦çš„ç¼“å­˜å®ç°</p><h4 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h4><p>é¦–å…ˆæ˜¯ç¼“å­˜æ¥å£</p><p>å°†å®˜æ–¹æ³¨é‡Šç¿»è¯‘ä¸€ä¸‹ï¼š</p><p>Â Â Â Â è¿™ä¸ªæ¥å£æ˜¯ç¼“å­˜æä¾›è€…çš„SPIï¼ˆäº†è§£java SPIæœºåˆ¶å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« â€“<a href="https://cloud.tencent.com/developer/article/1785056">Java SPI (Service Provider Interface) æœºåˆ¶è¯¦è§£-è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)</a>ï¼‰ã€‚</p><p>Â Â Â Â æ¯ä¸ªå‘½åç©ºé—´éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç¼“å­˜å®ä¾‹ã€‚</p><p>Â Â Â Â ç¼“å­˜çš„å®ç°å¿…é¡»æœ‰ä¸€ä¸ªæ¥æ”¶ä¸€ä¸ªStringå‹ç¼“å­˜idçš„æ„é€ å‡½æ•°ï¼ŒMybatiså°†æŠŠåç§°ç©ºé—´ä½œä¸ºidä¼ ç»™æ„é€ å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Cache</span> &#123;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> The identifier of this cache</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// å–å¾—ID</span><br>  String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key Can be any object but usually it is a &#123;<span class="hljs-doctag">@link</span> CacheKey&#125;</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> value The result of a select.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// å­˜å…¥å€¼</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key The key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> The object stored in the cache.</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// è·å–å€¼</span><br>  Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Optional. It is not called by the core.</span><br><span class="hljs-comment">   * </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> key The key</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> The object that was removed</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// åˆ é™¤å€¼</span><br>  Object <span class="hljs-title function_">removeObject</span><span class="hljs-params">(Object key)</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Clears this cache instance</span><br><span class="hljs-comment">   */</span>  <br>  <span class="hljs-comment">// æ¸…ç©º</span><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * Optional. This method is not called by the core.</span><br><span class="hljs-comment">   * </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> The number of elements stored in the cache (not its capacity).</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// å–å¾—å¤§å°</span><br>  <span class="hljs-type">int</span> <span class="hljs-title function_">getSize</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-comment">/** </span><br><span class="hljs-comment">   * Optional. As of 3.2.6 this method is no longer called by the core.</span><br><span class="hljs-comment">   *  </span><br><span class="hljs-comment">   * Any locking needed by the cache must be provided internally by the cache provider.</span><br><span class="hljs-comment">   * </span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> A ReadWriteLock </span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-comment">// å–å¾—è¯»å†™é”, ä»3.2.6å¼€å§‹æ²¡ç”¨äº†ï¼Œè¦SPIè‡ªå·±å®ç°é”</span><br>  ReadWriteLock <span class="hljs-title function_">getReadWriteLock</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="CacheKey"><a href="#CacheKey" class="headerlink" title="CacheKey"></a>CacheKey</h4><p>Â Â Â Â ç¼“å­˜keyã€‚ä¸€èˆ¬ç¼“å­˜æ¡†æ¶åŸºæœ¬ä¸Šéƒ½æ˜¯ä»¥key-valueçš„ç»“æ„è¿›è¡Œå­˜å‚¨ï¼ŒMybatis å¯¹äºå…¶Keyçš„ç”Ÿæˆé‡‡å–çš„è§„åˆ™ä¸ºï¼š[mappedStementId + offset + limit + SQL + queryParams + environment]ç”Ÿæˆä¸€ä¸ªå“ˆå¸Œç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheKey</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cloneable</span>, Serializable &#123;<br>  <span class="hljs-comment">// update å’Œ updateAllæ–¹æ³•æ— æ•ˆçš„ CacheKeyï¼ˆè¿™ä¸ªå±æ€§æ²¡æœ‰ç”¨åˆ°ï¼‰</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">NULL_CACHE_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullCacheKey</span>();<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEFAULT_MULTIPLYER</span> <span class="hljs-operator">=</span> <span class="hljs-number">37</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">DEFAULT_HASHCODE</span> <span class="hljs-operator">=</span> <span class="hljs-number">17</span>;<br><br>  <span class="hljs-comment">// å›ºå®šçš„ä¹˜æ•°</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> multiplier;<br>  <span class="hljs-comment">// hashç </span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> hashcode;<br>  <span class="hljs-comment">// æ ¡éªŒå’Œ -- è®¡ç®—æ–¹å¼ä¸ºæ‰€æœ‰ç¼“å­˜å¯¹è±¡çš„hashç ç›¸åŠ </span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> checksum;<br>  <span class="hljs-comment">// ç¼“å­˜å¯¹è±¡è®¡æ•°</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> count;<br>  <span class="hljs-comment">// å­˜å‚¨æ‰€æœ‰ç¼“å­˜å¯¹è±¡ç”¨äºequalsåˆ¤æ–­</span><br>  <span class="hljs-keyword">private</span> List&lt;Object&gt; updateList;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheKey</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>.hashcode = DEFAULT_HASHCODE;<br>    <span class="hljs-built_in">this</span>.multiplier = DEFAULT_MULTIPLYER;<br>    <span class="hljs-built_in">this</span>.count = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">this</span>.updateList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br>  &#125;<br><br>  <span class="hljs-comment">// ä¼ å…¥ä¸€ä¸ªObjectæ•°ç»„ï¼Œæ›´æ–°hashcodeå’Œæ•ˆéªŒç </span><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheKey</span><span class="hljs-params">(Object[] objects)</span> &#123;<br>    <span class="hljs-built_in">this</span>();<br>    updateAll(objects);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUpdateCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> updateList.size();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Object object)</span> &#123;<br>    <span class="hljs-keyword">if</span> (object != <span class="hljs-literal">null</span> &amp;&amp; object.getClass().isArray()) &#123;<br>      <span class="hljs-comment">// å¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™å¾ªç¯è°ƒç”¨doUpdate</span><br>      <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> Array.getLength(object);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">element</span> <span class="hljs-operator">=</span> Array.get(object, i);<br>        doUpdate(element);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å¦åˆ™ï¼ŒdoUpdate</span><br>      doUpdate(object);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doUpdate</span><span class="hljs-params">(Object object)</span> &#123;<br>    <span class="hljs-comment">// è®¡ç®—hashå€¼ï¼Œæ ¡éªŒç </span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">baseHashCode</span> <span class="hljs-operator">=</span> object == <span class="hljs-literal">null</span> ? <span class="hljs-number">1</span> : object.hashCode();<br><br>    count++;<br>    checksum += baseHashCode;<br>    baseHashCode *= count;<br><br>    hashcode = multiplier * hashcode + baseHashCode;<br><br>    <span class="hljs-comment">// åŒæ—¶å°†å¯¹è±¡åŠ å…¥åˆ—è¡¨ï¼Œè¿™æ ·ä¸‡ä¸€ä¸¤ä¸ªCacheKeyçš„hashç ç¢°å·§ä¸€æ ·ï¼Œå†æ ¹æ®å¯¹è±¡ä¸¥æ ¼equalsæ¥åŒºåˆ†</span><br>    updateList.add(object);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateAll</span><span class="hljs-params">(Object[] objects)</span> &#123;<br>    <span class="hljs-keyword">for</span> (Object o : objects) &#123;<br>      update(o);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object object)</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == object) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!(object <span class="hljs-keyword">instanceof</span> CacheKey)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">CacheKey</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> (CacheKey) object;<br><br>    <span class="hljs-comment">// å…ˆæ¯”hashcodeï¼Œchecksumï¼Œcountï¼Œç†è®ºä¸Šå¯ä»¥å¿«é€Ÿæ¯”å‡ºæ¥</span><br>    <span class="hljs-keyword">if</span> (hashcode != cacheKey.hashcode) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (checksum != cacheKey.checksum) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (count != cacheKey.count) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// ä¸‡ä¸€ä¸¤ä¸ªCacheKeyçš„hashç ç¢°å·§ä¸€æ ·ï¼Œå†æ ¹æ®å¯¹è±¡ä¸¥æ ¼equalsæ¥åŒºåˆ†</span><br>    <span class="hljs-comment">// è¿™é‡Œä¸¤ä¸ªlistçš„sizeæ²¡æ¯”æ˜¯å¦ç›¸ç­‰ï¼Œå…¶å®å‰é¢countç›¸ç­‰å°±å·²ç»ä¿è¯äº†</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; updateList.size(); i++) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">thisObject</span> <span class="hljs-operator">=</span> updateList.get(i);<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">thatObject</span> <span class="hljs-operator">=</span> cacheKey.updateList.get(i);<br>      <span class="hljs-keyword">if</span> (thisObject == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">if</span> (thatObject != <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">if</span> (!thisObject.equals(thatObject)) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <br><br>  <span class="hljs-comment">// æ ¼å¼ä¸ºï¼šhashcode:checkSum:[object.toString]</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">returnValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>().append(hashcode).append(<span class="hljs-string">&#x27;:&#x27;</span>).append(checksum);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; updateList.size(); i++) &#123;<br>      returnValue.append(<span class="hljs-string">&#x27;:&#x27;</span>).append(updateList.get(i));<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> returnValue.toString();<br>  &#125; <br><br>  <span class="hljs-comment">// æ·±æ‹·è´CacheKey</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> CacheKey <span class="hljs-title function_">clone</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CloneNotSupportedException &#123;<br>    <span class="hljs-type">CacheKey</span> <span class="hljs-variable">clonedCacheKey</span> <span class="hljs-operator">=</span> (CacheKey) <span class="hljs-built_in">super</span>.clone();<br>    clonedCacheKey.updateList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;(updateList);<br>    <span class="hljs-keyword">return</span> clonedCacheKey;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="NullCacheKey"><a href="#NullCacheKey" class="headerlink" title="NullCacheKey"></a>NullCacheKey</h4><p>ä¸èƒ½æ·»åŠ ç¼“å­˜ï¼Œå› æ­¤å«NullCacheKey</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NullCacheKey</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CacheKey</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">3704229911977019465L</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">NullCacheKey</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// åªæœ‰hashå€¼å’Œæ ¡éªŒç ä¸ºkey?</span><br>    <span class="hljs-built_in">super</span>();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Object object)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Not allowed to update a NullCacheKey instance.&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateAll</span><span class="hljs-params">(Object[] objects)</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Not allowed to update a NullCacheKey instance.&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PerpetualCache"><a href="#PerpetualCache" class="headerlink" title="PerpetualCache"></a>PerpetualCache</h4><p>Â Â Â Â æ°¸ä¹…ç¼“å­˜ï¼Œæ²¡æœ‰ç¼“å­˜è¿‡æœŸå’Œæ¸…é™¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerpetualCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> &#123;<br>  <span class="hljs-comment">// æ¯ä¸ªæ°¸ä¹…ç¼“å­˜æœ‰ä¸€ä¸ªIDæ¥è¯†åˆ«</span><br>  <span class="hljs-keyword">private</span> String id; <br><br>  <span class="hljs-comment">// å†…éƒ¨å°±æ˜¯ä¸€ä¸ªHashMap,æ‰€æœ‰æ–¹æ³•åŸºæœ¬å°±æ˜¯ç›´æ¥è°ƒç”¨HashMapçš„æ–¹æ³•,ä¸æ”¯æŒå¤šçº¿ç¨‹ï¼Ÿ</span><br>  <span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Object, Object&gt;();<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">PerpetualCache</span><span class="hljs-params">(String id)</span> &#123;<br>    <span class="hljs-built_in">this</span>.id = id;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>    <span class="hljs-comment">// åªæœ‰idç›¸ç­‰æ‰è®¤ä¸ºä¸¤ä¸ªcacheç›¸åŒ</span><br>    <span class="hljs-keyword">if</span> (getId() == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Cache instances require an ID.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == o) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!(o <span class="hljs-keyword">instanceof</span> Cache)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-type">Cache</span> <span class="hljs-variable">otherCache</span> <span class="hljs-operator">=</span> (Cache) o;<br>    <span class="hljs-keyword">return</span> getId().equals(otherCache.getId());<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (getId() == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Cache instances require an ID.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> getId().hashCode();<br>  &#125; <br><br>  <span class="hljs-comment">// å…¶ä»–è¦å®ç°çš„éƒ½ä¾èµ–äºhashmap</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BlockingCache"><a href="#BlockingCache" class="headerlink" title="BlockingCache"></a>BlockingCache</h4><p>Â Â Â Â ç®€å•çš„é˜»å¡è£…é¥°å™¨</p><p>Â Â Â Â EhCacheâ€™s BlockingCache decoratorçš„ç®€å•ä½æ•ˆç‰ˆæœ¬</p><p>Â Â Â Â å½“åœ¨ç¼“å­˜ä¸­æ‰¾ä¸åˆ°è¿™ä¸ªå…ƒç´ æ—¶ï¼Œç»™cache keyä¸Šä¸ªé”ã€‚è¿™æ ·ï¼Œå…¶ä»–è·å–è¯¥cache keyçš„çº¿ç¨‹å°†ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°è¿™ä¸ªå…ƒç´ è¢«å¡«å……è€Œä¸æ˜¯å‘½ä¸­æ•°æ®åº“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlockingCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> &#123;<br><br>  <span class="hljs-comment">// è·å–é”çš„è¶…æ—¶æ—¶é—´</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> timeout;<br>  <span class="hljs-comment">// å§”æ‰˜çš„Cacheå¯¹è±¡</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;<br>  <span class="hljs-comment">// å¯é‡å…¥é”mapï¼ˆå¹¶å‘å¯ç”¨ï¼‰</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Object, ReentrantLock&gt; locks;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">BlockingCache</span><span class="hljs-params">(Cache delegate)</span> &#123;<br>    <span class="hljs-built_in">this</span>.delegate = delegate;<br>    <span class="hljs-built_in">this</span>.locks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;Object, ReentrantLock&gt;();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      delegate.putObject(key, value);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-comment">// é‡Šæ”¾é”ï¼ˆåªæœ‰å½“å‰çº¿ç¨‹æŒæœ‰é”æ—¶æ‰èƒ½é‡Šæ”¾ï¼‰</span><br>      releaseLock(key);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseLock</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> locks.get(key);<br>    <span class="hljs-comment">// é˜²æ­¢ç ´å getObjectæ—¶åŠ çš„é” ï¼Ÿ</span><br>    <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) &#123;<br>      lock.unlock();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    acquireLock(key);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> delegate.getObject(key);<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¿™é‡Œvalue ä¸º null çš„è¯é”ä¼šä¸€ç›´ä¸é‡Šæ”¾</span><br><span class="hljs-comment">     * é‚£ä¹ˆå½“å‰çº¿ç¨‹ putObject æˆ–è€… é”€æ¯æ—¶é‡Šæ”¾é”ï¼Ÿ</span><br><span class="hljs-comment">     * å¼€å‘è€…å…³äºè¿™ä¸ªé—®é¢˜çš„ç–‘é—®è§ issue #1410</span><br><span class="hljs-comment">     * æœ‰äººå‘ç°è¿™æ ·å®ç°å¯èƒ½ä¼šå¯¼è‡´æ­»é”ï¼Œè¯¦è§ issue #1261,#1357</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * æˆ‘å»çœ‹äº†ä¸‹æœ€æ–°çš„ä»£ç ï¼Œå®˜æ–¹å·²ç»å°† ReentrantLock æ¢ä¸ºäº† </span><br><span class="hljs-comment">     * CountDownLatch,issueä¸Šè¯´çš„æ˜¯ä¸ºäº†é¿å…oomï¼ˆhttps://stackoverflow.com/questions/41898355/lock-handler-for-arbitrary-keys/41912651#41912651ï¼‰</span><br><span class="hljs-comment">     * è¿˜æœ‰å®˜æ–¹åŠ äº†ä¸€è¡Œæ–°çš„æ³¨é‡Š </span><br><span class="hljs-comment">     * By its nature, this implementation can cause deadlock when used incorrectly.</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>      releaseLock(key);<br>    &#125;        <br>    <span class="hljs-keyword">return</span> value;<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireLock</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> getLockForKey(key);<br>    <span class="hljs-keyword">if</span> (timeout &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> lock.tryLock(timeout, TimeUnit.MILLISECONDS);<br>        <span class="hljs-keyword">if</span> (!acquired) &#123;<br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Couldn&#x27;t get a lock in &quot;</span> + timeout + <span class="hljs-string">&quot; for the key &quot;</span> +  key + <span class="hljs-string">&quot; at the cache &quot;</span> + delegate.getId());  <br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Got interrupted while trying to acquire lock for key &quot;</span> + key, e);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      lock.lock();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> ReentrantLock <span class="hljs-title function_">getLockForKey</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br>    <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">previous</span> <span class="hljs-operator">=</span> locks.putIfAbsent(key, lock);<br>    <span class="hljs-keyword">return</span> previous == <span class="hljs-literal">null</span> ? lock : previous;<br>  &#125; <br><br>  <span class="hljs-comment">// å…¶ä»–æ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢é™„ä¸Šä¼šå¯¼è‡´æ­»é”çš„æµ‹è¯•ä»£ç ï¼ˆMybatisç‰ˆæœ¬ä¸ºæœ¬åšæ–‡æ¶‰åŠçš„ç‰ˆæœ¬ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BolckingCacheTest</span> &#123;<br><br>    <span class="hljs-meta">@Test(timeout = 3000L)</span><br>    <span class="hljs-comment">// ä½¿ç”¨ CountDownLatch çš„æœ€æ–°ä»£ç ä¹Ÿä¼šå‘ç”Ÿæ­»é”</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">BlockingCache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockingCache</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PerpetualCache</span>(<span class="hljs-string">&quot;default&quot;</span>));<br><br>        <span class="hljs-comment">// lock twice</span><br>        cache.getObject(<span class="hljs-number">1</span>);<br>        cache.getObject(<span class="hljs-number">1</span>);<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; Assert.assertEquals(cache.getObject(<span class="hljs-number">1</span>), <span class="hljs-number">1</span>));<br>        thread.setDaemon(<span class="hljs-literal">false</span>);<br>        thread.start();<br><br>        <span class="hljs-comment">// but release once</span><br>        cache.putObject(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br><br>        thread.join();<br>    &#125;<br><br>    <span class="hljs-meta">@Test(timeout = 3000L)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getObject2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">BlockingCache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockingCache</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PerpetualCache</span>(<span class="hljs-string">&quot;default&quot;</span>));<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; Assert.assertEquals(cache.getObject(<span class="hljs-number">1</span>), <span class="hljs-number">1</span>));<br>        thread.setDaemon(<span class="hljs-literal">false</span>);<br>        thread.start();<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br><br>        <span class="hljs-comment">// but release once</span><br>        cache.putObject(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br><br>        <span class="hljs-comment">// lock twice</span><br>        cache.getObject(<span class="hljs-number">1</span>);<br>        cache.getObject(<span class="hljs-number">1</span>);<br><br>        thread.join();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="FifoCache"><a href="#FifoCache" class="headerlink" title="FifoCache"></a>FifoCache</h4><p>FIFOç¼“å­˜ï¼Œè¿™ä¸ªç±»å°±æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªFIFIé“¾è¡¨ï¼Œå…¶ä»–æ¥å£éƒ½å§”æ‰˜ç»™åŒ…è£…çš„cacheå»åšã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FifoCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;<br>  <span class="hljs-comment">// FIFI é“¾è¡¨</span><br>  <span class="hljs-keyword">private</span> Deque&lt;Object&gt; keyList;<br>  <span class="hljs-comment">// é“¾è¡¨é•¿åº¦(é»˜è®¤ä¸º1024)</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">FifoCache</span><span class="hljs-params">(Cache delegate)</span> &#123;<br>    <span class="hljs-built_in">this</span>.delegate = delegate;<br>    <span class="hljs-built_in">this</span>.keyList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;Object&gt;();<br>    <span class="hljs-built_in">this</span>.size = <span class="hljs-number">1024</span>;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>    cycleKeyList(key);<br>    delegate.putObject(key, value);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cycleKeyList</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// å¢åŠ è®°å½•æ—¶åˆ¤æ–­å¦‚æœè®°å½•å·²è¶…è¿‡1024æ¡ï¼Œä¼šç§»é™¤é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä»è€Œè¾¾åˆ°FIFOç¼“å­˜æ•ˆæœ</span><br>    keyList.addLast(key);<br>    <span class="hljs-keyword">if</span> (keyList.size() &gt; size) &#123;<br>      <span class="hljs-type">Object</span> <span class="hljs-variable">oldestKey</span> <span class="hljs-operator">=</span> keyList.removeFirst();<br>      delegate.removeObject(oldestKey);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å…¶ä»–æ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="LoggingCache"><a href="#LoggingCache" class="headerlink" title="LoggingCache"></a>LoggingCache</h4><p>Â Â Â Â åŠ äº†æ—¥å¿—çš„ç¼“å­˜ï¼Œæ—¥å¿—ä¸»è¦æ˜¯å–ç¼“å­˜æ˜¯æ‰“å°å‘½ä¸­ç‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> &#123;<br><br>  <span class="hljs-comment">// ç”¨çš„mybatisè‡ªå·±çš„æŠ½è±¡Log</span><br>  <span class="hljs-keyword">private</span> Log log;  <br>  <span class="hljs-keyword">private</span> Cache delegate;<br>  <span class="hljs-comment">// è¯·æ±‚æ¬¡æ•°</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">requests</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-comment">// å‘½ä¸­ç¼“å­˜æ¬¡æ•°</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-variable">hits</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">LoggingCache</span><span class="hljs-params">(Cache delegate)</span> &#123;<br>    <span class="hljs-built_in">this</span>.delegate = delegate;<br>    <span class="hljs-built_in">this</span>.log = LogFactory.getLog(getId());<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// è®¿é—®ä¸€æ¬¡requestsåŠ ä¸€</span><br>    requests++;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> delegate.getObject(key);<br>    <span class="hljs-comment">//å‘½ä¸­äº†åˆ™hitsåŠ ä¸€</span><br>    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) &#123;<br>      hits++;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>      <span class="hljs-comment">// å°±æ˜¯æ‰“å°å‘½ä¸­ç‡ hits/requests</span><br>      log.debug(<span class="hljs-string">&quot;Cache Hit Ratio [&quot;</span> + getId() + <span class="hljs-string">&quot;]: &quot;</span> + getHitRatio());<br>    &#125;<br>    <span class="hljs-keyword">return</span> value;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getHitRatio</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) hits / (<span class="hljs-type">double</span>) requests;<br>  &#125; <br><br>  <span class="hljs-comment">// å…¶ä»–æ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="LruCache"><a href="#LruCache" class="headerlink" title="LruCache"></a>LruCache</h4><p>Â Â Â Â æœ€è¿‘æœ€å°‘ä½¿ç”¨ç¼“å­˜ã€‚åŸºäº LinkedHashMapï¼Œè¦†ç›–å…¶removeEldestEntryæ–¹æ³•å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LruCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;<br>  <span class="hljs-comment">// é¢å¤–ç”¨äº†ä¸€ä¸ªmapæ‰åšlruï¼Œä½†æ˜¯å§”æ‰˜çš„Cacheé‡Œé¢å…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªmapï¼Œè¿™æ ·ç­‰äºç”¨2å€çš„å†…å­˜å®ç°lruåŠŸèƒ½</span><br>  <span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; keyMap;<br>  <span class="hljs-keyword">private</span> Object eldestKey; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">LruCache</span><span class="hljs-params">(Cache delegate)</span> &#123;<br>    <span class="hljs-built_in">this</span>.delegate = delegate;<br>    setSize(<span class="hljs-number">1024</span>);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSize</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> size)</span> &#123;<br>    keyMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;Object, Object&gt;(size, <span class="hljs-number">.75F</span>, <span class="hljs-literal">true</span>) &#123;<br>      <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">4267176411845948333L</span>;<br><br>      <span class="hljs-comment">// æ ¸å¿ƒå°±æ˜¯è¦†ç›– LinkedHashMap.removeEldestEntryæ–¹æ³•,</span><br>      <span class="hljs-comment">// è¿”å›trueæˆ–falseå‘Šè¯‰ LinkedHashMapè¦ä¸è¦åˆ é™¤æ­¤æœ€è€é”®å€¼</span><br>      <span class="hljs-comment">// LinkedHashMapå†…éƒ¨å…¶å®å°±æ˜¯æ¯æ¬¡è®¿é—®æˆ–è€…æ’å…¥ä¸€ä¸ªå…ƒç´ éƒ½ä¼šæŠŠå…ƒç´ æ”¾åˆ°é“¾è¡¨æœ«å°¾ï¼Œ</span><br>      <span class="hljs-comment">// è¿™æ ·ä¸ç»å¸¸è®¿é—®çš„é”®å€¼è‚¯å®šå°±åœ¨é“¾è¡¨å¼€å¤´å•¦</span><br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeEldestEntry</span><span class="hljs-params">(Map.Entry&lt;Object, Object&gt; eldest)</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">tooBig</span> <span class="hljs-operator">=</span> size() &gt; size;<br>        <span class="hljs-keyword">if</span> (tooBig) &#123;<br>          <span class="hljs-comment">// è¿™é‡Œæ²¡è¾™äº†ï¼ŒæŠŠeldestKeyå­˜å…¥å®ä¾‹å˜é‡</span><br>          eldestKey = eldest.getKey();<br>        &#125;<br>        <span class="hljs-keyword">return</span> tooBig;<br>      &#125;<br>    &#125;;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>    delegate.putObject(key, value);<br>    <span class="hljs-comment">// å¢åŠ æ–°çºªå½•åï¼Œåˆ¤æ–­æ˜¯å¦è¦å°†æœ€è€å…ƒç´ ç§»é™¤</span><br>    cycleKeyList(key);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// getçš„æ—¶å€™è°ƒç”¨ä¸€ä¸‹LinkedHashMap.getï¼Œè®©æœ€è¿‘è®¿é—®çš„å€¼ç§»åŠ¨åˆ°é“¾è¡¨æœ«å°¾</span><br>    keyMap.get(key); <span class="hljs-comment">//touch</span><br>    <span class="hljs-keyword">return</span> delegate.getObject(key);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">removeObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// ä¸ºå•¥ä¸ remove</span><br>    <span class="hljs-comment">// keyMap.remove(key);</span><br>    <span class="hljs-comment">// key ä¸ä¼šå†è¢«è®¿é—®ï¼Œä¸‹æ¬¡æ¸…é™¤ç¼“å­˜ä¹‹å‰å¦‚æœkeyæœªè¢«æ”¾å…¥ç¼“å­˜å°±ä¼šè¢«åˆ é™¤</span><br>    <span class="hljs-keyword">return</span> delegate.removeObject(key);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span>  <span class="hljs-title function_">cycleKeyList</span><span class="hljs-params">(Object key)</span> &#123;<br>    keyMap.put(key, key);<br>    <span class="hljs-comment">// keyMapæ˜¯linkedhashmapï¼Œæœ€è€çš„è®°å½•å·²ç»è¢«ç§»é™¤äº†ï¼Œç„¶åè¿™é‡Œæˆ‘ä»¬è¿˜éœ€è¦ç§»é™¤è¢«å§”æ‰˜çš„é‚£ä¸ªcacheçš„è®°å½•</span><br>    <span class="hljs-keyword">if</span> (eldestKey != <span class="hljs-literal">null</span>) &#123;<br>      delegate.removeObject(eldestKey);<br>      eldestKey = <span class="hljs-literal">null</span>;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å…¶ä»–æ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ScheduledCache"><a href="#ScheduledCache" class="headerlink" title="ScheduledCache"></a>ScheduledCache</h4><p>Â Â Â Â å®šæ—¶è°ƒåº¦ç¼“å­˜ã€‚ç›®çš„æ˜¯å®šæ—¶æ¸…ç©ºä¸€ä¸‹ç¼“å­˜</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduledCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Cache delegate;<br>  <span class="hljs-comment">// æ¸…ç†é—´éš”</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> clearInterval;<br>  <span class="hljs-comment">// ä¸Šæ¬¡æ¸…ç†æ—¶é—´</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span> lastClear;    <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScheduledCache</span><span class="hljs-params">(Cache delegate)</span> &#123;<br>    <span class="hljs-built_in">this</span>.delegate = delegate;<br>    <span class="hljs-comment">// é»˜è®¤ 1å°æ—¶æ¸…ç©ºä¸€æ¬¡ç¼“å­˜</span><br>    <span class="hljs-built_in">this</span>.clearInterval = <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>; <span class="hljs-comment">// 1 hour</span><br>    <span class="hljs-built_in">this</span>.lastClear = System.currentTimeMillis();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSize</span><span class="hljs-params">()</span> &#123;<br>    clearWhenStale();<br>    <span class="hljs-keyword">return</span> delegate.getSize();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object object)</span> &#123;<br>    clearWhenStale();<br>    delegate.putObject(key, object);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-keyword">return</span> clearWhenStale() ? <span class="hljs-literal">null</span> : delegate.getObject(key);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">clearWhenStale</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// å¦‚æœåˆ°æ—¶é—´äº†ï¼Œæ¸…ç©ºä¸€ä¸‹ç¼“å­˜</span><br>    <span class="hljs-keyword">if</span> (System.currentTimeMillis() - lastClear &gt; clearInterval) &#123;<br>      clear();<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> &#123;<br>    lastClear = System.currentTimeMillis();<br>    delegate.clear();<br>  &#125; <br><br>  <span class="hljs-comment">// å…¶ä»–æ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SerializedCache"><a href="#SerializedCache" class="headerlink" title="SerializedCache"></a>SerializedCache</h4><p>Â Â Â Â åºåˆ—åŒ–ç¼“å­˜ã€‚åŸç†æ˜¯å…ˆå°†å¯¹è±¡åºåˆ—åŒ–æˆ2è¿›åˆ¶ï¼Œå†ç¼“å­˜ã€‚å¥½å¤„æ˜¯å°†å¯¹è±¡å‹ç¼©äº†ï¼Œçœå†…å­˜ã€åå¤„æ˜¯é€Ÿåº¦æ…¢äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializedCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> &#123;<br>  <span class="hljs-keyword">private</span> Cache delegate; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object object)</span> &#123;<br>    <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">null</span> || object <span class="hljs-keyword">instanceof</span> Serializable) &#123;<br>      <span class="hljs-comment">// å…ˆåºåˆ—åŒ–ï¼Œå†å§”æ‰˜è¢«åŒ…è£…è€…putObject</span><br>      delegate.putObject(key, serialize((Serializable) object));<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;SharedCache failed to make a copy of a non-serializable object: &quot;</span> + object);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// å…ˆå§”æ‰˜è¢«åŒ…è£…è€…getObject,å†ååºåˆ—åŒ–</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> delegate.getObject(key);<br>    <span class="hljs-keyword">return</span> object == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : deserialize((<span class="hljs-type">byte</span>[]) object);<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] serialize(Serializable value) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// åºåˆ—åŒ–æ ¸å¿ƒå°±æ˜¯ByteArrayOutputStream</span><br>      <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>      <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bos);<br>      oos.writeObject(value);<br>      oos.flush();<br>      oos.close();<br>      <span class="hljs-keyword">return</span> bos.toByteArray();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Error serializing object.  Cause: &quot;</span> + e, e);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> Serializable <span class="hljs-title function_">deserialize</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] value)</span> &#123;<br>    Serializable result;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// ååºåˆ—åŒ–æ ¸å¿ƒå°±æ˜¯ByteArrayInputStream</span><br>      <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(value);<br>      <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomObjectInputStream</span>(bis);<br>      result = (Serializable) ois.readObject();<br>      ois.close();<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheException</span>(<span class="hljs-string">&quot;Error deserializing object.  Cause: &quot;</span> + e, e);<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomObjectInputStream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ObjectInputStream</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomObjectInputStream</span><span class="hljs-params">(InputStream in)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>      <span class="hljs-built_in">super</span>(in);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-comment">// ä½¿ç”¨è‡ªå®šä¹‰çš„èµ„æºåŠ è½½æ–¹æ³• ï¼Ÿ</span><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>      <span class="hljs-keyword">return</span> Resources.classForName(desc.getName());<br>    &#125;<br>    <br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SoftCache"><a href="#SoftCache" class="headerlink" title="SoftCache"></a>SoftCache</h4><p>Â Â Â Â è½¯å¼•ç”¨ç¼“å­˜,æ ¸å¿ƒæ˜¯SoftReference</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SoftCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> &#123;<br><br>  <span class="hljs-comment">// é“¾è¡¨ç”¨æ¥å¼•ç”¨å…ƒç´ ï¼Œé˜²åƒåœ¾å›æ”¶</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;Object&gt; hardLinksToAvoidGarbageCollection;<br><br>  <span class="hljs-comment">// è¢«åƒåœ¾å›æ”¶çš„å¼•ç”¨é˜Ÿåˆ—</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReferenceQueue&lt;Object&gt; queueOfGarbageCollectedEntries;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache delegate;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> numberOfHardLinks; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">SoftCache</span><span class="hljs-params">(Cache delegate)</span> &#123;<br>    <span class="hljs-built_in">this</span>.delegate = delegate;<br>    <span class="hljs-comment">// é»˜è®¤é“¾è¡¨å¯ä»¥å­˜256å…ƒç´ </span><br>    <span class="hljs-built_in">this</span>.numberOfHardLinks = <span class="hljs-number">256</span>;<br>    <span class="hljs-built_in">this</span>.hardLinksToAvoidGarbageCollection = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;Object&gt;();<br>    <span class="hljs-built_in">this</span>.queueOfGarbageCollectedEntries = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>&lt;Object&gt;();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSize</span><span class="hljs-params">()</span> &#123;<br>    removeGarbageCollectedItems();<br>    <span class="hljs-keyword">return</span> delegate.getSize();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeGarbageCollectedItems</span><span class="hljs-params">()</span> &#123;<br>    SoftEntry sv;<br>    <span class="hljs-comment">// æŸ¥çœ‹è¢«åƒåœ¾å›æ”¶çš„å…ƒç´ ç»„æˆçš„å¼•ç”¨é˜Ÿåˆ—,ç„¶åè°ƒç”¨removeObjectç§»é™¤ä»–ä»¬</span><br>    <span class="hljs-keyword">while</span> ((sv = (SoftEntry) queueOfGarbageCollectedEntries.poll()) != <span class="hljs-literal">null</span>) &#123;<br>      delegate.removeObject(sv.key);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object value)</span> &#123;<br>    removeGarbageCollectedItems();<br>    <span class="hljs-comment">// putObjectå­˜äº†ä¸€ä¸ªSoftReferenceï¼Œè¿™æ ·valueæ²¡ç”¨æ—¶ä¼šè‡ªåŠ¨åƒåœ¾å›æ”¶</span><br>    delegate.putObject(key, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftEntry</span>(key, value, queueOfGarbageCollectedEntries));<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span>  <br>    <span class="hljs-comment">// assumed delegate cache is totally managed by this cache</span><br>    SoftReference&lt;Object&gt; softReference = (SoftReference&lt;Object&gt;) delegate.getObject(key);<br>    <span class="hljs-keyword">if</span> (softReference != <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// æ ¸å¿ƒè°ƒç”¨SoftReference.getå–å¾—å…ƒç´ </span><br>      result = softReference.get();<br>      <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) &#123;<br>        delegate.removeObject(key);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// See #586 (and #335) modifications need more than a read lock </span><br>        <span class="hljs-keyword">synchronized</span> (hardLinksToAvoidGarbageCollection) &#123;<br>          <span class="hljs-comment">// å°†valueå­˜å…¥ç»å¸¸è®¿é—®çš„é”®å€¼åˆ°é“¾è¡¨(æœ€å¤š256å…ƒç´ ),é˜²æ­¢åƒåœ¾å›æ”¶</span><br>          hardLinksToAvoidGarbageCollection.addFirst(result);<br>          <span class="hljs-keyword">if</span> (hardLinksToAvoidGarbageCollection.size() &gt; numberOfHardLinks) &#123;<br>            hardLinksToAvoidGarbageCollection.removeLast();<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">removeObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    removeGarbageCollectedItems();<br>    <span class="hljs-keyword">return</span> delegate.removeObject(key);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (hardLinksToAvoidGarbageCollection) &#123;<br>      hardLinksToAvoidGarbageCollection.clear();<br>    &#125;<br>    removeGarbageCollectedItems();<br>    delegate.clear();<br>  &#125; <br><br>  <span class="hljs-comment">// è¿™é‡Œè®¾ä¸ºstaticï¼Œå‰é¢åˆæœ‰newï¼Œä¸å¤ªæ‡‚</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SoftEntry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SoftReference</span>&lt;Object&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object key;<br><br>    SoftEntry(Object key, Object value, ReferenceQueue&lt;Object&gt; garbageCollectionQueue) &#123;<br>      <span class="hljs-built_in">super</span>(value, garbageCollectionQueue);<br>      <span class="hljs-built_in">this</span>.key = key;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å…¶ä»–æ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="SynchronizedCache"><a href="#SynchronizedCache" class="headerlink" title="SynchronizedCache"></a>SynchronizedCache</h4><p>Â Â Â Â åŒæ­¥ç¼“å­˜ã€‚é˜²æ­¢å¤šçº¿ç¨‹é—®é¢˜</p><p>Â Â Â Â æ ¸å¿ƒ: åŠ é”ã€‚</p><p>Â Â Â Â ReadWriteLock.readLock().lock()&#x2F;unlock()</p><p>Â Â Â Â ReadWriteLock.writeLock().lock()&#x2F;unlock()</p><p>Â Â Â Â 3.2.6ä»¥åè¿™ä¸ªç±»å·²ç»æ²¡ç”¨äº†ï¼Œè€ƒè™‘åˆ°Hazelcast, EhCacheå·²ç»æœ‰é”æœºåˆ¶äº†ï¼Œæ‰€ä»¥è¿™ä¸ªé”å°±ç”»è›‡æ·»è¶³äº†ã€‚</p><p>Â Â Â Â bugè§<a href="https://github.com/mybatis/mybatis-3/issues/159">https://github.com/mybatis/mybatis-3/issues/159</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> &#123;<br><br>  <span class="hljs-comment">// å°±æ˜¯åœ¨ä¸€äº›å¯èƒ½ä¼šå‡ºç°å¹¶å‘å¼‚å¸¸çš„æ¥å£ä¸ŠåŠ äº†ä¸ª synchronized</span><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSize</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.getSize();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object object)</span> &#123;<br>    delegate.putObject(key, object);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.getObject(key);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Object <span class="hljs-title function_">removeObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-keyword">return</span> delegate.removeObject(key);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> &#123;<br>    delegate.clear();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="TransactionalCache"><a href="#TransactionalCache" class="headerlink" title="TransactionalCache"></a>TransactionalCache</h4><p>Â Â Â Â äºŒçº§ç¼“å­˜äº‹åŠ¡ç¼“å†²åŒº</p><p>Â Â Â Â æ­¤ç±»ä¿å­˜ä¼šè¯æœŸé—´è¦æ·»åŠ åˆ°äºŒçº§ç¼“å­˜çš„æ‰€æœ‰ç¼“å­˜æ¡ç›®</p><p>Â Â Â Â å½“è°ƒç”¨commitæ—¶ï¼Œæ¡ç›®è¢«å‘é€åˆ°ç¼“å­˜ï¼Œå¦‚æœä¼šè¯å›æ»šï¼Œåˆ™æ¡ç›®è¢«ä¸¢å¼ƒ</p><p>Â Â Â Â æ·»åŠ äº†é˜»å¡ç¼“å­˜æ”¯æŒã€‚å› æ­¤ï¼Œä»»ä½•è¿”å›ç¼“å­˜æœªå‘½ä¸­çš„get()åé¢éƒ½ä¼šè·Ÿä¸€ä¸ªput()ï¼Œè¿™æ ·å°±å¯ä»¥é‡Šæ”¾ä»»ä½•ä¸è¯¥é”®ç›¸å…³è”çš„é”ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionalCache</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span> &#123;<br><br>  <span class="hljs-keyword">private</span> Cache delegate;<br>  <span class="hljs-comment">// commitå‰æ˜¯å¦æ‰§è¡Œè¿‡ clear</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> clearOnCommit;<br>  <span class="hljs-comment">// commitæ—¶è¦æ·»åŠ çš„å…ƒç´ </span><br>  <span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; entriesToAddOnCommit;<br>  <span class="hljs-keyword">private</span> Set&lt;Object&gt; entriesMissedInCache; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">TransactionalCache</span><span class="hljs-params">(Cache delegate)</span> &#123;<br>    <span class="hljs-built_in">this</span>.delegate = delegate;<br>    <span class="hljs-built_in">this</span>.clearOnCommit = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">this</span>.entriesToAddOnCommit = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Object, Object&gt;();<br>    <span class="hljs-built_in">this</span>.entriesMissedInCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Object&gt;();<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-comment">// issue #116</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">object</span> <span class="hljs-operator">=</span> delegate.getObject(key);<br>    <span class="hljs-keyword">if</span> (object == <span class="hljs-literal">null</span>) &#123;<br>      entriesMissedInCache.add(key);<br>    &#125;<br>    <span class="hljs-comment">// issue #146</span><br>    <span class="hljs-keyword">if</span> (clearOnCommit) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> object;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Object key, Object object)</span> &#123;<br>    entriesToAddOnCommit.put(key, object);<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">removeObject</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125; <br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> &#123;<br>    clearOnCommit = <span class="hljs-literal">true</span>;<br>    entriesToAddOnCommit.clear();<br>  &#125; <br><br>  <span class="hljs-comment">// å¤šäº†commitæ–¹æ³•ï¼Œæä¾›äº‹åŠ¡åŠŸèƒ½</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (clearOnCommit) &#123;<br>      delegate.clear();<br>    &#125;<br>    flushPendingEntries();<br>    reset();<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span> &#123;<br>    unlockMissedEntries();<br>    reset();<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reset</span><span class="hljs-params">()</span> &#123;<br>    clearOnCommit = <span class="hljs-literal">false</span>;<br>    entriesToAddOnCommit.clear();<br>    entriesMissedInCache.clear();<br>  &#125; <br><br>  <span class="hljs-comment">// å°† entriesToAddOnCommit å’Œ entriesMissedInCacheä¸­çš„å…ƒç´ å…¨éƒ¨æ”¾è¿›cache</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flushPendingEntries</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : entriesToAddOnCommit.entrySet()) &#123;<br>      delegate.putObject(entry.getKey(), entry.getValue());<br>    &#125;<br>    <span class="hljs-keyword">for</span> (Object entry : entriesMissedInCache) &#123;<br>      <span class="hljs-keyword">if</span> (!entriesToAddOnCommit.containsKey(entry)) &#123;<br>        delegate.putObject(entry, <span class="hljs-literal">null</span>);<br>      &#125;<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// è§£é”ç»™ç©ºå€¼ç¼“å­˜ä¸Šçš„é”</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlockMissedEntries</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (Object entry : entriesMissedInCache) &#123;<br>      delegate.putObject(entry, <span class="hljs-literal">null</span>);<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å…¶ä»–æ–¹æ³•ç•¥</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="WeakCache"><a href="#WeakCache" class="headerlink" title="WeakCache"></a>WeakCache</h4><p>Â Â Â Â å’Œè½¯å¼•ç”¨ç¼“å­˜ç±»ä¼¼Â ã€‚åŒºåˆ«æ˜¯æ“ä½œè¦ä¿å­˜çš„å…ƒç´ é›†åˆ <code>hardLinksToAvoidGarbageCollection</code> æ²¡æœ‰ä¸Šé”ï¼ˆå°è¯•æ‰¾issueå¤±è´¥ï¼‰</p><p>æ·¦ (<a href="http://code.google.com/p/mybatis/issues/detail?id=335%7C586">http://code.google.com/p/mybatis/issues/detail?id=335|586</a>) issueä¼¼ä¹æ²¡äº†</p><h4 id="TransactionalCacheManager"><a href="#TransactionalCacheManager" class="headerlink" title="TransactionalCacheManager"></a>TransactionalCacheManager</h4><p>Â Â Â Â äº‹åŠ¡ç¼“å­˜ç®¡ç†å™¨ï¼Œè¢«CachingExecutorä½¿ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionalCacheManager</span> &#123;<br><br>  <span class="hljs-comment">// ç®¡ç†äº†è®¸å¤šTransactionalCache</span><br>  <span class="hljs-keyword">private</span> Map&lt;Cache, TransactionalCache&gt; transactionalCaches = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Cache, TransactionalCache&gt;();<br> <br>  <span class="hljs-comment">// æ¸…ç†ç¼“å­˜</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">(Cache cache)</span> &#123;<br>    getTransactionalCache(cache).clear();<br>  &#125;<br><br>  <span class="hljs-comment">// å¾—åˆ°æŸä¸ªTransactionalCacheçš„ç¼“å­˜å€¼</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(Cache cache, CacheKey key)</span> &#123;<br>    <span class="hljs-keyword">return</span> getTransactionalCache(cache).getObject(key);<br>  &#125; <br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putObject</span><span class="hljs-params">(Cache cache, CacheKey key, Object value)</span> &#123;<br>    getTransactionalCache(cache).putObject(key, value);<br>  &#125; <br><br>  <span class="hljs-comment">// æäº¤æ—¶å…¨éƒ¨æäº¤</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (TransactionalCache txCache : transactionalCaches.values()) &#123;<br>      txCache.commit();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-comment">// å›æ»šæ—¶å…¨éƒ¨å›æ»š</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">for</span> (TransactionalCache txCache : transactionalCaches.values()) &#123;<br>      txCache.rollback();<br>    &#125;<br>  &#125; <br><br>  <span class="hljs-keyword">private</span> TransactionalCache <span class="hljs-title function_">getTransactionalCache</span><span class="hljs-params">(Cache cache)</span> &#123;<br>    <span class="hljs-type">TransactionalCache</span> <span class="hljs-variable">txCache</span> <span class="hljs-operator">=</span> transactionalCaches.get(cache);<br>    <span class="hljs-keyword">if</span> (txCache == <span class="hljs-literal">null</span>) &#123;<br>      txCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionalCache</span>(cache);<br>      transactionalCaches.put(cache, txCache);<br>    &#125;<br>    <span class="hljs-keyword">return</span> txCache;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç¼“å­˜æ¨¡å—çš„å†…å®¹å°±è¿™äº›</p>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2-exceptions.md</title>
    <link href="/2023/05/20/mybatis-source-code/2-exceptions/"/>
    <url>/2023/05/20/mybatis-source-code/2-exceptions/</url>
    
    <content type="html"><![CDATA[<p>è¿™ä¸ªæ¨¡å—åªæœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * å¼‚å¸¸å·¥å‚</span><br><span class="hljs-comment"> */</span> <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionFactory</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">ExceptionFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Prevent Instantiation</span><br>  &#125;<br><br>  <span class="hljs-comment">// æŠŠæ™®é€šå¼‚å¸¸åŒ…è£…æˆmybatisè‡ªå·±çš„PersistenceException</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RuntimeException <span class="hljs-title function_">wrapException</span><span class="hljs-params">(String message, Exception e)</span> &#123;<br>    <span class="hljs-comment">// æŸ¥æ‰¾é”™è¯¯ä¸Šä¸‹æ–‡ï¼Œå¾—åˆ°é”™è¯¯åŸå› ï¼Œä¼ ç»™PersistenceException</span><br>    <span class="hljs-comment">// æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªErrorContextï¼Œæ‰€ä»¥å¯ä»¥å¾—åˆ°ï¼Œ  .message(message).causeæ˜¯å…¸å‹çš„æ„å»ºå™¨æ¨¡å¼</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PersistenceException</span>(ErrorContext.instance().message(message).cause(e).toString(), e);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>1-logging</title>
    <link href="/2023/05/14/mybatis-source-code/1-logging/"/>
    <url>/2023/05/14/mybatis-source-code/1-logging/</url>
    
    <content type="html"><![CDATA[<h3 id="loggingï¼ˆæ—¥å¿—æ¨¡å—ï¼‰"><a href="#loggingï¼ˆæ—¥å¿—æ¨¡å—ï¼‰" class="headerlink" title="loggingï¼ˆæ—¥å¿—æ¨¡å—ï¼‰"></a>loggingï¼ˆæ—¥å¿—æ¨¡å—ï¼‰</h3><h4 id="LogException"><a href="#LogException" class="headerlink" title="LogException"></a>LogException</h4><p>é¦–å…ˆçœ‹ LogException ç±»ï¼ˆå…¶ä¸­ PersistenceException ä¸ºè‡ªå®šä¹‰å¼‚å¸¸ï¼Œå°è£…æ–¹æ³•å®Œå…¨ä¸€è‡´ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PersistenceException</span> &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1022924004852350942L</span>;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">LogException</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">super</span>();<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">LogException</span><span class="hljs-params">(String message)</span> &#123;<br>    <span class="hljs-built_in">super</span>(message);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">LogException</span><span class="hljs-params">(String message, Throwable cause)</span> &#123;<br>    <span class="hljs-built_in">super</span>(message, cause);<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">LogException</span><span class="hljs-params">(Throwable cause)</span> &#123;<br>    <span class="hljs-built_in">super</span>(cause);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h4><p>ç„¶åæ˜¯è‡ªå®šä¹‰æ—¥å¿—æ¥å£ Log</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Log</span> &#123;<br><br>  <span class="hljs-comment">// å’Œä¸€èˆ¬çš„log4jå¾ˆåƒï¼Œæä¾›æ—¥å¿—æ¥å£çš„ä¸€äº›æ–¹æ³•,error, debug, warnã€‚</span><br>  <span class="hljs-comment">// ç”¨è‡ªå·±çš„æ—¥å¿—ç±»ææ€•æ˜¯ä¸ºäº†é€šç”¨ï¼Œä¸ç»‘æ­»åœ¨æŸä¸ªç‰¹å®šçš„æ—¥å¿—æ¡†æ¶ä¸­</span><br>  <span class="hljs-comment">// ä½†ä¸æ˜¯ä¹Ÿæœ‰ç±»ä¼¼çš„slf4jå—ï¼Ÿä¸ºä½•è¿˜è¦è‡ªå·±å†™ï¼Ÿ</span><br>  <span class="hljs-comment">// å¯èƒ½æ˜¯ä¸æƒ³å¼•å…¥é¢å¤–çš„jaråŒ…ï¼ˆæˆ‘è§‰å¾—æ˜¯ä¸ºäº†é€‚é…å„ç§æ—¥å¿—æ¡†æ¶ï¼‰</span><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDebugEnabled</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTraceEnabled</span><span class="hljs-params">()</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String s, Throwable e)</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String s)</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">(String s)</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">trace</span><span class="hljs-params">(String s)</span>;<br><br>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">warn</span><span class="hljs-params">(String s)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="LogFactory-æ—¥å¿—å·¥å‚"><a href="#LogFactory-æ—¥å¿—å·¥å‚" class="headerlink" title="LogFactory æ—¥å¿—å·¥å‚"></a>LogFactory æ—¥å¿—å·¥å‚</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Marker to be used by logging implementations that support markers</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">// ç»™æ”¯æŒmarkeråŠŸèƒ½çš„loggerä½¿ç”¨(ç›®å‰æœ‰slf4j, log4j2)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MARKER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MYBATIS&quot;</span>;<br><br><span class="hljs-comment">// å…·ä½“ç©¶ç«Ÿç”¨å“ªä¸ªæ—¥å¿—æ¡†æ¶ï¼Œé‚£ä¸ªæ¡†æ¶æ‰€å¯¹åº”loggerçš„æ„é€ å‡½æ•°</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Constructor&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Log</span>&gt; logConstructor;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> &#123;<br>    <span class="hljs-comment">// è¿™é‡Œå•çº¯ç”¨çš„lambdaè¡¨è¾¾å¼ï¼Œæ²¡æœ‰å¤šçº¿ç¨‹</span><br>    <span class="hljs-comment">// è¿™æ®µä»£ç æ˜¯ä¸€ç›´æ‰¾å¯ç”¨çš„æ—¥å¿—å®ç°ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„</span><br>    <span class="hljs-comment">// æ—¥å¿—å®ç°ï¼Œæ‰¾åˆ°åè·³è¿‡åé¢çš„æŸ¥æ‰¾</span><br>    <span class="hljs-comment">// slf4j</span><br>    tryImplementation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        useSlf4jLogging();<br>      &#125;<br>    &#125;);<br>    <span class="hljs-comment">// common logging</span><br>    tryImplementation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        useCommonsLogging();<br>      &#125;<br>    &#125;);<br>    <span class="hljs-comment">// log4j2</span><br>    tryImplementation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        useLog4J2Logging();<br>      &#125;<br>    &#125;);<br>    <span class="hljs-comment">// log4j</span><br>    tryImplementation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        useLog4JLogging();<br>      &#125;<br>    &#125;);<br>    <span class="hljs-comment">// jdk logging</span><br>    tryImplementation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        useJdkLogging();<br>      &#125;<br>    &#125;);<br>    <span class="hljs-comment">// æ²¡æœ‰æ—¥å¿—</span><br>    tryImplementation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>      <span class="hljs-meta">@Override</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        useNoLogging();<br>      &#125;<br>    &#125;);<br>  &#125;<br></code></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹ <code>tryImplementation </code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tryImplementation</span><span class="hljs-params">(Runnable runnable)</span> &#123;<br>    <span class="hljs-comment">// å…ˆåˆ¤æ–­æ˜¯å¦æ‰¾åˆ°å¯ç”¨çš„æ—¥å¿—å®ç°</span><br>    <span class="hljs-keyword">if</span> (logConstructor == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        runnable.run();<br>      &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>        <span class="hljs-comment">// ignore</span><br>      &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>ä¸‹é¢ä»¥ <code>useSlf4jLogging()</code> ä¸ºä¾‹è®²è§£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">useSlf4jLogging</span><span class="hljs-params">()</span> &#123;<br>    setImplementation(org.apache.ibatis.logging.slf4j.Slf4jImpl.class);<br>  &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setImplementation</span><span class="hljs-params">(Class&lt;? extends Log&gt; implClass)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      Constructor&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Log</span>&gt; candidate = implClass.getConstructor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;);<br>      <span class="hljs-type">Log</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> candidate.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; LogFactory.class.getName() &#125;);<br>      log.debug(<span class="hljs-string">&quot;Logging initialized using &#x27;&quot;</span> + implClass + <span class="hljs-string">&quot;&#x27; adapter.&quot;</span>);<br>      <span class="hljs-comment">// è®¾ç½®logConstructor,ä¸€æ—¦è®¾ä¸Šï¼Œè¡¨æ˜æ‰¾åˆ°ç›¸åº”çš„logçš„jaråŒ…äº†ï¼Œé‚£åé¢åˆ«çš„logå°±ä¸æ‰¾äº†ã€‚</span><br>      logConstructor = candidate;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogException</span>(<span class="hljs-string">&quot;Error setting Log implementation.  Cause: &quot;</span> + t, t);<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>åé¢ <code>useCommonsLogging()ã€useLog4J2Logging()ã€useLog4JLogging()ã€useJdkLogging()ã€useNoLogging()</code> ç±»ä¼¼</p><p>æœ€åæ˜¯å‰©ä¸‹çš„ä¸€äº›æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// å•ä¾‹æ¨¡å¼ï¼Œä¸å¾—è‡ªå·±newå®ä¾‹</span><br><span class="hljs-keyword">private</span> <span class="hljs-title function_">LogFactory</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-comment">// disable construction</span><br>&#125;<br><br><span class="hljs-comment">// æ ¹æ®ä¼ å…¥çš„ç±»æ¥æ„å»ºLog</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Log <span class="hljs-title function_">getLog</span><span class="hljs-params">(Class&lt;?&gt; aClass)</span> &#123;<br>  <span class="hljs-keyword">return</span> getLog(aClass.getName());<br>&#125;<br><br><span class="hljs-comment">// æ ¹æ®ä¼ å…¥çš„ç±»åæ¥æ„å»ºLog</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Log <span class="hljs-title function_">getLog</span><span class="hljs-params">(String logger)</span> &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">//æ„é€ å‡½æ•°ï¼Œå‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªï¼Œä¸ºStringå‹ï¼ŒæŒ‡æ˜loggerçš„åç§°</span><br>    <span class="hljs-keyword">return</span> logConstructor.newInstance(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; logger &#125;);<br>  &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogException</span>(<span class="hljs-string">&quot;Error creating logger for logger &quot;</span> + logger + <span class="hljs-string">&quot;.  Cause: &quot;</span> + t, t);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æä¾›ä¸€ä¸ªæ‰©å±•åŠŸèƒ½ï¼Œå¦‚æœä»¥ä¸Šlogéƒ½ä¸æ»¡æ„ï¼Œå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„log</span><br><span class="hljs-comment">// è¿™ä¸ªæ–¹æ³•åœ¨ Configuration ç±»çš„ setLogImpl(Class&lt;?&gt; logImpl) æ–¹æ³•ä½¿ç”¨</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">useCustomLogging</span><span class="hljs-params">(Class&lt;? extends Log&gt; clazz)</span> &#123;<br>  setImplementation(clazz);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="JakartaCommonsLoggingImpl"><a href="#JakartaCommonsLoggingImpl" class="headerlink" title="JakartaCommonsLoggingImpl"></a>JakartaCommonsLoggingImpl</h4><p>é€‚é… <code>commons logging</code> é‡Œçš„ Log å’Œ LogFactory</p><p>å¯ä»¥çœ‹åˆ°å…¨æ˜¯å§”æ‰˜ç»™ç‰¹å®šçš„ log å’Œ LogFactoryæ¥å®ç°</p><p>è¿™é‡Œä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JakartaCommonsLoggingImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">org</span>.apache.ibatis.logging.Log &#123;<br><br>  <span class="hljs-keyword">private</span> Log log;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">JakartaCommonsLoggingImpl</span><span class="hljs-params">(String clazz)</span> &#123;<br>    log = LogFactory.getLog(clazz);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDebugEnabled</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> log.isDebugEnabled();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTraceEnabled</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> log.isTraceEnabled();<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String s, Throwable e)</span> &#123;<br>    log.error(s, e);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">error</span><span class="hljs-params">(String s)</span> &#123;<br>    log.error(s);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">(String s)</span> &#123;<br>    log.debug(s);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">trace</span><span class="hljs-params">(String s)</span> &#123;<br>    log.trace(s);<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warn</span><span class="hljs-params">(String s)</span> &#123;<br>    log.warn(s);<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p> <code>Jdk14LoggingImplã€Log4jImplã€NoLoggingImplã€StdOutImpl</code> å¤§åŒå°å¼‚</p><h4 id="Log4j2Impl"><a href="#Log4j2Impl" class="headerlink" title="Log4j2Impl"></a>Log4j2Impl</h4><p>Log4j2Impl æ ¹æ®ä» LogManagerè·å–çš„Loggerçš„ç±»å‹ï¼Œåˆ†åˆ«å§”æ‰˜ç»™ Log4j2AbstractLoggerImpl å’Œ Log4j2LoggerImpl å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Log4j2Impl</span><span class="hljs-params">(String clazz)</span> &#123;<br>  <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LogManager.getLogger(clazz);<br><br>  <span class="hljs-keyword">if</span> (logger <span class="hljs-keyword">instanceof</span> AbstractLogger) &#123;<br>    log = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Log4j2AbstractLoggerImpl</span>((AbstractLogger) logger);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    log = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Log4j2LoggerImpl</span>(logger);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Slf4jImpl"><a href="#Slf4jImpl" class="headerlink" title="Slf4jImpl"></a>Slf4jImpl</h4><p>Slf4jImpl ç±»ä¼¼</p><p>Slf4jImpl å’Œ ä¸Šé¢çš„ Log4j2Impléƒ½ä½¿ç”¨äº†ä»£ç†æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Slf4jImpl</span><span class="hljs-params">(String clazz)</span> &#123;<br>  <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(clazz);<br><br>  <span class="hljs-keyword">if</span> (logger <span class="hljs-keyword">instanceof</span> LocationAwareLogger) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// check for slf4j &gt;= 1.6 method signature</span><br>      logger.getClass().getMethod(<span class="hljs-string">&quot;log&quot;</span>, Marker.class, String.class, <span class="hljs-type">int</span>.class, String.class, Object[].class, Throwable.class);<br>      log = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Slf4jLocationAwareLoggerImpl</span>((LocationAwareLogger) logger);<br>      <span class="hljs-keyword">return</span>;<br>    &#125; <span class="hljs-keyword">catch</span> (SecurityException e) &#123;<br>      <span class="hljs-comment">// fail-back to Slf4jLoggerImpl</span><br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>      <span class="hljs-comment">// fail-back to Slf4jLoggerImpl</span><br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Logger is not LocationAwareLogger or slf4j version &lt; 1.6</span><br>  log = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Slf4jLoggerImpl</span>(logger);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="BaseJdbcLogger"><a href="#BaseJdbcLogger" class="headerlink" title="BaseJdbcLogger"></a>BaseJdbcLogger</h4><p>ç”¨äºä»£ç†ï¼ˆåšæ—¥å¿—ï¼‰çš„åŸºç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// SET_METHODS åŒ…å«javaç±»å‹è½¬jdbcç±»å‹çš„æ–¹æ³•</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; SET_METHODS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();<br><span class="hljs-comment">// EXECUTE_METHODS åŒ…å« executeã€executeUpdateã€</span><br><span class="hljs-comment">// executeQueryã€addBatchæ–¹æ³•</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;String&gt; EXECUTE_METHODS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;String&gt;();<br><br><span class="hljs-comment">// è‡ªç”¨çš„åˆ—çš„ç›¸å…³å±æ€§</span><br><span class="hljs-keyword">private</span> Map&lt;Object, Object&gt; columnMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Object, Object&gt;();<br><br><span class="hljs-keyword">private</span> List&lt;Object&gt; columnNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br><span class="hljs-keyword">private</span> List&lt;Object&gt; columnValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;();<br><br><span class="hljs-comment">// æ‰“æ—¥å¿—</span><br><span class="hljs-keyword">protected</span> Log statementLog;<br><span class="hljs-comment">// æŸ¥è¯¢æ ˆï¼ˆè¾“å‡ºæ—¶ç”¨ï¼‰</span><br><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> queryStack;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Default constructor</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseJdbcLogger</span><span class="hljs-params">(Log log, <span class="hljs-type">int</span> queryStack)</span> &#123;<br>  <span class="hljs-built_in">this</span>.statementLog = log;<br>  <span class="hljs-keyword">if</span> (queryStack == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">this</span>.queryStack = <span class="hljs-number">1</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">this</span>.queryStack = queryStack;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// ç±»åˆå§‹åŒ–æ—¶ä¸ºSET_METHODSå’ŒEXECUTE_METHODSèµ‹å€¼</span><br><span class="hljs-keyword">static</span> &#123;<br>  SET_METHODS.add(<span class="hljs-string">&quot;seString&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setInt&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setByte&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setShort&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setLong&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setDouble&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setFloat&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setTimestamp&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setDate&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setTime&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setArray&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setBigDecimal&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setAsciiStream&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setBinaryStream&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setBlob&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setBoolean&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setBytes&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setCharacterStream&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setClob&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setObject&quot;</span>);<br>  SET_METHODS.add(<span class="hljs-string">&quot;setNull&quot;</span>);<br><br>  EXECUTE_METHODS.add(<span class="hljs-string">&quot;execute&quot;</span>);<br>  EXECUTE_METHODS.add(<span class="hljs-string">&quot;executeUpdate&quot;</span>);<br>  EXECUTE_METHODS.add(<span class="hljs-string">&quot;executeQuery&quot;</span>);<br>  EXECUTE_METHODS.add(<span class="hljs-string">&quot;addBatch&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// è·å–å‚æ•°å€¼ è¿™é‡Œå¥½åƒæ˜¯è°ƒç”¨çš„Objectçš„toStringæ–¹æ³•?</span><br><span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getParameterValueString</span><span class="hljs-params">()</span> &#123;<br>  List&lt;Object&gt; typeList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Object&gt;(columnValues.size());<br>  <span class="hljs-keyword">for</span> (Object value : columnValues) &#123;<br>    <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) &#123;<br>      typeList.add(<span class="hljs-string">&quot;null&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      typeList.add(value + <span class="hljs-string">&quot;(&quot;</span> + value.getClass().getSimpleName() + <span class="hljs-string">&quot;)&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">parameters</span> <span class="hljs-operator">=</span> typeList.toString();<br>  <span class="hljs-keyword">return</span> parameters.substring(<span class="hljs-number">1</span>, parameters.length() - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-comment">// ç§»é™¤ original é‡Œçš„&quot; \t\n\r\f&quot;å­—ç¬¦ï¼Œç»Ÿä¸€ç”¨&quot; &quot;æ›¿ä»£</span><br><span class="hljs-keyword">protected</span> String <span class="hljs-title function_">removeBreakingWhitespace</span><span class="hljs-params">(String original)</span> &#123;<br>  <span class="hljs-type">StringTokenizer</span> <span class="hljs-variable">whitespaceStripper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringTokenizer</span>(original);<br>  <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>  <span class="hljs-keyword">while</span> (whitespaceStripper.hasMoreTokens()) &#123;<br>    builder.append(whitespaceStripper.nextToken());<br>    builder.append(<span class="hljs-string">&quot; &quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> builder.toString();<br>&#125;<br><br><span class="hljs-comment">// æ ¹æ®queryStack è¿”å› ===&gt; æˆ– &lt;===</span><br><span class="hljs-keyword">private</span> String <span class="hljs-title function_">prefix</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isInput)</span> &#123;<br>  <span class="hljs-type">char</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[queryStack * <span class="hljs-number">2</span> + <span class="hljs-number">2</span>];<br>  Arrays.fill(buffer, <span class="hljs-string">&#x27;=&#x27;</span>);<br>  buffer[queryStack * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27; &#x27;</span>;<br>  <span class="hljs-keyword">if</span> (isInput) &#123;<br>    buffer[queryStack * <span class="hljs-number">2</span>] = <span class="hljs-string">&#x27;&gt;&#x27;</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    buffer[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;&lt;&#x27;</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(buffer);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ResultSetLogger"><a href="#ResultSetLogger" class="headerlink" title="ResultSetLogger"></a>ResultSetLogger</h4><p>æ·»åŠ äº†æ—¥å¿—çš„ResultSetä»£ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResultSetLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseJdbcLogger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>  <span class="hljs-comment">// BLOB type ç±»å‹ä¸ºBLOBçš„å€¼æ‰“å°æ—¶åšç‰¹æ®Šå¤„ç†</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Set&lt;Integer&gt; BLOB_TYPES = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Integer&gt;();<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>  <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">private</span> ResultSet rs;<br>  <span class="hljs-keyword">private</span> Set&lt;Integer&gt; blobColumns = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;Integer&gt;();<br><br>  <span class="hljs-keyword">static</span> &#123;<br>    BLOB_TYPES.add(Types.BINARY);<br>    BLOB_TYPES.add(Types.BLOB);<br>    BLOB_TYPES.add(Types.CLOB);<br>    BLOB_TYPES.add(Types.LONGNVARCHAR);<br>    BLOB_TYPES.add(Types.LONGVARBINARY);<br>    BLOB_TYPES.add(Types.LONGVARCHAR);<br>    BLOB_TYPES.add(Types.NCLOB);<br>    BLOB_TYPES.add(Types.VARBINARY);<br>  &#125;<br><br>  <span class="hljs-comment">// ä¸å‘å¤–æä¾›æ„é€ å‡½æ•°</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">ResultSetLogger</span><span class="hljs-params">(ResultSet rs, Log statementLog, <span class="hljs-type">int</span> queryStack)</span> &#123;<br>    <span class="hljs-built_in">super</span>(statementLog, queryStack);<br>    <span class="hljs-built_in">this</span>.rs = rs;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] params)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// ä¸ä»£ç†Objectç±»çš„æ–¹æ³•</span><br>      <span class="hljs-keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>, params);<br>      &#125;<br>      <span class="hljs-comment">// å…ˆæ‰§è¡Œä»£ç†æ–¹æ³•</span><br>      <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> method.invoke(rs, params);<br>      <span class="hljs-comment">// å¦‚æœè¦ä»£ç†çš„æ–¹æ³•æ˜¯ next</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;next&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-keyword">if</span> (((Boolean) o)) &#123;<br>          rows++;<br>          <span class="hljs-comment">// æ‰“å°è·å–åˆ°çš„ç»“æœæ•°æ®</span><br>          <span class="hljs-keyword">if</span> (isTraceEnabled()) &#123;<br>            <span class="hljs-type">ResultSetMetaData</span> <span class="hljs-variable">rsmd</span> <span class="hljs-operator">=</span> rs.getMetaData();<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">columnCount</span> <span class="hljs-operator">=</span> rsmd.getColumnCount();<br>            <span class="hljs-keyword">if</span> (first) &#123;<br>              first = <span class="hljs-literal">false</span>;<br>              printColumnHeaders(rsmd, columnCount);<br>            &#125;<br>            printColumnValues(columnCount);<br>          &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// æ²¡æœ‰ä¸‹ä¸€è¡Œäº†</span><br>          debug(<span class="hljs-string">&quot;     Total: &quot;</span> + rows, <span class="hljs-literal">false</span>);<br>        &#125;<br>      &#125;<br>      clearColumnInfo();<br>      <span class="hljs-keyword">return</span> o;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ‰“å°åˆ—å</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printColumnHeaders</span><span class="hljs-params">(ResultSetMetaData rsmd, <span class="hljs-type">int</span> columnCount)</span> <span class="hljs-keyword">throws</span> SQLException &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    row.append(<span class="hljs-string">&quot;   Columns: &quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= columnCount; i++) &#123;<br>      <span class="hljs-keyword">if</span> (BLOB_TYPES.contains(rsmd.getColumnType(i))) &#123;<br>        blobColumns.add(i);<br>      &#125;<br>      <span class="hljs-type">String</span> <span class="hljs-variable">colname</span> <span class="hljs-operator">=</span> rsmd.getColumnLabel(i);<br>      row.append(colname);<br>      <span class="hljs-keyword">if</span> (i != columnCount) &#123;<br>        row.append(<span class="hljs-string">&quot;, &quot;</span>);<br>      &#125;<br>    &#125;<br>    trace(row.toString(), <span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// æ‰“å°æ¯ä¸€è¡Œå¯¹åº”åˆ—çš„å€¼</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printColumnValues</span><span class="hljs-params">(<span class="hljs-type">int</span> columnCount)</span> &#123;<br>    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>    row.append(<span class="hljs-string">&quot;       Row: &quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= columnCount; i++) &#123;<br>      String colname;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// ç±»å‹ä¸ºBLOBçš„å€¼ç»Ÿä¸€è¿”å› &lt;&lt;BLOB&gt;&gt;</span><br>        <span class="hljs-keyword">if</span> (blobColumns.contains(i)) &#123;<br>          colname = <span class="hljs-string">&quot;&lt;&lt;BLOB&gt;&gt;&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          colname = rs.getString(i);<br>        &#125;<br>      &#125; <span class="hljs-keyword">catch</span> (SQLException e) &#123;<br>        <span class="hljs-comment">// generally can&#x27;t call getString() on a BLOB column</span><br>        colname = <span class="hljs-string">&quot;&lt;&lt;Cannot Display&gt;&gt;&quot;</span>;<br>      &#125;<br>      row.append(colname);<br>      <span class="hljs-keyword">if</span> (i != columnCount) &#123;<br>        row.append(<span class="hljs-string">&quot;, &quot;</span>);<br>      &#125;<br>    &#125;<br>    trace(row.toString(), <span class="hljs-literal">false</span>);<br>  &#125;<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">   * Creates a logging version of a ResultSet</span><br><span class="hljs-comment">   * æä¾›é™æ€æ–¹æ³•ç”¨äºåˆ›å»ºä»£ç†ç±»</span><br><span class="hljs-comment">   * @param rs - the ResultSet to proxy</span><br><span class="hljs-comment">   * @return - the ResultSet with logging</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ResultSet <span class="hljs-title function_">newInstance</span><span class="hljs-params">(ResultSet rs, Log statementLog, <span class="hljs-type">int</span> queryStack)</span> &#123;<br>    <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResultSetLogger</span>(rs, statementLog, queryStack);<br>    <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> ResultSet.class.getClassLoader();<br>    <span class="hljs-keyword">return</span> (ResultSet) Proxy.newProxyInstance(cl, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;ResultSet.class&#125;, handler);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="StatementLogger"><a href="#StatementLogger" class="headerlink" title="StatementLogger"></a>StatementLogger</h4><p>æ·»åŠ äº†æ—¥å¿—çš„ Statementä»£ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StatementLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseJdbcLogger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>  <br>  <span class="hljs-keyword">private</span> Statement statement;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">StatementLogger</span><span class="hljs-params">(Statement stmt, Log statementLog, <span class="hljs-type">int</span> queryStack)</span> &#123;<br>    <span class="hljs-built_in">super</span>(statementLog, queryStack);<br>    <span class="hljs-built_in">this</span>.statement = stmt;<br>  &#125;<br><br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] params)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-keyword">try</span> &#123; <br>      <span class="hljs-comment">// åŒä¸Š</span><br>      <span class="hljs-keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>, params);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (EXECUTE_METHODS.contains(method.getName())) &#123;<br>        <span class="hljs-comment">// å¦‚æœæ˜¯ executeã€executeUpdateã€executeQueryã€addBatchç­‰æ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (isDebugEnabled()) &#123;<br>          debug(<span class="hljs-string">&quot; Executing: &quot;</span> + removeBreakingWhitespace((String) params[<span class="hljs-number">0</span>]), <span class="hljs-literal">true</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;executeQuery&quot;</span>.equals(method.getName())) &#123;<br>          <span class="hljs-comment">// å¦‚æœæ˜¯æŸ¥è¯¢æ–¹æ³•è¿”å› ResultSet ä»£ç†</span><br>          <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> (ResultSet) method.invoke(statement, params);<br>          <span class="hljs-keyword">return</span> rs == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : ResultSetLogger.newInstance(rs, statementLog, queryStack);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">// å…¶ä»–æ–¹æ³•ç›´æ¥æ‰§è¡Œ</span><br>          <span class="hljs-keyword">return</span> method.invoke(statement, params);<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;getResultSet&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-comment">// getResultSet ä¹Ÿæ˜¯è¿”å› ResultSet ä»£ç†</span><br>        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> (ResultSet) method.invoke(statement, params);<br>        <span class="hljs-keyword">return</span> rs == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : ResultSetLogger.newInstance(rs, statementLog, queryStack);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;equals&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-comment">// equals è¦åˆ¤æ–­ä»£ç†ç±»æ˜¯å¦ç›¸åŒ</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> params[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">return</span> ps <span class="hljs-keyword">instanceof</span> Proxy &amp;&amp; proxy == ps;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;hashCode&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-comment">// è¿”å›ä»£ç†ç±»çš„hashCode</span><br>        <span class="hljs-keyword">return</span> proxy.hashCode();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// æ‰§è¡ŒåŸæ–¹æ³•</span><br>        <span class="hljs-keyword">return</span> method.invoke(statement, params);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>    &#125;<br>  &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h4 id="PreparedStatementLogger"><a href="#PreparedStatementLogger" class="headerlink" title="PreparedStatementLogger"></a>PreparedStatementLogger</h4><p>æ·»åŠ äº†æ—¥å¿—çš„ PreparedStatement ä»£ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreparedStatementLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseJdbcLogger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>  <span class="hljs-keyword">private</span> PreparedStatement statement;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">PreparedStatementLogger</span><span class="hljs-params">(PreparedStatement stmt, Log statementLog, <span class="hljs-type">int</span> queryStack)</span> &#123;<br>    <span class="hljs-built_in">super</span>(statementLog, queryStack);<br>    <span class="hljs-built_in">this</span>.statement = stmt;<br>  &#125;<br> <br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] params)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>, params);<br>      &#125;          <br>      <span class="hljs-keyword">if</span> (EXECUTE_METHODS.contains(method.getName())) &#123;<br>        <span class="hljs-keyword">if</span> (isDebugEnabled()) &#123;<br>          <span class="hljs-comment">// è¿™é‡Œçš„ä¿¡æ¯ä¼¼ä¹å¯è¯»æ€§ä¸é«˜</span><br>          debug(<span class="hljs-string">&quot;Parameters: &quot;</span> + getParameterValueString(), <span class="hljs-literal">true</span>);<br>        &#125; <br>        <span class="hljs-comment">// æ¸…é™¤ä¹‹å‰å­˜å‚¨çš„åˆ—ä¿¡æ¯</span><br>        clearColumnInfo();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;executeQuery&quot;</span>.equals(method.getName())) &#123;<br>          <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> (ResultSet) method.invoke(statement, params);<br>          <span class="hljs-keyword">return</span> rs == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : ResultSetLogger.newInstance(rs, statementLog, queryStack);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-keyword">return</span> method.invoke(statement, params);<br>        &#125;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (SET_METHODS.contains(method.getName())) &#123;<br>        <span class="hljs-comment">// è°ƒç”¨SET_METHODS åŒ…å«çš„æ–¹æ³•æ—¶å…ˆå°†ä¿å­˜åˆ—ä¿¡æ¯å†è°ƒç”¨åŸæ–¹æ³•</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;setNull&quot;</span>.equals(method.getName())) &#123;<br>          setColumn(params[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          setColumn(params[<span class="hljs-number">0</span>], params[<span class="hljs-number">1</span>]);<br>        &#125;<br>        <span class="hljs-keyword">return</span> method.invoke(statement, params);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;getResultSet&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> (ResultSet) method.invoke(statement, params);<br>        <span class="hljs-keyword">return</span> rs == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : ResultSetLogger.newInstance(rs, statementLog, queryStack);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;getUpdateCount&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">updateCount</span> <span class="hljs-operator">=</span> (Integer) method.invoke(statement, params);<br>        <span class="hljs-keyword">if</span> (updateCount != -<span class="hljs-number">1</span>) &#123;<br>          <span class="hljs-comment">// è°ƒç”¨ getUpdateCount æ–¹æ³•æ—¶æ‰“å° æ›´æ–°æ•°é‡ ä¿¡æ¯</span><br>          debug(<span class="hljs-string">&quot;   Updates: &quot;</span> + updateCount, <span class="hljs-literal">false</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> updateCount;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> method.invoke(statement, params);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ConnectionLogger"><a href="#ConnectionLogger" class="headerlink" title="ConnectionLogger"></a>ConnectionLogger</h4><p>æ·»åŠ äº†æ—¥å¿—çš„ Connection ä»£ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseJdbcLogger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>  <span class="hljs-keyword">private</span> Connection connection;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">ConnectionLogger</span><span class="hljs-params">(Connection conn, Log statementLog, <span class="hljs-type">int</span> queryStack)</span> &#123;<br>    <span class="hljs-built_in">super</span>(statementLog, queryStack);<br>    <span class="hljs-built_in">this</span>.connection = conn;<br>  &#125;<br> <br>  <span class="hljs-meta">@Override</span><br>  <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] params)</span><br>      <span class="hljs-keyword">throws</span> Throwable &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">if</span> (Object.class.equals(method.getDeclaringClass())) &#123;<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>, params);<br>      &#125;    <br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;prepareStatement&quot;</span>.equals(method.getName())) &#123; <br>        <span class="hljs-comment">// è°ƒç”¨ prepareStatement æˆ–è€… prepareCall æ–¹æ³•æ—¶</span><br>        <span class="hljs-comment">// è¿”å› PreparedStatementçš„ä»£ç†</span><br>        <span class="hljs-keyword">if</span> (isDebugEnabled()) &#123;<br>          debug(<span class="hljs-string">&quot; Preparing: &quot;</span> + removeBreakingWhitespace((String) params[<span class="hljs-number">0</span>]), <span class="hljs-literal">true</span>);<br>        &#125;        <br>        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> (PreparedStatement) method.invoke(connection, params);<br>        stmt = PreparedStatementLogger.newInstance(stmt, statementLog, queryStack);<br>        <span class="hljs-keyword">return</span> stmt;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;prepareCall&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-keyword">if</span> (isDebugEnabled()) &#123;<br>          debug(<span class="hljs-string">&quot; Preparing: &quot;</span> + removeBreakingWhitespace((String) params[<span class="hljs-number">0</span>]), <span class="hljs-literal">true</span>);<br>        &#125;        <br>        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> (PreparedStatement) method.invoke(connection, params);<br>        stmt = PreparedStatementLogger.newInstance(stmt, statementLog, queryStack);<br>        <span class="hljs-keyword">return</span> stmt;<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;createStatement&quot;</span>.equals(method.getName())) &#123;<br>        <span class="hljs-comment">// è°ƒç”¨ createStatement æ—¶è¿”å› Statementçš„ä»£ç†</span><br>        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> (Statement) method.invoke(connection, params);<br>        stmt = StatementLogger.newInstance(stmt, statementLog, queryStack);<br>        <span class="hljs-keyword">return</span> stmt;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> method.invoke(connection, params);<br>      &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>      <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¥å¿—æ¨¡å—çš„ä»£ç å°±è®²è§£å®Œäº†</p>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>0-å‰è¨€</title>
    <link href="/2023/05/02/mybatis-source-code/0-%E5%89%8D%E8%A8%80/"/>
    <url>/2023/05/02/mybatis-source-code/0-%E5%89%8D%E8%A8%80/</url>
    
    <content type="html"><![CDATA[<h3 id="è¯´åœ¨å‰é¢"><a href="#è¯´åœ¨å‰é¢" class="headerlink" title="è¯´åœ¨å‰é¢"></a>è¯´åœ¨å‰é¢</h3><p>Â Â Â Â å‰æ®µæ—¶é—´ç²—ç•¥åœ°è¿‡äº†ä¸€émybatisæºç ã€‚æœ‰äº›åœ°æ–¹æ‡‚äº†ã€æœ‰äº›åœ°æ–¹æ²¡æ‡‚ã€‚æƒ³ç€å¤ä¹ ä¸€ä¸‹ï¼ŒåŠ æ·±ä¸€ä¸‹ç†è§£ã€åŠ ä¸Šè‡ªå·±ä¹Ÿæƒ³å¤šå†™å†™åšå®¢ï¼Œæ‰€ä»¥æœ‰äº†è¿™ä¸ªMybatisæºç è§£æç³»åˆ—</p><h4 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h4><ol><li><p>æˆ‘æ˜¯è·Ÿç€githubä¸Šä¸€ä¸ªä»“åº“ï¼ˆ<a href="https://github.com/tuguangquan/mybatis">tuguangquan&#x2F;mybatis: mybatisæºç ä¸­æ–‡æ³¨é‡Š (github.com)</a>ï¼‰è¿›è¡Œå¾—æºç é˜…è¯»ï¼Œå› æ­¤mybatisæºç ç‰ˆæœ¬ä¸æ˜¯æœ€æ–°çš„ï¼ˆ3.3.0-SNAPSHOTï¼‰</p></li><li><p>ä¸Šé¢ä»“åº“é‡Œè¯´çš„å¯¼å…¥mybatis-parentæ¨¡å—åªéœ€è¦åœ¨pomæ–‡ä»¶ä¸­é…ç½®ä¸€ä¸‹<parent>æ ‡ç­¾å³å¯</parent></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- groupIdã€artifactIdã€versionå‡å¯åœ¨</span><br><span class="hljs-comment">parentPom.xmlä¸­æ‰¾åˆ°--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>38-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- parentPomæ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>parentPom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>è¦æ˜¯å¯¹æŸä¸ªæ¨¡å—æœ‰ä¸å¤ªæ‡‚çš„åœ°æ–¹ï¼Œå¯ä»¥ç»“åˆå®˜æ–¹æä¾›çš„æµ‹è¯•ç”¨ä¾‹åŠ æ·±ç†è§£</p></li><li><p>è¦ä»”ç»†äº†è§£ä»£ç ä¸­æåˆ°çš„ç›¸å…³issueï¼Œå»ºè®®æŸ¥çœ‹æ–‡ä»¶çš„gitæäº¤å†å²</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>Mybatisæºç è§£æ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Mybatis</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å¯»æ‰¾é‡å¤æ•°</title>
    <link href="/2022/10/15/algorithm/%E5%AF%BB%E6%89%BE%E9%87%8D%E5%A4%8D%E6%95%B0/"/>
    <url>/2022/10/15/algorithm/%E5%AF%BB%E6%89%BE%E9%87%8D%E5%A4%8D%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<h4 id="æ–¹æ³•ä¸€ï¼šäºŒåˆ†æŸ¥æ‰¾"><a href="#æ–¹æ³•ä¸€ï¼šäºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="æ–¹æ³•ä¸€ï¼šäºŒåˆ†æŸ¥æ‰¾"></a>æ–¹æ³•ä¸€ï¼šäºŒåˆ†æŸ¥æ‰¾</h4><blockquote><p>å®šä¹‰ cnt[i] è¡¨ç¤ºnumsæ•°ç»„ä¸­å°äºç­‰äºiçš„æ•°æœ‰å¤šå°‘ä¸ª</p></blockquote><p>cntæ•°ç»„éšæ•°å­—ié€æ¸å¢å¤§å…·æœ‰å•è°ƒæ€§ã€‚å‡è®¾é‡å¤çš„æ•°æ˜¯targetï¼Œå¦‚æœcntæ•°ç»„æ»¡è¶³åœ¨targetå‰æœ‰cnt[i]&lt;&#x3D;i,targetåæœ‰cnt[i]&gt;iï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å°±åˆ©ç”¨äºŒåˆ†æŸ¥æ‰¾æ¥æ‰¾åˆ°target</p><p>ä¸‹é¢è¯æ˜ä¸Šè¿°å‡è®¾ï¼šè€ƒè™‘<strong>nums</strong>æ•°ç»„ä¸€å…±æœ‰n+1ä¸ªä½ç½®ï¼Œæˆ‘ä»¬å¡«å…¥çš„æ•°å­—éƒ½åœ¨[1,n]é—´ï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªæ•°é‡å¤æ”¾äº†ä¸¤æ¬¡ä»¥ä¸Šã€‚å¯¹äºæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œè€ƒè™‘ä¸€ä¸‹ä¸¤ç§æƒ…å†µï¼š</p><ul><li>å¦‚æœæµ‹è¯•ç”¨ä¾‹çš„æ•°ç»„ä¸­targetå‡ºç°äº†ä¸¤æ¬¡ï¼Œå…¶ä½™çš„æ•°å„å‡ºç°äº†ä¸€æ¬¡ã€‚è¿™ä¸ªæ—¶å€™å°äºtargetçš„æ•°iæ»¡è¶³cnt[i]&#x3D;i&lt;&#x3D;iï¼Œå¤§äºç­‰äºtargetçš„æ•°jæ»¡è¶³cnt[j]&#x3D;j+1&gt;j</li><li>å¦‚æœæµ‹è¯•ç”¨ä¾‹çš„æ•°ç»„ä¸­targetå‡ºç°äº†ä¸‰æ¬¡åŠä»¥ä¸Šï¼Œé‚£ä¹ˆå¿…ç„¶æœ‰ä¸€äº›æ•°ä¸åœ¨æ•°ç»„ä¸­äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ç”¨targetå»æ›¿æ¢è¿™äº›æ•°ï¼Œè€ƒè™‘æ›¿æ¢çš„æ—¶å€™å¯¹targetåªå‡ºç°ä¸¤æ¬¡çš„cntæ•°ç»„çš„å½±å“ã€‚å¦‚æœæ›¿æ¢çš„æ•°iå°äºtargetï¼Œé‚£ä¹ˆ[i,target-1]çš„cntå€¼å‡å‡ä¸€ï¼Œå…¶ä»–ä¸å˜ï¼Œæ»¡è¶³æ¡ä»¶ã€‚å¦‚æœæ›¿æ¢çš„æ•°jå¤§äºtargetï¼Œé‚£ä¹ˆ[target,j-1]çš„cntå€¼å‡åŠ ä¸€ï¼Œå…¶ä»–ä¸å˜ï¼Œäº¦æ»¡è¶³æ¡ä»¶</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findDuplicate</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> nums.length;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">l</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, r = n - <span class="hljs-number">1</span>, ans = -<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">while</span> (l &lt;= r) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> (l + r) &gt;&gt; <span class="hljs-number">1</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">cnt</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; ++i) &#123;<br>                <span class="hljs-keyword">if</span> (nums[i] &lt;= mid) &#123;<br>                    cnt++;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (cnt &lt;= mid) &#123;<br>                l = mid + <span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                r = mid - <span class="hljs-number">1</span>;<br>                ans = mid;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ans;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šO(nlogn)ï¼Œå…¶ä¸­nä¸ºnumsæ•°ç»„çš„é•¿åº¦ã€‚äºŒåˆ†æŸ¥æ‰¾æœ€å¤šéœ€è¦äºŒåˆ†O(nlogn)æ¬¡ï¼Œæ¯æ¬¡åˆ¤æ–­çš„æ—¶å€™éœ€è¦O(n)éå†numsæ•°ç»„æ±‚è§£å°äºç­‰äºmidçš„æ•°çš„ä¸ªæ•°ï¼Œå› æ­¤æ€»æ—¶é—´å¤æ‚åº¦ä¸ºO(nlogn)</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(1)ã€‚æˆ‘ä»¬åªéœ€è¦å¸¸æ•°ç©ºé—´å­˜æ”¾è‹¥å¹²å˜é‡ã€‚</li></ul><h4 id="æ–¹æ³•äºŒï¼šäºŒè¿›åˆ¶"><a href="#æ–¹æ³•äºŒï¼šäºŒè¿›åˆ¶" class="headerlink" title="æ–¹æ³•äºŒï¼šäºŒè¿›åˆ¶"></a>æ–¹æ³•äºŒï¼šäºŒè¿›åˆ¶</h4><blockquote><p>å°†æ‰€æœ‰æ•°æŒ‰äºŒè¿›åˆ¶ä½å±•å¼€è€ƒè™‘å¦‚ä½•æ‰¾å‡ºé‡å¤çš„æ•°ï¼Œå¦‚æœæˆ‘ä»¬èƒ½ç¡®å®šé‡å¤æ•°çš„æ¯ä¸€ä½æ˜¯1è¿˜æ˜¯0å°±å¯ä»¥æŒ‰ä½è¿˜åŸå‡ºé‡å¤çš„æ•°æ˜¯ä»€ä¹ˆã€‚</p></blockquote><p>è€ƒè™‘åˆ°ç¬¬iä½ï¼Œæˆ‘ä»¬è®°numsæ•°ç»„ä¸­äºŒè¿›åˆ¶å±•å¼€åç¬¬iä½ä¸º1çš„æ•°æœ‰xä¸ªï¼Œæ•°å­—[1,n]è¿™nä¸ªæ•°äºŒè¿›åˆ¶å±•å¼€åç¬¬iä½ä¸º1çš„æ•°æœ‰yä¸ªã€‚æˆ‘ä»¬å¯ä»¥å‡è®¾é‡å¤æ•°çš„ç¬¬iä½ä¸º1å½“ä¸”ä»…å½“ x &gt; y</p><p>è¯æ˜å¦‚ä¸‹ï¼š</p><ul><li><p>å¦‚æœæµ‹è¯•ç”¨ä¾‹çš„æ•°ç»„ä¸­targetå‡ºç°äº†ä¸¤æ¬¡ï¼Œå…¶ä½™çš„æ•°å„å‡ºç°äº†ä¸€æ¬¡ã€‚</p><ul><li>å¦‚æœtargetçš„ç¬¬iä½ä¸º1ï¼Œé‚£ä¹ˆnumsæ•°ç»„ä¸­ç¬¬iä½ä¸º1çš„ä¸ªæ•°xæ°å¥½æ¯”yå¤§1ï¼Œå³x&gt;y</li><li>å¦‚æœtargetçš„ç¬¬iä½ä¸º0ï¼Œé‚£ä¹ˆnumsæ•°ç»„ä¸­ç¬¬iä½ä¸º1çš„ä¸ªæ•°xå’Œyç›¸åŒï¼Œå³x&lt;&#x3D;y</li></ul></li><li><p>å¦‚æœæµ‹è¯•ç”¨ä¾‹çš„æ•°ç»„ä¸­targetå‡ºç°äº†ä¸‰æ¬¡åŠä»¥ä¸Šï¼Œé‚£ä¹ˆå¿…ç„¶æœ‰ä¸€äº›æ•°ä¸åœ¨numsæ•°ç»„ä¸­äº†ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘ç”¨targetå»æ›¿æ¢è¿™äº›æ•°ï¼Œè€ƒè™‘æ›¿æ¢çš„æ—¶å€™å¯¹targetå‡ºç°ä¸¤æ¬¡æƒ…å†µä¸‹çš„xçš„å½±å“:</p><ul><li>å¦‚æœè¢«æ›¿æ¢çš„æ•°çš„ç¬¬iä½ä¸º1ï¼Œå¹¶ä¸”targetçš„ç¬¬iä½ä¸º1ï¼Œé‚£ä¹ˆxä¸å˜ã€‚æ»¡è¶³x&gt;y</li><li>å¦‚æœè¢«æ›¿æ¢çš„æ•°çš„ç¬¬iä½ä¸º0ï¼Œå¹¶ä¸”targetçš„ç¬¬iä½ä¸º1ï¼Œé‚£ä¹ˆx+1ã€‚æ»¡è¶³x&gt;y</li><li>å¦‚æœè¢«æ›¿æ¢çš„æ•°çš„ç¬¬iä½ä¸º1ï¼Œå¹¶ä¸”targetçš„ç¬¬iä½ä¸º0ï¼Œé‚£ä¹ˆx-1ï¼Œæ»¡è¶³x&lt;&#x3D;y</li><li>å¦‚æœè¢«æ›¿æ¢çš„æ•°çš„ç¬¬iä½ä¸º0ï¼Œå¹¶ä¸”targetçš„ç¬¬iä½ä¸º0ï¼Œé‚£ä¹ˆxä¸å˜ï¼Œæ»¡è¶³x&lt;&#x3D;y</li></ul><p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœtargetçš„ç¬¬iä½ä¸º1ï¼Œé‚£ä¹ˆæ¯æ¬¡æ›¿æ¢ååªä¼šä½¿xä¸å˜æˆ–å¢å¤§;å¦‚æœä¸º0ï¼Œæ›¿æ¢ååªä¼šä½¿xä¸å˜æˆ–å‡å°ã€‚å§‹ç»ˆæ»¡è¶³x&gt;yæ—¶targetç¬¬iä½ä¸º1ï¼Œå¦åˆ™ä¸º0ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ®æ­¤æŒ‰ä½è¿˜åŸè¿™ä¸ªé‡å¤çš„æ•°ã€‚</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findDuplicate</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> nums.length, ans = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// ç¡®å®šäºŒè¿›åˆ¶ä¸‹æœ€é«˜ä½æ˜¯å¤šå°‘</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">bit_max</span> <span class="hljs-operator">=</span> <span class="hljs-number">31</span>;<br>        <span class="hljs-keyword">while</span> (((n - <span class="hljs-number">1</span>) &gt;&gt; bit_max) == <span class="hljs-number">0</span>) &#123;<br>            bit_max -= <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">bit</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; bit &lt;= bit_max; ++bit) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, y = <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; ++i) &#123;<br>                <span class="hljs-keyword">if</span> ((nums[i] &amp; (<span class="hljs-number">1</span> &lt;&lt; bit)) != <span class="hljs-number">0</span>) &#123;<br>                    x += <span class="hljs-number">1</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (i &gt;= <span class="hljs-number">1</span> &amp;&amp; ((i &amp; (<span class="hljs-number">1</span> &lt;&lt; bit)) != <span class="hljs-number">0</span>)) &#123;<br>                    y += <span class="hljs-number">1</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (x &gt; y) &#123;<br>                ans |= <span class="hljs-number">1</span> &lt;&lt; bit;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> ans;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šO(nlogn)ï¼Œå…¶ä¸­nä¸ºnumsæ•°ç»„çš„é•¿åº¦ã€‚O(logn)ä»£è¡¨äº†æˆ‘ä»¬æšä¸¾äºŒè¿›åˆ¶æ•°çš„ä½æ•°ä¸ªæ•°ï¼Œæšä¸¾ç¬¬iä½çš„æ—¶å€™éœ€è¦éå†æ•°ç»„ç»Ÿè®¡xå’Œyçš„ç­”æ¡ˆï¼Œå› æ­¤æ€»æ—¶é—´å¤æ‚åº¦ä¸ºO(nlogn)ã€‚</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(1)ã€‚æˆ‘ä»¬åªéœ€è¦å¸¸æ•°ç©ºé—´å­˜æ”¾è‹¥å¹²å˜é‡ã€‚</li></ul><h4 id="æ–¹æ³•ä¸‰ï¼šå¿«æ…¢æŒ‡é’ˆ"><a href="#æ–¹æ³•ä¸‰ï¼šå¿«æ…¢æŒ‡é’ˆ" class="headerlink" title="æ–¹æ³•ä¸‰ï¼šå¿«æ…¢æŒ‡é’ˆ"></a>æ–¹æ³•ä¸‰ï¼šå¿«æ…¢æŒ‡é’ˆ</h4><p>å¯¹ nums æ•°ç»„å»ºå›¾ï¼Œæ¯ä¸ªä½ç½® i è¿ä¸€æ¡ iâ†’nums[i] çš„è¾¹ï¼Œå°±å¯ä»¥å°†é—®é¢˜è½¬æ¢æˆ<a href="https://leetcode-cn.com/problems/linked-list-cycle-ii/solution/huan-xing-lian-biao-ii-by-leetcode/">142. ç¯å½¢é“¾è¡¨ II</a></p><p>æ ¹æ® Floydåˆ¤åœˆç®—æ³• ï¼ˆåˆç§°é¾Ÿå…”èµ›è·‘ç®—æ³•ï¼‰æ¥æ£€æµ‹é“¾è¡¨æ˜¯å¦æœ‰ç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findDuplicate</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">slow</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, fast = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">do</span> &#123;<br>            slow = nums[slow];<br>            fast = nums[nums[fast]];<br>        &#125; <span class="hljs-keyword">while</span> (slow != fast);<br>        slow = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (slow != fast) &#123;<br>            slow = nums[slow];<br>            fast = nums[fast];<br>        &#125;<br>        <span class="hljs-keyword">return</span> slow;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤æ‚åº¦åˆ†æ</strong></p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šO(n)</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(1)</li></ul>]]></content>
    
    
    <categories>
      
      <category>Leetcode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Algorithm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¼šè®®å®¤II</title>
    <link href="/2022/09/25/algorithm/%E4%BC%9A%E8%AE%AE%E5%AE%A4II/"/>
    <url>/2022/09/25/algorithm/%E4%BC%9A%E8%AE%AE%E5%AE%A4II/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ä¸‘æ•°II</title>
    <link href="/2022/09/25/algorithm/%E4%B8%91%E6%95%B0II/"/>
    <url>/2022/09/25/algorithm/%E4%B8%91%E6%95%B0II/</url>
    
    <content type="html"><![CDATA[<p>ç»™ä½ ä¸€ä¸ªæ­£æ•´æ•°nï¼Œè¯·ä½ æ‰¾å‡ºå¹¶è¿”å›ç¬¬nä¸ªä¸‘æ•°</p><p>ä¸‘æ•°å°±æ˜¯åªåŒ…å«è´¨å› æ•°2ã€3å’Œ5çš„æ­£æ•´æ•°</p><h4 id="æ–¹æ³•ä¸€ï¼šæœ€å°å †"><a href="#æ–¹æ³•ä¸€ï¼šæœ€å°å †" class="headerlink" title="æ–¹æ³•ä¸€ï¼šæœ€å°å †"></a>æ–¹æ³•ä¸€ï¼šæœ€å°å †</h4><p>åˆå§‹æ—¶å †ä¸ºç©ºã€‚é¦–å…ˆå°†æœ€å°çš„ä¸‘æ•°1åŠ å…¥å †ä¸­ã€‚</p><p>æ¯æ¬¡å–å‡ºå †é¡¶å…ƒç´ xï¼Œåˆ™xæ˜¯å †ä¸­æœ€å°çš„ä¸‘æ•°ï¼Œç”±äº2xã€3xã€5xä¹Ÿæ˜¯ä¸‘æ•°ï¼Œå› æ­¤å°†2xã€3xã€5xåŠ å…¥å †ã€‚</p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯èƒ½ä¼šæœ‰é‡å¤çš„å…ƒç´ ï¼Œéœ€è¦ç”¨ä¸€ä¸ªsetè¿›è¡Œå»é‡ï¼Œé¿å…æŸä¸ªä¸‘æ•°å¤šæ¬¡åŠ å…¥å †</p><p>ç¬¬næ¬¡ä»å †é¡¶å–å‡ºæ¥çš„å…ƒç´ å°±æ˜¯ç¬¬nä¸ªä¸‘æ•°</p><p>ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nthUglyNumber</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>        Set&lt;Long&gt; set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        PriorityQueue&lt;Long&gt; minHeap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;&gt;();<br>        set.add(<span class="hljs-number">1L</span>);<br>        minHeap.add(<span class="hljs-number">1L</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;n;i++) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> minHeap.poll();<br>            <span class="hljs-keyword">if</span> (!set.contains(<span class="hljs-number">2</span>*t)) &#123;<br>                set.add(<span class="hljs-number">2</span>*t);<br>                minHeap.add(<span class="hljs-number">2</span>*t);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!set.contains(<span class="hljs-number">3</span>*t)) &#123;<br>                set.add(<span class="hljs-number">3</span>*t);<br>                minHeap.add(<span class="hljs-number">3</span>*t);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!set.contains(<span class="hljs-number">5</span>*t)) &#123;<br>                set.add(<span class="hljs-number">5</span>*t);<br>                minHeap.add(<span class="hljs-number">5</span>*t);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> minHeap.peek().intValue();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="æ–¹æ³•äºŒï¼šåŠ¨æ€è§„åˆ’"><a href="#æ–¹æ³•äºŒï¼šåŠ¨æ€è§„åˆ’" class="headerlink" title="æ–¹æ³•äºŒï¼šåŠ¨æ€è§„åˆ’"></a>æ–¹æ³•äºŒï¼šåŠ¨æ€è§„åˆ’</h4><p>å®šä¹‰æ•°ç»„dpï¼Œå…¶ä¸­dp[i]è¡¨ç¤ºç¬¬iä¸ªä¸‘æ•°ï¼Œç¬¬nä¸ªä¸‘æ•°å³ä¸ºdp[n]ã€‚</p><p>ç”±äºæœ€å°çš„ä¸‘æ•°æ˜¯1ï¼Œå› æ­¤dp[1]&#x3D;1ã€‚</p><p>å®šä¹‰ä¸‰ä¸ªæŒ‡é’ˆp2ã€p3ã€p5ï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªä¸‘æ•°æ˜¯å½“å‰æŒ‡é’ˆæŒ‡å‘çš„ä¸‘æ•°ä¹˜ä»¥å¯¹åº”çš„è´¨å› æ•°ã€‚åˆå§‹æ—¶ï¼Œä¸‰ä¸ªæŒ‡é’ˆçš„å€¼éƒ½æ˜¯1ã€‚</p><p>å½“2&lt;&#x3D;i&lt;&#x3D;næ—¶ï¼Œä»¤dp[i]&#x3D;min(dp[p2]x2,dp[p3]x3,dp[p5]x5)ï¼Œç„¶ååˆ†åˆ«æ¯”è¾ƒdp[i]å’Œdp[p2]x2,dp[p3]x3,dp[p5]x5æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™å°†ç›¸åº”çš„æŒ‡é’ˆåŠ 1ã€‚</p><p>æ­£ç¡®æ€§è¯æ˜ï¼š</p><blockquote><p>å¯¹äºi&gt;1ï¼Œåœ¨è®¡ç®—dp[i]æ—¶ï¼ŒæŒ‡é’ˆpx(xâˆˆ{2,3,5})çš„å«ä¹‰æ˜¯ä½¿å¾—dp[j] Ã— x &gt; dp[i-1]çš„æœ€å°çš„ä¸‹æ ‡j.å³å½“j&gt;&#x3D;pxæ—¶dp[j] Ã— x &gt; dp[i-1],å½“j&lt;pxæ—¶dp[j] Ã— x &lt;&#x3D; dp[i-1]ã€‚</p><p>å› æ­¤ï¼Œå¯¹äºi&gt;1ï¼Œåœ¨è®¡ç®—dp[i]æ—¶ï¼Œdp[p2]Ã—2,dp[p3]Ã—3,dp[p5]Ã—5éƒ½å¤§äºdp[i-1],dp[p2-1]Ã—2,dp[p3-1]Ã—3,dp[p5-1]Ã—5éƒ½å°äºæˆ–ç­‰äºdp[i-1]ã€‚ä»¤dp[i] &#x3D; min(dp[p2]Ã—2,dp[p3]Ã—3,dp[p5]Ã—5),åˆ™dp[i]æ˜¯å¤§äºdp[i-1]çš„æœ€å°çš„ä¸‘æ•°ï¼Œå³dp[i]æ˜¯ç¬¬iä¸ªä¸‘æ•°</p><p>åœ¨è®¡ç®—dp[i]ä¹‹åï¼Œä¼šæ›´æ–°ä¸‰ä¸ªæŒ‡é’ˆp2ã€p3ã€p5ï¼Œæ›´æ–°ä¹‹åçš„æŒ‡é’ˆå°†ç”¨äºè®¡ç®—dp[i+1]ï¼ŒåŒæ ·æ»¡è¶³dp[i+1]æ˜¯å¤§äºdp[i]çš„æœ€å°çš„ä¸‘æ•°ï¼Œå³dp[i+1]æ˜¯ç¬¬i+1ä¸ªä¸‘æ•°</p></blockquote><p>ä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nthUglyNumber</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>        <span class="hljs-type">long</span>[] dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">long</span>[n];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">p2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,p3 = <span class="hljs-number">0</span>,p5 = <span class="hljs-number">0</span>;<br>        dp[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;n;i++) &#123;<br>            dp[i] = Math.min(dp[p2]*<span class="hljs-number">2</span>,Math.min(dp[p3]*<span class="hljs-number">3</span>,dp[p5]*<span class="hljs-number">5</span>));<br>            <span class="hljs-keyword">if</span> (dp[i] == dp[p2]*<span class="hljs-number">2</span>) &#123;<br>                p2++;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (dp[i] == dp[p3]*<span class="hljs-number">3</span>) &#123;<br>                p3++;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (dp[i] == dp[p5]*<span class="hljs-number">5</span>) &#123;<br>                p5++;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)dp[n-<span class="hljs-number">1</span>];<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Leetcode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Algorithm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ä¼˜é›…çš„è§£é¢˜æ€è·¯(æŒç»­æ›´æ–°)</title>
    <link href="/2022/09/17/algorithm/%E4%BC%98%E9%9B%85%E7%9A%84%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF/"/>
    <url>/2022/09/17/algorithm/%E4%BC%98%E9%9B%85%E7%9A%84%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF/</url>
    
    <content type="html"><![CDATA[<hr><h5 id="215-æ•°ç»„ä¸­çš„ç¬¬Kä¸ªæœ€å¤§å…ƒç´ -åŠ›æ‰£ï¼ˆLeetCodeï¼‰"><a href="#215-æ•°ç»„ä¸­çš„ç¬¬Kä¸ªæœ€å¤§å…ƒç´ -åŠ›æ‰£ï¼ˆLeetCodeï¼‰" class="headerlink" title="215. æ•°ç»„ä¸­çš„ç¬¬Kä¸ªæœ€å¤§å…ƒç´  - åŠ›æ‰£ï¼ˆLeetCodeï¼‰"></a><a href="https://leetcode.cn/problems/kth-largest-element-in-an-array/">215. æ•°ç»„ä¸­çš„ç¬¬Kä¸ªæœ€å¤§å…ƒç´  - åŠ›æ‰£ï¼ˆLeetCodeï¼‰</a></h5><p>å‡è®¾æ•°ç»„çš„å·¦è¾¹ç•Œä¸ºleftã€å³è¾¹ç•Œä¸ºright</p><p>æ”¹é€ å¿«é€Ÿæ’åºæ±‚è§£ã€‚å½“é€šè¿‡partitionç¡®å®šé€‰æ‹©çš„å…ƒç´ çš„ä½ç½®iä¹‹åï¼Œåˆ¤æ–­iå’Œright-k+1çš„å¤§å°</p><ul><li>å¦‚æœ i &lt; right-k+1ï¼Œåœ¨æ•°ç»„å·¦è¾¹è¿›è¡ŒåŒæ ·çš„æ“ä½œï¼ˆæ“ä½œä¹‹å‰å…ˆæ›´æ–°leftã€rightã€kçš„å€¼ï¼‰</li><li>i &gt; right-k+1ï¼Œåœ¨æ•°ç»„å³è¾¹è¿›è¡ŒåŒæ ·çš„æ“ä½œï¼ˆæ“ä½œä¹‹å‰å…ˆæ›´æ–°leftã€rightã€kçš„å€¼ï¼‰</li><li>ç›´åˆ°i &#x3D; right-k+1ã€‚</li></ul><hr><h5 id="220-å­˜åœ¨é‡å¤å…ƒç´ -III-åŠ›æ‰£ï¼ˆLeetCodeï¼‰"><a href="#220-å­˜åœ¨é‡å¤å…ƒç´ -III-åŠ›æ‰£ï¼ˆLeetCodeï¼‰" class="headerlink" title="220. å­˜åœ¨é‡å¤å…ƒç´  III - åŠ›æ‰£ï¼ˆLeetCodeï¼‰"></a><a href="https://leetcode.cn/problems/contains-duplicate-iii/">220. å­˜åœ¨é‡å¤å…ƒç´  III - åŠ›æ‰£ï¼ˆLeetCodeï¼‰</a></h5><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ nums å’Œä¸¤ä¸ªæ•´æ•°Â k å’Œ t ã€‚è¯·ä½ åˆ¤æ–­æ˜¯å¦å­˜åœ¨ ä¸¤ä¸ªä¸åŒä¸‹æ ‡ i å’Œ jï¼Œä½¿å¾—Â abs(nums[i] - nums[j]) &lt;&#x3D; t ï¼ŒåŒæ—¶åˆæ»¡è¶³ abs(i - j) &lt;&#x3D; k ã€‚</p><p>æ€è·¯ï¼š</p><ul><li>æ»‘åŠ¨çª—å£+æœ‰åºé›†åˆ<br>ç»´æŠ¤ä¸€ä¸ªTreeSetï¼ˆç§°ä¸ºsetï¼‰,setä¸­æœ€å¤šæœ‰kä¸ªå…ƒç´ ï¼Œå½“è¶…è¿‡kä¸ªå…ƒç´ æ—¶ï¼Œç§»é™¤setä¸­å­˜åœ¨æ—¶é—´æœ€é•¿çš„å…ƒç´ ã€‚<br>å¯¹numsä¸­çš„æ¯ä¸ªå…ƒç´ nums[i]ï¼Œåˆ¤æ–­setä¸­æ˜¯å¦æœ‰å…ƒç´ åœ¨[nums[i]-t,nums[i]+t]èŒƒå›´å†…ã€‚<ul><li>å¦‚æœå­˜åœ¨è¿™æ ·ä¸€ä¸ªå…ƒç´ ï¼Œç›´æ¥è¿”å›</li><li>å¦‚æœä¸å­˜åœ¨è¿™æ ·ä¸€ä¸ªå…ƒç´ ï¼Œå°†nums[i]åŠ å…¥setåç»§ç»­æ£€æµ‹nums[i+1]</li></ul></li><li>æ¡¶<br>å¯¹äºå…ƒç´ xï¼Œå…¶å½±å“çš„åŒºé—´ä¸º[x-t,x+t]ã€‚äºæ˜¯æˆ‘ä»¬å¯ä»¥è®¾å®šä¸€ä¸ªå¤§å°ä¸ºt+1çš„æ¡¶ã€‚<ul><li>å¦‚æœä¸¤ä¸ªå…ƒç´ åŒå±ä¸€ä¸ªæ¡¶ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå…ƒç´ å¿…ç„¶æ»¡è¶³æ¡ä»¶</li><li>å¦‚æœä¸¤ä¸ªå…ƒç´ å±äºç›¸é‚»æ¡¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ ¡éªŒè¿™ä¸¤ä¸ªå…ƒç´ å·®å€¼çš„ç»å¯¹å€¼æ˜¯å¦ä¸è¶…è¿‡t</li><li>å¦‚æœä¸¤ä¸ªå…ƒç´ æ—¢ä¸å±äºåŒä¸€ä¸ªæ¡¶ï¼Œä¹Ÿä¸å±äºç›¸é‚»æ¡¶ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå…ƒç´ å¿…ç„¶ä¸æ»¡è¶³æ¡ä»¶</li></ul></li></ul><hr><h5 id="222-å®Œå…¨äºŒå‰æ ‘çš„èŠ‚ç‚¹ä¸ªæ•°-åŠ›æ‰£ï¼ˆLeetCodeï¼‰"><a href="#222-å®Œå…¨äºŒå‰æ ‘çš„èŠ‚ç‚¹ä¸ªæ•°-åŠ›æ‰£ï¼ˆLeetCodeï¼‰" class="headerlink" title="222. å®Œå…¨äºŒå‰æ ‘çš„èŠ‚ç‚¹ä¸ªæ•° - åŠ›æ‰£ï¼ˆLeetCodeï¼‰"></a><a href="https://leetcode.cn/problems/count-complete-tree-nodes/">222. å®Œå…¨äºŒå‰æ ‘çš„èŠ‚ç‚¹ä¸ªæ•° - åŠ›æ‰£ï¼ˆLeetCodeï¼‰</a></h5><p>äºŒåˆ†æŸ¥æ‰¾ + ä½è¿ç®—</p><p>å‡è®¾å®Œå…¨äºŒå‰æ ‘çš„å±‚æ•°ä¸ºhï¼Œåˆ™å®Œå…¨äºŒå‰æ ‘çš„èŠ‚ç‚¹æ•°é‡åœ¨[2^h,2^(h+1)-1]ä¹‹é—´</p><ul><li>åœ¨åŒºé—´å†…ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œå¾—åˆ°éœ€è¦åˆ¤æ–­çš„æ•°k</li><li>åˆ¤æ–­ç¬¬kä¸ªèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼š<ul><li>ç¬¬kä¸ªèŠ‚ç‚¹ä½äºç¬¬hå±‚ï¼Œåˆ™kæœ‰h+1ä½ã€‚</li><li>é™¤æ‰æœ€é«˜ä½çš„1ä¹‹åï¼Œä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼ŒæŒ‰ç…§ä»é«˜åˆ°ä½éå†kçš„äºŒè¿›åˆ¶ä½ã€‚</li><li>å¦‚æœäºŒè¿›åˆ¶ä½ä¸º0ï¼Œè¡¨ç¤ºç§»åŠ¨åˆ°å·¦å­èŠ‚ç‚¹ï¼›å¦‚æœäºŒè¿›åˆ¶ä½ä¸º1ï¼Œè¡¨ç¤ºç§»åŠ¨åˆ°å³å­èŠ‚ç‚¹ã€‚</li><li>å½“ç§»åŠ¨åˆ°å€’æ•°ç¬¬äºŒä½æ—¶ï¼Œå…¶ä¸‹ä¸€ä¸ªè¦ç§»åŠ¨åˆ°çš„å­èŠ‚ç‚¹å°±æ˜¯ç¬¬kä¸ªèŠ‚ç‚¹ã€‚ç”±æ­¤å¯ä»¥çŸ¥é“ç¬¬kä¸ªèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨</li></ul></li><li>å¦‚æœç¬¬kä¸ªèŠ‚ç‚¹å­˜åœ¨ï¼Œåˆ™èŠ‚ç‚¹ä¸ªæ•°ä¸€å®šå¤§äºæˆ–ç­‰äºkã€‚å¦‚æœç¬¬kä¸ªèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™èŠ‚ç‚¹ä¸ªæ•°ä¸€å®šå°äºk</li><li>å¾—åˆ°æ–°çš„èŠ‚ç‚¹ä¸ªæ•°åŒºé—´åå›åˆ°ç¬¬ä¸€æ­¥ç»§ç»­è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ç›´åˆ°å¾—åˆ°èŠ‚ç‚¹ä¸ªæ•°</li></ul><hr><h5 id="235-äºŒå‰æœç´¢æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ-åŠ›æ‰£ï¼ˆLeetCodeï¼‰"><a href="#235-äºŒå‰æœç´¢æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ-åŠ›æ‰£ï¼ˆLeetCodeï¼‰" class="headerlink" title="235. äºŒå‰æœç´¢æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰"></a><a href="https://leetcode.cn/problems/lowest-common-ancestor-of-a-binary-search-tree/">235. äºŒå‰æœç´¢æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰</a></h5><p>ç»™å®šä¸€ä¸ªäºŒå‰æœç´¢æ ‘, æ‰¾åˆ°è¯¥æ ‘ä¸­ä¸¤ä¸ªæŒ‡å®šèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚</p><p>ç™¾åº¦ç™¾ç§‘ä¸­æœ€è¿‘å…¬å…±ç¥–å…ˆçš„å®šä¹‰ä¸ºï¼šâ€œå¯¹äºæœ‰æ ¹æ ‘ T çš„ä¸¤ä¸ªç»“ç‚¹ pã€qï¼Œæœ€è¿‘å…¬å…±ç¥–å…ˆè¡¨ç¤ºä¸ºä¸€ä¸ªç»“ç‚¹ xï¼Œæ»¡è¶³ x æ˜¯ pã€q çš„ç¥–å…ˆä¸” x çš„æ·±åº¦å°½å¯èƒ½å¤§ï¼ˆä¸€ä¸ªèŠ‚ç‚¹ä¹Ÿå¯ä»¥æ˜¯å®ƒè‡ªå·±çš„ç¥–å…ˆï¼‰ã€‚â€</p><p>æ€è·¯ï¼š</p><ul><li>æ‰¾äºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ<ul><li>å®šä¹‰fxè¡¨ç¤ºxèŠ‚ç‚¹çš„å­æ ‘ä¸­æ˜¯å¦åŒ…å«pèŠ‚ç‚¹æˆ–qèŠ‚ç‚¹ï¼Œå¦‚æœåŒ…å«åˆ™ä¸ºtrueï¼Œå¦åˆ™ä¸ºfalseã€‚ é‚£ä¹ˆpå’Œqçš„æœ€è¿‘å…¬å…±ç¥–å…ˆä¸€å®šæ»¡è¶³æ¡ä»¶<br><img src="/2022/09/17/algorithm/%E4%BC%98%E9%9B%85%E7%9A%84%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF/1663503015805.png" class><br>å½“xçš„å·¦å­æ ‘å’Œå³å­æ ‘åˆ†åˆ«åŒ…å«på’Œqã€xå°±æ˜¯pæˆ–qå¹¶ä¸”xçš„å·¦å­æ ‘æˆ–å³å­æ ‘åŒ…å«å¦ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œxä¸ºäºŒå‰æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚è¿™ä¸¤ä¸ªæ¡ä»¶åˆ†åˆ«å¯¹åº”ä¸Šé¢çš„ä¸¤ä¸ªè¡¨è¾¾å¼ã€‚<br>æ‰¾åˆ°æœ€è¿‘å…¬å…±ç¥–å…ˆåï¼Œç”±fxçš„å®šä¹‰å¯ä»¥ä¿è¯ä¸ä¼šè¯¯æ‰¾å‡ºæ–°çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ</li><li>è®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œå¯ä»¥å¾—åˆ°på’Œqåˆ°è¾¾æ ¹èŠ‚ç‚¹çš„è·¯å¾„ï¼Œä¸¤æ¡è·¯å¾„ä»ä¸‹å¾€ä¸Šç¬¬ä¸€ä¸ªäº¤ç‚¹å°±æ˜¯på’Œqçš„æœ€è¿‘å…¬å…±ç¥–å…ˆ</li></ul></li><li>æ‰¾äºŒå‰æœç´¢æ ‘çš„æœ€è¿‘å…¬å…±ç¥–å…ˆ<ul><li>æ ¹æ®äºŒå‰æœç´¢æ ‘çš„æ€§è´¨å¯ä»¥ç›´æ¥å¾—åˆ°på’Œqåˆ°è¾¾æ ¹èŠ‚ç‚¹çš„è·¯å¾„ï¼Œç„¶åç®—å‡ºæœ€è¿‘å…¬å…±ç¥–å…ˆ</li><li>å¦‚æœpå’Œqåˆ†åˆ«åœ¨xçš„ä¸¤è¾¹ï¼ˆåŒ…æ‹¬xå°±æ˜¯pæˆ–qï¼‰ï¼Œé‚£ä¹ˆxå°±æ˜¯på’Œqçš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚æ ¹æ®äºŒå‰æœç´¢æ ‘çš„æ€§è´¨å¯ä»¥é€šè¿‡pã€qå’ŒèŠ‚ç‚¹rootçš„å€¼è¿›è¡Œæ¯”è¾ƒå¿«é€Ÿæ‰¾åˆ°x</li></ul></li></ul><h5 id="240-æœç´¢äºŒç»´çŸ©é˜µ-II-åŠ›æ‰£ï¼ˆLeetCodeï¼‰"><a href="#240-æœç´¢äºŒç»´çŸ©é˜µ-II-åŠ›æ‰£ï¼ˆLeetCodeï¼‰" class="headerlink" title="240. æœç´¢äºŒç»´çŸ©é˜µ II - åŠ›æ‰£ï¼ˆLeetCodeï¼‰"></a><a href="https://leetcode.cn/problems/search-a-2d-matrix-ii/">240. æœç´¢äºŒç»´çŸ©é˜µ II - åŠ›æ‰£ï¼ˆLeetCodeï¼‰</a></h5><p>ç¼–å†™ä¸€ä¸ªé«˜æ•ˆçš„ç®—æ³•æ¥æœç´¢Â mÂ xÂ nÂ çŸ©é˜µ matrix ä¸­çš„ä¸€ä¸ªç›®æ ‡å€¼ target ã€‚è¯¥çŸ©é˜µå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p><ul><li>æ¯è¡Œçš„å…ƒç´ ä»å·¦åˆ°å³å‡åºæ’åˆ—ã€‚</li><li>æ¯åˆ—çš„å…ƒç´ ä»ä¸Šåˆ°ä¸‹å‡åºæ’åˆ—ã€‚</li></ul><p>æ€è·¯:</p><p>ä»çŸ©é˜µçš„å³ä¸Šæ–¹(0,n-1)å¼€å§‹æœç´¢ã€‚åœ¨æ¯ä¸€æ­¥çš„æœç´¢è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæˆ‘ä»¬ä½äºä½ç½® (x,y)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸Œæœ›åœ¨ä»¥<em>matrix</em>çš„å·¦ä¸‹è§’ä¸ºå·¦ä¸‹è§’ã€ä»¥(x,y)ä¸ºå³ä¸Šè§’çš„çŸ©é˜µä¸­è¿›è¡Œæœç´¢ï¼Œå³è¡Œçš„èŒƒå›´ä¸º [x,m-1]ï¼Œåˆ—çš„èŒƒå›´ä¸º[0,y]ï¼š</p><p>å¯¹äºä½äºä½ç½®ï¼ˆx,yï¼‰çš„æ•°matrix[x,y],æˆ‘ä»¬å°†å…¶å’Œtargetæ¯”è¾ƒ</p><ul><li>matrix[x,y] &lt; target å¯ä»¥æ¨æ–­å‡ºtargetä¸€å®šä¸åœ¨ç¬¬xè¡Œï¼ˆç¬¬xè¡Œçš„å…ƒç´ éƒ½ä¸¥æ ¼å°äºtargetï¼‰ï¼Œå°†x+1ï¼Œç„¶åé‡æ–°è¿›è¡Œæ¯”è¾ƒ</li><li>matrix[x,y] &gt; target åŒç†å°†y-1åé‡æ–°è¿›è¡Œæ¯”è¾ƒ</li><li>matrix[x,y] &#x3D; target æ‰¾åˆ°targetï¼Œè¿”å›ç»“æœ</li></ul><p>æœ€åå¦‚æœx&gt;&#x3D;m æˆ– y&lt;0ï¼Œè¡¨ç¤ºçŸ©é˜µmatrixä¸­æ²¡æœ‰å€¼ä¸ºtargetçš„æ•°</p><hr><h5 id="254-å› å­çš„ç»„åˆ-åŠ›æ‰£ï¼ˆLeetCodeï¼‰"><a href="#254-å› å­çš„ç»„åˆ-åŠ›æ‰£ï¼ˆLeetCodeï¼‰" class="headerlink" title="254. å› å­çš„ç»„åˆ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰"></a><a href="https://leetcode.cn/problems/factor-combinations/">254. å› å­çš„ç»„åˆ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰</a></h5><p>è¯·å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ªæ•´æ•° <em>n</em> å¹¶è¿”å›è¯¥æ•´æ•°æ‰€æœ‰çš„å› å­ç»„åˆã€‚</p><p>æ€è·¯:</p><ul><li><p>dfsé€’å½’ï¼šéå†èŒƒå›´ä¸ºi&#x3D;2~âˆšnçš„å› å­</p></li><li><p>å•å±‚é€’å½’ï¼šå¦‚æœiæ˜¯nçš„å› å­ï¼Œè¯¥å±‚ç»“æœä¸­æ·»åŠ ä¸€ä¸ª[iï¼Œn&#x2F;&#x2F;i]ç»„åˆ</p></li><li><p>é€’å½’å¤„ç†ï¼š</p><ul><li>æŸ¥çœ‹n&#x2F;&#x2F;ièƒ½å¦ä»å› å­iå¼€å§‹è¢«æ‹†åˆ†æˆå¤šå› å­ç»„åˆsubåºåˆ—</li><li>å¦‚æœsubå­˜åœ¨ï¼Œåˆ™åœ¨è¯¥å±‚ç»“æœä¸­ç»§ç»­æ·»åŠ sub+[i]ä¸ºä¸€ä¸ªæ–°çš„ç»„åˆ</li></ul></li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Algorithm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>åªå‡ºç°ä¸€æ¬¡çš„æ•°å­—III</title>
    <link href="/2022/09/17/algorithm/%E5%8F%AA%E5%87%BA%E7%8E%B0%E4%B8%80%E6%AC%A1%E7%9A%84%E6%95%B0%E5%AD%97III/"/>
    <url>/2022/09/17/algorithm/%E5%8F%AA%E5%87%BA%E7%8E%B0%E4%B8%80%E6%AC%A1%E7%9A%84%E6%95%B0%E5%AD%97III/</url>
    
    <content type="html"><![CDATA[<p><a href="https://leetcode.cn/problems/single-number-iii/">LeetCodeé“¾æ¥</a></p><p>é¢˜ç›®æè¿°å¦‚ä¸‹ï¼š</p><blockquote><p>ç»™ä½ ä¸€ä¸ªæ•´æ•°æ•°ç»„ <code>nums</code>ï¼Œå…¶ä¸­æ°å¥½æœ‰ä¸¤ä¸ªå…ƒç´ åªå‡ºç°ä¸€æ¬¡ï¼Œå…¶ä½™æ‰€æœ‰å…ƒç´ å‡å‡ºç°ä¸¤æ¬¡ã€‚ æ‰¾å‡ºåªå‡ºç°ä¸€æ¬¡çš„é‚£ä¸¤ä¸ªå…ƒç´ ã€‚ä½ å¯ä»¥æŒ‰ <strong>ä»»æ„é¡ºåº</strong> è¿”å›ç­”æ¡ˆã€‚</p></blockquote><p><strong>æ€è·¯ä¸€</strong>ï¼š</p><blockquote><p>Mapç»Ÿè®¡æ•´æ•°æ•°ç»„ä¸­å…ƒç´ å‡ºç°çš„æ¬¡æ•°</p></blockquote><p><strong>ä»£ç </strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] singleNumber(<span class="hljs-type">int</span>[] nums) &#123;<br>        Map&lt;Integer,Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;nums.length;i++) &#123;<br>            map.computeIfPresent(nums[i],(key,value) -&gt; value+<span class="hljs-number">1</span>);<br>            map.putIfAbsent(nums[i],<span class="hljs-number">1</span>);<br>        &#125;<br>        List&lt;Integer&gt; ans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;Integer,Integer&gt; entry:map.entrySet()) &#123;<br>            <span class="hljs-keyword">if</span> (entry.getValue() == <span class="hljs-number">1</span>) &#123;<br>                ans.add(entry.getKey());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;ans.get(<span class="hljs-number">0</span>),ans.get(<span class="hljs-number">1</span>)&#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤æ‚åº¦ï¼š</strong></p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šO(n),å…¶ä¸­nä¸ºæ•°ç»„é•¿åº¦</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(n),nä¸ºå“ˆå¸Œè¡¨ä½¿ç”¨çš„ç©ºé—´</li></ul><hr><p><strong>æ€è·¯äºŒ</strong>ï¼š</p><blockquote><p>æ ¹æ®å¼‚æˆ–è¿ç®—ç­‰ä½è¿ç®—çŸ¥è¯†</p></blockquote><p>å‡è®¾æ•´æ•°æ•°ç»„numsä¸­åªå‡ºç°ä¸€æ¬¡çš„æ•°å­—åˆ†åˆ«ä¸ºx1å’Œx2ã€å°†numsä¸­æ‰€æœ‰å…ƒç´ å¼‚æˆ–å¾—åˆ°xï¼Œé‚£ä¹ˆæ ¹æ®å¼‚æˆ–è¿ç®—çš„æ€§è´¨</p><p>a ^ a &#x3D; 0 å¯çŸ¥x1 ^ x2 &#x3D; xå¹¶ä¸”x1å’Œx2ä¸ç­‰(x1å’Œx2éƒ½åªå‡ºç°äº†ä¸€æ¬¡)ã€‚</p><p>æ ¹æ®x &amp; (-x)ç®—å‡ºxçš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­æœ€ä½ä½çš„1ï¼Œè®°ä¸ºç¬¬iä½ã€‚æ˜“çŸ¥x1å’Œx2çš„äºŒè¿›åˆ¶è¡¨ç¤ºçš„ç¬¬iä½ä¸€å®šä¸åŒï¼Œå³ä¸€ä¸ªæ•°çš„ç¬¬iä½æ˜¯0ï¼Œå¦ä¸€ä¸ªæ•°çš„ç¬¬iä½æ˜¯1</p><p>åŒæ—¶æˆ‘ä»¬å¯ä»¥å°†numsä¸­çš„æ•°åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºçš„ç¬¬iä½æ˜¯0ã€ä¸€ç±»æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºçš„ç¬¬iä½æ˜¯0ã€‚</p><p>åˆ†åˆ«å°†è¿™ä¸¤ç±»æ•°çš„æ‰€æœ‰å…ƒç´ å¼‚æˆ–å¾—åˆ°y1å’Œy2ï¼Œç”±äºé™¤äº†x1å’Œx2å…¶ä»–çš„æ•°éƒ½å‡ºç°äº†ä¸¤æ¬¡ï¼Œå¯ä»¥çŸ¥é“y1&#x3D;x1ã€y2&#x3D;x2</p><p><strong>ä»£ç ï¼š</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] singleNumber(<span class="hljs-type">int</span>[] nums) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;nums.length;i++) &#123;<br>            x = x ^ nums[i];<br>        &#125;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> x &amp; (-x);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">x1</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,x2 = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;nums.length;i++) &#123;<br>            <span class="hljs-comment">// ç¬¬iä½ä¸º1</span><br>            <span class="hljs-keyword">if</span> ((nums[i] &amp; t) == t) &#123;<br>                x1 = x1 ^ nums[i];<br>            &#125;<span class="hljs-keyword">else</span> &#123;<br>                x2 = x2 ^ nums[i];<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]&#123;x1,x2&#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤æ‚åº¦ï¼š</strong></p><ul><li>æ—¶é—´å¤æ‚åº¦ï¼šO(n),å…¶ä¸­nä½æ•°ç»„é•¿åº¦</li><li>ç©ºé—´å¤æ‚åº¦ï¼šO(1),ç®—æ³•ç”¨åˆ°äº†å¸¸æ•°çº§åˆ«çš„ç©ºé—´</li></ul>]]></content>
    
    
    <categories>
      
      <category>Leetcode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Algorithm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nçš‡åé—®é¢˜</title>
    <link href="/2022/08/29/algorithm/N%E7%9A%87%E5%90%8E%E9%97%AE%E9%A2%98/"/>
    <url>/2022/08/29/algorithm/N%E7%9A%87%E5%90%8E%E9%97%AE%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h3 id="åŸºäºé›†åˆçš„å›æº¯"><a href="#åŸºäºé›†åˆçš„å›æº¯" class="headerlink" title="åŸºäºé›†åˆçš„å›æº¯"></a>åŸºäºé›†åˆçš„å›æº¯</h3><p>æ€è·¯ï¼šæŒ‰è¡Œéå†ã€‚ç»´æŠ¤ä¸‰ä¸ªé›†åˆ<em>columns</em>ã€<em>diagonals1</em>å’Œ<em>diagonals2</em>åˆ†åˆ«è¡¨ç¤ºæ¯ä¸€åˆ—ä»¥åŠä¸¤ä¸ªæ–¹å‘çš„æ¯æ¡æ–œçº¿æ˜¯å¦æœ‰çš‡å</p><p>ä»£ç å¦‚ä¸‹:0-</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;List&lt;String&gt;&gt; ans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">public</span> List&lt;List&lt;String&gt;&gt; <span class="hljs-title function_">solveNQueens</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>        <span class="hljs-type">int</span>[] column = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];<br>        <span class="hljs-type">int</span>[] slashL = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span>[] slashR = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n*<span class="hljs-number">2</span>+<span class="hljs-number">1</span>];<br>        <span class="hljs-type">boolean</span>[][] board = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[n][n];<br>        dfs(board,column,slashL,slashR,n,<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> ans;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dfs</span><span class="hljs-params">(<span class="hljs-type">boolean</span>[][] board,<span class="hljs-type">int</span>[] column,<span class="hljs-type">int</span>[] slashL,<span class="hljs-type">int</span>[] slashR,<span class="hljs-type">int</span> n,<span class="hljs-type">int</span> rowIndex)</span> &#123;<br>        <span class="hljs-keyword">if</span> (rowIndex == n) &#123;<br>            List&lt;String&gt; t = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;n;i++) &#123;<br>                <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;n;j++) &#123;<br>                    <span class="hljs-keyword">if</span> (board[i][j]) &#123;<br>                        sb.append(<span class="hljs-string">&#x27;Q&#x27;</span>);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        sb.append(<span class="hljs-string">&#x27;.&#x27;</span>);<br>                    &#125;<br>                &#125;<br>                t.add(sb.toString());<br>            &#125;<br>            ans.add(t);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;n;i++) &#123;<br>            <span class="hljs-keyword">if</span> (column[i] == <span class="hljs-number">0</span> &amp;&amp; slashL[i+rowIndex] == <span class="hljs-number">0</span> &amp;&amp; slashR[rowIndex-i+n-<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>) &#123;<br>                column[i] = <span class="hljs-number">1</span>;<br>                slashL[i+rowIndex] = <span class="hljs-number">1</span>;<br>                slashR[rowIndex-i+n-<span class="hljs-number">1</span>] = <span class="hljs-number">1</span>;<br>                board[rowIndex][i] = <span class="hljs-literal">true</span>;<br>                dfs(board,column,slashL,slashR,n,rowIndex+<span class="hljs-number">1</span>);<br>                column[i] = <span class="hljs-number">0</span>;<br>                slashL[i+rowIndex] = <span class="hljs-number">0</span>;<br>                slashR[rowIndex-i+n-<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;<br>                board[rowIndex][i] = <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŸºäºä½è¿ç®—çš„å›æº¯"><a href="#åŸºäºä½è¿ç®—çš„å›æº¯" class="headerlink" title="åŸºäºä½è¿ç®—çš„å›æº¯"></a>åŸºäºä½è¿ç®—çš„å›æº¯</h3><p>æ€è·¯ï¼šä½¿ç”¨ä¸‰ä¸ªæ•´æ•°<em>columns</em>ã€<em>diagonals1</em>å’Œ<em>diagonals2</em>åˆ†åˆ«è®°å½•æ¯ä¸€åˆ—å’Œä¸¤ä¸ªæ–¹å‘çš„æ¯æ¡æ–œçº¿ä¸Šæ˜¯å¦æœ‰çš‡å</p><blockquote><p>æ­¤æ–¹æ³•çš„ç©ºé—´å¤æ‚åº¦å¯ç”±åŸºäºé›†åˆå›æº¯çš„O(N)é™ä¸ºO(1)</p></blockquote><p><em>columns</em>ã€<em>diagonals1</em>å’Œ<em>diagonals2</em>ä¸‰ä¸ªæ•´æ•°çš„ä½Nä½åˆ†åˆ«å¯¹åº”äºæ£‹ç›˜ä¸­çš„Nåˆ—ï¼Œå…¶ä¸­æ£‹ç›˜çš„æœ€å·¦åˆ—å¯¹åº”æ•´æ•°çš„æœ€ä½äºŒè¿›åˆ¶ä½ã€æœ€å³åˆ—å¯¹åº”æ•´æ•°çš„ç¬¬N-1ä¸ªäºŒè¿›åˆ¶ä½</p><p>çº¦å®šç”¨0è¡¨ç¤ºå¯ä»¥æ”¾ç½®çš‡åçš„ä½ç½®ã€ç”¨1è¡¨ç¤ºä¸èƒ½æ”¾ç½®çš‡åçš„ä½ç½®ã€‚å¦‚n&#x3D;4 columns&#x3D;0101(2)è¡¨ç¤ºç¬¬0ã€2åˆ—ä¸èƒ½æ”¾ç½®çš‡åï¼›ç¬¬1ã€3åˆ—å¯ä»¥æ”¾ç½®çš‡å</p><p>ä¸‹é¢è¯´æ˜æ¯æ¬¡æ”¾ç½®çš‡ååå¦‚ä½•æ›´æ–°ä¸‰ä¸ªæ•´æ•°çš„å€¼</p><img src="/2022/08/29/algorithm/N%E7%9A%87%E5%90%8E%E9%97%AE%E9%A2%98/1661847071002.png" class><br><br><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨ç¬¬1è¡Œç¬¬4åˆ—æ”¾ç½®çš‡ååï¼Œè€ƒè™‘ç¬¬2è¡Œèƒ½åœ¨å“ªäº›åˆ—æ”¾ç½®çš‡å</p><blockquote><p>é¦–å…ˆæ˜¾ç„¶å¯ä»¥å¾—åˆ°ç¬¬2ã€4åˆ—ä¸èƒ½æ”¾ç½®çš‡å</p><p>ç„¶åæ ¹æ®ä»å·¦ä¸Šåˆ°å³ä¸‹çš„æ–œçº¿å¯çŸ¥ç¬¬4ã€5åˆ—ä¸èƒ½æ”¾ç½®çš‡åã€‚ç¬¬4åˆ—ä¸ºå…¶å‰2è¡Œçš„ç¬¬2åˆ—å‘å³ä¸‹æ–¹ç§»åŠ¨ä¸¤æ­¥çš„ä½ç½®ã€ç¬¬5åˆ—ä¸ºå…¶å‰1è¡Œçš„ç¬¬4åˆ—å‘å³ä¸‹æ–¹ç§»åŠ¨ä¸€æ­¥çš„ä½ç½®</p><p>æ ¹æ®ä»å³ä¸Šåˆ°å·¦ä¸‹çš„æ–œçº¿å¯çŸ¥ç¬¬0ã€3åˆ—ä¸èƒ½æ”¾ç½®çš‡åã€‚ç¬¬0åˆ—ä¸ºå…¶å‰2è¡Œçš„ç¬¬2åˆ—å‘å³ä¸‹æ–¹ç§»åŠ¨ä¸¤æ­¥çš„ä½ç½®ã€ç¬¬3åˆ—ä¸ºå…¶å‰1è¡Œçš„ç¬¬4åˆ—å‘å³ä¸‹æ–¹ç§»åŠ¨ä¸€æ­¥çš„ä½ç½®</p></blockquote><p>ç®€å•å½’çº³å¯ä»¥å¾—åˆ°ä¸‰ä¸ªæ•´æ•°çš„æ›´æ–°è®¡ç®—æ–¹æ³•ï¼š</p><ul><li>åˆå§‹æ—¶ä¸‰ä¸ªæ•´æ•°éƒ½ç½®ä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰æ”¾ç½®ä»»ä½•çš‡å</li><li>åœ¨æ”¾ç½®å½“å‰çš‡åæ—¶ï¼Œå¦‚æœçš‡åæ”¾ç½®åœ¨ç¬¬iåˆ—ï¼Œåˆ™å°†ä¸‰ä¸ªæ•´æ•°çš„ç¬¬iï¼ˆä»ä½åˆ°é«˜ï¼‰ä½ç½®ä¸º1</li><li>è¿›å…¥ä¸‹ä¸€è¡Œæ—¶ï¼Œcolumnså€¼ä¿æŒä¸å˜ï¼Œdiagonals1å·¦ç§»1ä½ï¼ˆå½“å‰è¡Œä¸èƒ½æ”¾ç½®çš‡åä½ç½®çš„å³ä¸‹æ–¹è·ç¦»ä¸€æ­¥çš„ä½ç½®ä¹Ÿä¸èƒ½æ”¾ç½®çš‡åï¼‰ï¼Œdiagonals2å³ç§»1ä½ï¼ˆå½“å‰è¡Œä¸èƒ½æ”¾ç½®çš‡åä½ç½®çš„å·¦ä¸‹æ–¹è·ç¦»ä¸€æ­¥çš„ä½ç½®ä¹Ÿä¸èƒ½æ”¾ç½®çš‡åï¼‰</li></ul><p>æ¯æ¬¡æ”¾ç½®çš‡åæ—¶ï¼Œé€šè¿‡ä¸‰ä¸ªæ•´æ•°çš„æŒ‰ä½æˆ–è¿ç®—çš„ç»“æœå¯ä»¥å¾—åˆ°å¯ä»¥å’Œä¸å¯ä»¥æ”¾ç½®çš‡åçš„ä½ç½®</p><p>å¯ä»¥é€šè¿‡ï¼ˆ2^n-1ï¼‰&amp; (~(columns | diagonals1 | diagonals2))å¾—åˆ°æ‰€æœ‰å¯ä»¥æ”¾ç½®çš‡åçš„ä½ç½®ï¼ˆç¬¬iä½ä¸º1è¡¨ç¤ºç¬¬iä½å¯ä»¥æ”¾ç½®çš‡åï¼‰ï¼Œç„¶åéå†è¿™äº›ä½ç½®ï¼Œå¾—åˆ°æ‰€æœ‰å¯èƒ½çš„è§£</p><p>éå†å¯ä»¥æ”¾ç½®çš‡åçš„ä½ç½®æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ä»¥ä¸‹ä¸¤ä¸ªæŒ‰ä½ä¸è¿ç®—çš„æ€§è´¨ï¼š</p><ul><li>x <strong>&amp;</strong> (âˆ’x) å¯ä»¥è·å¾— x çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­çš„æœ€ä½ä½çš„ 1 çš„ä½ç½®</li><li>x <strong>&amp;</strong> (xâˆ’1) å¯ä»¥å°† x çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­çš„æœ€ä½ä½çš„ 1 ç½®æˆ 0</li></ul><p>å…·ä½“åšæ³•æ˜¯ï¼Œæ¯æ¬¡è·å¾—å¯ä»¥æ”¾ç½®çš‡åçš„ä½ç½®ä¸­çš„æœ€ä½ä½ï¼Œå¹¶å°†è¯¥ä½çš„å€¼ç½®æˆ 0ï¼Œå°è¯•åœ¨è¯¥ä½ç½®æ”¾ç½®çš‡åã€‚è¿™æ ·å³å¯éå†æ¯ä¸ªå¯ä»¥æ”¾ç½®çš‡åçš„ä½ç½®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-keyword">public</span> List&lt;List&lt;String&gt;&gt; <span class="hljs-title function_">solveNQueens</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>        <span class="hljs-type">int</span>[] queens = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];<br>        Arrays.fill(queens, -<span class="hljs-number">1</span>);<br>        List&lt;List&lt;String&gt;&gt; solutions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;List&lt;String&gt;&gt;();<br>        solve(solutions, queens, n, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">return</span> solutions;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">solve</span><span class="hljs-params">(List&lt;List&lt;String&gt;&gt; solutions, <span class="hljs-type">int</span>[] queens, <span class="hljs-type">int</span> n, <span class="hljs-type">int</span> row, <span class="hljs-type">int</span> columns, <span class="hljs-type">int</span> diagonals1, <span class="hljs-type">int</span> diagonals2)</span> &#123;<br>        <span class="hljs-keyword">if</span> (row == n) &#123;<br>            List&lt;String&gt; board = generateBoard(queens, n);<br>            solutions.add(board);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">availablePositions</span> <span class="hljs-operator">=</span> ((<span class="hljs-number">1</span> &lt;&lt; n) - <span class="hljs-number">1</span>) &amp; (~(columns | diagonals1 | diagonals2));<br>            <span class="hljs-keyword">while</span> (availablePositions != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">position</span> <span class="hljs-operator">=</span> availablePositions &amp; (-availablePositions);<br>                availablePositions = availablePositions &amp; (availablePositions - <span class="hljs-number">1</span>);<br>                <span class="hljs-type">int</span> <span class="hljs-variable">column</span> <span class="hljs-operator">=</span> Integer.bitCount(position - <span class="hljs-number">1</span>);<br>                queens[row] = column;<br>                solve(solutions, queens, n, row + <span class="hljs-number">1</span>, columns | position, (diagonals1 | position) &lt;&lt; <span class="hljs-number">1</span>, (diagonals2 | position) &gt;&gt; <span class="hljs-number">1</span>);<br>                queens[row] = -<span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">generateBoard</span><span class="hljs-params">(<span class="hljs-type">int</span>[] queens, <span class="hljs-type">int</span> n)</span> &#123;<br>        List&lt;String&gt; board = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>            <span class="hljs-type">char</span>[] row = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[n];<br>            Arrays.fill(row, <span class="hljs-string">&#x27;.&#x27;</span>);<br>            row[queens[i]] = <span class="hljs-string">&#x27;Q&#x27;</span>;<br>            board.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(row));<br>        &#125;<br>        <span class="hljs-keyword">return</span> board;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ®Leetcodeè¯„è®ºåŒºï¼šå½“æ•°æ®é‡è¾¾åˆ°15æ—¶ï¼ŒåŸºäºé›†åˆçš„å›æº¯ä¼šè¶…æ—¶ï¼ŒåŸºäºä½è¿ç®—çš„å›æº¯åˆšå¥½èƒ½è¿‡</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>Leetcode</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Algorithm</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
